
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ìƒì„¸ - ê¾¸ë©”ë•…í•™ì›</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="/students/list" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-2"></i>í•™ìƒ ëª©ë¡
                    </a>
                    <h1 id="pageTitle" class="text-2xl font-bold text-gray-900">í•™ìƒ ìƒì„¸</h1>
                </div>
                <div class="flex space-x-3">
                    <a href="/students/daily-record" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-calendar-check mr-2"></i>ì„±ê³¼ ê¸°ë¡
                    </a>
                    <button onclick="sendSMS()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-sms mr-2"></i>í•™ë¶€ëª¨ ë¬¸ì
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div id="loadingMessage" class="text-center text-gray-500 py-12">ë¡œë”© ì¤‘...</div>
        
        <div id="studentContent" class="hidden">
            <!-- í•™ìƒ í”„ë¡œí•„ -->
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl shadow-xl p-8 mb-6 text-white">
                <div class="flex items-center space-x-6">
                    <div class="bg-white text-blue-600 rounded-full w-24 h-24 flex items-center justify-center text-4xl font-bold">
                        <span id="studentInitial"></span>
                    </div>
                    <div class="flex-1">
                        <h2 id="studentName" class="text-3xl font-bold mb-2"></h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="opacity-80">í•™ë…„</span>
                                <p id="studentGrade" class="font-semibold text-lg"></p>
                            </div>
                            <div>
                                <span class="opacity-80">í•™êµ</span>
                                <p id="studentSchoolDetail" class="font-semibold text-lg"></p>
                            </div>
                            <div>
                                <span class="opacity-80">ë°˜</span>
                                <p id="studentClass" class="font-semibold text-lg"></p>
                            </div>
                            <div>
                                <span class="opacity-80">ìˆ˜ê°• ê³¼ëª©</span>
                                <p id="studentSubjects" class="font-semibold text-lg"></p>
                            </div>
                            <div>
                                <span class="opacity-80">ë“±ë¡ì¼</span>
                                <p id="enrollmentDate" class="font-semibold text-lg"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í•™ë¶€ëª¨ ì •ë³´ & ì—°ë½ì²˜ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-900 mb-4">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ í•™ë¶€ëª¨ ì •ë³´</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <span class="text-sm text-gray-500">í•™ë¶€ëª¨ ì´ë¦„</span>
                        <p id="parentName" class="text-lg font-semibold text-gray-900"></p>
                    </div>
                    <div>
                        <span class="text-sm text-gray-500">í•™ë¶€ëª¨ ì—°ë½ì²˜</span>
                        <p id="parentPhone" class="text-lg font-semibold text-gray-900"></p>
                    </div>
                    <div>
                        <span class="text-sm text-gray-500">í•™ìƒ ì—°ë½ì²˜</span>
                        <p id="studentPhone" class="text-lg font-semibold text-gray-900"></p>
                    </div>
                </div>
                <div id="studentNotes" class="mt-4 p-4 bg-yellow-50 rounded-lg hidden">
                    <span class="text-sm text-gray-500">ë©”ëª¨</span>
                    <p id="notesContent" class="text-gray-900 mt-1"></p>
                </div>
            </div>

            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600">ì¶œì„ë¥ </span>
                        <i class="fas fa-calendar-check text-green-500 text-2xl"></i>
                    </div>
                    <p id="attendanceRate" class="text-3xl font-bold text-green-600">-%</p>
                    <p class="text-sm text-gray-500 mt-1">ì´ <span id="attendanceDays">0</span>ì¼</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600">ê³¼ì œ ì™„ì„±ë¥ </span>
                        <i class="fas fa-tasks text-blue-500 text-2xl"></i>
                    </div>
                    <p id="homeworkRate" class="text-3xl font-bold text-blue-600">-%</p>
                    <p class="text-sm text-gray-500 mt-1">ì™„ë£Œ <span id="homeworkCompleted">0</span>ê±´</p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600">í‰ê·  ì´í•´ë„</span>
                        <i class="fas fa-brain text-purple-500 text-2xl"></i>
                    </div>
                    <p id="avgUnderstanding" class="text-3xl font-bold text-purple-600">-</p>
                    <p class="text-sm text-gray-500 mt-1">5ì  ë§Œì </p>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-600">í‰ê·  ì°¸ì—¬ë„</span>
                        <i class="fas fa-hand-paper text-orange-500 text-2xl"></i>
                    </div>
                    <p id="avgParticipation" class="text-3xl font-bold text-orange-600">-</p>
                    <p class="text-sm text-gray-500 mt-1">5ì  ë§Œì </p>
                </div>
            </div>

            <!-- ê¸°ê°„ ì„ íƒ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center space-x-4">
                    <label class="text-sm font-medium text-gray-700">ê¸°ê°„ ì„ íƒ:</label>
                    <select id="periodSelect" onchange="loadStats()" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="7">ìµœê·¼ 7ì¼</option>
                        <option value="30" selected>ìµœê·¼ 30ì¼</option>
                        <option value="90">ìµœê·¼ 90ì¼</option>
                        <option value="all">ì „ì²´ ê¸°ê°„</option>
                    </select>
                </div>
            </div>

            <!-- ì„±ê³¼ ê·¸ë˜í”„ -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“ˆ ì´í•´ë„ & ì°¸ì—¬ë„ ì¶”ì´</h3>
                    <canvas id="levelChart"></canvas>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“Š ì¶œì„ & ê³¼ì œ í˜„í™©</h3>
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <!-- ìµœê·¼ ì„±ê³¼ ê¸°ë¡ íƒ€ì„ë¼ì¸ -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-900 mb-6">ğŸ“ ìµœê·¼ ì„±ê³¼ ê¸°ë¡</h3>
                <div id="recentRecords" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <script>
        // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const userStr = localStorage.getItem('user');
        if (!userStr) {
            alert('âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\\n\\ní•™ìƒ ìƒì„¸ ì •ë³´ë¥¼ ë³´ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = '/login';
            throw new Error('Not logged in');
        }
        const currentUser = JSON.parse(userStr);
        const academyId = currentUser.id;
        const studentId = window.location.pathname.split('/').pop();
        console.log('ğŸ‘¤ Current User:', currentUser);
        console.log('ğŸ« Academy ID:', academyId);
        console.log('ğŸ‘¨â€ğŸ“ Student ID:', studentId);
        let student = null;
        let stats = null;
        let records = [];
        let levelChart = null;
        let statusChart = null;

        async function loadStudent() {
            try {
                const res = await fetch('/api/students/' + studentId);
                const data = await res.json();
                if (data.success) {
                    student = data.student;
                    renderStudent();
                } else {
                    document.getElementById('loadingMessage').innerHTML = '<div class="text-center text-red-500 py-12">í•™ìƒ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (error) {
                console.error('í•™ìƒ ì •ë³´ ë¡œë”© ì‹¤íŒ¨:', error);
                document.getElementById('loadingMessage').innerHTML = '<div class="text-center text-red-500 py-12">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        function renderStudent() {
            document.getElementById('pageTitle').textContent = student.name + ' í•™ìƒ';
            document.getElementById('studentInitial').textContent = student.name.charAt(0);
            document.getElementById('studentName').textContent = student.name;
            document.getElementById('studentGrade').textContent = student.grade;
            document.getElementById('studentSchoolDetail').textContent = student.school || 'ë¯¸ë“±ë¡';
            document.getElementById('studentClass').textContent = student.class_name || 'ë¯¸ë°°ì •';
            document.getElementById('studentSubjects').textContent = student.subjects;
            document.getElementById('enrollmentDate').textContent = student.enrollment_date;
            document.getElementById('parentName').textContent = student.parent_name;
            document.getElementById('parentPhone').textContent = student.parent_phone;
            document.getElementById('studentPhone').textContent = student.phone || 'ë¯¸ë“±ë¡';
            
            if (student.notes) {
                document.getElementById('studentNotes').classList.remove('hidden');
                document.getElementById('notesContent').textContent = student.notes;
            }

            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('studentContent').classList.remove('hidden');
        }

        async function loadStats() {
            try {
                const period = document.getElementById('periodSelect').value;
                let startDate, endDate = new Date().toISOString().split('T')[0];
                
                if (period === 'all') {
                    startDate = student.enrollment_date;
                } else {
                    const date = new Date();
                    date.setDate(date.getDate() - parseInt(period));
                    startDate = date.toISOString().split('T')[0];
                }

                const res = await fetch(`/api/students/${studentId}/stats?startDate=${startDate}&endDate=${endDate}`);
                const data = await res.json();
                if (data.success) {
                    stats = data.stats;
                    renderStats();
                }

                // ì „ì²´ ê¸°ë¡ë„ ë¡œë“œ
                const recordsRes = await fetch(`/api/daily-records?studentId=${studentId}&startDate=${startDate}&endDate=${endDate}`);
                const recordsData = await recordsRes.json();
                if (recordsData.success) {
                    records = recordsData.records;
                    renderRecords();
                    renderCharts();
                }
            } catch (error) {
                console.error('í†µê³„ ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }

        function renderStats() {
            const totalRecords = parseInt(stats.total_records) || 0;
            const attendanceCount = parseInt(stats.attendance_count) || 0;
            const homeworkCompleted = parseInt(stats.homework_completed) || 0;
            const avgUnderstanding = parseFloat(stats.avg_understanding) || 0;
            const avgParticipation = parseFloat(stats.avg_participation) || 0;

            const attendanceRate = totalRecords > 0 ? Math.round((attendanceCount / totalRecords) * 100) : 0;
            const homeworkRate = totalRecords > 0 ? Math.round((homeworkCompleted / totalRecords) * 100) : 0;

            document.getElementById('attendanceRate').textContent = attendanceRate + '%';
            document.getElementById('attendanceDays').textContent = attendanceCount;
            document.getElementById('homeworkRate').textContent = homeworkRate + '%';
            document.getElementById('homeworkCompleted').textContent = homeworkCompleted;
            document.getElementById('avgUnderstanding').textContent = avgUnderstanding > 0 ? avgUnderstanding.toFixed(1) : '-';
            document.getElementById('avgParticipation').textContent = avgParticipation > 0 ? avgParticipation.toFixed(1) : '-';
        }

        function renderRecords() {
            const container = document.getElementById('recentRecords');
            if (records.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const sortedRecords = [...records].sort((a, b) => new Date(b.record_date) - new Date(a.record_date)).slice(0, 10);

            container.innerHTML = sortedRecords.map(record => {
                const date = new Date(record.record_date);
                const dateStr = `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼\