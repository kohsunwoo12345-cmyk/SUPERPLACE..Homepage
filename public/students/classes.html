
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°˜ ê´€ë¦¬ - ê¾¸ë©”ë•…í•™ì›</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="/students" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-2"></i>ëŒì•„ê°€ê¸°
                    </a>
                    <h1 class="text-2xl font-bold text-gray-900">ğŸ« ë°˜ ê´€ë¦¬</h1>
                </div>
                <button onclick="showAddModal()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                    <i class="fas fa-plus mr-2"></i>ìƒˆ ë°˜ ì¶”ê°€
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div id="classList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="text-center text-gray-500 py-8">ë¡œë”© ì¤‘...</div>
        </div>
    </div>

    <!-- ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="classModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6">ìƒˆ ë°˜ ì¶”ê°€</h2>
            <form id="classForm">
                <input type="hidden" id="classId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë°˜ ì´ë¦„ *</label>
                        <input type="text" id="className" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="ì˜ˆ: ì¤‘1-Aë°˜">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">í•™ë…„</label>
                        <select id="grade" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ì´ˆ1">ì´ˆ1</option>
                            <option value="ì´ˆ2">ì´ˆ2</option>
                            <option value="ì´ˆ3">ì´ˆ3</option>
                            <option value="ì´ˆ4">ì´ˆ4</option>
                            <option value="ì´ˆ5">ì´ˆ5</option>
                            <option value="ì´ˆ6">ì´ˆ6</option>
                            <option value="ì¤‘1">ì¤‘1</option>
                            <option value="ì¤‘2">ì¤‘2</option>
                            <option value="ì¤‘3">ì¤‘3</option>
                            <option value="ê³ 1">ê³ 1</option>
                            <option value="ê³ 2">ê³ 2</option>
                            <option value="ê³ 3">ê³ 3</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë°˜ ìƒ‰ìƒ *</label>
                        <div id="colorPicker" class="grid grid-cols-8 gap-2 mb-4">
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #EF4444" data-color="#EF4444" title="ë¹¨ê°•"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #F59E0B" data-color="#F59E0B" title="ì£¼í™©"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #F9BC0B" data-color="#F9BC0B" title="ë…¸ë‘"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #84CC16" data-color="#84CC16" title="ì—°ë‘"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #10B981" data-color="#10B981" title="ì´ˆë¡"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #06B6D4" data-color="#06B6D4" title="í•˜ëŠ˜"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #3B82F6" data-color="#3B82F6" title="íŒŒë‘"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #6366F1" data-color="#6366F1" title="ë‚¨ìƒ‰"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #8B5CF6" data-color="#8B5CF6" title="ë³´ë¼"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #A855F7" data-color="#A855F7" title="ìì£¼"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #D946EF" data-color="#D946EF" title="ë¶„í™"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #EC4899" data-color="#EC4899" title="í•‘í¬"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #F43F5E" data-color="#F43F5E" title="ì¥ë¯¸"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #0EA5E9" data-color="#0EA5E9" title="ì²­ë¡"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #14B8A6" data-color="#14B8A6" title="ë¯¼íŠ¸"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #64748B" data-color="#64748B" title="íšŒìƒ‰"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #475569" data-color="#475569" title="ì§„íšŒìƒ‰"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #1E293B" data-color="#1E293B" title="ê²€ì •"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #78350F" data-color="#78350F" title="ê°ˆìƒ‰"></button>
                            <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-transparent hover:border-gray-400 transition" style="background-color: #BE123C" data-color="#BE123C" title="ì§„ë¹¨ê°•"></button>
                        </div>
                        <input type="hidden" id="classColor" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">ìˆ˜ì—… ìš”ì¼ ë° ì‹œê°„ *</label>
                        <div class="space-y-3" id="scheduleContainer">
                            <div class="schedule-day-item flex items-center space-x-2 p-3 border border-gray-200 rounded-lg">
                                <input type="checkbox" class="schedule-day-check rounded text-purple-600 focus:ring-purple-500" value="ì›”" id="day-mon">
                                <label for="day-mon" class="font-medium w-8">ì›”</label>
                                <input type="time" class="day-start-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="ì›”" placeholder="ì‹œì‘">
                                <span class="text-gray-400">~</span>
                                <input type="time" class="day-end-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="ì›”" placeholder="ì¢…ë£Œ">
                            </div>
                            <div class="schedule-day-item flex items-center space-x-2 p-3 border border-gray-200 rounded-lg">
                                <input type="checkbox" class="schedule-day-check rounded text-purple-600 focus:ring-purple-500" value="í™”" id="day-tue">
                                <label for="day-tue" class="font-medium w-8">í™”</label>
                                <input type="time" class="day-start-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="í™”" placeholder="ì‹œì‘">
                                <span class="text-gray-400">~</span>
                                <input type="time" class="day-end-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="í™”" placeholder="ì¢…ë£Œ">
                            </div>
                            <div class="schedule-day-item flex items-center space-x-2 p-3 border border-gray-200 rounded-lg">
                                <input type="checkbox" class="schedule-day-check rounded text-purple-600 focus:ring-purple-500" value="ìˆ˜" id="day-wed">
                                <label for="day-wed" class="font-medium w-8">ìˆ˜</label>
                                <input type="time" class="day-start-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="ìˆ˜" placeholder="ì‹œì‘">
                                <span class="text-gray-400">~</span>
                                <input type="time" class="day-end-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="ìˆ˜" placeholder="ì¢…ë£Œ">
                            </div>
                            <div class="schedule-day-item flex items-center space-x-2 p-3 border border-gray-200 rounded-lg">
                                <input type="checkbox" class="schedule-day-check rounded text-purple-600 focus:ring-purple-500" value="ëª©" id="day-thu">
                                <label for="day-thu" class="font-medium w-8">ëª©</label>
                                <input type="time" class="day-start-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="ëª©" placeholder="ì‹œì‘">
                                <span class="text-gray-400">~</span>
                                <input type="time" class="day-end-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="ëª©" placeholder="ì¢…ë£Œ">
                            </div>
                            <div class="schedule-day-item flex items-center space-x-2 p-3 border border-gray-200 rounded-lg">
                                <input type="checkbox" class="schedule-day-check rounded text-purple-600 focus:ring-purple-500" value="ê¸ˆ" id="day-fri">
                                <label for="day-fri" class="font-medium w-8">ê¸ˆ</label>
                                <input type="time" class="day-start-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="ê¸ˆ" placeholder="ì‹œì‘">
                                <span class="text-gray-400">~</span>
                                <input type="time" class="day-end-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="ê¸ˆ" placeholder="ì¢…ë£Œ">
                            </div>
                            <div class="schedule-day-item flex items-center space-x-2 p-3 border border-gray-200 rounded-lg">
                                <input type="checkbox" class="schedule-day-check rounded text-purple-600 focus:ring-purple-500" value="í† " id="day-sat">
                                <label for="day-sat" class="font-medium w-8">í† </label>
                                <input type="time" class="day-start-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="í† " placeholder="ì‹œì‘">
                                <span class="text-gray-400">~</span>
                                <input type="time" class="day-end-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="í† " placeholder="ì¢…ë£Œ">
                            </div>
                            <div class="schedule-day-item flex items-center space-x-2 p-3 border border-gray-200 rounded-lg">
                                <input type="checkbox" class="schedule-day-check rounded text-purple-600 focus:ring-purple-500" value="ì¼" id="day-sun">
                                <label for="day-sun" class="font-medium w-8">ì¼</label>
                                <input type="time" class="day-start-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="ì¼" placeholder="ì‹œì‘">
                                <span class="text-gray-400">~</span>
                                <input type="time" class="day-end-time flex-1 px-2 py-1 border border-gray-300 rounded text-sm" data-day="ì¼" placeholder="ì¢…ë£Œ">
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì„¤ëª…</label>
                        <textarea id="description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="ë°˜ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…"></textarea>
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button type="submit" class="flex-1 bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700">
                        ì €ì¥
                    </button>
                    <button type="button" onclick="hideModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">
                        ì·¨ì†Œ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const userStr = localStorage.getItem('user');
        
        // ë¡œê·¸ì¸ í™•ì¸
        if (!userStr) {
            alert('âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\\n\\në°˜ ê´€ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = '/login';
            throw new Error('Not logged in');
        }
        
        const currentUser = JSON.parse(userStr);
        const academyId = currentUser.id;
        
        console.log('ğŸ‘¤ Current User:', currentUser);
        console.log('ğŸ« Academy ID:', academyId);
        
        let classes = [];

        async function loadClasses() {
            try {
                console.log('ğŸ“¡ Loading classes for academy:', academyId);
                const userDataHeader = btoa(unescape(encodeURIComponent(JSON.stringify(currentUser))));
                console.log('ğŸ” Auth header length:', userDataHeader.length);
                
                const res = await fetch('/api/classes', {
                    headers: {
                        'X-User-Data-Base64': userDataHeader
                    }
                });
                
                console.log('ğŸ“¥ Response status:', res.status);
                const data = await res.json();
                console.log('ğŸ“¦ Response data:', data);
                
                if (data.success) {
                    classes = data.classes;
                    console.log('âœ… Loaded', classes.length, 'classes');
                    renderClasses();
                } else {
                    console.error('âŒ Load failed:', data.error);
                    alert('ë°˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨: ' + data.error);
                }
            } catch (error) {
                console.error('âŒ ë°˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
                alert('ë°˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function renderClasses() {
            const container = document.getElementById('classList');
            if (classes.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-12">ë“±ë¡ëœ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆ ë°˜ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>';
                return;
            }

            container.innerHTML = classes.map(cls => {
                let schedule = {};
                let scheduleDisplay = '';
                
                try {
                    schedule = cls.day_schedule ? JSON.parse(cls.day_schedule) : {};
                    scheduleDisplay = Object.keys(schedule).map(day => {
                        const time = schedule[day];
                        if (time && time.start && time.end) {
                            return day + ': ' + time.start + '~' + time.end;
                        }
                        return '';
                    }).filter(s => s).join(', ');
                } catch (e) {
                    console.error('Schedule parse error:', e);
                    scheduleDisplay = '';
                }
                
                // HTML í‘œì‹œìš©: íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
                const displayName = (cls.class_name || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                const displayGrade = (cls.grade || 'í•™ë…„ ë¯¸ì§€ì •').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                const displayDescription = (cls.description || 'ì„¤ëª… ì—†ìŒ').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                
                return '<div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition border-l-4" style="border-left-color: ' + (cls.color || '#8B5CF6') + '">' +
                    '<div class="flex justify-between items-start mb-4">' +
                        '<div>' +
                            '<div class="flex items-center space-x-2">' +
                                '<div class="w-4 h-4 rounded-full" style="background-color: ' + (cls.color || '#8B5CF6') + '"></div>' +
                                '<h3 class="text-xl font-bold text-gray-900">' + displayName + '</h3>' +
                            '</div>' +
                            '<p class="text-sm text-gray-500 mt-1">' + displayGrade + '</p>' +
                        '</div>' +
                        '<div class="flex space-x-2">' +
                            '<button onclick="editClass(' + cls.id + ')" class="text-blue-600 hover:text-blue-800">' +
                                '<i class="fas fa-edit"></i>' +
                            '</button>' +
                            '<button onclick="deleteClass(' + cls.id + ', ' + JSON.stringify(cls.class_name || '') + ')" class="text-red-600 hover:text-red-800">' +
                                '<i class="fas fa-trash"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                    (scheduleDisplay ? 
                        '<div class="mb-3 bg-gray-50 p-3 rounded-lg">' +
                            '<span class="text-xs text-gray-500 block mb-1"><i class="fas fa-calendar-alt mr-1"></i>ìˆ˜ì—… ìŠ¤ì¼€ì¤„:</span>' +
                            '<span class="text-xs font-medium text-gray-700">' + scheduleDisplay + '</span>' +
                        '</div>'
                     : '') +
                    '<p class="text-gray-600 mb-4 text-sm">' + displayDescription + '</p>' +
                    '<div class="flex justify-between items-center pt-4 border-t">' +
                        '<span class="text-sm text-gray-500">' +
                            '<i class="fas fa-users mr-2"></i>í•™ìƒ ' + cls.student_count + 'ëª…' +
                        '</span>' +
                        '<a href="/students/list?classId=' + cls.id + '" class="text-purple-600 hover:text-purple-800 font-medium">' +
                            'í•™ìƒ ë³´ê¸° â†’' +
                        '</a>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'ìƒˆ ë°˜ ì¶”ê°€';
            document.getElementById('classForm').reset();
            document.getElementById('classId').value = '';
            document.getElementById('classColor').value = '';
            
            // ëª¨ë“  ìƒ‰ìƒ ë²„íŠ¼ ì„ íƒ í•´ì œ
            document.querySelectorAll('.color-option').forEach(btn => {
                btn.classList.remove('border-purple-600', 'border-4');
            });
            
            // ëª¨ë“  ìŠ¤ì¼€ì¤„ ì²´í¬ë°•ìŠ¤ì™€ ì‹œê°„ ì´ˆê¸°í™”
            document.querySelectorAll('.schedule-day-check').forEach(cb => cb.checked = false);
            document.querySelectorAll('.day-start-time, .day-end-time').forEach(input => {
                input.value = '';
                input.disabled = true;
            });
            
            document.getElementById('classModal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('classModal').classList.add('hidden');
        }

        function editClass(classId) {
            const cls = classes.find(c => c.id === classId);
            if (!cls) return;

            document.getElementById('modalTitle').textContent = 'ë°˜ ìˆ˜ì •';
            document.getElementById('classId').value = cls.id;
            document.getElementById('className').value = cls.class_name;
            document.getElementById('grade').value = cls.grade || '';
            document.getElementById('description').value = cls.description || '';
            
            // ìƒ‰ìƒ ì„¤ì •
            document.getElementById('classColor').value = cls.color || '#8B5CF6';
            document.querySelectorAll('.color-option').forEach(btn => {
                if (btn.dataset.color === cls.color) {
                    btn.classList.add('border-purple-600', 'border-4');
                } else {
                    btn.classList.remove('border-purple-600', 'border-4');
                }
            });
            
            // ìš”ì¼ë³„ ì‹œê°„ ì„¤ì •
            const daySchedule = cls.day_schedule ? JSON.parse(cls.day_schedule) : {};
            
            document.querySelectorAll('.schedule-day-check').forEach(cb => {
                const day = cb.value;
                cb.checked = daySchedule[day] !== undefined;
                
                const startInput = document.querySelector('.day-start-time[data-day="' + day + '"]');
                const endInput = document.querySelector('.day-end-time[data-day="' + day + '"]');
                
                if (daySchedule[day]) {
                    startInput.value = daySchedule[day].start || '';
                    endInput.value = daySchedule[day].end || '';
                    startInput.disabled = false;
                    endInput.disabled = false;
                } else {
                    startInput.value = '';
                    endInput.value = '';
                    startInput.disabled = true;
                    endInput.disabled = true;
                }
            });
            
            document.getElementById('classModal').classList.remove('hidden');
        }

        async function deleteClass(classId, className) {
            if (!confirm(`"${className}" ë°˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nâš ï¸ ì´ ë°˜ì˜ í•™ìƒë“¤ì€ ë°˜ ë°°ì •ì´ í•´ì œë©ë‹ˆë‹¤.`)) return;

            console.log('ğŸ—‘ï¸ Deleting class:', classId);
            console.log('ğŸ—‘ï¸ currentUser:', currentUser);
            console.log('ğŸ—‘ï¸ academyId:', academyId);

            try {
                // currentUserê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                const userToSend = currentUser || { id: academyId };
                // UTF-8 ì•ˆì „í•œ Base64 ì¸ì½”ë”©
                const userDataHeader = btoa(unescape(encodeURIComponent(JSON.stringify(userToSend))));
                
                console.log('ğŸ—‘ï¸ Sending DELETE request...');
                console.log('ğŸ—‘ï¸ URL:', '/api/classes/' + classId);
                console.log('ğŸ—‘ï¸ Header length:', userDataHeader.length);
                
                const res = await fetch('/api/classes/' + classId, { 
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Data-Base64': userDataHeader
                    }
                });
                
                console.log('ğŸ—‘ï¸ Delete response status:', res.status);
                console.log('ğŸ—‘ï¸ Delete response headers:', [...res.headers.entries()]);
                
                const responseText = await res.text();
                console.log('ğŸ—‘ï¸ Delete response text:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('ğŸ—‘ï¸ Failed to parse response:', e);
                    alert('ì‚­ì œ ì‹¤íŒ¨: ì„œë²„ ì‘ë‹µì„ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                console.log('ğŸ—‘ï¸ Delete response data:', data);
                
                if (data.success) {
                    alert('ë°˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await loadClasses();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    console.error('ğŸ—‘ï¸ Delete failed:', data);
                }
            } catch (error) {
                console.error('ğŸ—‘ï¸ Delete error:', error);
                console.error('ğŸ—‘ï¸ Error stack:', error.stack);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        document.getElementById('classForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const classId = document.getElementById('classId').value;
            const color = document.getElementById('classColor').value;
            
            if (!color) {
                alert('ë°˜ ìƒ‰ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìš”ì¼ë³„ ì‹œê°„ ìˆ˜ì§‘
            const daySchedule = {};
            let hasSchedule = false;
            
            document.querySelectorAll('.schedule-day-check:checked').forEach(cb => {
                const day = cb.value;
                const startInput = document.querySelector('.day-start-time[data-day="' + day + '"]');
                const endInput = document.querySelector('.day-end-time[data-day="' + day + '"]');
                
                if (startInput && endInput && startInput.value && endInput.value) {
                    daySchedule[day] = {
                        start: startInput.value,
                        end: endInput.value
                    };
                    hasSchedule = true;
                }
            });
            
            if (!hasSchedule) {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ ìˆ˜ì—… ìš”ì¼ê³¼ ì‹œê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const payload = {
                academyId,
                className: document.getElementById('className').value,
                grade: document.getElementById('grade').value,
                description: document.getElementById('description').value,
                color: color,
                daySchedule: JSON.stringify(daySchedule)
            };

            console.log('ğŸ“¤ Submitting class:', payload);

            try {
                const url = classId ? '/api/classes/' + classId : '/api/classes';
                const method = classId ? 'PUT' : 'POST';
                
                const userDataHeader = btoa(unescape(encodeURIComponent(JSON.stringify(currentUser))));
                
                const res = await fetch(url, {
                    method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-User-Data-Base64': userDataHeader
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                
                if (data.success) {
                    hideModal();
                    await loadClasses();
                    alert(classId ? 'ë°˜ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒˆ ë°˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + data.error);
                }
            } catch (error) {
                console.error('âŒ Request error:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });
        
        // ìƒ‰ìƒ ì„ íƒ ì´ë²¤íŠ¸
        document.querySelectorAll('.color-option').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.color-option').forEach(b => {
                    b.classList.remove('border-purple-600', 'border-4');
                });
                btn.classList.add('border-purple-600', 'border-4');
                document.getElementById('classColor').value = btn.dataset.color;
            });
        });
        
        // ìš”ì¼ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        document.querySelectorAll('.schedule-day-check').forEach(cb => {
            cb.addEventListener('change', (e) => {
                const day = e.target.value;
                const startInput = document.querySelector('.day-start-time[data-day="' + day + '"]');
                const endInput = document.querySelector('.day-end-time[data-day="' + day + '"]');
                
                if (e.target.checked) {
                    startInput.disabled = false;
                    endInput.disabled = false;
                } else {
                    startInput.disabled = true;
                    endInput.disabled = true;
                    startInput.value = '';
                    endInput.value = '';
                }
            });
        });

        loadClasses();
    </script>
</body>
</html>
