<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµìœ¡ë¹„ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
        * { font-family: 'Pretendard Variable', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- í—¤ë” -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ’° êµìœ¡ë¹„ ê´€ë¦¬</h1>
                <p class="text-gray-600">í•™ìƒë³„ êµìœ¡ë¹„ ë‚©ì… í˜„í™©ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
            </div>
            <a href="/dashboard" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                <i class="fas fa-arrow-left mr-2"></i> ëŒ€ì‹œë³´ë“œ
            </a>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-600">ì´ í•™ìƒ ìˆ˜</span>
                    <i class="fas fa-users text-blue-500"></i>
                </div>
                <div class="text-3xl font-bold text-gray-900" id="totalStudents">0</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-600">ì™„ë‚© í•™ìƒ</span>
                    <i class="fas fa-check-circle text-green-500"></i>
                </div>
                <div class="text-3xl font-bold text-green-600" id="paidStudents">0</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-600">ë¯¸ë‚© í•™ìƒ</span>
                    <i class="fas fa-exclamation-circle text-red-500"></i>
                </div>
                <div class="text-3xl font-bold text-red-600" id="unpaidStudents">0</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium text-gray-600">ì´ ê¸ˆì•¡</span>
                    <i class="fas fa-won-sign text-purple-500"></i>
                </div>
                <div class="text-3xl font-bold text-gray-900" id="totalAmount">0ì›</div>
            </div>
        </div>

        <!-- í•„í„° ì˜ì—­ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë…„ë„</label>
                    <select id="yearFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì›”</label>
                    <select id="monthFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="1">1ì›”</option>
                        <option value="2">2ì›”</option>
                        <option value="3">3ì›”</option>
                        <option value="4">4ì›”</option>
                        <option value="5">5ì›”</option>
                        <option value="6">6ì›”</option>
                        <option value="7">7ì›”</option>
                        <option value="8">8ì›”</option>
                        <option value="9">9ì›”</option>
                        <option value="10">10ì›”</option>
                        <option value="11">11ì›”</option>
                        <option value="12">12ì›”</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ìƒíƒœ</label>
                    <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´</option>
                        <option value="paid">ì™„ë‚©</option>
                        <option value="unpaid">ë¯¸ë‚©</option>
                        <option value="partial">ë¶€ë¶„ë‚©</option>
                        <option value="overdue">ì—°ì²´</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="loadPayments()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                        <i class="fas fa-search mr-2"></i>ì¡°íšŒ
                    </button>
                </div>
            </div>
        </div>

        <!-- í•™ìƒ ëª©ë¡ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">í•™ìƒëª…</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">í•™ë…„</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">êµìœ¡ë¹„</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ë‚©ì…ì•¡</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ìƒíƒœ</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ë‚©ì…ì¼</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="paymentList" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                ë¡œë”© ì¤‘...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ë‚©ì… ì²˜ë¦¬ ëª¨ë‹¬ -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-900">ë‚©ì… ì²˜ë¦¬</h3>
            </div>
            <div class="p-6">
                <input type="hidden" id="modalStudentId">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">í•™ìƒëª…</label>
                    <input type="text" id="modalStudentName" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">êµìœ¡ë¹„</label>
                    <input type="text" id="modalAmount" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë‚©ì…ì•¡</label>
                    <input type="number" id="modalPaidAmount" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë‚©ì… ë°©ë²•</label>
                    <select id="modalPaymentMethod" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">ì„ íƒ</option>
                        <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                        <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                        <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë©”ëª¨</label>
                    <textarea id="modalMemo" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                    ì·¨ì†Œ
                </button>
                <button onclick="savePayment()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    ì €ì¥
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // ì‚¬ìš©ì ì •ë³´ í™•ì¸ ë° ê¶Œí•œ ì²´í¬
        function checkAuth() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.id) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return null;
            }
            
            // ì„ ìƒë‹˜ì€ ì ‘ê·¼ ë¶ˆê°€
            if (user.user_type === 'teacher') {
                alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = '/dashboard';
                return null;
            }
            
            return user;
        }

        // ë…„ë„ í•„í„° ì´ˆê¸°í™”
        function initYearFilter() {
            const yearFilter = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'ë…„';
                if (year === currentYear) option.selected = true;
                yearFilter.appendChild(option);
            }
        }

        // ì›” í•„í„° ì´ˆê¸°í™”
        function initMonthFilter() {
            const monthFilter = document.getElementById('monthFilter');
            const currentMonth = new Date().getMonth() + 1;
            monthFilter.value = currentMonth;
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            
            try {
                const response = await fetch(`/api/tuition/stats?year=${year}&month=${month}`, {
                    headers: {
                        'X-User-Data-Base64': btoa(JSON.stringify(currentUser))
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.stats) {
                    document.getElementById('totalStudents').textContent = data.stats.total_students || 0;
                    document.getElementById('paidStudents').textContent = data.stats.paid_count || 0;
                    document.getElementById('unpaidStudents').textContent = data.stats.unpaid_count || 0;
                    document.getElementById('totalAmount').textContent = ((data.stats.total_amount || 0).toLocaleString()) + 'ì›';
                }
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë‚©ì… í˜„í™© ë¡œë“œ
        async function loadPayments() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            const paymentList = document.getElementById('paymentList');
            paymentList.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>ë¡œë”© ì¤‘...</td></tr>';
            
            try {
                let url = `/api/tuition/payments?year=${year}&month=${month}`;
                if (status) url += `&status=${status}`;
                
                const response = await fetch(url, {
                    headers: {
                        'X-User-Data-Base64': btoa(JSON.stringify(currentUser))
                    }
                });
                
                const data = await response.json();
                
                if (!data.success || !data.payments || data.payments.length === 0) {
                    paymentList.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500"><i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i><div>ë‚©ì… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></td></tr>';
                    return;
                }
                
                paymentList.innerHTML = data.payments.map(payment => {
                    let statusBadge = '';
                    if (payment.status === 'paid') {
                        statusBadge = '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">ì™„ë‚©</span>';
                    } else if (payment.status === 'partial') {
                        statusBadge = '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-medium">ë¶€ë¶„ë‚©</span>';
                    } else if (payment.status === 'overdue') {
                        statusBadge = '<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium">ì—°ì²´</span>';
                    } else {
                        statusBadge = '<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">ë¯¸ë‚©</span>';
                    }
                    
                    return `<tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${payment.student_name}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${payment.grade || '-'}</td>
                        <td class="px-6 py-4 text-sm font-bold text-blue-600">${(payment.amount || 0).toLocaleString()}ì›</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${(payment.paid_amount || 0).toLocaleString()}ì›</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${payment.paid_date || '-'}</td>
                        <td class="px-6 py-4">
                            <button onclick="openModal(${payment.student_id}, '${payment.student_name}', ${payment.amount})" 
                                    class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                                <i class="fas fa-edit mr-1"></i>ì²˜ë¦¬
                            </button>
                        </td>
                    </tr>`;
                }).join('');
                
                // í†µê³„ë„ í•¨ê»˜ ë¡œë“œ
                loadStats();
            } catch (error) {
                console.error('ë‚©ì… í˜„í™© ë¡œë“œ ì‹¤íŒ¨:', error);
                paymentList.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-red-500"><i class="fas fa-exclamation-circle text-4xl mb-4"></i><div>ë‚©ì… í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div></td></tr>';
            }
        }

        // ëª¨ë‹¬ ì—´ê¸°
        function openModal(studentId, studentName, amount) {
            document.getElementById('modalStudentId').value = studentId;
            document.getElementById('modalStudentName').value = studentName;
            document.getElementById('modalAmount').value = amount.toLocaleString() + 'ì›';
            document.getElementById('modalPaidAmount').value = amount;
            document.getElementById('paymentModal').classList.remove('hidden');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('paymentModal').classList.add('hidden');
        }

        // ë‚©ì… ì €ì¥
        async function savePayment() {
            const studentId = document.getElementById('modalStudentId').value;
            const paidAmount = parseInt(document.getElementById('modalPaidAmount').value);
            const paymentMethod = document.getElementById('modalPaymentMethod').value;
            const memo = document.getElementById('modalMemo').value;
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            
            if (!paidAmount) {
                alert('ë‚©ì…ì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('/api/tuition/mark-paid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Data-Base64': btoa(JSON.stringify(currentUser))
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        year: parseInt(year),
                        month: parseInt(month),
                        paid_amount: paidAmount,
                        payment_method: paymentMethod,
                        memo: memo
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('ë‚©ì… ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeModal();
                    loadPayments();
                } else {
                    alert(data.error || 'ë‚©ì… ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë‚©ì… ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ë‚©ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', function() {
            currentUser = checkAuth();
            if (!currentUser) return;
            
            initYearFilter();
            initMonthFilter();
            loadPayments();
        });
    </script>
</body>
</html>
