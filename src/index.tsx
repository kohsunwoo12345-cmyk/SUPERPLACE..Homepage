// SUPERPLACE Academy - Complete Restructure 2026
import { Hono } from 'hono'
import { cors } from 'hono/cors'
import { getCookie } from 'hono/cookie'
import { serveStatic } from 'hono/cloudflare-workers'
// FIXME: student-routes.ts temporarily disabled due to teacher_classes error
// import studentRoutes from './student-routes'
import studentPages from './student-pages'
import formBuilderRoutes from './form-builder-routes'
import tuitionRoutes from './tuition-routes'
import revenueRoutes from './revenue-routes'

type Bindings = {
  DB: D1Database
  R2: R2Bucket
  OPENAI_API_KEY?: string
  OPENAI_BASE_URL?: string
  ALIGO_API_KEY?: string
  ALIGO_USER_ID?: string
  GOOGLE_CLIENT_ID?: string
  KAKAO_JS_KEY?: string
}

const app = new Hono<{ Bindings: Bindings }>()

// Enable CORS for API routes
app.use('/api/*', cors())

// Serve static files
app.use('/static/*', serveStatic({ root: './public' }))

// Mount student management routes
// FIXME: student-routes.tsì˜ /api/studentsê°€ index.tsxì˜ /api/studentsë³´ë‹¤ ìš°ì„ ë˜ì–´
// teacher_classes ì—ëŸ¬ ë°œìƒ. ì„ì‹œë¡œ ì£¼ì„ ì²˜ë¦¬í•˜ê³  index.tsxì˜ ë¼ìš°íŠ¸ë§Œ ì‚¬ìš©
// app.route('/', studentRoutes)

// Mount form builder routes (í¼ í…œí”Œë¦¿ ë° ì œì¶œ ê´€ë¦¬)
app.route('/', formBuilderRoutes)

// Mount tuition management routes (êµìœ¡ë¹„ ê´€ë¦¬ - ì›ì¥ë‹˜ ì „ìš©)
app.route('/', tuitionRoutes)

// Mount revenue management routes (ë§¤ì¶œ ê´€ë¦¬ - ì›ì¥ë‹˜ ì „ìš©)
app.route('/', revenueRoutes)

// ========================================
// API Routes
// ========================================

// ë¬¸ì˜ ì ‘ìˆ˜ API
app.post('/api/contact', async (c) => {
  try {
    const { name, email, phone, academy_name, message } = await c.req.json()
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!name || !email || !phone || !message) {
      return c.json({ success: false, error: 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // DB ì €ì¥
    const result = await c.env.DB.prepare(`
      INSERT INTO contacts (name, email, phone, academy_name, message)
      VALUES (?, ?, ?, ?, ?)
    `).bind(name, email, phone, academy_name || '', message).run()

    return c.json({ 
      success: true, 
      message: 'ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
      id: result.meta.last_row_id 
    })
  } catch (err) {
    console.error('Contact submission error:', err)
    return c.json({ success: false, error: 'ë¬¸ì˜ ì ‘ìˆ˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// íšŒì›ê°€ì… API
app.post('/api/signup', async (c) => {
  try {
    const { 
      email, 
      password, 
      name, 
      phone, 
      academy_name, 
      academy_location,
      marketing_consent
    } = await c.req.json()
    
    if (!email || !password || !name || !phone || !academy_name) {
      return c.json({ success: false, error: 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸
    const existing = await c.env.DB.prepare(`
      SELECT id FROM users WHERE email = ?
    `).bind(email).first()

    if (existing) {
      return c.json({ success: false, error: 'ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.' }, 400)
    }

    // ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (ì‹¤ì œë¡œëŠ” bcrypt ë“± ì‚¬ìš© ê¶Œì¥)
    const hashedPassword = password // TODO: ì‹¤ì œ í”„ë¡œì íŠ¸ì—ì„œëŠ” í•´ì‹± í•„ìš”

    // ë§ˆì¼€íŒ… ìˆ˜ì‹  ë™ì˜ ê°’ (í†µí•© ë™ì˜: ëª¨ë“  ì±„ë„ì— ë™ì¼í•˜ê²Œ ì ìš©)
    const consent = marketing_consent ? 1 : 0
    const consentDate = consent ? new Date().toISOString() : null

    // ğŸ”¥ STEP 1: ë¨¼ì € ì‚¬ìš©ì ìƒì„± (academy_idëŠ” NULL)
    const result = await c.env.DB.prepare(`
      INSERT INTO users (
        email, password, name, phone, academy_name, role, user_type,
        marketing_sms_consent, marketing_email_consent, marketing_kakao_consent, marketing_consent_date
      )
      VALUES (?, ?, ?, ?, ?, 'director', 'director', ?, ?, ?, ?)
    `).bind(
      email, 
      hashedPassword, 
      name, 
      phone, 
      academy_name || '', 
      consent,  // SMS
      consent,  // Email
      consent,  // Kakao (ëª¨ë‘ ë™ì¼í•œ ê°’)
      consentDate
    ).run()

    const userId = result.meta.last_row_id

    // ğŸ”¥ STEP 2: ì›ì¥ë‹˜ì˜ academy_idë¥¼ ìì‹ ì˜ idë¡œ ì„¤ì •
    // ì´ë ‡ê²Œ í•˜ë©´ ì›ì¥ë‹˜ê³¼ ì„ ìƒë‹˜ì´ ê°™ì€ academy_idë¥¼ ê³µìœ í•˜ê²Œ ë¨
    await c.env.DB.prepare(`
      UPDATE users 
      SET academy_id = ?
      WHERE id = ?
    `).bind(userId, userId).run()

    console.log(`[Signup] Director created with id=${userId}, academy_id=${userId}`)

    return c.json({ 
      success: true, 
      message: 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      id: userId 
    })
  } catch (err) {
    console.error('Signup error:', err)
    return c.json({ success: false, error: 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// DB Health Check API
app.get('/api/health', async (c) => {
  try {
    // DB ë°”ì¸ë”© í™•ì¸
    if (!c.env.DB) {
      return c.json({ 
        success: false, 
        error: 'DB binding not found',
        env_keys: Object.keys(c.env)
      }, 500)
    }

    // ê°„ë‹¨í•œ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
    const testResult = await c.env.DB.prepare('SELECT 1 as test').first()
    
    // users í…Œì´ë¸” êµ¬ì¡° í™•ì¸
    const tableInfo = await c.env.DB.prepare(`PRAGMA table_info(users)`).all()
    
    return c.json({ 
      success: true, 
      message: 'DB connection is healthy',
      test_result: testResult,
      users_table_columns: tableInfo.results.map(col => col.name)
    })
  } catch (err) {
    return c.json({ 
      success: false, 
      error: err.message,
      stack: err.stack
    }, 500)
  }
})

// ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ ëª©ë¡ ì¡°íšŒ API
app.get('/api/consulting/programs', async (c) => {
  try {
    if (!c.env.DB) {
      return c.json({ success: false, error: 'DB not configured' }, 500);
    }

    const programs = await c.env.DB.prepare(
      'SELECT * FROM consulting_programs ORDER BY created_at DESC'
    ).all();

    return c.json({ success: true, programs: programs.results });
  } catch (err) {
    console.error('ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ ì¡°íšŒ ì˜¤ë¥˜:', err);
    return c.json({ success: false, error: err.message }, 500);
  }
});

// ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ ìƒì„¸ ì¡°íšŒ API
app.get('/api/consulting/programs/:programId', async (c) => {
  try {
    if (!c.env.DB) {
      return c.json({ success: false, error: 'DB not configured' }, 500);
    }

    const programId = c.req.param('programId');
    const program = await c.env.DB.prepare(
      'SELECT * FROM consulting_programs WHERE program_id = ?'
    ).bind(programId).first();

    if (!program) {
      return c.json({ success: false, error: 'Program not found' }, 404);
    }

    return c.json({ success: true, program });
  } catch (err) {
    console.error('ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ ìƒì„¸ ì¡°íšŒ ì˜¤ë¥˜:', err);
    return c.json({ success: false, error: err.message }, 500);
  }
});

// ì»¨ì„¤íŒ… ìˆ˜ê°• ì‹ ì²­ API
app.post('/api/consulting/apply', async (c) => {
  try {
    if (!c.env.DB) {
      return c.json({ success: false, error: 'DB not configured' }, 500);
    }

    const body = await c.req.json();
    const { program_id, user_id, academy_id, applicant_name, applicant_email, applicant_phone, academy_name, message } = body;

    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    if (!program_id || !user_id || !applicant_name || !applicant_email || !applicant_phone) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400);
    }

    // í”„ë¡œê·¸ë¨ ì¡´ì¬ í™•ì¸
    const program = await c.env.DB.prepare(
      'SELECT * FROM consulting_programs WHERE program_id = ?'
    ).bind(program_id).first();

    if (!program) {
      return c.json({ success: false, error: 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.' }, 404);
    }

    // ì¤‘ë³µ ì‹ ì²­ í™•ì¸
    const existing = await c.env.DB.prepare(
      'SELECT * FROM consulting_applications WHERE program_id = ? AND user_id = ? AND status = "pending"'
    ).bind(program_id, user_id).first();

    if (existing) {
      return c.json({ success: false, error: 'ì´ë¯¸ ì‹ ì²­í•œ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤.' }, 400);
    }

    // ì‹ ì²­ ë“±ë¡
    const result = await c.env.DB.prepare(`
      INSERT INTO consulting_applications 
      (program_id, user_id, academy_id, applicant_name, applicant_email, applicant_phone, academy_name, message)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(program_id, user_id, academy_id, applicant_name, applicant_email, applicant_phone, academy_name, message).run();

    return c.json({ 
      success: true, 
      message: 'ìˆ˜ê°• ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
      applicationId: result.meta.last_row_id 
    });
  } catch (err) {
    console.error('ì»¨ì„¤íŒ… ì‹ ì²­ ì˜¤ë¥˜:', err);
    return c.json({ success: false, error: err.message }, 500);
  }
});

// ì»¨ì„¤íŒ… ì‹ ì²­ ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ììš©)
app.get('/api/admin/consulting/applications', async (c) => {
  try {
    if (!c.env.DB) {
      return c.json({ success: false, error: 'DB not configured' }, 500);
    }

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const sessionCookie = c.req.header('Cookie')?.split(';').find(c => c.trim().startsWith('session='));
    if (!sessionCookie) {
      return c.json({ success: false, error: 'Unauthorized' }, 401);
    }

    const applications = await c.env.DB.prepare(`
      SELECT 
        ca.*,
        cp.name as program_name,
        cp.price as program_price,
        u.email as user_email
      FROM consulting_applications ca
      LEFT JOIN consulting_programs cp ON ca.program_id = cp.program_id
      LEFT JOIN users u ON ca.user_id = u.id
      ORDER BY ca.applied_at DESC
    `).all();

    return c.json({ success: true, applications: applications.results });
  } catch (err) {
    console.error('ì»¨ì„¤íŒ… ì‹ ì²­ ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:', err);
    return c.json({ success: false, error: err.message }, 500);
  }
});

// ì»¨ì„¤íŒ… ì‹ ì²­ ìŠ¹ì¸ API
app.post('/api/admin/consulting/applications/:id/approve', async (c) => {
  try {
    if (!c.env.DB) {
      return c.json({ success: false, error: 'DB not configured' }, 500);
    }

    const applicationId = c.req.param('id');
    const body = await c.req.json();
    const { admin_id } = body;

    await c.env.DB.prepare(`
      UPDATE consulting_applications 
      SET status = 'approved', processed_at = CURRENT_TIMESTAMP, processed_by = ?
      WHERE id = ?
    `).bind(admin_id, applicationId).run();

    return c.json({ success: true, message: 'ì‹ ì²­ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } catch (err) {
    console.error('ì»¨ì„¤íŒ… ì‹ ì²­ ìŠ¹ì¸ ì˜¤ë¥˜:', err);
    return c.json({ success: false, error: err.message }, 500);
  }
});

// ì»¨ì„¤íŒ… ì‹ ì²­ ê±°ë¶€ API
app.post('/api/admin/consulting/applications/:id/reject', async (c) => {
  try {
    if (!c.env.DB) {
      return c.json({ success: false, error: 'DB not configured' }, 500);
    }

    const applicationId = c.req.param('id');
    const body = await c.req.json();
    const { admin_id, reason } = body;

    await c.env.DB.prepare(`
      UPDATE consulting_applications 
      SET status = 'rejected', processed_at = CURRENT_TIMESTAMP, processed_by = ?, reject_reason = ?
      WHERE id = ?
    `).bind(admin_id, reason, applicationId).run();

    return c.json({ success: true, message: 'ì‹ ì²­ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.' });
  } catch (err) {
    console.error('ì»¨ì„¤íŒ… ì‹ ì²­ ê±°ë¶€ ì˜¤ë¥˜:', err);
    return c.json({ success: false, error: err.message }, 500);
  }
});

// ë¡œê·¸ì¸ API
app.post('/api/login', async (c) => {
  try {
    // DB ë°”ì¸ë”© í™•ì¸
    if (!c.env.DB) {
      return c.json({ 
        success: false, 
        error: 'DB binding not configured. Please check Cloudflare Pages settings.',
        debug: {
          env_keys: Object.keys(c.env),
          has_db: !!c.env.DB
        }
      }, 500)
    }

    const { email, password } = await c.req.json()
    
    if (!email || !password) {
      return c.json({ success: false, error: 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ì‚¬ìš©ì ì¡°íšŒ (ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì»¬ëŸ¼ì— ë§ì¶° ìˆ˜ì •)
    const user = await c.env.DB.prepare(`
      SELECT id, email, name, role, points, academy_name, user_type, academy_id, parent_user_id 
      FROM users WHERE email = ? AND password = ?
    `).bind(email, password).first()

    if (!user) {
      return c.json({ success: false, error: 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' }, 401)
    }

    // ì„¸ì…˜ ìƒì„±
    const sessionId = crypto.randomUUID()
    const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7ì¼
    
    await c.env.DB.prepare(`
      INSERT INTO sessions (session_id, user_id, expires_at)
      VALUES (?, ?, ?)
    `).bind(sessionId, user.id, expiresAt.toISOString()).run()

    // ì¿ í‚¤ ì„¤ì •
    c.header('Set-Cookie', `session_id=${sessionId}; Path=/; HttpOnly; Secure; SameSite=Lax; Max-Age=${7 * 24 * 60 * 60}`)

    return c.json({ 
      success: true, 
      message: 'ë¡œê·¸ì¸ ì„±ê³µ',
      user: { 
        id: user.id, 
        email: user.email, 
        name: user.name, 
        role: user.role, 
        points: user.points || 0,
        academy_name: user.academy_name || '',
        user_type: user.user_type || 'director', // DBì—ì„œ ê°€ì ¸ì˜¨ ê°’ ì‚¬ìš©
        academy_id: user.academy_id, // ì¤‘ìš”!
        parent_user_id: user.parent_user_id // ì¤‘ìš”!
      }
    })
  } catch (err) {
    console.error('Login error:', err)
    console.error('Login error details:', {
      message: err.message,
      stack: err.stack,
      name: err.name
    })
    return c.json({ 
      success: false, 
      error: 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      debug: {
        error_message: err.message,
        error_name: err.name,
        has_db: !!c.env.DB
      }
    }, 500)
  }
})

// êµ¬ê¸€ ì†Œì…œ ë¡œê·¸ì¸ API
app.post('/api/auth/google', async (c) => {
  try {
    const { idToken, email, name, picture } = await c.req.json()
    
    if (!idToken || !email) {
      return c.json({ success: false, error: 'êµ¬ê¸€ ì¸ì¦ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)
    }

    // êµ¬ê¸€ IDë¡œ ì‚¬ìš©ì ì¡°íšŒ
    let user = await c.env.DB.prepare(`
      SELECT id, email, name, role, points, google_id FROM users WHERE google_id = ?
    `).bind(idToken).first()

    // ì´ë©”ì¼ë¡œ ê¸°ì¡´ ì‚¬ìš©ì ì¡°íšŒ (êµ¬ê¸€ IDê°€ ì—†ëŠ” ê²½ìš°)
    if (!user) {
      user = await c.env.DB.prepare(`
        SELECT id, email, name, role, points, google_id FROM users WHERE email = ?
      `).bind(email).first()

      // ê¸°ì¡´ ì‚¬ìš©ìì—ê²Œ êµ¬ê¸€ ID ì—°ë™
      if (user && !user.google_id) {
        await c.env.DB.prepare(`
          UPDATE users SET google_id = ?, profile_image = ?, social_provider = 'google', updated_at = CURRENT_TIMESTAMP WHERE id = ?
        `).bind(idToken, picture || null, user.id).run()
        
        user.google_id = idToken
      }
    }

    // ì‹ ê·œ ì‚¬ìš©ìì¸ ê²½ìš°
    if (!user) {
      return c.json({ 
        success: false, 
        needsRegistration: true,
        socialData: {
          provider: 'google',
          email: email,
          name: name,
          picture: picture,
          google_id: idToken
        },
        message: 'íšŒì›ê°€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      }, 200)
    }

    return c.json({ 
      success: true, 
      message: 'êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ',
      user: { 
        id: user.id, 
        email: user.email, 
        name: user.name, 
        role: user.role, 
        points: user.points || 0,
        profile_image: user.profile_image
      }
    })
  } catch (err) {
    console.error('Google login error:', err)
    return c.json({ success: false, error: 'êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì¹´ì¹´ì˜¤ ì†Œì…œ ë¡œê·¸ì¸ API
app.post('/api/auth/kakao', async (c) => {
  try {
    const { accessToken, id, email, nickname, profile_image } = await c.req.json()
    
    if (!accessToken || !id) {
      return c.json({ success: false, error: 'ì¹´ì¹´ì˜¤ ì¸ì¦ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)
    }

    const kakaoId = String(id)

    // ì¹´ì¹´ì˜¤ IDë¡œ ì‚¬ìš©ì ì¡°íšŒ
    let user = await c.env.DB.prepare(`
      SELECT id, email, name, role, points, kakao_id FROM users WHERE kakao_id = ?
    `).bind(kakaoId).first()

    // ì´ë©”ì¼ë¡œ ê¸°ì¡´ ì‚¬ìš©ì ì¡°íšŒ (ì¹´ì¹´ì˜¤ IDê°€ ì—†ëŠ” ê²½ìš°)
    if (!user && email) {
      user = await c.env.DB.prepare(`
        SELECT id, email, name, role, points, kakao_id FROM users WHERE email = ?
      `).bind(email).first()

      // ê¸°ì¡´ ì‚¬ìš©ìì—ê²Œ ì¹´ì¹´ì˜¤ ID ì—°ë™
      if (user && !user.kakao_id) {
        await c.env.DB.prepare(`
          UPDATE users SET kakao_id = ?, profile_image = ?, social_provider = 'kakao', updated_at = CURRENT_TIMESTAMP WHERE id = ?
        `).bind(kakaoId, profile_image || null, user.id).run()
        
        user.kakao_id = kakaoId
      }
    }

    // ì‹ ê·œ ì‚¬ìš©ìì¸ ê²½ìš°
    if (!user) {
      return c.json({ 
        success: false, 
        needsRegistration: true,
        socialData: {
          provider: 'kakao',
          email: email || '',
          name: nickname || '',
          picture: profile_image || '',
          kakao_id: kakaoId
        },
        message: 'íšŒì›ê°€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      }, 200)
    }

    return c.json({ 
      success: true, 
      message: 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì„±ê³µ',
      user: { 
        id: user.id, 
        email: user.email, 
        name: user.name, 
        role: user.role, 
        points: user.points || 0,
        profile_image: user.profile_image
      }
    })
  } catch (err) {
    console.error('Kakao login error:', err)
    return c.json({ success: false, error: 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì‹¤ì‹œê°„ í¬ì¸íŠ¸ ì¡°íšŒ API
app.get('/api/users/:id/points', async (c) => {
  try {
    const userId = c.req.param('id')
    
    const user = await c.env.DB.prepare(`
      SELECT id, email, name, points FROM users WHERE id = ?
    `).bind(userId).first()

    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    return c.json({ 
      success: true,
      points: user.points || 0,
      user: { id: user.id, email: user.email, name: user.name, points: user.points || 0 }
    })
  } catch (err) {
    console.error('Get points error:', err)
    return c.json({ success: false, error: 'í¬ì¸íŠ¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ API
app.post('/api/admin/users/:id/password', async (c) => {
  try {
    const userId = c.req.param('id')
    const { newPassword } = await c.req.json()

    if (!newPassword || newPassword.length < 6) {
      return c.json({ success: false, error: 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.' }, 400)
    }

    await c.env.DB.prepare(`
      UPDATE users SET password = ? WHERE id = ?
    `).bind(newPassword, userId).run()

    return c.json({ success: true, message: 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Password change error:', err)
    return c.json({ success: false, error: 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: í¬ì¸íŠ¸ ì§€ê¸‰ API
app.put('/api/admin/users/:id/points', async (c) => {
  try {
    const userId = c.req.param('id')
    const { points } = await c.req.json()

    if (!points || points <= 0) {
      return c.json({ success: false, error: 'ì˜¬ë°”ë¥¸ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.' }, 400)
    }

    // í˜„ì¬ ì”ì•¡ ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT balance FROM users WHERE id = ?
    `).bind(userId).first()

    const newBalance = (user?.balance || 0) + points

    // ì”ì•¡ ì—…ë°ì´íŠ¸ (balanceì™€ points ë™ê¸°í™”)
    await c.env.DB.prepare(`
      UPDATE users SET balance = ?, points = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(newBalance, newBalance, userId).run()

    return c.json({ success: true, message: 'í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.', newPoints: newBalance })
  } catch (err) {
    console.error('Points update error:', err)
    return c.json({ success: false, error: 'í¬ì¸íŠ¸ ì§€ê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: í¬ì¸íŠ¸ ì°¨ê° API
app.put('/api/admin/users/:id/points/deduct', async (c) => {
  try {
    const userId = c.req.param('id')
    const { points } = await c.req.json()

    if (!points || points <= 0) {
      return c.json({ success: false, error: 'ì˜¬ë°”ë¥¸ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.' }, 400)
    }

    // í˜„ì¬ ì”ì•¡ ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT id, email, name, balance FROM users WHERE id = ?
    `).bind(userId).first()

    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    const currentBalance = user?.balance || 0
    const newBalance = currentBalance - points

    console.log('Deduct points:', { userId, userName: user.name, currentBalance, deductPoints: points, newBalance })

    // í¬ì¸íŠ¸ ì°¨ê° (ë§ˆì´ë„ˆìŠ¤ í—ˆìš©, balanceì™€ points ë™ê¸°í™”)
    await c.env.DB.prepare(`
      UPDATE users SET balance = ?, points = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(newBalance, newBalance, userId).run()

    return c.json({ 
      success: true, 
      message: points + 'Pê°€ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤.',
      deductedPoints: points,
      newPoints: newBalance 
    })
  } catch (err) {
    console.error('Points deduct error:', err)
    return c.json({ success: false, error: 'í¬ì¸íŠ¸ ì°¨ê° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸ API
app.post('/api/admin/login-as/:id', async (c) => {
  try {
    const userId = c.req.param('id')

    // ì‚¬ìš©ì ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT id, email, name, role FROM users WHERE id = ?
    `).bind(userId).first()

    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    return c.json({ 
      success: true, 
      message: 'ë¡œê·¸ì¸ ì„±ê³µ',
      user: { id: user.id, email: user.email, name: user.name, role: user.role }
    })
  } catch (err) {
    console.error('Login as error:', err)
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// íšŒì›ê°€ì… API
app.post('/api/register', async (c) => {
  try {
    const { email, password, name, phone, academy_name, academy_location, google_id, kakao_id, profile_image, social_provider } = await c.req.json()

    // í•„ìˆ˜ í•„ë“œ í™•ì¸ (ì†Œì…œ ë¡œê·¸ì¸ì˜ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ ë¶ˆí•„ìš”)
    if (!email || !name) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ì†Œì…œ ë¡œê·¸ì¸ì´ ì•„ë‹Œ ê²½ìš° ë¹„ë°€ë²ˆí˜¸ í•„ìˆ˜
    if (!social_provider && !password) {
      return c.json({ success: false, error: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸
    const existingUser = await c.env.DB.prepare(`
      SELECT id FROM users WHERE email = ?
    `).bind(email).first()

    if (existingUser) {
      return c.json({ success: false, error: 'ì´ë¯¸ ë“±ë¡ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤.' }, 400)
    }

    // ì‚¬ìš©ì ìƒì„±
    // âœ… ê¸°ë³¸ê°’: role = 'director' (ì›ì¥ë‹˜)
    const result = await c.env.DB.prepare(`
      INSERT INTO users (email, password, name, phone, academy_name, role, google_id, kakao_id, profile_image, social_provider)
      VALUES (?, ?, ?, ?, ?, 'director', ?, ?, ?, ?)
    `).bind(
      email, 
      password || 'social_login_' + Date.now(), 
      name, 
      phone || null, 
      academy_name || null,
      google_id || null,
      kakao_id || null,
      profile_image || null,
      social_provider || null
    ).run()

    return c.json({ 
      success: true, 
      message: 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      user: { id: result.meta.last_row_id, email, name }
    })
  } catch (err) {
    console.error('Register error:', err)
    return c.json({ success: false, error: 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ========================================
// User Permissions API Routes
// ì‚¬ìš©ì ê¶Œí•œ í™•ì¸ API
app.get('/api/user/permissions', async (c) => {
  try {
    const userId = c.req.query('userId')
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    // ê´€ë¦¬ìëŠ” ëª¨ë“  ê¶Œí•œ ë³´ìœ 
    const user = await c.env.DB.prepare('SELECT role FROM users WHERE id = ?').bind(userId).first()
    if (user && user.role === 'admin') {
      return c.json({ 
        success: true, 
        permissions: {
          search_volume: true,
          sms: true,
          sms_sender: true,
          landing_builder: true,
          analytics: true,
          parent_message: true,
          blog_writer: true,
          student_management: true,
          dashboard_analytics: true,
          ai_learning_report: true,
          keyword_analyzer: true,
          review_template: true,
          ad_copy_generator: true,
          photo_optimizer: true,
          competitor_analysis: true,
          blog_checklist: true,
          content_calendar: true,
          consultation_script: true,
          place_optimization: true,
          roi_calculator: true,
          all: true
        }
      })
    }

    // user_programs í…Œì´ë¸”ì—ì„œ í”„ë¡œê·¸ë¨ ì¡°íšŒ
    const { results: programs } = await c.env.DB.prepare(`
      SELECT program_route, program_name, enabled
      FROM user_programs
      WHERE user_id = ? AND enabled = 1
    `).bind(userId).all()
    
    console.log('[User Permissions] Programs for user', userId, ':', programs)

    // í”„ë¡œê·¸ë¨ ë¼ìš°íŠ¸ë¥¼ ê¶Œí•œ í‚¤ë¡œ ë³€í™˜
    const permissionMap: any = {
      search_volume: false,
      sms: false,
      sms_sender: false,
      landing_builder: false,
      analytics: false,
      parent_message: false,
      blog_writer: false,
      student_management: false,
      dashboard_analytics: false,
      ai_learning_report: false,
      keyword_analyzer: false,
      review_template: false,
      ad_copy_generator: false,
      photo_optimizer: false,
      competitor_analysis: false,
      blog_checklist: false,
      content_calendar: false,
      consultation_script: false,
      place_optimization: false,
      roi_calculator: false,
      all: false
    }

    // ë¼ìš°íŠ¸ì™€ ê¶Œí•œ í‚¤ ë§¤í•‘ (4ê°œ ê¸°ë³¸ í”„ë¡œê·¸ë¨)
    const routeToPermission: any = {
      '/students': 'student_management',
      '/tools/ai-learning-report': 'ai_learning_report',
      '/tools/dashboard-analytics': 'analytics',
      '/tools/search-volume': 'search_volume'
    }

    // í”„ë¡œê·¸ë¨ì´ ìˆìœ¼ë©´ í•´ë‹¹ ê¶Œí•œ í™œì„±í™”
    programs.forEach((program: any) => {
      const permKey = routeToPermission[program.program_route]
      if (permKey) {
        permissionMap[permKey] = true
        console.log('[User Permissions] Enabled:', permKey, 'from program:', program.program_name)
      }
    })
    
    // SMS ê¶Œí•œì€ sms_senderë¡œë„ ë§¤í•‘
    if (permissionMap.sms_sender) {
      permissionMap.sms = true
    }

    return c.json({ success: true, permissions: permissionMap })
  } catch (err) {
    console.error('Get user permissions error:', err)
    return c.json({ success: false, error: 'ê¶Œí•œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ì‚¬ìš©ìì—ê²Œ ê¶Œí•œ ë¶€ì—¬ API
app.post('/api/admin/grant-permission', async (c) => {
  try {
    const body = await c.req.json()
    const { userId, programKey, expiresAt } = body
    const adminId = body.adminId || body.grantedBy // adminId ë˜ëŠ” grantedBy ëª¨ë‘ í—ˆìš©
    
    if (!userId || !programKey || !adminId) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await c.env.DB.prepare('SELECT role FROM users WHERE id = ?').bind(adminId).first()
    if (!admin || admin.role !== 'admin') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    // ê¶Œí•œ ë¶€ì—¬
    await c.env.DB.prepare(`
      INSERT OR REPLACE INTO user_permissions (user_id, program_key, granted_by, is_active, expires_at)
      VALUES (?, ?, ?, 1, ?)
    `).bind(userId, programKey, adminId, expiresAt || null).run()

    return c.json({ success: true, message: 'ê¶Œí•œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Grant permission error:', err)
    return c.json({ success: false, error: 'ê¶Œí•œ ë¶€ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ì‚¬ìš©ì ê¶Œí•œ íšŒìˆ˜ API
app.post('/api/admin/revoke-permission', async (c) => {
  try {
    const { userId, programKey, adminId } = await c.req.json()
    
    if (!userId || !programKey || !adminId) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await c.env.DB.prepare('SELECT role FROM users WHERE id = ?').bind(adminId).first()
    if (!admin || admin.role !== 'admin') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    // ê¶Œí•œ íšŒìˆ˜
    await c.env.DB.prepare(`
      UPDATE user_permissions 
      SET is_active = 0 
      WHERE user_id = ? AND program_key = ?
    `).bind(userId, programKey).run()

    return c.json({ success: true, message: 'ê¶Œí•œì´ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Revoke permission error:', err)
    return c.json({ success: false, error: 'ê¶Œí•œ íšŒìˆ˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ì‚¬ìš©ì ê¶Œí•œ ì¼ê´„ ì—…ë°ì´íŠ¸ API
app.post('/api/admin/update-user-permissions', async (c) => {
  try {
    const { userId, permissions, adminId } = await c.req.json()
    
    if (!userId || !permissions || !adminId) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await c.env.DB.prepare('SELECT role FROM users WHERE id = ?').bind(adminId).first()
    if (!admin || admin.role !== 'admin') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    // íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì¼ê´„ ì²˜ë¦¬
    // 1. í•´ë‹¹ ì‚¬ìš©ìì˜ ê¸°ì¡´ ê¶Œí•œ ëª¨ë‘ ë¹„í™œì„±í™”
    await c.env.DB.prepare(`
      UPDATE user_permissions 
      SET is_active = 0 
      WHERE user_id = ?
    `).bind(userId).run()

    // 2. ìƒˆë¡œìš´ ê¶Œí•œ ì¶”ê°€
    let successCount = 0
    for (const programKey of permissions) {
      try {
        await c.env.DB.prepare(`
          INSERT OR REPLACE INTO user_permissions (user_id, program_key, granted_by, is_active)
          VALUES (?, ?, ?, 1)
        `).bind(userId, programKey, adminId).run()
        successCount++
      } catch (err) {
        console.error('ê¶Œí•œ ì¶”ê°€ ì˜¤ë¥˜:', programKey, err)
      }
    }

    return c.json({ 
      success: true, 
      message: `${successCount}ê°œì˜ ê¶Œí•œì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      count: successCount
    })
  } catch (err) {
    console.error('Update permissions error:', err)
    return c.json({ success: false, error: 'ê¶Œí•œ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message }, 500)
  }
})

// ê´€ë¦¬ì: ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ API
app.post('/api/admin/run-migration', async (c) => {
  try {
    const { adminId } = await c.req.json()
    
    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await c.env.DB.prepare('SELECT role FROM users WHERE id = ?').bind(adminId).first()
    if (!admin || admin.role !== 'admin') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    // user_permissions í…Œì´ë¸” ì¬ìƒì„±
    await c.env.DB.prepare(`DROP TABLE IF EXISTS user_permissions_backup`).run()
    
    // ê¸°ì¡´ í…Œì´ë¸”ì„ ë°±ì—…ìœ¼ë¡œ ì´ë¦„ ë³€ê²½ (ë°ì´í„°ê°€ ìˆì„ ê²½ìš°)
    try {
      await c.env.DB.prepare(`ALTER TABLE user_permissions RENAME TO user_permissions_backup`).run()
    } catch (e) {
      // í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ë¬´ì‹œ
      console.log('No existing user_permissions table to backup')
    }
    
    // ìƒˆ í…Œì´ë¸” ìƒì„±
    await c.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS user_permissions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        program_key TEXT NOT NULL,
        granted_by INTEGER,
        granted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        expires_at DATETIME,
        is_active INTEGER DEFAULT 1,
        FOREIGN KEY (user_id) REFERENCES users(id),
        FOREIGN KEY (granted_by) REFERENCES users(id),
        UNIQUE(user_id, program_key)
      )
    `).run()
    
    // ì¸ë±ìŠ¤ ìƒì„±
    await c.env.DB.prepare(`CREATE INDEX IF NOT EXISTS idx_user_permissions_user_id ON user_permissions(user_id)`).run()
    await c.env.DB.prepare(`CREATE INDEX IF NOT EXISTS idx_user_permissions_program_key ON user_permissions(program_key)`).run()
    await c.env.DB.prepare(`CREATE INDEX IF NOT EXISTS idx_user_permissions_active ON user_permissions(is_active)`).run()

    return c.json({ success: true, message: 'user_permissions í…Œì´ë¸”ì´ ì„±ê³µì ìœ¼ë¡œ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Migration error:', err)
    return c.json({ success: false, error: 'ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message }, 500)
  }
})

// ğŸ”¥ ê´€ë¦¬ì: academies í…Œì´ë¸” FOREIGN KEY ì œê±° ë§ˆì´ê·¸ë ˆì´ì…˜
app.post('/api/admin/fix-academies-table', async (c) => {
  try {
    const results = []
    
    console.log('[Admin Fix] Starting academies table migration...')
    
    // Step 1: ê¸°ì¡´ academies ë°ì´í„° ë°±ì—…
    const existingAcademies = await c.env.DB.prepare(`
      SELECT * FROM academies
    `).all()
    
    results.push(`âœ… Backed up ${existingAcademies.results.length} academies`)
    console.log('[Admin Fix] Backed up academies:', existingAcademies.results.length)
    
    // Step 2: ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ
    await c.env.DB.prepare(`DROP TABLE IF EXISTS academies`).run()
    results.push('âœ… Dropped old academies table')
    console.log('[Admin Fix] Dropped old academies table')
    
    // Step 3: FOREIGN KEY ì œì•½ ì—†ì´ ìƒˆ í…Œì´ë¸” ìƒì„±
    await c.env.DB.prepare(`
      CREATE TABLE academies (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        academy_name TEXT NOT NULL,
        owner_id INTEGER NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run()
    results.push('âœ… Created new academies table (without FOREIGN KEY constraint)')
    console.log('[Admin Fix] Created new academies table without FK')
    
    // Step 4: ë°ì´í„° ë³µì›
    for (const academy of existingAcademies.results) {
      try {
        await c.env.DB.prepare(`
          INSERT INTO academies (id, academy_name, owner_id, created_at)
          VALUES (?, ?, ?, ?)
        `).bind(academy.id, academy.academy_name, academy.owner_id, academy.created_at).run()
      } catch (insertError) {
        console.error('[Admin Fix] Failed to restore academy:', academy.id, insertError.message)
      }
    }
    results.push(`âœ… Restored ${existingAcademies.results.length} academies`)
    console.log('[Admin Fix] Restored academies data')
    
    // Step 5: ì¸ë±ìŠ¤ ìƒì„±
    await c.env.DB.prepare(`
      CREATE INDEX IF NOT EXISTS idx_academies_owner_id ON academies(owner_id)
    `).run()
    results.push('âœ… Created index on owner_id')
    
    return c.json({ 
      success: true, 
      message: 'academies í…Œì´ë¸”ì´ ì„±ê³µì ìœ¼ë¡œ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (FOREIGN KEY ì œì•½ ì œê±°ë¨)',
      results
    })
  } catch (err) {
    console.error('[Admin Fix] Error:', err)
    return c.json({ 
      success: false, 
      error: 'academies í…Œì´ë¸” ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message 
    }, 500)
  }
})

// ğŸ”§ ê´€ë¦¬ì: ì‚¬ìš©ëŸ‰ ë°ì´í„° ë™ê¸°í™” API (ëœë”©í˜ì´ì§€ ê°œìˆ˜ ìˆ˜ì •)
// ğŸ”§ ê¸´ê¸‰ ìˆ˜ë™ ë™ê¸°í™” í˜ì´ì§€
app.get('/emergency-sync', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê¸´ê¸‰ ë™ê¸°í™” - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen flex items-center justify-center p-6">
        <div class="max-w-2xl w-full bg-white rounded-3xl shadow-2xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-3">ğŸ”§ ê¸´ê¸‰ ë™ê¸°í™”</h1>
                <p class="text-lg text-gray-600">ëœë”©í˜ì´ì§€ ê°œìˆ˜ê°€ ëŒ€ì‹œë³´ë“œì— í‘œì‹œë˜ì§€ ì•Šì„ ë•Œ ì‚¬ìš©í•˜ì„¸ìš”</p>
            </div>
            
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6 mb-6">
                <div class="flex items-start gap-3">
                    <span class="text-3xl">âš ï¸</span>
                    <div>
                        <h3 class="font-bold text-yellow-900 text-lg mb-2">ì–¸ì œ ì‚¬ìš©í•˜ë‚˜ìš”?</h3>
                        <ul class="text-yellow-800 space-y-1 text-sm">
                            <li>âœ“ ëœë”©í˜ì´ì§€ë¥¼ ë§Œë“¤ì—ˆëŠ”ë° ëŒ€ì‹œë³´ë“œì— 0ìœ¼ë¡œ í‘œì‹œë  ë•Œ</li>
                            <li>âœ“ í”Œëœ ì‚¬ìš©ëŸ‰ì´ ì •í™•í•˜ì§€ ì•Šì„ ë•Œ</li>
                            <li>âœ“ ê°œìˆ˜ê°€ ì‹¤ì œì™€ ë‹¤ë¥¼ ë•Œ</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="text-center mb-6">
                <button id="syncBtn" onclick="syncNow()" 
                        class="bg-gradient-to-r from-purple-600 to-blue-600 text-white text-xl font-bold px-12 py-5 rounded-2xl hover:from-purple-700 hover:to-blue-700 transition-all shadow-lg hover:shadow-xl transform hover:scale-105">
                    ğŸš€ ì§€ê¸ˆ ë™ê¸°í™” ì‹¤í–‰
                </button>
            </div>
            
            <div id="result" class="hidden"></div>
            
            <div class="text-center mt-8">
                <a href="/dashboard" class="text-purple-600 hover:text-purple-800 font-medium">
                    â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                </a>
            </div>
        </div>
        
        <script>
            async function syncNow() {
                const btn = document.getElementById('syncBtn');
                const result = document.getElementById('result');
                
                btn.disabled = true;
                btn.textContent = 'ğŸ”„ ë™ê¸°í™” ì¤‘...';
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                
                result.classList.remove('hidden');
                result.innerHTML = '<div class="text-center text-blue-600 font-medium">ë™ê¸°í™” ì§„í–‰ ì¤‘...</div>';
                
                try {
                    const response = await fetch('/api/emergency-sync-usage', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        result.innerHTML = \`
                            <div class="bg-green-50 border-2 border-green-500 rounded-xl p-6">
                                <div class="flex items-start gap-3 mb-4">
                                    <span class="text-4xl">âœ…</span>
                                    <div class="flex-1">
                                        <h3 class="font-bold text-green-900 text-2xl mb-2">ë™ê¸°í™” ì„±ê³µ!</h3>
                                        <p class="text-green-800 text-lg mb-4">\${data.message}</p>
                                        
                                        <div class="bg-white rounded-lg p-4 mb-4">
                                            <div class="text-sm font-bold text-gray-900 mb-2">ğŸ“Š ë™ê¸°í™” ê²°ê³¼:</div>
                                            <div class="space-y-2 text-sm text-gray-700">
                                                <div>â€¢ ì‚¬ìš©ì ID: \${data.data.user_id}</div>
                                                <div>â€¢ í•™ì› ID: \${data.data.academy_id}</div>
                                                <div>â€¢ êµ¬ë… ì‹œì‘ì¼: \${data.data.subscription_start_date}</div>
                                                <div class="font-bold text-purple-600">â€¢ ëœë”©í˜ì´ì§€ ê°œìˆ˜: \${data.data.landing_pages_count}ê°œ</div>
                                                <div>â€¢ ì‘ì—…: \${data.data.action === 'UPDATED' ? 'ì—…ë°ì´íŠ¸ ì™„ë£Œ' : 'ìƒˆë¡œ ìƒì„±'}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="text-center">
                                            <a href="/dashboard" class="inline-block bg-green-600 text-white font-bold px-8 py-3 rounded-xl hover:bg-green-700 transition">
                                                ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ê¸° â†’
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        \`;
                        
                        // 3ì´ˆ í›„ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 3000);
                    } else {
                        result.innerHTML = \`
                            <div class="bg-red-50 border-2 border-red-500 rounded-xl p-6">
                                <div class="flex items-start gap-3">
                                    <span class="text-3xl">âŒ</span>
                                    <div>
                                        <h3 class="font-bold text-red-900 text-lg mb-2">ë™ê¸°í™” ì‹¤íŒ¨</h3>
                                        <p class="text-red-800">\${data.error}</p>
                                    </div>
                                </div>
                            </div>
                        \`;
                        btn.disabled = false;
                        btn.textContent = 'ğŸš€ ë‹¤ì‹œ ì‹œë„';
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                } catch (error) {
                    result.innerHTML = \`
                        <div class="bg-red-50 border-2 border-red-500 rounded-xl p-6">
                            <div class="flex items-start gap-3">
                                <span class="text-3xl">âŒ</span>
                                <div>
                                    <h3 class="font-bold text-red-900 text-lg mb-2">ì˜¤ë¥˜ ë°œìƒ</h3>
                                    <p class="text-red-800">\${error.message}</p>
                                </div>
                            </div>
                        </div>
                    \`;
                    btn.disabled = false;
                    btn.textContent = 'ğŸš€ ë‹¤ì‹œ ì‹œë„';
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        </script>
    </body>
    </html>
  `)
})

// ğŸ”§ ê¸´ê¸‰ ìˆ˜ë™ ë™ê¸°í™” API (ê´€ë¦¬ì ê¶Œí•œ ë¶ˆí•„ìš”)
app.post('/api/emergency-sync-usage', async (c) => {
  try {
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const session = await c.env.DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')
    `).bind(sessionId).first()
    
    if (!session) {
      return c.json({ success: false, error: 'Session expired' }, 401)
    }
    
    const userId = session.user_id
    
    // ì‚¬ìš©ì ì •ë³´
    const user = await c.env.DB.prepare(`
      SELECT id, academy_id FROM users WHERE id = ?
    `).bind(userId).first()
    
    const academyId = user.academy_id || userId
    
    // í™œì„± êµ¬ë…
    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()
    
    if (!subscription) {
      return c.json({ success: false, error: 'í™œì„± êµ¬ë… ì—†ìŒ' }, 403)
    }
    
    // í˜„ì¬ êµ¬ë… ê¸°ê°„ ë‚´ ëœë”©í˜ì´ì§€ COUNT
    const countResult = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM landing_pages 
      WHERE user_id = ?
      AND created_at >= ?
    `).bind(academyId, subscription.subscription_start_date).first()
    
    const actualCount = countResult?.count || 0
    
    // usage_tracking ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
    const usageExists = await c.env.DB.prepare(`
      SELECT id FROM usage_tracking 
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(academyId, subscription.id).first()
    
    if (usageExists) {
      await c.env.DB.prepare(`
        UPDATE usage_tracking 
        SET landing_pages_created = ?, updated_at = CURRENT_TIMESTAMP
        WHERE academy_id = ? AND subscription_id = ?
      `).bind(actualCount, academyId, subscription.id).run()
    } else {
      await c.env.DB.prepare(`
        INSERT INTO usage_tracking (
          academy_id, subscription_id, current_students, ai_reports_used_this_month,
          landing_pages_created, current_teachers, sms_sent_this_month,
          created_at, updated_at
        ) VALUES (?, ?, 0, 0, ?, 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
      `).bind(academyId, subscription.id, actualCount).run()
    }
    
    return c.json({
      success: true,
      message: 'ë™ê¸°í™” ì™„ë£Œ!',
      data: {
        user_id: userId,
        academy_id: academyId,
        subscription_id: subscription.id,
        subscription_start_date: subscription.subscription_start_date,
        landing_pages_count: actualCount,
        action: usageExists ? 'UPDATED' : 'CREATED'
      }
    })
  } catch (error) {
    console.error('[Emergency Sync] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ”§ ë””ë²„ê·¸: ì´ë©”ì¼ë¡œ ëœë”©í˜ì´ì§€ ì •ë³´ ì¡°íšŒ
app.get('/api/debug/user-by-email', async (c) => {
  try {
    const email = c.req.query('email')
    if (!email) {
      return c.json({ success: false, error: 'Email parameter required' }, 400)
    }
    
    console.log('[Debug] Checking landing pages for email:', email)
    
    // ì‚¬ìš©ì ì •ë³´
    const user = await c.env.DB.prepare(`
      SELECT id, email, name, academy_id, user_type FROM users WHERE email = ?
    `).bind(email).first()
    
    if (!user) {
      return c.json({ success: false, error: 'User not found' })
    }
    
    const academyId = user.academy_id || user.id
    
    // ì „ì²´ ëœë”©í˜ì´ì§€ ê°œìˆ˜
    const totalCount = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM landing_pages WHERE user_id = ?
    `).bind(user.id).first()
    
    // í™œì„± êµ¬ë…
    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()
    
    // í˜„ì¬ í”Œëœ ê¸°ê°„ ë‚´ ëœë”©í˜ì´ì§€ ê°œìˆ˜
    let currentPlanCount = 0
    if (subscription && subscription.subscription_start_date) {
      const countResult = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM landing_pages 
        WHERE user_id IN (
          SELECT id FROM users WHERE id = ? OR academy_id = ?
        )
        AND created_at >= ?
      `).bind(academyId, academyId, subscription.subscription_start_date).first()
      currentPlanCount = countResult?.count || 0
    }
    
    // ëœë”©í˜ì´ì§€ ëª©ë¡
    const pages = await c.env.DB.prepare(`
      SELECT id, slug, title, user_id, created_at, status 
      FROM landing_pages 
      WHERE user_id = ? 
      ORDER BY created_at DESC 
      LIMIT 10
    `).bind(user.id).all()
    
    // usage_tracking
    const usage = subscription ? await c.env.DB.prepare(`
      SELECT * FROM usage_tracking 
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(academyId, subscription.id).first() : null
    
    return c.json({
      success: true,
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        academy_id: user.academy_id,
        user_type: user.user_type
      },
      landing_pages: {
        total_count: totalCount?.count || 0,
        current_plan_count: currentPlanCount,
        pages: pages.results || []
      },
      subscription: subscription ? {
        id: subscription.id,
        plan_name: subscription.plan_name,
        subscription_start_date: subscription.subscription_start_date,
        subscription_end_date: subscription.subscription_end_date,
        landing_page_limit: subscription.landing_page_limit,
        status: subscription.status
      } : null,
      usage_tracking: usage ? {
        landing_pages_created: usage.landing_pages_created,
        ai_reports_used_this_month: usage.ai_reports_used_this_month,
        current_students: usage.current_students
      } : null
    })
  } catch (error) {
    console.error('[Debug Email] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ”§ ë””ë²„ê·¸: íŠ¹ì • ì‚¬ìš©ìì˜ ëœë”©í˜ì´ì§€ ì •ë³´ ì¡°íšŒ
app.get('/api/debug/landing-pages/:userId', async (c) => {
  try {
    const userId = parseInt(c.req.param('userId'))
    
    console.log('[Debug] Checking landing pages for user:', userId)
    
    // ì‚¬ìš©ì ì •ë³´
    const user = await c.env.DB.prepare(`
      SELECT id, email, name, academy_id, user_type FROM users WHERE id = ?
    `).bind(userId).first()
    
    if (!user) {
      return c.json({ success: false, error: 'User not found' })
    }
    
    // ì‹¤ì œ ëœë”©í˜ì´ì§€ ê°œìˆ˜ (user_id ê¸°ì¤€)
    const countByUserId = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM landing_pages WHERE user_id = ?
    `).bind(userId).first()
    
    // ëœë”©í˜ì´ì§€ ëª©ë¡
    const pages = await c.env.DB.prepare(`
      SELECT id, slug, title, user_id, created_at FROM landing_pages 
      WHERE user_id = ? 
      ORDER BY created_at DESC 
      LIMIT 10
    `).bind(userId).all()
    
    // í™œì„± êµ¬ë…
    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(user.academy_id || userId).first()
    
    // usage_tracking
    const usage = subscription ? await c.env.DB.prepare(`
      SELECT * FROM usage_tracking 
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(user.academy_id || userId, subscription.id).first() : null
    
    return c.json({
      success: true,
      user: {
        id: user.id,
        email: user.email,
        name: user.name,
        academy_id: user.academy_id,
        user_type: user.user_type
      },
      landing_pages: {
        count: countByUserId?.count || 0,
        pages: pages.results || []
      },
      subscription: subscription ? {
        id: subscription.id,
        plan_name: subscription.plan_name,
        landing_page_limit: subscription.landing_page_limit,
        status: subscription.status
      } : null,
      usage_tracking: usage ? {
        landing_pages_created: usage.landing_pages_created,
        ai_reports_used_this_month: usage.ai_reports_used_this_month,
        current_students: usage.current_students
      } : null
    })
  } catch (error) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

app.post('/api/admin/sync-landing-pages-usage', async (c) => {
  try {
    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const userHeaderBase64 = c.req.header('X-User-Data-Base64')
    if (!userHeaderBase64) {
      return c.json({ success: false, error: 'Unauthorized' }, 401)
    }
    
    let user
    try {
      const userDataStr = atob(userHeaderBase64)
      user = JSON.parse(userDataStr)
    } catch (e) {
      return c.json({ success: false, error: 'Invalid user data' }, 401)
    }
    
    if (user.role !== 'admin') {
      return c.json({ success: false, error: 'Admin only' }, 403)
    }
    
    console.log('[Sync Usage] Starting landing pages usage sync...')
    
    // ëª¨ë“  í™œì„± êµ¬ë… ì¡°íšŒ
    const subscriptions = await c.env.DB.prepare(`
      SELECT id, academy_id, subscription_start_date FROM subscriptions 
      WHERE status = 'active'
    `).all()
    
    const results = []
    let synced = 0
    let created = 0
    
    for (const sub of subscriptions.results || []) {
      try {
        // ğŸ”¥ í˜„ì¬ êµ¬ë… ê¸°ê°„ ë‚´ì— ìƒì„±ëœ ëœë”©í˜ì´ì§€ë§Œ COUNT
        // ì›ì¥ ë³¸ì¸ + í•´ë‹¹ í•™ì› ì†Œì† ì„ ìƒë‹˜ë“¤ì˜ ëœë”©í˜ì´ì§€ ëª¨ë‘ í¬í•¨
        const landingPagesCount = await c.env.DB.prepare(`
          SELECT COUNT(*) as count FROM landing_pages 
          WHERE user_id IN (
            SELECT id FROM users WHERE id = ? OR academy_id = ?
          )
          AND created_at >= ?
        `).bind(sub.academy_id, sub.academy_id, sub.subscription_start_date).first()
        
        const actualCount = landingPagesCount?.count || 0
        
        // usage_tracking ì—…ë°ì´íŠ¸
        const updateResult = await c.env.DB.prepare(`
          UPDATE usage_tracking 
          SET landing_pages_created = ?, updated_at = CURRENT_TIMESTAMP
          WHERE subscription_id = ? AND academy_id = ?
        `).bind(actualCount, sub.id, sub.academy_id).run()
        
        if (updateResult.meta.changes > 0) {
          synced++
          results.push(`âœ… Academy ${sub.academy_id}: Updated to ${actualCount} pages`)
          console.log(`[Sync Usage] Academy ${sub.academy_id}: ${actualCount} pages`)
        } else {
          // usage_tracking ë ˆì½”ë“œê°€ ì—†ëŠ” ê²½ìš° ìƒì„±
          try {
            await c.env.DB.prepare(`
              INSERT INTO usage_tracking (
                academy_id, subscription_id, current_students, 
                ai_reports_used_this_month, landing_pages_created, 
                current_teachers, sms_sent_this_month, created_at, updated_at
              ) VALUES (?, ?, 0, 0, ?, 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
            `).bind(sub.academy_id, sub.id, actualCount).run()
            synced++
            created++
            results.push(`âœ… Academy ${sub.academy_id}: Created with ${actualCount} pages`)
            console.log(`[Sync Usage] Academy ${sub.academy_id}: Created with ${actualCount} pages`)
          } catch (insertErr) {
            results.push(`âš ï¸ Academy ${sub.academy_id}: Failed to create - ${insertErr.message}`)
          }
        }
      } catch (err) {
        results.push(`âŒ Academy ${sub.academy_id}: ${err.message}`)
        console.error(`[Sync Usage] Error for academy ${sub.academy_id}:`, err)
      }
    }
    
    return c.json({
      success: true,
      message: `ë™ê¸°í™” ì™„ë£Œ: ${synced}ê°œ êµ¬ë… ì—…ë°ì´íŠ¸ë¨`,
      synced,
      created,
      total: subscriptions.results?.length || 0,
      results
    })
  } catch (error) {
    console.error('[Sync Usage] Error:', error)
    return c.json({ 
      success: false, 
      error: 'ì‚¬ìš©ëŸ‰ ë™ê¸°í™” ì‹¤íŒ¨: ' + error.message 
    }, 500)
  }
})

// SMS API Routes
// ========================================

// SMS ìš”ê¸ˆí‘œ ì¡°íšŒ API
app.get('/api/sms/pricing', async (c) => {
  try {
    const pricing = await c.env.DB.prepare(`
      SELECT * FROM sms_pricing ORDER BY wholesale_price ASC
    `).all()

    return c.json({ success: true, pricing: pricing.results })
  } catch (err) {
    console.error('Get SMS pricing error:', err)
    return c.json({ success: false, error: 'SMS ìš”ê¸ˆí‘œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ë°œì‹ ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒ API
app.get('/api/sms/senders', async (c) => {
  try {
    // í—¤ë” ë˜ëŠ” ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì—ì„œ userId ê°€ì ¸ì˜¤ê¸°
    const userId = c.req.header('X-User-Id') || c.req.query('userId')
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    const senders = await c.env.DB.prepare(`
      SELECT id, phone_number, verification_method, verification_date, status
      FROM sender_ids
      WHERE user_id = ?
      ORDER BY created_at DESC
    `).bind(userId).all()

    return c.json({ success: true, senders: senders.results })
  } catch (err) {
    console.error('Get senders error:', err)
    return c.json({ success: false, error: 'ë°œì‹ ë²ˆí˜¸ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ë°œì‹ ë²ˆí˜¸ ë“±ë¡ API (ì•Œë¦¬ê³  ì‚¬ì´íŠ¸ì—ì„œ ì¸ì¦ ì™„ë£Œ í›„ DBì— ì €ì¥)
app.post('/api/sms/sender/register', async (c) => {
  try {
    const { userId, phoneNumber, verificationMethod } = await c.req.json()
    
    if (!userId || !phoneNumber) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦ (í•˜ì´í”ˆ ì œê±°)
    const cleanNumber = phoneNumber.replace(/-/g, '')
    if (!/^01[0-9]{8,9}$/.test(cleanNumber)) {
      return c.json({ success: false, error: 'ì˜¬ë°”ë¥¸ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ì´ë¯¸ ë“±ë¡ëœ ë²ˆí˜¸ì¸ì§€ í™•ì¸
    const existing = await c.env.DB.prepare(`
      SELECT id FROM sender_ids WHERE user_id = ? AND phone_number = ?
    `).bind(userId, cleanNumber).first()
    
    if (existing) {
      return c.json({ success: false, error: 'ì´ë¯¸ ë“±ë¡ëœ ë°œì‹ ë²ˆí˜¸ì…ë‹ˆë‹¤.' }, 400)
    }

    // DBì— ë°œì‹ ë²ˆí˜¸ ë“±ë¡ (ì•Œë¦¬ê³  ì‚¬ì´íŠ¸ì—ì„œ ì¸ì¦ ì™„ë£Œëœ ë²ˆí˜¸)
    const result = await c.env.DB.prepare(`
      INSERT INTO sender_ids (user_id, phone_number, verification_method, status, verification_date)
      VALUES (?, ?, ?, 'verified', CURRENT_TIMESTAMP)
    `).bind(userId, cleanNumber, verificationMethod || 'manual').run()
    
    return c.json({ 
      success: true, 
      message: 'ë°œì‹ ë²ˆí˜¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
      senderId: result.meta.last_row_id
    })
  } catch (err) {
    console.error('Sender registration error:', err)
    return c.json({ success: false, error: 'ë°œì‹ ë²ˆí˜¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ë°œì‹ ë²ˆí˜¸ ì‚­ì œ API
app.delete('/api/sms/sender/:senderId', async (c) => {
  try {
    const senderId = c.req.param('senderId')
    const userId = c.req.query('userId')
    
    if (!userId || !senderId) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // í•´ë‹¹ ì‚¬ìš©ìì˜ ë°œì‹ ë²ˆí˜¸ì¸ì§€ í™•ì¸
    const sender = await c.env.DB.prepare(`
      SELECT id FROM sender_ids WHERE id = ? AND user_id = ?
    `).bind(senderId, userId).first()
    
    if (!sender) {
      return c.json({ success: false, error: 'ë°œì‹ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    // ë°œì‹ ë²ˆí˜¸ ì‚­ì œ
    await c.env.DB.prepare(`
      DELETE FROM sender_ids WHERE id = ? AND user_id = ?
    `).bind(senderId, userId).run()
    
    return c.json({ 
      success: true, 
      message: 'ë°œì‹ ë²ˆí˜¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (err) {
    console.error('Sender delete error:', err)
    return c.json({ success: false, error: 'ë°œì‹ ë²ˆí˜¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// === SMS í…œí”Œë¦¿ & í´ë” ê´€ë¦¬ API ===

// í´ë” ëª©ë¡ ì¡°íšŒ
app.get('/api/sms/folders', async (c) => {
  try {
    const userId = c.req.query('userId')
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    const folders = await c.env.DB.prepare(`
      SELECT * FROM sms_folders WHERE user_id = ? ORDER BY created_at DESC
    `).bind(userId).all()

    return c.json({ success: true, folders: folders.results })
  } catch (err) {
    console.error('Get folders error:', err)
    return c.json({ success: false, error: 'í´ë” ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// í´ë” ìƒì„±
app.post('/api/sms/folders', async (c) => {
  try {
    const { userId, name } = await c.req.json()
    if (!userId || !name) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)
    }

    const result = await c.env.DB.prepare(`
      INSERT INTO sms_folders (user_id, name) VALUES (?, ?)
    `).bind(userId, name).run()

    return c.json({ success: true, folderId: result.meta.last_row_id })
  } catch (err) {
    console.error('Create folder error:', err)
    return c.json({ success: false, error: 'í´ë” ìƒì„± ì‹¤íŒ¨' }, 500)
  }
})

// í´ë” ì‚­ì œ
app.delete('/api/sms/folders/:folderId', async (c) => {
  try {
    const folderId = c.req.param('folderId')
    const userId = c.req.query('userId')

    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    // í´ë” ì†Œìœ ê¶Œ í™•ì¸
    const folder = await c.env.DB.prepare(`
      SELECT * FROM sms_folders WHERE id = ? AND user_id = ?
    `).bind(folderId, userId).first()

    if (!folder) {
      return c.json({ success: false, error: 'í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    // í´ë” ë‚´ í…œí”Œë¦¿ë“¤ì˜ folder_idë¥¼ NULLë¡œ ë³€ê²½
    await c.env.DB.prepare(`
      UPDATE sms_templates SET folder_id = NULL WHERE folder_id = ?
    `).bind(folderId).run()

    // í´ë” ì‚­ì œ
    await c.env.DB.prepare(`
      DELETE FROM sms_folders WHERE id = ?
    `).bind(folderId).run()

    return c.json({ success: true })
  } catch (err) {
    console.error('Delete folder error:', err)
    return c.json({ success: false, error: 'í´ë” ì‚­ì œ ì‹¤íŒ¨' }, 500)
  }
})

// í…œí”Œë¦¿ ëª©ë¡ ì¡°íšŒ
app.get('/api/sms/templates', async (c) => {
  try {
    const userId = c.req.query('userId')
    const folderId = c.req.query('folderId')
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    let query = 'SELECT * FROM sms_templates WHERE user_id = ?'
    let params = [userId]

    if (folderId) {
      query += ' AND folder_id = ?'
      params.push(folderId)
    } else {
      query += ' AND folder_id IS NULL'
    }

    query += ' ORDER BY updated_at DESC'

    const templates = await c.env.DB.prepare(query).bind(...params).all()

    return c.json({ success: true, templates: templates.results })
  } catch (err) {
    console.error('Get templates error:', err)
    return c.json({ success: false, error: 'í…œí”Œë¦¿ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// í…œí”Œë¦¿ ìƒì„±
app.post('/api/sms/templates', async (c) => {
  try {
    const { userId, folderId, title, message, receivers } = await c.req.json()
    
    if (!userId || !title || !message) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)
    }

    const result = await c.env.DB.prepare(`
      INSERT INTO sms_templates (user_id, folder_id, title, message, receivers)
      VALUES (?, ?, ?, ?, ?)
    `).bind(userId, folderId || null, title, message, receivers || null).run()

    return c.json({ success: true, templateId: result.meta.last_row_id })
  } catch (err) {
    console.error('Create template error:', err)
    return c.json({ success: false, error: 'í…œí”Œë¦¿ ì €ì¥ ì‹¤íŒ¨' }, 500)
  }
})

// í…œí”Œë¦¿ ìˆ˜ì •
app.put('/api/sms/templates/:templateId', async (c) => {
  try {
    const templateId = c.req.param('templateId')
    const { userId, title, message, folderId } = await c.req.json()

    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    // í…œí”Œë¦¿ ì†Œìœ ê¶Œ í™•ì¸
    const template = await c.env.DB.prepare(`
      SELECT * FROM sms_templates WHERE id = ? AND user_id = ?
    `).bind(templateId, userId).first()

    if (!template) {
      return c.json({ success: false, error: 'í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    await c.env.DB.prepare(`
      UPDATE sms_templates 
      SET title = ?, message = ?, folder_id = ?, updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(title, message, folderId || null, templateId).run()

    return c.json({ success: true })
  } catch (err) {
    console.error('Update template error:', err)
    return c.json({ success: false, error: 'í…œí”Œë¦¿ ìˆ˜ì • ì‹¤íŒ¨' }, 500)
  }
})

// í…œí”Œë¦¿ ì‚­ì œ
app.delete('/api/sms/templates/:templateId', async (c) => {
  try {
    const templateId = c.req.param('templateId')
    const userId = c.req.query('userId')

    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    // í…œí”Œë¦¿ ì†Œìœ ê¶Œ í™•ì¸
    const template = await c.env.DB.prepare(`
      SELECT * FROM sms_templates WHERE id = ? AND user_id = ?
    `).bind(templateId, userId).first()

    if (!template) {
      return c.json({ success: false, error: 'í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    await c.env.DB.prepare(`
      DELETE FROM sms_templates WHERE id = ?
    `).bind(templateId).run()

    return c.json({ success: true })
  } catch (err) {
    console.error('Delete template error:', err)
    return c.json({ success: false, error: 'í…œí”Œë¦¿ ì‚­ì œ ì‹¤íŒ¨' }, 500)
  }
})

// DB ì´ˆê¸°í™” API (í…ŒìŠ¤íŠ¸ìš©)
app.post('/api/init-db', async (c) => {
  try {
    // users í…Œì´ë¸” ìƒì„±
    await c.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        email TEXT UNIQUE NOT NULL,
        name TEXT NOT NULL,
        password TEXT NOT NULL,
        academy_id INTEGER NOT NULL DEFAULT 1,
        role TEXT DEFAULT 'teacher',
        balance INTEGER DEFAULT 0,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run()

    // point_transactions í…Œì´ë¸” ìƒì„±
    await c.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS point_transactions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        amount INTEGER NOT NULL,
        balance_before INTEGER DEFAULT 0,
        balance_after INTEGER NOT NULL,
        transaction_type TEXT NOT NULL,
        description TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id)
      )
    `).run()

    // sender_ids í…Œì´ë¸” ìƒì„±
    await c.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS sender_ids (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        phone_number TEXT NOT NULL,
        verification_method TEXT NOT NULL,
        verification_date DATETIME DEFAULT CURRENT_TIMESTAMP,
        status TEXT DEFAULT 'verified',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id)
      )
    `).run()

    // sms_pricing í…Œì´ë¸” ìƒì„±
    await c.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS sms_pricing (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        message_type TEXT NOT NULL,
        price INTEGER NOT NULL,
        description TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run()

    // ê¸°ë³¸ ì‚¬ìš©ì ì¶”ê°€ (ì—†ìœ¼ë©´)
    const existingUser = await c.env.DB.prepare('SELECT id FROM users WHERE id = 1').first()
    if (!existingUser) {
      await c.env.DB.prepare(`
        INSERT INTO users (id, email, name, password, academy_id, role, balance)
        VALUES (1, 'test@test.com', 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì', 'password', 1, 'teacher', 0)
      `).run()
    }

    // ê¸°ë³¸ ìš”ê¸ˆ ì¶”ê°€ (ì—†ìœ¼ë©´)
    const existingPricing = await c.env.DB.prepare('SELECT id FROM sms_pricing WHERE message_type = ?').bind('SMS').first()
    if (!existingPricing) {
      await c.env.DB.prepare(`
        INSERT INTO sms_pricing (message_type, price, description)
        VALUES ('SMS', 20, 'ë‹¨ë¬¸ SMS (90ë°”ì´íŠ¸ ì´í•˜)'),
               ('LMS', 50, 'ì¥ë¬¸ SMS (90ë°”ì´íŠ¸ ì´ˆê³¼)')
      `).run()
    }

    return c.json({ 
      success: true, 
      message: 'DB ì´ˆê¸°í™” ì™„ë£Œ',
      tables: ['users', 'point_transactions', 'sender_ids', 'sms_pricing']
    })
  } catch (err) {
    console.error('DB Init error:', err)
    return c.json({ success: false, error: 'DB ì´ˆê¸°í™” ì‹¤íŒ¨: ' + err.message }, 500)
  }
})

// ğŸ”§ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ API
app.get('/api/db/migrate', async (c) => {
  try {
    console.log('ğŸ”§ [Migration] Starting database migrations...')
    const results = []
    
    // Migration 1: Add academy_id to users table if it doesn't exist
    try {
      await c.env.DB.prepare(`ALTER TABLE users ADD COLUMN academy_id INTEGER DEFAULT 1`).run()
      console.log('âœ… [Migration] Added academy_id column to users table')
      results.push('âœ… Added academy_id to users')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] academy_id column in users:', e.message)
      results.push('â„¹ï¸ users.academy_id: ' + e.message.substring(0, 50))
    }
    
    // Migration 2: Set default academy_id for users without it
    try {
      // First, try to update all users with NULL or 0 academy_id
      const updateResult = await c.env.DB.prepare(`UPDATE users SET academy_id = id WHERE academy_id IS NULL OR academy_id = 0`).run()
      console.log('âœ… [Migration] Set default academy_id for users (NULL/0):', updateResult.meta.changes)
      results.push('âœ… Updated ' + updateResult.meta.changes + ' users with academy_id from NULL/0')
      
      // Also ensure ALL users have academy_id (even if not NULL)
      const updateResult2 = await c.env.DB.prepare(`UPDATE users SET academy_id = id WHERE academy_id IS NULL`).run()
      console.log('âœ… [Migration] Double-check academy_id for users:', updateResult2.meta.changes)
      
      // Count users with academy_id
      const countResult = await c.env.DB.prepare(`SELECT COUNT(*) as count FROM users WHERE academy_id IS NOT NULL AND academy_id > 0`).first()
      results.push('âœ… Total users with academy_id: ' + (countResult?.count || 0))
    } catch (e) {
      console.log('â„¹ï¸ [Migration] Failed to set default academy_id:', e.message)
      results.push('â„¹ï¸ Update users: ' + e.message.substring(0, 50))
    }
    
    // Migration 3: Ensure academies table exists
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS academies (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          academy_name TEXT NOT NULL,
          owner_id INTEGER NOT NULL,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (owner_id) REFERENCES users(id)
        )
      `).run()
      console.log('âœ… [Migration] Created academies table')
      results.push('âœ… Created academies table')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] Academies table:', e.message)
      results.push('â„¹ï¸ academies: ' + e.message.substring(0, 50))
    }
    
    // Migration 4: Check if subscriptions table has user_id (old schema)
    let hasOldSchema = false
    try {
      const testQuery = await c.env.DB.prepare(`SELECT user_id FROM subscriptions LIMIT 1`).first()
      hasOldSchema = true
      console.log('ğŸ“‹ [Migration] Detected OLD subscriptions schema with user_id')
      results.push('ğŸ“‹ Old subscriptions schema detected')
    } catch (e) {
      console.log('ğŸ“‹ [Migration] New subscriptions schema detected (no user_id column)')
      results.push('ğŸ“‹ New subscriptions schema')
    }
    
    // Migration 5: Add academy_id to subscriptions if missing
    try {
      await c.env.DB.prepare(`ALTER TABLE subscriptions ADD COLUMN academy_id INTEGER`).run()
      console.log('âœ… [Migration] Added academy_id to subscriptions table')
      results.push('âœ… Added academy_id to subscriptions')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] subscriptions.academy_id:', e.message)
      results.push('â„¹ï¸ subscriptions.academy_id: ' + e.message.substring(0, 50))
    }
    
    // Migration 6: Populate academy_id from user_id if old schema
    if (hasOldSchema) {
      try {
        // Get academy_id from users table and update subscriptions
        const updateResult = await c.env.DB.prepare(`
          UPDATE subscriptions 
          SET academy_id = (SELECT academy_id FROM users WHERE users.id = subscriptions.user_id)
          WHERE academy_id IS NULL
        `).run()
        console.log('âœ… [Migration] Populated academy_id in subscriptions:', updateResult.meta.changes)
        results.push('âœ… Populated ' + updateResult.meta.changes + ' subscriptions with academy_id from users')
      } catch (e) {
        console.log('âš ï¸ [Migration] Failed to populate academy_id:', e.message)
        results.push('âš ï¸ Populate academy_id: ' + e.message.substring(0, 50))
      }
    }
    
    // Migration 7: Add new columns to subscriptions if missing
    const newColumns = [
      { name: 'plan_name', type: 'TEXT', default: "'ìŠ¤íƒ€í„° í”Œëœ'" },
      { name: 'plan_price', type: 'INTEGER', default: '0' },
      { name: 'student_limit', type: 'INTEGER', default: '30' },
      { name: 'ai_report_limit', type: 'INTEGER', default: '30' },
      { name: 'landing_page_limit', type: 'INTEGER', default: '40' },
      { name: 'teacher_limit', type: 'INTEGER', default: '2' },
      { name: 'subscription_start_date', type: 'TEXT', default: null },
      { name: 'subscription_end_date', type: 'TEXT', default: null },
      { name: 'payment_method', type: 'TEXT', default: null },
      { name: 'merchant_uid', type: 'TEXT', default: null }
    ]
    
    for (const col of newColumns) {
      try {
        const defaultClause = col.default ? ` DEFAULT ${col.default}` : ''
        await c.env.DB.prepare(`ALTER TABLE subscriptions ADD COLUMN ${col.name} ${col.type}${defaultClause}`).run()
        console.log(`âœ… [Migration] Added ${col.name} to subscriptions`)
        results.push(`âœ… Added subscriptions.${col.name}`)
      } catch (e) {
        // Column already exists, skip
      }
    }
    
    // Migration 8: Populate subscription_start_date and subscription_end_date from start_date/end_date
    if (hasOldSchema) {
      try {
        await c.env.DB.prepare(`
          UPDATE subscriptions 
          SET subscription_start_date = start_date,
              subscription_end_date = end_date
          WHERE subscription_start_date IS NULL
        `).run()
        console.log('âœ… [Migration] Migrated date columns')
        results.push('âœ… Migrated date columns')
      } catch (e) {
        console.log('â„¹ï¸ [Migration] Date migration:', e.message)
      }
    }
    
    // Migration 9: Ensure usage_tracking table exists
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS usage_tracking (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          academy_id INTEGER,
          subscription_id INTEGER NOT NULL,
          current_students INTEGER DEFAULT 0,
          ai_reports_used_this_month INTEGER DEFAULT 0,
          landing_pages_created INTEGER DEFAULT 0,
          current_teachers INTEGER DEFAULT 0,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
      `).run()
      console.log('âœ… [Migration] Created usage_tracking table')
      results.push('âœ… Created usage_tracking table')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] usage_tracking table:', e.message)
      results.push('â„¹ï¸ usage_tracking: ' + e.message.substring(0, 50))
    }
    
    // Migration 10: Add academy_id column to usage_tracking if missing (for old tables)
    try {
      await c.env.DB.prepare(`ALTER TABLE usage_tracking ADD COLUMN academy_id INTEGER`).run()
      console.log('âœ… [Migration] Added academy_id to existing usage_tracking table')
      results.push('âœ… Added academy_id to usage_tracking')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] usage_tracking.academy_id:', e.message)
      results.push('â„¹ï¸ usage_tracking.academy_id: exists')
    }
    
    // Migration 11: Create usage_tracking for all existing subscriptions without tracking
    try {
      const subsWithoutUsage = await c.env.DB.prepare(`
        SELECT s.id as subscription_id, s.academy_id 
        FROM subscriptions s
        WHERE s.id NOT IN (SELECT COALESCE(subscription_id, 0) FROM usage_tracking)
        AND s.status = 'active'
        AND s.academy_id IS NOT NULL
      `).all()
      
      if (subsWithoutUsage.results && subsWithoutUsage.results.length > 0) {
        let created = 0
        for (const sub of subsWithoutUsage.results) {
          try {
            await c.env.DB.prepare(`
              INSERT INTO usage_tracking (
                academy_id, subscription_id, 
                current_students, ai_reports_used_this_month, 
                landing_pages_created, current_teachers,
                created_at, updated_at
              ) VALUES (?, ?, 0, 0, 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
            `).bind(sub.academy_id, sub.subscription_id).run()
            created++
          } catch (insertError) {
            console.log('âš ï¸ Failed to create usage_tracking for subscription', sub.subscription_id, ':', insertError.message)
          }
        }
        console.log('âœ… [Migration] Created usage_tracking for', created, 'subscriptions')
        results.push('âœ… Created ' + created + ' usage_tracking records')
      } else {
        results.push('â„¹ï¸ All subscriptions have usage_tracking')
      }
    } catch (e) {
      console.log('âš ï¸ [Migration] Failed to create usage_tracking:', e.message)
      results.push('âš ï¸ usage_tracking creation: ' + e.message.substring(0, 50))
    }
    
    // Migration 12: Create forms table
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS forms (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          academy_id INTEGER NOT NULL,
          name TEXT NOT NULL,
          description TEXT,
          custom_html TEXT,
          header_script TEXT,
          pixel_script TEXT,
          terms_text TEXT DEFAULT 'ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.',
          success_message TEXT DEFAULT 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!',
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
      `).run()
      console.log('âœ… [Migration] Created forms table')
      results.push('âœ… Created forms table')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] forms table:', e.message)
      results.push('â„¹ï¸ forms: ' + e.message.substring(0, 50))
    }
    
    // Migration 13: Create form_submissions table
    try {
      // ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ (êµ¬ì¡° ë³€ê²½ì„ ìœ„í•´)
      try {
        await c.env.DB.prepare(`DROP TABLE IF EXISTS form_submissions`).run()
        console.log('ğŸ—‘ï¸ [Migration] Dropped old form_submissions table')
      } catch (dropErr) {
        console.log('â„¹ï¸ [Migration] No old table to drop')
      }
      
      // ìƒˆ í…Œì´ë¸” ìƒì„±
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS form_submissions (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          form_id INTEGER NOT NULL,
          landing_page_id INTEGER,
          name TEXT NOT NULL,
          phone TEXT,
          email TEXT,
          additional_data TEXT,
          agreed_to_terms INTEGER DEFAULT 0,
          ip_address TEXT,
          user_agent TEXT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (form_id) REFERENCES forms(id),
          FOREIGN KEY (landing_page_id) REFERENCES landing_pages(id)
        )
      `).run()
      console.log('âœ… [Migration] Created form_submissions table')
      results.push('âœ… Created form_submissions table')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] form_submissions table:', e.message)
      results.push('â„¹ï¸ form_submissions: ' + e.message.substring(0, 50))
    }
    
    // Migration 14: Add form_id column to landing_pages
    try {
      await c.env.DB.prepare(`ALTER TABLE landing_pages ADD COLUMN form_id INTEGER`).run()
      console.log('âœ… [Migration] Added form_id to landing_pages')
      results.push('âœ… Added form_id to landing_pages')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] landing_pages.form_id:', e.message)
      results.push('â„¹ï¸ landing_pages.form_id: exists')
    }
    
    // Migration 15: Create user_sessions table for real-time user tracking
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS user_sessions (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER,
          session_id TEXT NOT NULL UNIQUE,
          ip_address TEXT,
          user_agent TEXT,
          is_logged_in INTEGER DEFAULT 0,
          login_time DATETIME,
          logout_time DATETIME,
          last_activity DATETIME DEFAULT CURRENT_TIMESTAMP,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
      `).run()
      console.log('âœ… [Migration] Created user_sessions table')
      results.push('âœ… Created user_sessions table')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] user_sessions table:', e.message)
      results.push('â„¹ï¸ user_sessions: ' + e.message.substring(0, 50))
    }
    
    // Migration 16: Add is_korea_academy to free_plan_requests
    try {
      await c.env.DB.prepare(`ALTER TABLE free_plan_requests ADD COLUMN is_korea_academy INTEGER DEFAULT 0`).run()
      console.log('âœ… [Migration] Added is_korea_academy to free_plan_requests')
      results.push('âœ… Added is_korea_academy to free_plan_requests')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] free_plan_requests.is_korea_academy:', e.message)
      results.push('â„¹ï¸ free_plan_requests.is_korea_academy: exists')
    }
    
    // Migration 17: Add fields column to forms table for custom form fields
    try {
      await c.env.DB.prepare(`ALTER TABLE forms ADD COLUMN fields TEXT`).run()
      console.log('âœ… [Migration] Added fields column to forms table')
      results.push('âœ… Added fields column to forms')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] forms.fields:', e.message)
      results.push('â„¹ï¸ forms.fields: exists')
    }
    
    // Migration 18: Add pixel tracking columns to landing_pages
    try {
      await c.env.DB.prepare(`ALTER TABLE landing_pages ADD COLUMN header_pixel TEXT`).run()
      console.log('âœ… [Migration] Added header_pixel to landing_pages')
      results.push('âœ… Added header_pixel to landing_pages')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] landing_pages.header_pixel:', e.message)
      results.push('â„¹ï¸ landing_pages.header_pixel: exists')
    }
    
    try {
      await c.env.DB.prepare(`ALTER TABLE landing_pages ADD COLUMN body_pixel TEXT`).run()
      console.log('âœ… [Migration] Added body_pixel to landing_pages')
      results.push('âœ… Added body_pixel to landing_pages')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] landing_pages.body_pixel:', e.message)
      results.push('â„¹ï¸ landing_pages.body_pixel: exists')
    }
    
    try {
      await c.env.DB.prepare(`ALTER TABLE landing_pages ADD COLUMN conversion_pixel TEXT`).run()
      console.log('âœ… [Migration] Added conversion_pixel to landing_pages')
      results.push('âœ… Added conversion_pixel to landing_pages')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] landing_pages.conversion_pixel:', e.message)
      results.push('â„¹ï¸ landing_pages.conversion_pixel: exists')
    }
    
    // Migration 19: Drop and recreate form_submissions without FOREIGN KEY constraints
    try {
      // ê¸°ì¡´ ë°ì´í„° ë°±ì—…
      const existingSubmissions = await c.env.DB.prepare('SELECT * FROM form_submissions').all()
      console.log('ğŸ“¦ [Migration] Backing up form_submissions:', existingSubmissions.results.length)
      
      // í…Œì´ë¸” ì‚­ì œ
      await c.env.DB.prepare('DROP TABLE IF EXISTS form_submissions_old').run()
      await c.env.DB.prepare('ALTER TABLE form_submissions RENAME TO form_submissions_old').run()
      
      // FOREIGN KEY ì—†ì´ ì¬ìƒì„±
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS form_submissions (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          form_id INTEGER NOT NULL,
          landing_page_id INTEGER,
          name TEXT NOT NULL,
          phone TEXT,
          email TEXT,
          data TEXT,
          agreed_to_terms INTEGER DEFAULT 0,
          ip_address TEXT,
          user_agent TEXT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
      `).run()
      
      // ë°ì´í„° ë³µì›
      if (existingSubmissions.results.length > 0) {
        for (const row of existingSubmissions.results) {
          await c.env.DB.prepare(`
            INSERT INTO form_submissions (
              id, form_id, landing_page_id, name, phone, email, data, 
              agreed_to_terms, ip_address, user_agent, created_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
          `).bind(
            row.id, row.form_id, row.landing_page_id, row.name, row.phone, 
            row.email, row.data, row.agreed_to_terms, row.ip_address, 
            row.user_agent, row.created_at
          ).run()
        }
      }
      
      // êµ¬ í…Œì´ë¸” ì‚­ì œ
      await c.env.DB.prepare('DROP TABLE IF EXISTS form_submissions_old').run()
      
      console.log('âœ… [Migration] Recreated form_submissions without FOREIGN KEY')
      results.push('âœ… Recreated form_submissions without FOREIGN KEY constraints')
    } catch (e) {
      console.log('â„¹ï¸ [Migration] form_submissions recreation:', e.message)
      results.push('â„¹ï¸ form_submissions: ' + e.message.substring(0, 100))
    }
    
    return c.json({ 
      success: true, 
      message: 'ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
      results: results,
      note: hasOldSchema ? 'âš ï¸ Old schema detected - migrated to new schema' : 'âœ… Using new schema'
    })
  } catch (err) {
    console.error('âŒ [Migration] Error:', err)
    return c.json({ success: false, error: 'ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨: ' + err.message }, 500)
  }
})

// í¬ì¸íŠ¸ ì¶©ì „ API (í…ŒìŠ¤íŠ¸ìš©)

// ì„¸ì…˜ ì¶”ì  API - í˜ì´ì§€ ë°©ë¬¸ ì‹œ í˜¸ì¶œ
app.post('/api/session/track', async (c) => {
  try {
    const { sessionId, userId, path } = await c.req.json()
    const ipAddress = c.req.header('cf-connecting-ip') || c.req.header('x-forwarded-for') || 'unknown'
    const userAgent = c.req.header('user-agent') || 'unknown'
    
    if (!sessionId) {
      return c.json({ success: false, error: 'Session ID is required' }, 400)
    }
    
    // ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
    const existingSession = await c.env.DB.prepare(`
      SELECT * FROM user_sessions WHERE session_id = ?
    `).bind(sessionId).first()
    
    if (existingSession) {
      // ì„¸ì…˜ ì—…ë°ì´íŠ¸ - ë§ˆì§€ë§‰ í™œë™ ì‹œê°„ ê°±ì‹ 
      await c.env.DB.prepare(`
        UPDATE user_sessions 
        SET last_activity = CURRENT_TIMESTAMP,
            user_id = ?,
            is_logged_in = ?
        WHERE session_id = ?
      `).bind(userId || null, userId ? 1 : 0, sessionId).run()
    } else {
      // ìƒˆ ì„¸ì…˜ ìƒì„±
      await c.env.DB.prepare(`
        INSERT INTO user_sessions (session_id, user_id, ip_address, user_agent, is_logged_in, login_time)
        VALUES (?, ?, ?, ?, ?, ?)
      `).bind(
        sessionId, 
        userId || null, 
        ipAddress, 
        userAgent, 
        userId ? 1 : 0,
        userId ? new Date().toISOString() : null
      ).run()
    }
    
    return c.json({ success: true })
  } catch (err) {
    console.error('Session track error:', err)
    return c.json({ success: false, error: 'Session tracking failed' }, 500)
  }
})

// ë¡œê·¸ì¸ ì„¸ì…˜ ì—…ë°ì´íŠ¸
app.post('/api/session/login', async (c) => {
  try {
    const { sessionId, userId } = await c.req.json()
    
    if (!sessionId || !userId) {
      return c.json({ success: false, error: 'Session ID and User ID are required' }, 400)
    }
    
    await c.env.DB.prepare(`
      UPDATE user_sessions 
      SET user_id = ?,
          is_logged_in = 1,
          login_time = CURRENT_TIMESTAMP,
          last_activity = CURRENT_TIMESTAMP
      WHERE session_id = ?
    `).bind(userId, sessionId).run()
    
    return c.json({ success: true })
  } catch (err) {
    console.error('Session login error:', err)
    return c.json({ success: false, error: 'Session login update failed' }, 500)
  }
})

// ë¡œê·¸ì•„ì›ƒ ì„¸ì…˜ ì—…ë°ì´íŠ¸
app.post('/api/session/logout', async (c) => {
  try {
    const { sessionId } = await c.req.json()
    
    if (!sessionId) {
      return c.json({ success: false, error: 'Session ID is required' }, 400)
    }
    
    await c.env.DB.prepare(`
      UPDATE user_sessions 
      SET logout_time = CURRENT_TIMESTAMP,
          last_activity = CURRENT_TIMESTAMP
      WHERE session_id = ?
    `).bind(sessionId).run()
    
    return c.json({ success: true })
  } catch (err) {
    console.error('Session logout error:', err)
    return c.json({ success: false, error: 'Session logout update failed' }, 500)
  }
})

// ê´€ë¦¬ì: ì‹¤ì‹œê°„ ì ‘ì†ì ì¡°íšŒ API
app.get('/api/admin/active-sessions', async (c) => {
  try {
    // DB í™•ì¸
    if (!c.env?.DB) {
      console.error('[Active Sessions] DB not available')
      return c.json({ success: false, error: 'Database not available' }, 500)
    }
    
    // ê´€ë¦¬ì í™•ì¸
    const userHeaderBase64 = c.req.header('X-User-Data-Base64')
    if (!userHeaderBase64) {
      return c.json({ success: false, error: 'Unauthorized' }, 401)
    }
    
    let user
    try {
      const userDataStr = atob(userHeaderBase64)
      user = JSON.parse(userDataStr)
    } catch (e) {
      console.error('[Active Sessions] User data decode error:', e)
      return c.json({ success: false, error: 'Invalid user data' }, 401)
    }
    
    if (user.role !== 'admin') {
      return c.json({ success: false, error: 'Admin only' }, 403)
    }
    
    console.log('[Active Sessions] Fetching active sessions...')
    
    // ìµœê·¼ 10ë¶„ ì´ë‚´ í™œë™í•œ ì„¸ì…˜ ì¡°íšŒ (ì‹¤ì‹œê°„ìœ¼ë¡œ ê°„ì£¼)
    const activeSessions = await c.env.DB.prepare(`
      SELECT 
        s.*,
        u.name as user_name,
        u.email as user_email,
        u.academy_name
      FROM user_sessions s
      LEFT JOIN users u ON s.user_id = u.id
      WHERE s.last_activity >= datetime('now', '-10 minutes')
        AND s.logout_time IS NULL
      ORDER BY s.last_activity DESC
    `).all()
    
    console.log('[Active Sessions] Found sessions:', activeSessions.results?.length || 0)
    
    // íšŒì›/ë¹„íšŒì› êµ¬ë¶„
    const loggedInUsers = (activeSessions.results || []).filter(s => s.is_logged_in === 1)
    const guests = (activeSessions.results || []).filter(s => s.is_logged_in === 0)
    
    // ì´ ì ‘ì†ì í†µê³„ (ì „ì²´ ê¸°ê°„)
    const totalStats = await c.env.DB.prepare(`
      SELECT 
        COUNT(*) as total_sessions,
        COUNT(CASE WHEN is_logged_in = 1 THEN 1 END) as total_logged_in,
        COUNT(CASE WHEN is_logged_in = 0 THEN 1 END) as total_guests
      FROM user_sessions
    `).first()
    
    return c.json({
      success: true,
      activeSessions: {
        loggedIn: loggedInUsers,
        guests: guests,
        total: (activeSessions.results || []).length,
        loggedInCount: loggedInUsers.length,
        guestsCount: guests.length
      },
      totalStats: totalStats || { total_sessions: 0, total_logged_in: 0, total_guests: 0 }
    })
  } catch (err) {
    console.error('[Active Sessions] Error:', err)
    return c.json({ 
      success: false, 
      error: 'Failed to fetch active sessions',
      details: err.message || String(err)
    }, 500)
  }
})

// ë‚ ì§œë³„ ì ‘ì†ì í†µê³„ API
app.get('/api/admin/sessions/history', async (c) => {
  try {
    // ê´€ë¦¬ì í™•ì¸
    const userHeaderBase64 = c.req.header('X-User-Data-Base64')
    if (!userHeaderBase64) {
      return c.json({ success: false, error: 'Unauthorized' }, 401)
    }
    
    let user
    try {
      const userDataStr = atob(userHeaderBase64)
      user = JSON.parse(userDataStr)
    } catch (e) {
      return c.json({ success: false, error: 'Invalid user data' }, 401)
    }
    
    if (user.role !== 'admin') {
      return c.json({ success: false, error: 'Admin only' }, 403)
    }
    
    const startDate = c.req.query('startDate') // YYYY-MM-DD
    const endDate = c.req.query('endDate')     // YYYY-MM-DD
    const searchKeyword = c.req.query('search') // ì´ë¦„, ì´ë©”ì¼, IP ê²€ìƒ‰
    
    let whereConditions = []
    let params = []
    
    // ë‚ ì§œ í•„í„°
    if (startDate) {
      whereConditions.push(`date(s.created_at) >= ?`)
      params.push(startDate)
    }
    if (endDate) {
      whereConditions.push(`date(s.created_at) <= ?`)
      params.push(endDate)
    }
    
    // ê²€ìƒ‰ í•„í„°
    if (searchKeyword) {
      whereConditions.push(`(
        u.name LIKE ? OR 
        u.email LIKE ? OR 
        u.academy_name LIKE ? OR 
        s.ip_address LIKE ?
      )`)
      const searchPattern = `%${searchKeyword}%`
      params.push(searchPattern, searchPattern, searchPattern, searchPattern)
    }
    
    const whereClause = whereConditions.length > 0 
      ? 'WHERE ' + whereConditions.join(' AND ')
      : ''
    
    // ë‚ ì§œë³„ í†µê³„
    const dailyStats = await c.env.DB.prepare(`
      SELECT 
        date(created_at) as date,
        COUNT(*) as total_sessions,
        COUNT(CASE WHEN is_logged_in = 1 THEN 1 END) as logged_in_sessions,
        COUNT(CASE WHEN is_logged_in = 0 THEN 1 END) as guest_sessions,
        COUNT(DISTINCT user_id) as unique_users
      FROM user_sessions
      ${whereClause.replace(/s\./g, '')}
      GROUP BY date(created_at)
      ORDER BY date DESC
      LIMIT 90
    `).bind(...params).all()
    
    // ìƒì„¸ ì„¸ì…˜ ëª©ë¡
    const sessions = await c.env.DB.prepare(`
      SELECT 
        s.id,
        s.user_id,
        s.session_id,
        s.ip_address,
        s.user_agent,
        s.is_logged_in,
        s.login_time,
        s.logout_time,
        s.last_activity,
        s.created_at,
        u.name as user_name,
        u.email as user_email,
        u.academy_name
      FROM user_sessions s
      LEFT JOIN users u ON s.user_id = u.id
      ${whereClause}
      ORDER BY s.created_at DESC
      LIMIT 1000
    `).bind(...params).all()
    
    return c.json({
      success: true,
      dailyStats: dailyStats.results || [],
      sessions: sessions.results || [],
      filters: {
        startDate: startDate || null,
        endDate: endDate || null,
        search: searchKeyword || null
      }
    })
  } catch (err) {
    console.error('[Sessions History] Error:', err)
    return c.json({ 
      success: false, 
      error: 'Failed to fetch sessions history',
      details: err.message || String(err)
    }, 500)
  }
})

app.post('/api/points/charge', async (c) => {
  try {
    const { userId, amount } = await c.req.json()
    
    if (!userId || !amount) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDì™€ ì¶©ì „ ê¸ˆì•¡ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    // ì‚¬ìš©ì ì¡°íšŒ
    const user = await c.env.DB.prepare('SELECT * FROM users WHERE id = ?').bind(userId).first()
    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    const balanceBefore = user.balance || 0

    // í¬ì¸íŠ¸ ì¶©ì „
    await c.env.DB.prepare('UPDATE users SET balance = balance + ? WHERE id = ?').bind(amount, userId).run()

    // ê±°ë˜ ë‚´ì—­ ê¸°ë¡
    await c.env.DB.prepare(`
      INSERT INTO point_transactions (user_id, amount, balance_before, balance_after, transaction_type, description, created_at)
      VALUES (?, ?, ?, ?, 'charge', 'í…ŒìŠ¤íŠ¸ ì¶©ì „', CURRENT_TIMESTAMP)
    `).bind(userId, amount, balanceBefore, balanceBefore + amount).run()

    const updatedUser = await c.env.DB.prepare('SELECT balance FROM users WHERE id = ?').bind(userId).first()

    return c.json({ 
      success: true, 
      message: 'í¬ì¸íŠ¸ê°€ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤.',
      balance: updatedUser.balance
    })
  } catch (err: any) {
    console.error('Charge points error:', err)
    return c.json({ success: false, error: 'í¬ì¸íŠ¸ ì¶©ì „ ì‹¤íŒ¨: ' + err.message }, 500)
  }
})

// SMS ë°œì†¡ API (í•µì‹¬ ë¡œì§ - ì„ ì°¨ê° í›„ë°œì†¡)
app.post('/api/sms/send', async (c) => {
  try {
    const { userId, senderId, receivers, message, reserveTime } = await c.req.json()
    
    if (!userId || !senderId || !receivers || !message) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // 1. ì‚¬ìš©ì ì”ì•¡ ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT balance FROM users WHERE id = ?
    `).bind(userId).first()
    
    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    // 2. ë©”ì‹œì§€ íƒ€ì… ê²°ì • (ë°”ì´íŠ¸ ìˆ˜ ê³„ì‚°)
    const byteSize = new Blob([message]).size
    let messageType = 'SMS'
    if (byteSize > 90) {
      messageType = 'LMS'
    }
    
    // 3. ìš”ê¸ˆ ì¡°íšŒ
    const pricing = await c.env.DB.prepare(`
      SELECT retail_price FROM sms_pricing WHERE message_type = ?
    `).bind(messageType).first()
    
    if (!pricing) {
      return c.json({ success: false, error: 'SMS ìš”ê¸ˆ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 500)
    }
    
    const costPerMessage = pricing.retail_price
    const totalCost = costPerMessage * receivers.length
    
    // 4. ì”ì•¡ í™•ì¸
    if (user.balance < totalCost) {
      return c.json({ 
        success: false, 
        error: `í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${totalCost}P, ë³´ìœ : ${user.balance}P)` 
      }, 400)
    }

    // 5. í¬ì¸íŠ¸ ì„ ì°¨ê° (íŠ¸ëœì­ì…˜ ì‹œì‘)
    const balanceBefor = user.balance
    const balanceAfter = user.balance - totalCost
    
    await c.env.DB.prepare(`
      UPDATE users SET balance = ? WHERE id = ?
    `).bind(balanceAfter, userId).run()
    
    // 6. í¬ì¸íŠ¸ ê±°ë˜ ë‚´ì—­ ê¸°ë¡
    await c.env.DB.prepare(`
      INSERT INTO point_transactions (user_id, transaction_type, amount, balance_before, balance_after, description)
      VALUES (?, 'sms_cost', ?, ?, ?, ?)
    `).bind(userId, -totalCost, balanceBefor, balanceAfter, `SMS ${receivers.length}ê±´ ë°œì†¡`).run()
    
    // 7. ë°œì‹ ë²ˆí˜¸ ì¡°íšŒ
    const sender = await c.env.DB.prepare(`
      SELECT phone_number FROM sender_ids WHERE id = ? AND user_id = ? AND status = 'verified'
    `).bind(senderId, userId).first()
    
    if (!sender) {
      // ì‹¤íŒ¨ ì‹œ í¬ì¸íŠ¸ í™˜ë¶ˆ
      await c.env.DB.prepare(`
        UPDATE users SET balance = ? WHERE id = ?
      `).bind(balanceBefor, userId).run()
      
      return c.json({ success: false, error: 'ì¸ì¦ëœ ë°œì‹ ë²ˆí˜¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    // 8. ì•Œë¦¬ê³  API í˜¸ì¶œ (ì‹¤ì œ ë°œì†¡)
    const aligoApiKey = c.env.ALIGO_API_KEY || '4bbi3l27pb5qh11tkujl578bttz6vb5j'
    const aligoUserId = c.env.ALIGO_USER_ID || 'wangholy'
    
    console.log('Aligo ENV Check:', { 
      hasApiKey: !!c.env.ALIGO_API_KEY, 
      hasUserId: !!c.env.ALIGO_USER_ID,
      apiKeyLength: c.env.ALIGO_API_KEY?.length,
      userId: c.env.ALIGO_USER_ID
    })
    
    const formData = new URLSearchParams()
    formData.append('key', aligoApiKey)
    formData.append('user_id', aligoUserId)
    formData.append('sender', sender.phone_number)
    formData.append('receiver', receivers.map((r: any) => r.phone).join(','))
    formData.append('msg', message)
    formData.append('msg_type', messageType)
    
    if (reserveTime) {
      formData.append('rdate', reserveTime.split('T')[0].replace(/-/g, ''))
      formData.append('rtime', reserveTime.split('T')[1].substring(0, 5).replace(':', ''))
    }
    
    const aligoResponse = await fetch('https://apis.aligo.in/send/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: formData
    })
    
    const aligoResult = await aligoResponse.json()
    
    // 9. ë°œì†¡ ê²°ê³¼ ì²˜ë¦¬
    if (aligoResult.result_code === '1') {
      // ì„±ê³µ: SMS ë¡œê·¸ ê¸°ë¡
      const logResult = await c.env.DB.prepare(`
        INSERT INTO sms_logs (user_id, sender_id, sender_number, receiver_number, message_type, message_content, byte_size, point_cost, status, alligo_response, alligo_msg_id, reserve_time, sent_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'success', ?, ?, ?, CURRENT_TIMESTAMP)
      `).bind(
        userId, 
        senderId, 
        sender.phone_number, 
        receivers.map((r: any) => r.phone).join(','),
        messageType,
        message,
        byteSize,
        totalCost,
        JSON.stringify(aligoResult),
        aligoResult.msg_id || null,
        reserveTime || null
      ).run()
      
      // ìˆ˜ì‹ ìë³„ ìƒì„¸ ê¸°ë¡
      for (const receiver of receivers) {
        const personalizedMessage = message.replace(/#{ì´ë¦„}/g, receiver.name || '')
        await c.env.DB.prepare(`
          INSERT INTO sms_recipients (sms_log_id, receiver_number, receiver_name, message_content, status, sent_at)
          VALUES (?, ?, ?, ?, 'success', CURRENT_TIMESTAMP)
        `).bind(logResult.meta.last_row_id, receiver.phone, receiver.name || null, personalizedMessage).run()
      }
      
      return c.json({ 
        success: true, 
        message: 'ë¬¸ì ë°œì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
        sentCount: receivers.length,
        totalCost: totalCost,
        remainingBalance: balanceAfter
      })
    } else {
      // ì‹¤íŒ¨: í¬ì¸íŠ¸ í™˜ë¶ˆ
      await c.env.DB.prepare(`
        UPDATE users SET balance = ? WHERE id = ?
      `).bind(balanceBefor, userId).run()
      
      await c.env.DB.prepare(`
        INSERT INTO point_transactions (user_id, transaction_type, amount, balance_before, balance_after, description)
        VALUES (?, 'refund', ?, ?, ?, ?)
      `).bind(userId, totalCost, balanceAfter, balanceBefor, `SMS ë°œì†¡ ì‹¤íŒ¨ë¡œ ì¸í•œ í™˜ë¶ˆ`).run()
      
      // ì‹¤íŒ¨ ë¡œê·¸ ê¸°ë¡
      await c.env.DB.prepare(`
        INSERT INTO sms_logs (user_id, sender_id, sender_number, receiver_number, message_type, message_content, byte_size, point_cost, status, alligo_response)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'failed', ?)
      `).bind(
        userId, 
        senderId, 
        sender.phone_number, 
        receivers.map((r: any) => r.phone).join(','),
        messageType,
        message,
        byteSize,
        totalCost,
        JSON.stringify(aligoResult)
      ).run()
      
      return c.json({ 
        success: false, 
        error: aligoResult.message || 'ë¬¸ì ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
        aligoError: aligoResult
      }, 400)
    }
  } catch (err) {
    console.error('SMS send error:', err)
    return c.json({ success: false, error: 'ë¬¸ì ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// SMS ë°œì†¡ ë‚´ì—­ ì¡°íšŒ API
app.get('/api/sms/logs', async (c) => {
  try {
    const userId = c.req.query('userId')
    const page = parseInt(c.req.query('page') || '1')
    const limit = parseInt(c.req.query('limit') || '20')
    const offset = (page - 1) * limit
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    const logs = await c.env.DB.prepare(`
      SELECT 
        sms_logs.*,
        sender_ids.phone_number as sender_phone
      FROM sms_logs
      LEFT JOIN sender_ids ON sms_logs.sender_id = sender_ids.id
      WHERE sms_logs.user_id = ?
      ORDER BY sms_logs.created_at DESC
      LIMIT ? OFFSET ?
    `).bind(userId, limit, offset).all()

    const total = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM sms_logs WHERE user_id = ?
    `).bind(userId).first()

    return c.json({ 
      success: true, 
      logs: logs.results,
      pagination: {
        page,
        limit,
        total: total?.count || 0,
        totalPages: Math.ceil((total?.count || 0) / limit)
      }
    })
  } catch (err) {
    console.error('Get SMS logs error:', err)
    return c.json({ success: false, error: 'SMS ë°œì†¡ ë‚´ì—­ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// í¬ì¸íŠ¸ ì¶©ì „ API (ê´€ë¦¬ì ì „ìš©)
app.post('/api/sms/charge', async (c) => {
  try {
    const { userId, amount, adminId, description } = await c.req.json()
    
    if (!userId || !amount || !adminId) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await c.env.DB.prepare(`
      SELECT role FROM users WHERE id = ?
    `).bind(adminId).first()
    
    if (!admin || admin.role !== 'admin') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    // ì‚¬ìš©ì ì”ì•¡ ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT balance FROM users WHERE id = ?
    `).bind(userId).first()
    
    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    const balanceBefore = user.balance
    const balanceAfter = user.balance + amount
    
    // í¬ì¸íŠ¸ ì¶©ì „
    await c.env.DB.prepare(`
      UPDATE users SET balance = ? WHERE id = ?
    `).bind(balanceAfter, userId).run()
    
    // ê±°ë˜ ë‚´ì—­ ê¸°ë¡
    await c.env.DB.prepare(`
      INSERT INTO point_transactions (user_id, transaction_type, amount, balance_before, balance_after, description, admin_id)
      VALUES (?, 'charge', ?, ?, ?, ?, ?)
    `).bind(userId, amount, balanceBefore, balanceAfter, description || 'ê´€ë¦¬ì í¬ì¸íŠ¸ ì¶©ì „', adminId).run()
    
    return c.json({ 
      success: true, 
      message: 'í¬ì¸íŠ¸ ì¶©ì „ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      balance: balanceAfter
    })
  } catch (err) {
    console.error('Point charge error:', err)
    return c.json({ success: false, error: 'í¬ì¸íŠ¸ ì¶©ì „ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ============================================
// ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼í†¡ API Routes
// ============================================

// ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼í†¡ ìš”ê¸ˆí‘œ ì¡°íšŒ
app.get('/api/kakao/pricing', async (c) => {
  try {
    const { results } = await c.env.DB.prepare(`
      SELECT * FROM kakao_pricing ORDER BY wholesale_price ASC
    `).all()

    return c.json({ success: true, pricing: results })
  } catch (err) {
    console.error('Failed to load kakao pricing:', err)
    return c.json({ success: false, error: 'ìš”ê¸ˆí‘œ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ì¹´ì¹´ì˜¤í†¡ ë°œì‹  í”„ë¡œí•„ ëª©ë¡ ì¡°íšŒ
app.get('/api/kakao/profiles', async (c) => {
  try {
    const userId = c.req.query('userId')
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    const { results } = await c.env.DB.prepare(`
      SELECT id, sender_key, profile_name, category_code, status, verification_date, created_at
      FROM kakao_sender_profiles
      WHERE user_id = ?
      ORDER BY created_at DESC
    `).bind(userId).all()

    return c.json({ success: true, profiles: results || [] })
  } catch (err) {
    console.error('Failed to load kakao profiles:', err)
    return c.json({ success: false, error: 'ë°œì‹  í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ì¹´ì¹´ì˜¤í†¡ ë°œì‹  í”„ë¡œí•„ ë“±ë¡
app.post('/api/kakao/profile/register', async (c) => {
  try {
    const { userId, senderKey, profileName, categoryCode } = await c.req.json()
    
    if (!userId || !senderKey || !profileName) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ì¤‘ë³µ í™•ì¸
    const existing = await c.env.DB.prepare(`
      SELECT id FROM kakao_sender_profiles WHERE sender_key = ? AND user_id = ?
    `).bind(senderKey, userId).first()

    if (existing) {
      return c.json({ success: false, error: 'ì´ë¯¸ ë“±ë¡ëœ ë°œì‹  í”„ë¡œí•„ì…ë‹ˆë‹¤.' }, 400)
    }

    const result = await c.env.DB.prepare(`
      INSERT INTO kakao_sender_profiles (user_id, sender_key, profile_name, category_code, status)
      VALUES (?, ?, ?, ?, 'active')
    `).bind(userId, senderKey, profileName, categoryCode || null).run()

    return c.json({ 
      success: true, 
      message: 'ë°œì‹  í”„ë¡œí•„ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
      profileId: result.meta.last_row_id
    })
  } catch (err) {
    console.error('Failed to register kakao profile:', err)
    return c.json({ success: false, error: 'ë°œì‹  í”„ë¡œí•„ ë“±ë¡ ì‹¤íŒ¨' }, 500)
  }
})

// ì¹´ì¹´ì˜¤í†¡ í…œí”Œë¦¿ ëª©ë¡ ì¡°íšŒ
app.get('/api/kakao/templates', async (c) => {
  try {
    const userId = c.req.query('userId')
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    const { results } = await c.env.DB.prepare(`
      SELECT * FROM kakao_templates
      WHERE user_id = ?
      ORDER BY created_at DESC
    `).bind(userId).all()

    return c.json({ success: true, templates: results || [] })
  } catch (err) {
    console.error('Failed to load kakao templates:', err)
    return c.json({ success: false, error: 'í…œí”Œë¦¿ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ì¹´ì¹´ì˜¤í†¡ í…œí”Œë¦¿ ë“±ë¡
app.post('/api/kakao/template/register', async (c) => {
  try {
    const { 
      userId, 
      templateCode, 
      templateName, 
      templateContent, 
      buttonsJson 
    } = await c.req.json()
    
    if (!userId || !templateCode || !templateName || !templateContent) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    const result = await c.env.DB.prepare(`
      INSERT INTO kakao_templates (
        user_id, template_code, template_name, template_content, 
        buttons_json, status
      ) VALUES (?, ?, ?, ?, ?, 'approved')
    `).bind(userId, templateCode, templateName, templateContent, buttonsJson || null).run()

    return c.json({ 
      success: true, 
      message: 'í…œí”Œë¦¿ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
      templateId: result.meta.last_row_id
    })
  } catch (err) {
    console.error('Failed to register kakao template:', err)
    return c.json({ success: false, error: 'í…œí”Œë¦¿ ë“±ë¡ ì‹¤íŒ¨' }, 500)
  }
})

// ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼í†¡ ë°œì†¡ API (ì•Œë¦¬ê³  ì—°ë™)
app.post('/api/kakao/send', async (c) => {
  try {
    const { 
      userId, 
      senderKey, 
      templateCode, 
      receivers,      // [{name: 'í™ê¸¸ë™', phone: '01012345678', variables: {...}}]
      failover,       // Y/N (SMS ëŒ€ì²´ë°œì†¡)
      failoverSms,    // ëŒ€ì²´ë°œì†¡ SMS ë‚´ìš©
      reserveTime     // ì˜ˆì•½ë°œì†¡ ì‹œê°„ (ì„ íƒ)
    } = await c.req.json()

    console.log('Kakao send request:', { userId, senderKey, templateCode, receiversCount: receivers?.length })

    // 1. í•„ìˆ˜ ì…ë ¥ê°’ ê²€ì¦
    if (!userId || !senderKey || !templateCode || !receivers || receivers.length === 0) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // 2. í…œí”Œë¦¿ ì¡°íšŒ
    const template = await c.env.DB.prepare(`
      SELECT * FROM kakao_templates WHERE template_code = ? AND user_id = ?
    `).bind(templateCode, userId).first()

    if (!template) {
      return c.json({ success: false, error: 'í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    // 3. ìš”ê¸ˆ ì¡°íšŒ
    const pricing = await c.env.DB.prepare(`
      SELECT retail_price FROM kakao_pricing WHERE message_type = 'ALIMTALK'
    `).first()

    const unitPrice = pricing?.retail_price || 15
    const totalCost = unitPrice * receivers.length

    // 4. ì‚¬ìš©ì ì”ì•¡ í™•ì¸ ë° í¬ì¸íŠ¸ ì„ ì°¨ê°
    const user = await c.env.DB.prepare(`
      SELECT balance FROM users WHERE id = ?
    `).bind(userId).first()

    if (!user || user.balance < totalCost) {
      return c.json({ 
        success: false, 
        error: `í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (í•„ìš”: ${totalCost}P, ë³´ìœ : ${user?.balance || 0}P)`
      }, 400)
    }

    const balanceBefore = user.balance
    const balanceAfter = balanceBefore - totalCost

    // í¬ì¸íŠ¸ ì°¨ê°
    await c.env.DB.prepare(`
      UPDATE users SET balance = ? WHERE id = ?
    `).bind(balanceAfter, userId).run()

    // í¬ì¸íŠ¸ ê±°ë˜ ë‚´ì—­ ê¸°ë¡
    await c.env.DB.prepare(`
      INSERT INTO point_transactions (user_id, transaction_type, amount, balance_before, balance_after, description)
      VALUES (?, 'kakao_cost', ?, ?, ?, ?)
    `).bind(
      userId, 
      -totalCost, 
      balanceBefore, 
      balanceAfter, 
      `ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ${receivers.length}ê±´ ë°œì†¡`
    ).run()

    console.log('Points deducted:', balanceBefore, '->', balanceAfter)

    // 5. ì•Œë¦¬ê³  API í˜¸ì¶œ (ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼í†¡ ë°œì†¡)
    try {
      const aligoApiKey = c.env.ALIGO_API_KEY
      const aligoUserId = c.env.ALIGO_USER_ID

      if (!aligoApiKey || !aligoUserId) {
        throw new Error('ì•Œë¦¬ê³  API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')
      }

      // ìˆ˜ì‹ ì ëª©ë¡ì„ ì•Œë¦¬ê³  í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      const receiverList = receivers.map(r => ({
        rcv: r.phone.replace(/-/g, ''),
        rcv_name: r.name || '',
        emtitle_1: r.variables?.title || '',  // í…œí”Œë¦¿ ë³€ìˆ˜
        message: template.template_content    // ê¸°ë³¸ ë©”ì‹œì§€
      }))

      const aligoRequest = {
        apikey: aligoApiKey,
        userid: aligoUserId,
        senderkey: senderKey,
        tpl_code: templateCode,
        sender: senderKey,
        receiver_1: receiverList[0].rcv,
        recvname_1: receiverList[0].rcv_name,
        subject_1: receiverList[0].emtitle_1,
        message_1: receiverList[0].message,
        failover: failover || 'Y',
        fsubject_1: failoverSms || 'ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼',
        fmessage_1: failoverSms || template.template_content
      }

      // ì˜ˆì•½ ë°œì†¡ ì„¤ì •
      if (reserveTime) {
        const reserveDate = new Date(reserveTime)
        aligoRequest.rdate = reserveDate.toISOString().split('T')[0].replace(/-/g, '')
        aligoRequest.rtime = reserveDate.toTimeString().split(' ')[0].replace(/:/g, '').substring(0, 4)
      }

      const aligoResponse = await fetch('https://kakaoapi.aligo.in/akv10/alimtalk/send/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams(aligoRequest)
      })

      const aligoData = await aligoResponse.json()
      console.log('Aligo kakao response:', aligoData)

      // 6. ë°œì†¡ ë¡œê·¸ ì €ì¥
      const logResult = await c.env.DB.prepare(`
        INSERT INTO kakao_logs (
          user_id, sender_key, template_code, receiver_phone, receiver_name, 
          message, buttons_json, fail_over, fail_over_sms, 
          status, result_code, result_message, msg_id, cost, reserved_date, sent_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      `).bind(
        userId, senderKey, templateCode, 
        receivers[0].phone, receivers[0].name,
        template.template_content, template.buttons_json, 
        failover || 'Y', failoverSms,
        aligoData.result_code === 1 ? 'success' : 'failed',
        aligoData.result_code || 0,
        aligoData.message || '',
        aligoData.msg_id || '',
        totalCost,
        reserveTime || null
      ).run()

      const kakaoLogId = logResult.meta.last_row_id

      // ìˆ˜ì‹ ìë³„ ìƒì„¸ ë‚´ì—­ ì €ì¥
      for (const receiver of receivers) {
        await c.env.DB.prepare(`
          INSERT INTO kakao_recipients (
            kakao_log_id, receiver_phone, receiver_name, status, sent_at
          ) VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP)
        `).bind(
          kakaoLogId, 
          receiver.phone, 
          receiver.name,
          aligoData.result_code === 1 ? 'success' : 'pending'
        ).run()
      }

      if (aligoData.result_code === 1) {
        return c.json({ 
          success: true, 
          message: `ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ${receivers.length}ê±´ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.`,
          balance: balanceAfter,
          cost: totalCost,
          msgId: aligoData.msg_id
        })
      } else {
        // ë°œì†¡ ì‹¤íŒ¨ ì‹œ í¬ì¸íŠ¸ í™˜ë¶ˆ
        await c.env.DB.prepare(`
          UPDATE users SET balance = ? WHERE id = ?
        `).bind(balanceBefore, userId).run()

        await c.env.DB.prepare(`
          INSERT INTO point_transactions (user_id, transaction_type, amount, balance_before, balance_after, description)
          VALUES (?, 'refund', ?, ?, ?, ?)
        `).bind(
          userId, 
          totalCost, 
          balanceAfter, 
          balanceBefore, 
          'ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ë°œì†¡ ì‹¤íŒ¨ë¡œ ì¸í•œ í™˜ë¶ˆ'
        ).run()

        return c.json({ 
          success: false, 
          error: aligoData.message || 'ì•Œë¦¼í†¡ ë°œì†¡ ì‹¤íŒ¨',
          aligoError: aligoData
        }, 500)
      }

    } catch (aligoError) {
      console.error('Aligo kakao API error:', aligoError)
      
      // API ì˜¤ë¥˜ ì‹œ í¬ì¸íŠ¸ í™˜ë¶ˆ
      await c.env.DB.prepare(`
        UPDATE users SET balance = ? WHERE id = ?
      `).bind(balanceBefore, userId).run()

      await c.env.DB.prepare(`
        INSERT INTO point_transactions (user_id, transaction_type, amount, balance_before, balance_after, description)
        VALUES (?, 'refund', ?, ?, ?, ?)
      `).bind(
        userId, 
        totalCost, 
        balanceAfter, 
        balanceBefore, 
        'ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ API ì˜¤ë¥˜ë¡œ ì¸í•œ í™˜ë¶ˆ'
      ).run()

      return c.json({ 
        success: false, 
        error: 'ì•Œë¦¬ê³  API í˜¸ì¶œ ì‹¤íŒ¨',
        details: aligoError.message
      }, 500)
    }

  } catch (err) {
    console.error('Kakao send error:', err)
    return c.json({ success: false, error: 'ì•Œë¦¼í†¡ ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼í†¡ ë°œì†¡ ë‚´ì—­ ì¡°íšŒ
app.get('/api/kakao/logs', async (c) => {
  try {
    const userId = c.req.query('userId')
    const page = parseInt(c.req.query('page') || '1')
    const limit = parseInt(c.req.query('limit') || '20')
    const offset = (page - 1) * limit

    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    const { results } = await c.env.DB.prepare(`
      SELECT * FROM kakao_logs
      WHERE user_id = ?
      ORDER BY created_at DESC
      LIMIT ? OFFSET ?
    `).bind(userId, limit, offset).all()

    const total = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM kakao_logs WHERE user_id = ?
    `).bind(userId).first()

    // í†µê³„ ì¡°íšŒ
    const stats = await c.env.DB.prepare(`
      SELECT 
        COUNT(*) as total_sent,
        SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) as success_count,
        SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed_count,
        SUM(cost) as total_cost
      FROM kakao_logs
      WHERE user_id = ?
    `).bind(userId).first()

    return c.json({ 
      success: true, 
      logs: results || [],
      pagination: {
        page,
        limit,
        total: total?.count || 0,
        totalPages: Math.ceil((total?.count || 0) / limit)
      },
      stats: {
        totalSent: stats?.total_sent || 0,
        successCount: stats?.success_count || 0,
        failedCount: stats?.failed_count || 0,
        totalCost: stats?.total_cost || 0
      }
    })
  } catch (err) {
    console.error('Failed to load kakao logs:', err)
    return c.json({ success: false, error: 'ë°œì†¡ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ============================================
// End of ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼í†¡ API Routes
// ============================================

// ì…ê¸ˆ ì‹ ì²­ API
app.post('/api/deposit/request', async (c) => {
  try {
    const { userId, userName, userEmail, amount, bankName, accountNumber, depositorName, message } = await c.req.json()

    if (!userId || !amount || amount <= 0) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    const result = await c.env.DB.prepare(`
      INSERT INTO deposit_requests (user_id, user_name, user_email, amount, bank_name, account_number, depositor_name, message, status)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'pending')
    `).bind(userId, userName, userEmail, amount, bankName || null, accountNumber || null, depositorName || null, message || null).run()

    return c.json({ 
      success: true, 
      message: 'ì…ê¸ˆ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      requestId: result.meta.last_row_id
    })
  } catch (err) {
    console.error('Deposit request error:', err)
    return c.json({ success: false, error: 'ì…ê¸ˆ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì‚¬ìš©ìë³„ ì…ê¸ˆ ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ API
app.get('/api/deposit/my-requests/:userId', async (c) => {
  try {
    const userId = c.req.param('userId')
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    const { results } = await c.env.DB.prepare(`
      SELECT 
        id,
        amount,
        bank_name,
        account_number,
        depositor_name,
        message,
        status,
        created_at,
        processed_at
      FROM deposit_requests
      WHERE user_id = ?
      ORDER BY created_at DESC
    `).bind(userId).all()

    return c.json({ 
      success: true, 
      requests: results || []
    })
  } catch (err) {
    console.error('Failed to load deposit requests:', err)
    return c.json({ success: false, error: 'ì…ê¸ˆ ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// í¬ì¸íŠ¸ ê±°ë˜ ë‚´ì—­ ì¡°íšŒ API
app.get('/api/point-transactions/:userId', async (c) => {
  try {
    const userId = c.req.param('userId')
    const limit = parseInt(c.req.query('limit') || '50')
    const offset = parseInt(c.req.query('offset') || '0')
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    const { results } = await c.env.DB.prepare(`
      SELECT 
        id,
        transaction_type,
        amount,
        balance_before,
        balance_after,
        description,
        created_at
      FROM point_transactions
      WHERE user_id = ?
      ORDER BY created_at DESC
      LIMIT ? OFFSET ?
    `).bind(userId, limit, offset).all()

    // í†µê³„ ì •ë³´
    const stats = await c.env.DB.prepare(`
      SELECT 
        SUM(CASE WHEN amount > 0 THEN amount ELSE 0 END) as total_charged,
        SUM(CASE WHEN amount < 0 THEN ABS(amount) ELSE 0 END) as total_used,
        COUNT(*) as total_transactions
      FROM point_transactions
      WHERE user_id = ?
    `).bind(userId).first()

    return c.json({ 
      success: true, 
      transactions: results || [],
      stats: {
        totalCharged: stats?.total_charged || 0,
        totalUsed: stats?.total_used || 0,
        totalTransactions: stats?.total_transactions || 0
      }
    })
  } catch (err) {
    console.error('Failed to load point transactions:', err)
    return c.json({ success: false, error: 'ê±°ë˜ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// R2 ì´ë¯¸ì§€ ì—…ë¡œë“œ API (ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì„œë¥˜ìš©)
app.post('/api/upload/document', async (c) => {
  try {
    const { userId, fileName, fileData, fileType } = await c.req.json()
    
    if (!userId || !fileName || !fileData || !fileType) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)
    }

    // Base64 ë°ì´í„°ë¥¼ ArrayBufferë¡œ ë³€í™˜
    const base64Data = fileData.split(',')[1] // "data:image/png;base64," ì œê±°
    const binaryString = atob(base64Data)
    const bytes = new Uint8Array(binaryString.length)
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i)
    }

    // íŒŒì¼ í¬ê¸° ì œí•œ (5MB)
    if (bytes.length > 5 * 1024 * 1024) {
      return c.json({ success: false, error: 'íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.' }, 400)
    }

    // R2ì— ì—…ë¡œë“œ (ê²½ë¡œ: documents/{userId}/{timestamp}-{fileName})
    const timestamp = Date.now()
    const key = `documents/${userId}/${timestamp}-${fileName}`
    
    await c.env.R2.put(key, bytes, {
      httpMetadata: {
        contentType: fileType
      }
    })

    // Public URL ë°˜í™˜ (ìì²´ ë„ë©”ì¸ ì‚¬ìš©)
    const publicUrl = `https://superplace-academy.pages.dev/api/document/${key}`

    return c.json({ 
      success: true, 
      url: publicUrl,
      key: key
    })
  } catch (err) {
    console.error('R2 upload error:', err)
    return c.json({ success: false, error: 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ëœë”©í˜ì´ì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ API (FormData)
app.post('/api/upload/landing-image', async (c) => {
  try {
    const formData = await c.req.formData()
    const image = formData.get('image') as File
    const userId = formData.get('userId') as string
    
    if (!image || !userId) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)
    }

    // ì´ë¯¸ì§€ íŒŒì¼ë§Œ í—ˆìš©
    if (!image.type.startsWith('image/')) {
      return c.json({ success: false, error: 'ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.' }, 400)
    }

    // íŒŒì¼ í¬ê¸° ì œí•œ (5MB)
    if (image.size > 5 * 1024 * 1024) {
      return c.json({ success: false, error: 'íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.' }, 400)
    }

    // íŒŒì¼ì„ ArrayBufferë¡œ ë³€í™˜
    const arrayBuffer = await image.arrayBuffer()
    const bytes = new Uint8Array(arrayBuffer)

    // R2ì— ì—…ë¡œë“œ (ê²½ë¡œ: landing-images/{userId}/{timestamp}-{fileName})
    const timestamp = Date.now()
    const sanitizedFileName = image.name.replace(/[^a-zA-Z0-9.-]/g, '_')
    const key = `landing-images/${userId}/${timestamp}-${sanitizedFileName}`
    
    await c.env.R2.put(key, bytes, {
      httpMetadata: {
        contentType: image.type
      }
    })

    // ê³µê°œ URL ìƒì„± (ì „ì²´ ë„ë©”ì¸ í¬í•¨)
    const publicUrl = `https://superplace-academy.pages.dev/api/image/${key}`

    return c.json({ 
      success: true, 
      url: publicUrl,
      message: 'ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (err) {
    console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', err)
    return c.json({ success: false, error: 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// R2 ì´ë¯¸ì§€ ì¡°íšŒ API (Public Access)
app.get('/api/image/:path{.+}', async (c) => {
  try {
    const path = c.req.param('path')
    
    if (!path) {
      return c.text('File not found', 404)
    }

    const object = await c.env.R2.get(path)
    
    if (!object) {
      return c.text('File not found', 404)
    }

    return new Response(object.body, {
      headers: {
        'Content-Type': object.httpMetadata?.contentType || 'image/jpeg',
        'Cache-Control': 'public, max-age=31536000',
        'Access-Control-Allow-Origin': '*'
      }
    })
  } catch (err) {
    console.error('R2 get error:', err)
    return c.text('Error retrieving file', 500)
  }
})

app.get('/api/document/:path{.+}', async (c) => {
  try {
    const path = c.req.param('path')
    
    if (!path) {
      return c.text('File not found', 404)
    }

    const object = await c.env.R2.get(path)
    
    if (!object) {
      return c.text('File not found', 404)
    }

    return new Response(object.body, {
      headers: {
        'Content-Type': object.httpMetadata?.contentType || 'application/octet-stream',
        'Cache-Control': 'public, max-age=31536000'
      }
    })
  } catch (err) {
    console.error('R2 get error:', err)
    return c.text('Error retrieving file', 500)
  }
})

// ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­ API (ì‚¬ì—…ì ë“±ë¡ì¦ í¬í•¨)
app.post('/api/sms/sender/verification-request', async (c) => {
  try {
    const { 
      userId, phoneNumber, businessName, businessRegistrationNumber, 
      businessRegistrationImage, certificateImage, employmentCertImage, contractImage 
    } = await c.req.json()
    
    console.log('Verification request received:', { userId, phoneNumber, businessName })
    
    if (!userId || !phoneNumber || !businessName || !businessRegistrationNumber || 
        !businessRegistrationImage || !certificateImage || !employmentCertImage || !contractImage) {
      return c.json({ success: false, error: 'ëª¨ë“  í•„ìˆ˜ ì„œë¥˜ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦ (í•˜ì´í”ˆ ì œê±°)
    const cleanNumber = phoneNumber.replace(/-/g, '')
    if (!/^01[0-9]{8,9}$/.test(cleanNumber)) {
      return c.json({ success: false, error: 'ì˜¬ë°”ë¥¸ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    console.log('Checking existing request...')
    
    // ì´ë¯¸ ì‹ ì²­ ì¤‘ì´ê±°ë‚˜ ìŠ¹ì¸ëœ ë²ˆí˜¸ì¸ì§€ í™•ì¸
    const existingRequest = await c.env.DB.prepare(`
      SELECT id, status FROM sender_verification_requests
      WHERE phone_number = ? AND user_id = ? AND status IN ('pending', 'approved')
      ORDER BY request_date DESC
      LIMIT 1
    `).bind(cleanNumber, userId).first()

    if (existingRequest) {
      if (existingRequest.status === 'pending') {
        return c.json({ success: false, error: 'ì´ë¯¸ ì‹ ì²­ ì¤‘ì¸ ë²ˆí˜¸ì…ë‹ˆë‹¤.' }, 400)
      }
      if (existingRequest.status === 'approved') {
        return c.json({ success: false, error: 'ì´ë¯¸ ìŠ¹ì¸ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.' }, 400)
      }
    }

    console.log('Inserting new request...')
    
    // ì‹ ì²­ ì €ì¥ (4ê°œ ì„œë¥˜ í¬í•¨)
    const result = await c.env.DB.prepare(`
      INSERT INTO sender_verification_requests 
      (user_id, phone_number, business_name, business_registration_number, 
       business_registration_image, certificate_image, employment_cert_image, contract_image, status)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'pending')
    `).bind(userId, cleanNumber, businessName, businessRegistrationNumber, 
            businessRegistrationImage, certificateImage, employmentCertImage, contractImage).run()

    console.log('Insert successful, ID:', result.meta.last_row_id)

    return c.json({ 
      success: true, 
      message: 'ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”. (í‰ì¼ ê¸°ì¤€ 2~3ì¼ ì†Œìš”)',
      requestId: result.meta.last_row_id
    })
  } catch (err) {
    console.error('Sender verification request error:', err)
    console.error('Error stack:', err.stack)
    console.error('Error message:', err.message)
    return c.json({ success: false, error: 'ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', details: err.message }, 500)
  }
})

// ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ API (ì‚¬ìš©ì)
app.get('/api/sms/sender/verification-requests', async (c) => {
  try {
    const userId = c.req.query('userId')
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    const requests = await c.env.DB.prepare(`
      SELECT 
        id, phone_number, business_name, business_registration_number, 
        business_registration_image, certificate_image, employment_cert_image, contract_image,
        request_date, status, admin_note, rejection_reason, processed_date
      FROM sender_verification_requests
      WHERE user_id = ?
      ORDER BY request_date DESC
    `).bind(userId).all()

    return c.json({ success: true, requests: requests.results })
  } catch (err) {
    console.error('Get verification requests error:', err)
    return c.json({ success: false, error: 'ì‹ ì²­ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­ ìŠ¹ì¸/ê±°ì ˆ API (ê´€ë¦¬ì)
app.post('/api/sms/sender/verification-process', async (c) => {
  try {
    const { requestId, action, adminNote, adminId } = await c.req.json()
    
    if (!requestId || !action || !adminId) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    if (!['approve', 'reject'].includes(action)) {
      return c.json({ success: false, error: 'ì˜¬ë°”ë¥¸ ì•¡ì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await c.env.DB.prepare(`
      SELECT role FROM users WHERE id = ?
    `).bind(adminId).first()

    if (!admin || admin.role !== 'admin') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    // ì‹ ì²­ ì •ë³´ ì¡°íšŒ
    const request = await c.env.DB.prepare(`
      SELECT * FROM sender_verification_requests WHERE id = ?
    `).bind(requestId).first()

    if (!request) {
      return c.json({ success: false, error: 'ì‹ ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    if (request.status !== 'pending') {
      return c.json({ success: false, error: 'ì´ë¯¸ ì²˜ë¦¬ëœ ì‹ ì²­ì…ë‹ˆë‹¤.' }, 400)
    }

    const newStatus = action === 'approve' ? 'approved' : 'rejected'
    const processedDate = new Date().toISOString()

    // ì‹ ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE sender_verification_requests
      SET status = ?, admin_note = ?, processed_by = ?, processed_date = ?
      WHERE id = ?
    `).bind(newStatus, adminNote || null, adminId, processedDate, requestId).run()

    // ìŠ¹ì¸ëœ ê²½ìš° sender_ids í…Œì´ë¸”ì— ì¶”ê°€ & Aligo API ë“±ë¡
    if (action === 'approve') {
      // 1. DBì— ë°œì‹ ë²ˆí˜¸ ì €ì¥
      await c.env.DB.prepare(`
        INSERT INTO sender_ids 
        (user_id, phone_number, verification_method, status, verification_request_id, business_name, business_registration_number)
        VALUES (?, ?, 'business_registration', 'verified', ?, ?, ?)
      `).bind(
        request.user_id, 
        request.phone_number, 
        requestId, 
        request.business_name, 
        request.business_registration_number
      ).run()

      // 2. Aligo APIë¡œ ë°œì‹ ë²ˆí˜¸ ë“±ë¡
      try {
        const aligoUserId = c.env.ALIGO_USER_ID || ''
        const aligoApiKey = c.env.ALIGO_API_KEY || ''
        
        if (!aligoUserId || !aligoApiKey) {
          console.warn('Aligo API credentials not configured')
        } else {
          const aligoResponse = await fetch('https://apis.aligo.in/sender/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
              user_id: aligoUserId,
              key: aligoApiKey,
              sender: request.phone_number.replace(/-/g, ''),
              comment: `${request.business_name} - ìŠ¹ì¸ì¼: ${new Date().toLocaleDateString('ko-KR')}`
            })
          })

          const aligoData = await aligoResponse.json()
          console.log('Aligo API response:', aligoData)

          if (aligoData.result_code !== '1') {
            console.error('Aligo sender registration failed:', aligoData)
            // ì‹¤íŒ¨í•´ë„ ì‹ ì²­ì€ ìŠ¹ì¸ ìƒíƒœ ìœ ì§€ (ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥)
          }
        }
      } catch (aligoErr) {
        console.error('Aligo API error:', aligoErr)
        // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì‹ ì²­ì€ ìŠ¹ì¸ ìƒíƒœ ìœ ì§€
      }
    }

    return c.json({ 
      success: true, 
      message: action === 'approve' ? 'ë°œì‹ ë²ˆí˜¸ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë°œì‹ ë²ˆí˜¸ ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (err) {
    console.error('Process verification error:', err)
    return c.json({ success: false, error: 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ììš© ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­ ì „ì²´ ëª©ë¡ ì¡°íšŒ API
app.get('/api/admin/sender/verification-requests', async (c) => {
  try {
    const adminId = c.req.query('adminId')
    
    if (!adminId) {
      return c.json({ success: false, error: 'ê´€ë¦¬ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await c.env.DB.prepare(`
      SELECT role FROM users WHERE id = ?
    `).bind(adminId).first()

    if (!admin || admin.role !== 'admin') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    const requests = await c.env.DB.prepare(`
      SELECT 
        svr.id, svr.user_id, svr.phone_number, svr.business_name, 
        svr.business_registration_number, svr.business_registration_image,
        svr.certificate_image, svr.employment_cert_image, svr.contract_image,
        svr.request_date, svr.status, svr.admin_note, svr.rejection_reason, svr.processed_date,
        u.name as user_name, u.email as user_email
      FROM sender_verification_requests svr
      LEFT JOIN users u ON svr.user_id = u.id
      ORDER BY 
        CASE svr.status 
          WHEN 'pending' THEN 1 
          WHEN 'approved' THEN 2 
          WHEN 'rejected' THEN 3 
        END,
        svr.request_date DESC
    `).all()

    return c.json({ success: true, requests: requests.results })
  } catch (err) {
    console.error('Get admin verification requests error:', err)
    return c.json({ success: false, error: 'ì‹ ì²­ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì„œë¥˜ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ API
app.get('/api/downloads/consent-form', async (c) => {
  // ë°œì‹ ë²ˆí˜¸ ì‚¬ì „ë“±ë¡ ëŒ€ë¦¬ ì‹ ì²­ì„œ (ì‚¬ìš©ì ì—…ë¡œë“œ íŒŒì¼)
  const docxUrl = 'https://www.genspark.ai/api/files/s/lIFq9l1L'
  const response = await fetch(docxUrl)
  const blob = await response.arrayBuffer()
  
  return new Response(blob, {
    headers: {
      'Content-Type': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'Content-Disposition': 'attachment; filename="ë°œì‹ ë²ˆí˜¸_ì‚¬ì „ë“±ë¡_ëŒ€ë¦¬_ì‹ ì²­ì„œ.docx"'
    }
  })
})

app.get('/api/downloads/contract', async (c) => {
  // ë¬¸ìë©”ì‹œì§€ ì´ìš©ê³„ì•½ì„œ (ì‚¬ìš©ì ì—…ë¡œë“œ íŒŒì¼)
  const docxUrl = 'https://www.genspark.ai/api/files/s/aKg3VCJT'
  const response = await fetch(docxUrl)
  const blob = await response.arrayBuffer()
  
  return new Response(blob, {
    headers: {
      'Content-Type': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'Content-Disposition': 'attachment; filename="ë¬¸ìë©”ì‹œì§€_ì´ìš©ê³„ì•½ì„œ.docx"'
    }
  })
})

app.get('/api/downloads/employment-cert', async (c) => {
  // ì¬ì§ì¦ëª…ì„œ ì–‘ì‹ (ê°„ë‹¨í•œ HTML í…œí”Œë¦¿)
  return c.html(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>ì¬ì§ì¦ëª…ì„œ</title>
      <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 60px; }
        h1 { text-align: center; font-size: 32px; margin-bottom: 40px; }
        table { width: 100%; border-collapse: collapse; margin: 30px 0; }
        th, td { border: 1px solid #000; padding: 12px; text-align: left; }
        th { background-color: #f0f0f0; font-weight: bold; }
        .info { margin: 30px 0; line-height: 2; }
        .signature { text-align: right; margin-top: 60px; }
      </style>
    </head>
    <body>
      <h1>ì¬ ì§ ì¦ ëª… ì„œ</h1>
      
      <div class="info">
        <table>
          <tr>
            <th width="30%">ì„±ëª… (í•œê¸€)</th>
            <td></td>
            <th width="30%">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸</th>
            <td></td>
          </tr>
          <tr>
            <th>ì£¼ì†Œ</th>
            <td colspan="3"></td>
          </tr>
        </table>
        
        <table>
          <tr>
            <th width="30%">ê·¼ë¬´ë¶€ì„œ</th>
            <td></td>
            <th width="30%">ì§ìœ„</th>
            <td></td>
          </tr>
          <tr>
            <th>ì¬ì§ê¸°ê°„</th>
            <td colspan="3">20   ë…„   ì›”   ì¼ ë¶€í„° 20   ë…„   ì›”   ì¼ í˜„ì¬ê¹Œì§€</td>
          </tr>
          <tr>
            <th>ì œì¶œìš©ë„</th>
            <td colspan="3"></td>
          </tr>
        </table>
      </div>
      
      <p style="text-align: center; margin: 40px 0;">
        ìœ„ì˜ ê¸°ì¬ì‚¬í•­ì´ ì‚¬ì‹¤ê³¼ ë‹¤ë¦„ì—†ìŒì„ ì¦ëª…í•©ë‹ˆë‹¤.
      </p>
      
      <div class="signature">
        <p>ë…„ &nbsp;&nbsp;&nbsp; ì›” &nbsp;&nbsp;&nbsp; ì¼</p>
        <br><br>
        <p>íšŒ ì‚¬ ëª…: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (ì¸)</p>
        <p>ëŒ€ í‘œ ì: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (ì¸)</p>
        <p>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸:</p>
        <p>ì£¼ ì†Œ:</p>
        <p>ì „ í™”:</p>
      </div>
    </body>
    </html>
  `)
})

// ë‚´ ì…ê¸ˆ ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ API
app.get('/api/deposit/my-requests/:userId', async (c) => {
  try {
    const userId = c.req.param('userId')
    
    const requests = await c.env.DB.prepare(`
      SELECT * FROM deposit_requests WHERE user_id = ? ORDER BY created_at DESC
    `).bind(userId).all()

    return c.json({ success: true, requests: requests.results })
  } catch (err) {
    console.error('Get deposit requests error:', err)
    return c.json({ success: false, error: 'ì…ê¸ˆ ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ì…ê¸ˆ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ API
app.get('/api/admin/deposit/requests', async (c) => {
  try {
    const requests = await c.env.DB.prepare(`
      SELECT * FROM deposit_requests ORDER BY created_at DESC
    `).all()

    return c.json({ success: true, requests: requests.results })
  } catch (err) {
    console.error('Get all deposit requests error:', err)
    return c.json({ success: false, error: 'ì…ê¸ˆ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ì…ê¸ˆ ì‹ ì²­ ì²˜ë¦¬ API
app.put('/api/admin/deposit/requests/:id/process', async (c) => {
  try {
    const requestId = c.req.param('id')
    const { status, adminId } = await c.req.json()

    console.log('Processing deposit:', { requestId, status, adminId })

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    if (adminId) {
      const admin = await c.env.DB.prepare(`
        SELECT role FROM users WHERE id = ?
      `).bind(adminId).first()

      if (!admin || admin.role !== 'admin') {
        return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
      }
    }

    // ì…ê¸ˆ ì‹ ì²­ ì •ë³´ ì¡°íšŒ
    const request = await c.env.DB.prepare(`
      SELECT * FROM deposit_requests WHERE id = ?
    `).bind(requestId).first()

    console.log('Found request:', request)

    if (!request) {
      return c.json({ success: false, error: 'ì…ê¸ˆ ì‹ ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    if (request.status !== 'pending') {
      return c.json({ success: false, error: 'ì´ë¯¸ ì²˜ë¦¬ëœ ì‹ ì²­ì…ë‹ˆë‹¤.' }, 400)
    }

    let balanceAfter = 0

    // ìŠ¹ì¸ì¸ ê²½ìš° í¬ì¸íŠ¸ ì§€ê¸‰
    if (status === 'approved') {
      const points = request.amount
      console.log('Approving deposit for user:', request.user_id, 'adding:', points)
      
      // í˜„ì¬ ì”ì•¡ ì¡°íšŒ (balance í•„ë“œë§Œ ì‚¬ìš©)
      const user = await c.env.DB.prepare(`
        SELECT balance FROM users WHERE id = ?
      `).bind(request.user_id).first()

      const balanceBefore = user?.balance || 0
      balanceAfter = balanceBefore + points

      // í¬ì¸íŠ¸ ì¶©ì „ (balance í•„ë“œ ì—…ë°ì´íŠ¸)
      await c.env.DB.prepare(`
        UPDATE users SET balance = ?, points = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
      `).bind(balanceAfter, balanceAfter, request.user_id).run()
      
      console.log('Points/Balance updated:', balanceBefore, '->', balanceAfter)

      // í¬ì¸íŠ¸ ê±°ë˜ ë‚´ì—­ ê¸°ë¡
      await c.env.DB.prepare(`
        INSERT INTO point_transactions (user_id, transaction_type, amount, balance_before, balance_after, description, admin_id)
        VALUES (?, 'deposit_approval', ?, ?, ?, ?, ?)
      `).bind(
        request.user_id, 
        points, 
        balanceBefore, 
        balanceAfter, 
        `ì…ê¸ˆ ì‹ ì²­ ìŠ¹ì¸ (ì‹ ì²­ ID: ${requestId})`,
        adminId || null
      ).run()

      // ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ (Resend API)
      if (request.user_email) {
        try {
          const resendApiKey = c.env.RESEND_API_KEY
          
          if (resendApiKey) {
            const emailResponse = await fetch('https://api.resend.com/emails', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${resendApiKey}`
              },
              body: JSON.stringify({
                from: 'ìŠˆí¼í”Œë ˆì´ìŠ¤ <noreply@superplace.co.kr>',
                to: request.user_email,
                subject: 'âœ… í¬ì¸íŠ¸ ì¶©ì „ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
                html: `
                  <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="background: linear-gradient(135deg, #9333ea 0%, #7e22ce 100%); padding: 30px; border-radius: 10px 10px 0 0; text-align: center;">
                      <h1 style="color: white; margin: 0; font-size: 24px;">ğŸ’° í¬ì¸íŠ¸ ì¶©ì „ ì™„ë£Œ</h1>
                    </div>
                    
                    <div style="background: white; padding: 30px; border: 1px solid #e5e7eb; border-top: none; border-radius: 0 0 10px 10px;">
                      <p style="font-size: 16px; color: #374151; margin-bottom: 20px;">
                        ì•ˆë…•í•˜ì„¸ìš”, <strong>${request.user_name || 'íšŒì›'}</strong>ë‹˜!
                      </p>
                      
                      <p style="font-size: 16px; color: #374151; margin-bottom: 30px;">
                        ì…ê¸ˆ ì‹ ì²­í•˜ì‹  í¬ì¸íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‰
                      </p>
                      
                      <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                          <span style="color: #6b7280;">ì¶©ì „ ê¸ˆì•¡</span>
                          <strong style="color: #9333ea; font-size: 20px;">${points.toLocaleString()}P</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                          <span style="color: #6b7280;">í˜„ì¬ ì”ì•¡</span>
                          <strong style="color: #1f2937; font-size: 18px;">${balanceAfter.toLocaleString()}P</strong>
                        </div>
                      </div>
                      
                      <div style="background: #eff6ff; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 30px;">
                        <p style="margin: 0; color: #1e40af; font-size: 14px;">
                          ğŸ’¡ <strong>SMS ë°œì†¡ ê°€ëŠ¥ ê±´ìˆ˜</strong><br>
                          â€¢ SMS (90ì): ì•½ ${Math.floor(balanceAfter / 20).toLocaleString()}ê±´<br>
                          â€¢ LMS (2000ì): ì•½ ${Math.floor(balanceAfter / 50).toLocaleString()}ê±´<br>
                          â€¢ MMS (ì‚¬ì§„ í¬í•¨): ì•½ ${Math.floor(balanceAfter / 150).toLocaleString()}ê±´
                        </p>
                      </div>
                      
                      <div style="text-align: center;">
                        <a href="https://superplace-academy.pages.dev/sms/compose" 
                           style="display: inline-block; background: #9333ea; color: white; padding: 14px 30px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
                          ì§€ê¸ˆ ë¬¸ì ë³´ë‚´ê¸° ğŸ“¤
                        </a>
                      </div>
                      
                      <p style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px; text-align: center;">
                        ë¬¸ì˜ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ì—°ë½ì£¼ì„¸ìš”.<br>
                        ê°ì‚¬í•©ë‹ˆë‹¤!
                      </p>
                    </div>
                  </div>
                `
              })
            })

            if (emailResponse.ok) {
              console.log('Email notification sent successfully')
            } else {
              console.error('Failed to send email notification:', await emailResponse.text())
            }
          }
        } catch (emailError) {
          console.error('Email sending error:', emailError)
          // ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨í•´ë„ ìŠ¹ì¸ ì²˜ë¦¬ëŠ” ê³„ì† ì§„í–‰
        }
      }
    }

    // ì…ê¸ˆ ì‹ ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE deposit_requests SET status = ?, processed_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(status, requestId).run()

    return c.json({ 
      success: true, 
      message: status === 'approved' ? 'ì…ê¸ˆì´ ìŠ¹ì¸ë˜ê³  í¬ì¸íŠ¸ê°€ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì…ê¸ˆ ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (err) {
    console.error('Process deposit request error:', err)
    return c.json({ success: false, error: 'ì…ê¸ˆ ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', details: error.message }, 500)
  }
})

// ê´€ë¦¬ì: ì‚¬ìš©ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
app.put('/api/admin/users/:id/password', async (c) => {
  try {
    const userId = c.req.param('id')
    const { newPassword } = await c.req.json()

    if (!newPassword || newPassword.length < 6) {
      return c.json({ success: false, error: 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.' }, 400)
    }

    await c.env.DB.prepare(`
      UPDATE users SET password = ? WHERE id = ?
    `).bind(newPassword, userId).run()

    return c.json({ success: true, message: 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Change password error:', err)
    return c.json({ success: false, error: 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ì‚¬ìš©ì í¬ì¸íŠ¸ ì¶”ê°€/ì°¨ê°
app.put('/api/admin/users/:id/points', async (c) => {
  try {
    const userId = c.req.param('id')
    const { points, action } = await c.req.json() // action: 'add' or 'subtract'

    if (!points || points <= 0) {
      return c.json({ success: false, error: 'ìœ íš¨í•œ í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // í˜„ì¬ í¬ì¸íŠ¸ ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT points FROM users WHERE id = ?
    `).bind(userId).first()

    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    let newPoints = (user.points || 0)
    if (action === 'add') {
      newPoints += points
    } else if (action === 'subtract') {
      newPoints = Math.max(0, newPoints - points) // 0 ë¯¸ë§Œìœ¼ë¡œ ë–¨ì–´ì§€ì§€ ì•ŠìŒ
    }

    await c.env.DB.prepare(`
      UPDATE users SET points = ? WHERE id = ?
    `).bind(newPoints, userId).run()

    return c.json({ success: true, message: 'í¬ì¸íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', newPoints })
  } catch (err) {
    console.error('Update points error:', err)
    return c.json({ success: false, error: 'í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ì‚¬ìš©ì ì•„ì´ë””ë¡œ ë¡œê·¸ì¸
app.post('/api/admin/login-as/:id', async (c) => {
  try {
    const userId = c.req.param('id')

    const user = await c.env.DB.prepare(`
      SELECT id, email, name, role, points FROM users WHERE id = ?
    `).bind(userId).first()

    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    return c.json({ 
      success: true, 
      message: 'ë¡œê·¸ì¸ ì„±ê³µ',
      user: { id: user.id, email: user.email, name: user.name, role: user.role, points: user.points }
    })
  } catch (err) {
    console.error('Login as user error:', err)
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ë¬¸ì˜ ëª©ë¡ ì¡°íšŒ API (ê´€ë¦¬ììš©)
app.get('/api/contacts', async (c) => {
  try {
    const { results } = await c.env.DB.prepare(`
      SELECT * FROM contacts ORDER BY created_at DESC LIMIT 50
    `).all()

    return c.json({ success: true, contacts: results })
  } catch (err) {
    console.error('Fetch contacts error:', err)
    return c.json({ success: false, error: 'ë¬¸ì˜ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ë¬¸ì˜ ìƒíƒœ ë³€ê²½ ë° ë‹µë³€ ë©”ëª¨ ì—…ë°ì´íŠ¸
app.put('/api/admin/contacts/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const { status, reply_memo, handled_by } = await c.req.json()
    
    let query = 'UPDATE contacts SET '
    const updates = []
    const bindings = []
    
    if (status) {
      updates.push('status = ?')
      bindings.push(status)
    }
    if (reply_memo !== undefined) {
      updates.push('reply_memo = ?')
      bindings.push(reply_memo)
    }
    if (handled_by) {
      updates.push('handled_by = ?, handled_at = CURRENT_TIMESTAMP')
      bindings.push(handled_by)
    }
    
    query += updates.join(', ') + ' WHERE id = ?'
    bindings.push(id)
    
    await c.env.DB.prepare(query).bind(...bindings).run()
    
    return c.json({ success: true, message: 'ë¬¸ì˜ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Update contact error:', err)
    return c.json({ success: false, error: 'ë¬¸ì˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨' }, 500)
  }
})

// ==================== ê´€ë¦¬ì API ====================

// ê´€ë¦¬ì - ë°˜ ì†Œìœ ê¶Œ ìˆ˜ì • (ë§ˆì´ê·¸ë ˆì´ì…˜)
app.post('/api/admin/fix-class-ownership', async (c) => {
  try {
    const { email, targetUserId } = await c.req.json()
    
    if (!email && !targetUserId) {
      return c.json({ success: false, error: 'ì´ë©”ì¼ ë˜ëŠ” ëŒ€ìƒ ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    console.log('ğŸ”§ [FixClassOwnership] Request:', { email, targetUserId })
    
    // ì´ë©”ì¼ë¡œ ì‚¬ìš©ì ì°¾ê¸°
    let userId = targetUserId
    if (email && !userId) {
      const user = await c.env.DB.prepare('SELECT id FROM users WHERE email = ?').bind(email).first()
      if (!user) {
        return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
      }
      userId = user.id
    }
    
    console.log('ğŸ‘¤ [FixClassOwnership] Target user_id:', userId)
    
    // í•´ë‹¹ ì‚¬ìš©ìì˜ ë°˜ ì°¾ê¸° (teacher_idë¡œ)
    const classesAsTeacher = await c.env.DB.prepare(
      'SELECT id, name, user_id, teacher_id FROM classes WHERE teacher_id = ?'
    ).bind(userId).all()
    
    console.log('ğŸ“š [FixClassOwnership] Found', classesAsTeacher.results?.length || 0, 'classes as teacher')
    
    if (!classesAsTeacher.results || classesAsTeacher.results.length === 0) {
      return c.json({ 
        success: true, 
        message: 'ìˆ˜ì •í•  ë°˜ì´ ì—†ìŠµë‹ˆë‹¤.',
        updated: 0
      })
    }
    
    // user_idë¥¼ teacher_idì™€ ê°™ê²Œ ìˆ˜ì •
    let updated = 0
    for (const cls of classesAsTeacher.results) {
      if (cls.user_id !== cls.teacher_id) {
        await c.env.DB.prepare(
          'UPDATE classes SET user_id = ? WHERE id = ?'
        ).bind(cls.teacher_id, cls.id).run()
        updated++
        console.log(`âœ… [FixClassOwnership] Updated class ${cls.id} (${cls.name}): user_id ${cls.user_id} â†’ ${cls.teacher_id}`)
      }
    }
    
    return c.json({ 
      success: true, 
      message: `${updated}ê°œì˜ ë°˜ ì†Œìœ ê¶Œì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      updated,
      details: classesAsTeacher.results.map(c => ({
        id: c.id,
        name: c.name,
        old_user_id: c.user_id,
        new_user_id: c.teacher_id
      }))
    })
  } catch (error) {
    console.error('âŒ [FixClassOwnership] Error:', error)
    return c.json({ success: false, error: 'ë°˜ ì†Œìœ ê¶Œ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì - ë°˜ ì†Œìœ ê¶Œ ì´ì „ (ê´€ë¦¬ì â†’ íŠ¹ì • ì‚¬ìš©ì)
// ê´€ë¦¬ì - ëª¨ë“  ë°˜ ì¡°íšŒ (ë””ë²„ê·¸ìš©)
app.get('/api/admin/classes/all', async (c) => {
  try {
    console.log('ğŸ” [AdminClasses] Fetching ALL classes from database')
    
    // ë¨¼ì € classes í…Œì´ë¸”ì˜ ìŠ¤í‚¤ë§ˆ í™•ì¸
    let schemaInfo
    try {
      schemaInfo = await c.env.DB.prepare(`
        PRAGMA table_info(classes)
      `).all()
      console.log('ğŸ“‹ [AdminClasses] Table schema:', JSON.stringify(schemaInfo.results))
    } catch (schemaError) {
      console.error('âš ï¸ [AdminClasses] Schema check failed:', schemaError.message)
    }
    
    // academy_id ë˜ëŠ” user_id ì»¬ëŸ¼ í™•ì¸
    const hasUserId = schemaInfo?.results?.some(col => col.name === 'user_id')
    const hasAcademyId = schemaInfo?.results?.some(col => col.name === 'academy_id')
    const ownerColumn = hasUserId ? 'user_id' : (hasAcademyId ? 'academy_id' : null)
    
    console.log('ğŸ” [AdminClasses] Owner column:', ownerColumn)
    
    if (!ownerColumn) {
      // ì†Œìœ ì ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ë‹¨ìˆœ ì¡°íšŒ
      const classes = await c.env.DB.prepare(`SELECT * FROM classes ORDER BY created_at DESC`).all()
      return c.json({ 
        success: true, 
        classes: classes.results || [],
        total: classes.results?.length || 0,
        note: 'ì†Œìœ ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. classes í…Œì´ë¸”ì— user_id ë˜ëŠ” academy_id ì»¬ëŸ¼ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      })
    }
    
    // ì†Œìœ ì ì •ë³´ì™€ í•¨ê»˜ ì¡°íšŒ
    const classes = await c.env.DB.prepare(`
      SELECT c.*, 
             u.email as owner_email, 
             u.name as owner_name,
             t.email as teacher_email,
             t.name as teacher_name
      FROM classes c
      LEFT JOIN users u ON c.${ownerColumn} = u.id
      LEFT JOIN users t ON c.teacher_id = t.id
      ORDER BY c.created_at DESC
    `).all()
    
    console.log('ğŸ“š [AdminClasses] Found', classes.results?.length || 0, 'total classes')
    
    return c.json({ 
      success: true, 
      classes: classes.results || [],
      total: classes.results?.length || 0,
      ownerColumn
    })
  } catch (error) {
    console.error('âŒ [AdminClasses] Error:', error)
    return c.json({ 
      success: false, 
      error: 'ë°˜ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      details: error.message 
    }, 500)
  }
})

// ê´€ë¦¬ì - íŠ¹ì • ì‚¬ìš©ìì—ê²Œ ë°˜ ì§ì ‘ ìƒì„± (ê´€ë¦¬ì ì „ìš©)
app.post('/api/admin/classes/create-for-user', async (c) => {
  try {
    const { targetEmail, className, gradeLevel, subject, description } = await c.req.json()
    
    if (!targetEmail || !className) {
      return c.json({ success: false, error: 'targetEmailê³¼ classNameì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    console.log('ğŸ« [AdminCreateClass] Creating class for user:', targetEmail)
    
    // ëŒ€ìƒ ì‚¬ìš©ì ì°¾ê¸°
    const targetUser = await c.env.DB.prepare(
      'SELECT id, email, name FROM users WHERE email = ?'
    ).bind(targetEmail).first()
    
    if (!targetUser) {
      return c.json({ success: false, error: 'ëŒ€ìƒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    console.log('ğŸ‘¤ [AdminCreateClass] Target user:', targetUser)
    
    // í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í™•ì¸
    const schemaInfo = await c.env.DB.prepare(`PRAGMA table_info(classes)`).all()
    const hasUserId = schemaInfo.results?.some(col => col.name === 'user_id')
    const hasAcademyId = schemaInfo.results?.some(col => col.name === 'academy_id')
    const ownerColumn = hasUserId ? 'user_id' : (hasAcademyId ? 'academy_id' : 'user_id')
    
    console.log('ğŸ” [AdminCreateClass] Using owner column:', ownerColumn)
    
    // ë°˜ ìƒì„± (ë™ì  ì»¬ëŸ¼ëª… ì‚¬ìš©)
    const result = await c.env.DB.prepare(`
      INSERT INTO classes (name, description, ${ownerColumn}, grade_level, subject, max_students, status, created_at)
      VALUES (?, ?, ?, ?, ?, 20, 'active', datetime('now'))
    `).bind(
      className,
      description || null,
      targetUser.id,
      gradeLevel || null,
      subject || null
    ).run()
    
    const classId = result.meta.last_row_id
    
    console.log('âœ… [AdminCreateClass] Class created:', { classId, name: className, owner: targetUser.email })
    
    return c.json({
      success: true,
      message: `${targetUser.email}ì—ê²Œ ë°˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      classId,
      class: {
        id: classId,
        name: className,
        owner_id: targetUser.id,
        owner_email: targetUser.email,
        owner_name: targetUser.name
      }
    })
  } catch (error) {
    console.error('âŒ [AdminCreateClass] Error:', error)
    return c.json({ 
      success: false, 
      error: 'ë°˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      details: error.message 
    }, 500)
  }
})

app.post('/api/admin/transfer-classes', async (c) => {
  try {
    const { fromUserId, toEmail } = await c.req.json()
    
    if (!fromUserId || !toEmail) {
      return c.json({ success: false, error: 'fromUserIdì™€ toEmailì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    console.log('ğŸ”„ [TransferClasses] Transfer request:', { fromUserId, toEmail })
    
    // ëŒ€ìƒ ì‚¬ìš©ì ì°¾ê¸°
    const toUser = await c.env.DB.prepare('SELECT id, email, name FROM users WHERE email = ?').bind(toEmail).first()
    if (!toUser) {
      return c.json({ success: false, error: 'ëŒ€ìƒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    console.log('ğŸ‘¤ [TransferClasses] Target user:', toUser)
    
    // í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í™•ì¸
    const schemaInfo = await c.env.DB.prepare(`PRAGMA table_info(classes)`).all()
    const hasUserId = schemaInfo.results?.some(col => col.name === 'user_id')
    const hasAcademyId = schemaInfo.results?.some(col => col.name === 'academy_id')
    const ownerColumn = hasUserId ? 'user_id' : (hasAcademyId ? 'academy_id' : 'user_id')
    
    console.log('ğŸ” [TransferClasses] Using owner column:', ownerColumn)
    
    // ì›ë³¸ ì‚¬ìš©ìì˜ ë°˜ ì°¾ê¸°
    const classes = await c.env.DB.prepare(
      `SELECT id, name, ${ownerColumn} as owner_id, teacher_id FROM classes WHERE ${ownerColumn} = ?`
    ).bind(fromUserId).all()
    
    console.log('ğŸ“š [TransferClasses] Found', classes.results?.length || 0, 'classes to transfer')
    
    if (!classes.results || classes.results.length === 0) {
      return c.json({ 
        success: true, 
        message: 'ì´ì „í•  ë°˜ì´ ì—†ìŠµë‹ˆë‹¤.',
        transferred: 0
      })
    }
    
    // owner_idë¥¼ ëŒ€ìƒ ì‚¬ìš©ìë¡œ ë³€ê²½
    let transferred = 0
    const details = []
    
    for (const cls of classes.results) {
      await c.env.DB.prepare(
        `UPDATE classes SET ${ownerColumn} = ? WHERE id = ?`
      ).bind(toUser.id, cls.id).run()
      
      transferred++
      details.push({
        id: cls.id,
        name: cls.name,
        from_user_id: cls.owner_id,
        to_user_id: toUser.id,
        to_email: toUser.email
      })
      
      console.log(`âœ… [TransferClasses] Transferred class ${cls.id} (${cls.name}): ${ownerColumn} ${cls.owner_id} â†’ ${toUser.id}`)
    }
    
    return c.json({ 
      success: true, 
      message: `${transferred}ê°œì˜ ë°˜ì´ ${toUser.email}ë¡œ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      transferred,
      target_user: {
        id: toUser.id,
        email: toUser.email,
        name: toUser.name
      },
      details
    })
  } catch (error) {
    console.error('âŒ [TransferClasses] Error:', error)
    return c.json({ success: false, error: 'ë°˜ ì´ì „ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', details: error.message }, 500)
  }
})

// ê´€ë¦¬ì - ëª¨ë“  ë°˜ì„ íŠ¹ì • ì‚¬ìš©ìë¡œ ì´ì „ (ê¸´ê¸‰ ìˆ˜ì •ìš©)
app.post('/api/admin/transfer-all-classes-to-user', async (c) => {
  try {
    const { toEmail } = await c.req.json()
    
    if (!toEmail) {
      return c.json({ success: false, error: 'toEmailì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    console.log('ğŸš¨ [EmergencyTransfer] Transferring ALL classes to:', toEmail)
    
    // ëŒ€ìƒ ì‚¬ìš©ì ì°¾ê¸°
    const toUser = await c.env.DB.prepare('SELECT id, email, name FROM users WHERE email = ?').bind(toEmail).first()
    if (!toUser) {
      return c.json({ success: false, error: 'ëŒ€ìƒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    console.log('ğŸ‘¤ [EmergencyTransfer] Target user:', toUser)
    
    // ëª¨ë“  ë°˜ ì¡°íšŒ
    let allClasses
    try {
      allClasses = await c.env.DB.prepare('SELECT * FROM classes ORDER BY id').all()
    } catch (e) {
      return c.json({ success: false, error: 'classes í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e.message }, 500)
    }
    
    console.log('ğŸ“š [EmergencyTransfer] Found', allClasses.results?.length || 0, 'total classes')
    
    if (!allClasses.results || allClasses.results.length === 0) {
      return c.json({ 
        success: true, 
        message: 'ì´ì „í•  ë°˜ì´ ì—†ìŠµë‹ˆë‹¤.',
        transferred: 0
      })
    }
    
    // academy_id ë˜ëŠ” user_id ì»¬ëŸ¼ í™•ì¸
    const firstClass = allClasses.results[0]
    const hasAcademyId = 'academy_id' in firstClass
    const hasUserId = 'user_id' in firstClass
    const ownerColumn = hasUserId ? 'user_id' : (hasAcademyId ? 'academy_id' : null)
    
    console.log('ğŸ” [EmergencyTransfer] Owner column:', ownerColumn)
    
    if (!ownerColumn) {
      return c.json({ success: false, error: 'ì†Œìœ ì ì»¬ëŸ¼(academy_id ë˜ëŠ” user_id)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 500)
    }
    
    // ëª¨ë“  ë°˜ì„ ëŒ€ìƒ ì‚¬ìš©ìë¡œ ë³€ê²½
    let transferred = 0
    const details = []
    
    for (const cls of allClasses.results) {
      try {
        await c.env.DB.prepare(
          `UPDATE classes SET ${ownerColumn} = ? WHERE id = ?`
        ).bind(toUser.id, cls.id).run()
        
        transferred++
        details.push({
          id: cls.id,
          name: cls.class_name || cls.name,
          from_owner_id: cls[ownerColumn],
          to_owner_id: toUser.id
        })
        
        console.log(`âœ… [EmergencyTransfer] Transferred class ${cls.id} (${cls.class_name || cls.name}): ${ownerColumn} ${cls[ownerColumn]} â†’ ${toUser.id}`)
      } catch (e) {
        console.error(`âŒ [EmergencyTransfer] Failed to transfer class ${cls.id}:`, e.message)
      }
    }
    
    return c.json({ 
      success: true, 
      message: `${transferred}ê°œì˜ ë°˜ì´ ${toUser.email}ë¡œ ì´ì „ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      transferred,
      total: allClasses.results.length,
      target_user: {
        id: toUser.id,
        email: toUser.email,
        name: toUser.name
      },
      details: details.slice(0, 10)  // ì²˜ìŒ 10ê°œë§Œ ë°˜í™˜
    })
  } catch (error) {
    console.error('âŒ [EmergencyTransfer] Error:', error)
    return c.json({ success: false, error: 'ë°˜ ì´ì „ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message }, 500)
  }
})

// ê´€ë¦¬ì - ì‚¬ìš©ì ëª©ë¡
app.get('/api/admin/users', async (c) => {
  try {
    const { results } = await c.env.DB.prepare('SELECT id, email, name, phone, academy_name, role, created_at FROM users ORDER BY created_at DESC').all()
    return c.json({ success: true, users: results })
  } catch (err) {
    return c.json({ success: false, error: 'ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ê´€ë¦¬ì - ì‚¬ìš©ì ì‚­ì œ
app.delete('/api/admin/users/:id', async (c) => {
  try {
    const userId = c.req.param('id')
    console.log('ğŸ—‘ï¸ Delete user request:', userId)
    
    // ê´€ë¦¬ìëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŒ
    const user = await c.env.DB.prepare('SELECT role FROM users WHERE id = ?').bind(userId).first()
    if (!user) {
      console.error('âŒ User not found:', userId)
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    if (user.role === 'admin') {
      console.error('âŒ Cannot delete admin:', userId)
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 403)
    }
    
    console.log('âœ… User found, starting deletion:', userId)
    
    // ê´€ë ¨ ë°ì´í„° ì‚­ì œ (ì™¸ë˜ í‚¤ ì œì•½ ì¡°ê±´ ê³ ë ¤) - í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•Šì•„ë„ ì—ëŸ¬ ë¬´ì‹œ
    try { await c.env.DB.prepare('DELETE FROM user_permissions WHERE user_id = ?').bind(userId).run() } catch (e) { console.log('Skip user_permissions:', e.message) }
    try { await c.env.DB.prepare('DELETE FROM user_programs WHERE user_id = ?').bind(userId).run() } catch (e) { console.log('Skip user_programs:', e.message) }
    try { await c.env.DB.prepare('DELETE FROM sender_ids WHERE user_id = ?').bind(userId).run() } catch (e) { console.log('Skip sender_ids:', e.message) }
    try { await c.env.DB.prepare('DELETE FROM sender_verification_requests WHERE user_id = ?').bind(userId).run() } catch (e) { console.log('Skip sender_verification_requests:', e.message) }
    try { await c.env.DB.prepare('DELETE FROM sms_logs WHERE user_id = ?').bind(userId).run() } catch (e) { console.log('Skip sms_logs:', e.message) }
    try { await c.env.DB.prepare('DELETE FROM landing_pages WHERE user_id = ?').bind(userId).run() } catch (e) { console.log('Skip landing_pages:', e.message) }
    try { await c.env.DB.prepare('DELETE FROM students WHERE user_id = ?').bind(userId).run() } catch (e) { console.log('Skip students:', e.message) }
    try { await c.env.DB.prepare('DELETE FROM deposit_requests WHERE user_id = ?').bind(userId).run() } catch (e) { console.log('Skip deposit_requests:', e.message) }
    
    console.log('âœ… Related data deleted, deleting user:', userId)
    
    // ì‚¬ìš©ì ì‚­ì œ
    const deleteResult = await c.env.DB.prepare('DELETE FROM users WHERE id = ?').bind(userId).run()
    console.log('âœ… User deleted successfully:', userId, deleteResult)
    
    return c.json({ success: true, message: 'ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('âŒ Delete user error:', err)
    console.error('Error details:', err.message, err.stack)
    return c.json({ success: false, error: 'ì‚¬ìš©ì ì‚­ì œ ì‹¤íŒ¨: ' + err.message }, 500)
  }
})

// ê´€ë¦¬ì - í”„ë¡œê·¸ë¨ ëª©ë¡
app.get('/api/admin/programs', async (c) => {
  try {
    const { results } = await c.env.DB.prepare('SELECT * FROM programs ORDER BY created_at DESC').all()
    return c.json({ success: true, programs: results })
  } catch (err) {
    console.error('Programs error:', err)
    return c.json({ success: false, error: 'í”„ë¡œê·¸ë¨ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// í”„ë¡œê·¸ë¨ ì¶”ê°€
app.post('/api/admin/programs', async (c) => {
  try {
    const { name, description, price, duration_days, max_students } = await c.req.json()
    
    const result = await c.env.DB.prepare(`
      INSERT INTO programs (name, description, price, duration_days, max_students, status, is_active)
      VALUES (?, ?, ?, ?, ?, 'active', 1)
    `).bind(name, description || '', price || 0, duration_days || 30, max_students || null).run()
    
    return c.json({ success: true, message: 'í”„ë¡œê·¸ë¨ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', id: result.meta.last_row_id })
  } catch (err) {
    console.error('Add program error:', err)
    return c.json({ success: false, error: 'í”„ë¡œê·¸ë¨ ì¶”ê°€ ì‹¤íŒ¨' }, 500)
  }
})

// í”„ë¡œê·¸ë¨ ìˆ˜ì •
app.put('/api/admin/programs/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const { name, description, price, duration_days, max_students, status } = await c.req.json()
    
    await c.env.DB.prepare(`
      UPDATE programs 
      SET name = ?, description = ?, price = ?, duration_days = ?, max_students = ?, status = ?
      WHERE id = ?
    `).bind(name, description, price, duration_days, max_students, status, id).run()
    
    return c.json({ success: true, message: 'í”„ë¡œê·¸ë¨ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Update program error:', err)
    return c.json({ success: false, error: 'í”„ë¡œê·¸ë¨ ìˆ˜ì • ì‹¤íŒ¨' }, 500)
  }
})

// í”„ë¡œê·¸ë¨ ì‚­ì œ
app.delete('/api/admin/programs/:id', async (c) => {
  try {
    const id = c.req.param('id')
    // ì†Œí”„íŠ¸ ì‚­ì œ (statusë¥¼ inactiveë¡œ ë³€ê²½)
    await c.env.DB.prepare('UPDATE programs SET status = ?, is_active = 0 WHERE id = ?').bind('inactive', id).run()
    
    return c.json({ success: true, message: 'í”„ë¡œê·¸ë¨ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Delete program error:', err)
    return c.json({ success: false, error: 'í”„ë¡œê·¸ë¨ ì‚­ì œ ì‹¤íŒ¨' }, 500)
  }
})


// ê´€ë¦¬ì - ìˆ˜ê°• í˜„í™©
app.get('/api/admin/enrollments', async (c) => {
  try {
    const query = 'SELECT up.*, u.name as user_name, p.name as program_name FROM user_programs up JOIN users u ON up.user_id = u.id JOIN programs p ON up.program_id = p.id WHERE up.status = ? ORDER BY up.created_at DESC'
    const { results } = await c.env.DB.prepare(query).bind('active').all()
    return c.json({ success: true, enrollments: results })
  } catch (err) {
    return c.json({ success: false, error: 'ìˆ˜ê°• í˜„í™© ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// í†µê³„ - ì›”ë³„ ê°€ì…ì ì¶”ì´ (ìµœê·¼ 6ê°œì›”)
app.get('/api/admin/stats/monthly-users', async (c) => {
  try {
    const query = `
      SELECT 
        strftime('%Y-%m', created_at) as month,
        COUNT(*) as count
      FROM users
      WHERE created_at >= date('now', '-6 months')
      GROUP BY month
      ORDER BY month ASC
    `
    const { results } = await c.env.DB.prepare(query).all()
    return c.json({ success: true, data: results })
  } catch (err) {
    console.error('Monthly users stats error:', err)
    return c.json({ success: false, error: 'í†µê³„ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// í†µê³„ - í”„ë¡œê·¸ë¨ë³„ ìˆ˜ê°•ìƒ ìˆ˜
app.get('/api/admin/stats/program-enrollments', async (c) => {
  try {
    const query = `
      SELECT 
        p.name as program_name,
        p.price,
        COUNT(up.id) as enrollment_count,
        SUM(p.price) as revenue
      FROM programs p
      LEFT JOIN user_programs up ON p.id = up.program_id AND up.status = 'active'
      WHERE p.status = 'active'
      GROUP BY p.id, p.name, p.price
      ORDER BY enrollment_count DESC
    `
    const { results } = await c.env.DB.prepare(query).all()
    return c.json({ success: true, data: results })
  } catch (err) {
    console.error('Program enrollments stats error:', err)
    return c.json({ success: false, error: 'í†µê³„ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// í†µê³„ - ëŒ€ì‹œë³´ë“œ ìš”ì•½
app.get('/api/admin/stats/dashboard-summary', async (c) => {
  try {
    // ì „ì²´ ì‚¬ìš©ì ìˆ˜
    const totalUsers = await c.env.DB.prepare('SELECT COUNT(*) as count FROM users').first()
    
    // í™œì„± ì‚¬ìš©ì ìˆ˜ (ìµœê·¼ 30ì¼ ë¡œê·¸ì¸)
    const activeUsers = await c.env.DB.prepare('SELECT COUNT(*) as count FROM users WHERE updated_at >= date("now", "-30 days")').first()
    
    // ì‹ ê·œ ë¬¸ì˜ ìˆ˜ (ëŒ€ê¸°ì¤‘)
    const pendingContacts = await c.env.DB.prepare('SELECT COUNT(*) as count FROM contacts WHERE status = ?').bind('pending').first()
    
    // ì „ì²´ ë¬¸ì˜ ìˆ˜
    const totalContacts = await c.env.DB.prepare('SELECT COUNT(*) as count FROM contacts').first()
    
    // í™œì„± í”„ë¡œê·¸ë¨ ìˆ˜
    const activePrograms = await c.env.DB.prepare('SELECT COUNT(*) as count FROM programs WHERE status = ?').bind('active').first()
    
    // ì „ì²´ ìˆ˜ê°• ìˆ˜
    const totalEnrollments = await c.env.DB.prepare('SELECT COUNT(*) as count FROM user_programs WHERE status = ?').bind('active').first()
    
    // ì´ ë§¤ì¶œ (ì˜ˆìƒ)
    const totalRevenue = await c.env.DB.prepare(`
      SELECT SUM(p.price) as total
      FROM user_programs up
      JOIN programs p ON up.program_id = p.id
      WHERE up.status = 'active'
    `).first()
    
    return c.json({
      success: true,
      data: {
        totalUsers: totalUsers?.count || 0,
        activeUsers: activeUsers?.count || 0,
        pendingContacts: pendingContacts?.count || 0,
        totalContacts: totalContacts?.count || 0,
        activePrograms: activePrograms?.count || 0,
        totalEnrollments: totalEnrollments?.count || 0,
        totalRevenue: totalRevenue?.total || 0
      }
    })
  } catch (err) {
    console.error('Dashboard summary error:', err)
    return c.json({ success: false, error: 'í†µê³„ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ê´€ë¦¬ì - ì‚¬ìš©ìë³„ í”„ë¡œê·¸ë¨ ì¡°íšŒ
app.get('/api/admin/users/:id/programs', async (c) => {
  try {
    const userId = c.req.param('id')
    const query = 'SELECT up.*, p.name as program_name, p.duration_days FROM user_programs up JOIN programs p ON up.program_id = p.id WHERE up.user_id = ? AND up.status = ? ORDER BY up.created_at DESC'
    const { results } = await c.env.DB.prepare(query).bind(userId, 'active').all()
    return c.json({ success: true, programs: results })
  } catch (err) {
    return c.json({ success: false, error: 'í”„ë¡œê·¸ë¨ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ê´€ë¦¬ì - í”„ë¡œê·¸ë¨ ë¶€ì—¬
app.post('/api/admin/assign-program', async (c) => {
  try {
    const { user_id, program_id, end_date } = await c.req.json()
    const query = 'INSERT INTO user_programs (user_id, program_id, end_date, status) VALUES (?, ?, ?, ?)'
    await c.env.DB.prepare(query).bind(user_id, program_id, end_date || null, 'active').run()
    return c.json({ success: true, message: 'í”„ë¡œê·¸ë¨ì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    return c.json({ success: false, error: 'í”„ë¡œê·¸ë¨ ë¶€ì—¬ ì‹¤íŒ¨' }, 500)
  }
})

// ê´€ë¦¬ì - í”„ë¡œê·¸ë¨ ì‚­ì œ
app.delete('/api/admin/remove-program/:id', async (c) => {
  try {
    const id = c.req.param('id')
    await c.env.DB.prepare('DELETE FROM user_programs WHERE id = ?').bind(id).run()
    return c.json({ success: true, message: 'í”„ë¡œê·¸ë¨ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    return c.json({ success: false, error: 'í”„ë¡œê·¸ë¨ ì‚­ì œ ì‹¤íŒ¨' }, 500)
  }
})

// ê´€ë¦¬ì - ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”
app.post('/api/admin/reset-password', async (c) => {
  try {
    const { user_id } = await c.req.json()
    const newPassword = 'academy1234' // ê¸°ë³¸ ì´ˆê¸°í™” ë¹„ë°€ë²ˆí˜¸
    const query = 'UPDATE users SET password = ? WHERE id = ?'
    await c.env.DB.prepare(query).bind(newPassword, user_id).run()
    return c.json({ success: true, message: `ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸: ${newPassword})` })
  } catch (err) {
    return c.json({ success: false, error: 'ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì‹¤íŒ¨' }, 500)
  }
})

// ê´€ë¦¬ì - ì‚¬ìš©ì í™œì„±í™”/ë¹„í™œì„±í™”
app.post('/api/admin/toggle-user-status', async (c) => {
  try {
    const { user_id, is_active } = await c.req.json()
    const status = is_active ? 'active' : 'inactive'
    const query = 'UPDATE users SET status = ? WHERE id = ?'
    await c.env.DB.prepare(query).bind(status, user_id).run()
    return c.json({ success: true, message: `ì‚¬ìš©ìê°€ ${is_active ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.` })
  } catch (err) {
    return c.json({ success: false, error: 'ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨' }, 500)
  }
})

// ê´€ë¦¬ì - ë¬¸ì˜ ìƒíƒœ ë³€ê²½
app.put('/api/admin/contacts/:id/status', async (c) => {
  try {
    const id = c.req.param('id')
    const { status } = await c.req.json()
    await c.env.DB.prepare('UPDATE contacts SET status = ? WHERE id = ?').bind(status, id).run()
    return c.json({ success: true, message: 'ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    return c.json({ success: false, error: 'ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨' }, 500)
  }
})

// ========================================
// ëœë”©í˜ì´ì§€ ìƒì„±ê¸° API
// ========================================

// ëœë”©í˜ì´ì§€ ìƒì„±
app.post('/api/landing/create', async (c) => {
  try {
    const { title, template_type, input_data, thumbnail_url, og_title, og_description, folder_id, form_id } = await c.req.json()
    
    // ë””ë²„ê¹…: ë°›ì€ ë°ì´í„° í™•ì¸
    console.log('ğŸ” APIì—ì„œ ë°›ì€ ë°ì´í„°:', {
      title,
      template_type,
      thumbnail_url: thumbnail_url ? (thumbnail_url.length > 100 ? thumbnail_url.substring(0, 100) + '...' : thumbnail_url) : null,
      og_title,
      og_description,
      folder_id,
      form_id
    })
    
    // Base64 ì¸ì½”ë”©ëœ ì‚¬ìš©ì ë°ì´í„° ë””ì½”ë”©
    const userHeaderBase64 = c.req.header('X-User-Data-Base64')
    let user = { id: 1 }
    if (userHeaderBase64) {
      try {
        const userDataStr = atob(userHeaderBase64)
        user = JSON.parse(userDataStr)
      } catch (e) {
        console.warn('Failed to decode user data:', e)
      }
    }
    
    // ğŸ”¥ ëœë”©í˜ì´ì§€ ìƒì„± í•œë„ ì²´í¬
    // First, get the user's academy_id and ensure it exists
    const userRecord = await c.env.DB.prepare(`SELECT id, academy_id FROM users WHERE id = ?`).bind(user.id).first()
    
    let academyIdToUse = userRecord?.academy_id
    if (!academyIdToUse) {
      // If user doesn't have academy_id, set it to user.id
      academyIdToUse = user.id
      try {
        await c.env.DB.prepare(`UPDATE users SET academy_id = ? WHERE id = ?`).bind(academyIdToUse, user.id).run()
        console.log('ğŸ”§ [Landing] Auto-set academy_id for user:', user.id)
      } catch (e) {
        console.error('Failed to set academy_id:', e)
      }
    }
    
    const activeSubscription = await c.env.DB.prepare(`
      SELECT id, landing_page_limit, plan_name, subscription_end_date, payment_method
      FROM subscriptions 
      WHERE academy_id = ?
        AND status = 'active' 
        AND subscription_end_date >= date('now')
      ORDER BY created_at DESC 
      LIMIT 1
    `).bind(academyIdToUse).first()
    
    if (!activeSubscription) {
      return c.json({ 
        success: false, 
        error: 'í™œì„±í™”ëœ êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤. í”Œëœì„ êµ¬ë§¤í•´ì£¼ì„¸ìš”.' 
      }, 403)
    }
    
    // ë¬´ë£Œ í”Œëœ ìë™ ê°±ì‹  ì²´í¬
    if (activeSubscription.payment_method === 'free') {
      const endDate = new Date(activeSubscription.subscription_end_date)
      const now = new Date()
      
      // êµ¬ë…ì´ ë§Œë£Œë˜ì—ˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë‹¤ìŒ ë‹¬ êµ¬ë… ìƒì„±
      if (endDate <= now) {
        console.log('ğŸ”„ [Free Plan] Auto-renewing expired free subscription')
        
        const newStartDate = new Date()
        const newEndDate = new Date()
        newEndDate.setMonth(newEndDate.getMonth() + 1)
        newEndDate.setDate(1)
        newEndDate.setHours(0, 0, 0, 0)
        
        // ì´ì „ êµ¬ë… ë¹„í™œì„±í™”
        await c.env.DB.prepare(`
          UPDATE subscriptions SET status = 'expired' WHERE id = ?
        `).bind(activeSubscription.id).run()
        
        // ìƒˆ êµ¬ë… ìƒì„±
        const newSubResult = await c.env.DB.prepare(`
          INSERT INTO subscriptions (
            academy_id, plan_name, plan_price, student_limit, ai_report_limit, 
            landing_page_limit, teacher_limit, subscription_start_date, 
            subscription_end_date, status, payment_method, created_at, updated_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', 'free', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
        `).bind(
          academyIdToUse,
          'ë¬´ë£Œ í”Œëœ',
          0, 50, 0, 1, 0,
          newStartDate.toISOString().split('T')[0],
          newEndDate.toISOString().split('T')[0]
        ).run()
        
        const newSubId = newSubResult.meta.last_row_id
        
        // usage_tracking ìƒì„±
        await c.env.DB.prepare(`
          INSERT INTO usage_tracking (
            academy_id, subscription_id, current_students, ai_reports_used_this_month,
            landing_pages_created, current_teachers, sms_sent_this_month,
            last_ai_report_reset_date, last_sms_reset_date, created_at, updated_at
          ) VALUES (?, ?, 0, 0, 0, 0, 0, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
        `).bind(
          academyIdToUse,
          newSubId,
          newStartDate.toISOString().split('T')[0],
          newStartDate.toISOString().split('T')[0]
        ).run()
        
        console.log('âœ… [Free Plan] Created new monthly subscription:', newSubId)
        
        // ìƒˆë¡œìš´ êµ¬ë…ìœ¼ë¡œ êµì²´
        const renewedSub = await c.env.DB.prepare(`
          SELECT id, landing_page_limit 
          FROM subscriptions 
          WHERE id = ?
        `).bind(newSubId).first()
        
        Object.assign(activeSubscription, renewedSub)
      }
    }
    
    const usage = await c.env.DB.prepare(`
      SELECT landing_pages_created 
      FROM usage_tracking 
      WHERE subscription_id = ?
    `).bind(activeSubscription.id).first()
    
    const currentPages = usage?.landing_pages_created || 0
    const pageLimit = activeSubscription.landing_page_limit
    
    // ğŸ”¥ ëœë”©í˜ì´ì§€ ìƒì„± í•œë„ ì²´í¬ (í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ì œê±°)
    if (currentPages >= pageLimit) {
      return c.json({ 
        success: false, 
        error: `â›” ì‚¬ìš© í•œë„ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nìƒì„±ëœ ëœë”©í˜ì´ì§€: ${currentPages}ê°œ / í•œë„: ${pageLimit}ê°œ\n\në” ë§ì€ ëœë”©í˜ì´ì§€ë¥¼ ì œì‘í•˜ì‹œë ¤ë©´ ìƒìœ„ í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•´ì£¼ì„¸ìš”.` 
      }, 403)
    }
    console.log(`âœ… [Landing] Limit check passed: ${currentPages}/${pageLimit}`)
    
    // ê³ ìœ  slug ìƒì„± (ëœë¤ 8ìë¦¬)
    const slug = Math.random().toString(36).substring(2, 10)
    
    // AIê°€ HTML ìƒì„± (í…œí”Œë¦¿ ê¸°ë°˜)
    const htmlContent = generateLandingPageHTML(template_type, input_data)
    
    // QR ì½”ë“œ URL ìƒì„± (Google Charts API ì‚¬ìš©)
    const landingUrl = `${c.req.header('origin') || 'https://example.com'}/landing/${slug}`
    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(landingUrl)}`
    
    // DB ì €ì¥
    const query = `
      INSERT INTO landing_pages (user_id, slug, title, template_type, content_json, html_content, qr_code_url, thumbnail_url, og_title, og_description, folder_id, form_id, status)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'active')
    `
    const result = await c.env.DB.prepare(query)
      .bind(user.id, slug, title, template_type, JSON.stringify(input_data), htmlContent, qrCodeUrl, thumbnail_url || null, og_title || null, og_description || null, folder_id || null, form_id || null)
      .run()
    
    // ğŸ”¥ ì‚¬ìš©ëŸ‰ ì¦ê°€ (ë ˆì½”ë“œê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±)
    try {
      // ë¨¼ì € usage_tracking ë ˆì½”ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      const usageExists = await c.env.DB.prepare(`
        SELECT id FROM usage_tracking WHERE subscription_id = ?
      `).bind(activeSubscription.id).first()
      
      if (!usageExists) {
        // ë ˆì½”ë“œê°€ ì—†ìœ¼ë©´ ìƒì„±
        console.log('âš ï¸ [Landing] usage_tracking record not found, creating...')
        await c.env.DB.prepare(`
          INSERT INTO usage_tracking (
            academy_id, subscription_id, current_students, ai_reports_used_this_month,
            landing_pages_created, current_teachers, sms_sent_this_month,
            created_at, updated_at
          ) VALUES (?, ?, 0, 0, 1, 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
        `).bind(academyIdToUse, activeSubscription.id).run()
        console.log('âœ… [Landing] Created usage_tracking with landing_pages_created = 1')
      } else {
        // ë ˆì½”ë“œê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
        await c.env.DB.prepare(`
          UPDATE usage_tracking 
          SET landing_pages_created = landing_pages_created + 1, 
              updated_at = CURRENT_TIMESTAMP
          WHERE subscription_id = ?
        `).bind(activeSubscription.id).run()
        console.log('âœ… [Landing] Updated landing_pages_created:', currentPages + 1, '/', pageLimit)
      }
    } catch (usageErr) {
      console.error('âŒ [Landing] Failed to update usage:', usageErr)
      // ì—ëŸ¬ê°€ ë‚˜ë„ ëœë”©í˜ì´ì§€ ìƒì„± ìì²´ëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
    }
    
    return c.json({ 
      success: true, 
      message: 'ëœë”©í˜ì´ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      slug,
      url: `/landing/${slug}`,
      usage: {
        current: currentPages + 1,
        limit: pageLimit
      },
      qrCodeUrl,
      id: result.meta.last_row_id
    })
  } catch (err) {
    console.error('Landing page creation error:', err)
    return c.json({ success: false, error: 'ëœë”©í˜ì´ì§€ ìƒì„± ì‹¤íŒ¨: ' + (err as Error).message }, 500)
  }
})

// ëœë”©í˜ì´ì§€ ìˆ˜ì • API
app.put('/api/landing/:slug/edit', async (c) => {
  try {
    const slug = c.req.param('slug')
    const { html_content, header_pixel, body_pixel, conversion_pixel } = await c.req.json()
    
    // ëœë”©í˜ì´ì§€ ì¡´ì¬ í™•ì¸
    const page = await c.env.DB.prepare('SELECT * FROM landing_pages WHERE slug = ?').bind(slug).first()
    
    if (!page) {
      return c.json({ success: false, error: 'ëœë”©í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // í”½ì…€ ì»¬ëŸ¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ê³  ì ì ˆí•œ ì¿¼ë¦¬ ì‚¬ìš©
    try {
      await c.env.DB.prepare(`
        UPDATE landing_pages 
        SET html_content = ?, 
            header_pixel = ?,
            body_pixel = ?,
            conversion_pixel = ?,
            updated_at = CURRENT_TIMESTAMP
        WHERE slug = ?
      `).bind(html_content || page.html_content, header_pixel || null, body_pixel || null, conversion_pixel || null, slug).run()
    } catch (columnErr) {
      // í”½ì…€ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ HTMLë§Œ ì—…ë°ì´íŠ¸
      console.log('Pixel columns not found, updating html_content only')
      await c.env.DB.prepare(`
        UPDATE landing_pages 
        SET html_content = ?, 
            updated_at = CURRENT_TIMESTAMP
        WHERE slug = ?
      `).bind(html_content || page.html_content, slug).run()
      
      // ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
      try {
        await c.env.DB.prepare(`ALTER TABLE landing_pages ADD COLUMN header_pixel TEXT`).run()
        await c.env.DB.prepare(`ALTER TABLE landing_pages ADD COLUMN body_pixel TEXT`).run()
        await c.env.DB.prepare(`ALTER TABLE landing_pages ADD COLUMN conversion_pixel TEXT`).run()
        console.log('âœ… Added pixel columns to landing_pages')
        
        // í”½ì…€ ë°ì´í„° ì—…ë°ì´íŠ¸
        await c.env.DB.prepare(`
          UPDATE landing_pages 
          SET header_pixel = ?,
              body_pixel = ?,
              conversion_pixel = ?
          WHERE slug = ?
        `).bind(header_pixel || null, body_pixel || null, conversion_pixel || null, slug).run()
      } catch (migrateErr) {
        console.log('Migration already applied or failed:', migrateErr)
      }
    }
    
    return c.json({ 
      success: true, 
      message: 'ëœë”©í˜ì´ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' 
    })
  } catch (err) {
    console.error('Landing page update error:', err)
    return c.json({ success: false, error: 'ëœë”©í˜ì´ì§€ ìˆ˜ì • ì‹¤íŒ¨: ' + (err as Error).message }, 500)
  }
})

// ì‚¬ìš©ì ëœë”©í˜ì´ì§€ ëª©ë¡
app.get('/api/landing/my-pages', async (c) => {
  try {
    const userId = c.req.query('userId')
    const folderId = c.req.query('folderId')
    
    let query = 'SELECT id, slug, title, template_type, view_count, status, folder_id, form_id, created_at FROM landing_pages WHERE user_id = ?'
    let params = [userId]
    
    if (folderId) {
      query += ' AND folder_id = ?'
      params.push(folderId)
    } else if (folderId === null || folderId === 'null') {
      // í´ë”ê°€ ì—†ëŠ” í˜ì´ì§€ë§Œ ì¡°íšŒ
      query += ' AND folder_id IS NULL'
    }
    
    query += ' ORDER BY created_at DESC'
    
    const { results } = await c.env.DB.prepare(query).bind(...params).all()
    return c.json({ success: true, pages: results })
  } catch (err) {
    console.error('ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', err)
    return c.json({ success: false, error: 'ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// í´ë” ëª©ë¡ ì¡°íšŒ
app.get('/api/landing/folders', async (c) => {
  try {
    const userId = c.req.query('userId')
    
    // í´ë” ëª©ë¡
    const foldersQuery = 'SELECT id, name, created_at FROM landing_folders WHERE user_id = ? ORDER BY created_at DESC'
    const { results: folders } = await c.env.DB.prepare(foldersQuery).bind(userId).all()
    
    // ê° í´ë”ì˜ í˜ì´ì§€ ìˆ˜ ê³„ì‚°
    const foldersWithCount = await Promise.all(folders.map(async (folder) => {
      const countQuery = 'SELECT COUNT(*) as count FROM landing_pages WHERE folder_id = ?'
      const count = await c.env.DB.prepare(countQuery).bind(folder.id).first()
      return { ...folder, page_count: count.count || 0 }
    }))
    
    // ì „ì²´ í˜ì´ì§€ ìˆ˜
    const totalQuery = 'SELECT COUNT(*) as count FROM landing_pages WHERE user_id = ?'
    const total = await c.env.DB.prepare(totalQuery).bind(userId).first()
    
    return c.json({ 
      success: true, 
      folders: foldersWithCount,
      totalPages: total.count || 0
    })
  } catch (err) {
    console.error('í´ë” ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', err)
    return c.json({ success: false, error: 'í´ë” ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// í´ë” ìƒì„±
app.post('/api/landing/folders', async (c) => {
  try {
    const { userId, name, description } = await c.req.json()
    
    if (!name || !name.trim()) {
      return c.json({ success: false, error: 'í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.' }, 400)
    }
    
    const query = 'INSERT INTO landing_folders (user_id, name, description) VALUES (?, ?, ?)'
    const result = await c.env.DB.prepare(query).bind(userId, name.trim(), description || null).run()
    
    return c.json({ 
      success: true, 
      folderId: result.meta.last_row_id,
      message: 'í´ë”ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.' 
    })
  } catch (err) {
    console.error('í´ë” ìƒì„± ì‹¤íŒ¨:', err)
    return c.json({ success: false, error: 'í´ë” ìƒì„± ì‹¤íŒ¨' }, 500)
  }
})

// í´ë” ìˆ˜ì •
app.put('/api/landing/folders/:id', async (c) => {
  try {
    const folderId = c.req.param('id')
    const { name, description } = await c.req.json()
    
    if (!name || !name.trim()) {
      return c.json({ success: false, error: 'í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.' }, 400)
    }
    
    const query = 'UPDATE landing_folders SET name = ?, description = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?'
    await c.env.DB.prepare(query).bind(name.trim(), description || null, folderId).run()
    
    return c.json({ 
      success: true, 
      message: 'í´ë”ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' 
    })
  } catch (err) {
    console.error('í´ë” ìˆ˜ì • ì‹¤íŒ¨:', err)
    return c.json({ success: false, error: 'í´ë” ìˆ˜ì • ì‹¤íŒ¨' }, 500)
  }
})

// í´ë” ì‚­ì œ
app.delete('/api/landing/folders/:id', async (c) => {
  try {
    const folderId = c.req.param('id')
    const userId = c.req.query('userId')
    
    // í´ë”ì— ìˆëŠ” í˜ì´ì§€ë“¤ì˜ folder_idë¥¼ NULLë¡œ ë³€ê²½
    await c.env.DB.prepare('UPDATE landing_pages SET folder_id = NULL WHERE folder_id = ?')
      .bind(folderId).run()
    
    // í´ë” ì‚­ì œ
    await c.env.DB.prepare('DELETE FROM landing_folders WHERE id = ? AND user_id = ?')
      .bind(folderId, userId).run()
    
    return c.json({ 
      success: true, 
      message: 'í´ë”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' 
    })
  } catch (err) {
    console.error('í´ë” ì‚­ì œ ì‹¤íŒ¨:', err)
    return c.json({ success: false, error: 'í´ë” ì‚­ì œ ì‹¤íŒ¨' }, 500)
  }
})

// ëœë”©í˜ì´ì§€ë¥¼ í´ë”ë¡œ ì´ë™
app.put('/api/landing/move-to-folder', async (c) => {
  try {
    const { pageId, folderId } = await c.req.json()
    
    const query = 'UPDATE landing_pages SET folder_id = ? WHERE id = ?'
    await c.env.DB.prepare(query).bind(folderId, pageId).run()
    
    return c.json({ 
      success: true, 
      message: 'í´ë”ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤.' 
    })
  } catch (err) {
    console.error('í´ë” ì´ë™ ì‹¤íŒ¨:', err)
    return c.json({ success: false, error: 'í´ë” ì´ë™ ì‹¤íŒ¨' }, 500)
  }
})

// ëœë”©í˜ì´ì§€ ì¡°íšŒ
app.get('/api/landing/:slug', async (c) => {
  try {
    const slug = c.req.param('slug')
    const query = 'SELECT * FROM landing_pages WHERE slug = ? AND status = ?'
    const result = await c.env.DB.prepare(query).bind(slug, 'active').first()
    
    if (!result) {
      return c.json({ success: false, error: 'í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // ì¡°íšŒìˆ˜ ì¦ê°€
    await c.env.DB.prepare('UPDATE landing_pages SET view_count = view_count + 1 WHERE slug = ?').bind(slug).run()
    
    // ìƒì„¸ ì¡°íšŒ ë¡œê·¸ ì €ì¥
    const viewQuery = 'INSERT INTO landing_page_views (landing_page_id, user_agent, referrer) VALUES (?, ?, ?)'
    await c.env.DB.prepare(viewQuery).bind(
      result.id,
      c.req.header('user-agent') || '',
      c.req.header('referer') || ''
    ).run()
    
    return c.json({ success: true, page: result })
  } catch (err) {
    return c.json({ success: false, error: 'í˜ì´ì§€ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ëœë”©í˜ì´ì§€ í†µê³„
app.get('/api/landing/stats/summary', async (c) => {
  try {
    const userHeader = c.req.header('X-User-Data')
    const user = userHeader ? JSON.parse(userHeader) : { id: 1 }
    
    // ì´ í˜ì´ì§€ ìˆ˜
    const totalPages = await c.env.DB.prepare('SELECT COUNT(*) as count FROM landing_pages WHERE user_id = ?').bind(user.id).first()
    
    // ì´ ì¡°íšŒìˆ˜
    const totalViews = await c.env.DB.prepare('SELECT SUM(view_count) as total FROM landing_pages WHERE user_id = ?').bind(user.id).first()
    
    // ê°€ì¥ ì¸ê¸°ìˆëŠ” í˜ì´ì§€ top 5
    const topPages = await c.env.DB.prepare('SELECT id, title, slug, view_count FROM landing_pages WHERE user_id = ? ORDER BY view_count DESC LIMIT 5').bind(user.id).all()
    
    return c.json({
      success: true,
      stats: {
        totalPages: totalPages?.count || 0,
        totalViews: totalViews?.total || 0,
        topPages: topPages.results || []
      }
    })
  } catch (err) {
    return c.json({ success: false, error: 'í†µê³„ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ëœë”©í˜ì´ì§€ ì‚­ì œ
app.delete('/api/landing/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const userId = c.req.query('userId')
    const userHeader = c.req.header('X-User-Data')
    
    let user
    if (userId) {
      user = { id: parseInt(userId) }
    } else if (userHeader) {
      user = JSON.parse(userHeader)
    } else {
      return c.json({ success: false, error: 'ì‚¬ìš©ì ì¸ì¦ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.' }, 401)
    }
    
    console.log('Deleting landing page:', { id, userId: user.id })
    
    // 1ë‹¨ê³„: form_submissionsì—ì„œ í•´ë‹¹ landing_page_idë¥¼ ì°¸ì¡°í•˜ëŠ” ëª¨ë“  í–‰ì„ ì‚­ì œ
    // (landing_page_idëŠ” nullableì´ë¯€ë¡œ ì‚­ì œí•´ë„ í¼ ì œì¶œ ë°ì´í„°ëŠ” ìœ ì§€ë¨)
    try {
      const deleteSubmissions = await c.env.DB.prepare(
        'DELETE FROM form_submissions WHERE landing_page_id = ?'
      ).bind(id).run()
      console.log('âœ… Deleted form_submissions with landing_page_id:', deleteSubmissions.meta.changes)
    } catch (deleteErr) {
      console.log('âš ï¸ Could not delete form_submissions:', deleteErr)
      // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ ì‹œë„
    }
    
    // 2ë‹¨ê³„: ëœë”©í˜ì´ì§€ ì‚­ì œ
    const result = await c.env.DB.prepare('DELETE FROM landing_pages WHERE id = ? AND user_id = ?').bind(id, user.id).run()
    console.log('Delete result:', result)
    
    if (result.meta.changes === 0) {
      return c.json({ success: false, error: 'ì‚­ì œí•  í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // 3ï¸âƒ£ ì¤‘ìš”: usage_trackingì˜ landing_pages_createdëŠ” ê°ì†Œì‹œí‚¤ì§€ ì•ŠìŒ!
    // â†’ ëˆ„ì  ì¹´ìš´íŠ¸ ìœ ì§€ (49ê°œ ìƒì„± í›„ 1ê°œ ì‚­ì œ = 49ê°œ ìœ ì§€)
    console.log('âœ… Landing page deleted. Usage tracking count NOT decreased (cumulative count maintained)')
    
    return c.json({ success: true, message: 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err: any) {
    console.error('Landing page delete error:', err)
    return c.json({ success: false, error: err.message || 'ì‚­ì œ ì‹¤íŒ¨' }, 500)
  }
})

// ëœë”©í˜ì´ì§€ HTML ìƒì„± í•¨ìˆ˜
function generateLandingPageHTML(template_type: string, data: any): string {
  const templates: any = {
    'academy-intro': generateAcademyIntroHTML,
    'program-promo': generateProgramPromoHTML,
    'event-promo': generateEventPromoHTML,
    'parent-letter': generateParentLetterHTML,
    'student-report': generateStudentReportHTML,
    'admission-info': generateAdmissionInfoHTML,
    'academy-stats': generateAcademyStatsHTML,
    'teacher-intro': generateTeacherIntroHTML,
    'vacation-course': generateVacationCourseHTML
  }
  
  const generator = templates[template_type] || templates['academy-intro']
  return generator(data)
}

// QR ì½”ë“œ ì„¹ì…˜ ìƒì„± í•¨ìˆ˜
function generateQRCodeSection(): string {
  return `
    <!-- QR ì½”ë“œ ì„¹ì…˜ -->
    <div class="container" style="margin-top: 3rem; margin-bottom: 2rem;">
        <div style="background: white; border-radius: 20px; padding: 2.5rem; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1);">
            <h3 style="font-size: 1.5rem; font-weight: 700; color: #333; margin-bottom: 1rem;">
                ğŸ“± QRì½”ë“œë¡œ ê³µìœ í•˜ê¸°
            </h3>
            <p style="color: #666; margin-bottom: 2rem; font-size: 1rem;">
                QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ë©´ ì´ í˜ì´ì§€ë¡œ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤
            </p>
            <div id="qrCodeContainer" style="display: inline-block; padding: 1rem; background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                <img id="qrCodeImage" src="" alt="QR ì½”ë“œ" style="width: 250px; height: 250px; display: block;">
            </div>
            <div style="margin-top: 1.5rem;">
                <a id="qrCodeDownload" href="" download="qrcode.png" style="display: inline-block; background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); color: white; padding: 0.75rem 2rem; border-radius: 50px; text-decoration: none; font-weight: 600; transition: transform 0.3s; box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);">
                    ğŸ’¾ QRì½”ë“œ ë‹¤ìš´ë¡œë“œ
                </a>
            </div>
            <p id="pageUrl" style="color: #999; margin-top: 1rem; font-size: 0.85rem; word-break: break-all;">
            </p>
        </div>
    </div>

    <script>
        // í˜„ì¬ í˜ì´ì§€ URLë¡œ QRì½”ë“œ ìƒì„±
        (function() {
            const currentUrl = window.location.href;
            const qrCodeUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(currentUrl);
            
            document.getElementById('qrCodeImage').src = qrCodeUrl;
            document.getElementById('qrCodeDownload').href = qrCodeUrl;
            document.getElementById('pageUrl').textContent = currentUrl;
        })();
    </script>
  `
}

// í•™ì› ì†Œê°œ í˜ì´ì§€ í…œí”Œë¦¿ (ê¹”ë”í•˜ê³  í˜„ëŒ€ì ì¸ ë²„ì „)
function generateAcademyIntroHTML(data: any): string {
  const { 
    academyName, 
    location, 
    features, 
    specialties, 
    contact,
    placeUrl,
    directorName,
    directorPhoto,
    directorCareer,
    academyPhoto1,
    academyPhoto2,
    academyPhoto3,
    educationPhilosophy,
    educationPrograms,
    curriculum
  } = data
  
  // ë°°ì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©, ë¬¸ìì—´ì´ë©´ split
  const specialtiesList = Array.isArray(specialties) ? specialties : (specialties ? specialties.split('\n').filter((s: string) => s.trim()) : [])
  const directorCareerList = Array.isArray(directorCareer) ? directorCareer : (directorCareer ? directorCareer.split('\n').filter((c: string) => c.trim()) : [])
  const educationProgramsList = Array.isArray(educationPrograms) ? educationPrograms : (educationPrograms ? educationPrograms.split('\n').filter((p: string) => p.trim()) : [])
  const curriculumList = Array.isArray(curriculum) ? curriculum : (curriculum ? curriculum.split('\n').filter((c: string) => c.trim()) : [])
  
  return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${academyName} - í•™ì› ì†Œê°œ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #fff;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* Navigation */
        nav {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        nav .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        nav h1 {
            font-size: 1.5rem;
            font-weight: 900;
            color: #4F46E5;
        }
        
        nav a {
            color: #333;
            text-decoration: none;
            margin-left: 2rem;
            font-weight: 500;
            transition: color 0.3s;
        }
        
        nav a:hover {
            color: #4F46E5;
        }
        
        /* Hero Section */
        .hero {
            position: relative;
            background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%);
            color: white;
            padding: 8rem 0 6rem;
            text-align: center;
            overflow: hidden;
        }
        
        .hero-pattern {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            background-image: 
                radial-gradient(circle at 20px 20px, white 2px, transparent 0),
                radial-gradient(circle at 80px 80px, white 2px, transparent 0);
            background-size: 100px 100px;
        }
        
        .hero-content {
            position: relative;
            z-index: 1;
        }
        
        .hero h1 {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .hero p {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            opacity: 0.95;
        }
        
        .hero .location {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        /* Section Styles */
        .section {
            padding: 5rem 0;
        }
        
        .section-title {
            font-size: 2.5rem;
            font-weight: 900;
            text-align: center;
            margin-bottom: 3rem;
            color: #1a202c;
        }
        
        .section-title::after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%);
            margin: 1rem auto 0;
            border-radius: 2px;
        }
        
        /* Director Section */
        .director-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .director-photo {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 2rem;
            border: 5px solid #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            background: #f0f0f0;
            display: block !important;
        }
        
        .director-name {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 2rem;
            color: #1a202c;
        }
        
        .career-list {
            text-align: left;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .career-item {
            display: flex;
            align-items: start;
            margin-bottom: 1rem;
            padding: 0.8rem;
            background: #f7fafc;
            border-radius: 10px;
            transition: transform 0.3s;
        }
        
        .career-item:hover {
            transform: translateX(10px);
        }
        
        .career-icon {
            color: #667eea;
            margin-right: 1rem;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        /* Gallery Section */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }
        
        .gallery-item {
            position: relative;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .gallery-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        
        .gallery-item img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            display: block !important;
            background: #f0f0f0;
            border: 3px solid #667eea !important;
        }
        
        /* Info Cards */
        .info-card {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .info-card h3 {
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 1.5rem;
            color: #1a202c;
        }
        
        .info-card p, .info-card ul {
            font-size: 1.1rem;
            line-height: 1.8;
            color: #4a5568;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .feature-item {
            display: flex;
            align-items: start;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 15px;
            transition: transform 0.3s;
        }
        
        .feature-item:hover {
            transform: translateY(-5px);
        }
        
        .feature-number {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin-right: 1rem;
            font-size: 1.2rem;
        }
        
        .feature-text {
            flex: 1;
            font-size: 1.05rem;
            color: #2d3748;
        }
        
        /* CTA Section */
        .cta-section {
            background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%);
            color: white;
            padding: 5rem 0;
            text-align: center;
        }
        
        .cta-section h2 {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 1.5rem;
        }
        
        .cta-section p {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            opacity: 0.95;
        }
        
        .cta-button {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 1.2rem 3rem;
            border-radius: 50px;
            font-size: 1.3rem;
            font-weight: 700;
            text-decoration: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .hero h1 { font-size: 2.5rem; }
            .hero p { font-size: 1.2rem; }
            .section-title { font-size: 2rem; }
            .gallery-grid { grid-template-columns: 1fr; }
            nav a { margin-left: 1rem; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="container">
            <h1>${academyName}</h1>
            <div>
                <a href="#about">ì†Œê°œ</a>
                <a href="#programs">í”„ë¡œê·¸ë¨</a>
                <a href="#gallery">ê°¤ëŸ¬ë¦¬</a>
                <a href="#contact">ì—°ë½ì²˜</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero">
        <div class="hero-pattern"></div>
        <div class="hero-content container">
            <h1>${academyName}</h1>
            <p>${features || 'ìµœê³ ì˜ êµìœ¡ì„ ì œê³µí•©ë‹ˆë‹¤'}</p>
            <p class="location"><i class="fas fa-map-marker-alt"></i> ${location}</p>
            ${placeUrl ? `
            <a href="${placeUrl}" target="_blank" rel="noopener noreferrer" style="display: inline-block; margin-top: 2rem; background: white; color: #667eea; padding: 1rem 2.5rem; border-radius: 50px; font-size: 1.2rem; font-weight: 700; text-decoration: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transition: all 0.3s ease;">
                <i class="fas fa-map-marked-alt" style="margin-right: 0.5rem;"></i>${academyName} ë°”ë¡œ ë³´ê¸°
            </a>
            ` : ''}
        </div>
    </div>

    <!-- Main Content -->
    ${directorName ? `
    <!-- í•™ì›ì¥ ì†Œê°œ -->
    <section id="about" class="section" style="background: #f7fafc;">
        <div class="container">
            <h2 class="section-title">í•™ì›ì¥ ì†Œê°œ</h2>
            <div class="director-card">
                ${directorPhoto ? `<img src="${directorPhoto}" alt="${directorName}" class="director-photo" width="180" height="180" style="display:block!important;width:180px!important;height:180px!important;" referrerpolicy="no-referrer" onerror="console.log('Failed to load director photo:',this.src);this.style.display='none';">` : ''}
                <h3 class="director-name">${directorName} ì›ì¥</h3>
                <div class="career-list">
                    ${directorCareerList.map((career: string) => `
                        <div class="career-item">
                            <i class="fas fa-check-circle career-icon"></i>
                            <div>${career}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    </section>
    ` : ''}

    ${academyPhoto1 || academyPhoto2 || academyPhoto3 ? `
    <!-- í•™ì› ê°¤ëŸ¬ë¦¬ -->
    <section id="gallery" class="section">
        <div class="container">
            <h2 class="section-title">í•™ì› ë‘˜ëŸ¬ë³´ê¸°</h2>
            <div class="gallery-grid">
                ${academyPhoto1 ? `
                <div class="gallery-item">
                    <img src="${academyPhoto1}" alt="í•™ì› ì‚¬ì§„ 1" width="400" height="300" style="display:block!important;width:100%!important;height:300px!important;" referrerpolicy="no-referrer" onload="console.log('Loaded image 1');" onerror="console.log('Failed to load image 1:',this.src);this.parentElement.style.display='none';" >
                </div>
                ` : ''}
                ${academyPhoto2 ? `
                <div class="gallery-item">
                    <img src="${academyPhoto2}" alt="í•™ì› ì‚¬ì§„ 2" width="400" height="300" style="display:block!important;width:100%!important;height:300px!important;" referrerpolicy="no-referrer" onload="console.log('Loaded image 2');" onerror="console.log('Failed to load image 2:',this.src);this.parentElement.style.display='none';" >
                </div>
                ` : ''}
                ${academyPhoto3 ? `
                <div class="gallery-item">
                    <img src="${academyPhoto3}" alt="í•™ì› ì‚¬ì§„ 3" width="400" height="300" style="display:block!important;width:100%!important;height:300px!important;" referrerpolicy="no-referrer" onload="console.log('Loaded image 3');" onerror="console.log('Failed to load image 3:',this.src);this.parentElement.style.display='none';" >
                </div>
                ` : ''}
            </div>
        </div>
    </section>
    ` : ''}

    ${educationPhilosophy || educationProgramsList.length > 0 || curriculumList.length > 0 ? `
    <!-- êµìœ¡ ì •ë³´ -->
    <section id="programs" class="section" style="background: #f7fafc;">
        <div class="container">
            <h2 class="section-title">êµìœ¡ ì •ë³´</h2>
            
            ${educationPhilosophy ? `
            <div class="info-card">
                <h3><i class="fas fa-lightbulb" style="color: #667eea;"></i> êµìœ¡ ì² í•™</h3>
                <p style="white-space: pre-line;">${educationPhilosophy}</p>
            </div>
            ` : ''}
            
            ${educationProgramsList.length > 0 ? `
            <div class="info-card">
                <h3><i class="fas fa-book-open" style="color: #667eea;"></i> êµìœ¡ í”„ë¡œê·¸ë¨</h3>
                <div class="feature-grid">
                    ${educationProgramsList.map((program: string, i: number) => `
                        <div class="feature-item">
                            <div class="feature-number">${i + 1}</div>
                            <div class="feature-text">${program}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            ${curriculumList.length > 0 ? `
            <div class="info-card">
                <h3><i class="fas fa-graduation-cap" style="color: #667eea;"></i> ì»¤ë¦¬í˜ëŸ¼</h3>
                <div class="feature-grid">
                    ${curriculumList.map((item: string, i: number) => `
                        <div class="feature-item">
                            <div class="feature-number">${i + 1}</div>
                            <div class="feature-text">${item}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
        </div>
    </section>
    ` : ''}

    ${specialtiesList.length > 0 ? `
    <!-- í•™ì› ê°•ì  -->
    <section class="section">
        <div class="container">
            <h2 class="section-title">${academyName}ì˜ ê°•ì </h2>
            <div class="feature-grid">
                ${specialtiesList.map((s: string, i: number) => `
                    <div class="feature-item">
                        <div class="feature-number">${i + 1}</div>
                        <div class="feature-text">${s}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    </section>
    ` : ''}

    <!-- ì—°ë½ì²˜ -->
    <section id="contact" class="cta-section">
        <div class="container">
            <h2>ì§€ê¸ˆ ë°”ë¡œ ìƒë‹´ ë°›ìœ¼ì„¸ìš”</h2>
            <p>ë¬´ë£Œ í•™ìŠµ ì§„ë‹¨ ë° ë§ì¶¤ ìƒë‹´ ì œê³µ</p>
            <p style="font-size: 2rem; font-weight: 900; margin-bottom: 2rem;">
                <i class="fas fa-phone-alt"></i> ${contact}
            </p>
            <a href="tel:${contact}" class="cta-button">
                <i class="fas fa-phone-alt"></i> ì „í™” ìƒë‹´í•˜ê¸°
            </a>
        </div>
    </section>

    <!-- Footer -->
    <footer style="background: #1a202c; color: #a0aec0; padding: 3rem 1.5rem; text-align: center;">
        <div class="container">
            <h3 style="color: white; font-size: 1.5rem; font-weight: 900; margin-bottom: 1rem;">${academyName}</h3>
            <p style="margin-bottom: 0.5rem;"><i class="fas fa-map-marker-alt"></i> ${location}</p>
            <p style="margin-bottom: 1.5rem;"><i class="fas fa-phone"></i> ${contact}</p>
            <p style="font-size: 0.9rem; opacity: 0.7;">Â© 2026 ${academyName}. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>
  `
}

// í”„ë¡œê·¸ë¨ í™ë³´ í˜ì´ì§€ í…œí”Œë¦¿
function generateProgramPromoHTML(data: any): string {
  const { programName, target, features, price, duration, cta, programImage } = data
  const featuresList = Array.isArray(features) ? features : (features ? features.split('\n').filter((f: string) => f.trim()) : [])
  
  return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${programName} - í”„ë¡œê·¸ë¨ ì•ˆë‚´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
      * { font-family: 'Pretendard Variable', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen py-8 px-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <!-- Header -->
            <div class="bg-blue-600 text-white p-8 text-center">
                <div class="inline-block bg-white text-blue-600 px-4 py-1 rounded-full text-sm font-medium mb-4">
                    ${target || 'ëª¨ì§‘ ì¤‘'}
                </div>
                <h1 class="text-3xl md:text-4xl font-bold mb-2">${programName}</h1>
                <p class="text-lg opacity-90">${duration || ''}</p>
            </div>
            
            ${programImage ? `
            <!-- Program Image -->
            <div class="p-6">
                <img src="${programImage}" alt="${programName}" class="w-full h-64 object-cover rounded-xl" onerror="this.style.display='none'">
            </div>
            ` : ''}
            
            <div class="p-8">
                <!-- Features -->
                <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b-2 border-blue-600 pb-2">ğŸ“š í”„ë¡œê·¸ë¨ íŠ¹ì§•</h2>
                <div class="space-y-3 mb-8">
                    ${featuresList.map((f: string) => `
                        <div class="flex items-start gap-3 p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <span class="text-blue-600 text-xl mt-0.5">âœ“</span>
                            <span class="text-gray-700 leading-relaxed">${f}</span>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Price -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-8 text-center border-2 border-blue-200">
                    <p class="text-gray-600 text-sm mb-1">ìˆ˜ê°•ë£Œ</p>
                    <p class="text-4xl font-bold text-gray-900 mb-1">${price ? price.toLocaleString() : 'ë¬¸ì˜'}ì›</p>
                    <p class="text-gray-500 text-sm">${duration || ''}</p>
                </div>
                
                <!-- CTA Button -->
                ${cta ? `
                <a href="${cta.startsWith('http') ? cta : 'tel:' + cta}" class="block w-full bg-blue-600 text-white text-center py-4 rounded-xl text-lg font-bold hover:bg-blue-700 transition">
                    ğŸ“ ìƒë‹´ ì‹ ì²­í•˜ê¸°
                </a>
                ` : ''}
            </div>
        </div>
    </div>
</body>
</html>
  `
}

// ì´ë²¤íŠ¸ í”„ë¡œëª¨ì…˜ í˜ì´ì§€ í…œí”Œë¦¿
function generateEventPromoHTML(data: any): string {
  const { eventName, period, benefits, urgency, cta } = data
  return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${eventName} - íŠ¹ë³„ ì´ë²¤íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
      * { font-family: 'Pretendard Variable', sans-serif; }
      @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
      .pulse-animation { animation: pulse 2s infinite; }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <div class="min-h-screen flex items-center justify-center px-6 py-12">
        <div class="max-w-2xl w-full">
            <div class="bg-gradient-to-br from-red-600 via-pink-600 to-purple-600 rounded-3xl p-1">
                <div class="bg-black rounded-3xl p-10">
                    <div class="text-center mb-10">
                        <div class="inline-block bg-red-600 px-6 py-2 rounded-full text-sm font-bold mb-6 pulse-animation">
                            âš¡ ${urgency || 'í•œì • íŠ¹ê°€'}
                        </div>
                        <h1 class="text-4xl md:text-6xl font-bold mb-6 bg-gradient-to-r from-yellow-300 to-red-300 bg-clip-text text-transparent">
                            ${eventName}
                        </h1>
                        <p class="text-2xl text-gray-300 mb-4">ğŸ“… ${period}</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-yellow-500/10 to-red-500/10 rounded-2xl p-8 mb-10 border border-yellow-500/30">
                        <h2 class="text-2xl font-bold mb-6 text-yellow-300">ğŸ íŠ¹ë³„ í˜œíƒ</h2>
                        <div class="space-y-4">
                            ${(benefits || []).map((b: string) => `
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">â­</span>
                                    <span class="text-lg">${b}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <a href="${cta || '#'}" class="block w-full bg-gradient-to-r from-yellow-400 to-red-500 text-black text-center py-6 rounded-xl text-2xl font-bold hover:shadow-2xl transition transform hover:scale-105">
                        ğŸ”¥ ì§€ê¸ˆ ë°”ë¡œ ì‹ ì²­í•˜ê¸°
                    </a>
                    
                    <p class="text-center text-gray-400 text-sm mt-6">â° ì„œë‘ë¥´ì„¸ìš”! ì¡°ê¸° ë§ˆê°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
  `
}

// ê°€ì •í†µì‹ ë¬¸ í˜ì´ì§€ í…œí”Œë¦¿
function generateParentLetterHTML(data: any): string {
  const { academyName, noticeTitle, noticeDate, noticeContent, keyPoints, contactInfo, staffName } = data
  const keyPointsList = keyPoints ? keyPoints.split('\n').filter((p: string) => p.trim()) : []
  
  return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${noticeTitle} - ${academyName}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
      * { font-family: 'Pretendard Variable', sans-serif; }
      .notice-border { border-left: 4px solid #10b981; }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen py-8 px-4">
    <div class="max-w-3xl mx-auto">
        <!-- í—¤ë” -->
        <div class="bg-white rounded-t-2xl p-8 shadow-lg">
            <div class="text-center border-b-2 border-green-500 pb-6">
                <div class="inline-block bg-green-100 px-6 py-2 rounded-full mb-4">
                    <span class="text-green-800 font-bold text-sm">ğŸ“§ ê°€ì •í†µì‹ ë¬¸</span>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-3">
                    ${academyName}
                </h1>
                <p class="text-gray-600 text-lg">${noticeDate}</p>
            </div>
        </div>

        <!-- ë³¸ë¬¸ -->
        <div class="bg-white p-8 shadow-lg">
            <div class="mb-8">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6 pb-3 border-b-2 border-gray-200">
                    ${noticeTitle}
                </h2>
                <div class="text-lg text-gray-700 leading-relaxed whitespace-pre-wrap mb-8">
                    ${noticeContent}
                </div>
            </div>

            ${keyPointsList.length > 0 ? `
            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 mb-8 notice-border">
                <h3 class="text-xl font-bold text-green-800 mb-4 flex items-center gap-2">
                    <span class="text-2xl">ğŸ“Œ</span>
                    ì£¼ìš” ì•ˆë‚´ì‚¬í•­
                </h3>
                <div class="space-y-3">
                    ${keyPointsList.map((point: string) => `
                        <div class="flex items-start gap-3 bg-white p-4 rounded-lg shadow-sm">
                            <span class="text-green-600 font-bold text-lg flex-shrink-0">â€¢</span>
                            <span class="text-gray-800 leading-relaxed">${point}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            <!-- ë¬¸ì˜ì²˜ -->
            <div class="bg-gradient-to-r from-blue-500 to-green-500 rounded-xl p-6 text-white">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div>
                        <p class="font-bold text-lg mb-2">ğŸ“ ë¬¸ì˜í•˜ê¸°</p>
                        <p class="text-2xl font-bold">${contactInfo}</p>
                        ${staffName ? `<p class="text-sm opacity-90 mt-1">${staffName}</p>` : ''}
                    </div>
                    <a href="tel:${contactInfo.replace(/[^0-9]/g, '')}" class="bg-white text-green-600 px-6 py-3 rounded-xl font-bold hover:shadow-lg transition transform hover:scale-105">
                        ì „í™”í•˜ê¸°
                    </a>
                </div>
            </div>
        </div>

        <!-- í‘¸í„° -->
        <div class="bg-gray-100 rounded-b-2xl p-6 shadow-lg text-center">
            <p class="text-gray-600 text-sm">í•­ìƒ ìµœì„ ì„ ë‹¤í•˜ëŠ” ${academyName}ì´ ë˜ê² ìŠµë‹ˆë‹¤.</p>
            <p class="text-gray-500 text-xs mt-2">ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ™</p>
        </div>
    </div>
</body>
</html>
  `
}

// í•™ìƒ ì„±ê³¼ ë¦¬í¬íŠ¸ í˜ì´ì§€ í…œí”Œë¦¿ (ì „ë¬¸ì ì´ê³  ìƒì„¸í•œ ë²„ì „)
// í•™ìƒ ì„±ê³¼ ë¦¬í¬íŠ¸ í˜ì´ì§€ í…œí”Œë¦¿ (ëª¨ë°”ì¼ ìµœì í™” + êµì¬/ì¶œì„ ì¶”ê°€)
function generateStudentReportHTML(data: any): string {
  const { 
    studentName, month, achievements, improvements, nextGoals, teacherName,
    textbooks, attendanceRate, attendanceDays, totalDays,
    understandingLevel, participationLevel, homeworkRate
  } = data
  
  // ê·¸ë˜í”„ ë°ì´í„° ìƒì„±
  const chartData = {
    attendance: attendanceRate || 95,
    understanding: understandingLevel || 4,
    participation: participationLevel || 4,
    homework: homeworkRate || 90
  }
  
  return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>${studentName} í•™ìƒ ${month} í•™ìŠµ ë¦¬í¬íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
      @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
      * { font-family: 'Pretendard Variable', sans-serif; }
      @keyframes slideInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
      .animate-slide { animation: slideInUp 0.6s ease-out; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen py-4 sm:py-8 px-3 sm:px-6">
    <div class="max-w-4xl mx-auto">
        <!-- Header Card -->
        <div class="bg-white rounded-2xl sm:rounded-3xl shadow-xl sm:shadow-2xl overflow-hidden mb-4 sm:mb-8 animate-slide">
            <div class="bg-gradient-to-r from-green-400 via-blue-500 to-purple-600 text-white p-6 sm:p-10 text-center relative">
                <div class="absolute top-2 right-2 sm:top-4 sm:right-4 bg-white/20 backdrop-blur-sm px-3 py-1.5 sm:px-4 sm:py-2 rounded-full text-xs sm:text-sm font-bold">
                    <i class="fas fa-calendar-alt mr-1 sm:mr-2"></i>${month}
                </div>
                <div class="mb-4 sm:mb-6">
                    <div class="inline-block bg-white/20 backdrop-blur-sm px-4 py-1.5 sm:px-6 sm:py-2 rounded-full text-xs sm:text-sm font-bold mb-2 sm:mb-4">
                        ğŸ“Š Monthly Learning Report
                    </div>
                </div>
                <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold mb-3 sm:mb-4">${month} í•™ìŠµ ë¦¬í¬íŠ¸</h1>
                <div class="flex items-center justify-center gap-2 sm:gap-3 text-2xl sm:text-3xl font-bold">
                    <i class="fas fa-user-graduate"></i>
                    <span>${studentName} í•™ìƒ</span>
                </div>
                <p class="text-sm sm:text-lg mt-3 sm:mt-4 opacity-90">ì—´ì‹¬íˆ ë…¸ë ¥í•œ í•œ ë‹¬ì˜ ê¸°ë¡ì…ë‹ˆë‹¤</p>
            </div>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-3 divide-x divide-gray-200 bg-gray-50">
                <div class="p-3 sm:p-6 text-center">
                    <div class="text-2xl sm:text-3xl font-bold text-green-600 mb-0.5 sm:mb-1">${(achievements || []).length}</div>
                    <div class="text-xs sm:text-sm text-gray-600">ì´ë‹¬ì˜ ì„±ê³¼</div>
                </div>
                <div class="p-3 sm:p-6 text-center">
                    <div class="text-2xl sm:text-3xl font-bold text-blue-600 mb-0.5 sm:mb-1">${attendanceRate || 95}%</div>
                    <div class="text-xs sm:text-sm text-gray-600">ì¶œì„ë¥ </div>
                </div>
                <div class="p-3 sm:p-6 text-center">
                    <div class="text-2xl sm:text-3xl font-bold text-purple-600 mb-0.5 sm:mb-1">${(nextGoals || []).length}</div>
                    <div class="text-xs sm:text-sm text-gray-600">ë‹¤ìŒ ëª©í‘œ</div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="bg-white rounded-2xl sm:rounded-3xl shadow-lg sm:shadow-xl p-4 sm:p-6 md:p-10 mb-4 sm:mb-8 space-y-6 sm:space-y-10">
            
            <!-- êµì¬ ì •ë³´ -->
            ${(textbooks && textbooks.length > 0) ? `
            <div class="p-4 sm:p-6 bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl sm:rounded-2xl border-2 border-amber-100">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3 sm:mb-4 flex items-center gap-2 sm:gap-3">
                    <i class="fas fa-book text-amber-600 text-2xl sm:text-3xl"></i>
                    ì‚¬ìš© êµì¬
                </h2>
                <div class="space-y-2 sm:space-y-3">
                    ${(textbooks || []).map((book: string) => `
                        <div class="flex items-center gap-2 sm:gap-3 p-3 sm:p-4 bg-white rounded-lg sm:rounded-xl shadow-sm">
                            <i class="fas fa-check-circle text-amber-600 text-lg sm:text-xl flex-shrink-0"></i>
                            <span class="text-sm sm:text-base text-gray-800 font-medium">${book}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- ì¶œì„ í˜„í™© -->
            <div class="p-4 sm:p-6 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl sm:rounded-2xl border-2 border-blue-100">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3 sm:mb-4 flex items-center gap-2 sm:gap-3">
                    <i class="fas fa-calendar-check text-blue-600 text-2xl sm:text-3xl"></i>
                    ì¶œì„ í˜„í™©
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                    <div class="bg-white rounded-lg sm:rounded-xl p-4 sm:p-5 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm sm:text-base text-gray-700 font-medium">ì¶œì„ë¥ </span>
                            <span class="text-2xl sm:text-3xl font-bold text-blue-600">${attendanceRate || 95}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 sm:h-3">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-2.5 sm:h-3 rounded-full" style="width: ${attendanceRate || 95}%"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg sm:rounded-xl p-4 sm:p-5 shadow-sm">
                        <div class="text-center">
                            <div class="text-sm sm:text-base text-gray-600 mb-2">ì¶œì„ ì¼ìˆ˜</div>
                            <div class="text-2xl sm:text-3xl font-bold text-blue-600">${attendanceDays || 19}ì¼ / ${totalDays || 20}ì¼</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ğŸ“Š í•™ìŠµ ì„±ê³¼ ê·¸ë˜í”„ -->
            <div class="p-4 sm:p-6 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl sm:rounded-2xl border-2 border-purple-100">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 sm:mb-6 flex items-center gap-2 sm:gap-3">
                    <i class="fas fa-chart-bar text-purple-600 text-2xl sm:text-3xl"></i>
                    í•™ìŠµ ì„±ê³¼ ë¶„ì„
                </h2>
                
                <!-- ì„±ê³¼ ì§€í‘œ ì¹´ë“œ -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4 mb-6">
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <div class="text-xs sm:text-sm text-gray-600 mb-2">ì¶œì„ë¥ </div>
                        <div class="text-2xl sm:text-3xl font-bold text-blue-600 mb-1">${chartData.attendance}%</div>
                        <div class="text-xs text-gray-500">Attendance</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <div class="text-xs sm:text-sm text-gray-600 mb-2">ì´í•´ë„</div>
                        <div class="text-2xl sm:text-3xl font-bold text-green-600 mb-1">${chartData.understanding}/5</div>
                        <div class="text-xs text-gray-500">Understanding</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <div class="text-xs sm:text-sm text-gray-600 mb-2">ì°¸ì—¬ë„</div>
                        <div class="text-2xl sm:text-3xl font-bold text-orange-600 mb-1">${chartData.participation}/5</div>
                        <div class="text-xs text-gray-500">Participation</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 shadow-sm text-center">
                        <div class="text-xs sm:text-sm text-gray-600 mb-2">ìˆ™ì œ ì™„ë£Œìœ¨</div>
                        <div class="text-2xl sm:text-3xl font-bold text-purple-600 mb-1">${chartData.homework}%</div>
                        <div class="text-xs text-gray-500">Homework</div>
                    </div>
                </div>
                
                <!-- ê·¸ë˜í”„ -->
                <div class="bg-white rounded-xl p-4 sm:p-6 shadow-sm">
                    <canvas id="performanceChart" class="w-full" style="max-height: 400px;"></canvas>
                </div>
                
                <!-- ì„±ê³¼ ì„¤ëª… -->
                <div class="mt-4 sm:mt-6 space-y-3">
                    <div class="flex items-start gap-3 p-3 sm:p-4 bg-white rounded-lg">
                        <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-blue-600 text-sm"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900 text-sm sm:text-base">ì¶œì„ë¥  ${chartData.attendance}%</div>
                            <div class="text-xs sm:text-sm text-gray-600 mt-1">
                                ${chartData.attendance >= 90 ? 'ë§¤ìš° ìš°ìˆ˜í•œ ì¶œì„ë¥ ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤! ğŸŒŸ' : 
                                  chartData.attendance >= 80 ? 'ì–‘í˜¸í•œ ì¶œì„ë¥ ì…ë‹ˆë‹¤. ì¡°ê¸ˆë§Œ ë” ë…¸ë ¥í•´ìš”! ğŸ’ª' : 
                                  'ì¶œì„ë¥  ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. í•¨ê»˜ ë…¸ë ¥í•´ë´ìš”! ğŸ“š'}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3 p-3 sm:p-4 bg-white rounded-lg">
                        <div class="flex-shrink-0 w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-brain text-green-600 text-sm"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900 text-sm sm:text-base">ìˆ˜ì—… ì´í•´ë„ ${chartData.understanding}/5</div>
                            <div class="text-xs sm:text-sm text-gray-600 mt-1">
                                ${chartData.understanding >= 4 ? 'ìˆ˜ì—… ë‚´ìš©ì„ ì˜ ì´í•´í•˜ê³  ìˆìŠµë‹ˆë‹¤! í›Œë¥­í•´ìš”! ğŸ¯' : 
                                  chartData.understanding >= 3 ? 'í‰ê·  ì´ìƒì˜ ì´í•´ë„ë¥¼ ë³´ì´ê³  ìˆì–´ìš”! ğŸ‘' : 
                                  'ì¡°ê¸ˆ ë” ì§‘ì¤‘í•˜ë©´ ë” ì¢‹ì€ ê²°ê³¼ê°€ ìˆì„ ê±°ì˜ˆìš”! ğŸ’¡'}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3 p-3 sm:p-4 bg-white rounded-lg">
                        <div class="flex-shrink-0 w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-hand-paper text-orange-600 text-sm"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900 text-sm sm:text-base">ìˆ˜ì—… ì°¸ì—¬ë„ ${chartData.participation}/5</div>
                            <div class="text-xs sm:text-sm text-gray-600 mt-1">
                                ${chartData.participation >= 4 ? 'ì ê·¹ì ìœ¼ë¡œ ìˆ˜ì—…ì— ì°¸ì—¬í•˜ê³  ìˆì–´ìš”! ë©‹ì ¸ìš”! ğŸ™‹' : 
                                  chartData.participation >= 3 ? 'ì¢‹ì€ ì°¸ì—¬ë„ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤! ğŸ˜Š' : 
                                  'ë” ì ê·¹ì ìœ¼ë¡œ ì°¸ì—¬í•´ë³´ë©´ ì–´ë–¨ê¹Œìš”? ğŸŒˆ'}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì´ë‹¬ì˜ ì„±ê³¼ -->
            <div>
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4 sm:mb-6 flex flex-wrap items-center gap-2 sm:gap-3">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-600 rounded-full flex items-center justify-center text-white flex-shrink-0">
                        <i class="fas fa-trophy text-base sm:text-lg"></i>
                    </div>
                    <span class="text-xl sm:text-2xl md:text-3xl">ì´ë‹¬ì˜ ì„±ê³¼</span>
                    <span class="hidden sm:inline text-base sm:text-lg text-gray-500 font-normal">Outstanding Achievements</span>
                </h2>
                <div class="space-y-3 sm:space-y-4">
                    ${(achievements || []).map((a: string, idx: number) => `
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 p-4 sm:p-6 rounded-r-xl sm:rounded-r-2xl shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-start gap-3 sm:gap-4">
                                <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 bg-green-600 rounded-full flex items-center justify-center text-white font-bold text-sm sm:text-base">
                                    ${idx + 1}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-gray-800 text-base sm:text-lg md:text-xl leading-relaxed font-medium break-words">${a}</p>
                                    <div class="mt-2 sm:mt-3">
                                        <span class="inline-block text-xs bg-green-100 text-green-700 px-2 sm:px-3 py-1 rounded-full font-medium">
                                            <i class="fas fa-check-circle mr-1"></i>ë‹¬ì„± ì™„ë£Œ
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <!-- ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ -->
            ${(improvements && improvements.length > 0) ? `
            <div>
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4 sm:mb-6 flex flex-wrap items-center gap-2 sm:gap-3">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-600 rounded-full flex items-center justify-center text-white flex-shrink-0">
                        <i class="fas fa-chart-line text-base sm:text-lg"></i>
                    </div>
                    <span class="text-xl sm:text-2xl md:text-3xl">ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„</span>
                    <span class="hidden sm:inline text-base sm:text-lg text-gray-500 font-normal">Areas for Improvement</span>
                </h2>
                <div class="space-y-3 sm:space-y-4">
                    ${(improvements || []).map((i: string, idx: number) => `
                        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border-l-4 border-blue-500 p-4 sm:p-6 rounded-r-xl sm:rounded-r-2xl shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-start gap-3 sm:gap-4">
                                <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm sm:text-base">
                                    ${idx + 1}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-gray-800 text-base sm:text-lg md:text-xl leading-relaxed font-medium break-words">${i}</p>
                                    <div class="mt-2 sm:mt-3">
                                        <span class="inline-block text-xs bg-blue-100 text-blue-700 px-2 sm:px-3 py-1 rounded-full font-medium">
                                            <i class="fas fa-lightbulb mr-1"></i>ê°œì„  ë°©í–¥
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : ''}
            
            <!-- ë‹¤ìŒ ë‹¬ ëª©í‘œ -->
            <div>
                <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4 sm:mb-6 flex flex-wrap items-center gap-2 sm:gap-3">
                    <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-600 rounded-full flex items-center justify-center text-white flex-shrink-0">
                        <i class="fas fa-bullseye text-base sm:text-lg"></i>
                    </div>
                    <span class="text-xl sm:text-2xl md:text-3xl">ë‹¤ìŒ ë‹¬ í•™ìŠµ ëª©í‘œ</span>
                    <span class="hidden sm:inline text-base sm:text-lg text-gray-500 font-normal">Next Month Goals</span>
                </h2>
                <div class="space-y-3 sm:space-y-4">
                    ${(nextGoals || []).map((g: string, idx: number) => `
                        <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-l-4 border-purple-500 p-4 sm:p-6 rounded-r-xl sm:rounded-r-2xl shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-start gap-3 sm:gap-4">
                                <div class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold text-sm sm:text-base">
                                    ${idx + 1}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-gray-800 text-base sm:text-lg md:text-xl leading-relaxed font-medium break-words">${g}</p>
                                    <div class="mt-2 sm:mt-3">
                                        <span class="inline-block text-xs bg-purple-100 text-purple-700 px-2 sm:px-3 py-1 rounded-full font-medium">
                                            <i class="fas fa-star mr-1"></i>ëª©í‘œ ì„¤ì •
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-white rounded-2xl sm:rounded-3xl shadow-lg p-4 sm:p-6 md:p-8 text-center">
            <p class="text-base sm:text-lg text-gray-700 mb-2 sm:mb-3">ë‹´ë‹¹ ì„ ìƒë‹˜: <span class="font-bold text-purple-600">${teacherName || 'ë‹´ë‹¹ êµì‚¬'}</span></p>
            <p class="text-xs sm:text-sm text-gray-500">ì´ ë¦¬í¬íŠ¸ëŠ” í•™ìƒì˜ í•™ìŠµ ì„±ì¥ì„ ìœ„í•œ ê¸°ë¡ì…ë‹ˆë‹¤</p>
        </div>
    </div>
    
    <script>
    // ğŸ“Š Chart.jsë¡œ í•™ìŠµ ì„±ê³¼ ê·¸ë˜í”„ ìƒì„±
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('performanceChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ì¶œì„ë¥ ', 'ì´í•´ë„', 'ì°¸ì—¬ë„', 'ìˆ™ì œ ì™„ë£Œìœ¨'],
                    datasets: [{
                        label: 'í•™ìŠµ ì„±ê³¼ ì§€í‘œ',
                        data: [
                            ${chartData.attendance},
                            ${chartData.understanding * 20}, // 5ì  ë§Œì ì„ 100ì  ë§Œì ìœ¼ë¡œ ë³€í™˜
                            ${chartData.participation * 20}, // 5ì  ë§Œì ì„ 100ì  ë§Œì ìœ¼ë¡œ ë³€í™˜
                            ${chartData.homework}
                        ],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)', // íŒŒë€ìƒ‰ - ì¶œì„ë¥ 
                            'rgba(34, 197, 94, 0.8)',  // ì´ˆë¡ìƒ‰ - ì´í•´ë„
                            'rgba(249, 115, 22, 0.8)', // ì£¼í™©ìƒ‰ - ì°¸ì—¬ë„
                            'rgba(168, 85, 247, 0.8)'  // ë³´ë¼ìƒ‰ - ìˆ™ì œ
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(34, 197, 94)',
                            'rgb(249, 115, 22)',
                            'rgb(168, 85, 247)'
                        ],
                        borderWidth: 2,
                        borderRadius: 8,
                        barThickness: 'flex',
                        maxBarThickness: 80
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.parsed.y;
                                    
                                    if (label === 'ì´í•´ë„' || label === 'ì°¸ì—¬ë„') {
                                        // 100ì  ë§Œì ì„ ë‹¤ì‹œ 5ì  ë§Œì ìœ¼ë¡œ í‘œì‹œ
                                        return label + ': ' + (value / 20).toFixed(1) + '/5.0';
                                    }
                                    return label + ': ' + value + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
    });
    </script>
</body>
</html>
  `
}

// ì…í•™ ì„¤ëª…íšŒ í˜ì´ì§€ í…œí”Œë¦¿
function generateAdmissionInfoHTML(data: any): string {
  const { eventTitle, eventDate, eventTime, location, agenda, benefits, targetGrade, contact } = data
  return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${eventTitle} - ì…í•™ ì„¤ëª…íšŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
      * { font-family: 'Pretendard Variable', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen py-12 px-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
            <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white p-12 text-center">
                <div class="inline-block bg-white/20 px-6 py-2 rounded-full text-sm font-bold mb-6">
                    ğŸ“ ${targetGrade || 'ì „ì²´ í•™ë…„'} ëŒ€ìƒ
                </div>
                <h1 class="text-4xl md:text-5xl font-bold mb-4">${eventTitle}</h1>
                <div class="flex flex-col md:flex-row justify-center items-center gap-4 text-xl mt-8">
                    <div class="flex items-center gap-2">
                        <span>ğŸ“…</span>
                        <span>${eventDate}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span>ğŸ•</span>
                        <span>${eventTime}</span>
                    </div>
                </div>
                <p class="text-lg mt-4 opacity-90">ğŸ“ ${location}</p>
            </div>
            
            <div class="p-10">
                <div class="mb-10">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">ğŸ“‹ ì„¤ëª…íšŒ ì•ˆë‚´</h2>
                    <div class="space-y-4">
                        ${(agenda || []).map((item: string, i: number) => `
                            <div class="flex items-start gap-4 p-5 bg-indigo-50 rounded-xl">
                                <div class="w-10 h-10 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                                    ${i + 1}
                                </div>
                                <div class="flex-1">
                                    <p class="text-gray-800 text-lg leading-relaxed">${item}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="mb-10">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6 text-center">ğŸ ì°¸ì„ í˜œíƒ</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        ${(benefits || []).map((benefit: string) => `
                            <div class="flex items-center gap-3 p-5 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200">
                                <span class="text-3xl">â­</span>
                                <span class="text-gray-800 font-medium">${benefit}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-400 to-indigo-400 rounded-2xl p-8 text-white text-center">
                    <h3 class="text-2xl font-bold mb-4">ì°¸ì„ ì‹ ì²­</h3>
                    <p class="text-lg mb-6">ì „í™” ë˜ëŠ” ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ì‹ ì²­í•˜ì„¸ìš”</p>
                    <a href="tel:${contact}" class="inline-block bg-white text-purple-600 px-10 py-4 rounded-full text-xl font-bold hover:bg-gray-100 transition">
                        ğŸ“ ${contact}
                    </a>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
  `
}

// í•™ì› ì„±ê³¼ í†µê³„ í˜ì´ì§€ í…œí”Œë¦¿
function generateAcademyStatsHTML(data: any): string {
  const { academyName, period, totalStudents, achievements, testimonials, gradeImprovement, reEnrollmentRate, collegeAdmissions, topGradeStudents } = data
  const achievementsList = Array.isArray(achievements) ? achievements : (achievements ? achievements.split('\n').filter((a: string) => a.trim()) : [])
  const testimonialsList = Array.isArray(testimonials) ? testimonials : (testimonials ? testimonials.split('\n').filter((t: string) => t.trim()) : [])
  
  return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${academyName} - ì„±ê³¼ í†µê³„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
      * { font-family: 'Pretendard Variable', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 py-8 px-4">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">${academyName}</h1>
            <p class="text-xl text-blue-600 font-semibold">${period} ì„±ê³¼ ë³´ê³ ì„œ</p>
        </div>
        
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow p-6 text-center border-t-4 border-blue-500">
                <div class="text-3xl font-bold text-gray-900 mb-1">${totalStudents || 0}ëª…</div>
                <div class="text-sm text-gray-600">ì´ ì¬í•™ìƒ</div>
            </div>
            <div class="bg-white rounded-xl shadow p-6 text-center border-t-4 border-green-500">
                <div class="text-3xl font-bold text-gray-900 mb-1">${gradeImprovement || '2'}ë“±ê¸‰â†‘</div>
                <div class="text-sm text-gray-600">í‰ê·  í–¥ìƒ</div>
            </div>
            <div class="bg-white rounded-xl shadow p-6 text-center border-t-4 border-purple-500">
                <div class="text-3xl font-bold text-gray-900 mb-1">${reEnrollmentRate || '95%'}</div>
                <div class="text-sm text-gray-600">ì¬ë“±ë¡ë¥ </div>
            </div>
            <div class="bg-white rounded-xl shadow p-6 text-center border-t-4 border-orange-500">
                <div class="text-3xl font-bold text-gray-900 mb-1">${topGradeStudents || '30'}ëª…</div>
                <div class="text-sm text-gray-600">1ë“±ê¸‰ ë‹¬ì„±</div>
            </div>
        </div>
        
        ${collegeAdmissions ? `
        <!-- College Admissions -->
        <div class="bg-blue-50 rounded-xl p-6 mb-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-1">ğŸ“ ëª…ë¬¸ëŒ€ í•©ê²©</h3>
                    <p class="text-gray-600">ìš°ë¦¬ í•™ì›ì˜ ìë‘ìŠ¤ëŸ¬ìš´ ì„±ê³¼ì…ë‹ˆë‹¤</p>
                </div>
                <div class="text-4xl font-bold text-blue-600">${collegeAdmissions}ëª…</div>
            </div>
        </div>
        ` : ''}
        
        <!-- Achievements -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 pb-3 border-b-2 border-blue-600">ğŸ† ì£¼ìš” ì„±ê³¼</h2>
            <div class="space-y-3">
                ${achievementsList.map((ach: string) => `
                    <div class="flex items-start gap-3 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                        <span class="text-yellow-600 text-xl">âœ“</span>
                        <p class="text-gray-700 leading-relaxed">${ach}</p>
                    </div>
                `).join('')}
            </div>
        </div>
        
        <!-- Testimonials -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 pb-3 border-b-2 border-green-600">ğŸ’¬ í•™ë¶€ëª¨ í›„ê¸°</h2>
            <div class="space-y-4">
                ${testimonialsList.map((test: string) => `
                    <div class="bg-green-50 rounded-lg p-5 border border-green-200">
                        <div class="flex items-center gap-2 mb-2">
                            <div class="flex text-yellow-500">
                                ${'â˜…'.repeat(5)}
                            </div>
                        </div>
                        <p class="text-gray-700 leading-relaxed">"${test}"</p>
                    </div>
                `).join('')}
            </div>
        </div>
    </div>
</body>
</html>
  `
}

// ì„ ìƒë‹˜ ì†Œê°œ í˜ì´ì§€ í…œí”Œë¦¿
function generateTeacherIntroHTML(data: any): string {
  const { teacherName, subject, experience, education, specialty, achievements, teachingStyle, contact, teacherPhoto } = data
  const achievementsList = Array.isArray(achievements) ? achievements : (achievements ? achievements.split('\n').filter((a: string) => a.trim()) : [])
  
  return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${teacherName} ì„ ìƒë‹˜ - ì†Œê°œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
      * { font-family: 'Pretendard Variable', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen py-8 px-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <!-- Header -->
            <div class="bg-teal-600 text-white p-8 text-center">
                ${teacherPhoto ? `
                <div class="w-32 h-32 mx-auto mb-4 rounded-full overflow-hidden bg-white">
                    <img src="${teacherPhoto}" alt="${teacherName}" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-6xl\\'>ğŸ‘¨â€ğŸ«</div>'">
                </div>
                ` : `
                <div class="w-32 h-32 bg-white/20 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <span class="text-6xl">ğŸ‘¨â€ğŸ«</span>
                </div>
                `}
                <h1 class="text-3xl font-bold mb-2">${teacherName} ì„ ìƒë‹˜</h1>
                <p class="text-xl opacity-90">${subject} ì „ë¬¸</p>
                <div class="mt-4 inline-block bg-white/20 px-4 py-2 rounded-full">
                    <span class="font-medium">ê²½ë ¥ ${experience}ë…„</span>
                </div>
            </div>
            
            <div class="p-8">
                <!-- Education -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-3 pb-2 border-b-2 border-teal-600">ğŸ“ í•™ë ¥</h2>
                    <div class="bg-teal-50 rounded-lg p-5 border border-teal-100">
                        <p class="text-gray-700 leading-relaxed">${education}</p>
                    </div>
                </div>
                
                <!-- Specialty -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-3 pb-2 border-b-2 border-teal-600">ğŸ’¡ ì „ë¬¸ ë¶„ì•¼</h2>
                    <div class="bg-blue-50 rounded-lg p-5 border border-blue-100">
                        <p class="text-gray-700 leading-relaxed">${specialty}</p>
                    </div>
                </div>
                
                <!-- Achievements -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-3 pb-2 border-b-2 border-teal-600">ğŸ† ì£¼ìš” ì‹¤ì </h2>
                    <div class="space-y-3">
                        ${achievementsList.map((ach: string) => `
                            <div class="flex items-start gap-3 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400">
                                <span class="text-yellow-600 text-xl">âœ“</span>
                                <span class="text-gray-700">${ach}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Teaching Style -->
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-3 pb-2 border-b-2 border-teal-600">ğŸ“š ìˆ˜ì—… ë°©ì‹</h2>
                    <div class="bg-gray-50 rounded-lg p-5 border border-gray-200">
                        <p class="text-gray-700 leading-relaxed">${teachingStyle}</p>
                    </div>
                </div>
                
                <!-- Contact -->
                ${contact ? `
                <div class="bg-teal-600 rounded-xl p-6 text-white text-center">
                    <h3 class="text-lg font-bold mb-3">ìˆ˜ì—… ë¬¸ì˜</h3>
                    <a href="tel:${contact}" class="inline-block bg-white text-teal-600 px-8 py-3 rounded-lg font-bold hover:bg-gray-100 transition">
                        ğŸ“ ${contact}
                    </a>
                </div>
                ` : ''}
            </div>
        </div>
    </div>
</body>
</html>
  `
}

// ë°©í•™ íŠ¹ê°• ì•ˆë‚´ í…œí”Œë¦¿
function generateVacationCourseHTML(data: any): string {
  const {
    academyName,
    courseName,
    period,
    schedule,
    programs,
    curriculum,
    contact,
    targetGrade,
    features,
    tuition,
    earlyBirdDiscount,
    placeUrl
  } = data
  
  // ë°°ì—´ ë³€í™˜
  const programsList = Array.isArray(programs) ? programs : (programs ? programs.split('\n').filter((p: string) => p.trim()) : [])
  const curriculumList = Array.isArray(curriculum) ? curriculum : (curriculum ? curriculum.split('\n').filter((c: string) => c.trim()) : [])
  const featuresList = Array.isArray(features) ? features : (features ? features.split('\n').filter((f: string) => f.trim()) : [])
  
  return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${courseName} - ${academyName}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Hero Section */
        .hero {
            background: white;
            border-radius: 30px;
            padding: 3rem;
            margin: 2rem 0;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hero-content {
            position: relative;
            z-index: 1;
        }
        
        .hero h1 {
            font-size: 2.5rem;
            font-weight: 900;
            color: #667eea;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .hero .academy-name {
            font-size: 1.5rem;
            color: #555;
            margin-bottom: 1rem;
            font-weight: 700;
        }
        
        .hero .badge {
            display: inline-block;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            margin: 1rem 0;
            box-shadow: 0 10px 25px rgba(245, 87, 108, 0.3);
        }
        
        .hero .period {
            font-size: 1.3rem;
            color: #764ba2;
            font-weight: 700;
            margin-top: 1.5rem;
        }
        
        /* Section Styles */
        .section {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            margin: 2rem 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        
        .section-title {
            font-size: 2rem;
            font-weight: 900;
            color: #667eea;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            padding-bottom: 1rem;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        
        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .info-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #e0e7ff;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }
        
        .info-card .icon {
            font-size: 2.5rem;
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .info-card .label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .info-card .value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #333;
        }
        
        /* Program List */
        .program-list {
            display: grid;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .program-item {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 1.5rem;
            border-radius: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 5px 15px rgba(253, 203, 110, 0.3);
            transition: transform 0.3s;
        }
        
        .program-item:hover {
            transform: translateX(10px);
        }
        
        .program-number {
            flex-shrink: 0;
            width: 50px;
            height: 50px;
            background: white;
            color: #fdcb6e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 900;
            margin-right: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .program-text {
            flex: 1;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3436;
        }
        
        /* Curriculum Timeline */
        .curriculum-timeline {
            position: relative;
            padding-left: 2rem;
            margin: 2rem 0;
        }
        
        .curriculum-timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        
        .curriculum-item {
            position: relative;
            padding: 1.5rem;
            background: #f8f9ff;
            border-radius: 15px;
            margin-bottom: 1.5rem;
            margin-left: 2rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        
        .curriculum-item::before {
            content: '';
            position: absolute;
            left: -3rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: white;
            border: 4px solid #667eea;
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.2);
        }
        
        .curriculum-item .week {
            display: inline-block;
            background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }
        
        .curriculum-item .content {
            font-size: 1.05rem;
            color: #333;
            line-height: 1.7;
        }
        
        /* Feature Cards */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            transition: transform 0.3s;
            border: 3px solid #4dd0e1;
        }
        
        .feature-card:hover {
            transform: translateY(-10px);
        }
        
        .feature-card .icon {
            font-size: 3rem;
            color: #00838f;
            margin-bottom: 1rem;
        }
        
        .feature-card .text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #00695c;
            line-height: 1.5;
        }
        
        /* Price Section */
        .price-section {
            background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%);
            color: white;
            padding: 2.5rem;
            border-radius: 20px;
            text-align: center;
            margin: 2rem 0;
            box-shadow: 0 15px 40px rgba(86, 171, 47, 0.3);
        }
        
        .price-section h2 {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 1.5rem;
        }
        
        .price {
            font-size: 3rem;
            font-weight: 900;
            margin: 1rem 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .early-bird {
            background: rgba(255,255,255,0.3);
            padding: 1rem 2rem;
            border-radius: 15px;
            margin-top: 1.5rem;
            font-size: 1.2rem;
            font-weight: 700;
            backdrop-filter: blur(10px);
        }
        
        /* CTA Section */
        .cta-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            margin: 2rem 0;
            box-shadow: 0 15px 40px rgba(245, 87, 108, 0.4);
        }
        
        .cta-section h2 {
            color: white;
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .cta-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .cta-button {
            display: inline-block;
            background: white;
            color: #f5576c;
            padding: 1.2rem 2.5rem;
            border-radius: 50px;
            font-size: 1.3rem;
            font-weight: 700;
            text-decoration: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .cta-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }
        
        .cta-button i {
            margin-right: 0.5rem;
        }
        
        /* Footer */
        footer {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 2rem;
            text-align: center;
            border-radius: 20px;
            margin: 2rem 0;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Hero Section -->
        <div class="hero">
            <div class="hero-content">
                <div class="academy-name">${academyName}</div>
                <h1>ğŸ“ ${courseName}</h1>
                <div class="badge">ğŸ”¥ íŠ¹ê°• ëª¨ì§‘ ì¤‘</div>
                <div class="period">
                    <i class="fas fa-calendar-alt"></i> ${period}
                </div>
            </div>
        </div>

        <!-- ê¸°ë³¸ ì •ë³´ -->
        <div class="section">
            <h2 class="section-title"><i class="fas fa-info-circle"></i> íŠ¹ê°• ê°œìš”</h2>
            <div class="info-grid">
                ${targetGrade ? `
                <div class="info-card">
                    <div class="icon"><i class="fas fa-users"></i></div>
                    <div class="label">ëŒ€ìƒ</div>
                    <div class="value">${targetGrade}</div>
                </div>
                ` : ''}
                <div class="info-card">
                    <div class="icon"><i class="fas fa-clock"></i></div>
                    <div class="label">ìˆ˜ì—… ì‹œê°„</div>
                    <div class="value">${schedule}</div>
                </div>
                <div class="info-card">
                    <div class="icon"><i class="fas fa-calendar-check"></i></div>
                    <div class="label">ê¸°ê°„</div>
                    <div class="value">${period}</div>
                </div>
            </div>
        </div>

        ${programsList.length > 0 ? `
        <!-- íŠ¹ê°• í”„ë¡œê·¸ë¨ -->
        <div class="section">
            <h2 class="section-title"><i class="fas fa-book-open"></i> íŠ¹ê°• í”„ë¡œê·¸ë¨</h2>
            <div class="program-list">
                ${programsList.map((program: string, index: number) => `
                <div class="program-item">
                    <div class="program-number">${index + 1}</div>
                    <div class="program-text">${program}</div>
                </div>
                `).join('')}
            </div>
        </div>
        ` : ''}

        ${curriculumList.length > 0 ? `
        <!-- ì»¤ë¦¬í˜ëŸ¼ -->
        <div class="section">
            <h2 class="section-title"><i class="fas fa-list-ol"></i> ì£¼ì°¨ë³„ ì»¤ë¦¬í˜ëŸ¼</h2>
            <div class="curriculum-timeline">
                ${curriculumList.map((item: string, index: number) => `
                <div class="curriculum-item">
                    <div class="week">${index + 1}ì£¼ì°¨</div>
                    <div class="content">${item}</div>
                </div>
                `).join('')}
            </div>
        </div>
        ` : ''}

        ${featuresList.length > 0 ? `
        <!-- íŠ¹ê°• íŠ¹ì§• -->
        <div class="section">
            <h2 class="section-title"><i class="fas fa-star"></i> íŠ¹ê°• íŠ¹ì§•</h2>
            <div class="feature-grid">
                ${featuresList.map((feature: string) => `
                <div class="feature-card">
                    <div class="icon"><i class="fas fa-check-circle"></i></div>
                    <div class="text">${feature}</div>
                </div>
                `).join('')}
            </div>
        </div>
        ` : ''}

        ${tuition ? `
        <!-- ìˆ˜ê°•ë£Œ -->
        <div class="price-section">
            <h2>ğŸ’° ìˆ˜ê°•ë£Œ</h2>
            <div class="price">${tuition}</div>
            ${earlyBirdDiscount ? `
            <div class="early-bird">
                ğŸ ì¡°ê¸° ë“±ë¡ í˜œíƒ: ${earlyBirdDiscount}
            </div>
            ` : ''}
        </div>
        ` : ''}

        <!-- CTA Section -->
        <div class="cta-section">
            <h2>ì§€ê¸ˆ ë°”ë¡œ ì‹ ì²­í•˜ì„¸ìš”!</h2>
            <div class="cta-buttons">
                <a href="tel:${contact}" class="cta-button">
                    <i class="fas fa-phone"></i>ì „í™” ë¬¸ì˜
                </a>
                ${placeUrl ? `
                <a href="${placeUrl}" target="_blank" rel="noopener noreferrer" class="cta-button">
                    <i class="fas fa-map-marker-alt"></i>ì˜¤ì‹œëŠ” ê¸¸
                </a>
                ` : ''}
            </div>
            <p style="margin-top: 2rem; font-size: 1.1rem; color: white; opacity: 0.95;">
                ğŸ“ ${contact}
            </p>
        </div>

        <!-- Footer -->
        <footer>
            <p>&copy; 2026 ${academyName}. All rights reserved.</p>
        </footer>
    </div>
</body>
</html>
  `
}

// ============================================
// í¼ ê´€ë¦¬ API
// ============================================

// í¼ ìƒì„±
app.post('/api/forms/create', async (c) => {
  try {
    const { userId, name, description, fields, termsText, successMessage, customHtml, headerScript, pixelScript } = await c.req.json()
    
    if (!userId || !name) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)
    }

    // ì‚¬ìš©ìì˜ academy_id ê°€ì ¸ì˜¤ê¸°
    const user = await c.env.DB.prepare('SELECT academy_id FROM users WHERE id = ?').bind(userId).first()
    const academyId = user?.academy_id || userId
    
    const result = await c.env.DB.prepare(`
      INSERT INTO forms (academy_id, name, description, fields, custom_html, header_script, pixel_script, terms_text, success_message)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      academyId,
      name,
      description || '',
      JSON.stringify(fields || []),
      customHtml || '',
      headerScript || '',
      pixelScript || '',
      termsText || 'ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.',
      successMessage || 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!'
    ).run()
    
    return c.json({ 
      success: true, 
      message: 'í¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      formId: result.meta.last_row_id
    })
  } catch (err) {
    console.error('Form creation error:', err)
    return c.json({ success: false, error: 'í¼ ìƒì„± ì‹¤íŒ¨: ' + (err as Error).message }, 500)
  }
})

// í¼ ëª©ë¡ ì¡°íšŒ
app.get('/api/forms/list', async (c) => {
  try {
    // X-User-Data-Base64 í—¤ë”ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const userDataHeader = c.req.header('X-User-Data-Base64')
    let userId = null
    
    if (userDataHeader) {
      try {
        const decoded = atob(userDataHeader)
        const userData = JSON.parse(decoded)
        userId = userData.id
      } catch (e) {
        console.error('Failed to decode user data:', e)
      }
    }
    
    if (!userId) {
      userId = c.req.query('userId')
    }
    
    if (!userId) {
      return c.json({ success: false, error: 'userIdê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    // ì‚¬ìš©ìì˜ academy_id ê°€ì ¸ì˜¤ê¸°
    const user = await c.env.DB.prepare('SELECT academy_id FROM users WHERE id = ?').bind(userId).first()
    const academyId = user?.academy_id || userId

    const forms = await c.env.DB.prepare(`
      SELECT * FROM forms WHERE academy_id = ? ORDER BY created_at DESC
    `).bind(academyId).all()
    
    return c.json({ success: true, forms: forms.results || [] })
  } catch (err) {
    console.error('Forms list error:', err)
    return c.json({ success: false, error: 'í¼ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// í¼ ìƒì„¸ ì¡°íšŒ
app.get('/api/forms/:id', async (c) => {
  try {
    const formId = c.req.param('id')
    
    const form = await c.env.DB.prepare(`
      SELECT * FROM forms WHERE id = ?
    `).bind(formId).first()
    
    if (!form) {
      return c.json({ success: false, error: 'í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    return c.json({ success: true, form })
  } catch (err) {
    console.error('Form detail error:', err)
    return c.json({ success: false, error: 'í¼ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// í¼ ìˆ˜ì •
app.put('/api/forms/:id', async (c) => {
  try {
    const formId = c.req.param('id')
    const { name, description, fields, termsText, successMessage, customHtml, headerScript, pixelScript } = await c.req.json()
    
    await c.env.DB.prepare(`
      UPDATE forms 
      SET name = ?, 
          description = ?, 
          fields = ?, 
          terms_text = ?,
          success_message = ?,
          custom_html = ?, 
          header_script = ?,
          pixel_script = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(
      name, 
      description || '', 
      JSON.stringify(fields || []), 
      termsText || 'ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.',
      successMessage || 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!',
      customHtml || '', 
      headerScript || '',
      pixelScript || '',
      formId
    ).run()
    
    return c.json({ success: true, message: 'í¼ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Form update error:', err)
    return c.json({ success: false, error: 'í¼ ìˆ˜ì • ì‹¤íŒ¨' }, 500)
  }
})

// í¼ ì‚­ì œ
app.delete('/api/forms/:id', async (c) => {
  try {
    const formId = c.req.param('id')
    
    await c.env.DB.prepare(`DELETE FROM forms WHERE id = ?`).bind(formId).run()
    
    return c.json({ success: true, message: 'í¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Form delete error:', err)
    return c.json({ success: false, error: 'í¼ ì‚­ì œ ì‹¤íŒ¨' }, 500)
  }
})

// í¼ HTML ê°€ì ¸ì˜¤ê¸°
app.get('/api/forms/:id/html', async (c) => {
  try {
    const formId = c.req.param('id')
    
    const form = await c.env.DB.prepare(`
      SELECT * FROM forms WHERE id = ?
    `).bind(formId).first()
    
    if (!form) {
      return c.json({ success: false, error: 'í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // ì»¤ìŠ¤í…€ í•„ë“œ íŒŒì‹±
    let customFields = []
    try {
      customFields = form.fields ? JSON.parse(form.fields as string) : []
    } catch (e) {
      console.error('Failed to parse form fields:', e)
    }
    
    // ì»¤ìŠ¤í…€ í•„ë“œ HTML ìƒì„±
    let customFieldsHtml = ''
    for (const field of customFields) {
      const required = field.required ? 'required' : ''
      const requiredStar = field.required ? ' *' : ''
      
      if (field.type === 'textarea') {
        customFieldsHtml += `
    <div>
        <label class="block text-sm font-bold text-gray-700 mb-2">${field.label}${requiredStar}</label>
        <textarea name="custom_${field.label}" ${required} class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="${field.placeholder || ''}" rows="4"></textarea>
    </div>`
      } else if (field.type === 'select') {
        let options = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>'
        for (const opt of (field.options || [])) {
          options += `<option value="${opt}">${opt}</option>`
        }
        customFieldsHtml += `
    <div>
        <label class="block text-sm font-bold text-gray-700 mb-2">${field.label}${requiredStar}</label>
        <select name="custom_${field.label}" ${required} class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            ${options}
        </select>
    </div>`
      } else {
        const inputType = field.type || 'text'
        customFieldsHtml += `
    <div>
        <label class="block text-sm font-bold text-gray-700 mb-2">${field.label}${requiredStar}</label>
        <input type="${inputType}" name="custom_${field.label}" ${required} class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="${field.placeholder || ''}">
    </div>`
      }
    }
    
    // í¼ HTML ìƒì„±
    const formHtml = `<!-- ì‹ ì²­ í¼ ì„¹ì…˜ -->
<div class="container mx-auto px-4 py-12" id="apply-form-section">
    <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-8">
        <h2 class="text-3xl font-bold text-center mb-2 bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-pink-600">
            ğŸ“ ì‹ ì²­í•˜ê¸°
        </h2>
        <p class="text-center text-gray-600 mb-8">ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ì‹ ì²­í•´ì£¼ì„¸ìš”</p>
        
        ${form.custom_html || ''}
        
        <form id="applicationForm" class="space-y-6">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">ì´ë¦„ *</label>
                <input type="text" name="name" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="í™ê¸¸ë™">
            </div>
            
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-2">ì—°ë½ì²˜ *</label>
                <input type="tel" name="phone" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="010-1234-5678">
            </div>
            
            ${customFieldsHtml}
            
            <div class="flex items-start">
                <input type="checkbox" name="agreedToTerms" required class="mt-1 mr-3 h-5 w-5 text-purple-600 focus:ring-purple-500 border-gray-300 rounded-xl">
                <label class="text-sm text-gray-700">
                    ${form.terms_text || 'ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.'}
                </label>
            </div>
            
            <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl text-lg font-bold hover:shadow-xl transition transform hover:scale-105">
                ì‹ ì²­í•˜ê¸°
            </button>
        </form>
        
        <div id="formResult" class="hidden mt-6 p-4 rounded-xl"></div>
    </div>
</div>

<script>
document.getElementById('applicationForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const customData = {};
    for (const [key, value] of formData.entries()) {
        if (key.startsWith('custom_')) {
            customData[key.replace('custom_', '')] = value;
        }
    }
    
    const data = {
        formId: ${form.id},
        landingPageSlug: 'YOUR_LANDING_PAGE_SLUG', // ëœë”©í˜ì´ì§€ slugë¡œ êµì²´í•˜ì„¸ìš”
        name: formData.get('name'),
        phone: formData.get('phone'),
        data: customData,
        agreedToTerms: formData.get('agreedToTerms') ? 1 : 0
    };
    
    try {
        const response = await fetch('https://superplace-academy.pages.dev/api/forms/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        const resultDiv = document.getElementById('formResult');
        resultDiv.classList.remove('hidden');
        
        if (result.success) {
            resultDiv.className = 'mt-6 p-4 rounded-xl bg-green-100 border-2 border-green-500 text-green-800';
            resultDiv.innerHTML = '<p class="font-bold text-center">âœ… ${form.success_message || 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!'}</p>';
            e.target.reset();
            
            // í”½ì…€ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            ${form.pixel_script || ''}
        } else {
            resultDiv.className = 'mt-6 p-4 rounded-xl bg-red-100 border-2 border-red-500 text-red-800';
            resultDiv.innerHTML = '<p class="font-bold text-center">âŒ ' + (result.error || 'ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.') + '</p>';
        }
    } catch (error) {
        const resultDiv = document.getElementById('formResult');
        resultDiv.classList.remove('hidden');
        resultDiv.className = 'mt-6 p-4 rounded-xl bg-red-100 border-2 border-red-500 text-red-800';
        resultDiv.innerHTML = '<p class="font-bold text-center">âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    }
});
</script>`
    
    return c.json({ success: true, html: formHtml })
  } catch (err) {
    console.error('Form HTML error:', err)
    return c.json({ success: false, error: 'HTML ìƒì„± ì‹¤íŒ¨' }, 500)
  }
})

// í¼ ì œì¶œ
app.post('/api/forms/submit', async (c) => {
  try {
    const { formId, landingPageSlug, name, phone, email, data, agreedToTerms } = await c.req.json()
    
    if (!formId || !name || !agreedToTerms) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)
    }
    
    // ëœë”©í˜ì´ì§€ ID ê°€ì ¸ì˜¤ê¸°
    let landingPageId = null
    if (landingPageSlug) {
      const page = await c.env.DB.prepare('SELECT id FROM landing_pages WHERE slug = ?').bind(landingPageSlug).first()
      landingPageId = page?.id || null
    }
    
    // IP ì£¼ì†Œì™€ User Agent ê°€ì ¸ì˜¤ê¸°
    const ipAddress = c.req.header('cf-connecting-ip') || c.req.header('x-forwarded-for') || 'unknown'
    const userAgent = c.req.header('user-agent') || 'unknown'
    
    const result = await c.env.DB.prepare(`
      INSERT INTO form_submissions (form_id, landing_page_id, name, phone, email, additional_data, agreed_to_terms, ip_address, user_agent)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(formId, landingPageId, name, phone || '', email || '', JSON.stringify(data || {}), agreedToTerms ? 1 : 0, ipAddress, userAgent).run()
    
    return c.json({ 
      success: true, 
      message: 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      submissionId: result.meta.last_row_id
    })
  } catch (err) {
    console.error('Form submission error:', err)
    return c.json({ success: false, error: 'ì‹ ì²­ ì‹¤íŒ¨: ' + (err as Error).message }, 500)
  }
})

// í¼ ì œì¶œ ë‚´ì—­ ì¡°íšŒ
app.get('/api/forms/:id/submissions', async (c) => {
  try {
    const formId = c.req.param('id')
    
    const submissions = await c.env.DB.prepare(`
      SELECT * FROM form_submissions WHERE form_id = ? ORDER BY created_at DESC
    `).bind(formId).all()
    
    return c.json({ success: true, submissions: submissions.results || [] })
  } catch (err) {
    console.error('Form submissions error:', err)
    return c.json({ success: false, error: 'ì œì¶œ ë‚´ì—­ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// Forms Submissions í˜ì´ì§€
app.get('/forms/:id/submissions', async (c) => {
  const formId = c.req.param('id')
  
  return c.html(`<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¼ ì œì¶œ ë‚´ì—­ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b-4 border-purple-600">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/tools/form-manager" class="text-gray-700 hover:text-purple-600">í¼ ê´€ë¦¬</a>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center gap-2 text-sm text-gray-600 mb-4">
                <a href="/tools/form-manager" class="hover:text-purple-600">í¼ ê´€ë¦¬</a>
                <i class="fas fa-chevron-right text-xs"></i>
                <span id="formTitle" class="text-gray-900 font-medium">ì œì¶œ ë‚´ì—­</span>
            </div>
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        <i class="fas fa-paper-plane text-purple-600 mr-3"></i>í¼ ì œì¶œ ë‚´ì—­
                    </h1>
                    <p class="text-gray-600">ì´ í¼ì„ í†µí•´ ì œì¶œëœ ë°ì´í„° ëª©ë¡ì…ë‹ˆë‹¤</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-600 mb-1">ì´ ì œì¶œ</div>
                    <div id="totalCount" class="text-3xl font-bold text-purple-600">0</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 mb-6">
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..." 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <button onclick="exportToCSV()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                    <i class="fas fa-file-excel"></i>
                    CSV ë‹¤ìš´ë¡œë“œ
                </button>
                <button onclick="loadSubmissions()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i>
                    ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
        </div>

        <!-- Submissions Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ë²ˆí˜¸</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ì´ë¦„</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ì—°ë½ì²˜</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ì´ë©”ì¼</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ì¶”ê°€ì •ë³´</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ì œì¶œì¼ì‹œ</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTableBody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16">
            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">ì•„ì§ ì œì¶œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-gray-500 mb-6">ì´ í¼ìœ¼ë¡œ ë°ì´í„°ê°€ ì œì¶œë˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
            <a href="/tools/form-manager" class="inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                <i class="fas fa-arrow-left mr-2"></i>í¼ ê´€ë¦¬ë¡œ ëŒì•„ê°€ê¸°
            </a>
        </div>
    </div>

    <script>
        let allSubmissions = [];
        const formId = ${formId};
        
        // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function formatKoreanTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            // UTC ì‹œê°„ì„ KST (UTC+9)ë¡œ ë³€í™˜
            const kstDate = new Date(date.getTime() + (9 * 60 * 60 * 1000));
            return kstDate.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        async function loadSubmissions() {
            try {
                const response = await fetch(\`/api/forms/\${formId}/submissions\`);
                const result = await response.json();
                
                if (!result.success) {
                    alert(result.error || 'ì œì¶œ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                allSubmissions = result.submissions || [];
                
                if (result.form) {
                    document.getElementById('formTitle').textContent = result.form.name;
                    document.title = result.form.name + ' - ì œì¶œ ë‚´ì—­';
                }
                
                document.getElementById('totalCount').textContent = allSubmissions.length;
                
                renderSubmissions(allSubmissions);
            } catch (err) {
                console.error('Error loading submissions:', err);
                alert('ì œì¶œ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function renderSubmissions(submissions) {
            const tbody = document.getElementById('submissionsTableBody');
            const emptyState = document.getElementById('emptyState');
            const table = tbody.closest('.bg-white');
            
            if (submissions.length === 0) {
                table.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            table.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            tbody.innerHTML = submissions.map((sub, index) => {
                const additionalData = sub.additional_data ? JSON.parse(sub.additional_data) : {};
                const additionalDataStr = Object.entries(additionalData)
                    .map(([key, value]) => \`\${key}: \${value}\`)
                    .join('<br>') || '-';
                
                return \`
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-900">\${submissions.length - index}</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">\${sub.name}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">\${sub.phone || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600">\${sub.email || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-xs text-gray-600">\${additionalDataStr}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">\${formatKoreanTime(sub.created_at)}</div>
                        </td>
                    </tr>
                \`;
            }).join('');
        }

        function exportToCSV() {
            if (allSubmissions.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const BOM = "\\uFEFF";
            const headers = ['ë²ˆí˜¸', 'ì´ë¦„', 'ì—°ë½ì²˜', 'ì´ë©”ì¼', 'ì¶”ê°€ì •ë³´', 'ì œì¶œì¼ì‹œ'];
            const rows = allSubmissions.map((sub, index) => {
                const additionalData = sub.additional_data ? JSON.parse(sub.additional_data) : {};
                const additionalDataStr = Object.entries(additionalData)
                    .map(([key, value]) => \`\${key}: \${value}\`)
                    .join('; ') || '-';
                
                return [
                    allSubmissions.length - index,
                    sub.name,
                    sub.phone || '-',
                    sub.email || '-',
                    additionalDataStr,
                    formatKoreanTime(sub.created_at)
                ];
            });

            const csv = BOM + [headers, ...rows]
                .map(row => row.map(cell => \`"\${String(cell).replace(/"/g, '""')}"\`).join(','))
                .join('\\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = \`í¼_ì œì¶œë‚´ì—­_\${formId}_\${new Date().toISOString().split('T')[0]}.csv\`;
            link.click();
        }

        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('loginTime');
            window.location.href = '/';
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allSubmissions.filter(sub => {
                return (sub.name && sub.name.toLowerCase().includes(searchTerm)) ||
                       (sub.phone && sub.phone.includes(searchTerm)) ||
                       (sub.email && sub.email.toLowerCase().includes(searchTerm));
            });
            renderSubmissions(filtered);
        });

        // Load on page load
        loadSubmissions();
    </script>
</body>
</html>`)
})


// QR ì½”ë“œ ìƒì„± API
app.get('/api/landing/:slug/qr', async (c) => {
  try {
    const slug = c.req.param('slug')
    const size = c.req.query('size') || '300'
    
    // ëœë”©í˜ì´ì§€ ì¡´ì¬ í™•ì¸
    const page = await c.env.DB.prepare('SELECT id, slug, title FROM landing_pages WHERE slug = ?').bind(slug).first()
    
    if (!page) {
      return c.json({ success: false, error: 'Landing page not found' }, 404)
    }
    
    const landingUrl = `${new URL(c.req.url).origin}/landing/${slug}`
    
    // QR ì½”ë“œ ìƒì„± (Google Chart API ì‚¬ìš©)
    const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chl=${encodeURIComponent(landingUrl)}&choe=UTF-8`
    
    return c.json({ 
      success: true, 
      qrCodeUrl: qrUrl,
      landingUrl: landingUrl,
      title: page.title
    })
  } catch (err) {
    console.error('QR generation error:', err)
    return c.json({ success: false, error: 'QR ìƒì„± ì‹¤íŒ¨' }, 500)
  }
})

// ëœë”©í˜ì´ì§€ë³„ ì‹ ì²­ì ëª©ë¡ ì¡°íšŒ API
app.get('/api/landing/:slug/submissions', async (c) => {
  try {
    const slug = c.req.param('slug')
    
    // Base64 ì¸ì½”ë”©ëœ ì‚¬ìš©ì ë°ì´í„° ë””ì½”ë”©
    const userHeaderBase64 = c.req.header('X-User-Data-Base64')
    let user = { id: 1 }
    if (userHeaderBase64) {
      try {
        const userDataStr = atob(userHeaderBase64)
        user = JSON.parse(userDataStr)
      } catch (e) {
        console.warn('Failed to decode user data:', e)
      }
    }
    
    // ëœë”©í˜ì´ì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const page = await c.env.DB.prepare(`
      SELECT id, title, user_id, form_id FROM landing_pages WHERE slug = ?
    `).bind(slug).first()
    
    if (!page) {
      return c.json({ success: false, error: 'Landing page not found' }, 404)
    }
    
    // ì†Œìœ ì í™•ì¸
    if (page.user_id !== user.id) {
      return c.json({ success: false, error: 'Unauthorized' }, 403)
    }
    
    // ì‹ ì²­ì ëª©ë¡ ì¡°íšŒ
    const submissions = await c.env.DB.prepare(`
      SELECT 
        id, name, phone, email, additional_data, 
        created_at, ip_address, user_agent
      FROM form_submissions 
      WHERE landing_page_id = ? 
      ORDER BY created_at DESC
    `).bind(page.id).all()
    
    return c.json({ 
      success: true, 
      landingPage: {
        id: page.id,
        title: page.title,
        slug: slug
      },
      submissions: submissions.results || [],
      total: submissions.results?.length || 0
    })
  } catch (err) {
    console.error('Submissions fetch error:', err)
    return c.json({ success: false, error: 'ì‹ ì²­ì ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})


// AI í•™ë¶€ëª¨ ë©”ì‹œì§€ ìƒì„± API
app.post('/api/generate-parent-message', async (c) => {
  try {
    const { studentName, grade, subject, shortMessage } = await c.req.json()
    
    if (!studentName || !grade || !subject || !shortMessage) {
      return c.json({ success: false, error: 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // í…œí”Œë¦¿ ê¸°ë°˜ ë©”ì‹œì§€ ìƒì„± (í˜„ì¬ëŠ” API í‚¤ ì—†ì´ ì‘ë™)
    const templateMessage = generateTemplateMessage(studentName, grade, subject, shortMessage)
    return c.json({ 
      success: true, 
      message: templateMessage,
      metadata: {
        studentName,
        grade,
        subject,
        originalMessage: shortMessage,
        mode: 'template'
      }
    })

    // API í‚¤ê°€ ìˆìœ¼ë©´ ì‹¤ì œ AI í˜¸ì¶œ
    try {
      const response = await fetch(`${baseURL}/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-5-mini',
          messages: [
            {
              role: 'system',
              content: `ë‹¹ì‹ ì€ í•™ì› ì›ì¥ë‹˜ì…ë‹ˆë‹¤. í•™ë¶€ëª¨ë‹˜ê»˜ í•™ìƒì˜ í•™ìŠµ í˜„í™©ì„ ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” ë§íˆ¬ë¡œ ì „ë‹¬í•˜ëŠ” ë©”ì‹œì§€ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

ê·œì¹™:
1. ì¡´ëŒ“ë§ ì‚¬ìš© (í•™ë¶€ëª¨ë‹˜ê»˜)
2. ë”°ëœ»í•˜ê³  ê¸ì •ì ì¸ í†¤
3. êµ¬ì²´ì ì¸ ì¹­ì°¬ í¬í•¨
4. ì•ìœ¼ë¡œì˜ í•™ìŠµ ë°©í–¥ ì œì‹œ
5. 200-300ì ì •ë„ì˜ ì ì ˆí•œ ê¸¸ì´
6. ì´ëª¨ì§€ 2-3ê°œ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©
7. í•™ë¶€ëª¨ë‹˜ì´ ì•ˆì‹¬í•˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë‚´ìš©`
            },
            {
              role: 'user',
              content: `í•™ìƒ ì´ë¦„: ${studentName}
í•™ë…„: ${grade}
ê³¼ëª©: ${subject}
ì›ì¥ë‹˜ì˜ ì§§ì€ ë©”ëª¨: ${shortMessage}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ë¶€ëª¨ë‹˜ê»˜ ë³´ë‚¼ ë”°ëœ»í•œ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.`
            }
          ],
          temperature: 0.8,
          max_tokens: 500
        })
      })

      const data = await response.json()
      
      if (!response.ok) {
        console.error('OpenAI API error:', data)
        // API ì˜¤ë¥˜ ì‹œ í…œí”Œë¦¿ ë©”ì‹œì§€ë¡œ í´ë°±
        const templateMessage = generateTemplateMessage(studentName, grade, subject, shortMessage)
        return c.json({ 
          success: true, 
          message: templateMessage,
          metadata: {
            studentName,
            grade,
            subject,
            originalMessage: shortMessage,
            mode: 'template_fallback'
          }
        })
      }

      const generatedMessage = data.choices[0]?.message?.content || ''

      return c.json({ 
        success: true, 
        message: generatedMessage,
        metadata: {
          studentName,
          grade,
          subject,
          originalMessage: shortMessage,
          mode: 'ai'
        }
      })
    } catch (apiError) {
      console.error('API call error:', apiError)
      // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ í…œí”Œë¦¿ ë©”ì‹œì§€ë¡œ í´ë°±
      const templateMessage = generateTemplateMessage(studentName, grade, subject, shortMessage)
      return c.json({ 
        success: true, 
        message: templateMessage,
        metadata: {
          studentName,
          grade,
          subject,
          originalMessage: shortMessage,
          mode: 'template_fallback'
        }
      })
    }
  } catch (err) {
    console.error('Generate message error:', err)
    return c.json({ success: false, error: 'ë©”ì‹œì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// í•™ìƒ ê¸°ë¡ ê¸°ë°˜ í•™ë¶€ëª¨ ë©”ì‹œì§€ ìƒì„± API (ì‹ ê·œ)
app.post('/api/generate-parent-message-from-records', async (c) => {
  try {
    const { studentId, studentName, grade, subjects, parentName, records, additionalMessage } = await c.req.json()
    
    if (!studentId || !studentName) {
      return c.json({ success: false, error: 'í•™ìƒ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    // ê¸°ë¡ ë¶„ì„
    const recordsSummary = analyzeRecords(records)
    
    // AI í”„ë¡¬í”„íŠ¸ ìƒì„±
    const aiPrompt = generateAIPrompt(studentName, grade, subjects, parentName, recordsSummary, additionalMessage)
    
    // OpenAI API í˜¸ì¶œ (í™˜ê²½ ë³€ìˆ˜ì— API í‚¤ê°€ ìˆìœ¼ë©´)
    const apiKey = c.env.OPENAI_API_KEY
    const baseURL = c.env.OPENAI_BASE_URL || 'https://api.openai.com/v1'

    if (apiKey) {
      try {
        const response = await fetch(`${baseURL}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: 'gpt-4o-mini',
            messages: [
              {
                role: 'system',
                content: `ë‹¹ì‹ ì€ í•™ì› ì›ì¥ë‹˜ì…ë‹ˆë‹¤. í•™ë¶€ëª¨ë‹˜ê»˜ í•™ìƒì˜ í•™ìŠµ í˜„í™©ì„ ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” ë§íˆ¬ë¡œ ì „ë‹¬í•˜ëŠ” ë©”ì‹œì§€ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

ê·œì¹™:
1. ì¡´ëŒ“ë§ ì‚¬ìš© (í•™ë¶€ëª¨ë‹˜ê»˜)
2. ë”°ëœ»í•˜ê³  ê¸ì •ì ì¸ í†¤
3. êµ¬ì²´ì ì¸ ë°ì´í„° ê¸°ë°˜ ì¹­ì°¬ (ì¶œì„ë¥ , ê³¼ì œ ì™„ì„±ë¥ , ì´í•´ë„ ë“±)
4. ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ë„ ê²©ë ¤ì™€ í•¨ê»˜ ì „ë‹¬
5. ì•ìœ¼ë¡œì˜ í•™ìŠµ ë°©í–¥ ì œì‹œ
6. 250-350ì ì •ë„ì˜ ì ì ˆí•œ ê¸¸ì´
7. ì´ëª¨ì§€ 2-3ê°œ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©
8. í•™ë¶€ëª¨ë‹˜ì´ ì•ˆì‹¬í•˜ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë‚´ìš©
9. ìµœê·¼ 7ì¼ê°„ì˜ êµ¬ì²´ì ì¸ í•™ìŠµ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ì‘ì„±`
              },
              {
                role: 'user',
                content: aiPrompt
              }
            ],
            temperature: 0.8,
            max_tokens: 600
          })
        })

        const data = await response.json()
        
        if (response.ok && data.choices && data.choices[0]) {
          return c.json({ 
            success: true, 
            message: data.choices[0].message.content,
            metadata: {
              studentName,
              grade,
              subjects,
              mode: 'ai',
              recordsCount: records.length
            }
          })
        }
      } catch (apiError) {
        console.error('OpenAI API error:', apiError)
        // API ì‹¤íŒ¨ ì‹œ í…œí”Œë¦¿ìœ¼ë¡œ í´ë°±
      }
    }

    // í…œí”Œë¦¿ ê¸°ë°˜ ë©”ì‹œì§€ ìƒì„± (í´ë°±)
    const templateMessage = generateTemplateMessageFromRecords(
      studentName, 
      grade, 
      subjects, 
      parentName, 
      recordsSummary, 
      additionalMessage
    )
    
    return c.json({ 
      success: true, 
      message: templateMessage,
      metadata: {
        studentName,
        grade,
        subjects,
        mode: 'template',
        recordsCount: records.length
      }
    })
  } catch (err) {
    console.error('Generate message from records error:', err)
    return c.json({ success: false, error: 'ë©”ì‹œì§€ ìƒì„± ì‹¤íŒ¨: ' + (err as Error).message }, 500)
  }
})

// ê¸°ë¡ ë¶„ì„ í•¨ìˆ˜
function analyzeRecords(records: any[]) {
  if (!records || records.length === 0) {
    return {
      totalDays: 0,
      attendanceRate: 0,
      homeworkRate: 0,
      avgUnderstanding: 0,
      avgParticipation: 0,
      achievements: [],
      memos: [],
      latestRecords: []
    }
  }

  const totalDays = records.length
  const attendanceCount = records.filter(r => r.attendance === 'ì¶œì„').length
  const homeworkCompleted = records.filter(r => r.homework_status === 'ì™„ë£Œ').length
  
  const understandingScores = records.filter(r => r.understanding_level).map(r => r.understanding_level)
  const participationScores = records.filter(r => r.participation_level).map(r => r.participation_level)
  
  const avgUnderstanding = understandingScores.length > 0 
    ? (understandingScores.reduce((a, b) => a + b, 0) / understandingScores.length).toFixed(1)
    : '0'
  
  const avgParticipation = participationScores.length > 0
    ? (participationScores.reduce((a, b) => a + b, 0) / participationScores.length).toFixed(1)
    : '0'

  const achievements = records.filter(r => r.achievement).map(r => r.achievement)
  const memos = records.filter(r => r.memo).map(r => r.memo)

  return {
    totalDays,
    attendanceRate: ((attendanceCount / totalDays) * 100).toFixed(0),
    homeworkRate: totalDays > 0 ? ((homeworkCompleted / totalDays) * 100).toFixed(0) : '0',
    avgUnderstanding,
    avgParticipation,
    achievements,
    memos,
    latestRecords: records.slice(0, 3)
  }
}

// AI í”„ë¡¬í”„íŠ¸ ìƒì„±
function generateAIPrompt(studentName: string, grade: string, subjects: string, parentName: string, summary: any, additionalMessage: string) {
  const achievementsList = summary.achievements.length > 0 
    ? `ì£¼ìš” ì„±ê³¼:\n${summary.achievements.slice(0, 3).map((a: string) => `- ${a}`).join('\n')}` 
    : ''
  
  const memosList = summary.memos.length > 0 
    ? `ì„ ìƒë‹˜ ë©”ëª¨:\n${summary.memos.slice(0, 3).map((m: string) => `- ${m}`).join('\n')}` 
    : ''
  
  const additionalPart = additionalMessage ? `ì¶”ê°€ ì „ë‹¬ ì‚¬í•­: ${additionalMessage}` : ''
  
  return `í•™ìƒ ì´ë¦„: ${studentName}
í•™ë…„: ${grade}
ê³¼ëª©: ${subjects}
í•™ë¶€ëª¨: ${parentName || 'í•™ë¶€ëª¨'} ë‹˜

ìµœê·¼ 7ì¼ê°„ í•™ìŠµ ê¸°ë¡ ë¶„ì„:
- ì´ ìˆ˜ì—… ì¼ìˆ˜: ${summary.totalDays}ì¼
- ì¶œì„ë¥ : ${summary.attendanceRate}%
- ê³¼ì œ ì™„ì„±ë¥ : ${summary.homeworkRate}%
- í‰ê·  ì´í•´ë„: ${summary.avgUnderstanding}/5ì 
- í‰ê·  ì°¸ì—¬ë„: ${summary.avgParticipation}/5ì 

${achievementsList}

${memosList}

${additionalPart}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ${parentName || 'í•™ë¶€ëª¨'} ë‹˜ê»˜ ë³´ë‚¼ ë”°ëœ»í•˜ê³  êµ¬ì²´ì ì¸ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”. 
í•™ìƒì˜ ê°•ì ì„ êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ì™€ í•¨ê»˜ ì¹­ì°¬í•˜ê³ , ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì€ ê²©ë ¤ì™€ í•¨ê»˜ ì œì‹œí•´ì£¼ì„¸ìš”.`
}

// í…œí”Œë¦¿ ê¸°ë°˜ ë©”ì‹œì§€ ìƒì„± (ê¸°ë¡ ê¸°ë°˜)
function generateTemplateMessageFromRecords(studentName: string, grade: string, subjects: string, parentName: string, summary: any, additionalMessage: string) {
  const parentTitle = parentName ? `${parentName} í•™ë¶€ëª¨ë‹˜` : 'í•™ë¶€ëª¨ë‹˜'
  
  let message = `ì•ˆë…•í•˜ì„¸ìš”, ${parentTitle}! ğŸ˜Š\n\n`
  message += `${studentName} í•™ìƒì˜ ìµœê·¼ ì¼ì£¼ì¼ í•™ìŠµ í˜„í™©ì„ ì „ë‹¬ë“œë¦½ë‹ˆë‹¤.\n\n`
  
  // ê¸ì •ì ì¸ ë¶€ë¶„ ê°•ì¡°
  if (parseInt(summary.attendanceRate) >= 80) {
    message += `âœ… ì¶œì„ë¥  ${summary.attendanceRate}%ë¡œ ì„±ì‹¤í•˜ê²Œ ìˆ˜ì—…ì— ì°¸ì—¬í•˜ê³  ìˆìŠµë‹ˆë‹¤. `
  }
  
  if (parseInt(summary.homeworkRate) >= 70) {
    message += `ê³¼ì œ ì™„ì„±ë¥ ë„ ${summary.homeworkRate}%ë¡œ ê¾¸ì¤€íˆ ê³¼ì œë¥¼ ì™„ìˆ˜í•˜ê³  ìˆì–´ìš”. `
  }
  
  if (parseFloat(summary.avgUnderstanding) >= 4.0) {
    message += `\n\níŠ¹íˆ ì´í•´ë„ê°€ ${summary.avgUnderstanding}/5ì ìœ¼ë¡œ ìˆ˜ì—… ë‚´ìš©ì„ ì˜ ì†Œí™”í•˜ê³  ìˆìŠµë‹ˆë‹¤! ğŸ‘ `
  } else if (parseFloat(summary.avgUnderstanding) >= 3.0) {
    message += `\n\nì´í•´ë„ëŠ” ${summary.avgUnderstanding}/5ì ìœ¼ë¡œ ê¾¸ì¤€íˆ ë°œì „í•˜ê³  ìˆìŠµë‹ˆë‹¤. `
  }
  
  if (parseFloat(summary.avgParticipation) >= 4.0) {
    message += `ìˆ˜ì—… ì°¸ì—¬ë„ë„ ${summary.avgParticipation}/5ì ìœ¼ë¡œ ë§¤ìš° ì ê·¹ì ì´ì—ìš”! `
  }
  
  // ì„±ê³¼ ì¶”ê°€
  if (summary.achievements.length > 0) {
    message += `\n\nğŸ¯ ìµœê·¼ ì„±ê³¼:\n${summary.achievements.slice(0, 2).map((a: string) => `- ${a}`).join('\n')}\n`
  }
  
  // ì¶”ê°€ ë©”ì‹œì§€
  if (additionalMessage) {
    message += `\n${additionalMessage}\n`
  }
  
  // ë§ˆë¬´ë¦¬ ê²©ë ¤
  message += `\nì•ìœ¼ë¡œë„ ${studentName} í•™ìƒì´ ë”ìš± ì„±ì¥í•  ìˆ˜ ìˆë„ë¡ ìµœì„ ì„ ë‹¤í•´ ì§€ë„í•˜ê² ìŠµë‹ˆë‹¤. ğŸ’ª`
  
  return message
}

// í…œí”Œë¦¿ ê¸°ë°˜ ë©”ì‹œì§€ ìƒì„± í•¨ìˆ˜
function generateTemplateMessage(studentName: string, grade: string, subject: string, shortMessage: string): string {
  const templates = [
    `ì•ˆë…•í•˜ì„¸ìš”, ${studentName} í•™ë¶€ëª¨ë‹˜! ğŸ˜Š

ì˜¤ëŠ˜ ${subject} ìˆ˜ì—…ì—ì„œ ${studentName} í•™ìƒì˜ ëª¨ìŠµì„ ì „í•´ë“œë¦½ë‹ˆë‹¤.

${shortMessage}

${studentName}ì˜ ì„±ì¥ ëª¨ìŠµì´ ì •ë§ ë³´ê¸° ì¢‹ìŠµë‹ˆë‹¤. ì•ìœ¼ë¡œë„ ì´ë ‡ê²Œ ê¾¸ì¤€íˆ ë…¸ë ¥í•œë‹¤ë©´ ${subject} ì‹¤ë ¥ì´ ë”ìš± íƒ„íƒ„í•´ì§ˆ ê²ƒì…ë‹ˆë‹¤! ğŸ’ª

í•­ìƒ ì‘ì›í•˜ê² ìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!`,
    
    `${studentName} í•™ë¶€ëª¨ë‹˜, ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹

${grade} ${subject} ìˆ˜ì—… ì†Œì‹ì„ ì „í•´ë“œë¦½ë‹ˆë‹¤.

${shortMessage}

${studentName}ì˜ ì´ëŸ¬í•œ ëª¨ìŠµì´ ì •ë§ ìë‘ìŠ¤ëŸ½ìŠµë‹ˆë‹¤. ê³„ì†í•´ì„œ ì´ëŸ° ê¸ì •ì ì¸ ìì„¸ë¡œ í•™ìŠµì— ì„í•œë‹¤ë©´ ëª©í‘œí•œ ì„±ê³¼ë¥¼ ê¼­ ì´ë£° ìˆ˜ ìˆì„ ê±°ì˜ˆìš”! ğŸ¯

ê¶ê¸ˆí•˜ì‹  ì  ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ ì£¼ì„¸ìš”!`,
    
    `í•™ë¶€ëª¨ë‹˜, ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š

ì˜¤ëŠ˜ ${studentName} í•™ìƒì˜ ${subject} ìˆ˜ì—… í˜„í™©ì„ ë§ì”€ë“œë¦½ë‹ˆë‹¤.

${shortMessage}

${studentName}ê°€ ë³´ì—¬ì¤€ ì´ëŸ° ëª¨ìŠµë“¤ì´ ì •ë§ ì¸ìƒ ê¹Šì—ˆìŠµë‹ˆë‹¤. ì´ëŒ€ë¡œë§Œ ê¾¸ì¤€íˆ ë…¸ë ¥í•œë‹¤ë©´ ${subject} ê³¼ëª©ì—ì„œ ë” í° ë°œì „ì„ ê¸°ëŒ€í•  ìˆ˜ ìˆê² ìŠµë‹ˆë‹¤! âœ¨

ì•ìœ¼ë¡œë„ ${studentName}ì˜ ì„±ì¥ì„ í•¨ê»˜ ì‘ì›í•˜ê² ìŠµë‹ˆë‹¤!`
  ]
  
  // ëœë¤í•˜ê²Œ í…œí”Œë¦¿ ì„ íƒ
  const randomIndex = Math.floor(Math.random() * templates.length)
  return templates[randomIndex]
}

// AI ë¸”ë¡œê·¸ ê¸€ ìƒì„± API
app.post('/api/generate-blog-post', async (c) => {
  try {
    const { topic, keywords, tone } = await c.req.json()
    
    if (!topic) {
      return c.json({ success: false, error: 'ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // í…œí”Œë¦¿ ê¸°ë°˜ ë¸”ë¡œê·¸ ìƒì„± (í˜„ì¬ëŠ” API í‚¤ ì—†ì´ ì‘ë™)
    const templateBlog = generateTemplateBlog(topic, keywords, tone)
    return c.json({ 
      success: true, 
      content: templateBlog,
      metadata: {
        topic,
        keywords,
        tone,
        wordCount: templateBlog.length,
        mode: 'template'
      }
    })

    // API í‚¤ê°€ ìˆìœ¼ë©´ ì‹¤ì œ AI í˜¸ì¶œ
    try {
      const response = await fetch(`${baseURL}/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-5',
          messages: [
            {
              role: 'system',
              content: `ë‹¹ì‹ ì€ í•™ì› ë§ˆì¼€íŒ… ì „ë¬¸ ë¸”ë¡œê·¸ ì‘ê°€ì…ë‹ˆë‹¤. ë„¤ì´ë²„ ë¸”ë¡œê·¸ SEOì— ìµœì í™”ëœ ê¸€ì„ ì‘ì„±í•©ë‹ˆë‹¤.

ê¸€ì“°ê¸° ì›ì¹™:
1. ì œëª©: ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ í¬í•¨í•œ ë§¤ë ¥ì ì¸ ì œëª©
2. ì„œë¡ : ë…ìì˜ ê´€ì‹¬ì„ ë„ëŠ” ê³µê° ë‚´ìš©
3. ë³¸ë¡ : êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ ì •ë³´ (3-5ê°€ì§€ í•µì‹¬ í¬ì¸íŠ¸)
4. ê²°ë¡ : í–‰ë™ì„ ìœ ë„í•˜ëŠ” ë§ˆë¬´ë¦¬
5. í‚¤ì›Œë“œ: ìì—°ìŠ¤ëŸ½ê²Œ 3-5íšŒ ë°˜ë³µ
6. ê¸¸ì´: 1500-2000ì
7. í†¤: ${tone || 'ì¹œê·¼í•˜ê³  ì „ë¬¸ì ì¸'}
8. ë¬¸ë‹¨: 3-4ë¬¸ì¥ìœ¼ë¡œ êµ¬ì„±, ê°€ë…ì„± ë†’ê²Œ
9. ì´ëª¨ì§€ ì ì ˆíˆ ì‚¬ìš©`
            },
            {
              role: 'user',
              content: `ë¸”ë¡œê·¸ ì£¼ì œ: ${topic}
${keywords ? `í¬í•¨í•  í‚¤ì›Œë“œ: ${keywords}` : ''}

ìœ„ ì£¼ì œë¡œ ë„¤ì´ë²„ ë¸”ë¡œê·¸ì— ì˜¬ë¦´ ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
ì œëª©, ì„œë¡ , ë³¸ë¡ , ê²°ë¡ ì„ ëª…í™•íˆ êµ¬ë¶„í•´ì„œ ì‘ì„±í•´ì£¼ì„¸ìš”.`
            }
          ],
          temperature: 0.9,
          max_tokens: 2500
        })
      })

      const data = await response.json()
      
      if (!response.ok) {
        console.error('OpenAI API error:', data)
        // API ì˜¤ë¥˜ ì‹œ í…œí”Œë¦¿ìœ¼ë¡œ í´ë°±
        const templateBlog = generateTemplateBlog(topic, keywords, tone)
        return c.json({ 
          success: true, 
          content: templateBlog,
          metadata: {
            topic,
            keywords,
            tone,
            wordCount: templateBlog.length,
            mode: 'template_fallback'
          }
        })
      }

      const generatedPost = data.choices[0]?.message?.content || ''

      return c.json({ 
        success: true, 
        content: generatedPost,
        metadata: {
          topic,
          keywords,
          tone,
          wordCount: generatedPost.length,
          mode: 'ai'
        }
      })
    } catch (apiError) {
      console.error('API call error:', apiError)
      // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ í…œí”Œë¦¿ìœ¼ë¡œ í´ë°±
      const templateBlog = generateTemplateBlog(topic, keywords, tone)
      return c.json({ 
        success: true, 
        content: templateBlog,
        metadata: {
          topic,
          keywords,
          tone,
          wordCount: templateBlog.length,
          mode: 'template_fallback'
        }
      })
    }
  } catch (err) {
    console.error('Generate blog post error:', err)
    return c.json({ success: false, error: 'ë¸”ë¡œê·¸ ê¸€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// í…œí”Œë¦¿ ê¸°ë°˜ ë¸”ë¡œê·¸ ìƒì„± í•¨ìˆ˜
function generateTemplateBlog(topic: string, keywords: string | undefined, tone: string | undefined): string {
  const keywordList = keywords ? keywords.split(',').map(k => k.trim()) : [topic]
  const mainKeyword = keywordList[0]
  
  return `ğŸ“Œ ${topic} - í•™ì›ì¥ì´ ì•Œë ¤ë“œë¦¬ëŠ” ì‹¤ì „ ê°€ì´ë“œ

ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ì€ ë§ì€ í•™ë¶€ëª¨ë‹˜ë“¤ì´ ê¶ê¸ˆí•´í•˜ì‹œëŠ” "${topic}"ì— ëŒ€í•´ ìƒì„¸íˆ ì•Œë ¤ë“œë¦¬ë ¤ê³  í•©ë‹ˆë‹¤. ğŸ˜Š

ì‹¤ì œ í•™ì›ì„ ìš´ì˜í•˜ë©´ì„œ ê²ªì€ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ì •ë§ ë„ì›€ì´ ë˜ëŠ” ì •ë³´ë§Œ ëª¨ì•˜ìœ¼ë‹ˆ, ëê¹Œì§€ ì½ì–´ë³´ì‹œë©´ í° ë„ì›€ì´ ë˜ì‹¤ ê±°ì˜ˆìš”!


ğŸ¯ ì™œ ${mainKeyword}ì´(ê°€) ì¤‘ìš”í• ê¹Œìš”?

ìš”ì¦˜ í•™ë¶€ëª¨ë‹˜ë“¤ê³¼ ìƒë‹´í•˜ë‹¤ ë³´ë©´ "${mainKeyword}"ì— ëŒ€í•œ ê³ ë¯¼ì´ ì •ë§ ë§ìœ¼ì‹­ë‹ˆë‹¤. ê·¸ë§Œí¼ ì¤‘ìš”í•œ ì£¼ì œì´ê¸° ë•Œë¬¸ì´ì£ .

íŠ¹íˆ ì´ˆë“±í•™ìƒë¶€í„° ê³ ë“±í•™ìƒê¹Œì§€, í•™ë…„ë³„ë¡œ ì ‘ê·¼ ë°©ë²•ì´ ë‹¤ë¥´ê¸° ë•Œë¬¸ì— ìš°ë¦¬ ì•„ì´ì—ê²Œ ë§ëŠ” ë°©ë²•ì„ ì°¾ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.


âœ¨ ${topic} - í•µì‹¬ í¬ì¸íŠ¸ 3ê°€ì§€

1ï¸âƒ£ ì²« ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸

${mainKeyword}ì„(ë¥¼) ì‹œì‘í•  ë•Œ ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ ê¸°ì´ˆë¥¼ íƒ„íƒ„íˆ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë§ì€ í•™ìƒë“¤ì´ ë¹¨ë¦¬ ì§„ë„ë¥¼ ë‚˜ê°€ë ¤ê³  í•˜ì§€ë§Œ, ê¸°ì´ˆê°€ ì•½í•˜ë©´ ë‚˜ì¤‘ì— ì–´ë ¤ì›€ì„ ê²ªê²Œ ë©ë‹ˆë‹¤.

ì‹¤ì œë¡œ ì €í¬ í•™ì›ì—ì„œë„ ê¸°ì´ˆë¶€í„° ì²´ê³„ì ìœ¼ë¡œ í•™ìŠµí•œ í•™ìƒë“¤ì´ ì¥ê¸°ì ìœ¼ë¡œ í›¨ì”¬ ì¢‹ì€ ì„±ê³¼ë¥¼ ë‚´ëŠ” ê²ƒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.


2ï¸âƒ£ ë‘ ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸

ê¾¸ì¤€í•¨ì´ ì •ë§ ì¤‘ìš”í•©ë‹ˆë‹¤. ${mainKeyword}ì€(ëŠ”) ë‹¨ê¸°ê°„ì— íš¨ê³¼ë¥¼ ë³´ê¸° ì–´ë µìŠµë‹ˆë‹¤. ìµœì†Œ 3ê°œì›” ì´ìƒ ê¾¸ì¤€íˆ í•™ìŠµí•´ì•¼ í™•ì‹¤í•œ ë³€í™”ë¥¼ ëŠë‚„ ìˆ˜ ìˆì–´ìš”.

í•˜ë£¨ 30ë¶„ì´ë¼ë„ ë§¤ì¼ ê¾¸ì¤€íˆ í•˜ëŠ” ê²ƒì´ ì£¼ë§ì— 3ì‹œê°„ ëª°ì•„ì„œ í•˜ëŠ” ê²ƒë³´ë‹¤ í›¨ì”¬ íš¨ê³¼ì ì…ë‹ˆë‹¤. ğŸ’ª


3ï¸âƒ£ ì„¸ ë²ˆì§¸ í•µì‹¬ í¬ì¸íŠ¸

ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ëŠ” ê²ƒë„ ì¢‹ì€ ë°©ë²•ì…ë‹ˆë‹¤. í˜¼ìì„œ í•˜ë‹¤ ë³´ë©´ ë°©í–¥ì„ ìƒê¸° ì‰½ê³ , ì˜ëª»ëœ ìŠµê´€ì´ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

${keywords ? keywords.split(',').map(k => k.trim()).join(', ') : topic}ê³¼ ê´€ë ¨í•´ì„œ ì²´ê³„ì ì¸ ì»¤ë¦¬í˜ëŸ¼ì„ ê°–ì¶˜ ê³³ì—ì„œ í•™ìŠµí•˜ë©´ ì‹œê°„ê³¼ ë…¸ë ¥ì„ ì•„ë‚„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


ğŸ“š ì‹¤ì „ í™œìš© íŒ

ì´ë¡ ë§Œ ì•„ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ì‹¤ì œë¡œ ì ìš©í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤. 

ë§¤ì¼ ì‘ì€ ëª©í‘œë¥¼ ì„¸ìš°ê³ , ê·¸ê²ƒì„ ë‹¬ì„±í•˜ë©´ì„œ ì„±ì·¨ê°ì„ ëŠë¼ê²Œ í•´ì£¼ì„¸ìš”. ì´ë ‡ê²Œ í•˜ë©´ ìì—°ìŠ¤ëŸ½ê²Œ í•™ìŠµ ë™ê¸°ê°€ ìƒê¸°ê³ , ${mainKeyword}ì— ëŒ€í•œ í¥ë¯¸ë„ ë†’ì•„ì§‘ë‹ˆë‹¤.

íŠ¹íˆ í•™ë¶€ëª¨ë‹˜ì˜ ê´€ì‹¬ê³¼ ì‘ì›ì´ ì •ë§ ì¤‘ìš”í•©ë‹ˆë‹¤. ì‘ì€ ë°œì „ì´ë¼ë„ ì¹­ì°¬í•´ì£¼ì‹œë©´, ì•„ì´ë“¤ì€ ë” ì—´ì‹¬íˆ í•˜ê²Œ ë©ë‹ˆë‹¤! ğŸ‰


ğŸ’¡ ë§ˆë¬´ë¦¬í•˜ë©°

ì˜¤ëŠ˜ì€ ${topic}ì— ëŒ€í•´ ìì„¸íˆ ì•Œì•„ë³´ì•˜ìŠµë‹ˆë‹¤.

í•µì‹¬ì€ ê¸°ì´ˆë¥¼ íƒ„íƒ„íˆ í•˜ê³ , ê¾¸ì¤€íˆ í•™ìŠµí•˜ë©°, í•„ìš”í•˜ë‹¤ë©´ ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ëŠ” ê²ƒì…ë‹ˆë‹¤.

ìš°ë¦¬ ì•„ì´ì—ê²Œ ë§ëŠ” ë°©ë²•ì„ ì°¾ì•„ì„œ ì°¨ê·¼ì°¨ê·¼ ì§„í–‰í•˜ì‹œë©´, ë¶„ëª… ì¢‹ì€ ê²°ê³¼ê°€ ìˆì„ ê±°ì˜ˆìš”! ğŸ˜Š

ê¶ê¸ˆí•˜ì‹  ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”. ì„±ì‹¬ì„±ì˜ê» ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤!

#${mainKeyword} ${keywords ? keywords.split(',').map(k => '#' + k.trim()).join(' ') : ''} #í•™ì› #í•™ìŠµë²• #ê³µë¶€ë²• #êµìœ¡ì •ë³´`
}

// ========================================
// Page Routes
// ========================================

// Main page
// Favicon route - prevent 404
app.get('/favicon.ico', (c) => {
  return c.body(null, 204)
})

app.get('/', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="naver-site-verification" content="f0716e4a61fc6144eec195ebe09f93fe452ada21" />
        <meta name="google-site-verification" content="WhKCP6gbVE2UVm3T9eXQ8beqCW16phA-ltSMFkSvlhg" />
        <link rel="icon" type="image/x-icon" href="/favicon.ico">
        <link rel="icon" type="image/png" href="/logo.png">
        <title>í•™ì› ë§ˆì¼€íŒ… í•™ì› ê´€ë¦¬ í”„ë¡œê·¸ë¨ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <meta name="description" content="ì „êµ­ì—ì„œ ìœ ì¼í•©ë‹ˆë‹¤! 100% í˜„ì§ í•™ì›ì¥ì´ ì•Œë ¤ì£¼ëŠ” ì‹¤ì „ ë§ˆì¼€íŒ…! ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œ, ë¸”ë¡œê·¸ ë§ˆì¼€íŒ…, í¼ë„ ë§ˆì¼€íŒ… ì „ë¬¸ êµìœ¡. ëŒ€í‘œì´ì‚¬ ê³ í¬ì¤€, ì œ1íŒ€ì¥ ê³ ì„ ìš°ì™€ í•¨ê»˜í•˜ëŠ” í•™ì› ì„±ì¥ ì»¨ì„¤íŒ….">
        
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website">
        <meta property="og:url" content="https://superplace-academy.pages.dev/">
        <meta property="og:title" content="í•™ì› ë§ˆì¼€íŒ… í•™ì› ê´€ë¦¬ í”„ë¡œê·¸ë¨ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤">
        <meta property="og:description" content="ì „êµ­ì—ì„œ ìœ ì¼í•©ë‹ˆë‹¤! 100% í˜„ì§ í•™ì›ì¥ì´ ì•Œë ¤ì£¼ëŠ” ì‹¤ì „ ë§ˆì¼€íŒ…!">
        <meta property="og:image" content="https://superplace-academy.pages.dev/homepage-thumbnail.jpg">
        
        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content="https://superplace-academy.pages.dev/">
        <meta property="twitter:title" content="í•™ì› ë§ˆì¼€íŒ… í•™ì› ê´€ë¦¬ í”„ë¡œê·¸ë¨ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤">
        <meta property="twitter:description" content="ì „êµ­ì—ì„œ ìœ ì¼í•©ë‹ˆë‹¤! 100% í˜„ì§ í•™ì›ì¥ì´ ì•Œë ¤ì£¼ëŠ” ì‹¤ì „ ë§ˆì¼€íŒ…!">
        <meta property="twitter:image" content="https://superplace-academy.pages.dev/homepage-thumbnail.jpg">
        
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          
          :root {
            --primary: #7c3aed;
            --primary-dark: #5b21b6;
            --accent: #fb923c;
            --accent-dark: #f97316;
          }
          
          body {
            background: #ffffff;
            color: #1f2937;
          }
          
          .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          }
          
          .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px -8px rgba(124, 58, 237, 0.15);
          }
          
          .animate-fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
          }
          
          .animate-fade-in.visible {
            opacity: 1;
            transform: translateY(0);
          }
          
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
          
          .gradient-orange {
            background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
          }
          
          .section-light {
            background: #fafafa;
          }
          
          .text-balance {
            text-wrap: balance;
          }
          
          /* ì „ì²´ ë©”ê°€ ë©”ë‰´ ìŠ¤íƒ€ì¼ */
          .nav-menu-wrapper {
            display: flex;
            align-items: center;
            gap: 40px;
            position: relative;
          }
          
          .mega-menu {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            display: none;
            background: white;
            border-top: 2px solid #e5e7eb;
            box-shadow: 0 20px 40px -8px rgba(0, 0, 0, 0.15);
            z-index: 100;
            transition: opacity 0.3s ease-out;
          }
          
          .mega-menu-inner {
            max-width: 1280px;
            margin: 0 auto;
            padding: 40px 48px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 32px;
          }
          
          .menu-column {
            display: flex;
            flex-direction: column;
            min-width: 0;
          }
          
          .menu-column-title {
            font-size: 15px;
            font-weight: 700;
            color: #7c3aed;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e5e7eb;
            white-space: nowrap;
            cursor: pointer;
          }
          
          .menu-column-title a {
            color: #7c3aed;
            text-decoration: none;
          }
          
          .menu-column-title a:hover {
            color: #6d28d9;
          }
          
          .menu-column a {
            display: block;
            padding: 8px 0;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
          }
          
          .menu-column a:hover {
            color: #7c3aed;
            padding-left: 8px;
          }
          
          @keyframes fadeInDown {
            from {
              opacity: 0;
              transform: translateY(-10px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
        </style>
    </head>
    <body>
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <div class="flex items-center space-x-3">
                        <img src="/static/images/logo.png" alt="SUPER PLACE" class="h-10" onerror="this.style.display='none'">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </div>
                    <div class="hidden md:flex items-center space-x-10">
                        <!-- ë©”ë‰´ í•­ëª©ë“¤ -->
                        <div class="nav-menu-wrapper">
                            <a href="/" class="text-gray-700 hover:text-purple-600 font-medium transition">í™ˆ</a>
                            <a href="/programs" class="text-gray-700 hover:text-purple-600 font-medium transition">êµìœ¡ í”„ë¡œê·¸ë¨</a>
                            <a href="/pricing" class="text-gray-700 hover:text-purple-600 font-medium transition">ìš”ê¸ˆì œ</a>
                            <a href="/success" class="text-gray-700 hover:text-purple-600 font-medium transition">ì„±ê³µ ì‚¬ë¡€</a>
                            <a href="/contact" class="text-gray-700 hover:text-purple-600 font-medium transition">ë¬¸ì˜í•˜ê¸°</a>
                            <a href="https://kohsunwoo12345-cmyk.github.io/SUPERPLACE.Home.store/" target="_blank" class="text-gray-700 hover:text-purple-600 font-medium transition">AI ë´‡ ì‡¼í•‘ëª°</a>
                            
                            <!-- ì „ì²´ ë©”ê°€ ë©”ë‰´ -->
                            <div class="mega-menu">
                                <div class="mega-menu-inner">
                                    <!-- í™ˆ -->
                                    <div class="menu-column">
                                        <div class="menu-column-title"><a href="#home" onclick="scrollToSection('home'); return false;" style="cursor: pointer; text-decoration: none;">í™ˆ</a></div>
                                        <a href="/">ë©”ì¸ í™ˆ</a>
                                        <a href="/about">íšŒì‚¬ ì†Œê°œ</a>
                                        <a href="/dashboard">ëŒ€ì‹œë³´ë“œ</a>
                                    </div>
                                    
                                    <!-- êµìœ¡ í”„ë¡œê·¸ë¨ -->
                                    <div class="menu-column">
                                        <div class="menu-column-title"><a href="#programs" onclick="scrollToSection('programs'); return false;" style="cursor: pointer; text-decoration: none;">êµìœ¡ í”„ë¡œê·¸ë¨</a></div>
                                        <a href="/tools/landing-page-builder">ëœë”©í˜ì´ì§€ ìƒì„±ê¸°</a>
                                        <a href="/tools/sms-sender">ë¬¸ì ë°œì†¡</a>
                                        <a href="/tools/student-management">í•™ìƒ ê´€ë¦¬</a>
                                        <a href="/tools/ai-learning-report">í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</a>
                                    </div>
                                    
                                    <!-- ìš”ê¸ˆì œ -->
                                    <div class="menu-column">
                                        <div class="menu-column-title"><a href="#pricing" onclick="scrollToSection('pricing'); return false;" style="cursor: pointer; text-decoration: none;">ìš”ê¸ˆì œ</a></div>
                                        <a href="/pricing/starter">ìŠ¤íƒ€í„° í”Œëœ</a>
                                        <a href="/pricing/basic">ë² ì´ì§ í”Œëœ</a>
                                        <a href="/pricing/pro">í”„ë¡œ í”Œëœ</a>
                                        <a href="/pricing/business">ë¹„ì¦ˆë‹ˆìŠ¤ í”Œëœ</a>
                                        <a href="/pricing/premium">í”„ë¦¬ë¯¸ì—„ í”Œëœ</a>
                                        <a href="/pricing/enterprise">ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ</a>
                                    </div>
                                    
                                    <!-- ì„±ê³µ ì‚¬ë¡€ -->
                                    <div class="menu-column">
                                        <div class="menu-column-title"><a href="#success" onclick="scrollToSection('success'); return false;" style="cursor: pointer; text-decoration: none;">ì„±ê³µ ì‚¬ë¡€</a></div>
                                        <a href="/success">ì „ì²´ ì‚¬ë¡€</a>
                                        <a href="/success/academy">í•™ì› ì„±ê³µ ì‚¬ë¡€</a>
                                        <a href="/success/teacher">êµì‚¬ ì„±ê³µ ì‚¬ë¡€</a>
                                    </div>
                                    
                                    <!-- ë¬¸ì˜í•˜ê¸° -->
                                    <div class="menu-column">
                                        <div class="menu-column-title"><a href="#contact" onclick="scrollToSection('contact'); return false;" style="cursor: pointer; text-decoration: none;">ë¬¸ì˜í•˜ê¸°</a></div>
                                        <a href="/contact">ì¼ë°˜ ë¬¸ì˜</a>
                                        <a href="/contact/support">ê¸°ìˆ  ì§€ì›</a>
                                        <a href="/contact/sales">ì˜ì—… ë¬¸ì˜</a>
                                    </div>
                                    
                                    <!-- AI ë´‡ ì‡¼í•‘ëª° -->
                                    <div class="menu-column">
                                        <div class="menu-column-title">AI ë´‡ ì‡¼í•‘ëª°</div>
                                        <a href="https://kohsunwoo12345-cmyk.github.io/SUPERPLACE.Home.store/" target="_blank">ì‡¼í•‘ëª° í™ˆ</a>
                                        <a href="https://kohsunwoo12345-cmyk.github.io/SUPERPLACE.Home.store/products" target="_blank">ìƒí’ˆ ëª©ë¡</a>
                                        <a href="https://kohsunwoo12345-cmyk.github.io/SUPERPLACE.Home.store/cart" target="_blank">ì¥ë°”êµ¬ë‹ˆ</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ë¡œê·¸ì¸ ì „ -->
                        <a href="/signup?teacher=true" id="teacherRegisterBtn" class="text-purple-600 hover:text-purple-700 font-semibold border border-purple-600 px-5 py-2.5 rounded-full hover:bg-purple-50 transition-all">
                            ì„ ìƒë‹˜ ë“±ë¡
                        </a>
                        <a href="/login" id="loginBtn" class="gradient-purple text-white px-6 py-2.5 rounded-full font-medium hover:shadow-lg transition-all">
                            ë¡œê·¸ì¸
                        </a>
                        
                        <!-- ì„ ìƒë‹˜ ì „ìš© (ë¡œê·¸ì¸ í›„) -->
                        <a href="/academy-management" id="academyManageLink" class="hidden text-gray-700 hover:text-purple-600 font-medium transition">í•™ì› ê´€ë¦¬</a>
                        
                        <!-- ë¡œê·¸ì¸ í›„ -->
                        <div id="userMenu" class="hidden flex items-center space-x-4">
                            <a href="/dashboard" class="text-gray-700 hover:text-purple-600 font-medium">ëŒ€ì‹œë³´ë“œ</a>
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold" id="userAvatar"></div>
                                <span id="userName" class="text-gray-900 font-medium"></span>
                            </div>
                            <button onclick="logout()" class="text-gray-600 hover:text-red-600">ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                    </div>
                    <div class="md:hidden">
                        <button id="mobile-menu-btn" class="text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Mobile menu -->
            <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-gray-100">
                <div class="px-6 py-4 space-y-2">
                    <a href="/" class="block px-4 py-3 text-gray-700 hover:bg-purple-50 rounded-xl transition">í™ˆ</a>
                    <a href="/programs" class="block px-4 py-3 text-gray-700 hover:bg-purple-50 rounded-xl transition">êµìœ¡ í”„ë¡œê·¸ë¨</a>
                    <a href="/pricing" class="block px-4 py-3 text-gray-700 hover:bg-purple-50 rounded-xl transition">ìš”ê¸ˆì œ</a>
                    <a href="/success" class="block px-4 py-3 text-gray-700 hover:bg-purple-50 rounded-xl transition">ì„±ê³µ ì‚¬ë¡€</a>
                    <a href="/contact" class="block px-4 py-3 text-gray-700 hover:bg-purple-50 rounded-xl transition">ë¬¸ì˜í•˜ê¸°</a>
                    <a href="https://kohsunwoo12345-cmyk.github.io/SUPERPLACE.Home.store/" target="_blank" class="block px-4 py-3 text-gray-700 hover:bg-purple-50 rounded-xl transition">AI ë´‡ ì‡¼í•‘ëª°</a>
                    <a href="/teachers/register" class="block px-4 py-3 text-purple-600 border border-purple-600 bg-white hover:bg-purple-50 rounded-xl text-center font-semibold">ì„ ìƒë‹˜ ë“±ë¡</a>
                    <a href="/login" class="block px-4 py-3 gradient-purple text-white rounded-xl text-center font-medium">ë¡œê·¸ì¸</a>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section id="home" class="pt-32 pb-32 px-6 bg-white relative overflow-hidden">
            <div class="absolute inset-0 z-0">
                <div class="absolute top-0 right-0 w-1/2 h-1/2 bg-gradient-to-br from-purple-100 to-transparent rounded-full blur-3xl opacity-30"></div>
                <div class="absolute bottom-0 left-0 w-1/2 h-1/2 bg-gradient-to-tr from-orange-100 to-transparent rounded-full blur-3xl opacity-30"></div>
            </div>
            <div class="max-w-7xl mx-auto relative z-10">
                <div class="grid lg:grid-cols-2 gap-12 items-center">
                    <!-- Left: Text Content -->
                    <div class="animate-fade-in">
                        <div class="inline-block mb-6 px-5 py-2.5 bg-purple-50 rounded-full text-purple-700 text-sm font-medium border border-purple-100">
                            í•™ì› ë§ˆì¼€íŒ…ì˜ ìƒˆë¡œìš´ ê¸°ì¤€
                        </div>
                        <h1 class="text-5xl lg:text-6xl font-bold text-gray-900 mb-6 leading-tight">
                            í•™ì›ì¥ë‹˜ì˜ ì„±ê³µ,<br>
                            <span class="text-purple-600">ìš°ë¦¬ê°€ í•¨ê»˜í•©ë‹ˆë‹¤</span>
                        </h1>
                        <p class="text-xl text-gray-600 mb-10 leading-relaxed">
                            ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ 1ìœ„, ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œ, í¼ë„ ë§ˆì¼€íŒ…ê¹Œì§€<br>
                            <span class="text-gray-900 font-medium">500ê°œ í•™ì›ì´ ê²€ì¦</span>í•œ ì‹¤ì „ ë§ˆì¼€íŒ… ë…¸í•˜ìš°
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4 mb-12">
                            <a href="/contact" class="gradient-purple text-white px-10 py-4 rounded-full text-lg font-medium shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 text-center">
                                ë¬´ë£Œ ìƒë‹´ ì‹ ì²­í•˜ê¸°
                            </a>
                            <a href="/programs" class="bg-white text-purple-600 border-2 border-purple-200 px-10 py-4 rounded-full text-lg font-medium hover:border-purple-400 hover:bg-purple-50 transition-all text-center">
                                êµìœ¡ í”„ë¡œê·¸ë¨ ë³´ê¸°
                            </a>
                        </div>
                        
                        <!-- ì„ ìƒë‹˜ ë“±ë¡ ì•ˆë‚´ -->
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200 rounded-2xl p-6">
                            <div class="flex items-start space-x-4">
                                <div class="flex-shrink-0">
                                    <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-lg font-bold text-gray-900 mb-2">ì„ ìƒë‹˜ì´ì‹ ê°€ìš”?</h3>
                                    <p class="text-gray-600 mb-4">
                                        í•™ì› ì›ì¥ë‹˜ê³¼ í•¨ê»˜ í•™ìƒ ê´€ë¦¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”. ê°„í¸í•œ ë“±ë¡ ì ˆì°¨ë¡œ ë°”ë¡œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                                    </p>
                                    <a href="/teachers/register" class="inline-flex items-center px-6 py-3 bg-white border-2 border-purple-600 text-purple-600 rounded-full font-semibold hover:bg-purple-600 hover:text-white transition-all">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                        </svg>
                                        ì„ ìƒë‹˜ ë“±ë¡í•˜ê¸°
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right: Hero Image -->
                    <div class="animate-fade-in" style="transition-delay: 0.2s">
                        <div class="relative rounded-3xl overflow-hidden shadow-2xl">
                            <img src="/static/images/hero-main.png" 
                                 alt="í•™ì› ì „ë¬¸ ë§ˆì¼€íŒ… - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤" 
                                 class="w-full h-auto object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-purple-900/10 to-transparent"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-20">
                    
                    <!-- Marketing Funnel Process -->
                    <div class="pt-16 border-t border-gray-200">
                        <div class="text-center mb-12">
                            <h3 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-3">
                                ìš°ë¦¬ í•™ì›ì˜ ì™„ë²½í•œ í”„ë¡œì„¸ìŠ¤
                            </h3>
                            <p class="text-lg text-gray-600">
                                ë…¸ì¶œë¶€í„° ìœ ì§€ê¹Œì§€, ì²´ê³„ì ì¸ ë§ˆì¼€íŒ… í¼ë„ë¡œ ì„±ê³µì„ ì´ë•ë‹ˆë‹¤
                            </p>
                        </div>
                        
                        <!-- Enhanced Process Flow -->
                        <div class="max-w-5xl mx-auto">
                            <div class="grid grid-cols-4 gap-4 lg:gap-6">
                                <!-- Step 1: ë…¸ì¶œ -->
                                <div class="relative group">
                                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-6 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-xl border border-purple-200">
                                        <div class="inline-flex items-center justify-center w-20 h-20 lg:w-24 lg:h-24 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 shadow-lg mb-4 transform transition-transform group-hover:rotate-6">
                                            <span class="text-4xl lg:text-5xl">ğŸ“¢</span>
                                        </div>
                                        <h4 class="text-lg lg:text-xl font-bold text-gray-900 mb-2">ë…¸ì¶œ</h4>
                                        <p class="text-sm text-purple-700 font-medium">í™ë³´</p>
                                    </div>
                                    <!-- Arrow -->
                                    <div class="hidden lg:block absolute top-1/2 -right-3 transform -translate-y-1/2 z-10">
                                        <svg class="w-6 h-6 text-purple-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                </div>
                                
                                <!-- Step 2: ìƒë‹´ -->
                                <div class="relative group">
                                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-6 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-xl border border-blue-200">
                                        <div class="inline-flex items-center justify-center w-20 h-20 lg:w-24 lg:h-24 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 shadow-lg mb-4 transform transition-transform group-hover:rotate-6">
                                            <span class="text-4xl lg:text-5xl">ğŸ’¬</span>
                                        </div>
                                        <h4 class="text-lg lg:text-xl font-bold text-gray-900 mb-2">ìƒë‹´</h4>
                                        <p class="text-sm text-blue-700 font-medium">1ì°¨ ì „í™˜</p>
                                    </div>
                                    <!-- Arrow -->
                                    <div class="hidden lg:block absolute top-1/2 -right-3 transform -translate-y-1/2 z-10">
                                        <svg class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                </div>
                                
                                <!-- Step 3: ë“±ë¡ -->
                                <div class="relative group">
                                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-6 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-xl border border-green-200">
                                        <div class="inline-flex items-center justify-center w-20 h-20 lg:w-24 lg:h-24 rounded-2xl bg-gradient-to-br from-green-500 to-green-600 shadow-lg mb-4 transform transition-transform group-hover:rotate-6">
                                            <span class="text-4xl lg:text-5xl">âœ…</span>
                                        </div>
                                        <h4 class="text-lg lg:text-xl font-bold text-gray-900 mb-2">ë“±ë¡</h4>
                                        <p class="text-sm text-green-700 font-medium">2ì°¨ ì „í™˜</p>
                                    </div>
                                    <!-- Arrow -->
                                    <div class="hidden lg:block absolute top-1/2 -right-3 transform -translate-y-1/2 z-10">
                                        <svg class="w-6 h-6 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                        </svg>
                                    </div>
                                </div>
                                
                                <!-- Step 4: íŒ¬ë¤ ìœ ì§€ -->
                                <div class="relative group">
                                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl p-6 text-center transform transition-all duration-300 hover:scale-105 hover:shadow-xl border border-orange-200">
                                        <div class="inline-flex items-center justify-center w-20 h-20 lg:w-24 lg:h-24 rounded-2xl bg-gradient-to-br from-orange-500 to-orange-600 shadow-lg mb-4 transform transition-transform group-hover:rotate-6">
                                            <span class="text-4xl lg:text-5xl">ğŸ¯</span>
                                        </div>
                                        <h4 class="text-lg lg:text-xl font-bold text-gray-900 mb-2">íŒ¬ë¤ ìœ ì§€</h4>
                                        <p class="text-sm text-orange-700 font-medium">ì´íƒˆ ë°©ì§€</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Enhanced Description -->
                        <div class="mt-12 text-center">
                            <div class="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-purple-500 to-orange-500 rounded-full shadow-lg">
                                <span class="text-white font-bold text-lg">ë…¸ì¶œ</span>
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-white font-bold text-lg">ìƒë‹´</span>
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-white font-bold text-lg">ë“±ë¡</span>
                                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-white font-bold text-lg">ìœ ì§€</span>
                            </div>
                            <p class="mt-6 text-gray-600 text-lg font-medium">
                                ì™„ë²½í•œ í”„ë¡œì„¸ìŠ¤ë¡œ í•™ì› ì„±ì¥ì„ ì‹¤í˜„í•©ë‹ˆë‹¤
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <!-- Our Story Section -->
        <section id="story" class="py-20 px-6 bg-gradient-to-br from-purple-50 to-white">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-6 tracking-tight">
                        ìš°ë¦¬ì˜ ì‹œì‘
                    </h2>
                    <div class="w-24 h-1 bg-gradient-to-r from-purple-600 to-orange-500 mx-auto"></div>
                </div>
                
                <!-- CEO Profile and Intro -->
                <div class="grid lg:grid-cols-2 gap-12 mb-16 items-center">
                    <!-- CEO Image -->
                    <div class="flex justify-center">
                        <div class="relative">
                            <img src="/static/images/ceo-profile.jpg" alt="ëŒ€í‘œì´ì‚¬ ê³ í¬ì¤€" class="rounded-3xl shadow-2xl w-full max-w-md">
                            <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 bg-white px-8 py-4 rounded-full shadow-lg">
                                <p class="text-xl font-bold text-gray-900">ëŒ€í‘œì´ì‚¬ ê³ í¬ì¤€</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Intro Text -->
                    <div class="space-y-6">
                        <p class="text-2xl lg:text-3xl text-gray-800 leading-relaxed font-medium tracking-wide">
                            <span class="font-bold text-purple-600">ì¸ì²œ ì„œêµ¬ì—ì„œ<br>ê³µë¶€ë°©ì„ ìš´ì˜í•˜ë˜ ì €í¬</span>ëŠ”<br>
                            ì²˜ìŒì— í•™ìƒ ëª¨ì§‘ì—<br>
                            í° ì–´ë ¤ì›€ì„ ê²ªì—ˆìŠµë‹ˆë‹¤.
                        </p>
                        <p class="text-xl lg:text-2xl text-gray-700 leading-relaxed tracking-wide">
                            í•˜ì§€ë§Œ <span class="font-bold text-orange-500">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìµœì í™”,<br>ë¸”ë¡œê·¸ ë§ˆì¼€íŒ…, í¼ë„ ì‹œìŠ¤í…œ</span>ì„<br>
                            ì§ì ‘ ê³µë¶€í•˜ê³  ì ìš©í•˜ë©´ì„œ<br>
                            ë†€ë¼ìš´ ë³€í™”ë¥¼ ê²½í—˜í–ˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
                
                <!-- Story Content - Compact Version -->
                <div class="max-w-4xl mx-auto space-y-8">
                    
                    <!-- ì„±ê³¼ ì¹´ë“œ -->
                    <div class="grid sm:grid-cols-2 gap-6">
                        <div class="bg-white rounded-2xl p-8 shadow-lg border-l-4 border-purple-500">
                            <div class="text-5xl font-bold text-purple-600 mb-2">2ë°°</div>
                            <p class="text-gray-900 font-semibold text-lg">ì‹ ê·œ ë¬¸ì˜ ì¦ê°€</p>
                            <p class="text-gray-600 text-sm mt-1">3ê°œì›” ë§Œì— ë‹¬ì„±</p>
                        </div>
                        <div class="bg-white rounded-2xl p-8 shadow-lg border-l-4 border-orange-500">
                            <div class="text-5xl font-bold text-orange-500 mb-2">3ë°°</div>
                            <p class="text-gray-900 font-semibold text-lg">í•™ì› ê·œëª¨ ì„±ì¥</p>
                            <p class="text-gray-600 text-sm mt-1">ëª‡ ë…„ ë§Œì— ë‹¬ì„±</p>
                        </div>
                    </div>

                    <!-- í•µì‹¬ ë©”ì‹œì§€ -->
                    <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-2xl p-10 lg:p-12 text-white shadow-xl">
                        <p class="text-xl lg:text-2xl leading-relaxed mb-8 text-center">
                            í•˜ì§€ë§Œ í•™ì›ìƒì´ ë“±ë¡í•˜ëŠ” ë§Œí¼<br class="sm:hidden">
                            <span class="font-bold text-orange-300">ì´íƒˆ í•™ì›ìƒë„ ë§ì•˜ìŠµë‹ˆë‹¤.</span>
                        </p>
                        
                        <div class="space-y-6">
                            <div class="flex items-start gap-4">
                                <svg class="w-7 h-7 text-orange-300 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <p class="text-lg leading-relaxed">
                                    í•™ì›ìƒ ëª¨ì§‘ë¶€í„° ì›ìƒ ê´€ë¦¬, í•™ë¶€ëª¨ ê´€ë¦¬ê¹Œì§€<br>
                                    <span class="font-bold">ëª¨ë‘ ìë™í™”</span>ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œìŠ¤í…œ êµ¬ì¶•
                                </p>
                            </div>
                            
                            <div class="flex items-start gap-4">
                                <svg class="w-7 h-7 text-orange-300 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <p class="text-lg leading-relaxed">
                                    <span class="font-bold">AI ê¸°ë°˜ í•™ìƒ ë¶„ì„</span> ì‹œìŠ¤í…œìœ¼ë¡œ<br>
                                    ì°¸ì—¬ë„Â·ì´í•´ë„ ìë™ ë¶„ì„ â†’ í•™ë¶€ëª¨ì—ê²Œ ì „ë‹¬
                                </p>
                            </div>
                            
                            <div class="flex items-start gap-4">
                                <svg class="w-7 h-7 text-orange-300 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                                <p class="text-lg leading-relaxed">
                                    <span class="font-bold">ì»´ë§¹ë„ í´ë¦­ í•œ ë²ˆ</span>ìœ¼ë¡œ<br>
                                    ëª¨ë“  ê³¼ì • ê°„í¸ ì‚¬ìš© ê°€ëŠ¥
                                </p>
                            </div>
                        </div>

                        <div class="mt-10 pt-8 border-t border-white/20 text-center">
                            <p class="text-2xl lg:text-3xl font-bold text-orange-300 mb-4">
                                "ì´ ë…¸í•˜ìš°ë¥¼ ë‚˜ëˆ„ê³  ì‹¶ë‹¤"
                            </p>
                            <p class="text-xl">
                                ê·¸ë ‡ê²Œ <span class="font-bold">'ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤'</span>ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>

                    <!-- ì§„ì§œ ë§ˆì¼€íŒ… ì •ì˜ -->
                    <div class="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-10 text-white shadow-xl">
                        <h3 class="text-2xl lg:text-3xl font-bold mb-6 text-center">
                            ì§„ì§œ <span class="text-orange-400">í•™ì› ë§ˆì¼€íŒ…</span>ì´ë€?
                        </h3>
                        <div class="grid sm:grid-cols-2 gap-4 text-sm lg:text-base">
                            <div class="flex items-center gap-3 bg-white/10 rounded-lg p-4">
                                <span class="text-orange-400 font-bold text-xl">1</span>
                                <span>ëª¨ë“  í”Œë«í¼ ë…¸ì¶œ</span>
                            </div>
                            <div class="flex items-center gap-3 bg-white/10 rounded-lg p-4">
                                <span class="text-orange-400 font-bold text-xl">2</span>
                                <span>ê³ ê° ë°©ë¬¸ ìœ ë„</span>
                            </div>
                            <div class="flex items-center gap-3 bg-white/10 rounded-lg p-4">
                                <span class="text-orange-400 font-bold text-xl">3</span>
                                <span>ìƒë‹´ â†’ ë“±ë¡ ì „í™˜</span>
                            </div>
                            <div class="flex items-center gap-3 bg-white/10 rounded-lg p-4">
                                <span class="text-orange-400 font-bold text-xl">4</span>
                                <span>ì´íƒˆ ë°©ì§€ ê´€ë¦¬</span>
                            </div>
                        </div>
                    </div>

                    <!-- ê°ì‚¬ ì¸ì‚¬ -->
                    <div class="text-center py-8">
                        <p class="text-3xl lg:text-4xl font-bold text-gray-900">ê°ì‚¬í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>


                <!-- Testimonial -->
                <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-3xl p-12 lg:p-16 max-w-5xl mx-auto animate-fade-in shadow-2xl">
                    <div class="flex items-start gap-6 mb-8">
                        <svg class="w-12 h-12 text-white/80 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
                        </svg>
                    </div>
                    <p class="text-2xl lg:text-3xl text-white leading-relaxed mb-10 font-medium">
                        í”Œë ˆì´ìŠ¤ ë§ˆì¼€íŒ… êµìœ¡ì„ ë°›ì€ í›„ 3ê°œì›” ë§Œì— ì‹ ê·œ ë¬¸ì˜ê°€ <span class="text-orange-300 font-bold">2ë°° ì´ìƒ</span> ëŠ˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì „ ë…¸í•˜ìš°ê°€ ì •ë§ ëŒ€ë‹¨í•©ë‹ˆë‹¤!
                    </p>
                    <div class="flex items-center gap-5">
                        <div class="w-20 h-20 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-white font-bold text-2xl border-2 border-white/30">
                            ê¹€
                        </div>
                        <div>
                            <div class="font-bold text-white text-xl">ê¹€OO ì›ì¥ë‹˜</div>
                            <div class="text-white/80">ì„œìš¸ ê°•ë‚¨êµ¬ ì˜ì–´í•™ì›</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <!-- Services Section -->
        <section id="programs" class="py-32 px-6 section-light">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-20 animate-fade-in">
                    <h2 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-6">
                        í•µì‹¬ êµìœ¡ í”„ë¡œê·¸ë¨
                    </h2>
                    <p class="text-xl text-gray-600">
                        ì‹¤ì „ì—ì„œ ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ í•™ì› ë§ˆì¼€íŒ… ì „ëµ
                    </p>
                </div>
                
                <div class="grid md:grid-cols-3 gap-6 lg:gap-8">
                    <!-- Service 1 -->
                    <div class="bg-white rounded-3xl overflow-hidden border border-gray-100 card-hover animate-fade-in" style="transition-delay: 0.1s">
                        <div class="h-48 overflow-hidden">
                            <img src="/static/images/naver-place.png" 
                                 alt="ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë§ˆì¼€íŒ…" 
                                 class="w-full h-full object-cover hover:scale-105 transition-transform duration-500">
                        </div>
                        <div class="p-8">
                            <div class="w-12 h-12 gradient-purple rounded-xl flex items-center justify-center mb-4">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-3">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤<br>ìƒìœ„ë…¸ì¶œ</h3>
                            <p class="text-gray-600 mb-6 leading-relaxed">
                                ì§€ì—­ ê²€ìƒ‰ 1ìœ„ ë‹¬ì„±ì„ ìœ„í•œ ì‹¤ì „ ë…¸í•˜ìš°. í‚¤ì›Œë“œ ë¶„ì„ë¶€í„° ë¦¬ë·° ê´€ë¦¬ê¹Œì§€ ì™„ë²½í•˜ê²Œ ë§ˆìŠ¤í„°í•©ë‹ˆë‹¤.
                            </p>
                            <ul class="space-y-3 text-gray-700">
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-purple-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>í‚¤ì›Œë“œ ìµœì í™” ì „ëµ</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-purple-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ë¦¬ë·° ê´€ë¦¬ ì‹œìŠ¤í…œ</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-purple-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ì§€ì—­ SEO ì™„ë²½ ê°€ì´ë“œ</span>
                                </li>
                            </ul>
                            <a href="/programs/naver-place" class="mt-6 block w-full py-3 text-center gradient-purple text-white rounded-xl font-bold hover:shadow-lg transition-all">
                                ìì„¸íˆ ë³´ê¸° â†’
                            </a>
                        </div>
                    </div>

                    <!-- Service 2 -->
                    <div class="bg-white rounded-3xl overflow-hidden border border-gray-100 card-hover animate-fade-in" style="transition-delay: 0.2s">
                        <div class="h-48 overflow-hidden">
                            <img src="/static/images/blog-marketing.jpg" 
                                 alt="ë¸”ë¡œê·¸ ë§ˆì¼€íŒ…" 
                                 class="w-full h-full object-cover hover:scale-105 transition-transform duration-500">
                        </div>
                        <div class="p-8">
                            <div class="w-12 h-12 gradient-orange rounded-xl flex items-center justify-center mb-4">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-3">ë¸”ë¡œê·¸<br>ìƒìœ„ë…¸ì¶œ</h3>
                            <p class="text-gray-600 mb-6 leading-relaxed">
                                ë„¤ì´ë²„ ë¸”ë¡œê·¸ ê²€ìƒ‰ ìµœìƒìœ„ ì§„ì… ì „ëµ. SEO ìµœì í™”ì™€ ì½˜í…ì¸  ê¸°íšì˜ ëª¨ë“  ê²ƒì„ ë°°ì›ë‹ˆë‹¤.
                            </p>
                            <ul class="space-y-3 text-gray-700">
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-orange-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ ì™„ë²½ ì´í•´</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-orange-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>íš¨ê³¼ì ì¸ ê¸€ì“°ê¸° ê¸°ë²•</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-orange-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ì½˜í…ì¸  ì „ëµ ìˆ˜ë¦½</span>
                                </li>
                            </ul>
                            <a href="/programs/blog" class="mt-6 block w-full py-3 text-center gradient-orange text-white rounded-xl font-bold hover:shadow-lg transition-all">
                                ìì„¸íˆ ë³´ê¸° â†’
                            </a>
                        </div>
                    </div>

                    <!-- Service 3 -->
                    <div class="bg-white rounded-3xl overflow-hidden border border-gray-100 card-hover animate-fade-in" style="transition-delay: 0.3s">
                        <div class="h-48 overflow-hidden">
                            <img src="/static/images/funnel-marketing.png" 
                                 alt="í¼ë„ ë§ˆì¼€íŒ…" 
                                 class="w-full h-full object-cover hover:scale-105 transition-transform duration-500">
                        </div>
                        <div class="p-8">
                            <div class="w-12 h-12 gradient-purple rounded-xl flex items-center justify-center mb-4">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-3">í¼ë„<br>ë§ˆì¼€íŒ…</h3>
                            <p class="text-gray-600 mb-6 leading-relaxed">
                                ìƒë‹´ë¶€í„° ë“±ë¡ê¹Œì§€ ìë™í™” ì‹œìŠ¤í…œ êµ¬ì¶•. íš¨ìœ¨ì ì¸ í•™ìƒ ëª¨ì§‘ í”„ë¡œì„¸ìŠ¤ë¥¼ ì™„ì„±í•©ë‹ˆë‹¤.
                            </p>
                            <ul class="space-y-3 text-gray-700">
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-purple-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ê³ ê° ì—¬ì • ì™„ë²½ ì„¤ê³„</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-purple-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ë§ˆì¼€íŒ… ìë™í™” ë„êµ¬</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-purple-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ì „í™˜ìœ¨ ê·¹ëŒ€í™” ì „ëµ</span>
                                </li>
                            </ul>
                            <a href="/programs/funnel" class="mt-6 block w-full py-3 text-center gradient-purple text-white rounded-xl font-bold hover:shadow-lg transition-all">
                                ìì„¸íˆ ë³´ê¸° â†’
                            </a>
                        </div>
                    </div>

                    <!-- Service 4: ëœë”©í˜ì´ì§€ ì œì‘ -->
                    <div class="bg-white rounded-3xl overflow-hidden border border-gray-100 card-hover animate-fade-in" style="transition-delay: 0.4s">
                        <div class="h-48 bg-gradient-to-br from-purple-100 to-purple-50 flex items-center justify-center">
                            <i class="fas fa-desktop text-6xl text-purple-600"></i>
                        </div>
                        <div class="p-8">
                            <div class="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center mb-4">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-3">ëœë”©í˜ì´ì§€<br>ì œì‘</h3>
                            <p class="text-gray-600 mb-6 leading-relaxed">
                                ì „í™˜ìœ¨ì„ ë†’ì´ëŠ” ë§ì¶¤í˜• ëœë”©í˜ì´ì§€ ì œì‘. ë°˜ì‘í˜• ë””ìì¸ê³¼ ë¹ ë¥¸ ë¡œë”©ìœ¼ë¡œ ìƒë‹´ ì‹ ì²­ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.
                            </p>
                            <ul class="space-y-3 text-gray-700">
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-purple-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ë°˜ì‘í˜• ë””ìì¸</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-purple-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ë¹ ë¥¸ ë¡œë”© ì†ë„</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-purple-600 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ì „í™˜ìœ¨ ìµœì í™”</span>
                                </li>
                            </ul>
                            <a href="/services/landing-page" class="mt-6 block w-full py-3 text-center gradient-purple text-white rounded-xl font-bold hover:shadow-lg transition-all">
                                ìì„¸íˆ ë³´ê¸° â†’
                            </a>
                        </div>
                    </div>

                    <!-- Service 5: í•™ì›ë§ˆì¼€íŒ… ëŒ€í–‰ -->
                    <div class="bg-white rounded-3xl overflow-hidden border border-gray-100 card-hover animate-fade-in" style="transition-delay: 0.5s">
                        <div class="h-48 bg-gradient-to-br from-orange-100 to-orange-50 flex items-center justify-center">
                            <i class="fas fa-bullhorn text-6xl text-orange-600"></i>
                        </div>
                        <div class="p-8">
                            <div class="w-12 h-12 gradient-orange rounded-xl flex items-center justify-center mb-4">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-3">í•™ì›ë§ˆì¼€íŒ…<br>ëŒ€í–‰</h3>
                            <p class="text-gray-600 mb-6 leading-relaxed">
                                í•™ìƒ ëª¨ì§‘ë¶€í„° ìœ ì§€ê¹Œì§€ ì˜¬ì¸ì› ì†”ë£¨ì…˜. ì „ë¬¸ ë§ˆì¼€í„°ê°€ í•™ì› ì„±ì¥ì„ ìœ„í•œ ëª¨ë“  ë§ˆì¼€íŒ…ì„ ëŒ€í–‰í•©ë‹ˆë‹¤.
                            </p>
                            <ul class="space-y-3 text-gray-700">
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-orange-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ì˜¨ë¼ì¸ ê´‘ê³  ìš´ì˜</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-orange-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>SEO & SNS ë§ˆì¼€íŒ…</span>
                                </li>
                                <li class="flex items-start">
                                    <svg class="w-5 h-5 text-orange-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span>ì½˜í…ì¸  ì œì‘ & ë¶„ì„</span>
                                </li>
                            </ul>
                            <a href="/services/marketing" class="mt-6 block w-full py-3 text-center gradient-orange text-white rounded-xl font-bold hover:shadow-lg transition-all">
                                ìì„¸íˆ ë³´ê¸° â†’
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <!-- CTA Section -->
        <section id="contact" class="py-32 px-6 gradient-purple">
            <div class="max-w-4xl mx-auto text-center animate-fade-in">
                <h2 class="text-4xl lg:text-6xl font-bold text-white mb-8 text-balance">
                    í•™ì› ì„±ì¥ì˜ ì‹œì‘,<br>
                    ì§€ê¸ˆ ë°”ë¡œ ì‹œì‘í•˜ì„¸ìš”
                </h2>
                <p class="text-xl text-white/90 mb-12 leading-relaxed">
                    ë¬´ë£Œ ìƒë‹´ìœ¼ë¡œ ìš°ë¦¬ í•™ì›ì— ë”± ë§ëŠ” ë§ˆì¼€íŒ… ì „ëµì„ ë°›ì•„ë³´ì„¸ìš”
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="/contact" class="bg-white text-purple-600 px-12 py-5 rounded-full text-lg font-medium shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all duration-300">
                        ë¬´ë£Œ ìƒë‹´ ì‹ ì²­í•˜ê¸°
                    </a>
                    <a href="/programs" class="bg-white/10 backdrop-blur-sm border-2 border-white/40 text-white px-12 py-5 rounded-full text-lg font-medium hover:bg-white hover:text-purple-600 transition-all">
                        êµìœ¡ í”„ë¡œê·¸ë¨ ë³´ê¸°
                    </a>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-gray-50 text-gray-600 py-20 px-6 border-t border-gray-100">
            <div class="max-w-7xl mx-auto">
                <div class="grid md:grid-cols-4 gap-12 mb-16">
                    <div>
                        <div class="flex items-center space-x-2 mb-4">
                            <img src="/static/images/logo.png" alt="SUPER PLACE" class="h-8" onerror="this.style.display='none'">
                            <span class="text-xl font-bold text-gray-900">ìŠˆí¼í”Œë ˆì´ìŠ¤</span>
                        </div>
                        <p class="text-gray-500 text-sm leading-relaxed">
                            í•™ì› ë§ˆì¼€íŒ…ì˜ ìƒˆë¡œìš´ ê¸°ì¤€
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-4">ì„œë¹„ìŠ¤</h4>
                        <ul class="space-y-3 text-sm">
                            <li><a href="/programs" class="hover:text-purple-600 transition">êµìœ¡ í”„ë¡œê·¸ë¨</a></li>
                            <li><a href="/success" class="hover:text-purple-600 transition">ì„±ê³µ ì‚¬ë¡€</a></li>
                            <li><a href="/contact" class="hover:text-purple-600 transition">ë¬¸ì˜í•˜ê¸°</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-4">íšŒì‚¬</h4>
                        <ul class="space-y-3 text-sm">
                            <li><a href="/about" class="hover:text-purple-600 transition">íšŒì‚¬ ì†Œê°œ</a></li>
                            <li><a href="/terms" class="hover:text-purple-600 transition">ì´ìš©ì•½ê´€</a></li>
                            <li><a href="/privacy" class="hover:text-purple-600 transition">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-4">ì—°ë½ì²˜</h4>
                        <ul class="space-y-3 text-sm">
                            <li>ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬ ì²­ë¼ì»¤ë‚¼ë¡œ 270, 2ì¸µ</li>
                            <li>wangholy1@naver.com</li>
                            <li>010-8739-9697</li>
                        </ul>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-8 mt-8">
                    <div class="text-center text-gray-600 text-sm space-y-2">
                        <p class="font-medium text-gray-900">ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</p>
                        <p>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 142-88-02445</p>
                        <p>ì£¼ì†Œ: ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬ ì²­ë¼ì»¤ë‚¼ë¡œ 270, 2ì¸µ</p>
                        <p>ì´ë©”ì¼: wangholy1@naver.com | ì „í™”: 010-8739-9697</p>
                        <p class="text-gray-500 mt-4">&copy; 2024 ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤. All rights reserved.</p>
                    </div>
                </div>
            </div>
        </footer>

        <script>
            // Mega menu delay control
            let menuTimeout;
            const menuWrapper = document.querySelector('.nav-menu-wrapper');
            const megaMenu = document.querySelector('.mega-menu');
            
            function showMegaMenu() {
                clearTimeout(menuTimeout);
                if (megaMenu) {
                    megaMenu.style.display = 'block';
                }
            }
            
            function hideMegaMenu() {
                menuTimeout = setTimeout(() => {
                    if (megaMenu) {
                        megaMenu.style.display = 'none';
                    }
                }, 500); // 500ms delay before hiding
            }
            
            if (menuWrapper) {
                menuWrapper.addEventListener('mouseenter', showMegaMenu);
                menuWrapper.addEventListener('mouseleave', hideMegaMenu);
            }
            
            if (megaMenu) {
                megaMenu.addEventListener('mouseenter', showMegaMenu);
                megaMenu.addEventListener('mouseleave', hideMegaMenu);
            }
            
            // Smooth scroll to section
            function scrollToSection(sectionId) {
                const element = document.getElementById(sectionId);
                if (element) {
                    const navHeight = 80; // Navigation bar height
                    const elementPosition = element.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - navHeight;
                    
                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                }
            }
            
            // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
            function checkLoginStatus() {
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                if (user) {
                    // ë¡œê·¸ì¸ëœ ìƒíƒœ
                    document.getElementById('loginBtn').classList.add('hidden');
                    document.getElementById('teacherRegisterBtn').classList.add('hidden');
                    document.getElementById('userMenu').classList.remove('hidden');
                    document.getElementById('userMenu').classList.add('flex');
                    document.getElementById('userName').textContent = user.name;
                    document.getElementById('userAvatar').textContent = user.name.charAt(0);
                    
                    // ì„ ìƒë‹˜ì¸ ê²½ìš° 'í•™ì› ê´€ë¦¬' ë²„íŠ¼ ë³´ì´ê¸°
                    if (user.user_type === 'teacher') {
                        document.getElementById('academyManageLink').classList.remove('hidden');
                    }
                } else {
                    // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                    document.getElementById('loginBtn').classList.remove('hidden');
                    document.getElementById('teacherRegisterBtn').classList.remove('hidden');
                    document.getElementById('userMenu').classList.add('hidden');
                    document.getElementById('academyManageLink').classList.add('hidden');
                }
            }

            function logout() {
                if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                    location.reload();
                }
            }

            // Mobile menu toggle
            document.getElementById('mobile-menu-btn').addEventListener('click', function() {
                const menu = document.getElementById('mobile-menu');
                menu.classList.toggle('hidden');
            });

            // Smooth scroll animations
            const observeElements = () => {
                const elements = document.querySelectorAll('.animate-fade-in');
                
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                        }
                    });
                }, {
                    threshold: 0.15,
                    rootMargin: '0px 0px -60px 0px'
                });
                
                elements.forEach(element => observer.observe(element));
            };

            // Initialize
            document.addEventListener('DOMContentLoaded', () => {
                checkLoginStatus(); // ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬ ì¶”ê°€
                observeElements();
                
                // Add visible class to hero immediately
                document.querySelector('section .animate-fade-in')?.classList.add('visible');
            });
            
            // ğŸ”¥ ì„¸ì…˜ ì¶”ì 
            (function() {
                try {
                    let sessionId = localStorage.getItem('sessionId');
                    if (!sessionId) {
                        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        localStorage.setItem('sessionId', sessionId);
                    }
                    
                    const user = JSON.parse(localStorage.getItem('user') || 'null');
                    
                    fetch('/api/session/track', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sessionId: sessionId,
                            userId: user?.id || null
                        })
                    }).catch(err => console.log('Session track error:', err));
                    
                    // 5ë¶„ë§ˆë‹¤ í™œë™ ì—…ë°ì´íŠ¸
                    setInterval(() => {
                        fetch('/api/session/track', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                sessionId: sessionId,
                                userId: user?.id || null
                            })
                        }).catch(err => console.log('Session track error:', err));
                    }, 5 * 60 * 1000);
                } catch (e) {
                    console.log('Session tracking init error:', e);
                }
            })();
        </script>
    </body>
    </html>
  `)
})

// ==================== ê²°ì œ ì‹œìŠ¤í…œ API ====================

// í”Œëœ ì •ë³´ ë§¤í•‘
const PLAN_INFO = {
  'starter': { name: 'ìŠ¤íƒ€í„° í”Œëœ', price: 55000, studentLimit: 50, aiReportLimit: 50, landingPageLimit: 50, teacherLimit: 2 },
  'basic': { name: 'ë² ì´ì§ í”Œëœ', price: 143000, studentLimit: 150, aiReportLimit: 150, landingPageLimit: 160, teacherLimit: 6 },
  'pro': { name: 'í”„ë¡œ í”Œëœ', price: 187000, studentLimit: 500, aiReportLimit: 500, landingPageLimit: 530, teacherLimit: 20 },
  'premium': { name: 'í”„ë¦¬ë¯¸ì—„ í”Œëœ', price: 330000, studentLimit: 1000, aiReportLimit: 1000, landingPageLimit: 1100, teacherLimit: 40 },
  'enterprise': { name: 'ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ', price: 750000, studentLimit: 3000, aiReportLimit: 3000, landingPageLimit: 5000, teacherLimit: 999 }
}

// ê²°ì œ ì™„ë£Œ ì›¹í›… (ì•„ì„í¬íŠ¸ì—ì„œ í˜¸ì¶œ)
app.post('/api/payments/webhook', async (c) => {
  try {
    const { imp_uid, merchant_uid, status } = await c.req.json()
    
    console.log('[Payment Webhook] Received:', { imp_uid, merchant_uid, status })

    if (status === 'paid') {
      // merchant_uidì—ì„œ academy_idì™€ plan ì¶”ì¶œ
      // í˜•ì‹: academy_{academyId}_{planId}_{timestamp}
      const parts = merchant_uid.split('_')
      const academyId = parseInt(parts[1])
      const planId = parts[2]
      
      const planInfo = PLAN_INFO[planId]
      if (!planInfo) {
        console.error('[Payment Webhook] Invalid plan ID:', planId)
        return c.json({ success: false, error: 'Invalid plan' }, 400)
      }

      // ğŸ”¥ academy_idëŠ” í•­ìƒ user.id (êµ¬ë… ì¡°íšŒ APIì™€ ì¼ì¹˜)
      const actualAcademyId = academyId // user.id
      console.log('[Payment Webhook] Using academy_id = user.id:', actualAcademyId)
      
      // ğŸ”¥ FOREIGN KEY ì œì•½ ë§Œì¡±: academies í…Œì´ë¸”ì— user.idë¥¼ idë¡œ í•˜ëŠ” ë ˆì½”ë“œ ìƒì„±
      try {
        const existingAcademy = await c.env.DB.prepare(`
          SELECT id FROM academies WHERE id = ?
        `).bind(actualAcademyId).first()
        
        if (!existingAcademy) {
          console.log('[Payment Webhook] Creating academy with explicit id:', actualAcademyId)
          
          // FOREIGN KEY ì²´í¬ ì„ì‹œ ë¹„í™œì„±í™”
          await c.env.DB.prepare(`PRAGMA foreign_keys = OFF`).run()
          
          const user = await c.env.DB.prepare(`SELECT name FROM users WHERE id = ?`).bind(actualAcademyId).first()
          const academyName = user?.name ? user.name + ' í•™ì›' : 'í•™ì›'
          
          await c.env.DB.prepare(`
            INSERT OR REPLACE INTO academies (id, academy_name, owner_id, created_at)
            VALUES (?, ?, ?, CURRENT_TIMESTAMP)
          `).bind(actualAcademyId, academyName, actualAcademyId).run()
          
          await c.env.DB.prepare(`PRAGMA foreign_keys = ON`).run()
          
          console.log('[Payment Webhook] Academy created with id:', actualAcademyId)
        }
      } catch (academyError) {
        console.error('[Payment Webhook] Academy creation error:', academyError)
      }

      // users í…Œì´ë¸”ì—ì„œ academy_id ì—…ë°ì´íŠ¸
      await c.env.DB.prepare(`
        UPDATE users SET academy_id = ? WHERE id = ?
      `).bind(actualAcademyId, academyId).run()

      // êµ¬ë… ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ê³„ì‚° (1ê°œì›”)
      const now = new Date()
      const startDate = now.toISOString().split('T')[0]
      const endDate = new Date(now.setMonth(now.getMonth() + 1)).toISOString().split('T')[0]

      // ê¸°ì¡´ êµ¬ë… ë¹„í™œì„±í™”
      await c.env.DB.prepare(`
        UPDATE subscriptions 
        SET status = 'expired', updated_at = CURRENT_TIMESTAMP
        WHERE academy_id = ? AND status = 'active'
      `).bind(actualAcademyId).run()

      // ìƒˆ êµ¬ë… ìƒì„±
      const result = await c.env.DB.prepare(`
        INSERT INTO subscriptions (
          academy_id, plan_name, plan_price, student_limit, ai_report_limit,
          landing_page_limit, teacher_limit, subscription_start_date, 
          subscription_end_date, status, payment_method, merchant_uid, imp_uid
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', 'card', ?, ?)
      `).bind(
        actualAcademyId,
        planInfo.name,
        planInfo.price,
        planInfo.studentLimit,
        planInfo.aiReportLimit,
        planInfo.landingPageLimit,
        planInfo.teacherLimit,
        startDate,
        endDate,
        merchant_uid,
        imp_uid
      ).run()

      console.log('[Payment Webhook] Subscription created:', {
        subscriptionId: result.meta.last_row_id,
        academyId: actualAcademyId,
        plan: planInfo.name,
        startDate,
        endDate
      })

      // ğŸ”¥ í”„ë¡œê·¸ë¨ ìë™ ë“±ë¡ (4ê°œ ê¸°ë³¸ í”„ë¡œê·¸ë¨)
      const programs = [
        { route: '/students', name: 'í•™ìƒ ê´€ë¦¬' },
        { route: '/tools/ai-learning-report', name: 'AIí•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸' },
        { route: '/tools/dashboard-analytics', name: 'í†µí•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ' },
        { route: '/tools/search-volume', name: 'ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ' }
      ]
      
      // user_programs í…Œì´ë¸”ì— ê¸°ë³¸ 4ê°œ í”„ë¡œê·¸ë¨ ì¶”ê°€ (user_idëŠ” ì›ë˜ ì‚¬ìš©ì ID ì‚¬ìš©)
      for (const program of programs) {
        try {
          await c.env.DB.prepare(`
            INSERT OR IGNORE INTO user_programs (user_id, program_route, program_name, enabled, created_at)
            VALUES (?, ?, ?, 1, CURRENT_TIMESTAMP)
          `).bind(academyId, program.route, program.name).run()
        } catch (e) {
          console.error('[Payment Webhook] Failed to add program:', program.name, e)
        }
      }
      
      console.log('[Payment Webhook] Added 4 basic programs for user:', academyId)

      return c.json({ success: true, subscriptionId: result.meta.last_row_id })
    }

    return c.json({ success: true, message: 'Status not paid' })
  } catch (error) {
    console.error('[Payment Webhook] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ê²°ì œ ì™„ë£Œ í›„ í´ë¼ì´ì–¸íŠ¸ ì¸¡ í™•ì¸
app.post('/api/payments/complete', async (c) => {
  try {
    const { imp_uid, merchant_uid } = await c.req.json()
    
    console.log('[Payment Complete] Client callback:', { imp_uid, merchant_uid })

    // merchant_uidì—ì„œ ì •ë³´ ì¶”ì¶œ
    const parts = merchant_uid.split('_')
    const academyId = parseInt(parts[1])
    const planId = parts[2]
    
    const planInfo = PLAN_INFO[planId]
    if (!planInfo) {
      return c.json({ success: false, error: 'Invalid plan' }, 400)
    }

    // ğŸ”¥ academy_idëŠ” í•­ìƒ user.id (êµ¬ë… ì¡°íšŒ APIì™€ ì¼ì¹˜)
    const actualAcademyId = academyId // user.id
    console.log('[Payment Complete] Using academy_id = user.id:', actualAcademyId)
    
    // ğŸ”¥ FOREIGN KEY ì œì•½ ë§Œì¡±: academies í…Œì´ë¸”ì— user.idë¥¼ idë¡œ í•˜ëŠ” ë ˆì½”ë“œ ìƒì„±
    try {
      const existingAcademy = await c.env.DB.prepare(`
        SELECT id FROM academies WHERE id = ?
      `).bind(actualAcademyId).first()
      
      if (!existingAcademy) {
        console.log('[Payment Complete] Creating academy with explicit id:', actualAcademyId)
        
        // FOREIGN KEY ì²´í¬ ì„ì‹œ ë¹„í™œì„±í™”
        await c.env.DB.prepare(`PRAGMA foreign_keys = OFF`).run()
        
        const user = await c.env.DB.prepare(`SELECT name FROM users WHERE id = ?`).bind(actualAcademyId).first()
        const academyName = user?.name ? user.name + ' í•™ì›' : 'í•™ì›'
        
        await c.env.DB.prepare(`
          INSERT OR REPLACE INTO academies (id, academy_name, owner_id, created_at)
          VALUES (?, ?, ?, CURRENT_TIMESTAMP)
        `).bind(actualAcademyId, academyName, actualAcademyId).run()
        
        await c.env.DB.prepare(`PRAGMA foreign_keys = ON`).run()
        
        console.log('[Payment Complete] Academy created with id:', actualAcademyId)
      }
    } catch (academyError) {
      console.error('[Payment Complete] Academy creation error:', academyError)
    }

    // users í…Œì´ë¸”ì—ì„œ academy_id ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE users SET academy_id = ? WHERE id = ?
    `).bind(actualAcademyId, academyId).run()

    // êµ¬ë… ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ê³„ì‚°
    const now = new Date()
    const startDate = now.toISOString().split('T')[0]
    const endDate = new Date(now.setMonth(now.getMonth() + 1)).toISOString().split('T')[0]

    // ê¸°ì¡´ êµ¬ë… ë¹„í™œì„±í™”
    await c.env.DB.prepare(`
      UPDATE subscriptions 
      SET status = 'expired', updated_at = CURRENT_TIMESTAMP
      WHERE academy_id = ? AND status = 'active'
    `).bind(actualAcademyId).run()

    // ìƒˆ êµ¬ë… ìƒì„±
    const result = await c.env.DB.prepare(`
      INSERT INTO subscriptions (
        academy_id, plan_name, plan_price, student_limit, ai_report_limit,
        landing_page_limit, teacher_limit, subscription_start_date, 
        subscription_end_date, status, payment_method, merchant_uid, imp_uid
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', 'card', ?, ?)
    `).bind(
      actualAcademyId,
      planInfo.name,
      planInfo.price,
      planInfo.studentLimit,
      planInfo.aiReportLimit,
      planInfo.landingPageLimit,
      planInfo.teacherLimit,
      startDate,
      endDate,
      merchant_uid,
      imp_uid
    ).run()

    console.log('[Payment Complete] Subscription created:', {
      subscriptionId: result.meta.last_row_id,
      academyId: actualAcademyId,
      plan: planInfo.name,
      startDate,
      endDate
    })

    // usage_tracking í…Œì´ë¸” ìƒì„± (ì—†ì„ ê²½ìš°)
    await c.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS usage_tracking (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        academy_id INTEGER NOT NULL,
        subscription_id INTEGER NOT NULL,
        current_students INTEGER DEFAULT 0,
        ai_reports_used_this_month INTEGER DEFAULT 0,
        last_ai_report_reset_date TEXT,
        landing_pages_created INTEGER DEFAULT 0,
        current_teachers INTEGER DEFAULT 0,
        sms_sent_this_month INTEGER DEFAULT 0,
        last_sms_reset_date TEXT,
        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
        updated_at TEXT DEFAULT CURRENT_TIMESTAMP
      )
    `).run()

    // usage_tracking ë ˆì½”ë“œ ìƒì„± (êµ¬ë…ê³¼ í•¨ê»˜)
    const usageResult = await c.env.DB.prepare(`
      INSERT INTO usage_tracking (
        academy_id, subscription_id, current_students, 
        ai_reports_used_this_month, landing_pages_created, 
        current_teachers, sms_sent_this_month,
        last_ai_report_reset_date, last_sms_reset_date
      ) VALUES (?, ?, 0, 0, 0, 0, 0, ?, ?)
    `).bind(
      actualAcademyId,
      result.meta.last_row_id,
      startDate,
      startDate
    ).run()

    console.log('[Payment Complete] Usage tracking initialized:', {
      usageId: usageResult.meta.last_row_id
    })

    // ğŸ”¥ í”„ë¡œê·¸ë¨ ìë™ ë“±ë¡ (4ê°œ ê¸°ë³¸ í”„ë¡œê·¸ë¨) - user_idëŠ” ì›ë˜ ì‚¬ìš©ì ID ì‚¬ìš©
    const programs = [
      { route: '/students', name: 'í•™ìƒ ê´€ë¦¬' },
      { route: '/tools/ai-learning-report', name: 'AIí•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸' },
      { route: '/tools/dashboard-analytics', name: 'í†µí•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ' },
      { route: '/tools/search-volume', name: 'ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ' }
    ]
    
    // user_programs í…Œì´ë¸”ì— ê¸°ë³¸ 4ê°œ í”„ë¡œê·¸ë¨ ì¶”ê°€
    for (const program of programs) {
      try {
        await c.env.DB.prepare(`
          INSERT OR IGNORE INTO user_programs (user_id, program_route, program_name, enabled, created_at)
          VALUES (?, ?, ?, 1, CURRENT_TIMESTAMP)
        `).bind(academyId, program.route, program.name).run()
      } catch (e) {
        console.error('[Payment Complete] Failed to add program:', program.name, e)
      }
    }
    
    console.log('[Payment Complete] Added 4 basic programs for user:', academyId)

    return c.json({ 
      success: true, 
      subscription: {
        id: result.meta.last_row_id,
        planName: planInfo.name,
        startDate,
        endDate
      }
    })
  } catch (error) {
    console.error('[Payment Complete] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// êµ¬ë… ìƒíƒœ í™•ì¸ API
app.get('/api/subscriptions/status', async (c) => {
  try {
    // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      console.log('[Subscription Status] No session_id cookie found')
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }
    
    // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ID ì¡°íšŒ
    const session = await c.env.DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')
    `).bind(sessionId).first()
    
    if (!session) {
      console.log('[Subscription Status] Session not found or expired')
      return c.json({ success: false, error: 'Session expired' }, 401)
    }

    const userId = session.user_id
    
    console.log('[Subscription Status] userId:', userId)
    
    // ì‚¬ìš©ìì˜ user_typeê³¼ academy_id ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT id, academy_id, user_type FROM users WHERE id = ?
    `).bind(userId).first()
    
    console.log('[Subscription Status] user:', user)
    
    // ğŸ”¥ í”Œëœ ìƒì† ì‹œìŠ¤í…œ: ì„ ìƒë‹˜ì€ ì›ì¥ì˜ í”Œëœì„ ìƒì†ë°›ìŒ
    let academyId
    if (user.user_type === 'teacher') {
      // ì„ ìƒë‹˜ì¸ ê²½ìš° academy_id (ì›ì¥ ID)ë¡œ êµ¬ë… ì¡°íšŒ
      academyId = user.academy_id
      console.log('ğŸ“ [Subscription Status] TEACHER detected!')
      console.log('  â””â”€ Teacher userId:', userId)
      console.log('  â””â”€ Owner academy_id:', academyId)
      
      // ğŸ”¥ academy_idê°€ ì—†ëŠ” ê²½ìš° parent_user_idë¥¼ ì‚¬ìš©
      if (!academyId) {
        console.log('  â””â”€ âš ï¸ academy_id is null, trying parent_user_id...')
        const parentUser = await c.env.DB.prepare(`
          SELECT parent_user_id FROM users WHERE id = ?
        `).bind(userId).first()
        
        if (parentUser?.parent_user_id) {
          academyId = parentUser.parent_user_id
          console.log('  â””â”€ âœ… Found parent_user_id:', academyId)
          
          // academy_id ìë™ ì„¤ì •
          try {
            await c.env.DB.prepare(`UPDATE users SET academy_id = ? WHERE id = ?`).bind(academyId, userId).run()
            console.log('  â””â”€ âœ… Auto-fixed academy_id to:', academyId)
          } catch (e) {
            console.error('  â””â”€ âŒ Failed to update academy_id:', e)
          }
        } else {
          console.error('  â””â”€ âŒ No parent_user_id found either!')
          return c.json({ 
            success: true,
            hasSubscription: false,
            message: 'ì„ ìƒë‹˜ ê³„ì •ì´ í•™ì›ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. í•™ì›ì¥ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.' 
          })
        }
      }
      
      console.log('  â””â”€ Will inherit owner\'s plan from academy_id:', academyId)
    } else {
      // ì›ì¥ì¸ ê²½ìš° ìì‹ ì˜ IDë¡œ êµ¬ë… ì¡°íšŒ
      academyId = user.id
      console.log('ğŸ‘¨â€ğŸ’¼ [Subscription Status] OWNER detected!')
      console.log('  â””â”€ Owner userId:', userId)
      console.log('  â””â”€ Using own academy_id:', academyId)
      
      // academy_idê°€ ìì‹ ì˜ IDì™€ ë‹¤ë¥´ë©´ ìˆ˜ì •
      if (user?.academy_id !== user.id) {
        console.log(`  â””â”€ Fixing academy_id from ${user?.academy_id} to ${user.id}`)
        try {
          await c.env.DB.prepare(`UPDATE users SET academy_id = ? WHERE id = ?`).bind(academyId, userId).run()
          console.log('  â””â”€ âœ… Fixed!')
        } catch (e) {
          console.error('  â””â”€ âŒ Failed to update academy_id:', e)
        }
      }
    }

    console.log('ğŸ” [Subscription Status] Querying subscription WHERE academy_id =', academyId, 'AND status = active')

    // í™œì„± êµ¬ë… ì¡°íšŒ
    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC
      LIMIT 1
    `).bind(academyId).first()

    console.log('ğŸ“‹ [Subscription Status] Active subscription:', subscription ? 'FOUND âœ…' : 'NOT FOUND âŒ')
    if (subscription) {
      console.log('  â””â”€ Subscription ID:', subscription.id)
      console.log('  â””â”€ Plan:', subscription.plan_name)
      console.log('  â””â”€ Academy ID:', subscription.academy_id)
      console.log('  â””â”€ Start:', subscription.subscription_start_date)
      console.log('  â””â”€ End:', subscription.subscription_end_date)
      console.log('  â””â”€ Limits:', {
        students: subscription.student_limit,
        aiReports: subscription.ai_report_limit,
        landingPages: subscription.landing_page_limit,
        teachers: subscription.teacher_limit
      })
    }

    if (!subscription) {
      // êµ¬ë…ì´ ì—†ì–´ë„ ê´€ë¦¬ìê°€ ì„¤ì •í•œ í•œë„ê°€ ìˆëŠ”ì§€ í™•ì¸
      console.log('âš ï¸ [Subscription Status] No active subscription, checking for admin plan...')
      
      const adminSubscription = await c.env.DB.prepare(`
        SELECT * FROM subscriptions 
        WHERE academy_id = ? AND plan_name = 'ê´€ë¦¬ì ì„¤ì • í”Œëœ'
        ORDER BY created_at DESC
        LIMIT 1
      `).bind(academyId).first()
      
      console.log('ğŸ“‹ [Subscription Status] Admin plan:', adminSubscription ? 'FOUND âœ…' : 'NOT FOUND âŒ')
      
      if (adminSubscription) {
        // ê´€ë¦¬ì ì„¤ì • í”Œëœì´ ìˆìœ¼ë©´ í‘œì‹œ
        console.log('âœ… [Subscription Status] Returning admin subscription')
        return c.json({ 
          success: true, 
          hasSubscription: true,
          subscription: {
            id: adminSubscription.id,
            planName: adminSubscription.plan_name,
            startDate: adminSubscription.subscription_start_date,
            endDate: adminSubscription.subscription_end_date,
            studentLimit: adminSubscription.student_limit || 0,
            aiReportLimit: adminSubscription.ai_report_limit || 0,
            landingPageLimit: adminSubscription.landing_page_limit || 0,
            teacherLimit: adminSubscription.teacher_limit || 0
          }
        })
      }
      
      console.error('ğŸ’¥ [Subscription Status] CRITICAL: No subscription found!')
      console.error('  â””â”€ User type:', user.user_type)
      console.error('  â””â”€ User ID:', userId)
      console.error('  â””â”€ Academy ID used:', academyId)
      console.error('  â””â”€ User academy_id:', user.academy_id)
      
      return c.json({ 
        success: true, 
        hasSubscription: false,
        message: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤'
      })
    }

    console.log('[Subscription Status] Found active subscription, checking expiration')

    // êµ¬ë… ë§Œë£Œ í™•ì¸ (í•œêµ­ ì‹œê°„ ê¸°ì¤€, ì¢…ë£Œì¼ 23:59:59ê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥)
    const now = new Date()
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)) // UTC+9
    const koreaDateStr = koreaTime.toISOString().split('T')[0]
    const endDateTime = new Date(subscription.subscription_end_date + 'T23:59:59+09:00')
    const isExpired = koreaTime > endDateTime

    if (isExpired) {
      // êµ¬ë… ë§Œë£Œ ì²˜ë¦¬
      await c.env.DB.prepare(`
        UPDATE subscriptions 
        SET status = 'expired', updated_at = CURRENT_TIMESTAMP
        WHERE id = ?
      `).bind(subscription.id).run()

      return c.json({ 
        success: true, 
        hasSubscription: false,
        message: 'êµ¬ë…ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤'
      })
    }

    return c.json({ 
      success: true, 
      hasSubscription: true,
      subscription: {
        id: subscription.id,
        planName: subscription.plan_name,
        startDate: subscription.subscription_start_date,
        endDate: subscription.subscription_end_date,
        studentLimit: subscription.student_limit,
        aiReportLimit: subscription.ai_report_limit,
        landingPageLimit: subscription.landing_page_limit,
        teacherLimit: subscription.teacher_limit
      }
    })
  } catch (error) {
    console.error('[Subscription Status] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ==================== êµ¬ë… ë§Œë£Œ ìë™ ì²˜ë¦¬ API ====================

// ğŸ”¥ Cron Job: ë§Œë£Œëœ ëª¨ë“  êµ¬ë… ìë™ ë¹„í™œì„±í™”
app.get('/api/subscriptions/check-expired', async (c) => {
  try {
    console.log('[Subscription Cron] Starting expired subscription check...')
    
    // í˜„ì¬ í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì˜¤ëŠ˜ ë‚ ì§œ
    const now = new Date()
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)) // UTC+9
    const todayKorea = koreaTime.toISOString().split('T')[0]
    
    console.log('[Subscription Cron] Today (Korea Time):', todayKorea)
    
    // ë§Œë£Œëœ êµ¬ë… ì°¾ê¸° (subscription_end_dateê°€ ì˜¤ëŠ˜ë³´ë‹¤ ì´ì „ì¸ active êµ¬ë…)
    const expiredSubscriptions = await c.env.DB.prepare(`
      SELECT id, academy_id, plan_name, subscription_end_date 
      FROM subscriptions 
      WHERE status = 'active' 
        AND subscription_end_date < ?
    `).bind(todayKorea).all()
    
    console.log('[Subscription Cron] Found', expiredSubscriptions.results.length, 'expired subscriptions')
    
    if (expiredSubscriptions.results.length === 0) {
      return c.json({ 
        success: true, 
        message: 'No expired subscriptions found',
        expiredCount: 0 
      })
    }
    
    // ê° ë§Œë£Œëœ êµ¬ë…ì„ ë¹„í™œì„±í™”í•˜ê³  ê´€ë ¨ ë°ì´í„° íšŒìˆ˜
    let expiredCount = 0
    for (const sub of expiredSubscriptions.results) {
      try {
        // 1. êµ¬ë… ìƒíƒœë¥¼ expiredë¡œ ë³€ê²½
        await c.env.DB.prepare(`
          UPDATE subscriptions 
          SET status = 'expired', updated_at = CURRENT_TIMESTAMP
          WHERE id = ?
        `).bind(sub.id).run()
        
        console.log('[Subscription Cron] Expired subscription:', {
          id: sub.id,
          academy_id: sub.academy_id,
          plan_name: sub.plan_name,
          end_date: sub.subscription_end_date
        })
        
        // ğŸ”¥ 2. í”Œëœ ìë™ íšŒìˆ˜: ê¶Œí•œ ë° í”„ë¡œê·¸ë¨ ì‚­ì œ
        try {
          // ì›ì¥ê³¼ í•´ë‹¹ í•™ì›ì˜ ëª¨ë“  ì„ ìƒë‹˜ ì°¾ê¸°
          const academyUsers = await c.env.DB.prepare(`
            SELECT id FROM users WHERE academy_id = ?
          `).bind(sub.academy_id).all()
          
          // ëª¨ë“  ì‚¬ìš©ìì˜ ê¶Œí•œ ë° í”„ë¡œê·¸ë¨ ì‚­ì œ
          for (const academyUser of academyUsers.results) {
            // user_permissions ì‚­ì œ
            await c.env.DB.prepare(`
              DELETE FROM user_permissions WHERE user_id = ?
            `).bind(academyUser.id).run()
            
            // user_programs ì‚­ì œ
            await c.env.DB.prepare(`
              DELETE FROM user_programs WHERE user_id = ?
            `).bind(academyUser.id).run()
          }
          
          // usage_tracking ë¦¬ì…‹
          await c.env.DB.prepare(`
            UPDATE usage_tracking 
            SET current_students = 0, 
                ai_reports_used_this_month = 0, 
                landing_pages_created = 0, 
                current_teachers = 0,
                sms_sent_this_month = 0,
                updated_at = CURRENT_TIMESTAMP
            WHERE academy_id = ?
          `).bind(sub.academy_id).run()
          
          console.log('[Subscription Cron] âœ… Auto-revoked plan for academy:', sub.academy_id)
        } catch (revokeErr) {
          console.error('[Subscription Cron] Failed to auto-revoke for academy', sub.academy_id, ':', revokeErr.message)
        }
        
        expiredCount++
      } catch (err) {
        console.error('[Subscription Cron] Failed to expire subscription', sub.id, ':', err.message)
      }
    }
    
    return c.json({ 
      success: true, 
      message: `Successfully expired ${expiredCount} subscriptions`,
      expiredCount,
      expiredSubscriptions: expiredSubscriptions.results.map(s => ({
        id: s.id,
        academy_id: s.academy_id,
        plan_name: s.plan_name,
        end_date: s.subscription_end_date
      }))
    })
  } catch (error) {
    console.error('[Subscription Cron] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ==================== ì‚¬ìš©ëŸ‰ í•œë„ ì²´í¬ API ====================

// ì‚¬ìš©ëŸ‰ ì¡°íšŒ API
app.get('/api/usage/check', async (c) => {
  try {
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    // ì„¸ì…˜ì—ì„œ user_id ì¡°íšŒ
    const session = await c.env.DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')
    `).bind(sessionId).first()
    
    if (!session) {
      return c.json({ success: false, error: 'Session expired or invalid' }, 401)
    }
    
    const userId = session.user_id
    
    // ì‚¬ìš©ìì˜ user_typeê³¼ academy_id ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT id, academy_id, user_type FROM users WHERE id = ?
    `).bind(userId).first()
    
    if (!user) {
      return c.json({ success: false, error: 'User not found' }, 404)
    }
    
    // ğŸ”¥ í”Œëœ ìƒì† ì‹œìŠ¤í…œ: ì„ ìƒë‹˜ì€ ì›ì¥ì˜ í”Œëœì„ ìƒì†ë°›ìŒ
    let academyId
    if (user.user_type === 'teacher') {
      // ì„ ìƒë‹˜ì¸ ê²½ìš° academy_id (ì›ì¥ ID)ë¡œ êµ¬ë… ì¡°íšŒ
      academyId = user.academy_id
      
      console.log('ğŸ“ [Usage Check] TEACHER detected!')
      console.log('  â””â”€ Teacher userId:', userId)
      console.log('  â””â”€ Owner academy_id:', academyId)
      
      // ğŸ”¥ academy_idê°€ ì—†ëŠ” ê²½ìš° parent_user_idë¥¼ ì‚¬ìš©
      if (!academyId) {
        console.log('  â””â”€ âš ï¸ academy_id is null, trying parent_user_id...')
        const parentUser = await c.env.DB.prepare(`
          SELECT parent_user_id FROM users WHERE id = ?
        `).bind(userId).first()
        
        if (parentUser?.parent_user_id) {
          academyId = parentUser.parent_user_id
          console.log('  â””â”€ âœ… Found parent_user_id:', academyId)
          
          // academy_id ìë™ ì„¤ì •
          try {
            await c.env.DB.prepare(`UPDATE users SET academy_id = ? WHERE id = ?`).bind(academyId, userId).run()
            console.log('  â””â”€ âœ… Auto-fixed academy_id to:', academyId)
          } catch (e) {
            console.error('  â””â”€ âŒ Failed to update academy_id:', e)
          }
        } else {
          console.error('  â””â”€ âŒ No parent_user_id found either!')
          return c.json({ 
            success: false, 
            error: 'ì„ ìƒë‹˜ ê³„ì •ì´ í•™ì›ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. í•™ì›ì¥ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.' 
          }, 403)
        }
      }
      
      console.log('  â””â”€ Will lookup subscription for owner academy_id:', academyId)
    } else {
      // ì›ì¥ì¸ ê²½ìš° ìì‹ ì˜ IDë¡œ êµ¬ë… ì¡°íšŒ
      academyId = user.id
      console.log('ğŸ‘¨â€ğŸ’¼ [Usage Check] OWNER detected!')
      console.log('  â””â”€ Owner userId:', userId)
      console.log('  â””â”€ Using own academy_id:', academyId)
      
      // academy_idê°€ ìì‹ ì˜ IDì™€ ë‹¤ë¥´ë©´ ìˆ˜ì •
      if (user?.academy_id !== user.id) {
        try {
          await c.env.DB.prepare(`UPDATE users SET academy_id = ? WHERE id = ?`).bind(academyId, userId).run()
          console.log('  â””â”€ Fixed academy_id from', user.academy_id, 'to', userId)
        } catch (e) {
          console.error('  â””â”€ Failed to update academy_id:', e)
        }
      }
    }

    console.log('ğŸ” [Usage Check] Querying subscription WHERE academy_id =', academyId)

    // í™œì„± êµ¬ë… ì¡°íšŒ
    let subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()

    console.log('ğŸ“‹ [Usage Check] Active subscription found:', subscription ? 'YES âœ…' : 'NO âŒ')
    if (subscription) {
      console.log('  â””â”€ Subscription ID:', subscription.id)
      console.log('  â””â”€ Plan:', subscription.plan_name)
      console.log('  â””â”€ Academy ID:', subscription.academy_id)
      console.log('  â””â”€ Status:', subscription.status)
      console.log('  â””â”€ End Date:', subscription.subscription_end_date)
    }

    // í™œì„± êµ¬ë…ì´ ì—†ìœ¼ë©´ ê´€ë¦¬ì ì„¤ì • í”Œëœ í™•ì¸
    if (!subscription) {
      console.log('âš ï¸ [Usage Check] No active subscription, checking admin plan...')
      subscription = await c.env.DB.prepare(`
        SELECT * FROM subscriptions 
        WHERE academy_id = ? AND plan_name = 'ê´€ë¦¬ì ì„¤ì • í”Œëœ'
        ORDER BY created_at DESC LIMIT 1
      `).bind(academyId).first()
      
      if (subscription) {
        console.log('âœ… [Usage Check] Found admin plan!')
      } else {
        console.log('âŒ [Usage Check] No admin plan either!')
      }
    }

    if (!subscription) {
      console.error('ğŸ’¥ [Usage Check] CRITICAL: No subscription found for academy_id:', academyId)
      console.error('  â””â”€ User type:', user.user_type)
      console.error('  â””â”€ User ID:', userId)
      console.error('  â””â”€ User academy_id:', user.academy_id)
      return c.json({ 
        success: false, 
        error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤' 
      }, 403)
    }

    // ğŸ”¥ êµ¬ë… ë§Œë£Œ ìë™ ì²´í¬ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
    const now = new Date()
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)) // UTC+9
    const endDateTime = new Date(subscription.subscription_end_date + 'T23:59:59+09:00')
    const isExpired = koreaTime > endDateTime
    
    if (isExpired) {
      console.log('[Usage Check] Subscription expired, updating status:', {
        subscriptionId: subscription.id,
        endDate: subscription.subscription_end_date
      })
      
      // êµ¬ë… ë§Œë£Œ ì²˜ë¦¬
      await c.env.DB.prepare(`
        UPDATE subscriptions 
        SET status = 'expired', updated_at = CURRENT_TIMESTAMP
        WHERE id = ?
      `).bind(subscription.id).run()
      
      return c.json({ 
        success: false, 
        error: 'êµ¬ë…ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
        expired: true,
        endDate: subscription.subscription_end_date
      }, 403)
    }

    // ğŸ”¥ ì‹¤ì œ ë°ì´í„° ì¡°íšŒ: students í…Œì´ë¸”ì—ì„œ ì‹¤ì œ í•™ìƒ ìˆ˜ ê³„ì‚°
    // academy_idë¡œ ì¡°íšŒí•˜ê³  status='active'ì¸ í•™ìƒë§Œ ì¹´ìš´íŠ¸
    let actualStudentsCount = 0
    try {
      // ë¨¼ì € users.academy_idê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
      console.log('[Usage Check] userId:', userId, 'academyId:', academyId)
      console.log('[Usage Check] user.academy_id:', user.academy_id, 'user.id:', user.id)
      
      const result = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM students 
        WHERE academy_id = ? AND status = 'active'
      `).bind(academyId).first()
      actualStudentsCount = result?.count || 0
      console.log('[Usage Check] Actual students count:', actualStudentsCount, 'for academy_id:', academyId)
      
      // ë””ë²„ê¹…: ëª¨ë“  í•™ìƒ ë ˆì½”ë“œ í™•ì¸
      const allStudents = await c.env.DB.prepare(`
        SELECT id, name, academy_id, status FROM students LIMIT 10
      `).all()
      console.log('[Usage Check] Sample students:', JSON.stringify(allStudents.results))
    } catch (err) {
      console.error('[Usage] students table error:', err.message)
    }
    
    // ğŸ”¥ ëˆ„ì  ëœë”©í˜ì´ì§€ ê°œìˆ˜ ì¡°íšŒ: usage_trackingì—ì„œ ëˆ„ì  ìƒì„± ê°œìˆ˜ ì‚¬ìš© (ì‚­ì œí•´ë„ ëˆ„ì  ìœ ì§€)
    let actualLandingPagesCount = 0
    let usage = null
    try {
      // usage_trackingì—ì„œ ë¨¼ì € ì¡°íšŒ
      usage = await c.env.DB.prepare(`
        SELECT * FROM usage_tracking 
        WHERE academy_id = ? AND subscription_id = ?
      `).bind(academyId, subscription.id).first()
      
      console.log('[Usage Check] ğŸ” Checking landing pages for academy_id:', academyId, 'subscription_id:', subscription.id)
      console.log('[Usage Check] ğŸ“Š usage_tracking record:', usage ? 'EXISTS' : 'NOT FOUND')
      
      // ğŸ”¥ í˜„ì¬ êµ¬ë… ê¸°ê°„ ë‚´ì— ìƒì„±ëœ ëœë”©í˜ì´ì§€ë§Œ COUNT
      // ì›ì¥ ë³¸ì¸ + í•´ë‹¹ í•™ì› ì†Œì† ì„ ìƒë‹˜ë“¤ì˜ ëœë”©í˜ì´ì§€ ëª¨ë‘ í¬í•¨
      const countResult = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM landing_pages 
        WHERE user_id IN (
          SELECT id FROM users WHERE id = ? OR academy_id = ?
        )
        AND created_at >= ?
      `).bind(academyId, academyId, subscription.subscription_start_date).first()
      const actualCount = countResult?.count || 0
      console.log('[Usage Check] ğŸ“ˆ Landing pages created since', subscription.subscription_start_date, ':', actualCount, 'for academy_id:', academyId, '(including teachers)')
      
      if (usage && usage.landing_pages_created !== null && usage.landing_pages_created !== undefined) {
        const trackedCount = usage.landing_pages_created
        console.log('[Usage Check] ğŸ“ usage_tracking.landing_pages_created:', trackedCount)
        
        // ğŸ”¥ ì‹¤ì œ ê°œìˆ˜ì™€ ë‹¤ë¥´ë©´ ë™ê¸°í™”
        if (trackedCount !== actualCount) {
          console.log('[Usage Check] âš ï¸ MISMATCH! Tracked:', trackedCount, 'vs Actual:', actualCount)
          console.log('[Usage Check] ğŸ”„ Auto-syncing to actual count...')
          try {
            await c.env.DB.prepare(`
              UPDATE usage_tracking 
              SET landing_pages_created = ?, updated_at = CURRENT_TIMESTAMP
              WHERE academy_id = ? AND subscription_id = ?
            `).bind(actualCount, academyId, subscription.id).run()
            console.log('[Usage Check] âœ… Synced to', actualCount)
            actualLandingPagesCount = actualCount
          } catch (syncErr) {
            console.error('[Usage Check] âŒ Sync failed:', syncErr.message)
            actualLandingPagesCount = trackedCount // ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ê°’ ìœ ì§€
          }
        } else {
          actualLandingPagesCount = trackedCount
          console.log('[Usage Check] âœ… Counts match:', actualLandingPagesCount)
        }
      } else {
        // ğŸ”¥ usage_tracking ë ˆì½”ë“œê°€ ì—†ìœ¼ë©´ ì‹¤ì œ ê°œìˆ˜ë¡œ ìƒì„±
        console.log('[Usage Check] âš ï¸ No usage_tracking record, creating with count:', actualCount)
        actualLandingPagesCount = actualCount
        
        try {
          await c.env.DB.prepare(`
            INSERT INTO usage_tracking (
              academy_id, subscription_id, current_students, ai_reports_used_this_month,
              landing_pages_created, current_teachers, sms_sent_this_month,
              created_at, updated_at
            ) VALUES (?, ?, 0, 0, ?, 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
          `).bind(academyId, subscription.id, actualLandingPagesCount).run()
          console.log('[Usage Check] âœ… Auto-created usage_tracking with', actualLandingPagesCount, 'landing pages')
        } catch (insertErr) {
          console.error('[Usage Check] âŒ Failed to auto-create usage_tracking:', insertErr.message)
        }
      }
    } catch (err) {
      console.error('[Usage] landing_pages_created error:', err.message)
    }
    
    // ğŸ”¥ ì‹¤ì œ ë°ì´í„° ì¡°íšŒ: users í…Œì´ë¸”ì—ì„œ ì‹¤ì œ ì„ ìƒë‹˜ ìˆ˜ ê³„ì‚°
    // academy_id ë˜ëŠ” parent_user_idê°€ ì›ì¥ IDì¸ ì„ ìƒë‹˜ë“¤
    let actualTeachersCount = 0
    try {
      // ğŸ”§ ë°©ë²• 1: academy_idë¡œ ì¡°íšŒ
      const resultByAcademyId = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM users 
        WHERE academy_id = ? AND user_type = 'teacher'
      `).bind(academyId).first()
      
      // ğŸ”§ ë°©ë²• 2: parent_user_idë¡œ ì¡°íšŒ (academy_idê°€ ì—†ëŠ” ê²½ìš° ëŒ€ë¹„)
      const resultByParentId = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM users 
        WHERE parent_user_id = ? AND user_type = 'teacher'
      `).bind(academyId).first()
      
      const countByAcademyId = resultByAcademyId?.count || 0
      const countByParentId = resultByParentId?.count || 0
      
      // ë‘ ë°©ë²• ì¤‘ í° ê°’ ì‚¬ìš© (ë” ì •í™•í•œ ê°’)
      actualTeachersCount = Math.max(countByAcademyId, countByParentId)
      
      console.log('[Usage Check] Teachers count by academy_id:', countByAcademyId)
      console.log('[Usage Check] Teachers count by parent_user_id:', countByParentId)
      console.log('[Usage Check] Using max count:', actualTeachersCount, 'for academy:', academyId)
      
      // ğŸ”¥ ìë™ ìˆ˜ì •: parent_user_idëŠ” ìˆëŠ”ë° academy_idê°€ ì—†ëŠ” ì„ ìƒë‹˜ ìˆ˜ì •
      if (countByParentId > countByAcademyId) {
        console.log('[Usage Check] âš ï¸ Found teachers without academy_id, auto-fixing...')
        
        try {
          const updateResult = await c.env.DB.prepare(`
            UPDATE users 
            SET academy_id = parent_user_id 
            WHERE parent_user_id = ? 
              AND user_type = 'teacher' 
              AND (academy_id IS NULL OR academy_id != parent_user_id)
          `).bind(academyId).run()
          
          console.log('[Usage Check] âœ… Auto-fixed', updateResult.meta.changes, 'teachers')
        } catch (updateErr) {
          console.error('[Usage Check] âŒ Failed to auto-fix:', updateErr.message)
        }
      }
      
      // ë””ë²„ê¹…: ì„ ìƒë‹˜ ëª©ë¡ í™•ì¸ (academy_id ë˜ëŠ” parent_user_id)
      const teachersList = await c.env.DB.prepare(`
        SELECT id, name, email, user_type, academy_id, parent_user_id FROM users 
        WHERE (academy_id = ? OR parent_user_id = ?) AND user_type = 'teacher'
        LIMIT 10
      `).bind(academyId, academyId).all()
      console.log('[Usage Check] Teachers list:', JSON.stringify(teachersList.results))
    } catch (err) {
      console.error('[Usage] teachers count error:', err.message)
    }

    // ğŸ”¥ usageëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì¡°íšŒë˜ì—ˆìŒ (line 10308)
    // AI ë¦¬í¬íŠ¸ ì‚¬ìš©ëŸ‰ (usage_trackingì—ì„œë§Œ ì¡°íšŒ)
    let aiReportsCount = 0
    if (usage) {
      aiReportsCount = usage.ai_reports_used_this_month || 0
      console.log('[Usage Check] âœ… AI reports:', aiReportsCount)
    } else {
      console.log('[Usage Check] âš ï¸ No usage_tracking for AI reports')
    }

    // ğŸ“Š ìµœì¢… ì‘ë‹µ: ì‹¤ì œ ë°ì´í„° ë°˜í™˜
    return c.json({
      success: true,
      limits: {
        students: subscription.student_limit,
        aiReports: subscription.ai_report_limit,
        landingPages: subscription.landing_page_limit,
        teachers: subscription.teacher_limit
      },
      usage: {
        students: actualStudentsCount,
        aiReports: aiReportsCount,
        landingPages: actualLandingPagesCount,
        teachers: actualTeachersCount,
        sms: usage?.sms_sent_this_month || 0
      }
    })
  } catch (error) {
    console.error('[Usage Check] Error:', error)
    return c.json({ 
      success: false, 
      error: error.message,
      stack: error.stack 
    }, 500)
  }
})

// í•™ìƒ ì¶”ê°€ ì „ í•œë„ ì²´í¬
app.post('/api/usage/check-student-limit', async (c) => {
  try {
    const session = getCookie(c, 'session_id')
    if (!session) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const sessionData = JSON.parse(session)
    const academyId = sessionData.id

    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()

    if (!subscription) {
      return c.json({ 
        success: false, 
        error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤' 
      }, 403)
    }

    const usage = await c.env.DB.prepare(`
      SELECT * FROM usage_tracking 
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(academyId, subscription.id).first()

    const currentStudents = usage?.current_students || 0
    const canAdd = currentStudents < subscription.student_limit

    return c.json({
      success: true,
      canAdd,
      current: currentStudents,
      limit: subscription.student_limit,
      message: canAdd ? 'í•™ìƒì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' : 'í•™ìƒ ìˆ˜ í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// AI ë¦¬í¬íŠ¸ ìƒì„± ì „ í•œë„ ì²´í¬
app.post('/api/usage/check-ai-report-limit', async (c) => {
  try {
    const session = getCookie(c, 'session_id')
    if (!session) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const sessionData = JSON.parse(session)
    const academyId = sessionData.id

    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()

    if (!subscription) {
      return c.json({ 
        success: false, 
        error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤' 
      }, 403)
    }

    const usage = await c.env.DB.prepare(`
      SELECT * FROM usage_tracking 
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(academyId, subscription.id).first()

    const currentReports = usage?.ai_reports_used_this_month || 0
    const canCreate = currentReports < subscription.ai_report_limit

    return c.json({
      success: true,
      canCreate,
      current: currentReports,
      limit: subscription.ai_report_limit,
      message: canCreate ? 'AI ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' : 'AI ë¦¬í¬íŠ¸ ì›”ê°„ í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ëœë”©í˜ì´ì§€ ìƒì„± ì „ í•œë„ ì²´í¬ (í¬ì¸íŠ¸ ì‹œìŠ¤í…œ í¬í•¨)
app.post('/api/usage/check-landing-page-limit', async (c) => {
  try {
    const session = getCookie(c, 'session_id')
    if (!session) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const sessionData = JSON.parse(session)
    const academyId = sessionData.id

    // ì‚¬ìš©ì í¬ì¸íŠ¸ ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT id, points FROM users WHERE id = ?
    `).bind(academyId).first()
    
    const userPoints = user?.points || 0

    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()

    if (!subscription) {
      return c.json({ 
        success: false, 
        error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤' 
      }, 403)
    }

    const usage = await c.env.DB.prepare(`
      SELECT * FROM usage_tracking 
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(academyId, subscription.id).first()

    const currentPages = usage?.landing_pages_created || 0
    const pageLimit = subscription.landing_page_limit
    const withinLimit = currentPages < pageLimit
    
    // í¬ì¸íŠ¸ë¡œ ì¶”ê°€ ìƒì„± ê°€ëŠ¥ ì—¬ë¶€ (ëœë”©í˜ì´ì§€ 1ê°œë‹¹ 7700í¬ì¸íŠ¸)
    const LANDING_PAGE_POINT_COST = 7700
    const canUsePoints = userPoints >= LANDING_PAGE_POINT_COST

    return c.json({
      success: true,
      canCreate: withinLimit || canUsePoints,
      withinLimit: withinLimit,
      canUsePoints: canUsePoints,
      current: currentPages,
      limit: pageLimit,
      userPoints: userPoints,
      pointCost: LANDING_PAGE_POINT_COST,
      message: withinLimit 
        ? 'ëœë”©í˜ì´ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' 
        : canUsePoints 
          ? `í•œë„ ì´ˆê³¼: í¬ì¸íŠ¸ë¡œ ìƒì„± ê°€ëŠ¥ (${LANDING_PAGE_POINT_COST}P ì°¨ê°)`
          : 'ëœë”©í˜ì´ì§€ í•œë„ ì´ˆê³¼ ë° í¬ì¸íŠ¸ ë¶€ì¡±'
    })
  } catch (error) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ì„ ìƒë‹˜ ì¶”ê°€ ì „ í•œë„ ì²´í¬
app.post('/api/usage/check-teacher-limit', async (c) => {
  try {
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    // ì„¸ì…˜ì—ì„œ user_id ì¡°íšŒ
    const session = await c.env.DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')
    `).bind(sessionId).first()
    
    if (!session) {
      return c.json({ success: false, error: 'Session expired' }, 401)
    }

    const userId = session.user_id
    
    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT id, academy_id, user_type FROM users WHERE id = ?
    `).bind(userId).first()
    
    if (!user) {
      return c.json({ success: false, error: 'User not found' }, 404)
    }

    // ğŸ”¥ í”Œëœ ìƒì†: ì„ ìƒë‹˜ì€ ì›ì¥ ID ì‚¬ìš©
    let academyId
    if (user.user_type === 'teacher') {
      academyId = user.academy_id
    } else {
      academyId = user.id
    }

    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()

    if (!subscription) {
      return c.json({ 
        success: false, 
        error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤' 
      }, 403)
    }

    // ğŸ”¥ ì‹¤ì œ ì„ ìƒë‹˜ ìˆ˜ ì¡°íšŒ (academy_id ë˜ëŠ” parent_user_id)
    const resultByAcademyId = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM users 
      WHERE academy_id = ? AND user_type = 'teacher'
    `).bind(academyId).first()
    
    const resultByParentId = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM users 
      WHERE parent_user_id = ? AND user_type = 'teacher'
    `).bind(academyId).first()
    
    const countByAcademyId = resultByAcademyId?.count || 0
    const countByParentId = resultByParentId?.count || 0
    const currentTeachers = Math.max(countByAcademyId, countByParentId)
    
    console.log('[Teacher Limit Check] By academy_id:', countByAcademyId, 'By parent_user_id:', countByParentId)
    console.log('[Teacher Limit Check] Using max:', currentTeachers, 'Limit:', subscription.teacher_limit)
    
    // ğŸ”¥ ìë™ ìˆ˜ì •
    if (countByParentId > countByAcademyId) {
      try {
        await c.env.DB.prepare(`
          UPDATE users 
          SET academy_id = parent_user_id 
          WHERE parent_user_id = ? AND user_type = 'teacher' 
            AND (academy_id IS NULL OR academy_id != parent_user_id)
        `).bind(academyId).run()
        console.log('[Teacher Limit Check] âœ… Auto-fixed teachers')
      } catch (err) {
        console.error('[Teacher Limit Check] Auto-fix failed:', err)
      }
    }
    
    const canAdd = currentTeachers < subscription.teacher_limit

    console.log('[Teacher Limit Check] Academy:', academyId, 'Current:', currentTeachers, 'Limit:', subscription.teacher_limit, 'Can add:', canAdd)

    return c.json({
      success: true,
      canAdd,
      current: currentTeachers,
      limit: subscription.teacher_limit,
      message: canAdd ? 'ì„ ìƒë‹˜ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤' : 'ì„ ìƒë‹˜ ê³„ì • í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('[Teacher Limit Check] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ì‚¬ìš©ëŸ‰ ì¦ê°€ API (í•™ìƒ ì¶”ê°€ ì‹œ)
app.post('/api/usage/increment-students', async (c) => {
  try {
    const session = getCookie(c, 'session_id')
    if (!session) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const sessionData = JSON.parse(session)
    const academyId = sessionData.id

    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()

    if (!subscription) {
      return c.json({ success: false, error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤' }, 403)
    }

    await c.env.DB.prepare(`
      UPDATE usage_tracking 
      SET current_students = current_students + 1, updated_at = CURRENT_TIMESTAMP
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(academyId, subscription.id).run()

    return c.json({ success: true, message: 'í•™ìƒ ìˆ˜ê°€ ì¦ê°€í–ˆìŠµë‹ˆë‹¤' })
  } catch (error) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ì‚¬ìš©ëŸ‰ ì¦ê°€ API (AI ë¦¬í¬íŠ¸ ìƒì„± ì‹œ)
app.post('/api/usage/increment-ai-reports', async (c) => {
  try {
    const session = getCookie(c, 'session_id')
    if (!session) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const sessionData = JSON.parse(session)
    const academyId = sessionData.id

    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()

    if (!subscription) {
      return c.json({ success: false, error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤' }, 403)
    }

    await c.env.DB.prepare(`
      UPDATE usage_tracking 
      SET ai_reports_used_this_month = ai_reports_used_this_month + 1, updated_at = CURRENT_TIMESTAMP
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(academyId, subscription.id).run()

    return c.json({ success: true, message: 'AI ë¦¬í¬íŠ¸ ì‚¬ìš©ëŸ‰ì´ ì¦ê°€í–ˆìŠµë‹ˆë‹¤' })
  } catch (error) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ì‚¬ìš©ëŸ‰ ì¦ê°€ API (ëœë”©í˜ì´ì§€ ìƒì„± ì‹œ)
app.post('/api/usage/increment-landing-pages', async (c) => {
  try {
    const session = getCookie(c, 'session_id')
    if (!session) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const sessionData = JSON.parse(session)
    const academyId = sessionData.id

    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()

    if (!subscription) {
      return c.json({ success: false, error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤' }, 403)
    }

    await c.env.DB.prepare(`
      UPDATE usage_tracking 
      SET landing_pages_created = landing_pages_created + 1, updated_at = CURRENT_TIMESTAMP
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(academyId, subscription.id).run()

    return c.json({ success: true, message: 'ëœë”©í˜ì´ì§€ ì‚¬ìš©ëŸ‰ì´ ì¦ê°€í–ˆìŠµë‹ˆë‹¤' })
  } catch (error) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ========================================
// ë¬´ë£Œ í”Œëœ ì‹ ì²­ API
// ========================================

// ë¬´ë£Œ í”Œëœ ì‹ ì²­
app.post('/api/free-plan/apply', async (c) => {
  try {
    const { userId, academyName, ownerName, email, phone, reason, isKoreaAcademy } = await c.req.json()
    
    if (!userId || !academyName || !ownerName || !email || !phone) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // ì´ë¯¸ ì‹ ì²­í•œ ë‚´ì—­ì´ ìˆëŠ”ì§€ í™•ì¸
    const existing = await c.env.DB.prepare(`
      SELECT id, status FROM free_plan_requests 
      WHERE user_id = ? AND status = 'pending'
    `).bind(userId).first()

    if (existing) {
      return c.json({ success: false, error: 'ì´ë¯¸ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ìˆìŠµë‹ˆë‹¤.' }, 400)
    }

    // ì´ë¯¸ ë¬´ë£Œ í”Œëœì„ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸
    const existingPlan = await c.env.DB.prepare(`
      SELECT id FROM subscriptions 
      WHERE academy_id = ? AND plan_name = 'ë¬´ë£Œ í”Œëœ' AND status = 'active'
    `).bind(userId).first()

    if (existingPlan) {
      return c.json({ success: false, error: 'ì´ë¯¸ ë¬´ë£Œ í”Œëœì„ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.' }, 400)
    }

    const result = await c.env.DB.prepare(`
      INSERT INTO free_plan_requests 
      (user_id, academy_name, owner_name, email, phone, reason, is_korea_academy, status, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, 'pending', CURRENT_TIMESTAMP)
    `).bind(userId, academyName, ownerName, email, phone, reason || null, isKoreaAcademy || 0).run()

    return c.json({
      success: true,
      message: 'ë¬´ë£Œ í”Œëœ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      requestId: result.meta.last_row_id
    })
  } catch (error) {
    console.error('ë¬´ë£Œ í”Œëœ ì‹ ì²­ ì‹¤íŒ¨:', error)
    return c.json({ success: false, error: 'ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ë¬´ë£Œ í”Œëœ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ
app.get('/api/free-plan/requests', async (c) => {
  try {
    const adminEmail = c.req.query('adminEmail')
    
    // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
    if (adminEmail !== 'admin@superplace.co.kr') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    const requests = await c.env.DB.prepare(`
      SELECT * FROM free_plan_requests
      ORDER BY 
        CASE status
          WHEN 'pending' THEN 1
          WHEN 'approved' THEN 2
          WHEN 'rejected' THEN 3
        END,
        created_at DESC
    `).all()

    return c.json({ success: true, requests: requests.results })
  } catch (error) {
    console.error('ì‹ ì²­ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error)
    return c.json({ success: false, error: 'ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ë¬´ë£Œ í”Œëœ ìŠ¹ì¸
app.post('/api/free-plan/approve', async (c) => {
  try {
    const { requestId, adminEmail } = await c.req.json()
    
    // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
    if (adminEmail !== 'admin@superplace.co.kr') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    // ì‹ ì²­ ì •ë³´ ì¡°íšŒ
    const request: any = await c.env.DB.prepare(`
      SELECT * FROM free_plan_requests WHERE id = ?
    `).bind(requestId).first()

    if (!request) {
      return c.json({ success: false, error: 'ì‹ ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    if (request.status !== 'pending') {
      return c.json({ success: false, error: 'ì´ë¯¸ ì²˜ë¦¬ëœ ì‹ ì²­ì…ë‹ˆë‹¤.' }, 400)
    }

    const userId = request.user_id

    console.log('[Free Plan Approve] Starting approval for user:', userId)

    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (ì •ìˆ˜ IDì¸ ê²½ìš°ë§Œ)
    let user: any = null
    let academyId: number
    
    // userIdê°€ ìˆ«ìì¸ ê²½ìš°ì—ë§Œ users í…Œì´ë¸”ì—ì„œ ì¡°íšŒ
    if (!isNaN(Number(userId))) {
      const numericUserId = Number(userId)
      user = await c.env.DB.prepare(`
        SELECT id, academy_id, name FROM users WHERE id = ?
      `).bind(numericUserId).first()
      
      if (user) {
        academyId = user.academy_id || user.id
        
        if (!user.academy_id) {
          await c.env.DB.prepare(`
            UPDATE users SET academy_id = ? WHERE id = ?
          `).bind(academyId, numericUserId).run()
        }
      } else {
        academyId = numericUserId
      }
    } else {
      // TEXT userIdë¥¼ ìˆ«ìë¡œ ë³€í™˜ (ê°„ë‹¨í•œ í•´ì‹œ)
      let hash = 0
      for (let i = 0; i < userId.length; i++) {
        hash = ((hash << 5) - hash) + userId.charCodeAt(i)
        hash = hash & hash // Convert to 32bit integer
      }
      academyId = Math.abs(hash)
    }
    
    console.log('[Free Plan Approve] Academy ID:', academyId)

    // academies í…Œì´ë¸”ì— academy ë ˆì½”ë“œ ìƒì„± (ì—†ìœ¼ë©´)
    // owner_idëŠ” ì„ì‹œê°’ 1 ì‚¬ìš© (FOREIGN KEY ì œì•½ íšŒí”¼)
    const existingAcademy = await c.env.DB.prepare(`
      SELECT id FROM academies WHERE id = ?
    `).bind(academyId).first()
    
    if (!existingAcademy) {
      try {
        await c.env.DB.prepare(`
          INSERT INTO academies (id, academy_name, owner_id, created_at)
          VALUES (?, ?, 1, CURRENT_TIMESTAMP)
        `).bind(academyId, request.academy_name).run()
        console.log('[Free Plan Approve] Created academy:', academyId)
      } catch (e) {
        console.log('[Free Plan Approve] Academy creation error:', e)
        // academies í…Œì´ë¸”ì´ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ë¬´ì‹œ
      }
    }

    // êµ¬ë… ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ê³„ì‚° (ì˜êµ¬ - 10ë…„)
    const startDate = new Date()
    const endDate = new Date()
    endDate.setFullYear(endDate.getFullYear() + 10)
    
    const startDateStr = startDate.toISOString().split('T')[0]
    const endDateStr = endDate.toISOString().split('T')[0]
    console.log('[Free Plan Approve] Date range:', startDateStr, 'to', endDateStr)

    // êµ¬ë… ìƒì„± (ë¬´ë£Œ í”Œëœ - ë§¤ë‹¬ 1ê°œ ëœë”©í˜ì´ì§€)
    // ë§¤ë‹¬ 1ì¼ì— ìë™ ê°±ì‹ ë˜ë„ë¡ 1ê°œì›” ê¸°ê°„ ì„¤ì •
    const monthlyStartDate = new Date()
    const monthlyEndDate = new Date()
    monthlyEndDate.setMonth(monthlyEndDate.getMonth() + 1)
    monthlyEndDate.setDate(1) // ë‹¤ìŒ ë‹¬ 1ì¼
    monthlyEndDate.setHours(0, 0, 0, 0)
    
    const monthlyStartStr = monthlyStartDate.toISOString().split('T')[0]
    const monthlyEndStr = monthlyEndDate.toISOString().split('T')[0]
    
    const subscriptionResult = await c.env.DB.prepare(`
      INSERT INTO subscriptions (
        academy_id, plan_name, plan_price, student_limit, ai_report_limit, 
        landing_page_limit, teacher_limit, subscription_start_date, 
        subscription_end_date, status, payment_method, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', 'free', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(
      academyId,
      'ë¬´ë£Œ í”Œëœ',
      0,
      50,  // í•™ìƒ 50ëª…
      0,   // AI ë¦¬í¬íŠ¸ ì—†ìŒ
      1,   // ëœë”©í˜ì´ì§€ ë§¤ë‹¬ 1ê°œ
      0,   // ì„ ìƒë‹˜ ì—†ìŒ
      monthlyStartStr,
      monthlyEndStr
    ).run()

    const subscriptionId = subscriptionResult.meta.last_row_id
    console.log('[Free Plan Approve] Created subscription:', subscriptionId)

    // ê¸°ì¡´ usage_tracking ì‚­ì œ (ìˆë‹¤ë©´)
    await c.env.DB.prepare(`
      DELETE FROM usage_tracking WHERE academy_id = ?
    `).bind(academyId).run()

    // usage_tracking ìƒì„±
    await c.env.DB.prepare(`
      INSERT INTO usage_tracking (
        academy_id, subscription_id, current_students, ai_reports_used_this_month,
        landing_pages_created, current_teachers, sms_sent_this_month,
        last_ai_report_reset_date, last_sms_reset_date, created_at, updated_at
      ) VALUES (?, ?, 0, 0, 0, 0, 0, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(
      academyId, 
      subscriptionId,
      startDateStr,
      startDateStr
    ).run()
    console.log('[Free Plan Approve] Created usage_tracking')

    // ğŸ”¥ í•™ìƒ ê´€ë¦¬ í”„ë¡œê·¸ë¨ë§Œ ìë™ ë“±ë¡
    const studentManagementProgram = { route: '/students', name: 'í•™ìƒ ê´€ë¦¬' }
    
    try {
      await c.env.DB.prepare(`
        INSERT OR IGNORE INTO user_programs (user_id, program_route, program_name, enabled, created_at)
        VALUES (?, ?, ?, 1, CURRENT_TIMESTAMP)
      `).bind(userId, studentManagementProgram.route, studentManagementProgram.name).run()
      
      console.log('[Free Plan Approve] Added student management program for user:', userId)
    } catch (e) {
      console.error('[Free Plan Approve] Failed to add program:', e)
    }

    // ì‹ ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE free_plan_requests
      SET status = 'approved', approved_at = CURRENT_TIMESTAMP, approved_by = ?
      WHERE id = ?
    `).bind(adminEmail, requestId).run()

    return c.json({
      success: true,
      message: 'ë¬´ë£Œ í”Œëœì´ ìŠ¹ì¸ë˜ê³  í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.',
      subscription_id: subscriptionId,
      academy_id: academyId
    })
  } catch (error) {
    console.error('[Free Plan Approve] Error:', error)
    return c.json({ 
      success: false, 
      error: 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error as Error).message 
    }, 500)
  }
})

// ê´€ë¦¬ì: ë¬´ë£Œ í”Œëœ ê±°ì ˆ
app.post('/api/free-plan/reject', async (c) => {
  try {
    const { requestId, adminEmail, reason } = await c.req.json()
    
    // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
    if (adminEmail !== 'admin@superplace.co.kr') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    await c.env.DB.prepare(`
      UPDATE free_plan_requests
      SET status = 'rejected', rejected_at = CURRENT_TIMESTAMP, rejected_by = ?, rejection_reason = ?
      WHERE id = ?
    `).bind(adminEmail, reason || null, requestId).run()

    return c.json({
      success: true,
      message: 'ë¬´ë£Œ í”Œëœ ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error) {
    console.error('ê±°ì ˆ ì²˜ë¦¬ ì‹¤íŒ¨:', error)
    return c.json({ success: false, error: 'ê±°ì ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ========================================
// ê³„ì¢Œì´ì²´ ê²°ì œ API
// ========================================

// ê³„ì¢Œì´ì²´ ì‹ ì²­
app.post('/api/bank-transfer/request', async (c) => {
  try {
    const { userId, userName, userEmail, userPhone, planName, amount, note } = await c.req.json()
    
    if (!userId || !userName || !userEmail || !userPhone || !planName || !amount) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    const result = await c.env.DB.prepare(`
      INSERT INTO bank_transfer_requests 
      (user_id, user_name, user_email, user_phone, plan_name, amount, note, status, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, 'pending', CURRENT_TIMESTAMP)
    `).bind(userId, userName, userEmail, userPhone, planName, amount, note || null).run()

    return c.json({
      success: true,
      message: 'ê³„ì¢Œì´ì²´ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      requestId: result.meta.last_row_id
    })
  } catch (error) {
    console.error('ê³„ì¢Œì´ì²´ ì‹ ì²­ ì‹¤íŒ¨:', error)
    return c.json({ success: false, error: 'ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ê³„ì¢Œì´ì²´ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ
app.get('/api/bank-transfer/requests', async (c) => {
  try {
    const adminEmail = c.req.query('adminEmail')
    
    // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
    if (adminEmail !== 'admin@superplace.co.kr') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    const requests = await c.env.DB.prepare(`
      SELECT * FROM bank_transfer_requests
      ORDER BY 
        CASE status
          WHEN 'pending' THEN 1
          WHEN 'approved' THEN 2
          WHEN 'rejected' THEN 3
        END,
        created_at DESC
    `).all()

    return c.json({
      success: true,
      requests: requests.results || []
    })
  } catch (error) {
    console.error('ì‹ ì²­ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error)
    return c.json({ success: false, error: 'ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì¹´ë“œê²°ì œ ì‹ ì²­ API
app.post('/api/card-payment/request', async (c) => {
  try {
    const { userId, userName, userEmail, userPhone, planName, amount, note } = await c.req.json()
    
    if (!userId || !userName || !userEmail || !userPhone || !planName || !amount) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    // card_payment_requests í…Œì´ë¸” ìƒì„± (ì—†ì„ ê²½ìš°)
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS card_payment_requests (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          user_name TEXT NOT NULL,
          user_email TEXT NOT NULL,
          user_phone TEXT NOT NULL,
          plan_name TEXT NOT NULL,
          amount INTEGER NOT NULL,
          note TEXT,
          status TEXT DEFAULT 'pending',
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          approved_at DATETIME,
          rejected_at DATETIME,
          processed_by TEXT
        )
      `).run()
    } catch (e) {
      console.log('[Card Payment] Table already exists')
    }

    const result = await c.env.DB.prepare(`
      INSERT INTO card_payment_requests 
      (user_id, user_name, user_email, user_phone, plan_name, amount, note, status, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, 'pending', CURRENT_TIMESTAMP)
    `).bind(userId, userName, userEmail, userPhone, planName, amount, note || null).run()

    return c.json({
      success: true,
      message: 'ì¹´ë“œê²°ì œ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ê²°ì œ ë§í¬ê°€ ë°œì†¡ë©ë‹ˆë‹¤.',
      requestId: result.meta.last_row_id
    })
  } catch (error) {
    console.error('ì¹´ë“œê²°ì œ ì‹ ì²­ ì‹¤íŒ¨:', error)
    return c.json({ success: false, error: 'ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ì¹´ë“œê²°ì œ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ
app.get('/api/card-payment/requests', async (c) => {
  try {
    const adminEmail = c.req.query('adminEmail')
    
    // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
    if (adminEmail !== 'admin@superplace.co.kr') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    const requests = await c.env.DB.prepare(`
      SELECT * FROM card_payment_requests
      ORDER BY 
        CASE status
          WHEN 'pending' THEN 1
          WHEN 'approved' THEN 2
          WHEN 'rejected' THEN 3
        END,
        created_at DESC
    `).all()

    return c.json({
      success: true,
      requests: requests.results || []
    })
  } catch (error) {
    console.error('ì¹´ë“œê²°ì œ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error)
    return c.json({ success: false, error: 'ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ì¹´ë“œê²°ì œ ì‹ ì²­ ìŠ¹ì¸
app.post('/api/card-payment/approve', async (c) => {
  try {
    const { requestId, adminEmail } = await c.req.json()
    
    // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
    if (adminEmail !== 'admin@superplace.co.kr') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    // ì‹ ì²­ ì •ë³´ ì¡°íšŒ
    const request: any = await c.env.DB.prepare(`
      SELECT * FROM card_payment_requests WHERE id = ?
    `).bind(requestId).first()

    if (!request) {
      return c.json({ success: false, error: 'ì‹ ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    if (request.status === 'approved') {
      return c.json({ success: false, error: 'ì´ë¯¸ ìŠ¹ì¸ëœ ì‹ ì²­ì…ë‹ˆë‹¤.' }, 400)
    }

    // í”Œëœë³„ í•œë„ ì„¤ì •
    const planLimits: any = {
      'ìŠ¤íƒ€í„° í”Œëœ': { student: 50, ai_report: 50, landing_page: 50, teacher: 2, price: 55000 },
      'ë² ì´ì§ í”Œëœ': { student: 150, ai_report: 150, landing_page: 160, teacher: 6, price: 143000 },
      'í”„ë¡œ í”Œëœ': { student: 500, ai_report: 500, landing_page: 530, teacher: 20, price: 187000 },
      'í”„ë¦¬ë¯¸ì—„ í”Œëœ': { student: 1000, ai_report: 1000, landing_page: 1100, teacher: 40, price: 330000 },
      'ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ': { student: 3000, ai_report: 3000, landing_page: 5000, teacher: 999, price: 750000 }
    }

    const limits = planLimits[request.plan_name] || planLimits['ìŠ¤íƒ€í„° í”Œëœ']

    // ì‚¬ìš©ìì˜ academy_idëŠ” user.idì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
    const academyId = request.user_id
    console.log('[Card Payment Approve] Using academyId:', academyId, 'for user:', request.user_id)
    
    const actualAcademyId = academyId
    console.log('[Card Payment Approve] Using academy_id = user.id:', actualAcademyId)
    
    // FOREIGN KEY ì œì•½ ë§Œì¡±: academies í…Œì´ë¸”ì— user.idë¥¼ idë¡œ í•˜ëŠ” ë ˆì½”ë“œ ìƒì„±
    try {
      const existingAcademy = await c.env.DB.prepare(`
        SELECT id FROM academies WHERE id = ?
      `).bind(actualAcademyId).first()
      
      if (!existingAcademy) {
        console.log('[Card Payment Approve] Creating academy with explicit id:', actualAcademyId)
        
        await c.env.DB.prepare(`PRAGMA foreign_keys = OFF`).run()
        
        await c.env.DB.prepare(`
          INSERT OR REPLACE INTO academies (id, academy_name, owner_id, created_at)
          VALUES (?, ?, ?, CURRENT_TIMESTAMP)
        `).bind(actualAcademyId, request.user_name + ' í•™ì›', actualAcademyId).run()
        
        await c.env.DB.prepare(`PRAGMA foreign_keys = ON`).run()
        
        console.log('[Card Payment Approve] Academy created with id:', actualAcademyId)
      }
    } catch (academyError) {
      console.error('[Card Payment Approve] Academy creation error:', academyError)
    }
    
    // users í…Œì´ë¸”ì—ì„œ academy_id ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE users SET academy_id = ? WHERE id = ?
    `).bind(actualAcademyId, request.user_id).run()
    console.log('[Card Payment Approve] Updated users.academy_id')

    // ê¸°ì¡´ í™œì„± êµ¬ë… ë¹„í™œì„±í™”
    await c.env.DB.prepare(`
      UPDATE subscriptions 
      SET status = 'expired', updated_at = CURRENT_TIMESTAMP
      WHERE academy_id = ? AND status = 'active'
    `).bind(actualAcademyId).run()
    console.log('[Card Payment Approve] Deactivated existing subscriptions')

    // êµ¬ë… ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ê³„ì‚° (1ê°œì›”)
    const startDate = new Date()
    const endDate = new Date()
    endDate.setMonth(endDate.getMonth() + 1)
    
    const startDateStr = startDate.toISOString().split('T')[0]
    const endDateStr = endDate.toISOString().split('T')[0]
    console.log('[Card Payment Approve] Date range:', startDateStr, 'to', endDateStr)

    // êµ¬ë… ìƒì„±
    const subscriptionResult = await c.env.DB.prepare(`
      INSERT INTO subscriptions (
        academy_id, plan_name, plan_price, student_limit, ai_report_limit, 
        landing_page_limit, teacher_limit, subscription_start_date, 
        subscription_end_date, status, payment_method, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', 'card_payment', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(
      actualAcademyId,
      request.plan_name,
      limits.price,
      limits.student,
      limits.ai_report,
      limits.landing_page,
      limits.teacher,
      startDateStr,
      endDateStr
    ).run()

    const subscriptionId = subscriptionResult.meta.last_row_id
    console.log('[Card Payment Approve] Created subscription:', subscriptionId)

    // ê¸°ì¡´ usage_tracking ì‚­ì œ
    await c.env.DB.prepare(`
      DELETE FROM usage_tracking WHERE academy_id = ?
    `).bind(actualAcademyId).run()
    console.log('[Card Payment Approve] Deleted old usage_tracking')

    // usage_tracking ìƒì„±
    await c.env.DB.prepare(`
      INSERT INTO usage_tracking (
        academy_id, subscription_id, current_students, ai_reports_used_this_month,
        landing_pages_created, current_teachers, sms_sent_this_month,
        last_ai_report_reset_date, last_sms_reset_date, created_at, updated_at
      ) VALUES (?, ?, 0, 0, 0, 0, 0, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(
      actualAcademyId, 
      subscriptionId,
      startDateStr,
      startDateStr
    ).run()
    console.log('[Card Payment Approve] Created usage_tracking')

    // ì‹ ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE card_payment_requests 
      SET status = 'approved', approved_at = CURRENT_TIMESTAMP, processed_by = ?
      WHERE id = ?
    `).bind(adminEmail, requestId).run()

    console.log(`âœ… ì¹´ë“œê²°ì œ ìŠ¹ì¸ ì™„ë£Œ: ${request.user_name} - ${request.plan_name}`)

    return c.json({
      success: true,
      message: `ì¹´ë“œê²°ì œ ì‹ ì²­ì´ ìŠ¹ì¸ë˜ê³  ${request.plan_name}ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìš©ìì—ê²Œ ê²°ì œ ë§í¬ë¥¼ ë°œì†¡í•´ì£¼ì„¸ìš”.`
    })
  } catch (error: any) {
    console.error('ì¹´ë“œê²°ì œ ì‹ ì²­ ìŠ¹ì¸ ì‹¤íŒ¨:', error)
    console.error('Error stack:', error?.stack)
    return c.json({ 
      success: false, 
      error: 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 
      details: error?.message || String(error),
      stack: error?.stack || ''
    }, 500)
  }
})

// ê´€ë¦¬ì: ì¹´ë“œê²°ì œ ì‹ ì²­ ê±°ë¶€
app.post('/api/card-payment/reject', async (c) => {
  try {
    const { requestId, adminEmail, reason } = await c.req.json()
    
    // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
    if (adminEmail !== 'admin@superplace.co.kr') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    await c.env.DB.prepare(`
      UPDATE card_payment_requests 
      SET status = 'rejected', rejected_at = CURRENT_TIMESTAMP, processed_by = ?, note = ?
      WHERE id = ?
    `).bind(adminEmail, reason || 'ê´€ë¦¬ìì— ì˜í•´ ê±°ë¶€ë¨', requestId).run()

    return c.json({
      success: true,
      message: 'ì¹´ë“œê²°ì œ ì‹ ì²­ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error) {
    console.error('ì¹´ë“œê²°ì œ ì‹ ì²­ ê±°ë¶€ ì‹¤íŒ¨:', error)
    return c.json({ success: false, error: 'ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ê³„ì¢Œì´ì²´ ìŠ¹ì¸
app.post('/api/bank-transfer/approve', async (c) => {
  try {
    const { requestId, adminEmail } = await c.req.json()
    
    // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
    if (adminEmail !== 'admin@superplace.co.kr') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    // ì‹ ì²­ ì •ë³´ ì¡°íšŒ
    const request: any = await c.env.DB.prepare(`
      SELECT * FROM bank_transfer_requests WHERE id = ?
    `).bind(requestId).first()

    if (!request) {
      return c.json({ success: false, error: 'ì‹ ì²­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    if (request.status === 'approved') {
      return c.json({ success: false, error: 'ì´ë¯¸ ìŠ¹ì¸ëœ ì‹ ì²­ì…ë‹ˆë‹¤.' }, 400)
    }

    // í”Œëœë³„ í•œë„ ì„¤ì •
    const planLimits: any = {
      'ìŠ¤íƒ€í„° í”Œëœ': { student: 50, ai_report: 50, landing_page: 50, teacher: 2, price: 55000 },
      'ë² ì´ì§ í”Œëœ': { student: 150, ai_report: 150, landing_page: 160, teacher: 6, price: 143000 },
      'í”„ë¡œ í”Œëœ': { student: 500, ai_report: 500, landing_page: 530, teacher: 20, price: 187000 },
      'í”„ë¦¬ë¯¸ì—„ í”Œëœ': { student: 1000, ai_report: 1000, landing_page: 1100, teacher: 40, price: 330000 },
      'ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ': { student: 3000, ai_report: 3000, landing_page: 5000, teacher: 999, price: 750000 }
    }

    const limits = planLimits[request.plan_name] || planLimits['ìŠ¤íƒ€í„° í”Œëœ']

    // ì‚¬ìš©ìì˜ academy_idëŠ” user.idì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
    const academyId = request.user_id
    console.log('[Bank Transfer Approve] Using academyId:', academyId, 'for user:', request.user_id)
    
    // ğŸ”¥ í•µì‹¬: academy_idëŠ” í•­ìƒ user.idë¥¼ ì§ì ‘ ì‚¬ìš© (êµ¬ë… ì¡°íšŒ APIì™€ ì™„ì „ ì¼ì¹˜)
    const actualAcademyId = academyId // user.id
    console.log('[Bank Transfer Approve] Using academy_id = user.id:', actualAcademyId)
    
    // ğŸ”¥ FOREIGN KEY ì œì•½ ë§Œì¡±: academies í…Œì´ë¸”ì— user.idë¥¼ idë¡œ í•˜ëŠ” ë ˆì½”ë“œ ìƒì„±
    // SQLiteì—ì„œ ëª…ì‹œì  idë¥¼ ì‚½ì…í•˜ë ¤ë©´ íŠ¹ë³„í•œ ë°©ë²• í•„ìš”
    try {
      // ë¨¼ì € í•´ë‹¹ idê°€ ìˆëŠ”ì§€ í™•ì¸
      const existingAcademy = await c.env.DB.prepare(`
        SELECT id FROM academies WHERE id = ?
      `).bind(actualAcademyId).first()
      
      if (!existingAcademy) {
        console.log('[Bank Transfer Approve] Creating academy with explicit id:', actualAcademyId)
        
        // AUTOINCREMENT ì œì•½ì„ ìš°íšŒí•˜ê¸° ìœ„í•´ sqlite_sequence ì¡°ì‘
        // ë°©ë²• 1: AUTOINCREMENTê°€ ì—†ëŠ” í…Œì´ë¸”ì´ë¼ë©´ ì§ì ‘ ì‚½ì… ê°€ëŠ¥
        // ë°©ë²• 2: ì„ì‹œë¡œ FOREIGN KEY ì²´í¬ ë¹„í™œì„±í™”
        
        // PRAGMAë¥¼ ì‚¬ìš©í•˜ì—¬ FOREIGN KEY ì²´í¬ë¥¼ ì„ì‹œë¡œ ë„ê³  ì‚½ì…
        await c.env.DB.prepare(`PRAGMA foreign_keys = OFF`).run()
        
        await c.env.DB.prepare(`
          INSERT OR REPLACE INTO academies (id, academy_name, owner_id, created_at)
          VALUES (?, ?, ?, CURRENT_TIMESTAMP)
        `).bind(actualAcademyId, request.user_name + ' í•™ì›', actualAcademyId).run()
        
        await c.env.DB.prepare(`PRAGMA foreign_keys = ON`).run()
        
        console.log('[Bank Transfer Approve] Academy created with id:', actualAcademyId)
      }
    } catch (academyError) {
      console.error('[Bank Transfer Approve] Academy creation error:', academyError)
      // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (FOREIGN KEY ì²´í¬ê°€ êº¼ì ¸ìˆì„ ìˆ˜ë„ ìˆìŒ)
    }
    
    // users í…Œì´ë¸”ì—ì„œ academy_id ì—…ë°ì´íŠ¸ (ìê¸° ìì‹ ì˜ IDë¡œ)
    await c.env.DB.prepare(`
      UPDATE users SET academy_id = ? WHERE id = ?
    `).bind(actualAcademyId, request.user_id).run()
    console.log('[Bank Transfer Approve] Updated users.academy_id')

    // ê¸°ì¡´ í™œì„± êµ¬ë… ë¹„í™œì„±í™”
    await c.env.DB.prepare(`
      UPDATE subscriptions 
      SET status = 'expired', updated_at = CURRENT_TIMESTAMP
      WHERE academy_id = ? AND status = 'active'
    `).bind(actualAcademyId).run()
    console.log('[Bank Transfer Approve] Deactivated existing subscriptions')

    // êµ¬ë… ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ê³„ì‚° (1ê°œì›”)
    const startDate = new Date()
    const endDate = new Date()
    endDate.setMonth(endDate.getMonth() + 1)
    
    const startDateStr = startDate.toISOString().split('T')[0]
    const endDateStr = endDate.toISOString().split('T')[0]
    console.log('[Bank Transfer Approve] Date range:', startDateStr, 'to', endDateStr)

    // êµ¬ë… ìƒì„± (academy_id = user.id ì§ì ‘ ì‚¬ìš©)
    const subscriptionResult = await c.env.DB.prepare(`
      INSERT INTO subscriptions (
        academy_id, plan_name, plan_price, student_limit, ai_report_limit, 
        landing_page_limit, teacher_limit, subscription_start_date, 
        subscription_end_date, status, payment_method, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', 'bank_transfer', CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(
      actualAcademyId,
      request.plan_name,
      limits.price,
      limits.student,
      limits.ai_report,
      limits.landing_page,
      limits.teacher,
      startDateStr,
      endDateStr
    ).run()

    const subscriptionId = subscriptionResult.meta.last_row_id
    console.log('[Bank Transfer Approve] Created subscription:', subscriptionId)

    // ê¸°ì¡´ usage_tracking ì‚­ì œ (ìˆë‹¤ë©´)
    await c.env.DB.prepare(`
      DELETE FROM usage_tracking WHERE academy_id = ?
    `).bind(actualAcademyId).run()
    console.log('[Bank Transfer Approve] Deleted old usage_tracking')

    // usage_tracking ìƒì„±
    await c.env.DB.prepare(`
      INSERT INTO usage_tracking (
        academy_id, subscription_id, current_students, ai_reports_used_this_month,
        landing_pages_created, current_teachers, sms_sent_this_month,
        last_ai_report_reset_date, last_sms_reset_date, created_at, updated_at
      ) VALUES (?, ?, 0, 0, 0, 0, 0, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(
      actualAcademyId, 
      subscriptionId,
      startDateStr,
      startDateStr
    ).run()
    console.log('[Bank Transfer Approve] Created usage_tracking')

    // ğŸ”¥ í”„ë¡œê·¸ë¨ ìë™ ë“±ë¡ (4ê°œ ê¸°ë³¸ í”„ë¡œê·¸ë¨)
    const programs = [
      { route: '/students', name: 'í•™ìƒ ê´€ë¦¬' },
      { route: '/tools/ai-learning-report', name: 'AIí•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸' },
      { route: '/tools/dashboard-analytics', name: 'í†µí•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ' },
      { route: '/tools/search-volume', name: 'ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ' }
    ]
    
    // user_programs í…Œì´ë¸”ì— ê¸°ë³¸ 4ê°œ í”„ë¡œê·¸ë¨ ì¶”ê°€
    for (const program of programs) {
      try {
        await c.env.DB.prepare(`
          INSERT OR IGNORE INTO user_programs (user_id, program_route, program_name, enabled, created_at)
          VALUES (?, ?, ?, 1, CURRENT_TIMESTAMP)
        `).bind(request.user_id, program.route, program.name).run()
      } catch (e) {
        console.error('[Bank Transfer Approve] Failed to add program:', program.name, e)
      }
    }
    
    console.log('[Bank Transfer Approve] Added 4 basic programs for user:', request.user_id)

    // ì‹ ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE bank_transfer_requests
      SET status = 'approved', approved_at = CURRENT_TIMESTAMP, approved_by = ?
      WHERE id = ?
    `).bind(adminEmail, requestId).run()

    return c.json({
      success: true,
      message: 'ê³„ì¢Œì´ì²´ê°€ ìŠ¹ì¸ë˜ê³  êµ¬ë…ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.',
      subscription_id: subscriptionId,
      academy_id: actualAcademyId
    })
  } catch (error) {
    console.error('[Bank Transfer Approve] Error:', error)
    console.error('[Bank Transfer Approve] Error stack:', (error as Error).stack)
    console.error('[Bank Transfer Approve] Error message:', (error as Error).message)
    return c.json({ 
      success: false, 
      error: 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error as Error).message 
    }, 500)
  }
})

// ê´€ë¦¬ì: ê³„ì¢Œì´ì²´ ê±°ì ˆ
app.post('/api/bank-transfer/reject', async (c) => {
  try {
    const { requestId, adminEmail, reason } = await c.req.json()
    
    // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
    if (adminEmail !== 'admin@superplace.co.kr') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    await c.env.DB.prepare(`
      UPDATE bank_transfer_requests
      SET status = 'rejected', rejected_at = CURRENT_TIMESTAMP, rejected_by = ?, rejection_reason = ?
      WHERE id = ?
    `).bind(adminEmail, reason || null, requestId).run()

    return c.json({
      success: true,
      message: 'ê³„ì¢Œì´ì²´ ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error) {
    console.error('ê±°ì ˆ ì²˜ë¦¬ ì‹¤íŒ¨:', error)
    return c.json({ success: false, error: 'ê±°ì ˆ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì‚¬ìš©ëŸ‰ ì¦ê°€ API (ì„ ìƒë‹˜ ì¶”ê°€ ì‹œ)
app.post('/api/usage/increment-teachers', async (c) => {
  try {
    const session = getCookie(c, 'session_id')
    if (!session) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const sessionData = JSON.parse(session)
    const academyId = sessionData.id

    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()

    if (!subscription) {
      return c.json({ success: false, error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤' }, 403)
    }

    await c.env.DB.prepare(`
      UPDATE usage_tracking 
      SET current_teachers = current_teachers + 1, updated_at = CURRENT_TIMESTAMP
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(academyId, subscription.id).run()

    return c.json({ success: true, message: 'ì„ ìƒë‹˜ ìˆ˜ê°€ ì¦ê°€í–ˆìŠµë‹ˆë‹¤' })
  } catch (error) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ”¥ ê´€ë¦¬ì: ì‚¬ìš©ì ì‚¬ìš© í•œë„ ìˆ˜ì • API (êµ¬ë… ìƒì„± í¬í•¨)
app.post('/api/admin/usage/:userId/update-limits', async (c) => {
  try {
    const userId = c.req.param('userId')
    const { studentLimit, aiReportLimit, landingPageLimit, teacherLimit, subscriptionDays, subscriptionMonths, durationType } = await c.req.json()
    
    // ì¼/ì›” ë‹¨ìœ„ ê³„ì‚°
    let months = 0;
    let days = 0;
    let periodDisplay = '';
    
    if (durationType === 'days') {
      days = subscriptionDays || 1;
      periodDisplay = `${days}ì¼`;
      console.log('[Admin] Duration type: days, days:', days);
    } else {
      months = subscriptionMonths || 1;
      periodDisplay = `${months}ê°œì›”`;
      console.log('[Admin] Duration type: months, months:', months);
    }
    
    console.log('[Admin] Updating usage limits for user:', userId, 'period:', periodDisplay)
    
    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    const user = await c.env.DB.prepare('SELECT id, email, name, academy_id, academy_name FROM users WHERE id = ?').bind(userId).first()
    
    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    // academy_idëŠ” ì•„ë˜ì—ì„œ ì²˜ë¦¬ë¨
    let academyId = null
    
    // í•´ë‹¹ ì‚¬ìš©ì(academy)ì˜ ê¸°ì¡´ êµ¬ë… ì¡°íšŒ
    const existingSubscription = await c.env.DB.prepare(`
      SELECT id FROM subscriptions 
      WHERE academy_id = ? AND plan_name = 'ê´€ë¦¬ì ì„¤ì • í”Œëœ'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()
    
    // í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ê³„ì‚°
    const now = new Date()
    const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)) // UTC+9
    const today = koreaTime.toISOString().split('T')[0]
    
    // ì¢…ë£Œì¼ ê³„ì‚°
    const endDate = new Date(koreaTime);
    if (durationType === 'days') {
      // ì¼ ë‹¨ìœ„: Nì¼ í›„ (ë‹¹ì¼ í¬í•¨í•˜ë©´ -1ì¼ ì•ˆí•¨)
      endDate.setDate(endDate.getDate() + days - 1); // 1ì¼ì´ë©´ ì˜¤ëŠ˜ê¹Œì§€
    } else {
      // ì›” ë‹¨ìœ„: Nê°œì›” í›„ ì „ë‚ ê¹Œì§€
      endDate.setMonth(endDate.getMonth() + months);
      endDate.setDate(endDate.getDate() - 1);
    }
    const subscriptionEndDate = endDate.toISOString().split('T')[0]
    
    console.log(`[Admin] Subscription period: ${today} to ${subscriptionEndDate} (${periodDisplay})`)
    
    // ğŸ”¥ CRITICAL: academies í…Œì´ë¸”ì— ë ˆì½”ë“œ ìƒì„± (AUTOINCREMENT ê³ ë ¤)
    console.log('[Admin] Ensuring academy record exists for user:', userId)
    console.log('[Admin] User info:', { id: user.id, name: user.name, academy_id: user.academy_id })
    
    try {
      const academyName = user.academy_name || user.name + 'í•™ì›'
      
      // Step 1: ì‚¬ìš©ìì˜ academy_id í™•ì¸
      let finalAcademyId = user.academy_id
      
      if (!finalAcademyId || finalAcademyId == null) {
        // academy_idê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
        console.log('[Admin] Creating new academy record')
        console.log('[Admin] Academy name:', academyName)
        
        try {
          // âš¡ FOREIGN KEY ìš°íšŒ: owner_idë¥¼ 1 (admin)ë¡œ ê³ ì •í•˜ì—¬ ìƒì„±
          console.log('[Admin] Using owner_id=1 (admin) to bypass FOREIGN KEY constraint')
          
          const insertResult = await c.env.DB.prepare(`
            INSERT INTO academies (academy_name, owner_id, created_at)
            VALUES (?, 1, datetime('now'))
          `).bind(academyName).run()
          
          finalAcademyId = insertResult.meta.last_row_id
          console.log('[Admin] âœ… New academy created with ID:', finalAcademyId, '(owner_id=1)')
          
          // users í…Œì´ë¸” ì—…ë°ì´íŠ¸
          await c.env.DB.prepare(`
            UPDATE users SET academy_id = ? WHERE id = ?
          `).bind(finalAcademyId, user.id).run()
          
          console.log('[Admin] âœ… User academy_id updated to:', finalAcademyId)
        } catch (insertError) {
          console.error('[Admin] âŒ Academy INSERT failed even with owner_id=1:', insertError.message)
          
          // ê·¸ë˜ë„ ì‹¤íŒ¨í•˜ë©´ user.idë¥¼ academy_idë¡œ ì‚¬ìš©
          console.warn('[Admin] ğŸ”§ Final fallback: using user.id as academy_id without academy record')
          finalAcademyId = user.id
          
          // users í…Œì´ë¸”ì˜ academy_id ì—…ë°ì´íŠ¸
          await c.env.DB.prepare(`
            UPDATE users SET academy_id = ? WHERE id = ?
          `).bind(finalAcademyId, user.id).run()
          
          console.log('[Admin] âœ… Using user.id as academy_id:', finalAcademyId)
        }
      } else {
        // academy_idê°€ ìˆìœ¼ë©´ í•´ë‹¹ academyê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        const existingAcademy = await c.env.DB.prepare(`
          SELECT id FROM academies WHERE id = ?
        `).bind(finalAcademyId).first()
        
        if (!existingAcademy) {
          // academy_idê°€ ìˆëŠ”ë° ì‹¤ì œ ë ˆì½”ë“œê°€ ì—†ìœ¼ë©´ ìƒì„±
          console.log('[Admin] academy_id exists but record missing, creating new academy')
          
          const insertResult = await c.env.DB.prepare(`
            INSERT INTO academies (academy_name, owner_id, created_at)
            VALUES (?, ?, datetime('now'))
          `).bind(academyName, user.id).run()
          
          const newId = insertResult.meta.last_row_id
          console.log('[Admin] Created academy with ID:', newId)
          
          // IDê°€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ users ì—…ë°ì´íŠ¸
          if (newId !== finalAcademyId) {
            finalAcademyId = newId
            await c.env.DB.prepare(`
              UPDATE users SET academy_id = ? WHERE id = ?
            `).bind(finalAcademyId, user.id).run()
            console.log('[Admin] Updated user academy_id to match:', finalAcademyId)
          }
        } else {
          console.log('[Admin] âœ… Academy record already exists with ID:', finalAcademyId)
        }
      }
      
      // ìµœì¢… í™•ì¸ (academy ë ˆì½”ë“œê°€ ì—†ì–´ë„ ì§„í–‰ ê°€ëŠ¥)
      const verifyAcademy = await c.env.DB.prepare(`
        SELECT id, academy_name, owner_id FROM academies WHERE id = ?
      `).bind(finalAcademyId).first()
      
      if (verifyAcademy) {
        console.log(`âœ… [Admin] Academy verified: ID=${verifyAcademy.id}, Name=${verifyAcademy.academy_name}`)
      } else {
        console.warn(`âš ï¸ [Admin] Academy record not found for ID=${finalAcademyId}, but continuing with subscription creation`)
        console.warn('[Admin] This is acceptable - subscriptions can work without academy records in some cases')
      }
      
      // ì´ì œ finalAcademyIdë¥¼ ì‚¬ìš©
      academyId = finalAcademyId
    } catch (academyError) {
      console.error('[Admin] Academy handling failed:', academyError.message)
      console.error('[Admin] Stack:', academyError.stack)
      return c.json({ 
        success: false, 
        error: `Academy ì²˜ë¦¬ ì‹¤íŒ¨: ${academyError.message}` 
      }, 500)
    }
    
    if (existingSubscription) {
      // ê¸°ì¡´ ê´€ë¦¬ì í”Œëœ ì—…ë°ì´íŠ¸
      console.log('[Admin] Updating existing admin subscription:', existingSubscription.id)
      
      await c.env.DB.prepare(`
        UPDATE subscriptions 
        SET student_limit = ?, 
            ai_report_limit = ?, 
            landing_page_limit = ?, 
            teacher_limit = ?,
            subscription_start_date = ?,
            subscription_end_date = ?,
            status = 'active',
            updated_at = CURRENT_TIMESTAMP
        WHERE id = ?
      `).bind(studentLimit, aiReportLimit, landingPageLimit, teacherLimit, today, subscriptionEndDate, existingSubscription.id).run()
      
      // usage_trackingë„ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ìƒì„±
      try {
        const existingUsage = await c.env.DB.prepare(`
          SELECT id FROM usage_tracking WHERE academy_id = ? AND subscription_id = ?
        `).bind(academyId, existingSubscription.id).first()
        
        if (!existingUsage) {
          console.log('[Admin] Creating missing usage_tracking for existing subscription')
          await c.env.DB.prepare(`
            INSERT INTO usage_tracking (
              academy_id, subscription_id,
              current_students, ai_reports_used_this_month, 
              landing_pages_created, current_teachers,
              created_at, updated_at
            )
            VALUES (?, ?, 0, 0, 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
          `).bind(academyId, existingSubscription.id).run()
        }
      } catch (usageError) {
        console.warn('[Admin] Failed to create usage_tracking (may already exist):', usageError.message)
        // Continue anyway - usage_tracking is not critical for subscription limits
      }
      
      console.log('âœ… [Admin] Existing admin subscription updated')
    } else {
      // ìƒˆ ê´€ë¦¬ì í”Œëœ ìƒì„±
      console.log('[Admin] Creating new admin subscription for academy_id:', academyId)
      
      try {
        const newSubResult = await c.env.DB.prepare(`
          INSERT INTO subscriptions (
            academy_id, plan_name, plan_price, 
            student_limit, ai_report_limit, landing_page_limit, teacher_limit,
            subscription_start_date, subscription_end_date, status, payment_method,
            merchant_uid, created_at
          )
          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
        `).bind(
          academyId, 'ê´€ë¦¬ì ì„¤ì • í”Œëœ', 0,
          studentLimit, aiReportLimit, landingPageLimit, teacherLimit,
          today, subscriptionEndDate, 'active', 'admin',
          'admin_' + userId + '_' + Date.now()
        ).run()
        
        const newSubId = newSubResult.meta.last_row_id
        console.log('[Admin] âœ… Subscription created with ID:', newSubId)
        
        // usage_tracking ìƒì„±
        try {
          await c.env.DB.prepare(`
            INSERT INTO usage_tracking (
              academy_id, subscription_id,
              current_students, ai_reports_used_this_month, 
              landing_pages_created, current_teachers,
              created_at, updated_at
            )
            VALUES (?, ?, 0, 0, 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
          `).bind(academyId, newSubId).run()
          console.log('âœ… [Admin] New admin subscription created with usage_tracking')
        } catch (usageError) {
          console.warn('[Admin] Failed to create usage_tracking:', usageError.message)
          console.log('âœ… [Admin] New admin subscription created (usage_tracking will be auto-created on first use)')
        }
      } catch (subscriptionError) {
        console.error('[Admin] âŒ Subscription INSERT failed:', subscriptionError.message)
        
        if (subscriptionError.message && subscriptionError.message.includes('FOREIGN KEY')) {
          console.error('[Admin] ğŸ”§ Subscription FOREIGN KEY error!')
          console.error('[Admin] academy_id used:', academyId)
          
          // academies í…Œì´ë¸”ì— ë ˆì½”ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
          const academyCheck = await c.env.DB.prepare(`
            SELECT id, academy_name FROM academies WHERE id = ?
          `).bind(academyId).first()
          
          if (!academyCheck) {
            console.error('[Admin] âŒ Academy record missing for ID:', academyId)
            console.error('[Admin] ğŸ”§ Creating academy record now...')
            
            // ê°•ì œë¡œ academy ë ˆì½”ë“œ ìƒì„± ì‹œë„ (owner_idë¥¼ 1ë¡œ ì„¤ì • - admin)
            try {
              await c.env.DB.prepare(`
                INSERT INTO academies (academy_name, owner_id, created_at)
                VALUES (?, ?, datetime('now'))
              `).bind(user.name + 'í•™ì›', 1).run() // owner_idë¥¼ 1 (admin)ë¡œ ì„¤ì •
              
              console.log('[Admin] âœ… Academy record created with admin as owner')
              
              // ë‹¤ì‹œ subscription ìƒì„± ì‹œë„
              const retrySubResult = await c.env.DB.prepare(`
                INSERT INTO subscriptions (
                  academy_id, plan_name, plan_price, 
                  student_limit, ai_report_limit, landing_page_limit, teacher_limit,
                  subscription_start_date, subscription_end_date, status, payment_method,
                  merchant_uid, created_at
                )
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
              `).bind(
                academyId, 'ê´€ë¦¬ì ì„¤ì • í”Œëœ', 0,
                studentLimit, aiReportLimit, landingPageLimit, teacherLimit,
                today, subscriptionEndDate, 'active', 'admin',
                'admin_' + userId + '_' + Date.now()
              ).run()
              
              console.log('[Admin] âœ… Subscription created on retry:', retrySubResult.meta.last_row_id)
            } catch (retryError) {
              console.error('[Admin] âŒ Retry also failed:', retryError.message)
              throw retryError
            }
          } else {
            console.error('[Admin] Academy exists but FK still failed - unknown issue')
            throw subscriptionError
          }
        } else {
          throw subscriptionError
        }
      }
    }
    
    return c.json({ 
      success: true, 
      message: 'ì‚¬ìš© í•œë„ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤',
      limits: {
        studentLimit,
        aiReportLimit,
        landingPageLimit,
        teacherLimit
      }
    })
  } catch (error) {
    console.error('[Admin] âŒ Update limits error:', error)
    console.error('[Admin] Error message:', error.message)
    console.error('[Admin] Error stack:', error.stack)
    
    // FOREIGN KEY constraint ì—ëŸ¬ íŠ¹ë³„ ì²˜ë¦¬
    if (error.message && error.message.includes('FOREIGN KEY')) {
      return c.json({ 
        success: false, 
        error: `ë°ì´í„°ë² ì´ìŠ¤ ì œì•½ ì¡°ê±´ ì˜¤ë¥˜: ${error.message}. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.` 
      }, 500)
    }
    
    return c.json({ success: false, error: error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ğŸ”¥ ê´€ë¦¬ì: í”Œëœ íšŒìˆ˜ API
app.post('/api/admin/revoke-plan/:userId', async (c) => {
  try {
    const userId = c.req.param('userId')
    
    console.log('[Admin Revoke] Revoking plan for user:', userId)
    
    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    const user: any = await c.env.DB.prepare('SELECT id, academy_id, name FROM users WHERE id = ?').bind(userId).first()
    
    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    const academyId = user.academy_id || user.id
    
    // 1. ëª¨ë“  êµ¬ë…ì„ ì™„ì „íˆ ì‚­ì œ (í™œì„±, ì·¨ì†Œ, ê´€ë¦¬ì ì„¤ì • í”Œëœ ëª¨ë‘ í¬í•¨)
    await c.env.DB.prepare(`
      DELETE FROM subscriptions 
      WHERE academy_id = ?
    `).bind(academyId).run()
    
    console.log('[Admin Revoke] Deleted all subscriptions for academy:', academyId)
    
    // 2. ëª¨ë“  í”„ë¡œê·¸ë¨ ì‚­ì œ
    await c.env.DB.prepare(`
      DELETE FROM user_programs WHERE user_id = ?
    `).bind(userId).run()
    
    console.log('[Admin Revoke] Deleted all programs for user:', userId)
    
    // 3. ëª¨ë“  ì‚¬ìš©ì ê¶Œí•œ ì‚­ì œ
    await c.env.DB.prepare(`
      DELETE FROM user_permissions WHERE user_id = ?
    `).bind(userId).run()
    
    console.log('[Admin Revoke] Deleted all permissions for user:', userId)
    
    // 4. usage_tracking ì´ˆê¸°í™” (ì‚­ì œí•˜ì§€ ì•Šê³  0ìœ¼ë¡œ ë¦¬ì…‹)
    await c.env.DB.prepare(`
      UPDATE usage_tracking
      SET current_students = 0, ai_reports_used_this_month = 0, 
          landing_pages_created = 0, current_teachers = 0,
          updated_at = CURRENT_TIMESTAMP
      WHERE academy_id = ?
    `).bind(academyId).run()
    
    console.log('[Admin Revoke] Reset usage_tracking for academy:', academyId)
    
    return c.json({ 
      success: true, 
      message: 'í”Œëœì´ ì„±ê³µì ìœ¼ë¡œ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤'
    })
  } catch (error) {
    console.error('[Admin Revoke] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ§ª ê´€ë¦¬ì: í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± API (ì„ì‹œ) - ë‹¨ìˆœí™” ë²„ì „
app.post('/api/admin/seed-test-data', async (c) => {
  try {
    const DB = c.env.DB
    
    console.log('[Admin Seed] Starting simplified test data creation')
    
    // Step 1: ê°„ë‹¨í•œ ê²°ì œ ë°ì´í„°ë§Œ ì§ì ‘ ìƒì„± (ì™¸ë˜ í‚¤ ë¬´ì‹œ)
    const testPayments = [
      // ìµœê·¼ 30ì¼ ê°„ê²©ìœ¼ë¡œ ë‹¤ì–‘í•œ í”Œëœ ê²°ì œ
      { id: 'pay_001', sub_id: 1, user_id: 1, amount: 55000, method: 'card', plan: 'starter', days_ago: 30 },
      { id: 'pay_002', sub_id: 2, user_id: 2, amount: 77000, method: 'bank_transfer', plan: 'basic', days_ago: 28 },
      { id: 'pay_003', sub_id: 3, user_id: 3, amount: 147000, method: 'card', plan: 'pro', days_ago: 25 },
      { id: 'pay_004', sub_id: 1, user_id: 1, amount: 55000, method: 'card', plan: 'starter', days_ago: 22 },
      { id: 'pay_005', sub_id: 4, user_id: 4, amount: 297000, method: 'bank_transfer', plan: 'business', days_ago: 20 },
      { id: 'pay_006', sub_id: 2, user_id: 2, amount: 77000, method: 'card', plan: 'basic', days_ago: 18 },
      { id: 'pay_007', sub_id: 5, user_id: 5, amount: 440000, method: 'card', plan: 'premium', days_ago: 15 },
      { id: 'pay_008', sub_id: 3, user_id: 3, amount: 147000, method: 'bank_transfer', plan: 'pro', days_ago: 12 },
      { id: 'pay_009', sub_id: 6, user_id: 6, amount: 750000, method: 'card', plan: 'enterprise', days_ago: 10 },
      { id: 'pay_010', sub_id: 1, user_id: 1, amount: 55000, method: 'card', plan: 'starter', days_ago: 8 },
      { id: 'pay_011', sub_id: 4, user_id: 4, amount: 297000, method: 'card', plan: 'business', days_ago: 7 },
      { id: 'pay_012', sub_id: 2, user_id: 2, amount: 77000, method: 'bank_transfer', plan: 'basic', days_ago: 5 },
      { id: 'pay_013', sub_id: 3, user_id: 3, amount: 147000, method: 'card', plan: 'pro', days_ago: 3 },
      { id: 'pay_014', sub_id: 5, user_id: 5, amount: 440000, method: 'bank_transfer', plan: 'premium', days_ago: 2 },
      { id: 'pay_015', sub_id: 1, user_id: 1, amount: 55000, method: 'card', plan: 'starter', days_ago: 1 },
      // ì´ì „ ë‹¬ ë°ì´í„° ì¶”ê°€
      { id: 'pay_016', sub_id: 2, user_id: 2, amount: 77000, method: 'card', plan: 'basic', days_ago: 35 },
      { id: 'pay_017', sub_id: 3, user_id: 3, amount: 147000, method: 'bank_transfer', plan: 'pro', days_ago: 40 },
      { id: 'pay_018', sub_id: 4, user_id: 4, amount: 297000, method: 'card', plan: 'business', days_ago: 45 },
      { id: 'pay_019', sub_id: 5, user_id: 5, amount: 440000, method: 'card', plan: 'premium', days_ago: 50 },
      { id: 'pay_020', sub_id: 6, user_id: 6, amount: 750000, method: 'bank_transfer', plan: 'enterprise', days_ago: 55 }
    ]
    
    let successCount = 0
    let errorCount = 0
    
    for (const payment of testPayments) {
      try {
        await DB.prepare(`
          INSERT OR REPLACE INTO payments (id, subscription_id, user_id, amount, payment_method, merchant_uid, imp_uid, status, created_at)
          VALUES (?, ?, ?, ?, ?, ?, ?, 'completed', datetime('now', '-${payment.days_ago} days'))
        `).bind(
          payment.id,
          payment.sub_id,
          payment.user_id,
          payment.amount,
          payment.method,
          `merchant_${payment.id}`,
          payment.method === 'card' ? `imp_${payment.id}` : null
        ).run()
        successCount++
      } catch (e) {
        console.error(`[Admin Seed] Error creating payment ${payment.id}:`, e.message)
        errorCount++
      }
    }
    
    console.log(`[Admin Seed] Test data created: ${successCount} success, ${errorCount} errors`)
    
    return c.json({ 
      success: true, 
      message: 'í…ŒìŠ¤íŠ¸ ê²°ì œ ë°ì´í„°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      data: {
        created: successCount,
        errors: errorCount,
        total: testPayments.length
      }
    })
  } catch (error) {
    console.error('[Admin Seed] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ” ê´€ë¦¬ì: DB ë””ë²„ê·¸ API (ê²°ì œ ë°ì´í„° í™•ì¸)
app.get('/api/admin/debug/payments', async (c) => {
  try {
    const DB = c.env.DB
    
    // ëª¨ë“  ê²°ì œ ë°ì´í„° í™•ì¸
    const allPayments = await DB.prepare(`
      SELECT * FROM payments ORDER BY created_at DESC LIMIT 10
    `).all()
    
    // payments í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í™•ì¸
    const schema = await DB.prepare(`
      PRAGMA table_info(payments)
    `).all()
    
    // ê²°ì œ ê±´ìˆ˜ í™•ì¸
    const counts = await DB.prepare(`
      SELECT 
        status,
        COUNT(*) as count,
        SUM(amount) as total
      FROM payments
      GROUP BY status
    `).all()
    
    return c.json({
      success: true,
      data: {
        schema: schema.results,
        counts: counts.results,
        recentPayments: allPayments.results,
        totalCount: allPayments.results.length
      }
    })
  } catch (error) {
    console.error('[Admin Debug] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ’° ê´€ë¦¬ì: ë§¤ì¶œ í†µê³„ ì¡°íšŒ API
app.get('/api/admin/revenue/stats', async (c) => {
  try {
    const DB = c.env.DB
    
    // ğŸ”¥ 1. ì „ì²´ ë§¤ì¶œ í†µê³„ (ì¹´ë“œ ê²°ì œ + ê³„ì¢Œì´ì²´ ìŠ¹ì¸ ëª¨ë‘ í¬í•¨)
    const cardStats = await DB.prepare(`
      SELECT 
        COUNT(*) as count,
        SUM(amount) as revenue
      FROM payments
      WHERE status = 'completed'
    `).first()
    
    const bankStats = await DB.prepare(`
      SELECT 
        COUNT(*) as count,
        SUM(amount) as revenue
      FROM bank_transfer_requests
      WHERE status = 'approved'
    `).first()
    
    const totalCount = (cardStats?.count || 0) + (bankStats?.count || 0)
    const totalRevenue = (cardStats?.revenue || 0) + (bankStats?.revenue || 0)
    
    console.log('[Admin Revenue] Card:', cardStats, 'Bank:', bankStats)
    
    // ğŸ”¥ 2. ê²°ì œ ìˆ˜ë‹¨ë³„ í†µê³„ (ì¹´ë“œ vs ê³„ì¢Œì´ì²´)
    const methodData = {
      card: { 
        count: cardStats?.count || 0, 
        revenue: cardStats?.revenue || 0 
      },
      bank_transfer: { 
        count: bankStats?.count || 0, 
        revenue: bankStats?.revenue || 0 
      }
    }
    
    // ğŸ”¥ 3. í”Œëœë³„ ë§¤ì¶œ í†µê³„ (ì¹´ë“œ + ê³„ì¢Œì´ì²´)
    const cardPlanStats = await DB.prepare(`
      SELECT 
        s.plan_name,
        COUNT(p.id) as count,
        SUM(p.amount) as revenue
      FROM payments p
      JOIN subscriptions s ON p.subscription_id = s.id
      WHERE p.status = 'completed'
      GROUP BY s.plan_name
    `).all()
    
    const bankPlanStats = await DB.prepare(`
      SELECT 
        plan_name,
        COUNT(*) as count,
        SUM(amount) as revenue
      FROM bank_transfer_requests
      WHERE status = 'approved'
      GROUP BY plan_name
    `).all()
    
    // í”Œëœë³„ ë°ì´í„° ë³‘í•©
    const planStatsMap = new Map()
    
    cardPlanStats.results.forEach((item: any) => {
      planStatsMap.set(item.plan_name, {
        plan_name: item.plan_name,
        count: item.count || 0,
        revenue: item.revenue || 0
      })
    })
    
    bankPlanStats.results.forEach((item: any) => {
      const existing = planStatsMap.get(item.plan_name) || { plan_name: item.plan_name, count: 0, revenue: 0 }
      planStatsMap.set(item.plan_name, {
        plan_name: item.plan_name,
        count: existing.count + (item.count || 0),
        revenue: existing.revenue + (item.revenue || 0)
      })
    })
    
    const planStats = Array.from(planStatsMap.values()).sort((a, b) => b.revenue - a.revenue)
    
    // ğŸ”¥ 4. ìµœê·¼ 30ì¼ ì¼ë³„ ë§¤ì¶œ (ì¹´ë“œ + ê³„ì¢Œì´ì²´)
    const cardDailyStats = await DB.prepare(`
      SELECT 
        DATE(created_at) as date,
        COUNT(*) as count,
        SUM(amount) as revenue
      FROM payments
      WHERE status = 'completed'
        AND DATE(created_at) >= DATE('now', '-30 days')
      GROUP BY DATE(created_at)
    `).all()
    
    const bankDailyStats = await DB.prepare(`
      SELECT 
        DATE(approved_at) as date,
        COUNT(*) as count,
        SUM(amount) as revenue
      FROM bank_transfer_requests
      WHERE status = 'approved'
        AND DATE(approved_at) >= DATE('now', '-30 days')
      GROUP BY DATE(approved_at)
    `).all()
    
    // ì¼ë³„ ë°ì´í„° ë³‘í•©
    const dailyStatsMap = new Map()
    
    cardDailyStats.results.forEach((item: any) => {
      dailyStatsMap.set(item.date, {
        date: item.date,
        count: item.count || 0,
        revenue: item.revenue || 0
      })
    })
    
    bankDailyStats.results.forEach((item: any) => {
      const existing = dailyStatsMap.get(item.date) || { date: item.date, count: 0, revenue: 0 }
      dailyStatsMap.set(item.date, {
        date: item.date,
        count: existing.count + (item.count || 0),
        revenue: existing.revenue + (item.revenue || 0)
      })
    })
    
    const dailyStats = Array.from(dailyStatsMap.values()).sort((a, b) => b.date.localeCompare(a.date))
    
    // ğŸ”¥ 5. ì›”ë³„ ë§¤ì¶œ (ìµœê·¼ 12ê°œì›”, ì¹´ë“œ + ê³„ì¢Œì´ì²´)
    const cardMonthlyStats = await DB.prepare(`
      SELECT 
        strftime('%Y-%m', created_at) as month,
        COUNT(*) as count,
        SUM(amount) as revenue
      FROM payments
      WHERE status = 'completed'
        AND DATE(created_at) >= DATE('now', '-12 months')
      GROUP BY strftime('%Y-%m', created_at)
    `).all()
    
    const bankMonthlyStats = await DB.prepare(`
      SELECT 
        strftime('%Y-%m', approved_at) as month,
        COUNT(*) as count,
        SUM(amount) as revenue
      FROM bank_transfer_requests
      WHERE status = 'approved'
        AND DATE(approved_at) >= DATE('now', '-12 months')
      GROUP BY strftime('%Y-%m', approved_at)
    `).all()
    
    // ì›”ë³„ ë°ì´í„° ë³‘í•©
    const monthlyStatsMap = new Map()
    
    cardMonthlyStats.results.forEach((item: any) => {
      monthlyStatsMap.set(item.month, {
        month: item.month,
        count: item.count || 0,
        revenue: item.revenue || 0
      })
    })
    
    bankMonthlyStats.results.forEach((item: any) => {
      const existing = monthlyStatsMap.get(item.month) || { month: item.month, count: 0, revenue: 0 }
      monthlyStatsMap.set(item.month, {
        month: item.month,
        count: existing.count + (item.count || 0),
        revenue: existing.revenue + (item.revenue || 0)
      })
    })
    
    const monthlyStats = Array.from(monthlyStatsMap.values()).sort((a, b) => b.month.localeCompare(a.month))
    
    return c.json({
      success: true,
      data: {
        total: {
          count: totalCount,
          revenue: totalRevenue
        },
        byMethod: methodData,
        byPlan: planStats,
        daily: dailyStats,
        monthly: monthlyStats
      }
    })
  } catch (error) {
    console.error('[Admin Revenue] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ’° ê´€ë¦¬ì: ìƒì„¸ ê±°ë˜ ë‚´ì—­ ì¡°íšŒ API (ì¹´ë“œ + ê³„ì¢Œì´ì²´ í†µí•©)
app.get('/api/admin/revenue/transactions', async (c) => {
  try {
    const DB = c.env.DB
    const url = new URL(c.req.url)
    const limit = parseInt(url.searchParams.get('limit') || '50')
    const offset = parseInt(url.searchParams.get('offset') || '0')
    const method = url.searchParams.get('method') // 'card' or 'bank_transfer'
    const plan = url.searchParams.get('plan')
    const startDate = url.searchParams.get('startDate')
    const endDate = url.searchParams.get('endDate')
    
    console.log('[Admin Transactions] Fetching with filters:', { method, plan, startDate, endDate, limit, offset })
    
    // ğŸ”¥ ì¹´ë“œ ê²°ì œ ì¡°íšŒ
    let cardConditions = ["p.status = 'completed'"]
    let cardParams: any[] = []
    
    if (method === 'card') {
      // ì¹´ë“œë§Œ í•„í„°
    } else if (method === 'bank_transfer') {
      // ê³„ì¢Œì´ì²´ë§Œ í•„í„° -> ì¹´ë“œ ê²°ê³¼ëŠ” ì œì™¸
      cardConditions.push('1 = 0')
    }
    
    if (plan) {
      cardConditions.push('s.plan_name = ?')
      cardParams.push(plan)
    }
    
    if (startDate) {
      cardConditions.push("DATE(p.created_at) >= DATE(?)")
      cardParams.push(startDate)
    }
    
    if (endDate) {
      cardConditions.push("DATE(p.created_at) <= DATE(?)")
      cardParams.push(endDate)
    }
    
    const cardWhereClause = cardConditions.length > 0 ? 'WHERE ' + cardConditions.join(' AND ') : ''
    
    const cardQuery = `
      SELECT 
        'card' as payment_method,
        p.id,
        p.amount,
        p.created_at as transaction_date,
        p.merchant_uid,
        s.plan_name,
        s.plan_price,
        u.id as user_id,
        u.name as user_name,
        u.email as user_email
      FROM payments p
      JOIN subscriptions s ON p.subscription_id = s.id
      JOIN users u ON p.user_id = u.id
      ${cardWhereClause}
    `
    
    // ğŸ”¥ ê³„ì¢Œì´ì²´ ì¡°íšŒ
    let bankConditions = ["b.status = 'approved'"]
    let bankParams: any[] = []
    
    if (method === 'bank_transfer') {
      // ê³„ì¢Œì´ì²´ë§Œ í•„í„°
    } else if (method === 'card') {
      // ì¹´ë“œë§Œ í•„í„° -> ê³„ì¢Œì´ì²´ ê²°ê³¼ëŠ” ì œì™¸
      bankConditions.push('1 = 0')
    }
    
    if (plan) {
      bankConditions.push('b.plan_name = ?')
      bankParams.push(plan)
    }
    
    if (startDate) {
      bankConditions.push("DATE(b.approved_at) >= DATE(?)")
      bankParams.push(startDate)
    }
    
    if (endDate) {
      bankConditions.push("DATE(b.approved_at) <= DATE(?)")
      bankParams.push(endDate)
    }
    
    const bankWhereClause = bankConditions.length > 0 ? 'WHERE ' + bankConditions.join(' AND ') : ''
    
    const bankQuery = `
      SELECT 
        'bank_transfer' as payment_method,
        b.id,
        b.amount,
        b.approved_at as transaction_date,
        '' as merchant_uid,
        b.plan_name,
        b.amount as plan_price,
        u.id as user_id,
        u.name as user_name,
        u.email as user_email
      FROM bank_transfer_requests b
      JOIN users u ON b.user_id = u.id
      ${bankWhereClause}
    `
    
    // ğŸ”¥ ë‘ ì¿¼ë¦¬ë¥¼ UNIONìœ¼ë¡œ ë³‘í•©
    const unionQuery = `
      ${cardQuery}
      UNION ALL
      ${bankQuery}
      ORDER BY transaction_date DESC
    `
    
    console.log('[Admin Transactions] Union query:', unionQuery)
    console.log('[Admin Transactions] Card params:', cardParams, 'Bank params:', bankParams)
    
    // ì „ì²´ ê±°ë˜ ë‚´ì—­ ì¡°íšŒ
    const allParams = [...cardParams, ...bankParams]
    const allTransactions = await DB.prepare(unionQuery).bind(...allParams).all()
    
    // ì „ì²´ ê±´ìˆ˜
    const total = allTransactions.results?.length || 0
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ì ìš© (ë©”ëª¨ë¦¬ì—ì„œ ì²˜ë¦¬)
    const paginatedTransactions = (allTransactions.results || []).slice(offset, offset + limit)
    
    console.log('[Admin Transactions] Total:', total, 'Paginated:', paginatedTransactions.length)
    
    return c.json({
      success: true,
      data: {
        transactions: paginatedTransactions,
        pagination: {
          total,
          limit,
          offset,
          hasMore: (offset + limit) < total
        }
      }
    })
  } catch (error) {
    console.error('[Admin Transactions] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ”¥ ê´€ë¦¬ì: ì‚¬ìš©ì êµ¬ë… ì •ë³´ ì¡°íšŒ API
app.get('/api/admin/usage/:userId', async (c) => {
  try {
    const userId = c.req.param('userId')
    
    // ì‚¬ìš©ìì˜ academy_id ì¡°íšŒ
    const user = await c.env.DB.prepare('SELECT id, academy_id, name, academy_name FROM users WHERE id = ?').bind(userId).first()
    
    if (!user) {
      return c.json({ success: false, hasSubscription: false, message: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' })
    }
    
    // academy_idê°€ ì—†ìœ¼ë©´ ìƒì„±
    let academyId = user.academy_id
    if (!academyId) {
      // user.idë¥¼ academy_idë¡œ ì‚¬ìš©
      academyId = user.id
      try {
        await c.env.DB.prepare(`
          UPDATE users SET academy_id = ? WHERE id = ?
        `).bind(academyId, user.id).run()
        console.log('[Admin] Auto-created academy_id:', academyId)
      } catch (err) {
        console.error('[Admin] Failed to set academy_id:', err)
      }
    }
    
    // í™œì„± êµ¬ë… ì¡°íšŒ (ë‘ ê°€ì§€ ìŠ¤í‚¤ë§ˆ ëª¨ë‘ ì‹œë„)
    let subscription = null
    try {
      // ë¨¼ì € ìƒˆ ìŠ¤í‚¤ë§ˆ ì‹œë„ (academy_id)
      subscription = await c.env.DB.prepare(`
        SELECT * FROM subscriptions 
        WHERE academy_id = ? AND status = 'active'
        ORDER BY created_at DESC LIMIT 1
      `).bind(academyId).first()
    } catch (e) {
      console.log('[Admin] academy_id column not found in GET, trying user_id (old schema):', e.message)
      // êµ¬ ìŠ¤í‚¤ë§ˆ ì‹œë„ (user_id)
      try {
        subscription = await c.env.DB.prepare(`
          SELECT * FROM subscriptions 
          WHERE user_id = ? AND status = 'active'
          ORDER BY created_at DESC LIMIT 1
        `).bind(user.id).first()
        
        if (subscription) {
          console.log('[Admin] Found subscription using old schema (user_id) in GET')
        }
      } catch (e2) {
        console.log('[Admin] Both schema attempts failed in GET:', e2.message)
        return c.json({ 
          success: false, 
          error: 'DB ìŠ¤í‚¤ë§ˆ ì˜¤ë¥˜: /api/db/migrateë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”. Error: ' + e2.message 
        }, 500)
      }
    }
    
    if (!subscription) {
      return c.json({ success: true, hasSubscription: false, message: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤' })
    }
    
    // ì‚¬ìš©ëŸ‰ ì¡°íšŒ
    const usage = await c.env.DB.prepare(`
      SELECT * FROM usage_tracking 
      WHERE subscription_id = ?
    `).bind(subscription.id).first()
    
    return c.json({
      success: true,
      hasSubscription: true,
      subscription: {
        id: subscription.id,
        planName: subscription.plan_name,
        startDate: subscription.subscription_start_date,
        endDate: subscription.subscription_end_date,
        studentLimit: subscription.student_limit,
        aiReportLimit: subscription.ai_report_limit,
        landingPageLimit: subscription.landing_page_limit,
        teacherLimit: subscription.teacher_limit
      },
      usage: {
        currentStudents: usage?.current_students || 0,
        aiReportsUsed: usage?.ai_reports_used_this_month || 0,
        landingPagesCreated: usage?.landing_pages_created || 0,
        currentTeachers: usage?.current_teachers || 0
      }
    })
  } catch (error) {
    console.error('[Admin] Get usage error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ==================== í”Œëœë³„ êµ¬ë§¤ í˜ì´ì§€ ====================

// ìŠ¤íƒ€í„° í”Œëœ êµ¬ë§¤ í˜ì´ì§€
app.get('/pricing/starter', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ìŠ¤íƒ€í„° í”Œëœ êµ¬ë§¤ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
        </style>
    </head>
    <body class="bg-gradient-to-br from-gray-50 via-white to-purple-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <div class="flex items-center space-x-6">
                        <a href="/pricing" class="text-gray-600 hover:text-purple-600 transition">â† ìš”ê¸ˆì œë¡œ ëŒì•„ê°€ê¸°</a>
                        <a href="/dashboard" class="gradient-purple text-white px-6 py-2.5 rounded-full font-medium hover:shadow-lg transition">ëŒ€ì‹œë³´ë“œ</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-32 pb-24 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="grid lg:grid-cols-2 gap-12">
                    <!-- ì™¼ìª½: í”Œëœ ì •ë³´ -->
                    <div>
                        <div class="inline-block px-4 py-2 bg-gray-100 rounded-full text-gray-700 text-sm font-semibold mb-4">
                            ìŠ¤íƒ€í„° í”Œëœ
                        </div>
                        <h1 class="text-5xl font-bold text-gray-900 mb-4">
                            ì†Œê·œëª¨ í•™ì›ì„ ìœ„í•œ<br>
                            <span class="text-purple-600">ì‹œì‘ í”Œëœ</span>
                        </h1>
                        <div class="flex items-end gap-3 mb-8">
                            <span class="text-6xl font-bold text-gray-900">â‚©55,000</span>
                            <span class="text-2xl text-gray-600 mb-2">/ì›”</span>
                        </div>

                        <div class="bg-white rounded-2xl p-8 border-2 border-gray-200 mb-8">
                            <h3 class="text-xl font-bold text-gray-900 mb-6">í¬í•¨ëœ ê¸°ëŠ¥</h3>
                            <div class="space-y-4">
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">í•™ìƒ ìµœëŒ€ 50ëª…</div>
                                        <div class="text-sm text-gray-600">ì†Œê·œëª¨ í•™ì›ì— ìµœì í™”</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">AI í•™ìŠµ ë¦¬í¬íŠ¸ ì›” 50ê°œ</div>
                                        <div class="text-sm text-gray-600">í•™ìƒë³„ ë§ì¶¤ ë¶„ì„ ë¦¬í¬íŠ¸</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">ëœë”©í˜ì´ì§€ 50ê°œ</div>
                                        <div class="text-sm text-gray-600">ì „ë¬¸ ë§ˆì¼€íŒ… í˜ì´ì§€ ì œì‘</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">ì„ ìƒë‹˜ ê³„ì • 2ëª…</div>
                                        <div class="text-sm text-gray-600">ë‹¤ì¤‘ ì‚¬ìš©ì ê´€ë¦¬</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">ì¼ì¼ ì„±ê³¼ ê¸°ë¡</div>
                                        <div class="text-sm text-gray-600">í•™ìƒ ì¼ì¼ í•™ìŠµ í˜„í™© ê´€ë¦¬</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">ê¸°ë³¸ ë§ˆì¼€íŒ… ìë£Œ</div>
                                        <div class="text-sm text-gray-600">í…œí”Œë¦¿ ì œê³µ</div>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-gray-900">ì´ë©”ì¼ ì§€ì›</div>
                                        <div class="text-sm text-gray-600">ì—…ë¬´ì‹œê°„ ë‚´ ì§€ì›</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6">
                            <div class="flex items-start gap-3">
                                <svg class="w-6 h-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="text-sm text-gray-700">
                                    <strong>ì´ìš© ê¸°ê°„:</strong> ê²°ì œì¼ë¡œë¶€í„° 1ê°œì›”<br>
                                    <strong>ìë™ ê°±ì‹ :</strong> ì—†ìŒ (ì¬êµ¬ë§¤ í•„ìš”)<br>
                                    <strong>í™˜ë¶ˆ ì •ì±…:</strong> 7ì¼ ì´ë‚´ 100% í™˜ë¶ˆ
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½: ê²°ì œ í¼ -->
                    <div>
                        <div class="bg-white rounded-2xl p-8 border-2 border-gray-200 shadow-xl sticky top-32">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6">ê²°ì œ ì •ë³´</h2>
                            
                            <div class="mb-6">
                                <div class="flex justify-between items-center py-6">
                                    <div>
                                        <div class="text-lg font-bold text-gray-900">ìŠ¤íƒ€í„° í”Œëœ (ì›”ê°„)</div>
                                        <div class="text-sm text-gray-600 mt-1">1ê°œì›” ì´ìš©ê¶Œ</div>
                                    </div>
                                    <span class="text-3xl font-bold text-purple-600">â‚©55,000</span>
                                </div>
                            </div>

                            <div class="space-y-4 mb-6">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë¦„</label>
                                    <input type="text" id="buyerName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="í™ê¸¸ë™">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë©”ì¼</label>
                                    <input type="email" id="buyerEmail" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="example@email.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">ì—°ë½ì²˜</label>
                                    <input type="tel" id="buyerPhone" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="010-1234-5678">
                                </div>
                            </div>

                            <div class="mb-6">
                                <label class="flex items-start gap-3">
                                    <input type="checkbox" id="agreeTerms" class="mt-1 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                                    <span class="text-sm text-gray-700">
                                        <a href="/terms" class="text-purple-600 hover:underline">ì´ìš©ì•½ê´€</a> ë° 
                                        <a href="/privacy" class="text-purple-600 hover:underline">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•©ë‹ˆë‹¤.
                                    </span>
                                </label>
                            </div>

                            <button onclick="processPayment()" class="w-full py-4 gradient-purple text-white rounded-xl font-bold text-lg hover:shadow-2xl transition-all mb-3">
                                ğŸ’³ ì¹´ë“œ ê²°ì œí•˜ê¸°
                            </button>

                            <button onclick="goToBankTransfer()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg hover:bg-blue-700 hover:shadow-xl transition-all">
                                ğŸ¦ ê³„ì¢Œì´ì²´í•˜ê¸°
                            </button>

                            <div class="mt-6 text-center text-sm text-gray-500">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                </svg>
                                ì•ˆì „í•œ ê²°ì œ ì‹œìŠ¤í…œìœ¼ë¡œ ë³´í˜¸ë©ë‹ˆë‹¤
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ì•„ì„í¬íŠ¸ ì´ˆê¸°í™” (ë‚˜ì¤‘ì— ì‹¤ì œ ê°€ë§¹ì  ì½”ë“œë¡œ ë³€ê²½)
            IMP.init('imp00000000');

            // ë¡œê·¸ì¸ ì²´í¬ ë° ì‚¬ìš©ì ì •ë³´ ìë™ ì…ë ¥
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (user) {
                document.getElementById('buyerName').value = user.name || '';
                document.getElementById('buyerEmail').value = user.email || '';
                document.getElementById('buyerPhone').value = user.phone || '';
            }

            function goToBankTransfer() {
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }
                window.location.href = '/payment/bank-transfer?plan=ìŠ¤íƒ€í„° í”Œëœ&amount=55000';
            }

            async function processPayment() {
                const name = document.getElementById('buyerName').value;
                const email = document.getElementById('buyerEmail').value;
                const phone = document.getElementById('buyerPhone').value;
                const agreeTerms = document.getElementById('agreeTerms').checked;

                if (!name || !email || !phone) {
                    alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!agreeTerms) {
                    alert('ì´ìš©ì•½ê´€ ë° ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }

                // ì¹´ë“œê²°ì œ ì‹ ì²­ API í˜¸ì¶œ
                try {
                    const response = await fetch('/api/card-payment/request', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userId: user.id,
                            userName: name,
                            userEmail: email,
                            userPhone: phone,
                            planName: 'ìŠ¤íƒ€í„° í”Œëœ',
                            amount: 55000,
                            note: ''
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert('âœ… ì¹´ë“œ ê²°ì œ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nì¹´ë“œ ê²°ì œ ê°€ëŠ¥í•œ í˜ì´ì§€ ë§í¬ë¥¼ ë¬¸ì ë©”ì‹œì§€ë¡œ ì „ì†¡í•˜ê² ìŠµë‹ˆë‹¤!\\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ê²°ì œ ë§í¬ê°€ ë°œì†¡ë©ë‹ˆë‹¤.\\nìŠ¹ì¸ê¹Œì§€ 1-2 ì˜ì—…ì¼ ì†Œìš”ë©ë‹ˆë‹¤.');
                        window.location.href = '/dashboard';
                    } else {
                        alert('âŒ ì‹ ì²­ ì‹¤íŒ¨: ' + result.error);
                    }
                } catch (error) {
                    console.error('[Card Payment Request] Error:', error);
                    alert('ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        </script>
    </body>
    </html>
  `)
})

// ë¬´ë£Œ í”Œëœ ì‹ ì²­ í˜ì´ì§€
app.get('/pricing/free', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¬´ë£Œ í”Œëœ ì‹ ì²­ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
        </style>
    </head>
    <body class="bg-gradient-to-br from-green-50 via-white to-emerald-50">
        <nav class="fixed w-full top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <div class="flex items-center space-x-6">
                        <a href="/pricing" class="text-gray-600 hover:text-gray-900">â† ìš”ê¸ˆì œ</a>
                        <a href="/dashboard" class="px-6 py-2.5 bg-green-500 text-white rounded-full hover:bg-green-600">ëŒ€ì‹œë³´ë“œ</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-32 pb-24 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-12">
                    <div class="inline-block px-4 py-2 bg-green-100 rounded-full text-green-700 text-sm font-semibold mb-4">
                        ğŸ ë¬´ë£Œ í”Œëœ
                    </div>
                    <h1 class="text-5xl font-bold text-gray-900 mb-4">
                        í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ<br>
                        <span class="text-green-600">ë¬´ë£Œë¡œ ì‹œì‘í•˜ê¸°</span>
                    </h1>
                    <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                        í•™ìƒ 50ëª…ê¹Œì§€ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œì„<br>
                        ë¬´ë£Œë¡œ ì‚¬ìš©í•´ë³´ì„¸ìš”. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì¦‰ì‹œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
                    </p>
                </div>

                <div class="bg-white rounded-3xl p-10 shadow-2xl border-2 border-green-200 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">ë¬´ë£Œ í”Œëœ í˜œíƒ</h2>
                    <div class="grid md:grid-cols-2 gap-6 mb-8">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-green-500 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <div>
                                <h3 class="font-bold text-gray-900 mb-1">í•™ìƒ ìµœëŒ€ 50ëª…</h3>
                                <p class="text-sm text-gray-600">í•™ìƒ ì •ë³´ ê´€ë¦¬, ì¶œê²° ê´€ë¦¬, ì„±ì  ê´€ë¦¬ ê°€ëŠ¥</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-green-500 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <div>
                                <h3 class="font-bold text-gray-900 mb-1">í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œë§Œ ì œê³µ</h3>
                                <p class="text-sm text-gray-600">AI ë¦¬í¬íŠ¸, ëœë”©í˜ì´ì§€ ë“±ì€ ìœ ë£Œ í”Œëœì—ì„œ</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-green-500 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <div>
                                <h3 class="font-bold text-gray-900 mb-1">ì„ ìƒë‹˜ ê³„ì • ë¯¸ì œê³µ</h3>
                                <p class="text-sm text-gray-600">ì›ì¥ë‹˜ ê³„ì • 1ê°œë§Œ ì‚¬ìš© ê°€ëŠ¥</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-green-500 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <div>
                                <h3 class="font-bold text-gray-900 mb-1">ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”</h3>
                                <p class="text-sm text-gray-600">ì‹ ì²­ í›„ 24ì‹œê°„ ë‚´ ìŠ¹ì¸ ì²˜ë¦¬</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-8">
                        <h3 class="font-bold text-yellow-800 mb-2">âš ï¸ ì£¼ì˜ì‚¬í•­</h3>
                        <ul class="text-sm text-yellow-700 space-y-1">
                            <li>â€¢ ë¬´ë£Œ í”Œëœì€ <strong>í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ</strong>ë§Œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                            <li>â€¢ AI ë¦¬í¬íŠ¸, ëœë”©í˜ì´ì§€, ì„ ìƒë‹˜ ê³„ì •ì€ ìœ ë£Œ í”Œëœì—ì„œ ì œê³µë©ë‹ˆë‹¤</li>
                            <li>â€¢ ì‹ ì²­ í›„ ê´€ë¦¬ì ìŠ¹ì¸ì´ ì™„ë£Œë˜ë©´ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                            <li>â€¢ ì–¸ì œë“ ì§€ ìœ ë£Œ í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                        </ul>
                    </div>

                    <h2 class="text-2xl font-bold text-gray-900 mb-6">ì‹ ì²­ ì •ë³´</h2>
                    <div class="space-y-4 mb-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">í•™ì›ëª…</label>
                            <input type="text" id="academyName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="ì˜ˆ: ìŠˆí¼í•™ì›">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ì›ì¥ë‹˜ ì„±í•¨</label>
                            <input type="text" id="ownerName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="ì˜ˆ: í™ê¸¸ë™">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë©”ì¼</label>
                            <input type="email" id="email" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="ì˜ˆ: hong@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ì—°ë½ì²˜</label>
                            <input type="tel" id="phone" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="ì˜ˆ: 010-1234-5678">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ì‹ ì²­ ì‚¬ìœ  (ì„ íƒ)</label>
                            <textarea id="reason" rows="3" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-green-500 focus:outline-none" placeholder="ë¬´ë£Œ í”Œëœ ì‹ ì²­ ì‚¬ìœ ë¥¼ ê°„ë‹¨íˆ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">í•œêµ­í•™ì›ëŒ€í•™êµ ì†Œì†ì´ì‹ ê°€ìš”?</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="isKoreaAcademy" value="yes" id="koreaAcademyYes" class="w-4 h-4 text-green-500">
                                    <span class="text-gray-700">ì˜ˆ</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="isKoreaAcademy" value="no" id="koreaAcademyNo" class="w-4 h-4 text-gray-500" checked>
                                    <span class="text-gray-700">ì•„ë‹ˆìš”</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <label class="flex items-start gap-3 mb-6 cursor-pointer">
                        <input type="checkbox" id="agreeTerms" class="w-5 h-5 text-green-500 mt-0.5">
                        <span class="text-sm text-gray-700">
                            ë¬´ë£Œ í”Œëœ ì´ìš©ì•½ê´€ ë° ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•©ë‹ˆë‹¤. 
                            <span class="text-gray-500">(í•„ìˆ˜)</span>
                        </span>
                    </label>

                    <button onclick="submitFreeApplication()" class="w-full py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-bold text-lg hover:shadow-2xl transition-all">
                        ğŸ ë¬´ë£Œ í”Œëœ ì‹ ì²­í•˜ê¸°
                    </button>

                    <p class="text-center text-sm text-gray-500 mt-4">
                        ì‹ ì²­ í›„ 24ì‹œê°„ ë‚´ ìŠ¹ì¸ ê²°ê³¼ë¥¼ ì´ë©”ì¼ë¡œ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤
                    </p>
                </div>

                <div class="text-center">
                    <p class="text-gray-600 mb-4">ë” ë§ì€ ê¸°ëŠ¥ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</p>
                    <a href="/pricing" class="inline-block px-8 py-3 border-2 border-gray-300 text-gray-700 rounded-xl font-bold hover:border-green-500 hover:text-green-600 transition-all">
                        ìœ ë£Œ í”Œëœ ë³´ê¸°
                    </a>
                </div>
            </div>
        </div>

        <script>
            // ì‚¬ìš©ì ì •ë³´ ìë™ ì…ë ¥
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (user) {
                document.getElementById('ownerName').value = user.name || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('phone').value = user.phone || '';
            }

            async function submitFreeApplication() {
                // ì…ë ¥ ê²€ì¦
                const academyName = document.getElementById('academyName').value.trim();
                const ownerName = document.getElementById('ownerName').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const reason = document.getElementById('reason').value.trim();
                const agreeTerms = document.getElementById('agreeTerms').checked;
                const isKoreaAcademy = document.getElementById('koreaAcademyYes').checked ? 1 : 0;

                if (!academyName || !ownerName || !email || !phone) {
                    alert('í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!agreeTerms) {
                    alert('ì´ìš©ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!user || !user.id) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }

                try {
                    const response = await fetch('/api/free-plan/apply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            academyName,
                            ownerName,
                            email,
                            phone,
                            reason,
                            isKoreaAcademy
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('âœ… ë¬´ë£Œ í”Œëœ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ì´ë©”ì¼ë¡œ ì•Œë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\\në³´í†µ 24ì‹œê°„ ë‚´ì— ì²˜ë¦¬ë©ë‹ˆë‹¤.');
                        window.location.href = '/dashboard';
                    } else {
                        alert('âŒ ì‹ ì²­ ì‹¤íŒ¨: ' + result.error);
                    }
                } catch (error) {
                    alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
        </script>
    </body>
    </html>
  `)
})

// ë² ì´ì§ í”Œëœ êµ¬ë§¤ í˜ì´ì§€
app.get('/pricing/basic', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë² ì´ì§ í”Œëœ êµ¬ë§¤ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
          .gradient-purple { background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); }
          .gradient-blue { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); }
        </style>
    </head>
    <body class="bg-gradient-to-br from-blue-50 via-white to-purple-50">
        <nav class="fixed w-full top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <div class="flex items-center space-x-6">
                        <a href="/pricing" class="text-gray-600 hover:text-purple-600 transition">â† ìš”ê¸ˆì œë¡œ ëŒì•„ê°€ê¸°</a>
                        <a href="/dashboard" class="gradient-purple text-white px-6 py-2.5 rounded-full font-medium hover:shadow-lg transition">ëŒ€ì‹œë³´ë“œ</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-32 pb-24 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="grid lg:grid-cols-2 gap-12">
                    <div>
                        <div class="inline-block px-4 py-2 bg-blue-100 rounded-full text-blue-700 text-sm font-semibold mb-4">ë² ì´ì§ í”Œëœ</div>
                        <h1 class="text-5xl font-bold text-gray-900 mb-4">ì„±ì¥í•˜ëŠ” í•™ì›ì„ ìœ„í•œ<br><span class="text-blue-600">ë² ì´ì§ í”Œëœ</span></h1>
                        <div class="flex items-end gap-3 mb-8">
                            <span class="text-6xl font-bold text-gray-900">â‚©143,000</span>
                            <span class="text-2xl text-gray-600 mb-2">/ì›”</span>
                        </div>

                        <div class="bg-white rounded-2xl p-8 border-2 border-blue-200 mb-8">
                            <h3 class="text-xl font-bold text-gray-900 mb-6">í¬í•¨ëœ ê¸°ëŠ¥</h3>
                            <div class="space-y-4">
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-gray-900">í•™ìƒ ìµœëŒ€ 150ëª…</div><div class="text-sm text-gray-600">ì¤‘ì†Œê·œëª¨ í•™ì›ì— ì í•©</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-gray-900">AI í•™ìŠµ ë¦¬í¬íŠ¸ ì›” 150ê°œ</div><div class="text-sm text-gray-600">í•™ìƒë³„ ë§ì¶¤ ë¶„ì„ ë¦¬í¬íŠ¸</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-gray-900">ëœë”©í˜ì´ì§€ 160ê°œ</div><div class="text-sm text-gray-600">ì „ë¬¸ ë§ˆì¼€íŒ… í˜ì´ì§€ ì œì‘</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-gray-900">ì„ ìƒë‹˜ ê³„ì • 6ëª…</div><div class="text-sm text-gray-600">íŒ€ í˜‘ì—… ê°•í™”</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-gray-900">í•™ë¶€ëª¨ ì†Œí†µ ìë™í™”</div><div class="text-sm text-gray-600">ìë™ ë©”ì‹œì§€ ë°œì†¡</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-gray-900">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìµœì í™” ê°€ì´ë“œ</div><div class="text-sm text-gray-600">ì§€ì—­ ë§ˆì¼€íŒ… ê°•í™”</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-gray-900">ì´ë©”ì¼ ì§€ì›</div><div class="text-sm text-gray-600">ì—…ë¬´ì‹œê°„ ë‚´ ì§€ì›</div></div></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="bg-white rounded-2xl p-8 border-2 border-blue-200 shadow-xl sticky top-32">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6">ê²°ì œ ì •ë³´</h2>
                            <div class="mb-6">
                                <div class="flex justify-between items-center py-6"><div><div class="text-lg font-bold text-gray-900">ë² ì´ì§ í”Œëœ (ì›”ê°„)</div><div class="text-sm text-gray-600 mt-1">1ê°œì›” ì´ìš©ê¶Œ</div></div><span class="text-3xl font-bold text-blue-600">â‚©143,000</span></div>
                            </div>
                            <div class="space-y-4 mb-6">
                                <div><label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë¦„</label><input type="text" id="buyerName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="í™ê¸¸ë™"></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë©”ì¼</label><input type="email" id="buyerEmail" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="example@email.com"></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-2">ì—°ë½ì²˜</label><input type="tel" id="buyerPhone" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none" placeholder="010-1234-5678"></div>
                            </div>
                            <div class="mb-6"><label class="flex items-start gap-3"><input type="checkbox" id="agreeTerms" class="mt-1 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><span class="text-sm text-gray-700"><a href="/terms" class="text-blue-600 hover:underline">ì´ìš©ì•½ê´€</a> ë° <a href="/privacy" class="text-blue-600 hover:underline">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•©ë‹ˆë‹¤.</span></label></div>
                            <button onclick="requestCardPayment()" class="w-full py-4 gradient-blue text-white rounded-xl font-bold text-lg hover:shadow-2xl transition-all mb-3">ğŸ’³ ì¹´ë“œ ê²°ì œ ë§í¬ ë¬¸ì ìš”ì²­</button>
                            <button onclick="goToBankTransfer()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg hover:bg-blue-700 hover:shadow-xl transition-all">ğŸ¦ ê³„ì¢Œì´ì²´í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            IMP.init('imp00000000');
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (user) {
                document.getElementById('buyerName').value = user.name || '';
                document.getElementById('buyerEmail').value = user.email || '';
                document.getElementById('buyerPhone').value = user.phone || '';
            }
            function goToBankTransfer() {
                if (!user) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); window.location.href = '/login'; return; }
                window.location.href = '/payment/bank-transfer?plan=ë² ì´ì§ í”Œëœ&amount=143000';
            }
            async function requestCardPayment() {
                const name = document.getElementById('buyerName').value;
                const email = document.getElementById('buyerEmail').value;
                const phone = document.getElementById('buyerPhone').value;
                const agreeTerms = document.getElementById('agreeTerms').checked;
                if (!name || !email || !phone) { alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                if (!agreeTerms) { alert('ì´ìš©ì•½ê´€ ë° ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•´ì£¼ì„¸ìš”.'); return; }
                if (!user) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); window.location.href = '/login'; return; }
                try {
                    const response = await fetch('/api/card-payment/request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            userName: name,
                            userEmail: email,
                            userPhone: phone,
                            planName: 'ë² ì´ì§ í”Œëœ',
                            amount: 143000,
                            note: 'ë² ì´ì§ í”Œëœ ì¹´ë“œê²°ì œ ì‹ ì²­'
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… ì¹´ë“œ ê²°ì œ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì¹´ë“œ ê²°ì œ ê°€ëŠ¥í•œ í˜ì´ì§€ ë§í¬ë¥¼ ë¬¸ì ë©”ì‹œì§€ë¡œ ì „ì†¡í•˜ê² ìŠµë‹ˆë‹¤!\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ê²°ì œ ë§í¬ê°€ ë°œì†¡ë©ë‹ˆë‹¤.\nìŠ¹ì¸ê¹Œì§€ 1-2 ì˜ì—…ì¼ ì†Œìš”ë©ë‹ˆë‹¤.');
                        window.location.href = '/dashboard';
                    } else {
                        alert('ì‹ ì²­ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    alert('ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    console.error('Card payment request error:', error);
                }
            }
        </script>
    </body>
    </html>
  `)
})

// í”„ë¡œ í”Œëœ êµ¬ë§¤ í˜ì´ì§€
app.get('/pricing/pro', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í”„ë¡œ í”Œëœ êµ¬ë§¤ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
          .gradient-purple { background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); }
        </style>
    </head>
    <body class="bg-gradient-to-br from-purple-50 via-white to-pink-50">
        <nav class="fixed w-full top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <div class="flex items-center space-x-6">
                        <a href="/pricing" class="text-gray-600 hover:text-purple-600 transition">â† ìš”ê¸ˆì œë¡œ ëŒì•„ê°€ê¸°</a>
                        <a href="/dashboard" class="gradient-purple text-white px-6 py-2.5 rounded-full font-medium hover:shadow-lg transition">ëŒ€ì‹œë³´ë“œ</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-32 pb-24 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="grid lg:grid-cols-2 gap-12">
                    <div>
                        <div class="inline-block px-4 py-2 bg-gradient-to-r from-purple-100 to-pink-100 rounded-full text-purple-700 text-sm font-semibold mb-4">í”„ë¡œ í”Œëœ â­</div>
                        <h1 class="text-5xl font-bold text-gray-900 mb-4">ì¤‘í˜• í•™ì›ì„ ìœ„í•œ<br><span class="bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">í”„ë¡œ í”Œëœ</span></h1>
                        <div class="flex items-end gap-3 mb-8">
                            <span class="text-6xl font-bold text-gray-900">â‚©187,000</span>
                            <span class="text-2xl text-gray-600 mb-2">/ì›”</span>
                        </div>

                        <div class="bg-gradient-to-br from-purple-600 to-pink-600 rounded-2xl p-8 text-white mb-8">
                            <h3 class="text-xl font-bold mb-6">í¬í•¨ëœ ê¸°ëŠ¥</h3>
                            <div class="space-y-4">
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold">í•™ìƒ ìµœëŒ€ 500ëª…</div><div class="text-sm text-white/80">ì¤‘ëŒ€í˜• í•™ì›ì— ì í•©</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold">AI í•™ìŠµ ë¦¬í¬íŠ¸ ì›” 500ê°œ</div><div class="text-sm text-white/80">ìƒì„¸í•œ í•™ìƒ ë¶„ì„</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold">ëœë”©í˜ì´ì§€ 530ê°œ</div><div class="text-sm text-white/80">ëŒ€ê·œëª¨ ë§ˆì¼€íŒ… ì§€ì›</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold">ì„ ìƒë‹˜ ê³„ì • 20ëª…</div><div class="text-sm text-white/80">ëŒ€ê·œëª¨ íŒ€ ê´€ë¦¬</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold">ìš°ì„  ê³ ê° ì§€ì›</div><div class="text-sm text-white/80">ë¹ ë¥¸ ì‘ë‹µ ë³´ì¥</div></div></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="bg-white rounded-2xl p-8 border-2 border-purple-200 shadow-xl sticky top-32">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6">ê²°ì œ ì •ë³´</h2>
                            <div class="mb-6">
                                <div class="flex justify-between items-center py-6"><div><div class="text-lg font-bold text-gray-900">í”„ë¡œ í”Œëœ (ì›”ê°„)</div><div class="text-sm text-gray-600 mt-1">1ê°œì›” ì´ìš©ê¶Œ</div></div><span class="text-3xl font-bold text-purple-600">â‚©187,000</span></div>
                            </div>
                            <div class="space-y-4 mb-6">
                                <div><label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë¦„</label><input type="text" id="buyerName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="í™ê¸¸ë™"></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë©”ì¼</label><input type="email" id="buyerEmail" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="example@email.com"></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-2">ì—°ë½ì²˜</label><input type="tel" id="buyerPhone" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="010-1234-5678"></div>
                            </div>
                            <div class="mb-6"><label class="flex items-start gap-3"><input type="checkbox" id="agreeTerms" class="mt-1 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500"><span class="text-sm text-gray-700"><a href="/terms" class="text-purple-600 hover:underline">ì´ìš©ì•½ê´€</a> ë° <a href="/privacy" class="text-purple-600 hover:underline">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•©ë‹ˆë‹¤.</span></label></div>
                            <button onclick="requestCardPayment()" class="w-full py-4 gradient-purple text-white rounded-xl font-bold text-lg hover:shadow-2xl transition-all mb-3">ğŸ’³ ì¹´ë“œ ê²°ì œ ë§í¬ ë¬¸ì ìš”ì²­</button>
                            <button onclick="goToBankTransfer()" class="w-full py-4 bg-purple-600 text-white rounded-xl font-bold text-lg hover:bg-purple-700 hover:shadow-xl transition-all">ğŸ¦ ê³„ì¢Œì´ì²´í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (user) {
                document.getElementById('buyerName').value = user.name || '';
                document.getElementById('buyerEmail').value = user.email || '';
                document.getElementById('buyerPhone').value = user.phone || '';
            }
            function goToBankTransfer() {
                if (!user) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); window.location.href = '/login'; return; }
                window.location.href = '/payment/bank-transfer?plan=í”„ë¡œ í”Œëœ&amount=187000';
            }
            async function requestCardPayment() {
                const name = document.getElementById('buyerName').value;
                const email = document.getElementById('buyerEmail').value;
                const phone = document.getElementById('buyerPhone').value;
                const agreeTerms = document.getElementById('agreeTerms').checked;
                if (!name || !email || !phone) { alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                if (!agreeTerms) { alert('ì´ìš©ì•½ê´€ ë° ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•´ì£¼ì„¸ìš”.'); return; }
                if (!user) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); window.location.href = '/login'; return; }
                try {
                    const response = await fetch('/api/card-payment/request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            userName: name,
                            userEmail: email,
                            userPhone: phone,
                            planName: 'í”„ë¡œ í”Œëœ',
                            amount: 187000,
                            note: 'í”„ë¡œ í”Œëœ ì¹´ë“œê²°ì œ ì‹ ì²­'
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… ì¹´ë“œ ê²°ì œ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nì¹´ë“œ ê²°ì œ ê°€ëŠ¥í•œ í˜ì´ì§€ ë§í¬ë¥¼ ë¬¸ì ë©”ì‹œì§€ë¡œ ì „ì†¡í•˜ê² ìŠµë‹ˆë‹¤!\\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ê²°ì œ ë§í¬ê°€ ë°œì†¡ë©ë‹ˆë‹¤.\\nìŠ¹ì¸ê¹Œì§€ 1-2 ì˜ì—…ì¼ ì†Œìš”ë©ë‹ˆë‹¤.');
                        window.location.href = '/dashboard';
                    } else {
                        alert('ì‹ ì²­ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    alert('ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    console.error('Card payment request error:', error);
                }
            }
        </script>
    </body>
    </html>
  `)
})


// ë¹„ì¦ˆë‹ˆìŠ¤ í”Œëœ êµ¬ë§¤ í˜ì´ì§€
app.get('/pricing/business', (c) => {
  return c.html(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>ë¹„ì¦ˆë‹ˆìŠ¤ í”Œëœ êµ¬ë§¤</title><script src="https://cdn.tailwindcss.com"></script><script src="https://cdn.iamport.kr/v1/iamport.js"></script><style>@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');*{font-family:'Pretendard Variable',Pretendard,sans-serif;}</style></head><body class="bg-gradient-to-br from-green-50 to-blue-50"><nav class="fixed w-full top-0 z-50 bg-white/90 backdrop-blur-md border-b"><div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center"><a href="/" class="text-xl font-bold">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</a><div class="flex gap-6"><a href="/pricing" class="text-gray-600">â† ìš”ê¸ˆì œ</a><a href="/dashboard" class="bg-green-600 text-white px-6 py-2.5 rounded-full">ëŒ€ì‹œë³´ë“œ</a></div></div></nav><div class="pt-32 pb-24 px-6"><div class="max-w-6xl mx-auto grid lg:grid-cols-2 gap-12"><div><div class="inline-block px-4 py-2 bg-green-100 rounded-full text-green-700 font-semibold mb-4">ë¹„ì¦ˆë‹ˆìŠ¤ í”Œëœ</div><h1 class="text-5xl font-bold mb-4">ëŒ€í˜• í•™ì›ì„ ìœ„í•œ<br><span class="text-green-600">ë¹„ì¦ˆë‹ˆìŠ¤ ì†”ë£¨ì…˜</span></h1><div class="flex items-end gap-3 mb-8"><span class="text-6xl font-bold">â‚©297,000</span><span class="text-2xl text-gray-600">/ì›”</span></div><div class="bg-white rounded-2xl p-8 border-2 border-green-200"><h3 class="text-xl font-bold mb-6">í¬í•¨ëœ ê¸°ëŠ¥</h3><div class="space-y-3 text-gray-700"><div class="flex gap-3"><svg class="w-5 h-5 text-green-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg><span>í•™ìƒ 300ëª…</span></div><div class="flex gap-3"><svg class="w-5 h-5 text-green-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg><span>AI ë¦¬í¬íŠ¸ 600ê°œ/ì›”</span></div><div class="flex gap-3"><svg class="w-5 h-5 text-green-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg><span>ëœë”©í˜ì´ì§€ 550ê°œ</span></div><div class="flex gap-3"><svg class="w-5 h-5 text-green-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg><span>ì„ ìƒë‹˜ 10ëª…</span></div><div class="flex gap-3"><svg class="w-5 h-5 text-green-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg><span>ë©€í‹° ìº í¼ìŠ¤ ê´€ë¦¬</span></div><div class="flex gap-3"><svg class="w-5 h-5 text-green-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg><span>ì „ìš© ê³„ì • ë§¤ë‹ˆì €</span></div><div class="flex gap-3"><svg class="w-5 h-5 text-green-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg><span>ë§ì¶¤í˜• ëŒ€ì‹œë³´ë“œ</span></div><div class="flex gap-3"><svg class="w-5 h-5 text-green-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"></path></svg><span>24/7 ì „í™” ì§€ì›</span></div></div></div></div><div><div class="bg-white rounded-2xl p-8 border-2 border-green-300 shadow-2xl sticky top-32"><h2 class="text-2xl font-bold mb-6">ê²°ì œ ì •ë³´</h2><div class="mb-6"><div class="flex justify-between py-6"><div><div class="text-lg font-bold">ë¹„ì¦ˆë‹ˆìŠ¤ í”Œëœ (ì›”ê°„)</div><div class="text-sm text-gray-600 mt-1">1ê°œì›” ì´ìš©ê¶Œ</div></div><span class="text-3xl font-bold text-green-600">â‚©297,000</span></div></div><div class="space-y-4 mb-6"><input type="text" id="buyerName" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="ì´ë¦„"><input type="email" id="buyerEmail" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="ì´ë©”ì¼"><input type="tel" id="buyerPhone" class="w-full px-4 py-3 border-2 rounded-lg" placeholder="ì—°ë½ì²˜"></div><label class="flex gap-3 mb-6"><input type="checkbox" id="agreeTerms" class="w-5 h-5"><span class="text-sm">ì•½ê´€ ë™ì˜</span></label><button onclick="processPayment()" class="w-full py-4 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 mb-3">ğŸ’³ ì¹´ë“œ ê²°ì œí•˜ê¸°</button><button onclick="goToBankTransfer()" class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 hover:shadow-xl transition-all">ğŸ¦ ê³„ì¢Œì´ì²´í•˜ê¸°</button></div></div></div></div><script>IMP.init('imp00000000');const user=JSON.parse(localStorage.getItem('user')||'null');if(user){document.getElementById('buyerName').value=user.name||'';document.getElementById('buyerEmail').value=user.email||'';document.getElementById('buyerPhone').value=user.phone||'';}function goToBankTransfer(){if(!user){alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');window.location.href='/login';return;}window.location.href='/payment/bank-transfer?plan=ë¹„ì¦ˆë‹ˆìŠ¤ í”Œëœ&amount=297000';}function processPayment(){const name=document.getElementById('buyerName').value,email=document.getElementById('buyerEmail').value,phone=document.getElementById('buyerPhone').value;if(!name||!email||!phone||!document.getElementById('agreeTerms').checked){alert('ì •ë³´ ì…ë ¥ ë° ì•½ê´€ ë™ì˜ í•„ìš”');return;}if(!user){window.location.href='/login';return;}const merchantUid='academy_'+user.id+'_business_'+Date.now();IMP.request_pay({pg:'html5_inicis',pay_method:'card',merchant_uid:merchantUid,name:'ë¹„ì¦ˆë‹ˆìŠ¤ í”Œëœ',amount:326700,buyer_email:email,buyer_name:name,buyer_tel:phone},async(rsp)=>{if(rsp.success){const res=await fetch('/api/payments/complete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({imp_uid:rsp.imp_uid,merchant_uid:rsp.merchant_uid})});const result=await res.json();if(result.success){alert('ê²°ì œ ì™„ë£Œ!');window.location.href='/dashboard';}}else{alert('ê²°ì œ ì‹¤íŒ¨: '+rsp.error_msg);}});}</script></body></html>`)
})

// í”„ë¦¬ë¯¸ì—„ í”Œëœ êµ¬ë§¤ í˜ì´ì§€
app.get('/pricing/premium', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í”„ë¦¬ë¯¸ì—„ í”Œëœ êµ¬ë§¤ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
          .gradient-amber { background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%); }
        </style>
    </head>
    <body class="bg-gradient-to-br from-amber-50 via-white to-orange-50">
        <nav class="fixed w-full top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <div class="flex items-center space-x-6">
                        <a href="/pricing" class="text-gray-600 hover:text-amber-600 transition">â† ìš”ê¸ˆì œë¡œ ëŒì•„ê°€ê¸°</a>
                        <a href="/dashboard" class="gradient-amber text-white px-6 py-2.5 rounded-full font-medium hover:shadow-lg transition">ëŒ€ì‹œë³´ë“œ</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-32 pb-24 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="grid lg:grid-cols-2 gap-12">
                    <div>
                        <div class="inline-block px-4 py-2 bg-gradient-to-r from-amber-100 to-orange-100 rounded-full text-amber-700 text-sm font-semibold mb-4">í”„ë¦¬ë¯¸ì—„ í”Œëœ</div>
                        <h1 class="text-5xl font-bold text-gray-900 mb-4">ëŒ€í˜• í•™ì›ì„ ìœ„í•œ<br><span class="bg-gradient-to-r from-amber-600 to-orange-600 bg-clip-text text-transparent">í”„ë¦¬ë¯¸ì—„ í”Œëœ</span></h1>
                        <div class="flex items-end gap-3 mb-8">
                            <span class="text-6xl font-bold text-gray-900">â‚©330,000</span>
                            <span class="text-2xl text-gray-600 mb-2">/ì›”</span>
                        </div>

                        <div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl p-8 text-white mb-8">
                            <h3 class="text-xl font-bold mb-6">í¬í•¨ëœ ê¸°ëŠ¥</h3>
                            <div class="space-y-4">
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold">í•™ìƒ ìµœëŒ€ 1,000ëª…</div><div class="text-sm text-white/80">ëŒ€í˜• í•™ì›ì— ì í•©</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold">AI í•™ìŠµ ë¦¬í¬íŠ¸ ì›” 1,000ê°œ</div><div class="text-sm text-white/80">ë¬´ì œí•œ ë¶„ì„</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold">ëœë”©í˜ì´ì§€ 1,100ê°œ</div><div class="text-sm text-white/80">ëŒ€ê·œëª¨ ìº í˜ì¸ ì§€ì›</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold">ì„ ìƒë‹˜ ê³„ì • 40ëª…</div><div class="text-sm text-white/80">ëŒ€ê·œëª¨ ì¡°ì§ ê´€ë¦¬</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold">ì „ë‹´ ê³ ê° ì§€ì›</div><div class="text-sm text-white/80">24/7 ìš°ì„  ì‘ëŒ€</div></div></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="bg-white rounded-2xl p-8 border-2 border-amber-200 shadow-xl sticky top-32">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6">ê²°ì œ ì •ë³´</h2>
                            <div class="mb-6">
                                <div class="flex justify-between items-center py-6"><div><div class="text-lg font-bold text-gray-900">í”„ë¦¬ë¯¸ì—„ í”Œëœ (ì›”ê°„)</div><div class="text-sm text-gray-600 mt-1">1ê°œì›” ì´ìš©ê¶Œ</div></div><span class="text-3xl font-bold text-amber-600">â‚©330,000</span></div>
                            </div>
                            <div class="space-y-4 mb-6">
                                <div><label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë¦„</label><input type="text" id="buyerName" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none" placeholder="í™ê¸¸ë™"></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë©”ì¼</label><input type="email" id="buyerEmail" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none" placeholder="example@email.com"></div>
                                <div><label class="block text-sm font-semibold text-gray-700 mb-2">ì—°ë½ì²˜</label><input type="tel" id="buyerPhone" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-amber-500 focus:outline-none" placeholder="010-1234-5678"></div>
                            </div>
                            <div class="mb-6"><label class="flex items-start gap-3"><input type="checkbox" id="agreeTerms" class="mt-1 w-5 h-5 text-amber-600 border-gray-300 rounded focus:ring-amber-500"><span class="text-sm text-gray-700"><a href="/terms" class="text-amber-600 hover:underline">ì´ìš©ì•½ê´€</a> ë° <a href="/privacy" class="text-amber-600 hover:underline">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•©ë‹ˆë‹¤.</span></label></div>
                            <button onclick="requestCardPayment()" class="w-full py-4 gradient-amber text-white rounded-xl font-bold text-lg hover:shadow-2xl transition-all mb-3">ğŸ’³ ì¹´ë“œ ê²°ì œ ë§í¬ ë¬¸ì ìš”ì²­</button>
                            <button onclick="goToBankTransfer()" class="w-full py-4 bg-amber-600 text-white rounded-xl font-bold text-lg hover:bg-amber-700 hover:shadow-xl transition-all">ğŸ¦ ê³„ì¢Œì´ì²´í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (user) {
                document.getElementById('buyerName').value = user.name || '';
                document.getElementById('buyerEmail').value = user.email || '';
                document.getElementById('buyerPhone').value = user.phone || '';
            }
            function goToBankTransfer() {
                if (!user) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); window.location.href = '/login'; return; }
                window.location.href = '/payment/bank-transfer?plan=í”„ë¦¬ë¯¸ì—„ í”Œëœ&amount=330000';
            }
            async function requestCardPayment() {
                const name = document.getElementById('buyerName').value;
                const email = document.getElementById('buyerEmail').value;
                const phone = document.getElementById('buyerPhone').value;
                const agreeTerms = document.getElementById('agreeTerms').checked;
                if (!name || !email || !phone) { alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                if (!agreeTerms) { alert('ì´ìš©ì•½ê´€ ë° ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•´ì£¼ì„¸ìš”.'); return; }
                if (!user) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); window.location.href = '/login'; return; }
                try {
                    const response = await fetch('/api/card-payment/request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            userName: name,
                            userEmail: email,
                            userPhone: phone,
                            planName: 'í”„ë¦¬ë¯¸ì—„ í”Œëœ',
                            amount: 330000,
                            note: 'í”„ë¦¬ë¯¸ì—„ í”Œëœ ì¹´ë“œê²°ì œ ì‹ ì²­'
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… ì¹´ë“œ ê²°ì œ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nì¹´ë“œ ê²°ì œ ê°€ëŠ¥í•œ í˜ì´ì§€ ë§í¬ë¥¼ ë¬¸ì ë©”ì‹œì§€ë¡œ ì „ì†¡í•˜ê² ìŠµë‹ˆë‹¤!\\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ê²°ì œ ë§í¬ê°€ ë°œì†¡ë©ë‹ˆë‹¤.\\nìŠ¹ì¸ê¹Œì§€ 1-2 ì˜ì—…ì¼ ì†Œìš”ë©ë‹ˆë‹¤.');
                        window.location.href = '/dashboard';
                    } else {
                        alert('ì‹ ì²­ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    alert('ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    console.error('Card payment request error:', error);
                }
            }
        </script>
    </body>
    </html>
  `)
})


// ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ êµ¬ë§¤ í˜ì´ì§€
app.get('/pricing/enterprise', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ êµ¬ë§¤ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
          .gradient-slate { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); }
        </style>
    </head>
    <body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white">
        <nav class="fixed w-full top-0 z-50 bg-black/50 backdrop-blur-md border-b border-white/10">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-white">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <div class="flex items-center space-x-6">
                        <a href="/pricing" class="text-gray-300 hover:text-white transition">â† ìš”ê¸ˆì œë¡œ ëŒì•„ê°€ê¸°</a>
                        <a href="/dashboard" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-2.5 rounded-full font-medium hover:shadow-lg transition">ëŒ€ì‹œë³´ë“œ</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-32 pb-24 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="grid lg:grid-cols-2 gap-12">
                    <div>
                        <div class="inline-block px-4 py-2 bg-gradient-to-r from-purple-500/20 to-pink-500/20 border border-purple-500/50 rounded-full text-purple-300 text-sm font-semibold mb-4">ì—”í„°í”„ë¼ì´ì¦ˆ</div>
                        <h1 class="text-5xl font-bold mb-4">ëŒ€ê·œëª¨ í•™ì› ë°<br><span class="bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">í”„ëœì°¨ì´ì¦ˆë¥¼ ìœ„í•œ</span></h1>
                        <div class="flex items-end gap-3 mb-8">
                            <span class="text-6xl font-bold text-white">â‚©750,000</span>
                            <span class="text-2xl text-gray-400 mb-2">/ì›”</span>
                        </div>

                        <div class="bg-gradient-to-br from-purple-600/20 to-pink-600/20 backdrop-blur-xl border border-purple-500/30 rounded-2xl p-8 mb-8">
                            <h3 class="text-xl font-bold mb-6">í¬í•¨ëœ ê¸°ëŠ¥</h3>
                            <div class="space-y-4">
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-purple-400/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-white">í•™ìƒ ìµœëŒ€ 3,000ëª…</div><div class="text-sm text-gray-400">í”„ëœì°¨ì´ì¦ˆ ì§€ì›</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-purple-400/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-white">AI í•™ìŠµ ë¦¬í¬íŠ¸ ì›” 3,000ê°œ</div><div class="text-sm text-gray-400">ë¬´ì œí•œ ë¶„ì„</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-purple-400/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-white">ëœë”©í˜ì´ì§€ 5,000ê°œ</div><div class="text-sm text-gray-400">ë¬´ì œí•œ ìº í˜ì¸</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-purple-400/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-white">ì„ ìƒë‹˜ ê³„ì • ë¬´ì œí•œ</div><div class="text-sm text-gray-400">ë‹¤ì¤‘ ì§€ì  ê´€ë¦¬</div></div></div>
                                <div class="flex items-start gap-3"><div class="w-6 h-6 bg-purple-400/20 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5"><svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div><div><div class="font-semibold text-white">ì „ë‹´ ë§¤ë‹ˆì € ë°°ì •</div><div class="text-sm text-gray-400">1:1 ë§ì¶¤ ì§€ì›</div></div></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="bg-white/5 backdrop-blur-xl rounded-2xl p-8 border border-white/10 shadow-2xl sticky top-32">
                            <h2 class="text-2xl font-bold text-white mb-6">ê²°ì œ ì •ë³´</h2>
                            <div class="mb-6">
                                <div class="flex justify-between items-center py-6"><div><div class="text-lg font-bold text-white">ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ (ì›”ê°„)</div><div class="text-sm text-gray-400 mt-1">1ê°œì›” ì´ìš©ê¶Œ</div></div><span class="text-3xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">â‚©750,000</span></div>
                            </div>
                            <div class="space-y-4 mb-6">
                                <div><label class="block text-sm font-semibold text-gray-300 mb-2">ì´ë¦„</label><input type="text" id="buyerName" class="w-full px-4 py-3 border-2 border-white/10 bg-white/5 text-white rounded-lg focus:border-purple-500 focus:outline-none" placeholder="í™ê¸¸ë™"></div>
                                <div><label class="block text-sm font-semibold text-gray-300 mb-2">ì´ë©”ì¼</label><input type="email" id="buyerEmail" class="w-full px-4 py-3 border-2 border-white/10 bg-white/5 text-white rounded-lg focus:border-purple-500 focus:outline-none" placeholder="example@email.com"></div>
                                <div><label class="block text-sm font-semibold text-gray-300 mb-2">ì—°ë½ì²˜</label><input type="tel" id="buyerPhone" class="w-full px-4 py-3 border-2 border-white/10 bg-white/5 text-white rounded-lg focus:border-purple-500 focus:outline-none" placeholder="010-1234-5678"></div>
                            </div>
                            <div class="mb-6"><label class="flex items-start gap-3"><input type="checkbox" id="agreeTerms" class="mt-1 w-5 h-5 text-purple-600 border-gray-600 rounded focus:ring-purple-500"><span class="text-sm text-gray-300"><a href="/terms" class="text-purple-400 hover:underline">ì´ìš©ì•½ê´€</a> ë° <a href="/privacy" class="text-purple-400 hover:underline">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>ì— ë™ì˜í•©ë‹ˆë‹¤.</span></label></div>
                            <button onclick="requestCardPayment()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-bold text-lg hover:shadow-2xl transition-all mb-3">ğŸ’³ ì¹´ë“œ ê²°ì œ ë§í¬ ë¬¸ì ìš”ì²­</button>
                            <button onclick="goToBankTransfer()" class="w-full py-4 bg-purple-600 text-white rounded-xl font-bold text-lg hover:bg-purple-700 hover:shadow-xl transition-all">ğŸ¦ ê³„ì¢Œì´ì²´í•˜ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (user) {
                document.getElementById('buyerName').value = user.name || '';
                document.getElementById('buyerEmail').value = user.email || '';
                document.getElementById('buyerPhone').value = user.phone || '';
            }
            function goToBankTransfer() {
                if (!user) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); window.location.href = '/login'; return; }
                window.location.href = '/payment/bank-transfer?plan=ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ&amount=750000';
            }
            async function requestCardPayment() {
                const name = document.getElementById('buyerName').value;
                const email = document.getElementById('buyerEmail').value;
                const phone = document.getElementById('buyerPhone').value;
                const agreeTerms = document.getElementById('agreeTerms').checked;
                if (!name || !email || !phone) { alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                if (!agreeTerms) { alert('ì´ìš©ì•½ê´€ ë° ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì— ë™ì˜í•´ì£¼ì„¸ìš”.'); return; }
                if (!user) { alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.'); window.location.href = '/login'; return; }
                try {
                    const response = await fetch('/api/card-payment/request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            userName: name,
                            userEmail: email,
                            userPhone: phone,
                            planName: 'ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ',
                            amount: 750000,
                            note: 'ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ ì¹´ë“œê²°ì œ ì‹ ì²­'
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… ì¹´ë“œ ê²°ì œ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nì¹´ë“œ ê²°ì œ ê°€ëŠ¥í•œ í˜ì´ì§€ ë§í¬ë¥¼ ë¬¸ì ë©”ì‹œì§€ë¡œ ì „ì†¡í•˜ê² ìŠµë‹ˆë‹¤!\\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ê²°ì œ ë§í¬ê°€ ë°œì†¡ë©ë‹ˆë‹¤.\\nìŠ¹ì¸ê¹Œì§€ 1-2 ì˜ì—…ì¼ ì†Œìš”ë©ë‹ˆë‹¤.');
                        window.location.href = '/dashboard';
                    } else {
                        alert('ì‹ ì²­ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    alert('ì‹ ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    console.error('Card payment request error:', error);
                }
            }
        </script>
    </body>
    </html>
  `)
})


// ìš”ê¸ˆì œ í˜ì´ì§€
app.get('/pricing', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ìš”ê¸ˆì œ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
          .gradient-orange {
            background: linear-gradient(135deg, #f97316 0%, #fb923c 100%);
          }
          .gradient-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
          }
          .pricing-card {
            transition: all 0.3s ease;
          }
          .pricing-card:hover {
            transform: translateY(-8px);
          }
          .check-icon {
            flex-shrink: 0;
          }
        </style>
    </head>
    <body class="bg-gradient-to-br from-purple-50 via-white to-orange-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white/80 backdrop-blur-md border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <div class="hidden md:flex items-center space-x-10">
                        <a href="/" class="text-gray-700 hover:text-purple-600 font-medium transition">í™ˆ</a>
                        <a href="/programs" class="text-gray-700 hover:text-purple-600 font-medium transition">êµìœ¡ í”„ë¡œê·¸ë¨</a>
                        <a href="/pricing" class="text-purple-600 font-bold">ìš”ê¸ˆì œ</a>
                        <a href="/success" class="text-gray-700 hover:text-purple-600 font-medium transition">ì„±ê³µ ì‚¬ë¡€</a>
                        <a href="/contact" class="text-gray-700 hover:text-purple-600 font-medium transition">ë¬¸ì˜í•˜ê¸°</a>
                        <a href="/login" class="gradient-purple text-white px-6 py-2.5 rounded-full font-medium hover:shadow-lg transition-all">ë¡œê·¸ì¸</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="pt-32 pb-16 px-6">
            <div class="max-w-7xl mx-auto text-center">
                <div class="inline-block mb-6 px-5 py-2.5 bg-purple-100 rounded-full text-purple-700 text-sm font-semibold">
                    ğŸ’ í•©ë¦¬ì ì¸ ê°€ê²©ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”
                </div>
                <h1 class="text-5xl lg:text-6xl font-bold text-gray-900 mb-6">
                    í•™ì› ì„±ì¥ì„ ìœ„í•œ<br>
                    <span class="text-purple-600">ë§ì¶¤í˜• ìš”ê¸ˆì œ</span>
                </h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
                    ê·œëª¨ì™€ í•„ìš”ì— ë§ëŠ” í”Œëœì„ ì„ íƒí•˜ê³ ,<br>
                    ì§€ê¸ˆ ë°”ë¡œ í•™ì› ë§ˆì¼€íŒ… í˜ì‹ ì„ ì‹œì‘í•˜ì„¸ìš”
                </p>
            </div>
        </section>

        <!-- Pricing Cards -->
        <section class="pb-24 px-6">
            <div class="max-w-7xl mx-auto">
                <!-- ë¬´ë£Œ í”Œëœ (ìƒë‹¨ 1ê°œ) -->
                <div class="max-w-md mx-auto mb-12">
                    
                    <!-- ë¬´ë£Œ í”Œëœ -->
                    <div class="pricing-card bg-gradient-to-br from-green-50 to-emerald-50 rounded-3xl p-8 border-2 border-green-300 hover:border-green-400 hover:shadow-2xl relative">
                        <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
                            <div class="bg-green-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg">
                                ğŸ ë¬´ë£Œ
                            </div>
                        </div>
                        <div class="mb-6">
                            <div class="inline-block px-4 py-2 bg-green-100 rounded-full text-green-700 text-sm font-semibold mb-4">
                                ë¬´ë£Œ
                            </div>
                            <div class="flex items-end gap-2 mb-2">
                                <span class="text-5xl font-bold text-gray-900">â‚©0</span>
                                <span class="text-gray-600 mb-2">/ì›”</span>
                            </div>
                            <p class="text-gray-600">í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ ì²´í—˜</p>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700">í•™ìƒ ìµœëŒ€ 50ëª…</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-gray-300 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                <span class="text-gray-400 line-through">AI ë¦¬í¬íŠ¸</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700">ëœë”©í˜ì´ì§€ 1ê°œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="w-5 h-5 text-gray-300 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                <span class="text-gray-400 line-through">ì„ ìƒë‹˜ ê³„ì •</span>
                            </div>
                        </div>
                        
                        <div class="mb-6 p-3 bg-green-50 rounded-lg">
                            <p class="text-xs text-gray-600 leading-relaxed">
                                âœ“ í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ ì²´í—˜ìš©<br>
                                âœ“ ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”<br>
                                âš ï¸ AI ë¦¬í¬íŠ¸, ì„ ìƒë‹˜ ê³„ì • ì œí•œ
                            </p>
                        </div>
                        
                        <a href="/pricing/free"
                            class="block text-center w-full py-4 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600 transition-all hover:shadow-lg">
                            ë¬´ë£Œ ì‹ ì²­í•˜ê¸°
                        </a>
                    </div>
                </div>
                
                <!-- ìœ ë£Œ í”Œëœë“¤ (3ê°œ + 3ê°œ) -->
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    
                    <!-- ìŠ¤íƒ€í„° í”Œëœ -->
                    <div class="pricing-card bg-white rounded-3xl p-8 border-2 border-gray-200 hover:border-purple-300 hover:shadow-2xl">
                        <div class="mb-6">
                            <div class="inline-block px-4 py-2 bg-gray-100 rounded-full text-gray-700 text-sm font-semibold mb-4">
                                ìŠ¤íƒ€í„°
                            </div>
                            <div class="flex items-end gap-2 mb-2">
                                <span class="text-5xl font-bold text-gray-900">â‚©55,000</span>
                                <span class="text-gray-600 mb-2">/ì›”</span>
                            </div>
                            <p class="text-gray-600">ì†Œê·œëª¨ í•™ì›ì„ ìœ„í•œ ê¸°ë³¸ í”Œëœ</p>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700">í•™ìƒ ìµœëŒ€ 50ëª…</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700">AI ë¦¬í¬íŠ¸ ì›” 50ê°œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700">ëœë”©í˜ì´ì§€ 50ê°œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700">ì„ ìƒë‹˜ ê³„ì • 2ëª…</span>
                            </div>
                        </div>
                        
                        <div class="mb-6 p-3 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-600 leading-relaxed">
                                âš ï¸ í•œë„ ì´ˆê³¼ ì‹œ ì¶”ê°€ ë¶ˆê°€<br>
                                ğŸ’¡ ìƒìœ„ í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ í•„ìš”
                            </p>
                        </div>
                        
                        <a href="/pricing/starter"
                            class="block text-center w-full py-4 bg-gray-900 text-white rounded-xl font-bold hover:bg-gray-800 transition-all hover:shadow-lg">
                            êµ¬ë§¤í•˜ê¸°
                        </a>
                    </div>

                    <!-- ë² ì´ì§ í”Œëœ -->
                    <div class="pricing-card bg-white rounded-3xl p-8 border-2 border-blue-200 hover:border-blue-400 hover:shadow-2xl relative">
                        <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
                            <div class="bg-blue-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-lg">
                                â­ ì¸ê¸°
                            </div>
                        </div>
                        <div class="mb-6">
                            <div class="inline-block px-4 py-2 bg-blue-100 rounded-full text-blue-700 text-sm font-semibold mb-4">
                                ë² ì´ì§
                            </div>
                            <div class="flex items-end gap-2 mb-2">
                                <span class="text-5xl font-bold text-gray-900">â‚©143,000</span>
                                <span class="text-gray-600 mb-2">/ì›”</span>
                            </div>
                            <p class="text-gray-600">ì„±ì¥í•˜ëŠ” í•™ì›ì„ ìœ„í•œ í”Œëœ</p>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700">í•™ìƒ ìµœëŒ€ 150ëª…</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700">AI ë¦¬í¬íŠ¸ ì›” 150ê°œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700">ëœë”©í˜ì´ì§€ 160ê°œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700">ì„ ìƒë‹˜ ê³„ì • 6ëª…</span>
                            </div>
                        </div>
                        
                        <div class="mb-6 p-3 bg-blue-50 rounded-lg">
                            <p class="text-xs text-gray-600 leading-relaxed">
                                âš ï¸ í•œë„ ì´ˆê³¼ ì‹œ ì¶”ê°€ ë¶ˆê°€<br>
                                ğŸ’¡ ìƒìœ„ í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ í•„ìš”
                            </p>
                        </div>
                        
                        <button 
                            onclick="location.href='/pricing/basic'"
                            class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all hover:shadow-lg">
                            êµ¬ë§¤í•˜ê¸°
                        </button>
                    </div>

                    <!-- í”„ë¡œ í”Œëœ (ì¶”ì²œ) -->
                    <div class="pricing-card bg-gradient-to-br from-purple-600 to-purple-700 rounded-3xl p-8 border-2 border-purple-500 hover:shadow-2xl relative">                        
                        <div class="mb-6">
                            <div class="inline-block px-4 py-2 bg-white/20 rounded-full text-white text-sm font-semibold mb-4">
                                í”„ë¡œ
                            </div>
                            <div class="flex items-end gap-2 mb-2">
                                <span class="text-5xl font-bold text-white">â‚©187,000</span>
                                <span class="text-purple-100 mb-2">/ì›”</span>
                            </div>
                            <p class="text-purple-100">ì¤‘í˜• í•™ì›ì„ ìœ„í•œ í”„ë¦¬ë¯¸ì—„ í”Œëœ</p>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-300 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-white font-medium">í•™ìƒ ìµœëŒ€ 500ëª…</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-300 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-white font-medium">AI ë¦¬í¬íŠ¸ ì›” 500ê°œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-300 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-white font-medium">ëœë”©í˜ì´ì§€ 530ê°œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-300 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-white font-medium">ì„ ìƒë‹˜ ê³„ì • 20ëª…</span>
                            </div>
                        </div>
                        
                        <div class="mb-6 p-3 bg-white/10 rounded-lg">
                            <p class="text-xs text-purple-100 leading-relaxed">
                                âš ï¸ í•œë„ ì´ˆê³¼ ì‹œ ì¶”ê°€ ë¶ˆê°€<br>
                                ğŸ’¡ ìƒìœ„ í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ í•„ìš”
                            </p>
                        </div>
                        
                        <button 
                            onclick="location.href='/pricing/pro'"
                            class="w-full py-4 bg-white text-purple-600 rounded-xl font-bold hover:bg-purple-50 transition-all hover:shadow-lg">
                            êµ¬ë§¤í•˜ê¸°
                        </button>
                    </div>

                    <!-- í”„ë¦¬ë¯¸ì—„ í”Œëœ -->
                    <div class="pricing-card bg-white rounded-3xl p-8 border-2 border-orange-200 hover:border-orange-400 hover:shadow-2xl">
                        <div class="mb-6">
                            <div class="inline-block px-4 py-2 bg-orange-100 rounded-full text-orange-700 text-sm font-semibold mb-4">
                                í”„ë¦¬ë¯¸ì—„
                            </div>
                            <div class="flex items-end gap-2 mb-2">
                                <span class="text-5xl font-bold text-gray-900">â‚©330,000</span>
                                <span class="text-gray-600 mb-2">/ì›”</span>
                            </div>
                            <p class="text-gray-600">ëŒ€ê·œëª¨ í•™ì› ìµœì í™” ì†”ë£¨ì…˜</p>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700 font-medium">í•™ìƒ ìµœëŒ€ 1,000ëª…</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700 font-medium">AI ë¦¬í¬íŠ¸ ì›” 1,000ê°œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700 font-medium">ëœë”©í˜ì´ì§€ 1,100ê°œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-gray-700 font-medium">ì„ ìƒë‹˜ ê³„ì • 40ëª…</span>
                            </div>
                        </div>
                        
                        <div class="mb-6 p-3 bg-orange-50 rounded-lg">
                            <p class="text-xs text-gray-600 leading-relaxed">
                                âš ï¸ í•œë„ ì´ˆê³¼ ì‹œ ì¶”ê°€ ë¶ˆê°€<br>
                                ğŸ’¡ ìƒìœ„ í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ í•„ìš”
                            </p>
                        </div>
                        
                        <button 
                            onclick="location.href='/pricing/premium'"
                            class="w-full py-4 bg-orange-600 text-white rounded-xl font-bold hover:bg-orange-700 transition-all hover:shadow-lg">
                            êµ¬ë§¤í•˜ê¸°
                        </button>
                    </div>

                    <!-- ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ -->
                    <div class="pricing-card bg-gradient-to-br from-gray-900 to-gray-800 rounded-3xl p-8 border-2 border-gray-700 hover:shadow-2xl">
                        <div class="mb-6">
                            <div class="inline-block px-4 py-2 bg-white/10 rounded-full text-white text-sm font-semibold mb-4">
                                ì—”í„°í”„ë¼ì´ì¦ˆ
                            </div>
                            <div class="flex items-end gap-2 mb-2">
                                <span class="text-5xl font-bold text-white">â‚©750,000</span>
                                <span class="text-gray-300 mb-2">/ì›”</span>
                            </div>
                            <p class="text-gray-300">í”„ëœì°¨ì´ì¦ˆ & ëŒ€í˜• í•™ì› ê·¸ë£¹</p>
                        </div>
                        
                        <div class="space-y-3 mb-6">
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-white font-medium">í•™ìƒ ìµœëŒ€ 3,000ëª…</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-white font-medium">AI ë¦¬í¬íŠ¸ ì›” 3,000ê°œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-white font-medium">ëœë”©í˜ì´ì§€ 5,000ê°œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-white font-medium">ì„ ìƒë‹˜ ê³„ì • ë¬´ì œí•œ</span>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg class="check-icon w-5 h-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-white font-medium">ì „ë‹´ ë§¤ë‹ˆì € ë°°ì •</span>
                            </div>
                        </div>
                        
                        <div class="mb-6 p-3 bg-white/5 rounded-lg">
                            <p class="text-xs text-gray-300 leading-relaxed">
                                ğŸ¯ ëŒ€ê·œëª¨ í•™ì›ì„ ìœ„í•œ ìµœê³ ê¸‰ í”Œëœ<br>
                                ğŸ’¼ ì „ë‹´ ë§¤ë‹ˆì €ì˜ 1:1 ì¼€ì–´
                            </p>
                        </div>
                        
                        <button 
                            onclick="location.href='/pricing/enterprise'"
                            class="w-full py-4 bg-white text-gray-900 rounded-xl font-bold hover:bg-gray-100 transition-all hover:shadow-lg">
                            êµ¬ë§¤í•˜ê¸°
                        </button>
                    </div>

                </div>
            </div>
        </section>

        <!-- FAQ Section -->
        <section class="py-24 px-6 bg-white">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl font-bold text-gray-900 mb-4">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</h2>
                    <p class="text-xl text-gray-600">ê¶ê¸ˆí•˜ì‹  ì ì„ í™•ì¸í•´ë³´ì„¸ìš”</p>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-gray-50 rounded-2xl p-6 hover:bg-gray-100 transition-all">
                        <h3 class="text-lg font-bold text-gray-900 mb-2">ğŸ’³ ê²°ì œ ë°©ë²•ì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?</h3>
                        <p class="text-gray-600">ì‹ ìš©ì¹´ë“œ, ì²´í¬ì¹´ë“œ, ê³„ì¢Œì´ì²´, ê°€ìƒê³„ì¢Œ ë“± ë‹¤ì–‘í•œ ê²°ì œ ìˆ˜ë‹¨ì„ ì§€ì›í•©ë‹ˆë‹¤.</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-2xl p-6 hover:bg-gray-100 transition-all">
                        <h3 class="text-lg font-bold text-gray-900 mb-2">ğŸ”„ í”Œëœ ë³€ê²½ì´ ê°€ëŠ¥í•œê°€ìš”?</h3>
                        <p class="text-gray-600">ë„¤, ì–¸ì œë“ ì§€ í”Œëœì„ ì—…ê·¸ë ˆì´ë“œí•˜ê±°ë‚˜ ë‹¤ìš´ê·¸ë ˆì´ë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì°¨ì•¡ì€ ì¼í•  ê³„ì‚°ë©ë‹ˆë‹¤.</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-2xl p-6 hover:bg-gray-100 transition-all">
                        <h3 class="text-lg font-bold text-gray-900 mb-2">ğŸ“± ë¬´ë£Œ ì²´í—˜ì´ ê°€ëŠ¥í•œê°€ìš”?</h3>
                        <p class="text-gray-600">ë² ì´ì§ í”Œëœì„ 14ì¼ ë™ì•ˆ ë¬´ë£Œë¡œ ì²´í—˜í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì²´í—˜ ê¸°ê°„ ì¤‘ ì–¸ì œë“  í•´ì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-2xl p-6 hover:bg-gray-100 transition-all">
                        <h3 class="text-lg font-bold text-gray-900 mb-2">ğŸ“ êµìœ¡ ìë£ŒëŠ” ì–´ë–»ê²Œ ë°›ë‚˜ìš”?</h3>
                        <p class="text-gray-600">êµ¬ë§¤ í›„ ëŒ€ì‹œë³´ë“œì—ì„œ ì¦‰ì‹œ ëª¨ë“  êµìœ¡ ìë£Œì™€ ë§ˆì¼€íŒ… ê°€ì´ë“œì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA Section -->
        <section class="py-24 px-6 bg-gradient-to-br from-purple-600 to-purple-800">
            <div class="max-w-4xl mx-auto text-center text-white">
                <h2 class="text-4xl lg:text-5xl font-bold mb-6">
                    ì•„ì§ ê³ ë¯¼ì¤‘ì´ì‹ ê°€ìš”?
                </h2>
                <p class="text-xl text-purple-100 mb-10">
                    ì§€ê¸ˆ ë°”ë¡œ ìƒë‹´ì„ ë°›ì•„ë³´ì„¸ìš”. í•™ì›ì— ë§ëŠ” ìµœì ì˜ í”Œëœì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤.
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="/contact" class="inline-block bg-white text-purple-600 px-8 py-4 rounded-xl font-bold hover:bg-purple-50 transition-all">
                        ë¬´ë£Œ ìƒë‹´ ì‹ ì²­
                    </a>
                    <a href="tel:010-8739-9697" class="inline-block bg-purple-500 text-white px-8 py-4 rounded-xl font-bold hover:bg-purple-400 transition-all">
                        ğŸ“ 010-8739-9697
                    </a>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-gray-900 text-gray-300 py-16 px-6">
            <div class="max-w-7xl mx-auto text-center">
                <div class="text-2xl font-bold text-white mb-4">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</div>
                <p class="text-gray-400 mb-6">í•™ì› ë§ˆì¼€íŒ…ì˜ ìƒˆë¡œìš´ ê¸°ì¤€</p>
                <div class="space-y-2">
                    <p>ì´ë©”ì¼: wangholy1@naver.com</p>
                    <p>ì „í™”: 010-8739-9697</p>
                </div>
            </div>
        </footer>

        <script>
            // ì•„ì„í¬íŠ¸ ì´ˆê¸°í™”
            const IMP = window.IMP;
            IMP.init('imp00000000'); // ì‹¤ì œ ê°€ë§¹ì  ì‹ë³„ì½”ë“œë¡œ êµì²´ í•„ìš”

            function startPayment(plan, amount, planName) {
                // ë¡œê·¸ì¸ ì²´í¬
                const currentUser = localStorage.getItem('currentUser');
                if (!currentUser) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }

                const user = JSON.parse(currentUser);
                // merchant_uid í˜•ì‹: academy_{academyId}_{planId}_{timestamp}
                const merchantUid = \`academy_\${user.id}_\${plan}_\${new Date().getTime()}\`;

                console.log('[Payment] Starting payment:', { plan, amount, planName, merchantUid });

                IMP.request_pay({
                    pg: 'html5_inicis',  // PGì‚¬ (inicis: KGì´ë‹ˆì‹œìŠ¤)
                    pay_method: 'card',
                    merchant_uid: merchantUid,
                    name: planName,
                    amount: amount,
                    buyer_email: user.email || '',
                    buyer_name: user.name || '',
                    buyer_tel: user.phone || '',
                    buyer_addr: '',
                    buyer_postcode: ''
                }, async function(rsp) {
                    if (rsp.success) {
                        console.log('[Payment] Payment success:', { imp_uid: rsp.imp_uid, merchant_uid: rsp.merchant_uid });
                        
                        // ê²°ì œ ì„±ê³µ ì‹œ ì„œë²„ì— êµ¬ë… ìƒì„± ìš”ì²­
                        try {
                            const response = await fetch('/api/payments/complete', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    imp_uid: rsp.imp_uid,
                                    merchant_uid: rsp.merchant_uid
                                })
                            });

                            const result = await response.json();
                            
                            if (result.success) {
                                const sub = result.subscription;
                                alert(\`ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\ní”Œëœ: \${sub.planName}\\nì´ìš© ê¸°ê°„: \${sub.startDate} ~ \${sub.endDate}\\n\\nëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.\`);
                                window.location.href = '/dashboard';
                            } else {
                                alert('ê²°ì œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
                            }
                        } catch (error) {
                            console.error('[Payment] Error:', error);
                            alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        console.error('[Payment] Payment failed:', rsp.error_msg);
                        alert('ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + rsp.error_msg);
                    }
                });
            }
            
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
            (function() {
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                const navButtons = document.querySelectorAll('nav a[href="/login"]');
                
                navButtons.forEach(loginBtn => {
                    if (user && user.id) {
                        // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì: ëŒ€ì‹œë³´ë“œ ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
                        loginBtn.href = '/dashboard';
                        loginBtn.textContent = 'ëŒ€ì‹œë³´ë“œ';
                        loginBtn.className = 'gradient-purple text-white px-6 py-2.5 rounded-full font-medium hover:shadow-lg transition-all';
                    }
                    // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ì: ê¸°ì¡´ ë¡œê·¸ì¸ ë²„íŠ¼ ìœ ì§€
                });
            })();
        </script>
    </body>
    </html>
  `)
})

// ë¬¸ì˜í•˜ê¸° í˜ì´ì§€
app.get('/contact', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¬¸ì˜í•˜ê¸° - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
        </style>
    </head>
    <body class="bg-white">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <img src="/static/images/logo.png" alt="SUPER PLACE" class="h-10" onerror="this.style.display='none'">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <div class="hidden md:flex items-center space-x-10">
                        <a href="/" class="text-gray-700 hover:text-purple-600 font-medium transition">í™ˆ</a>
                        <a href="/programs" class="text-gray-700 hover:text-purple-600 font-medium transition">êµìœ¡ í”„ë¡œê·¸ë¨</a>
                        <a href="/success" class="text-gray-700 hover:text-purple-600 font-medium transition">ì„±ê³µ ì‚¬ë¡€</a>
                        <a href="/contact" class="text-purple-600 font-medium transition">ë¬¸ì˜í•˜ê¸°</a>
                        <a href="/login" class="gradient-purple text-white px-6 py-2.5 rounded-full font-medium hover:shadow-lg transition-all">ë¡œê·¸ì¸</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Contact Form Section -->
        <section class="pt-32 pb-24 px-6">
            <div class="max-w-3xl mx-auto">
                <div class="text-center mb-12">
                    <h1 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-4">ë¬´ë£Œ ìƒë‹´ ì‹ ì²­</h1>
                    <p class="text-xl text-gray-600">í•™ì›ì— ë§ëŠ” ë§ì¶¤ ë§ˆì¼€íŒ… ì „ëµì„ ìƒë‹´í•´ë“œë¦½ë‹ˆë‹¤</p>
                </div>

                <!-- ì¹´ì¹´ì˜¤ì±„ë„ ë¬¸ì˜ ë²„íŠ¼ -->
                <div class="mb-8">
                    <a href="https://pf.kakao.com/_tnZzn/chat" target="_blank" rel="noopener noreferrer"
                        class="block bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 rounded-2xl shadow-lg p-6 hover:shadow-xl transition-all transform hover:-translate-y-1">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-yellow-300 rounded-2xl flex items-center justify-center">
                                    <svg class="w-10 h-10" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 3C6.5 3 2 6.58 2 11c0 2.95 2.03 5.53 5 6.74V22l4.5-3.5c.67.09 1.36.14 2.5.14 5.5 0 10-3.58 10-8s-4.5-8-10-8z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold mb-1">ğŸ’¬ ì¹´ì¹´ì˜¤ì±„ë„ë¡œ ë¹ ë¥¸ ë¬¸ì˜</h3>
                                    <p class="text-sm text-gray-700">ì‹¤ì‹œê°„ ìƒë‹´ ê°€ëŠ¥ (í‰ì¼ 9:00-18:00)</p>
                                </div>
                            </div>
                            <div class="text-2xl">â†’</div>
                        </div>
                    </a>
                </div>

                <div class="text-center mb-8">
                    <span class="inline-block px-4 py-2 bg-gray-100 rounded-full text-sm text-gray-600">
                        ë˜ëŠ” ì•„ë˜ ì–‘ì‹ìœ¼ë¡œ ë¬¸ì˜í•˜ì„¸ìš”
                    </span>
                </div>

                <div class="bg-white rounded-2xl border border-gray-200 p-8 lg:p-12">
                    <form id="contactForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì´ë¦„ <span class="text-red-500">*</span></label>
                            <input type="text" name="name" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì´ë©”ì¼ <span class="text-red-500">*</span></label>
                            <input type="email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì—°ë½ì²˜ <span class="text-red-500">*</span></label>
                            <input type="tel" name="phone" required placeholder="010-0000-0000" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì›ëª…</label>
                            <input type="text" name="academy_name" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ë¬¸ì˜ ë‚´ìš© <span class="text-red-500">*</span></label>
                            <textarea name="message" required rows="6" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition resize-none"></textarea>
                        </div>

                        <button type="submit" class="w-full gradient-purple text-white py-4 rounded-xl text-lg font-medium hover:shadow-xl transition-all">
                            ë¬¸ì˜ ì ‘ìˆ˜í•˜ê¸°
                        </button>

                        <div id="message" class="hidden mt-4 p-4 rounded-xl"></div>
                    </form>
                </div>

                <div class="mt-12 grid md:grid-cols-3 gap-6">
                    <div class="text-center p-6 bg-gray-50 rounded-xl">
                        <svg class="w-10 h-10 mx-auto mb-3 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <div class="font-medium text-gray-900">ì´ë©”ì¼</div>
                        <div class="text-sm text-gray-600 mt-1">wangholy1@naver.com</div>
                    </div>
                    <div class="text-center p-6 bg-gray-50 rounded-xl">
                        <svg class="w-10 h-10 mx-auto mb-3 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <div class="font-medium text-gray-900">ìœ„ì¹˜</div>
                        <div class="text-sm text-gray-600 mt-1">ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬</div>
                    </div>
                    <div class="text-center p-6 bg-gray-50 rounded-xl">
                        <svg class="w-10 h-10 mx-auto mb-3 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="font-medium text-gray-900">ìƒë‹´ ì‹œê°„</div>
                        <div class="text-sm text-gray-600 mt-1">í‰ì¼ 10:00 - 18:00</div>
                    </div>
                </div>
            </div>
        </section>

        <script>
            document.getElementById('contactForm').addEventListener('submit', async (e) => {
                e.preventDefault()
                
                const formData = new FormData(e.target)
                const data = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    academy_name: formData.get('academy_name'),
                    message: formData.get('message')
                }

                try {
                    const response = await fetch('/api/contact', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    })

                    const result = await response.json()
                    const messageEl = document.getElementById('message')
                    messageEl.classList.remove('hidden')

                    if (result.success) {
                        messageEl.className = 'mt-4 p-4 rounded-xl bg-green-50 text-green-800 border border-green-200'
                        messageEl.textContent = result.message
                        e.target.reset()
                    } else {
                        messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                        messageEl.textContent = result.error
                    }
                } catch (err) {
                    const messageEl = document.getElementById('message')
                    messageEl.classList.remove('hidden')
                    messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                    messageEl.textContent = 'ë¬¸ì˜ ì ‘ìˆ˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                }
            })
        </script>
    </body>
    </html>
  `)
})

// íšŒì›ê°€ì… í˜ì´ì§€
app.get('/register', (c) => {
  return c.redirect('/signup')
})

// ë¡œê·¸ì¸ í˜ì´ì§€
app.get('/login', (c) => {
  const googleClientId = c.env.GOOGLE_CLIENT_ID || 'YOUR_GOOGLE_CLIENT_ID'
  const kakaoJsKey = c.env.KAKAO_JS_KEY || 'YOUR_KAKAO_JS_KEY'
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¡œê·¸ì¸ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen flex items-center justify-center px-6 py-12">
            <div class="max-w-md w-full">
                <div class="text-center mb-10">
                    <a href="/" class="inline-block mb-6">
                        <span class="text-2xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">ë¡œê·¸ì¸</h1>
                    <p class="text-gray-600">í•™ì› ë§ˆì¼€íŒ… êµìœ¡ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>
                </div>

                <div class="bg-white rounded-2xl border border-gray-200 p-8">
                    <form id="loginForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì´ë©”ì¼</label>
                            <input type="email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" name="password" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                        </div>

                        <button type="submit" class="w-full gradient-purple text-white py-3 rounded-xl font-medium hover:shadow-xl transition-all">
                            ë¡œê·¸ì¸
                        </button>

                        <div id="message" class="hidden mt-4 p-4 rounded-xl"></div>
                    </form>

                    <!-- ì†Œì…œ ë¡œê·¸ì¸ -->
                    <div class="mt-6">
                        <div class="relative">
                            <div class="absolute inset-0 flex items-center">
                                <div class="w-full border-t border-gray-200"></div>
                            </div>
                            <div class="relative flex justify-center text-sm">
                                <span class="px-4 bg-white text-gray-500">ë˜ëŠ” ê°„í¸ ë¡œê·¸ì¸</span>
                            </div>
                        </div>

                        <div class="mt-6 space-y-3">
                            <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center gap-3 px-4 py-3 border border-gray-300 rounded-xl hover:bg-gray-50 transition-all">
                                <svg class="w-5 h-5" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                <span class="font-medium text-gray-700">êµ¬ê¸€ë¡œ ê³„ì†í•˜ê¸°</span>
                            </button>

                            <button onclick="loginWithKakao()" class="w-full flex items-center justify-center gap-3 px-4 py-3 rounded-xl transition-all" style="background-color: #FEE500;">
                                <svg class="w-5 h-5" viewBox="0 0 24 24">
                                    <path fill="#000000" d="M12 3c5.799 0 10.5 3.664 10.5 8.185 0 4.52-4.701 8.184-10.5 8.184a13.5 13.5 0 0 1-1.727-.11l-4.408 2.883c-.501.265-.678.236-.472-.413l.892-3.678c-2.88-1.46-4.785-3.99-4.785-6.866C1.5 6.665 6.201 3 12 3zm5.907 8.06l1.47-1.424a.472.472 0 0 0-.656-.678l-1.928 1.866V9.282a.472.472 0 0 0-.944 0v2.557a.471.471 0 0 0 0 .222V13.5a.472.472 0 0 0 .944 0v-1.363l.427-.413 1.428 2.033a.472.472 0 1 0 .773-.543l-1.514-2.155zm-2.958 1.924h-1.46V9.297a.472.472 0 0 0-.943 0v4.159c0 .26.21.472.471.472h1.932a.472.472 0 1 0 0-.944zm-5.857-1.092l.696-1.707.638 1.707H9.092zm2.523.488l.002-.016a.469.469 0 0 0-.127-.32l-1.046-2.8a.69.69 0 0 0-.627-.474.696.696 0 0 0-.653.447l-1.661 4.075a.472.472 0 0 0 .874.357l.33-.813h2.07l.299.8a.472.472 0 1 0 .884-.33l-.345-.926zM8.294 9.302a.472.472 0 0 0-.471-.472H5.185a.472.472 0 1 0 0 .944h1.039v3.736a.472.472 0 0 0 .943 0V9.774h1.127a.472.472 0 0 0 .47-.472z"/>
                                </svg>
                                <span class="font-medium text-gray-900">ì¹´ì¹´ì˜¤ë¡œ ê³„ì†í•˜ê¸°</span>
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 text-center text-sm text-gray-600">
                        ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="/signup" class="text-purple-600 hover:text-purple-700 font-medium">íšŒì›ê°€ì…</a>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <div class="text-center">
                            <p class="text-sm text-gray-600 mb-2">ì„ ìƒë‹˜ì´ì‹ ê°€ìš”?</p>
                            <a href="/teachers/register" class="inline-flex items-center text-sm text-purple-600 hover:text-purple-700 font-medium">
                                <i class="fas fa-chalkboard-teacher mr-2"></i>
                                ì„ ìƒë‹˜ ë“±ë¡í•˜ê¸°
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Google Sign-In SDK -->
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <!-- Kakao SDK -->
        <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js" integrity="sha384-l+xbElFSnPZ2rOaPrU//2FF5B4LB8FiX5q4fXYTlfcG4PGpMkE1vcL7kNXI6Cci0" crossorigin="anonymous"></script>

        <script>
            // API í‚¤ ì„¤ì • (ì„œë²„ì—ì„œ ì£¼ì…)
            const GOOGLE_CLIENT_ID = '${googleClientId}';
            const KAKAO_JS_KEY = '${kakaoJsKey}';
            
            // êµ¬ê¸€ ë¡œê·¸ì¸ ì´ˆê¸°í™”
            function initGoogleSignIn() {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleGoogleCallback
                })
            }

            // êµ¬ê¸€ ë¡œê·¸ì¸ ì½œë°±
            async function handleGoogleCallback(response) {
                try {
                    // JWT í† í° ë””ì½”ë”©
                    const payload = JSON.parse(atob(response.credential.split('.')[1]))
                    
                    const result = await fetch('/api/auth/google', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            idToken: response.credential,
                            email: payload.email,
                            name: payload.name,
                            picture: payload.picture
                        })
                    })

                    const data = await result.json()
                    
                    if (data.success) {
                        // âœ… academy_id ì²´í¬ ë° fallback ì„¤ì •
                        if (!data.user.academy_id) {
                            if (data.user.user_type === 'teacher' && data.user.parent_user_id) {
                                console.warn('âš ï¸ Teacher academy_id missing, using parent_user_id');
                                data.user.academy_id = data.user.parent_user_id;
                            } else {
                                console.warn('âš ï¸ academy_id missing, using user.id as fallback');
                                data.user.academy_id = data.user.id;
                            }
                        }
                        
                        localStorage.setItem('user', JSON.stringify(data.user))
                        localStorage.setItem('loginTime', Date.now().toString())
                        showMessage('success', data.message)
                        setTimeout(() => {
                            window.location.href = data.user.role === 'admin' ? '/admin/dashboard' : '/dashboard'
                        }, 1000)
                    } else if (data.needsRegistration) {
                        // íšŒì›ê°€ì… í•„ìš”
                        sessionStorage.setItem('socialData', JSON.stringify(data.socialData))
                        window.location.href = '/signup?from=google'
                    } else {
                        showMessage('error', data.error || 'êµ¬ê¸€ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
                    }
                } catch (err) {
                    console.error('Google login error:', err)
                    showMessage('error', 'êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
                }
            }

            // êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
            function loginWithGoogle() {
                google.accounts.id.prompt()
            }

            // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì´ˆê¸°í™”
            function initKakaoLogin() {
                if (!Kakao.isInitialized()) {
                    Kakao.init(KAKAO_JS_KEY)
                }
            }

            // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸
            function loginWithKakao() {
                Kakao.Auth.login({
                    success: async function(authObj) {
                        try {
                            // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                            Kakao.API.request({
                                url: '/v2/user/me',
                                success: async function(response) {
                                    const result = await fetch('/api/auth/kakao', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            accessToken: authObj.access_token,
                                            id: response.id,
                                            email: response.kakao_account?.email || '',
                                            nickname: response.properties?.nickname || '',
                                            profile_image: response.properties?.profile_image || ''
                                        })
                                    })

                                    const data = await result.json()
                                    
                                    if (data.success) {
                                        // âœ… academy_id ì²´í¬ ë° fallback ì„¤ì •
                                        if (!data.user.academy_id) {
                                            if (data.user.user_type === 'teacher' && data.user.parent_user_id) {
                                                console.warn('âš ï¸ Teacher academy_id missing, using parent_user_id');
                                                data.user.academy_id = data.user.parent_user_id;
                                            } else {
                                                console.warn('âš ï¸ academy_id missing, using user.id as fallback');
                                                data.user.academy_id = data.user.id;
                                            }
                                        }
                                        
                                        localStorage.setItem('user', JSON.stringify(data.user))
                                        localStorage.setItem('loginTime', Date.now().toString())
                                        showMessage('success', data.message)
                                        setTimeout(() => {
                                            window.location.href = data.user.role === 'admin' ? '/admin/dashboard' : '/dashboard'
                                        }, 1000)
                                    } else if (data.needsRegistration) {
                                        // íšŒì›ê°€ì… í•„ìš”
                                        sessionStorage.setItem('socialData', JSON.stringify(data.socialData))
                                        window.location.href = '/signup?from=kakao'
                                    } else {
                                        showMessage('error', data.error || 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
                                    }
                                },
                                fail: function(error) {
                                    console.error('Kakao API error:', err)
                                    showMessage('error', 'ì¹´ì¹´ì˜¤ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.')
                                }
                            })
                        } catch (err) {
                            console.error('Kakao login error:', err)
                            showMessage('error', 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
                        }
                    },
                    fail: function(err) {
                        console.error('Kakao login failed:', err)
                        showMessage('error', 'ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
                    }
                })
            }

            // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
            function showMessage(type, text) {
                const messageEl = document.getElementById('message')
                messageEl.classList.remove('hidden')
                if (type === 'success') {
                    messageEl.className = 'mt-4 p-4 rounded-xl bg-green-50 text-green-800 border border-green-200'
                } else {
                    messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                }
                messageEl.textContent = text
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
            window.addEventListener('load', () => {
                initGoogleSignIn()
                initKakaoLogin()
            })

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault()
                
                const formData = new FormData(e.target)
                const data = {
                    email: formData.get('email'),
                    password: formData.get('password')
                }

                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    })

                    const result = await response.json()
                    const messageEl = document.getElementById('message')
                    messageEl.classList.remove('hidden')

                    if (result.success) {
                        messageEl.className = 'mt-4 p-4 rounded-xl bg-green-50 text-green-800 border border-green-200'
                        messageEl.textContent = result.message
                        
                        // âœ… academy_id ì™„ë²½í•œ fallback ë¡œì§
                        if (!result.user.academy_id) {
                            console.warn('âš ï¸ [Login] academy_id missing in response');
                            
                            if (result.user.user_type === 'teacher') {
                                // ì„ ìƒë‹˜: parent_user_id ì‚¬ìš©
                                if (result.user.parent_user_id) {
                                    result.user.academy_id = result.user.parent_user_id;
                                    console.log('âœ… [Login] Teacher: Using parent_user_id as academy_id:', result.user.parent_user_id);
                                } else {
                                    console.error('âŒ [Login] Teacher has no parent_user_id!');
                                    alert('ì„ ìƒë‹˜ ê³„ì • ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ì›ì¥ë‹˜ê»˜ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
                                    return;
                                }
                            } else {
                                // ì›ì¥ë‹˜/ê¸°íƒ€: user.id ì‚¬ìš©
                                result.user.academy_id = result.user.id;
                                console.log('âœ… [Login] Director: Using user.id as academy_id:', result.user.id);
                            }
                        } else {
                            console.log('âœ… [Login] academy_id exists:', result.user.academy_id);
                        }
                        
                        localStorage.setItem('user', JSON.stringify(result.user))
                        localStorage.setItem('loginTime', Date.now().toString())
                        
                        // ì—­í• ì— ë”°ë¼ ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸
                        setTimeout(() => {
                            if (result.user.role === 'admin') {
                                window.location.href = '/admin/dashboard'
                            } else {
                                window.location.href = '/dashboard'
                            }
                        }, 1000)
                    } else {
                        messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                        messageEl.textContent = result.error
                    }
                } catch (err) {
                    const messageEl = document.getElementById('message')
                    messageEl.classList.remove('hidden')
                    messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                    messageEl.textContent = 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                }
            })
        </script>
    </body>
    </html>
  `)
})

// í…ŒìŠ¤íŠ¸ ë¼ìš°íŠ¸
app.get('/test-route', (c) => {
  return c.html('<h1>Test Route Works!</h1>')
})

// ì„ ìƒë‹˜ ë“±ë¡ í˜ì´ì§€
app.get('/teachers/register', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì„ ìƒë‹˜ ë“±ë¡ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gradient-to-br from-purple-50 to-blue-50 min-h-screen flex items-center justify-center p-4">
        <div class="max-w-md w-full">
            <!-- ë¡œê³  -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 gradient-purple rounded-2xl mb-4">
                    <i class="fas fa-chalkboard-teacher text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ì„ ìƒë‹˜ ë“±ë¡</h1>
                <p class="text-gray-600">í•™ì› ì¸ì¦ ì½”ë“œë¡œ ì„ ìƒë‹˜ ê³„ì •ì„ ë“±ë¡í•˜ì„¸ìš”</p>
            </div>

            <!-- ë“±ë¡ í¼ -->
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <form id="registerForm" onsubmit="handleRegister(event)">
                    <div class="space-y-4">
                        <!-- í•™ì› ì¸ì¦ ì½”ë“œ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-key text-purple-600 mr-2"></i>í•™ì› ì¸ì¦ ì½”ë“œ *
                            </label>
                            <input 
                                type="text" 
                                name="verificationCode" 
                                required 
                                maxlength="6"
                                placeholder="6ìë¦¬ ì½”ë“œ"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent uppercase"
                            >
                            <p class="text-xs text-gray-500 mt-1">
                                ì›ì¥ë‹˜ìœ¼ë¡œë¶€í„° ë°›ì€ 6ìë¦¬ ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”
                            </p>
                        </div>

                        <!-- í•™ì›ëª… -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-school text-purple-600 mr-2"></i>í•™ì›ëª… *
                            </label>
                            <input 
                                type="text" 
                                name="academyName" 
                                required 
                                placeholder="ì˜ˆ: ê¾¸ë©”ë•…í•™ì› ë¶„ë‹¹ì "
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            >
                            <p class="text-xs text-gray-500 mt-1">
                                ì¸ì¦ ì½”ë“œì™€ ì¼ì¹˜í•˜ëŠ” í•™ì›ëª…ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”
                            </p>
                        </div>

                        <!-- ì´ë¦„ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user text-purple-600 mr-2"></i>ì´ë¦„ *
                            </label>
                            <input 
                                type="text" 
                                name="name" 
                                required 
                                placeholder="í™ê¸¸ë™"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            >
                        </div>

                        <!-- ì´ë©”ì¼ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-envelope text-purple-600 mr-2"></i>ì´ë©”ì¼ *
                            </label>
                            <input 
                                type="email" 
                                name="email" 
                                required 
                                placeholder="teacher@example.com"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            >
                        </div>

                        <!-- ë¹„ë°€ë²ˆí˜¸ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-lock text-purple-600 mr-2"></i>ë¹„ë°€ë²ˆí˜¸ *
                            </label>
                            <input 
                                type="password" 
                                name="password" 
                                required 
                                minlength="6"
                                placeholder="ìµœì†Œ 6ì ì´ìƒ"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            >
                        </div>

                        <!-- ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-lock text-purple-600 mr-2"></i>ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *
                            </label>
                            <input 
                                type="password" 
                                name="confirmPassword" 
                                required 
                                minlength="6"
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            >
                        </div>

                        <!-- ì „í™”ë²ˆí˜¸ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-phone text-purple-600 mr-2"></i>ì „í™”ë²ˆí˜¸
                            </label>
                            <input 
                                type="tel" 
                                name="phone" 
                                placeholder="010-1234-5678"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            >
                        </div>
                    </div>

                    <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
                    <div class="mt-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <p class="text-sm text-purple-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>ë“±ë¡ ì ˆì°¨:</strong> ì‹ ì²­ í›„ ì›ì¥ë‹˜ì˜ ìŠ¹ì¸ì„ ë°›ìœ¼ë©´ ê³„ì •ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <!-- ë²„íŠ¼ -->
                    <button 
                        type="submit" 
                        class="w-full mt-6 gradient-purple text-white py-3 rounded-lg font-medium hover:opacity-90 transition"
                    >
                        <i class="fas fa-user-plus mr-2"></i>ë“±ë¡ ì‹ ì²­
                    </button>
                </form>

                <!-- ë¡œê·¸ì¸ ë§í¬ -->
                <div class="mt-6 text-center">
                    <p class="text-gray-600">
                        ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? 
                        <a href="/login" class="text-purple-600 hover:text-purple-700 font-medium">ë¡œê·¸ì¸</a>
                    </p>
                    <p class="text-gray-600 mt-2">
                        <a href="/" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-home mr-1"></i>í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                        </a>
                    </p>
                </div>
            </div>

            <!-- ë„ì›€ë§ -->
            <div class="mt-8 text-center">
                <p class="text-sm text-gray-600">
                    <i class="fas fa-question-circle mr-2"></i>
                    ì¸ì¦ ì½”ë“œê°€ ì—†ìœ¼ì‹ ê°€ìš”? ì†Œì† í•™ì› ì›ì¥ë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”.
                </p>
            </div>
        </div>

        <script>
            async function handleRegister(event) {
                event.preventDefault();
                
                const form = event.target;
                const formData = {
                    verificationCode: form.verificationCode.value.toUpperCase().trim(),
                    academyName: form.academyName.value.trim(),
                    name: form.name.value.trim(),
                    email: form.email.value.trim(),
                    password: form.password.value,
                    phone: form.phone.value.trim()
                };
                
                // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                if (formData.password !== form.confirmPassword.value) {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }
                
                try {
                    const response = await fetch('/api/teachers/apply', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert(data.message);
                        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                        window.location.href = '/login';
                    } else {
                        alert('ì˜¤ë¥˜: ' + data.error);
                    }
                } catch (error) {
                    console.error('Register error:', error);
                    alert('ë“±ë¡ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        </script>
    </body>
    </html>
  `)
})

// ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ í˜ì´ì§€
app.get('/privacy-policy', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
                <a href="/" class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</a>
                <div class="flex items-center space-x-6">
                    <a href="/" class="text-gray-600 hover:text-purple-600 transition">í™ˆ</a>
                    <a href="/dashboard" class="gradient-purple text-white px-5 py-2.5 rounded-lg hover:shadow-lg transition font-medium">ëŒ€ì‹œë³´ë“œ</a>
                </div>
            </div>
        </nav>

        <!-- Content -->
        <div class="pt-32 pb-24 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-12">
                    <h1 class="text-4xl font-bold text-gray-900 mb-4">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</h1>
                    <p class="text-gray-600">ì‹œí–‰ì¼: 2026ë…„ 1ì›” 23ì¼</p>
                </div>

                <div class="bg-white rounded-2xl border border-gray-200 p-8 md:p-12 shadow-sm">
                    <div class="prose prose-lg max-w-none space-y-8">
                        <section>
                            <p class="text-gray-700 leading-relaxed">
                                ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤(ì´í•˜ "íšŒì‚¬"ë¼ í•©ë‹ˆë‹¤)ëŠ” ì´ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼ ì¤‘ìš”ì‹œí•˜ë©°, ã€Œê°œì¸ì •ë³´ë³´í˜¸ë²•ã€, ã€Œì •ë³´í†µì‹ ë§ ì´ìš©ì´‰ì§„ ë° ì •ë³´ë³´í˜¸ ë“±ì— ê´€í•œ ë²•ë¥ ã€ ë“± ê´€ë ¨ ë²•ë ¹ì„ ì¤€ìˆ˜í•˜ê³  ìˆìŠµë‹ˆë‹¤. íšŒì‚¬ëŠ” ë³¸ ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì„ í†µí•˜ì—¬ ì´ìš©ìê°€ ì œê³µí•˜ëŠ” ê°œì¸ì •ë³´ê°€ ì–´ë– í•œ ìš©ë„ì™€ ë°©ì‹ìœ¼ë¡œ ì´ìš©ë˜ê³  ìˆìœ¼ë©°, ê°œì¸ì •ë³´ë³´í˜¸ë¥¼ ìœ„í•´ ì–´ë– í•œ ì¡°ì¹˜ê°€ ì·¨í•´ì§€ê³  ìˆëŠ”ì§€ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.
                            </p>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">1. ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ í•­ëª© ë° ìˆ˜ì§‘ ë°©ë²•</h2>
                            
                            <h3 class="text-xl font-semibold text-gray-900 mb-3 mt-6">ê°€. ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´ì˜ í•­ëª©</h3>
                            <p class="text-gray-700 mb-3">íšŒì‚¬ëŠ” íšŒì›ê°€ì…, ì›í™œí•œ ê³ ê°ìƒë‹´, ì„œë¹„ìŠ¤ ì œê³µ(AI ë¦¬í¬íŠ¸, ë¬¸ì ë°œì†¡ ë“±)ì„ ìœ„í•´ ì•„ë˜ì™€ ê°™ì€ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                            <ul class="list-disc pl-6 space-y-2 text-gray-700">
                                <li><strong>[í•„ìˆ˜í•­ëª©]</strong> ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸, ì„±ëª…, íœ´ëŒ€ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ ì£¼ì†Œ, í•™ì›ëª…, í•™ì› ì£¼ì†Œ</li>
                                <li><strong>[ìœ ë£Œ ê²°ì œ ì‹œ]</strong> ì¹´ë“œì‚¬ëª…, ì¹´ë“œë²ˆí˜¸(ì¼ë¶€), ì€í–‰ê³„ì¢Œ ì •ë³´, ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</li>
                                <li><strong>[ì„œë¹„ìŠ¤ ì´ìš© ê³¼ì •]</strong> ì„œë¹„ìŠ¤ ì´ìš©ê¸°ë¡, ì ‘ì† ë¡œê·¸, ì¿ í‚¤, ì ‘ì† IP ì •ë³´, ê²°ì œ ê¸°ë¡, ë¶ˆëŸ‰ ì´ìš© ê¸°ë¡</li>
                                <li><strong>[AI ì„œë¹„ìŠ¤ ì´ìš© ì‹œ]</strong> íšŒì›ì´ ì…ë ¥í•˜ëŠ” í•™ìŠµ ë°ì´í„°(í•™ìƒ ì´ë¦„(ì‹ë³„ ë¶ˆê°€ ì²˜ë¦¬ ê¶Œì¥), ì„±ì , í‰ê°€ ë‚´ìš© ë“±)</li>
                            </ul>

                            <h3 class="text-xl font-semibold text-gray-900 mb-3 mt-6">ë‚˜. ìˆ˜ì§‘ë°©ë²•</h3>
                            <p class="text-gray-700">í™ˆí˜ì´ì§€(íšŒì›ê°€ì…, ê²Œì‹œíŒ, ê²°ì œì°½), ì„œë©´ ì–‘ì‹, ì „í™”/íŒ©ìŠ¤, ìƒì„±í˜• AI ì„œë¹„ìŠ¤ ì´ìš© ê³¼ì •</p>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">2. ê°œì¸ì •ë³´ì˜ ì´ìš©ëª©ì </h2>
                            <p class="text-gray-700 mb-3">íšŒì‚¬ëŠ” ìˆ˜ì§‘í•œ ê°œì¸ì •ë³´ë¥¼ ë‹¤ìŒì˜ ëª©ì ì„ ìœ„í•´ í™œìš©í•©ë‹ˆë‹¤.</p>
                            <ul class="list-disc pl-6 space-y-2 text-gray-700">
                                <li><strong>ì„œë¹„ìŠ¤ ì œê³µ ë° ê³„ì•½ ì´í–‰:</strong> AI ê¸°ë°˜ ì½˜í…ì¸ (ë¦¬í¬íŠ¸, ëœë”©í˜ì´ì§€) ìƒì„±, ë¬¸ì ë©”ì‹œì§€(SMS/LMS) ë°œì†¡, ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ, ìš”ê¸ˆ ê²°ì œ ë° ì •ì‚°</li>
                                <li><strong>íšŒì› ê´€ë¦¬:</strong> íšŒì›ì œ ì„œë¹„ìŠ¤ ì´ìš©ì— ë”°ë¥¸ ë³¸ì¸í™•ì¸, ê°œì¸ ì‹ë³„, ë¶ˆëŸ‰ íšŒì›ì˜ ë¶€ì • ì´ìš© ë°©ì§€, ê°€ì… ì˜ì‚¬ í™•ì¸, ë¯¼ì› ì²˜ë¦¬, ê³ ì§€ì‚¬í•­ ì „ë‹¬</li>
                                <li><strong>ë§ˆì¼€íŒ… ë° ê´‘ê³  (ë™ì˜ ì‹œ):</strong> ì‹ ê·œ ì„œë¹„ìŠ¤(Gems) ê°œë°œ ë° ë§ì¶¤ ì„œë¹„ìŠ¤ ì œê³µ, ì´ë²¤íŠ¸ ë° ê´‘ê³ ì„± ì •ë³´ ì œê³µ</li>
                            </ul>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">3. ê°œì¸ì •ë³´ì˜ ì œ3ì ì œê³µ</h2>
                            <p class="text-gray-700 mb-3">íšŒì‚¬ëŠ” ì´ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼ ì›ì¹™ì ìœ¼ë¡œ ì™¸ë¶€ì— ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ì•„ë˜ì˜ ê²½ìš°ì—ëŠ” ì˜ˆì™¸ë¡œ í•©ë‹ˆë‹¤.</p>
                            <ul class="list-disc pl-6 space-y-2 text-gray-700">
                                <li>ì´ìš©ìë“¤ì´ ì‚¬ì „ì— ë™ì˜í•œ ê²½ìš°</li>
                                <li>ë²•ë ¹ì˜ ê·œì •ì— ì˜ê±°í•˜ê±°ë‚˜, ìˆ˜ì‚¬ ëª©ì ìœ¼ë¡œ ë²•ë ¹ì— ì •í•´ì§„ ì ˆì°¨ì™€ ë°©ë²•ì— ë”°ë¼ ìˆ˜ì‚¬ê¸°ê´€ì˜ ìš”êµ¬ê°€ ìˆëŠ” ê²½ìš°</li>
                            </ul>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">4. ê°œì¸ì •ë³´ ì²˜ë¦¬ì˜ ìœ„íƒ â­</h2>
                            <p class="text-gray-700 mb-4">íšŒì‚¬ëŠ” ì„œë¹„ìŠ¤ í–¥ìƒ ë° ì›í™œí•œ ê³„ì•½ ì´í–‰ì„ ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ê°œì¸ì •ë³´ ì²˜ë¦¬ë¥¼ ìœ„íƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full border-collapse border border-gray-300">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-900">ìˆ˜íƒì—…ì²´</th>
                                            <th class="border border-gray-300 px-4 py-3 text-left font-semibold text-gray-900">ìœ„íƒ ì—…ë¬´ ë‚´ìš©</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-300 px-4 py-3 text-gray-700">OpenAI, L.L.C., Google AI (ë¯¸êµ­)</td>
                                            <td class="border border-gray-300 px-4 py-3 text-gray-700">AI ê¸°ë°˜ ë¦¬í¬íŠ¸ ë° ëœë”©í˜ì´ì§€ ìƒì„±ì„ ìœ„í•œ ë°ì´í„° ì²˜ë¦¬</td>
                                        </tr>
                                        <tr class="bg-gray-50">
                                            <td class="border border-gray-300 px-4 py-3 text-gray-700">(ì£¼)ê¸¸ì»´í¼ë‹ˆ ë˜ëŠ” ì•Œë¦¬ê³ </td>
                                            <td class="border border-gray-300 px-4 py-3 text-gray-700">ë¬¸ì ë©”ì‹œì§€(SMS/LMS) ë°œì†¡ ì‹œìŠ¤í…œ ìš´ì˜</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-4 py-3 text-gray-700">Cloudflare / Vercel</td>
                                            <td class="border border-gray-300 px-4 py-3 text-gray-700">ì„œë¹„ìŠ¤ ë°ì´í„° í˜¸ìŠ¤íŒ… ë° ë³´ì•ˆ ì„œë²„ ìš´ì˜</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">5. ê°œì¸ì •ë³´ì˜ ë³´ìœ  ë° ì´ìš©ê¸°ê°„</h2>
                            <p class="text-gray-700 mb-3">íšŒì‚¬ëŠ” ì›ì¹™ì ìœ¼ë¡œ ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ëª©ì ì´ ë‹¬ì„±ëœ í›„ì—ëŠ” í•´ë‹¹ ì •ë³´ë¥¼ ì§€ì²´ ì—†ì´ íŒŒê¸°í•©ë‹ˆë‹¤. ë‹¨, ê´€ê³„ë²•ë ¹ì˜ ê·œì •ì— ì˜í•˜ì—¬ ë³´ì¡´í•  í•„ìš”ê°€ ìˆëŠ” ê²½ìš° ì•„ë˜ì™€ ê°™ì´ ì¼ì • ê¸°ê°„ ë³´ê´€í•©ë‹ˆë‹¤.</p>
                            <ul class="list-disc pl-6 space-y-2 text-gray-700">
                                <li>ê³„ì•½ ë˜ëŠ” ì²­ì•½ì² íšŒ ë“±ì— ê´€í•œ ê¸°ë¡: 5ë…„ (ì „ììƒê±°ë˜ë²•)</li>
                                <li>ëŒ€ê¸ˆê²°ì œ ë° ì¬í™” ë“±ì˜ ê³µê¸‰ì— ê´€í•œ ê¸°ë¡: 5ë…„ (ì „ììƒê±°ë˜ë²•)</li>
                                <li>ì†Œë¹„ìì˜ ë¶ˆë§Œ ë˜ëŠ” ë¶„ìŸì²˜ë¦¬ì— ê´€í•œ ê¸°ë¡: 3ë…„ (ì „ììƒê±°ë˜ë²•)</li>
                                <li>ì›¹ì‚¬ì´íŠ¸ ë°©ë¬¸ ê¸°ë¡(ë¡œê·¸): 3ê°œì›” (í†µì‹ ë¹„ë°€ë³´í˜¸ë²•)</li>
                            </ul>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">6. ê°œì¸ì •ë³´ì˜ íŒŒê¸°ì ˆì°¨ ë° ë°©ë²•</h2>
                            
                            <h3 class="text-xl font-semibold text-gray-900 mb-3 mt-4">ê°€. íŒŒê¸°ì ˆì°¨</h3>
                            <p class="text-gray-700">ì´ìš©ìì˜ ì •ë³´ëŠ” ëª©ì ì´ ë‹¬ì„±ëœ í›„ ë³„ë„ì˜ DBë¡œ ì˜®ê²¨ì ¸(ì¢…ì´ì˜ ê²½ìš° ë³„ë„ì˜ ì„œë¥˜í•¨) ë‚´ë¶€ ë°©ì¹¨ ë° ê¸°íƒ€ ê´€ë ¨ ë²•ë ¹ì— ì˜í•œ ì •ë³´ë³´í˜¸ ì‚¬ìœ ì— ë”°ë¼ ì¼ì • ê¸°ê°„ ì €ì¥ëœ í›„ íŒŒê¸°ë©ë‹ˆë‹¤.</p>

                            <h3 class="text-xl font-semibold text-gray-900 mb-3 mt-4">ë‚˜. íŒŒê¸°ë°©ë²•</h3>
                            <p class="text-gray-700">ì „ìì  íŒŒì¼ í˜•íƒœë¡œ ì €ì¥ëœ ê°œì¸ì •ë³´ëŠ” ê¸°ë¡ì„ ì¬ìƒí•  ìˆ˜ ì—†ëŠ” ê¸°ìˆ ì  ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ ì‚­ì œí•˜ë©°, ì¢…ì´ ë¬¸ì„œëŠ” ë¶„ì‡„í•˜ê±°ë‚˜ ì†Œê°í•˜ì—¬ íŒŒê¸°í•©ë‹ˆë‹¤.</p>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">7. ì´ìš©ì ë° ë²•ì •ëŒ€ë¦¬ì¸ì˜ ê¶Œë¦¬ì™€ ê·¸ í–‰ì‚¬ë°©ë²•</h2>
                            <p class="text-gray-700">ì´ìš©ìëŠ” ì–¸ì œë“ ì§€ ë“±ë¡ë˜ì–´ ìˆëŠ” ìì‹ ì˜ ê°œì¸ì •ë³´ë¥¼ ì¡°íšŒí•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìœ¼ë©° ê°€ì… í•´ì§€ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°œì¸ì •ë³´ ì¡°íšŒ/ìˆ˜ì •ì„ ìœ„í•´ì„œëŠ” 'ê°œì¸ì •ë³´ë³€ê²½'(ë˜ëŠ” 'íšŒì›ì •ë³´ìˆ˜ì •')ì„, ê°€ì… í•´ì§€ë¥¼ ìœ„í•´ì„œëŠ” 'íšŒì›íƒˆí‡´'ë¥¼ í´ë¦­í•˜ì—¬ ë³¸ì¸ í™•ì¸ ì ˆì°¨ë¥¼ ê±°ì¹œ í›„ ì§ì ‘ ì—´ëŒ, ì •ì • ë˜ëŠ” íƒˆí‡´ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">8. ê°œì¸ì •ë³´ ìë™ ìˆ˜ì§‘ ì¥ì¹˜ì˜ ì„¤ì¹˜/ìš´ì˜ ë° ê±°ë¶€ì— ê´€í•œ ì‚¬í•­</h2>
                            <p class="text-gray-700">íšŒì‚¬ëŠ” ì´ìš©ìì—ê²Œ íŠ¹í™”ëœ ë§ì¶¤ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ì„œ ì´ìš©ìë“¤ì˜ ì •ë³´ë¥¼ ìˆ˜ì‹œë¡œ ì €ì¥í•˜ê³  ì°¾ì•„ë‚´ëŠ” 'ì¿ í‚¤(cookie)' ë“±ì„ ìš´ìš©í•©ë‹ˆë‹¤. ì´ìš©ìëŠ” ì¿ í‚¤ ì„¤ì¹˜ì— ëŒ€í•œ ì„ íƒê¶Œì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ì›¹ë¸Œë¼ìš°ì € ì„¤ì •ì„ í†µí•´ ì¿ í‚¤ ì €ì¥ì„ ê±°ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¨, ì¿ í‚¤ ì €ì¥ì„ ê±°ë¶€í•  ê²½ìš° ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì¼ë¶€ ì„œë¹„ìŠ¤ ì´ìš©ì— ì–´ë ¤ì›€ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">9. ê°œì¸ì •ë³´ì˜ ê¸°ìˆ ì /ê´€ë¦¬ì  ë³´í˜¸ ëŒ€ì±…</h2>
                            <p class="text-gray-700 mb-3">íšŒì‚¬ëŠ” ì´ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬í•¨ì— ìˆì–´ ë¶„ì‹¤, ë„ë‚œ, ìœ ì¶œ, ë³€ì¡° ë˜ëŠ” í›¼ì†ë˜ì§€ ì•Šë„ë¡ ë‹¤ìŒê³¼ ê°™ì€ ëŒ€ì±…ì„ ê°•êµ¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                            <ul class="list-disc pl-6 space-y-2 text-gray-700">
                                <li><strong>ì•”í˜¸í™”:</strong> ë¹„ë°€ë²ˆí˜¸ì™€ ì¤‘ìš” ë°ì´í„°ëŠ” ì•”í˜¸í™”ë˜ì–´ ì €ì¥ ë° ê´€ë¦¬ë©ë‹ˆë‹¤.</li>
                                <li><strong>í•´í‚¹ ëŒ€ë¹„:</strong> í•´í‚¹ì´ë‚˜ ì»´í“¨í„° ë°”ì´ëŸ¬ìŠ¤ ë“±ì— ì˜í•œ í”¼í•´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ë³´ì•ˆ í”„ë¡œê·¸ë¨ì„ ì„¤ì¹˜í•˜ê³  ì£¼ê¸°ì ì¸ ê°±ì‹ Â·ì ê²€ì„ í•˜ë©°, ì™¸ë¶€ë¡œë¶€í„° ì ‘ê·¼ì´ í†µì œëœ êµ¬ì—­ì— ì‹œìŠ¤í…œì„ ì„¤ì¹˜í•˜ê³  ê¸°ìˆ ì /ë¬¼ë¦¬ì ìœ¼ë¡œ ê°ì‹œ ë° ì°¨ë‹¨í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
                                <li><strong>ì·¨ê¸‰ ì§ì›ì˜ ìµœì†Œí™”:</strong> ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì§ì›ì„ ìµœì†Œí•œìœ¼ë¡œ ì§€ì •í•˜ê³  ë‹´ë‹¹ìì— ëŒ€í•œ ìˆ˜ì‹œ êµìœ¡ì„ í†µí•´ ë³¸ ì •ì±…ì˜ ì¤€ìˆ˜ë¥¼ ê°•ì¡°í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
                            </ul>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">10. ê°œì¸ì •ë³´ë³´í˜¸ì±…ì„ì ë° ì—°ë½ì²˜</h2>
                            <p class="text-gray-700 mb-3">íšŒì‚¬ëŠ” íšŒì›ì˜ ê°œì¸ì •ë³´ë¥¼ ë³´í˜¸í•˜ê³  ê°œì¸ì •ë³´ì™€ ê´€ë ¨í•œ ë¶ˆë§Œì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ ê´€ë ¨ ë¶€ì„œ ë° ê°œì¸ì •ë³´ë³´í˜¸ì±…ì„ìë¥¼ ì§€ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-6">
                                <p class="font-semibold text-gray-900 mb-2">ê°œì¸ì •ë³´ë³´í˜¸ì±…ì„ì(CPO): ê³ í¬ì¤€ (ëŒ€í‘œ)</p>
                                <p class="text-gray-700">ì—°ë½ì²˜: 010-8739-9697</p>
                                <p class="text-gray-700">ì´ë©”ì¼: wangholy1@naver.com</p>
                            </div>

                            <p class="text-gray-700 mt-4 mb-2">ê¸°íƒ€ ê°œì¸ì •ë³´ì¹¨í•´ì— ëŒ€í•œ ì‹ ê³ ë‚˜ ìƒë‹´ì´ í•„ìš”í•˜ì‹  ê²½ìš°ì—ëŠ” ì•„ë˜ ê¸°ê´€ì— ë¬¸ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                            <ul class="list-disc pl-6 space-y-1 text-gray-700">
                                <li>ê°œì¸ì •ë³´ì¹¨í•´ì‹ ê³ ì„¼í„° (privacy.kisa.or.kr / 118)</li>
                                <li>ëŒ€ê²€ì°°ì²­ ì‚¬ì´ë²„ìˆ˜ì‚¬ê³¼ (www.spo.go.kr / 1301)</li>
                                <li>ê²½ì°°ì²­ ì‚¬ì´ë²„ìˆ˜ì‚¬êµ­ (ecrm.police.go.kr / 182)</li>
                            </ul>
                        </section>

                        <section>
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">11. ê³ ì§€ì˜ ì˜ë¬´</h2>
                            <p class="text-gray-700">ì´ ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì€ 2026ë…„ 1ì›” 23ì¼ë¶€í„° ì ìš©ë©ë‹ˆë‹¤. ë‚´ìš©ì˜ ì¶”ê°€, ì‚­ì œ ë° ìˆ˜ì •ì´ ìˆì„ ì‹œì—ëŠ” ê°œì • ìµœì†Œ 7ì¼ ì „ë¶€í„° í™ˆí˜ì´ì§€ì˜ 'ê³µì§€ì‚¬í•­'ì„ í†µí•´ ê³ ì§€í•  ê²ƒì…ë‹ˆë‹¤.</p>
                        </section>
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <a href="/" class="inline-flex items-center gap-2 text-purple-600 hover:text-purple-700 font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        <span>í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-gray-900 text-gray-300 py-12">
            <div class="max-w-7xl mx-auto px-6">
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h3 class="text-white font-bold text-lg mb-4">ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</h3>
                        <div class="space-y-2 text-sm">
                            <p>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 142-88-02445</p>
                            <p>ì£¼ì†Œ: ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬ ì²­ë¼ì»¤ë‚¼ë¡œ 270, 2ì¸µ</p>
                            <p>ì´ë©”ì¼: wangholy1@naver.com | ì „í™”: 010-8739-9697</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-lg mb-4">ë²•ì  ê³ ì§€</h3>
                        <div class="space-y-2 text-sm">
                            <a href="/privacy-policy" class="block hover:text-white transition">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
                            <a href="/signup" class="block hover:text-white transition">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</a>
                        </div>
                    </div>
                </div>
                <div class="border-t border-gray-700 pt-6 text-center text-sm">
                    <p>Â© 2024 ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </body>
    </html>
  `)
})

// ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ ì‡¼í•‘ëª° í˜ì´ì§€
app.get('/consulting', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>êµìœ¡ ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet">
        <style>
          * { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-50">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-blue-600">SUPER PLACE</a>
                    <div class="flex gap-6 items-center">
                        <a href="/dashboard" class="text-gray-600 hover:text-blue-600">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="/consulting" class="text-blue-600 font-semibold">êµìœ¡ í”„ë¡œê·¸ë¨</a>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Hero Section -->
        <section class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">í•™ì› ì „ë¬¸ ë§ˆì¼€íŒ… ì»¨ì„¤íŒ…</h1>
                <p class="text-xl md:text-2xl text-blue-100 mb-8">ì‹¤ì œ í¬ìŠ¤íŒ…ì˜ ì§‘ì¤‘ ì»¨ì„¤íŒ… ì‹œì‘í•˜ì‹¤ ë§ˆì¼€íŒ…!</p>
                <p class="text-lg text-blue-200">ë§ì¶¤í˜• 1:1 ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨</p>
            </div>
        </section>

        <!-- Products Grid -->
        <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
            <div id="productsGrid" class="grid md:grid-cols-2 gap-8">
                <!-- í”„ë¡œê·¸ë¨ ì¹´ë“œê°€ ì—¬ê¸° ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-gray-900 text-white py-12 mt-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid md:grid-cols-3 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4">ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</h3>
                        <p class="text-gray-400 text-sm">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 142-88-02445</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">ì£¼ì†Œ</h4>
                        <p class="text-gray-400 text-sm">ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬ ì²­ë¼ì»¤ë‚¼ë¡œ 270, 2ì¸µ</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">ë¬¸ì˜</h4>
                        <p class="text-gray-400 text-sm">ì´ë©”ì¼: wangholy1@naver.com</p>
                        <p class="text-gray-400 text-sm">ì „í™”: 010-8739-9697</p>
                    </div>
                </div>
                <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-500 text-sm">
                    Â© 2024 ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤. All rights reserved.
                </div>
            </div>
        </footer>

        <script>
          // í•˜ë“œì½”ë”©ëœ í”„ë¡œê·¸ë¨ ë°ì´í„°
          const programs = [
            {
              program_id: 'naver-place-consulting',
              name: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œ ì»¨ì„¤íŒ…',
              description: 'ì‹¤ì œ í¬ìŠ¤íŒ…ì˜ ì§‘ì¤‘ ì»¨ì„¤íŒ… ì‹œì‘í•˜ì‹¤ ë§ˆì¼€íŒ…!',
              image_url: '/static/images/naver-place-consulting.jpg',
              price: 1210000,
              sessions: 6,
              details: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œì„ ìœ„í•œ 1:1 ë§ì¶¤ ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. 6íšŒì— ê±¸ì³ í”Œë ˆì´ìŠ¤ ë“±ë¡ë¶€í„° ìƒìœ„ë…¸ì¶œ ì „ëµ, ë¦¬ë·° ê´€ë¦¬, í‚¤ì›Œë“œ ìµœì í™”ê¹Œì§€ ì‹¤ì „ ë…¸í•˜ìš°ë¥¼ ì „ìˆ˜ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
              features: ["í”Œë ˆì´ìŠ¤ ìµœì í™” ì „ëµ", "ë¦¬ë·° ê´€ë¦¬ ë…¸í•˜ìš°", "í‚¤ì›Œë“œ ë¶„ì„ ë° íƒ€ê²ŸíŒ…", "ê²½ìŸì‚¬ ë¶„ì„", "ìƒìœ„ë…¸ì¶œ ì‹¤ì „ ê¸°ë²•", "1:1 ë§ì¶¤ ì»¨ì„¤íŒ…"],
              type: 'consulting'
            },
            {
              program_id: 'blog-consulting',
              name: 'ë¸”ë¡œê·¸ 1:1 ì»¨ì„¤íŒ…',
              description: 'ì‹¤ì œ í¬ìŠ¤íŒ…ì˜ ì§‘ì¤‘ ì»¨ì„¤íŒ… ì‹œì‘í•˜ì‹¤ ë§ˆì¼€íŒ…!',
              image_url: '/static/images/blog-consulting.jpg',
              price: 1210000,
              sessions: 6,
              details: 'ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œì„ ìœ„í•œ 1:1 ë§ì¶¤ ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. 6íšŒì— ê±¸ì³ SEO ìµœì í™”, ì½˜í…ì¸  ì‘ì„±ë²•, í‚¤ì›Œë“œ ì „ëµ, ìœ ì… ì¦ëŒ€ ë°©ë²•ê¹Œì§€ ë¸”ë¡œê·¸ ë§ˆì¼€íŒ…ì˜ ëª¨ë“  ê²ƒì„ ë°°ìš°ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
              features: ["SEO ìµœì í™” ì „ëµ", "ì½˜í…ì¸  ê¸°íš ë° ì‘ì„±ë²•", "í‚¤ì›Œë“œ ë¦¬ì„œì¹˜", "ê²€ìƒ‰ ìƒìœ„ë…¸ì¶œ ê¸°ë²•", "ìœ ì… ë¶„ì„ ë° ê°œì„ ", "1:1 ë§ì¶¤ ì»¨ì„¤íŒ…"],
              type: 'consulting'
            },
            {
              program_id: 'landing-page-max',
              name: '(Max) ëœë”©í˜ì´ì§€ ì œì‘',
              description: 'ì „ë¬¸ê°€ê°€ ë§Œë“œëŠ” ê³ í€„ë¦¬í‹° ëœë”©í˜ì´ì§€',
              image_url: '/landing-page-service.jpg',
              price: null,
              sessions: null,
              details: 'í•™ì› ì „ë¬¸ ë§ˆì¼€íŒ… ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ì œì‘í•˜ëŠ” í”„ë¦¬ë¯¸ì—„ ëœë”©í˜ì´ì§€ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ë°˜ì‘í˜• ë””ìì¸, SEO ìµœì í™”, ê³ ê° ì „í™˜ìœ¨ì„ ê·¹ëŒ€í™”í•œ í˜ì´ì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.',
              features: ["ë°˜ì‘í˜• ì›¹ ë””ìì¸", "SEO ìµœì í™” ì ìš©", "ê³ ê° ì „í™˜ìœ¨ ê·¹ëŒ€í™”", "ë¹ ë¥¸ ë¡œë”© ì†ë„", "ëª¨ë°”ì¼ ìµœì í™”", "ê´€ë¦¬ì í˜ì´ì§€ ì œê³µ", "ë¬´ì œí•œ ìˆ˜ì • ì§€ì›", "í˜¸ìŠ¤íŒ… 1ë…„ ë¬´ë£Œ"],
              type: 'inquiry'
            },
            {
              program_id: 'marketing-agency',
              name: 'í•™ì› ë§ˆì¼€íŒ… ëŒ€í–‰',
              description: 'í•™ì› ì „ë¬¸ ë§ˆì¼€íŒ… ëŒ€í–‰ ì„œë¹„ìŠ¤',
              image_url: '/marketing-agency.jpg',
              price: null,
              sessions: null,
              details: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤, ë¸”ë¡œê·¸, SNS ë“± ë‹¤ì–‘í•œ ì±„ë„ì„ í†µí•œ ì¢…í•© ë§ˆì¼€íŒ… ëŒ€í–‰ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. í•™ì›ì— ìµœì í™”ëœ ë§ˆì¼€íŒ… ì „ëµìœ¼ë¡œ í•™ìƒ ëª¨ì§‘ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.',
              features: ["ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ê´€ë¦¬", "ë¸”ë¡œê·¸ ì½˜í…ì¸  ì‘ì„±", "SNS ë§ˆì¼€íŒ… ëŒ€í–‰", "í‚¤ì›Œë“œ ê´‘ê³  ìš´ì˜", "ì›”ê°„ ë¦¬í¬íŠ¸ ì œê³µ", "ì‹¤ì‹œê°„ ìƒë‹´ ì§€ì›", "ê²½ìŸì‚¬ ë¶„ì„ ë¦¬í¬íŠ¸", "ë§ì¶¤í˜• ë§ˆì¼€íŒ… ì „ëµ"],
              type: 'inquiry'
            }
          ];

          function loadPrograms() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = programs.map(program => {
              const features = program.features;
                return \`
                  <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition duration-300">
                    <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                      <img src="\${program.image_url}" alt="\${program.name}" class="w-full h-64 object-cover">
                    </div>
                    <div class="p-8">
                      <h2 class="text-2xl font-bold text-gray-900 mb-3">\${program.name}</h2>
                      <p class="text-gray-600 mb-4">\${program.description}</p>
                      <div class="mb-6">
                        <p class="text-sm text-gray-700 mb-3 leading-relaxed">\${program.details}</p>
                        <div class="space-y-2">
                          \${features.map(f => \`
                            <div class="flex items-center text-sm text-gray-600">
                              <i class="fas fa-check-circle text-green-500 mr-2"></i>
                              <span>\${f}</span>
                            </div>
                          \`).join('')}
                        </div>
                      </div>
                      <div class="flex items-center justify-between border-t pt-6">
                        <div>
                          \${program.type === 'consulting' ? \`
                            <p class="text-sm text-gray-500">ì´ \${program.sessions}íšŒ ì»¨ì„¤íŒ…</p>
                            <p class="text-3xl font-bold text-blue-600">\${(program.price / 10000).toFixed(0)}ë§Œì›</p>
                          \` : \`
                            <p class="text-sm text-gray-500">ë§ì¶¤í˜• ì„œë¹„ìŠ¤</p>
                            <p class="text-3xl font-bold text-blue-600">ê°€ê²© ë¬¸ì˜</p>
                          \`}
                        </div>
                        <a href="/consulting/\${program.program_id}" 
                           class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 transition">
                          \${program.type === 'consulting' ? 'ìˆ˜ê°•í•˜ê¸°' : 'ë¬¸ì˜í•˜ê¸°'}
                        </a>
                      </div>
                    </div>
                  </div>
                \`;
              }).join('');
          }

          loadPrograms();
        </script>
    </body>
    </html>
  `);
});

// ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ ìƒì„¸ í˜ì´ì§€
app.get('/consulting/:programId', async (c) => {
  const programId = c.req.param('programId');
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ ìƒì„¸ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet">
        <style>
          * { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-50">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-blue-600">SUPER PLACE</a>
                    <div class="flex gap-6 items-center">
                        <a href="/consulting" class="text-gray-600 hover:text-blue-600">â† ëª©ë¡ìœ¼ë¡œ</a>
                        <a href="/dashboard" class="text-gray-600 hover:text-blue-600">ëŒ€ì‹œë³´ë“œ</a>
                    </div>
                </div>
            </nav>
        </header>

        <main class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
            <div id="programDetail" class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <!-- í”„ë¡œê·¸ë¨ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </main>

        <script>
          const programId = '${programId}';
          
          // í•˜ë“œì½”ë”©ëœ í”„ë¡œê·¸ë¨ ë°ì´í„°
          const programs = {
            'naver-place-consulting': {
              program_id: 'naver-place-consulting',
              name: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œ ì»¨ì„¤íŒ…',
              description: 'ì‹¤ì œ í¬ìŠ¤íŒ…ì˜ ì§‘ì¤‘ ì»¨ì„¤íŒ… ì‹œì‘í•˜ì‹¤ ë§ˆì¼€íŒ…!',
              image_url: '/static/images/naver-place-consulting.jpg',
              price: 1210000,
              sessions: 6,
              details: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œì„ ìœ„í•œ 1:1 ë§ì¶¤ ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. 6íšŒì— ê±¸ì³ í”Œë ˆì´ìŠ¤ ë“±ë¡ë¶€í„° ìƒìœ„ë…¸ì¶œ ì „ëµ, ë¦¬ë·° ê´€ë¦¬, í‚¤ì›Œë“œ ìµœì í™”ê¹Œì§€ ì‹¤ì „ ë…¸í•˜ìš°ë¥¼ ì „ìˆ˜ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
              features: ["í”Œë ˆì´ìŠ¤ ìµœì í™” ì „ëµ", "ë¦¬ë·° ê´€ë¦¬ ë…¸í•˜ìš°", "í‚¤ì›Œë“œ ë¶„ì„ ë° íƒ€ê²ŸíŒ…", "ê²½ìŸì‚¬ ë¶„ì„", "ìƒìœ„ë…¸ì¶œ ì‹¤ì „ ê¸°ë²•", "1:1 ë§ì¶¤ ì»¨ì„¤íŒ…"],
              type: 'consulting'
            },
            'blog-consulting': {
              program_id: 'blog-consulting',
              name: 'ë¸”ë¡œê·¸ 1:1 ì»¨ì„¤íŒ…',
              description: 'ì‹¤ì œ í¬ìŠ¤íŒ…ì˜ ì§‘ì¤‘ ì»¨ì„¤íŒ… ì‹œì‘í•˜ì‹¤ ë§ˆì¼€íŒ…!',
              image_url: '/static/images/blog-consulting.jpg',
              price: 1210000,
              sessions: 6,
              details: 'ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œì„ ìœ„í•œ 1:1 ë§ì¶¤ ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. 6íšŒì— ê±¸ì³ SEO ìµœì í™”, ì½˜í…ì¸  ì‘ì„±ë²•, í‚¤ì›Œë“œ ì „ëµ, ìœ ì… ì¦ëŒ€ ë°©ë²•ê¹Œì§€ ë¸”ë¡œê·¸ ë§ˆì¼€íŒ…ì˜ ëª¨ë“  ê²ƒì„ ë°°ìš°ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
              features: ["SEO ìµœì í™” ì „ëµ", "ì½˜í…ì¸  ê¸°íš ë° ì‘ì„±ë²•", "í‚¤ì›Œë“œ ë¦¬ì„œì¹˜", "ê²€ìƒ‰ ìƒìœ„ë…¸ì¶œ ê¸°ë²•", "ìœ ì… ë¶„ì„ ë° ê°œì„ ", "1:1 ë§ì¶¤ ì»¨ì„¤íŒ…"],
              type: 'consulting'
            },
            'landing-page-max': {
              program_id: 'landing-page-max',
              name: '(Max) ëœë”©í˜ì´ì§€ ì œì‘',
              description: 'ì „ë¬¸ê°€ê°€ ë§Œë“œëŠ” ê³ í€„ë¦¬í‹° ëœë”©í˜ì´ì§€',
              image_url: '/landing-page-service.jpg',
              price: null,
              sessions: null,
              details: 'í•™ì› ì „ë¬¸ ë§ˆì¼€íŒ… ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ì œì‘í•˜ëŠ” í”„ë¦¬ë¯¸ì—„ ëœë”©í˜ì´ì§€ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ë°˜ì‘í˜• ë””ìì¸, SEO ìµœì í™”, ê³ ê° ì „í™˜ìœ¨ì„ ê·¹ëŒ€í™”í•œ í˜ì´ì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.',
              features: ["ë°˜ì‘í˜• ì›¹ ë””ìì¸", "SEO ìµœì í™” ì ìš©", "ê³ ê° ì „í™˜ìœ¨ ê·¹ëŒ€í™”", "ë¹ ë¥¸ ë¡œë”© ì†ë„", "ëª¨ë°”ì¼ ìµœì í™”", "ê´€ë¦¬ì í˜ì´ì§€ ì œê³µ", "ë¬´ì œí•œ ìˆ˜ì • ì§€ì›", "í˜¸ìŠ¤íŒ… 1ë…„ ë¬´ë£Œ"],
              type: 'inquiry'
            },
            'marketing-agency': {
              program_id: 'marketing-agency',
              name: 'í•™ì› ë§ˆì¼€íŒ… ëŒ€í–‰',
              description: 'í•™ì› ì „ë¬¸ ë§ˆì¼€íŒ… ëŒ€í–‰ ì„œë¹„ìŠ¤',
              image_url: '/marketing-agency.jpg',
              price: null,
              sessions: null,
              details: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤, ë¸”ë¡œê·¸, SNS ë“± ë‹¤ì–‘í•œ ì±„ë„ì„ í†µí•œ ì¢…í•© ë§ˆì¼€íŒ… ëŒ€í–‰ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. í•™ì›ì— ìµœì í™”ëœ ë§ˆì¼€íŒ… ì „ëµìœ¼ë¡œ í•™ìƒ ëª¨ì§‘ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.',
              features: ["ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ê´€ë¦¬", "ë¸”ë¡œê·¸ ì½˜í…ì¸  ì‘ì„±", "SNS ë§ˆì¼€íŒ… ëŒ€í–‰", "í‚¤ì›Œë“œ ê´‘ê³  ìš´ì˜", "ì›”ê°„ ë¦¬í¬íŠ¸ ì œê³µ", "ì‹¤ì‹œê°„ ìƒë‹´ ì§€ì›", "ê²½ìŸì‚¬ ë¶„ì„ ë¦¬í¬íŠ¸", "ë§ì¶¤í˜• ë§ˆì¼€íŒ… ì „ëµ"],
              type: 'inquiry'
            }
          };
              sessions: 6,
              details: 'ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œì„ ìœ„í•œ 1:1 ë§ì¶¤ ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. 6íšŒì— ê±¸ì³ SEO ìµœì í™”, ì½˜í…ì¸  ì‘ì„±ë²•, í‚¤ì›Œë“œ ì „ëµ, ìœ ì… ì¦ëŒ€ ë°©ë²•ê¹Œì§€ ë¸”ë¡œê·¸ ë§ˆì¼€íŒ…ì˜ ëª¨ë“  ê²ƒì„ ë°°ìš°ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
              features: ["SEO ìµœì í™” ì „ëµ", "ì½˜í…ì¸  ê¸°íš ë° ì‘ì„±ë²•", "í‚¤ì›Œë“œ ë¦¬ì„œì¹˜", "ê²€ìƒ‰ ìƒìœ„ë…¸ì¶œ ê¸°ë²•", "ìœ ì… ë¶„ì„ ë° ê°œì„ ", "1:1 ë§ì¶¤ ì»¨ì„¤íŒ…"]
            }
          };
          
          function loadProgramDetail() {
            try {
              const program = programs[programId];
              
              if (!program) {
                alert('í”„ë¡œê·¸ë¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = '/consulting';
                return;
              }

              const features = program.features;
              
              let infoCardsHTML = '';
              if (program.type === 'consulting') {
                infoCardsHTML = '<div class="text-center">' +
                  '<i class="fas fa-calendar-alt text-3xl text-blue-600 mb-2"></i>' +
                  '<p class="text-sm text-gray-500">ì»¨ì„¤íŒ… íšŸìˆ˜</p>' +
                  '<p class="text-2xl font-bold text-gray-900">' + program.sessions + 'íšŒ</p>' +
                  '</div>' +
                  '<div class="text-center">' +
                  '<i class="fas fa-won-sign text-3xl text-blue-600 mb-2"></i>' +
                  '<p class="text-sm text-gray-500">ìˆ˜ê°•ë£Œ</p>' +
                  '<p class="text-2xl font-bold text-blue-600">' + (program.price / 10000).toFixed(0) + 'ë§Œì›</p>' +
                  '</div>' +
                  '<div class="text-center">' +
                  '<i class="fas fa-user-tie text-3xl text-blue-600 mb-2"></i>' +
                  '<p class="text-sm text-gray-500">ì»¨ì„¤íŒ… ë°©ì‹</p>' +
                  '<p class="text-2xl font-bold text-gray-900">1:1 ë§ì¶¤</p>' +
                  '</div>';
              } else {
                infoCardsHTML = '<div class="text-center">' +
                  '<i class="fas fa-rocket text-3xl text-blue-600 mb-2"></i>' +
                  '<p class="text-sm text-gray-500">ì œê³µ ë°©ì‹</p>' +
                  '<p class="text-2xl font-bold text-gray-900">ë§ì¶¤í˜•</p>' +
                  '</div>' +
                  '<div class="text-center">' +
                  '<i class="fas fa-won-sign text-3xl text-blue-600 mb-2"></i>' +
                  '<p class="text-sm text-gray-500">ê°€ê²©</p>' +
                  '<p class="text-2xl font-bold text-blue-600">ë¬¸ì˜</p>' +
                  '</div>' +
                  '<div class="text-center">' +
                  '<i class="fas fa-headset text-3xl text-blue-600 mb-2"></i>' +
                  '<p class="text-sm text-gray-500">ìƒë‹´</p>' +
                  '<p class="text-2xl font-bold text-gray-900">24ì‹œê°„</p>' +
                  '</div>';
              }
              
              document.getElementById('programDetail').innerHTML = \`
                <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                  <img src="\${program.image_url}" alt="\${program.name}" class="w-full h-96 object-cover">
                </div>
                <div class="p-8 md:p-12">
                  <h1 class="text-4xl font-bold text-gray-900 mb-4">\${program.name}</h1>
                  <p class="text-xl text-gray-600 mb-8">\${program.description}</p>
                  
                  <div class="bg-blue-50 rounded-xl p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">\${program.type === 'consulting' ? 'í”„ë¡œê·¸ë¨ ì •ë³´' : 'ì„œë¹„ìŠ¤ ì •ë³´'}</h2>
                    <div class="grid md:grid-cols-3 gap-6">
                      \${infoCardsHTML}
                    </div>
                  </div>

                  <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">\${program.type === 'consulting' ? 'ì»¤ë¦¬í˜ëŸ¼' : 'ì œê³µ ì„œë¹„ìŠ¤'}</h2>
                    <p class="text-gray-700 leading-relaxed mb-6">\${program.details}</p>
                    <div class="grid md:grid-cols-2 gap-4">
                      \${features.map((feature, index) => \`
                        <div class="flex items-start p-4 bg-gray-50 rounded-lg">
                          <div class="flex-shrink-0 w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold mr-3">
                            \${index + 1}
                          </div>
                          <p class="text-gray-700">\${feature}</p>
                        </div>
                      \`).join('')}
                    </div>
                  </div>

                  <div class="border-t pt-8">
                    <button onclick="openApplicationForm()" 
                            class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-xl font-bold rounded-xl hover:from-blue-700 hover:to-indigo-700 transition">
                      \${program.type === 'consulting' ? 'ì§€ê¸ˆ ìˆ˜ê°• ì‹ ì²­í•˜ê¸°' : 'ì§€ê¸ˆ ë¬¸ì˜í•˜ê¸°'}
                    </button>
                  </div>
                </div>
              \`;
            } catch (err) {
              console.error('í”„ë¡œê·¸ë¨ ìƒì„¸ ë¡œë“œ ì˜¤ë¥˜:', err);
              alert('í”„ë¡œê·¸ë¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          }

          function openApplicationForm() {
            window.location.href = \`/consulting/\${programId}/apply\`;
          }

          loadProgramDetail();
        </script>
    </body>
    </html>
  `);
});

// ì»¨ì„¤íŒ… ìˆ˜ê°• ì‹ ì²­ í˜ì´ì§€
app.get('/consulting/:programId/apply', async (c) => {
  const programId = c.req.param('programId');
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ìˆ˜ê°• ì‹ ì²­ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet">
        <style>
          * { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-50">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-blue-600">SUPER PLACE</a>
                    <a href="/consulting/\${programId}" class="text-gray-600 hover:text-blue-600">â† ë’¤ë¡œê°€ê¸°</a>
                </div>
            </nav>
        </header>

        <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
            <div class="bg-white rounded-2xl shadow-lg p-8 md:p-12 application-form-container">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ìˆ˜ê°• ì‹ ì²­</h1>
                <p id="programName" class="text-lg text-gray-600 mb-8"></p>
                
                <form id="applicationForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ì‹ ì²­ì ì´ë¦„ *</label>
                        <input type="text" id="name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë©”ì¼ *</label>
                        <input type="email" id="email" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ì—°ë½ì²˜ *</label>
                        <input type="tel" id="phone" required placeholder="010-0000-0000"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">í•™ì›ëª…</label>
                        <input type="text" id="academy_name" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ë¬¸ì˜ì‚¬í•­</label>
                        <textarea id="message" rows="4" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-700">
                          <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                          ì‹ ì²­í•˜ì‹œë©´ ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
                        </p>
                    </div>

                    <button type="submit" 
                            class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-lg font-bold rounded-xl hover:from-blue-700 hover:to-indigo-700 transition">
                      ì‹ ì²­í•˜ê¸°
                    </button>
                </form>
            </div>
        </main>

        <script>
          const programId = '${programId}';
          
          // í•˜ë“œì½”ë”©ëœ í”„ë¡œê·¸ë¨ ë°ì´í„°
          const programs = {
            'landing-page-max': {
              name: '(Max) ëœë”©í˜ì´ì§€ ì œì‘',
              type: 'inquiry'
            },
            'marketing-agency': {
              name: 'í•™ì› ë§ˆì¼€íŒ… ëŒ€í–‰',
              type: 'inquiry'
            },
            'naver-place-consulting': {
              name: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œ ì»¨ì„¤íŒ…',
              type: 'consulting'
            },
            'blog-consulting': {
              name: 'ë¸”ë¡œê·¸ 1:1 ì»¨ì„¤íŒ…',
              type: 'consulting'
            }
          };

          const program = programs[programId];
          if (program) {
            document.getElementById('programName').textContent = program.name;
            
            // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            // ë¡œê·¸ì¸ ì²´í¬
            if (!user.id) {
              document.querySelector('.application-form-container').innerHTML = \`
                <div class="text-center py-16">
                  <i class="fas fa-lock text-6xl text-gray-400 mb-4"></i>
                  <h2 class="text-2xl font-bold text-gray-900 mb-4">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
                  <p class="text-gray-600 mb-8">ì„œë¹„ìŠ¤ ì‹ ì²­ì„ í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
                  <a href="/login" class="inline-block px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 transition">
                    ë¡œê·¸ì¸í•˜ê¸°
                  </a>
                </div>
              \`;
              return;
            }
            
            // ëœë”©í˜ì´ì§€ ì œì‘ì˜ ê²½ìš° ìƒì„¸ í¼ í‘œì‹œ
            if (programId === 'landing-page-max') {
              document.querySelector('.application-form-container').innerHTML = \`
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ëœë”©í˜ì´ì§€ ì œì‘ ì‹ ì²­</h1>
                <p class="text-lg text-gray-600 mb-8">\${program.name}</p>
                
                <form id="landingPageForm" class="space-y-8">
                  <!-- ê¸°ë³¸ ì •ë³´ -->
                  <div class="border-b pb-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">ì‹ ì²­ì ì •ë³´</h2>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ì‹ ì²­ì ì´ë¦„ *</label>
                        <input type="text" id="name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                      </div>
                      <div class="grid md:grid-cols-2 gap-4">
                        <div>
                          <label class="block text-sm font-semibold text-gray-700 mb-2">ì´ë©”ì¼ *</label>
                          <input type="email" id="email" required 
                                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                          <label class="block text-sm font-semibold text-gray-700 mb-2">ì—°ë½ì²˜ *</label>
                          <input type="tel" id="phone" required placeholder="010-0000-0000"
                                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">í•™ì›ëª… *</label>
                        <input type="text" id="academy_name" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                      </div>
                    </div>
                  </div>

                  <!-- í•™ì›ì¥ ì •ë³´ -->
                  <div class="border-b pb-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">í•™ì›ì¥ ì •ë³´</h2>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">í•™ì›ì¥ ì´ë¦„ *</label>
                        <input type="text" id="director_name" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                      </div>
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">í•™ì›ì¥ ì‚¬ì§„ URL *</label>
                        <input type="url" id="director_photo" required placeholder="https://example.com/photo.jpg"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               oninput="previewImage(this.value, 'director_photo_preview')">
                        <p class="text-xs text-gray-500 mt-1">ì´ë¯¸ì§€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: https://...)</p>
                        <div id="director_photo_preview" class="mt-3 hidden">
                          <img src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="w-32 h-32 object-cover rounded-full border-4 border-blue-500 shadow-lg">
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">í•™ì›ì¥ ê²½ë ¥ *</label>
                        <textarea id="director_career" rows="4" required placeholder="ì˜ˆ: ì„œìš¸ëŒ€í•™êµ êµìœ¡í•™ ì„ì‚¬&#10;â—‹â—‹í•™ì› 10ë…„ ìš´ì˜&#10;êµìœ¡ì²­ ìš°ìˆ˜í•™ì› ì„ ì •"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                      </div>
                    </div>
                  </div>

                  <!-- í•™ì› ì‚¬ì§„ -->
                  <div class="border-b pb-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">í•™ì› ì‚¬ì§„</h2>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">í•™ì› ì‚¬ì§„ 1 URL *</label>
                        <input type="url" id="academy_photo_1" required placeholder="https://example.com/photo1.jpg"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               oninput="previewImage(this.value, 'academy_photo_1_preview')">
                        <div id="academy_photo_1_preview" class="mt-3 hidden">
                          <img src="" alt="í•™ì› ì‚¬ì§„ 1" class="w-full h-48 object-cover rounded-lg border-2 border-blue-500 shadow-lg">
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">í•™ì› ì‚¬ì§„ 2 URL *</label>
                        <input type="url" id="academy_photo_2" required placeholder="https://example.com/photo2.jpg"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               oninput="previewImage(this.value, 'academy_photo_2_preview')">
                        <div id="academy_photo_2_preview" class="mt-3 hidden">
                          <img src="" alt="í•™ì› ì‚¬ì§„ 2" class="w-full h-48 object-cover rounded-lg border-2 border-blue-500 shadow-lg">
                        </div>
                      </div>
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">í•™ì› ì‚¬ì§„ 3 URL *</label>
                        <input type="url" id="academy_photo_3" required placeholder="https://example.com/photo3.jpg"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                               oninput="previewImage(this.value, 'academy_photo_3_preview')">
                        <div id="academy_photo_3_preview" class="mt-3 hidden">
                          <img src="" alt="í•™ì› ì‚¬ì§„ 3" class="w-full h-48 object-cover rounded-lg border-2 border-blue-500 shadow-lg">
                        </div>
                      </div>
                      <p class="text-xs text-gray-500">í•™ì› ë‚´ë¶€, ìˆ˜ì—… ëª¨ìŠµ, í•™ìƒë“¤ ê³µë¶€í•˜ëŠ” ì‚¬ì§„ ë“±ì„ ë„£ì–´ì£¼ì„¸ìš”</p>
                    </div>
                  </div>

                  <!-- êµìœ¡ ì •ë³´ -->
                  <div class="border-b pb-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">êµìœ¡ ì •ë³´</h2>
                    <div class="space-y-4">
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">êµìœ¡ ì² í•™ *</label>
                        <textarea id="education_philosophy" rows="4" required placeholder="ìš°ë¦¬ í•™ì›ë§Œì˜ êµìœ¡ ì² í•™ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                      </div>
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">êµìœ¡ í”„ë¡œê·¸ë¨ *</label>
                        <textarea id="education_programs" rows="4" required placeholder="ì˜ˆ: 1:1 ë§ì¶¤ ìˆ˜ì—…&#10;ì†Œê·¸ë£¹ í† ë¡  ìˆ˜ì—…&#10;ì˜¨ë¼ì¸ ê°•ì˜ ì œê³µ"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                      </div>
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ì»¤ë¦¬í˜ëŸ¼ *</label>
                        <textarea id="curriculum" rows="4" required placeholder="ì˜ˆ: 1ë‹¨ê³„: ê¸°ì´ˆ ë‹¤ì§€ê¸°&#10;2ë‹¨ê³„: ì‹¤ë ¥ í–¥ìƒ&#10;3ë‹¨ê³„: ì‹¬í™” í•™ìŠµ"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                      </div>
                    </div>
                  </div>

                  <!-- ì¶”ê°€ ìš”ì²­ì‚¬í•­ -->
                  <div>
                    <h2 class="text-xl font-bold text-gray-900 mb-4">ì¶”ê°€ ìš”ì²­ì‚¬í•­</h2>
                    <div>
                      <label class="block text-sm font-semibold text-gray-700 mb-2">ê¸°íƒ€ ìš”ì²­ì‚¬í•­</label>
                      <textarea id="message" rows="4" placeholder="ì›í•˜ì‹œëŠ” ë””ìì¸ ìŠ¤íƒ€ì¼, ìƒ‰ìƒ, íŠ¹ë³„íˆ ê°•ì¡°í•˜ê³  ì‹¶ì€ ë‚´ìš© ë“±ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                  </div>

                  <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-700">
                      <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                      ì‹ ì²­í•˜ì‹œë©´ 1-2ì¼ ë‚´ë¡œ ì—°ë½ë“œë ¤ ìƒì„¸ ìƒë‹´ì„ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.
                    </p>
                  </div>

                  <button type="submit" 
                          class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-lg font-bold rounded-xl hover:from-blue-700 hover:to-indigo-700 transition">
                    ì œì‘ ì‹ ì²­í•˜ê¸°
                  </button>
                </form>
              \`;
              
              // ëœë”©í˜ì´ì§€ í¼ ì œì¶œ
              document.getElementById('landingPageForm').addEventListener('submit', handleLandingPageSubmit);
            } else {
              // ê¸°ì¡´ ê°„ë‹¨í•œ í¼ ìœ ì§€ (ë‹¤ë¥¸ ì„œë¹„ìŠ¤ìš©)
              document.getElementById('applicationForm').addEventListener('submit', handleSimpleSubmit);
            }
          }

          async function handleLandingPageSubmit(e) {
            e.preventDefault();
            
            const formData = {
              program_id: programId,
              applicant_name: document.getElementById('name').value,
              applicant_email: document.getElementById('email').value,
              applicant_phone: document.getElementById('phone').value,
              academy_name: document.getElementById('academy_name').value,
              director_name: document.getElementById('director_name').value,
              director_photo: document.getElementById('director_photo').value,
              director_career: document.getElementById('director_career').value,
              academy_photo_1: document.getElementById('academy_photo_1').value,
              academy_photo_2: document.getElementById('academy_photo_2').value,
              academy_photo_3: document.getElementById('academy_photo_3').value,
              education_philosophy: document.getElementById('education_philosophy').value,
              education_programs: document.getElementById('education_programs').value,
              curriculum: document.getElementById('curriculum').value,
              message: document.getElementById('message').value
            };

            try {
              const response = await fetch('/api/consulting/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
              });

              const data = await response.json();
              
              if (data.success) {
                alert('ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë¹ ë¥¸ ì‹œì¼ ë‚´ë¡œ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
                window.location.href = '/consulting';
              } else {
                alert(data.error || 'ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              }
            } catch (err) {
              console.error('ì‹ ì²­ ì˜¤ë¥˜:', err);
              alert('ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          }

          async function handleSimpleSubmit(e) {
            e.preventDefault();
            
            const formData = {
              program_id: programId,
              applicant_name: document.getElementById('name').value,
              applicant_email: document.getElementById('email').value,
              applicant_phone: document.getElementById('phone').value,
              academy_name: document.getElementById('academy_name').value,
              message: document.getElementById('message').value
            };

            try {
              const response = await fetch('/api/consulting/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
              });

              const data = await response.json();
              
              if (data.success) {
                alert(data.message || 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                window.location.href = '/consulting';
              } else {
                alert(data.error || 'ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              }
            } catch (err) {
              console.error('ì‹ ì²­ ì˜¤ë¥˜:', err);
              alert('ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          }

          // í¼ ë Œë”ë§ í›„ ì‚¬ìš©ì ì •ë³´ ìë™ ì±„ìš°ê¸°
          setTimeout(() => {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (user.name) {
              const nameInput = document.getElementById('name');
              if (nameInput) nameInput.value = user.name;
            }
            
            if (user.email) {
              const emailInput = document.getElementById('email');
              if (emailInput) emailInput.value = user.email;
            }
            
            if (user.phone) {
              const phoneInput = document.getElementById('phone');
              if (phoneInput) phoneInput.value = user.phone;
            }
            
            if (user.academy_name) {
              const academyNameInput = document.getElementById('academy_name');
              if (academyNameInput) {
                academyNameInput.value = user.academy_name;
                // ëœë”©í˜ì´ì§€ ì œì‘ í¼ì—ì„œëŠ” í•„ìˆ˜ í•„ë“œì´ë¯€ë¡œ ì½ê¸° ì „ìš©ìœ¼ë¡œ ì„¤ì •
                if (programId === 'landing-page-max') {
                  academyNameInput.readOnly = true;
                  academyNameInput.classList.add('bg-gray-100');
                }
              }
            }
          }, 100);
        </script>
    </body>
    </html>
  `);
});

// ê´€ë¦¬ì - ì»¨ì„¤íŒ… ì‹ ì²­ ê´€ë¦¬ í˜ì´ì§€
app.get('/admin/consulting-applications', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì»¨ì„¤íŒ… ì‹ ì²­ ê´€ë¦¬ - ê´€ë¦¬ì</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet">
        <style>
          * { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-50">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <a href="/admin/dashboard" class="text-2xl font-bold text-blue-600">ê´€ë¦¬ì</a>
                    <div class="flex gap-6 items-center">
                        <a href="/admin/dashboard" class="text-gray-600 hover:text-blue-600">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="/admin/consulting-applications" class="text-blue-600 font-semibold">ì»¨ì„¤íŒ… ì‹ ì²­</a>
                    </div>
                </div>
            </nav>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ì»¨ì„¤íŒ… ì‹ ì²­ ê´€ë¦¬</h1>
                <p class="text-gray-600">ìˆ˜ê°• ì‹ ì²­ ë‚´ì—­ì„ í™•ì¸í•˜ê³  ìŠ¹ì¸/ê±°ë¶€ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>

            <!-- í•„í„° -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex gap-4">
                    <button onclick="filterApplications('all')" 
                            class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200" id="filter-all">
                      ì „ì²´
                    </button>
                    <button onclick="filterApplications('pending')" 
                            class="px-4 py-2 rounded-lg bg-yellow-100 text-yellow-800 hover:bg-yellow-200" id="filter-pending">
                      ëŒ€ê¸°ì¤‘
                    </button>
                    <button onclick="filterApplications('approved')" 
                            class="px-4 py-2 rounded-lg bg-green-100 text-green-800 hover:bg-green-200" id="filter-approved">
                      ìŠ¹ì¸ë¨
                    </button>
                    <button onclick="filterApplications('rejected')" 
                            class="px-4 py-2 rounded-lg bg-red-100 text-red-800 hover:bg-red-200" id="filter-rejected">
                      ê±°ë¶€ë¨
                    </button>
                </div>
            </div>

            <!-- ì‹ ì²­ ëª©ë¡ -->
            <div id="applicationsList" class="space-y-4">
                <!-- ì‹ ì²­ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </main>

        <script>
          let allApplications = [];
          let currentFilter = 'all';

          async function loadApplications() {
            try {
              const response = await fetch('/api/admin/consulting/applications');
              const data = await response.json();
              
              if (data.success) {
                allApplications = data.applications;
                renderApplications();
              }
            } catch (err) {
              console.error('ì‹ ì²­ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
            }
          }

          function filterApplications(status) {
            currentFilter = status;
            renderApplications();
          }

          function renderApplications() {
            const filtered = currentFilter === 'all' 
              ? allApplications 
              : allApplications.filter(app => app.status === currentFilter);

            const list = document.getElementById('applicationsList');
            
            if (filtered.length === 0) {
              list.innerHTML = '<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
              return;
            }

            list.innerHTML = filtered.map(app => {
              const statusBadge = {
                'pending': '<span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-semibold">ëŒ€ê¸°ì¤‘</span>',
                'approved': '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-semibold">ìŠ¹ì¸ë¨</span>',
                'rejected': '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-semibold">ê±°ë¶€ë¨</span>'
              }[app.status];

              return \`
                <div class="bg-white rounded-lg shadow p-6">
                  <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                      <div class="flex items-center gap-3 mb-2">
                        <h3 class="text-xl font-bold text-gray-900">\${app.program_name}</h3>
                        \${statusBadge}
                      </div>
                      <p class="text-sm text-gray-500">\${new Date(app.applied_at).toLocaleString('ko-KR')}</p>
                    </div>
                    <div class="text-right">
                      <p class="text-2xl font-bold text-blue-600">\${(app.program_price / 10000).toFixed(0)}ë§Œì›</p>
                    </div>
                  </div>

                  <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <p class="text-sm text-gray-500">ì‹ ì²­ì</p>
                      <p class="font-semibold">\${app.applicant_name}</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">ì´ë©”ì¼</p>
                      <p class="font-semibold">\${app.applicant_email}</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">ì—°ë½ì²˜</p>
                      <p class="font-semibold">\${app.applicant_phone}</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">í•™ì›ëª…</p>
                      <p class="font-semibold">\${app.academy_name || '-'}</p>
                    </div>
                  </div>

                  \${app.message ? \`
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                      <p class="text-sm text-gray-500 mb-1">ë¬¸ì˜ì‚¬í•­</p>
                      <p class="text-gray-700">\${app.message}</p>
                    </div>
                  \` : ''}

                  \${app.status === 'pending' ? \`
                    <div class="flex gap-3">
                      <button onclick="approveApplication(\${app.id})" 
                              class="flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-check mr-2"></i>ìŠ¹ì¸
                      </button>
                      <button onclick="rejectApplication(\${app.id})" 
                              class="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        <i class="fas fa-times mr-2"></i>ê±°ë¶€
                      </button>
                    </div>
                  \` : ''}

                  \${app.status === 'rejected' && app.reject_reason ? \`
                    <div class="mt-4 p-4 bg-red-50 rounded-lg">
                      <p class="text-sm text-red-700"><strong>ê±°ë¶€ ì‚¬ìœ :</strong> \${app.reject_reason}</p>
                    </div>
                  \` : ''}
                </div>
              \`;
            }).join('');
          }

          async function approveApplication(id) {
            if (!confirm('ì´ ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            try {
              const response = await fetch(\`/api/admin/consulting/applications/\${id}/approve\`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_id: user.id })
              });

              const data = await response.json();
              
              if (data.success) {
                alert(data.message);
                loadApplications();
              } else {
                alert(data.error || 'ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              }
            } catch (err) {
              console.error('ìŠ¹ì¸ ì˜¤ë¥˜:', err);
              alert('ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          }

          async function rejectApplication(id) {
            const reason = prompt('ê±°ë¶€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!reason) return;

            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            try {
              const response = await fetch(\`/api/admin/consulting/applications/\${id}/reject\`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_id: user.id, reason })
              });

              const data = await response.json();
              
              if (data.success) {
                alert(data.message);
                loadApplications();
              } else {
                alert(data.error || 'ê±°ë¶€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              }
            } catch (err) {
              console.error('ê±°ë¶€ ì˜¤ë¥˜:', err);
              alert('ê±°ë¶€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          }

          loadApplications();
        </script>
    </body>
    </html>
  `);
});

// íšŒì›ê°€ì… í˜ì´ì§€
app.get('/signup', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>íšŒì›ê°€ì… v2.0 - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="min-h-screen flex items-center justify-center px-6 py-12">
            <div class="max-w-md w-full">
                <div class="text-center mb-10">
                    <a href="/" class="inline-block mb-6">
                        <span class="text-2xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <div class="flex items-center justify-center gap-3 mb-2">
                        <h1 class="text-3xl font-bold text-gray-900">íšŒì›ê°€ì…</h1>
                        <span class="px-2 py-1 bg-purple-100 text-purple-700 text-xs font-bold rounded-full">v2.0</span>
                    </div>
                    <p class="text-gray-600">í•™ì› ë§ˆì¼€íŒ… êµìœ¡ì„ ì‹œì‘í•´ë³´ì„¸ìš”</p>
                </div>

                <div class="bg-white rounded-2xl border border-gray-200 p-8">
                    <!-- ê³„ì • ìœ í˜• ì„ íƒ (ë¼ë””ì˜¤ ë²„íŠ¼) -->
                    <div class="mb-6">
                        <label class="block text-lg font-bold text-gray-900 mb-4 text-center">
                            ì–´ë–¤ ê³„ì •ìœ¼ë¡œ ê°€ì…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                        </label>
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <label class="relative cursor-pointer">
                                <input type="radio" name="userType" value="director" checked class="peer sr-only" onchange="toggleUserType()">
                                <div class="p-6 border-2 border-gray-300 rounded-xl peer-checked:border-purple-600 peer-checked:bg-purple-50 hover:border-purple-400 transition text-center">
                                    <i class="fas fa-school text-4xl text-purple-600 mb-3 block"></i>
                                    <p class="font-bold text-gray-900 text-lg mb-1">í•™ì›ì¥</p>
                                    <p class="text-xs text-gray-600">í•™ì›ì„ ìš´ì˜í•©ë‹ˆë‹¤</p>
                                </div>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="radio" name="userType" value="teacher" class="peer sr-only" onchange="toggleUserType()">
                                <div class="p-6 border-2 border-gray-300 rounded-xl peer-checked:border-purple-600 peer-checked:bg-purple-50 hover:border-purple-400 transition text-center">
                                    <i class="fas fa-chalkboard-teacher text-4xl text-purple-600 mb-3 block"></i>
                                    <p class="font-bold text-gray-900 text-lg mb-1">ì„ ìƒë‹˜</p>
                                    <p class="text-xs text-gray-600">í•™ì›ì—ì„œ ê°€ë¥´ì¹©ë‹ˆë‹¤</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <form id="signupForm" class="space-y-5">
                        <!-- ì„ ìƒë‹˜ ì „ìš© í•„ë“œ -->
                        <div id="teacherFields" class="hidden space-y-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">
                                    <i class="fas fa-key text-purple-600 mr-2"></i>í•™ì› ì¸ì¦ ì½”ë“œ <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="verificationCode" id="verificationCode" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition uppercase" placeholder="ABC123" maxlength="6">
                                <p class="text-xs text-gray-500 mt-1">ì›ì¥ë‹˜ì—ê²Œ ë°›ì€ 6ìë¦¬ ì½”ë“œ</p>
                            </div>
                        </div>

                        <!-- ê³µí†µ í•„ë“œ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">
                                <span id="nameLabel">ì›ì¥ë‹˜ ì„±í•¨</span> <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="name" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="í™ê¸¸ë™">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì´ë©”ì¼ <span class="text-red-500">*</span></label>
                            <input type="email" name="email" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="example@email.com">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ë¹„ë°€ë²ˆí˜¸ <span class="text-red-500">*</span></label>
                            <input type="password" name="password" required minlength="6" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="ìµœì†Œ 6ì ì´ìƒ">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì—°ë½ì²˜ <span class="text-red-500">*</span></label>
                            <input type="tel" name="phone" required placeholder="010-0000-0000" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì› ì´ë¦„ <span class="text-red-500">*</span></label>
                            <input type="text" name="academy_name" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="ê¾¸ë©”ë•…í•™ì›">
                            <p id="academyHint" class="text-xs text-gray-500 mt-1 hidden">ì¸ì¦ ì½”ë“œì™€ ì¼ì¹˜í•˜ëŠ” í•™ì›ëª…ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”</p>
                        </div>

                        <!-- ì›ì¥ë‹˜ ì „ìš© í•„ë“œ -->
                        <div id="directorFields">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì› ìœ„ì¹˜</label>
                                <input type="text" name="academy_location" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="ì¸ì²œ ì„œêµ¬ ê²€ë‹¨ë™ (ì„ íƒì‚¬í•­)">
                            </div>
                        </div>

                        <!-- ì„ ìƒë‹˜ ì•ˆë‚´ ë©”ì‹œì§€ -->
                        <div id="teacherNotice" class="hidden bg-purple-50 border border-purple-200 rounded-xl p-4">
                            <p class="text-sm text-purple-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>ë“±ë¡ ì ˆì°¨:</strong> ì‹ ì²­ í›„ ì›ì¥ë‹˜ì˜ ìŠ¹ì¸ì„ ë°›ìœ¼ë©´ ê³„ì •ì´ í™œì„±í™”ë©ë‹ˆë‹¤.
                            </p>
                        </div>

                        <!-- ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ë™ì˜ -->
                        <div class="border-t pt-5">
                            <div class="space-y-4">
                                <!-- ì•½ê´€ ì „ë¬¸ ë³´ê¸° -->
                                <details class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                    <summary class="cursor-pointer font-medium text-gray-900 hover:text-purple-600 transition flex items-center justify-between">
                                        <span>ğŸ“„ ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ì „ë¬¸ ë³´ê¸°</span>
                                        <i class="fas fa-chevron-down text-sm"></i>
                                    </summary>
                                    <div class="mt-4 max-h-96 overflow-y-auto text-xs text-gray-700 leading-relaxed space-y-3 bg-white p-4 rounded-lg">
                                        <h3 class="font-bold text-sm text-gray-900">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</h3>
                                        
                                        <div class="space-y-2">
                                            <p class="font-semibold">ì œ 1 ì¥ ì´ ì¹™</p>
                                            <p><strong>ì œ 1 ì¡° (ëª©ì )</strong> ì´ ì•½ê´€ì€ ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤(ì´í•˜ "íšŒì‚¬"ë¼ í•©ë‹ˆë‹¤)ê°€ ì œê³µí•˜ëŠ” í•™ì› ê´€ë¦¬ í”Œë«í¼, AI ë§ˆì¼€íŒ… ìë™í™” ì†”ë£¨ì…˜, ë¬¸ì ë°œì†¡ ì„œë¹„ìŠ¤ ë° ê¸°íƒ€ ì œë°˜ ì„œë¹„ìŠ¤(ì´í•˜ "ì„œë¹„ìŠ¤"ë¼ í•©ë‹ˆë‹¤)ì˜ ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬ íšŒì‚¬ì™€ íšŒì› ê°„ì˜ ê¶Œë¦¬, ì˜ë¬´ ë° ì±…ì„ì‚¬í•­, ê¸°íƒ€ í•„ìš”í•œ ì‚¬í•­ì„ ê·œì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
                                            
                                            <p><strong>ì œ 2 ì¡° (ìš©ì–´ì˜ ì •ì˜)</strong> ì´ ì•½ê´€ì—ì„œ ì‚¬ìš©í•˜ëŠ” ìš©ì–´ì˜ ì •ì˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
                                            <ul class="list-disc pl-5 space-y-1">
                                                <li>"ì„œë¹„ìŠ¤"ë¼ í•¨ì€ êµ¬í˜„ë˜ëŠ” ë‹¨ë§ê¸°(PC, íœ´ëŒ€í˜• ë‹¨ë§ê¸° ë“±)ì™€ ìƒê´€ì—†ì´ íšŒì›ì´ ì´ìš©í•  ìˆ˜ ìˆëŠ” 'ìŠˆí¼í”Œë ˆì´ìŠ¤ ì•„ì¹´ë°ë¯¸' ë° ê´€ë ¨ ì œë°˜ ì„œë¹„ìŠ¤ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
                                                <li>"íšŒì›"ì´ë¼ í•¨ì€ íšŒì‚¬ì˜ ì„œë¹„ìŠ¤ì— ì ‘ì†í•˜ì—¬ ì´ ì•½ê´€ì— ë”°ë¼ íšŒì‚¬ì™€ ì´ìš©ê³„ì•½ì„ ì²´ê²°í•˜ê³  íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ê³ ê°(í•™ì›ì¥ ë° í•™ì› ê´€ê³„ì)ì„ ë§í•©ë‹ˆë‹¤.</li>
                                                <li>"ì•„ì´ë””(ID)"ë¼ í•¨ì€ íšŒì›ì˜ ì‹ë³„ê³¼ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•˜ì—¬ íšŒì›ì´ ì •í•˜ê³  íšŒì‚¬ê°€ ìŠ¹ì¸í•˜ëŠ” ë¬¸ìì™€ ìˆ«ìì˜ ì¡°í•©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
                                                <li>"ë¹„ë°€ë²ˆí˜¸"ë¼ í•¨ì€ íšŒì›ì´ ë¶€ì—¬ë°›ì€ IDì™€ ì¼ì¹˜ëœ íšŒì›ì„ì„ í™•ì¸í•˜ê³  ë¹„ë°€ë³´í˜¸ë¥¼ ìœ„í•´ íšŒì› ìì‹ ì´ ì •í•œ ë¬¸ì ë˜ëŠ” ìˆ«ìì˜ ì¡°í•©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
                                                <li>"í¬ì¸íŠ¸"ë¼ í•¨ì€ ì„œë¹„ìŠ¤ ë‚´ì—ì„œ ë¬¸ì ë©”ì‹œì§€(SMS/LMS) ë°œì†¡ ë“±ì„ ì´ìš©í•˜ê¸° ìœ„í•´ íšŒì›ì´ ìœ ìƒìœ¼ë¡œ ì¶©ì „í•˜ê±°ë‚˜ íšŒì‚¬ê°€ ë¬´ìƒìœ¼ë¡œ ì§€ê¸‰í•˜ëŠ” ê°€ìƒì˜ ê²°ì œ ìˆ˜ë‹¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
                                                <li>"AI ê²°ê³¼ë¬¼"ì´ë¼ í•¨ì€ íšŒì›ì´ ì…ë ¥í•œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ê³µì§€ëŠ¥(OpenAI ë“±) ì•Œê³ ë¦¬ì¦˜ì„ í†µí•´ ìƒì„±ëœ ë¦¬í¬íŠ¸, ëœë”©í˜ì´ì§€, í…ìŠ¤íŠ¸ ë“±ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
                                            </ul>
                                            
                                            <p><strong>ì œ 3 ì¡° (ì•½ê´€ì˜ íš¨ë ¥ ë° ë³€ê²½)</strong></p>
                                            <p>â‘  ì´ ì•½ê´€ì€ ì„œë¹„ìŠ¤ í™”ë©´ì— ê²Œì‹œí•˜ê±°ë‚˜ ê¸°íƒ€ì˜ ë°©ë²•ìœ¼ë¡œ íšŒì›ì—ê²Œ ê³µì§€í•¨ìœ¼ë¡œì¨ íš¨ë ¥ì´ ë°œìƒí•©ë‹ˆë‹¤.</p>
                                            <p>â‘¡ íšŒì‚¬ëŠ” í•„ìš”í•˜ë‹¤ê³  ì¸ì •ë˜ëŠ” ê²½ìš° ã€Œì•½ê´€ì˜ ê·œì œì— ê´€í•œ ë²•ë¥ ã€ ë“± ê´€ë ¨ ë²•ë ¹ì„ ìœ„ë°°í•˜ì§€ ì•ŠëŠ” ë²”ìœ„ì—ì„œ ì´ ì•½ê´€ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                            <p>â‘¢ íšŒì‚¬ê°€ ì•½ê´€ì„ ë³€ê²½í•  ê²½ìš°ì—ëŠ” ì ìš©ì¼ì ë° ë³€ê²½ì‚¬ìœ ë¥¼ ëª…ì‹œí•˜ì—¬ í˜„í–‰ì•½ê´€ê³¼ í•¨ê»˜ ì„œë¹„ìŠ¤ ì´ˆê¸°í™”ë©´ì— ê·¸ ì ìš©ì¼ì 7ì¼ ì „ë¶€í„° ê³µì§€í•©ë‹ˆë‹¤.</p>
                                            
                                            <p class="font-semibold">ì œ 2 ì¥ ì´ìš©ê³„ì•½ì˜ ì²´ê²°</p>
                                            <p><strong>ì œ 4 ì¡° (ì´ìš©ê³„ì•½ì˜ ì„±ë¦½)</strong> ì´ìš©ê³„ì•½ì€ íšŒì›ì´ ë˜ê³ ì í•˜ëŠ” ìê°€ ì•½ê´€ì˜ ë‚´ìš©ì— ëŒ€í•˜ì—¬ ë™ì˜ë¥¼ í•œ ë‹¤ìŒ íšŒì›ê°€ì… ì‹ ì²­ì„ í•˜ê³  íšŒì‚¬ê°€ ì´ëŸ¬í•œ ì‹ ì²­ì— ëŒ€í•˜ì—¬ ìŠ¹ë‚™í•¨ìœ¼ë¡œì¨ ì²´ê²°ë©ë‹ˆë‹¤.</p>
                                            
                                            <p><strong>ì œ 9 ì¡° (AI ì„œë¹„ìŠ¤ ì´ìš© ë° ë©´ì±… íŠ¹ì•½)</strong> [ì¤‘ìš”]</p>
                                            <p>â‘  íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” AI ê¸°ë°˜ ì„œë¹„ìŠ¤(ëœë”©í˜ì´ì§€ ìƒì„±, í•™ìƒ ë¦¬í¬íŠ¸ ë“±)ëŠ” í™•ë¥ ì  ìƒì„± ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ë¯€ë¡œ, ê²°ê³¼ë¬¼ì˜ ì™„ì „í•œ ì •í™•ì„±, ì ë²•ì„±, ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                                            <p>â‘¡ íšŒì›ì€ AIê°€ ìƒì„±í•œ ê²°ê³¼ë¬¼ì„ í•™ë¶€ëª¨ ìƒë‹´, ë§ˆì¼€íŒ… ë“±ì— í™œìš©í•˜ê¸° ì „ì— ë°˜ë“œì‹œ ë‚´ìš©ì„ ê²€ìˆ˜í•˜ì—¬ì•¼ í•˜ë©°, ê²€ìˆ˜í•˜ì§€ ì•Šê³  í™œìš©í•˜ì—¬ ë°œìƒí•œ ë¬¸ì œì— ëŒ€í•œ ì±…ì„ì€ íšŒì› ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.</p>
                                            
                                            <p><strong>ì œ 10 ì¡° (ë¬¸ì ë°œì†¡ ì„œë¹„ìŠ¤ ì´ìš© ë° ìŠ¤íŒ¸ ë°©ì§€)</strong> [ì¤‘ìš”]</p>
                                            <p>â‘  íšŒì›ì€ ë¬¸ì ë©”ì‹œì§€ ë°œì†¡ ì‹œ ã€Œì •ë³´í†µì‹ ë§ ì´ìš©ì´‰ì§„ ë° ì •ë³´ë³´í˜¸ ë“±ì— ê´€í•œ ë²•ë¥ ã€ì„ ì¤€ìˆ˜í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.</p>
                                            <p>â‘¡ ìˆ˜ì‹ ìì˜ ì‚¬ì „ ë™ì˜ ì—†ëŠ” ê´‘ê³ ì„± ì •ë³´ ì „ì†¡ìœ¼ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ë¯¼Â·í˜•ì‚¬ìƒ ì±…ì„ì€ ì „ì ìœ¼ë¡œ íšŒì›ì´ ë¶€ë‹´í•©ë‹ˆë‹¤.</p>
                                        </div>
                                        
                                        <p class="text-xs text-gray-500 pt-4 border-t">ë¶€ì¹™: ì´ ì•½ê´€ì€ 2026ë…„ 1ì›” 23ì¼ë¶€í„° ì‹œí–‰í•©ë‹ˆë‹¤.</p>
                                    </div>
                                </details>
                                
                                <!-- í•„ìˆ˜ ë™ì˜ ì²´í¬ë°•ìŠ¤ -->
                                <label class="flex items-start gap-3 cursor-pointer p-4 border-2 border-gray-300 rounded-xl hover:border-purple-500 transition bg-white" id="termsLabel">
                                    <input type="checkbox" id="agreeTerms" required class="mt-1 w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-2 focus:ring-purple-500 cursor-pointer">
                                    <span class="flex-1 text-sm">
                                        <span class="font-medium text-gray-900">[í•„ìˆ˜]</span>
                                        <span class="text-gray-700">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
                                        <p class="text-xs text-gray-500 mt-1">ìœ„ ì•½ê´€ì„ ì½ê³  ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©°, AI ì„œë¹„ìŠ¤ ë©´ì±…ì‚¬í•­ ë° ë¬¸ì ë°œì†¡ ì‹œ ìŠ¤íŒ¸ ë°©ì§€ ì˜ë¬´ë¥¼ ì´í•´í•˜ì˜€ìŠµë‹ˆë‹¤.</p>
                                    </span>
                                </label>
                                
                                <!-- ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜ (ì„ íƒ) -->
                                <details class="bg-blue-50 rounded-xl p-4 border-2 border-blue-200">
                                    <summary class="cursor-pointer font-medium text-gray-900 hover:text-blue-600 transition flex items-center justify-between">
                                        <span>ğŸ“¢ [ì„ íƒ] ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜</span>
                                        <i class="fas fa-chevron-down text-sm"></i>
                                    </summary>
                                    <div class="mt-4 text-xs text-gray-700 leading-relaxed space-y-3 bg-white p-4 rounded-lg">
                                        <p class="font-semibold text-sm text-gray-900">ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤(ì´í•˜ "íšŒì‚¬")ëŠ” íšŒì›ë‹˜ê»˜ ìµœì í™”ëœ ë§ì¶¤í˜• ì„œë¹„ìŠ¤ì™€ í˜œíƒì„ ì œê³µí•˜ê¸° ìœ„í•´, ë‹¤ìŒê³¼ ê°™ì´ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘Â·ì´ìš©í•˜ê³  ê´‘ê³ ì„± ì •ë³´ë¥¼ ì „ì†¡í•˜ê³ ì í•©ë‹ˆë‹¤.</p>
                                        
                                        <div>
                                            <p class="font-semibold text-gray-900 mb-2">1. ìˆ˜ì§‘ ë° ì´ìš© ëª©ì </p>
                                            <ul class="list-disc pl-5 space-y-1">
                                                <li>ì‹ ê·œ ì„œë¹„ìŠ¤(AI Gems, ë´‡ ë“±) ì¶œì‹œ ë° ì—…ë°ì´íŠ¸ ì•ˆë‚´</li>
                                                <li>í•™ì› ìš´ì˜/ë§ˆì¼€íŒ… ê´€ë ¨ êµìœ¡, ì„¸ë¯¸ë‚˜, ë‰´ìŠ¤ë ˆí„° ë°œì†¡</li>
                                                <li>ì´ë²¤íŠ¸ ì •ë³´ ì•ˆë‚´, í• ì¸ ì¿ í° ë° ê²½í’ˆ ì§€ê¸‰, í¬ì¸íŠ¸ ì ë¦½ í˜œíƒ ì œê³µ</li>
                                            </ul>
                                        </div>
                                        
                                        <div>
                                            <p class="font-semibold text-gray-900 mb-2">2. ìˆ˜ì§‘ ë° ì´ìš© í•­ëª©</p>
                                            <p>íœ´ëŒ€ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ ì£¼ì†Œ, ì´ë¦„, í•™ì›ëª…</p>
                                        </div>
                                        
                                        <div>
                                            <p class="font-semibold text-gray-900 mb-2">3. ë³´ìœ  ë° ì´ìš© ê¸°ê°„</p>
                                            <p>íšŒì› íƒˆí‡´ ì‹œ ë˜ëŠ” ë™ì˜ ì² íšŒ ì‹œê¹Œì§€</p>
                                        </div>
                                        
                                        <div>
                                            <p class="font-semibold text-gray-900 mb-2">4. ì „ì†¡ ë°©ë²•</p>
                                            <p>íœ´ëŒ€í° ë¬¸ìë©”ì‹œì§€(SMS/LMS/MMS), ì´ë©”ì¼, ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼í†¡/ì¹œêµ¬í†¡</p>
                                        </div>
                                        
                                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-4">
                                            <p class="text-gray-800">
                                                <strong>â€» ê·€í•˜ëŠ” ë™ì˜ë¥¼ ê±°ë¶€í•  ê¶Œë¦¬ê°€ ìˆìŠµë‹ˆë‹¤.</strong> ë™ì˜ë¥¼ ê±°ë¶€í•˜ì…”ë„ ê¸°ë³¸ ì„œë¹„ìŠ¤(í•™ìƒ ê´€ë¦¬, ë¦¬í¬íŠ¸ ìƒì„± ë“±) ì´ìš©ì—ëŠ” ì œí•œì´ ì—†ìœ¼ë‚˜, ì´ë²¤íŠ¸ ë° í• ì¸ í˜œíƒ ì •ë³´ëŠ” ì œê³µë°›ìœ¼ì‹¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                                            </p>
                                        </div>
                                    </div>
                                </details>
                                
                                <!-- í†µí•© ë§ˆì¼€íŒ… ìˆ˜ì‹  ë™ì˜ ì²´í¬ë°•ìŠ¤ -->
                                <label class="flex items-start gap-3 cursor-pointer p-4 border-2 border-blue-200 rounded-xl hover:border-blue-400 transition bg-blue-50">
                                    <input type="checkbox" id="agreeMarketing" class="mt-1 w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-2 focus:ring-blue-500 cursor-pointer">
                                    <span class="flex-1 text-sm">
                                        <span class="font-medium text-blue-700">[ì„ íƒ]</span>
                                        <span class="text-gray-700">ë§ˆì¼€íŒ… ì •ë³´ ìˆ˜ì‹  ë™ì˜ (ë¬¸ìë©”ì‹œì§€, ì´ë©”ì¼, ì¹´ì¹´ì˜¤í†¡)</span>
                                        <p class="text-xs text-gray-600 mt-1">ì´ë²¤íŠ¸, í• ì¸ ì¿ í°, ì‹ ê·œ ì„œë¹„ìŠ¤ ì•ˆë‚´, ë‰´ìŠ¤ë ˆí„°, êµìœ¡ ìë£Œ ë“±ì„ ë¬¸ìë©”ì‹œì§€(SMS/LMS/MMS), ì´ë©”ì¼, ì¹´ì¹´ì˜¤í†¡ ì•Œë¦¼í†¡/ì¹œêµ¬í†¡ìœ¼ë¡œ ë°›ì•„ë³´ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="w-full gradient-purple text-white py-3 rounded-xl font-medium hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed" id="submitBtn">
                            <span id="submitText">íšŒì›ê°€ì…</span>
                        </button>

                        <div id="message" class="hidden mt-4 p-4 rounded-xl"></div>
                    </form>

                    <div class="mt-6 text-center text-sm text-gray-600">
                        ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="/login" class="text-purple-600 hover:text-purple-700 font-medium">ë¡œê·¸ì¸</a>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ë¼ë””ì˜¤ ë²„íŠ¼ í† ê¸€ í•¨ìˆ˜
            function toggleUserType() {
                const userTypeRadio = document.querySelector('input[name="userType"]:checked').value;
                const isTeacher = userTypeRadio === 'teacher';
                
                const teacherFields = document.getElementById('teacherFields');
                const directorFields = document.getElementById('directorFields');
                const teacherNotice = document.getElementById('teacherNotice');
                const academyHint = document.getElementById('academyHint');
                const nameLabel = document.getElementById('nameLabel');
                const submitText = document.getElementById('submitText');
                const verificationCodeInput = document.getElementById('verificationCode');

                if (isTeacher) {
                    // ì„ ìƒë‹˜ ëª¨ë“œ
                    teacherFields.classList.remove('hidden');
                    directorFields.classList.add('hidden');
                    teacherNotice.classList.remove('hidden');
                    academyHint.classList.remove('hidden');
                    nameLabel.textContent = 'ì´ë¦„';
                    submitText.innerHTML = '<i class="fas fa-user-plus mr-2"></i>ì„ ìƒë‹˜ ë“±ë¡ ì‹ ì²­';
                    verificationCodeInput.required = true;
                } else {
                    // ì›ì¥ë‹˜ ëª¨ë“œ
                    teacherFields.classList.add('hidden');
                    directorFields.classList.remove('hidden');
                    teacherNotice.classList.add('hidden');
                    academyHint.classList.add('hidden');
                    nameLabel.textContent = 'ì›ì¥ë‹˜ ì„±í•¨';
                    submitText.textContent = 'íšŒì›ê°€ì…';
                    verificationCodeInput.required = false;
                }
            }
            
            // ì•½ê´€ ë™ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³€ê²½ ì‹œ ì œì¶œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            document.addEventListener('DOMContentLoaded', () => {
                const agreeTerms = document.getElementById('agreeTerms');
                const submitBtn = document.getElementById('submitBtn');
                const termsLabel = document.getElementById('termsLabel');
                
                function updateSubmitButton() {
                    if (agreeTerms.checked) {
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        termsLabel.classList.remove('border-red-300');
                        termsLabel.classList.add('border-purple-300');
                    } else {
                        submitBtn.disabled = true;
                        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        termsLabel.classList.remove('border-purple-300');
                    }
                }
                
                // ì´ˆê¸° ìƒíƒœ ì„¤ì •
                updateSubmitButton();
                
                // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                agreeTerms.addEventListener('change', updateSubmitButton);
            });

            // í¼ ì œì¶œ
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault()
                
                // ì•½ê´€ ë™ì˜ ì²´í¬ ê²€ì¦
                const agreeTerms = document.getElementById('agreeTerms');
                if (!agreeTerms.checked) {
                    const messageEl = document.getElementById('message');
                    messageEl.classList.remove('hidden');
                    messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200';
                    messageEl.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.';
                    
                    // ì²´í¬ë°•ìŠ¤ ì˜ì—­ ê°•ì¡°
                    const termsLabel = document.getElementById('termsLabel');
                    termsLabel.classList.add('border-red-500', 'bg-red-50');
                    setTimeout(() => {
                        termsLabel.classList.remove('border-red-500', 'bg-red-50');
                    }, 2000);
                    
                    // ì²´í¬ë°•ìŠ¤ë¡œ ìŠ¤í¬ë¡¤
                    agreeTerms.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                const formData = new FormData(e.target)
                const userTypeRadio = document.querySelector('input[name="userType"]:checked').value;
                const isTeacher = userTypeRadio === 'teacher';
                
                // ì„ ìƒë‹˜ ë“±ë¡ì¸ ê²½ìš°
                if (isTeacher) {
                    const data = {
                        verificationCode: formData.get('verificationCode'),
                        academy_name: formData.get('academy_name'),
                        name: formData.get('name'),
                        email: formData.get('email'),
                        password: formData.get('password'),
                        phone: formData.get('phone')
                    }
                    
                    try {
                        const response = await fetch('/api/teachers/apply', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        })

                        const result = await response.json()
                        const messageEl = document.getElementById('message')
                        messageEl.classList.remove('hidden')

                        if (result.success) {
                            messageEl.className = 'mt-4 p-4 rounded-xl bg-green-50 text-green-800 border border-green-200'
                            messageEl.textContent = result.message || 'ë“±ë¡ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì›ì¥ë‹˜ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.'
                            e.target.reset()
                            setTimeout(() => {
                                window.location.href = '/login'
                            }, 2000)
                        } else {
                            messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                            let errorMsg = result.error || 'ë“±ë¡ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                            if (result.details) {
                                errorMsg += '\\n\\nìƒì„¸: ' + result.details
                            }
                            messageEl.textContent = errorMsg
                            console.error('Error details:', result)
                        }
                    } catch (error) {
                        console.error('Teacher registration error:', error)
                        const messageEl = document.getElementById('message')
                        messageEl.classList.remove('hidden')
                        messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                        messageEl.textContent = 'ë“±ë¡ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\\n\\n' + error.message
                    }
                    return
                }
                
                // ì›ì¥ë‹˜ íšŒì›ê°€ì…ì¸ ê²½ìš°
                const data = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    password: formData.get('password'),
                    phone: formData.get('phone'),
                    academy_name: formData.get('academy_name'),
                    academy_location: formData.get('academy_location'),
                    marketing_consent: document.getElementById('agreeMarketing').checked
                }

                try {
                    const response = await fetch('/api/signup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    })

                    const result = await response.json()
                    const messageEl = document.getElementById('message')
                    messageEl.classList.remove('hidden')

                    if (result.success) {
                        messageEl.className = 'mt-4 p-4 rounded-xl bg-green-50 text-green-800 border border-green-200'
                        messageEl.textContent = result.message
                        setTimeout(() => {
                            window.location.href = '/login'
                        }, 1500)
                    } else {
                        messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                        messageEl.textContent = result.error
                    }
                } catch (err) {
                    const messageEl = document.getElementById('message')
                    messageEl.classList.remove('hidden')
                    messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                    messageEl.textContent = 'íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                }
            })
        </script>
    </body>
    </html>
  `)
})

// êµìœ¡ í”„ë¡œê·¸ë¨ í˜ì´ì§€
// app.get('/programs', (c) => {
//   return c.html(`
//     <!DOCTYPE html>
//     <html lang="ko">
//     <head>
//         <meta charset="UTF-8">
//         <meta name="viewport" content="width=device-width, initial-scale=1.0">
//         <title>êµìœ¡ í”„ë¡œê·¸ë¨ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
//         <script src="https://cdn.tailwindcss.com"></script>
//         <style>
//           @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
//           * {
//             font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
//           }
//           .gradient-purple {
//             background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
//           }
//           .gradient-orange {
//             background: linear-gradient(135deg, #fb923c 0%, #f97316 100%);
//           }
//         </style>
//     </head>
//     <body class="bg-white">
//         <!-- Navigation -->
//         <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
//             <div class="max-w-7xl mx-auto px-6 lg:px-8">
//                 <div class="flex justify-between items-center h-20">
//                     <a href="/" class="flex items-center space-x-3">
//                         <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
//                     </a>
//                     <div class="hidden md:flex items-center space-x-10">
//                         <a href="/" class="text-gray-700 hover:text-purple-600 font-medium transition">í™ˆ</a>
//                         <a href="/programs" class="text-purple-600 font-medium">êµìœ¡ í”„ë¡œê·¸ë¨</a>
//                         <a href="/success" class="text-gray-700 hover:text-purple-600 font-medium transition">ì„±ê³µ ì‚¬ë¡€</a>
//                         <a href="/contact" class="text-gray-700 hover:text-purple-600 font-medium transition">ë¬¸ì˜í•˜ê¸°</a>
//                         <a href="/login" class="gradient-purple text-white px-6 py-2.5 rounded-full font-medium">ë¡œê·¸ì¸</a>
//                     </div>
//                 </div>
//             </div>
//         </nav>
// 
//         <!-- Hero -->
//         <section class="pt-32 pb-20 px-6">
//             <div class="max-w-7xl mx-auto text-center">
//                 <h1 class="text-5xl lg:text-6xl font-bold text-gray-900 mb-6">êµìœ¡ í”„ë¡œê·¸ë¨</h1>
//                 <p class="text-xl text-gray-600 max-w-3xl mx-auto">
//                     ì‹¤ì „ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ì²´ê³„ì ì¸ í•™ì› ë§ˆì¼€íŒ… êµìœ¡
//                 </p>
//             </div>
//         </section>
// 
//         <!-- Programs -->
//         <section class="pb-24 px-6">
//             <div class="max-w-7xl mx-auto space-y-20">
//                 <!-- Program 1 -->
//                 <div class="grid lg:grid-cols-2 gap-12 items-center">
//                     <div>
//                         <div class="inline-block px-4 py-2 bg-purple-100 text-purple-700 rounded-full text-sm font-medium mb-4">í”„ë¡œê·¸ë¨ 01</div>
//                         <h2 class="text-4xl font-bold text-gray-900 mb-6">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œ</h2>
//                         <p class="text-xl text-gray-600 mb-8">
//                             ì§€ì—­ ê²€ìƒ‰ 1ìœ„ë¥¼ ì°¨ì§€í•˜ëŠ” ì‹¤ì „ ë…¸í•˜ìš°. í•™ì› ìœ„ì¹˜ ê¸°ë°˜ ìµœì í™” ì „ëµìœ¼ë¡œ ì‹ ê·œ í•™ìƒ ìœ ì…ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.
//                         </p>
//                         <div class="space-y-4 mb-8">
//                             <div class="flex items-start">
//                                 <svg class="w-6 h-6 text-purple-600 mt-1 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
//                                     <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
//                                 </svg>
//                                 <div>
//                                     <div class="font-semibold text-gray-900">í‚¤ì›Œë“œ ë¶„ì„ ë° ìµœì í™”</div>
//                                     <div class="text-gray-600 text-sm">í•™ì›ì— ë§ëŠ” ìµœì ì˜ í‚¤ì›Œë“œ ë°œêµ´</div>
//                                 </div>
//                             </div>
//                             <div class="flex items-start">
//                                 <svg class="w-6 h-6 text-purple-600 mt-1 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
//                                     <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
//                                 </svg>
//                                 <div>
//                                     <div class="font-semibold text-gray-900">ë¦¬ë·° ê´€ë¦¬ ì „ëµ</div>
//                                     <div class="text-gray-600 text-sm">ê¸ì •ì ì¸ ë¦¬ë·° í™•ë³´ ë° ê´€ë¦¬</div>
//                                 </div>
//                             </div>
//                             <div class="flex items-start">
//                                 <svg class="w-6 h-6 text-purple-600 mt-1 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
//                                     <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
//                                 </svg>
//                                 <div>
//                                     <div class="font-semibold text-gray-900">ì§€ì—­ SEO ì™„ë²½ ê°€ì´ë“œ</div>
//                                     <div class="text-gray-600 text-sm">ì§€ì—­ ê¸°ë°˜ ê²€ìƒ‰ ìµœì í™”</div>
//                                 </div>
//                             </div>
//                         </div>
//                         <a href="/contact" class="inline-block gradient-purple text-white px-8 py-4 rounded-xl font-medium hover:shadow-xl transition">
//                             ë¬¸ì˜í•˜ê¸°
//                         </a>
//                     </div>
//                     <div class="bg-gradient-to-br from-purple-50 to-white rounded-2xl p-12 border border-purple-100">
//                         <div class="text-6xl mb-6">ğŸ“</div>
//                         <div class="space-y-3 text-gray-700">
//                             <div class="flex justify-between items-center p-4 bg-white rounded-xl">
//                                 <span>êµìœ¡ ê¸°ê°„</span>
//                                 <span class="font-semibold">4ì£¼</span>
//                             </div>
//                             <div class="flex justify-between items-center p-4 bg-white rounded-xl">
//                                 <span>ìˆ˜ê°• ë°©ì‹</span>
//                                 <span class="font-semibold">ì˜¨ë¼ì¸ + ì˜¤í”„ë¼ì¸</span>
//                             </div>
//                             <div class="flex justify-between items-center p-4 bg-white rounded-xl">
//                                 <span>ë‚œì´ë„</span>
//                                 <span class="font-semibold">ì´ˆê¸‰-ì¤‘ê¸‰</span>
//                             </div>
//                         </div>
//                     </div>
//                 </div>
// 
//                 <!-- Program 2 -->
//                 <div class="grid lg:grid-cols-2 gap-12 items-center">
//                     <div class="order-2 lg:order-1">
//                         <div class="bg-gradient-to-br from-orange-50 to-white rounded-2xl p-12 border border-orange-100">
//                             <div class="text-6xl mb-6">ğŸ“</div>
//                             <div class="space-y-3 text-gray-700">
//                                 <div class="flex justify-between items-center p-4 bg-white rounded-xl">
//                                     <span>êµìœ¡ ê¸°ê°„</span>
//                                     <span class="font-semibold">4ì£¼</span>
//                                 </div>
//                                 <div class="flex justify-between items-center p-4 bg-white rounded-xl">
//                                     <span>ìˆ˜ê°• ë°©ì‹</span>
//                                     <span class="font-semibold">ì˜¨ë¼ì¸</span>
//                                 </div>
//                                 <div class="flex justify-between items-center p-4 bg-white rounded-xl">
//                                     <span>ë‚œì´ë„</span>
//                                     <span class="font-semibold">ì´ˆê¸‰-ì¤‘ê¸‰</span>
//                                 </div>
//                             </div>
//                         </div>
//                     </div>
//                     <div class="order-1 lg:order-2">
//                         <div class="inline-block px-4 py-2 bg-orange-100 text-orange-700 rounded-full text-sm font-medium mb-4">í”„ë¡œê·¸ë¨ 02</div>
//                         <h2 class="text-4xl font-bold text-gray-900 mb-6">ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œ</h2>
//                         <p class="text-xl text-gray-600 mb-8">
//                             ë„¤ì´ë²„ ë¸”ë¡œê·¸ ê²€ìƒ‰ ìƒìœ„ê¶Œ ì§„ì… ì „ëµ. SEO ìµœì í™”ë¶€í„° ì½˜í…ì¸  ê¸°íšê¹Œì§€ ì²´ê³„ì ìœ¼ë¡œ í•™ìŠµí•©ë‹ˆë‹¤.
//                         </p>
//                         <div class="space-y-4 mb-8">
//                             <div class="flex items-start">
//                                 <svg class="w-6 h-6 text-orange-500 mt-1 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
//                                     <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
//                                 </svg>
//                                 <div>
//                                     <div class="font-semibold text-gray-900">ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ ì´í•´</div>
//                                     <div class="text-gray-600 text-sm">ë„¤ì´ë²„ ê²€ìƒ‰ ì›ë¦¬ ì™„ë²½ ë§ˆìŠ¤í„°</div>
//                                 </div>
//                             </div>
//                             <div class="flex items-start">
//                                 <svg class="w-6 h-6 text-orange-500 mt-1 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
//                                     <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
//                                 </svg>
//                                 <div>
//                                     <div class="font-semibold text-gray-900">ì½˜í…ì¸  ì‘ì„± ê¸°ë²•</div>
//                                     <div class="text-gray-600 text-sm">íš¨ê³¼ì ì¸ ë¸”ë¡œê·¸ ê¸€ì“°ê¸°</div>
//                                 </div>
//                             </div>
//                             <div class="flex items-start">
//                                 <svg class="w-6 h-6 text-orange-500 mt-1 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
//                                     <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
//                                 </svg>
//                                 <div>
//                                     <div class="font-semibold text-gray-900">íš¨ê³¼ì ì¸ í¬ìŠ¤íŒ… ì „ëµ</div>
//                                     <div class="text-gray-600 text-sm">ì£¼ê¸°ì ì¸ ì½˜í…ì¸  ë°œí–‰ ì „ëµ</div>
//                                 </div>
//                             </div>
//                         </div>
//                         <a href="/contact" class="inline-block gradient-orange text-white px-8 py-4 rounded-xl font-medium hover:shadow-xl transition">
//                             ë¬¸ì˜í•˜ê¸°
//                         </a>
//                     </div>
//                 </div>
// 
//                 <!-- Program 3 -->
//                 <div class="grid lg:grid-cols-2 gap-12 items-center">
//                     <div>
//                         <div class="inline-block px-4 py-2 bg-purple-100 text-purple-700 rounded-full text-sm font-medium mb-4">í”„ë¡œê·¸ë¨ 03</div>
//                         <h2 class="text-4xl font-bold text-gray-900 mb-6">í¼ë„ ë§ˆì¼€íŒ…</h2>
//                         <p class="text-xl text-gray-600 mb-8">
//                             ìƒë‹´ë¶€í„° ë“±ë¡ê¹Œì§€ ìë™í™” ì‹œìŠ¤í…œ êµ¬ì¶•. íš¨ìœ¨ì ì¸ í•™ìƒ ëª¨ì§‘ í”„ë¡œì„¸ìŠ¤ë¥¼ ì™„ì„±í•©ë‹ˆë‹¤.
//                         </p>
//                         <div class="space-y-4 mb-8">
//                             <div class="flex items-start">
//                                 <svg class="w-6 h-6 text-purple-600 mt-1 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
//                                     <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
//                                 </svg>
//                                 <div>
//                                     <div class="font-semibold text-gray-900">ê³ ê° ì—¬ì • ì„¤ê³„</div>
//                                     <div class="text-gray-600 text-sm">ìƒë‹´-ë“±ë¡ê¹Œì§€ í”„ë¡œì„¸ìŠ¤ ìµœì í™”</div>
//                                 </div>
//                             </div>
//                             <div class="flex items-start">
//                                 <svg class="w-6 h-6 text-purple-600 mt-1 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
//                                     <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
//                                 </svg>
//                                 <div>
//                                     <div class="font-semibold text-gray-900">ìë™í™” ë„êµ¬ í™œìš©</div>
//                                     <div class="text-gray-600 text-sm">íš¨ìœ¨ì ì¸ ë§ˆì¼€íŒ… ìë™í™”</div>
//                                 </div>
//                             </div>
//                             <div class="flex items-start">
//                                 <svg class="w-6 h-6 text-purple-600 mt-1 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
//                                     <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
//                                 </svg>
//                                 <div>
//                                     <div class="font-semibold text-gray-900">ì „í™˜ìœ¨ ìµœì í™”</div>
//                                     <div class="text-gray-600 text-sm">ìƒë‹´-ë“±ë¡ ì „í™˜ìœ¨ ê·¹ëŒ€í™”</div>
//                                 </div>
//                             </div>
//                         </div>
//                         <a href="/contact" class="inline-block gradient-purple text-white px-8 py-4 rounded-xl font-medium hover:shadow-xl transition">
//                             ë¬¸ì˜í•˜ê¸°
//                         </a>
//                     </div>
//                     <div class="bg-gradient-to-br from-purple-50 to-white rounded-2xl p-12 border border-purple-100">
//                         <div class="text-6xl mb-6">âš¡</div>
//                         <div class="space-y-3 text-gray-700">
//                             <div class="flex justify-between items-center p-4 bg-white rounded-xl">
//                                 <span>êµìœ¡ ê¸°ê°„</span>
//                                 <span class="font-semibold">6ì£¼</span>
//                             </div>
//                             <div class="flex justify-between items-center p-4 bg-white rounded-xl">
//                                 <span>ìˆ˜ê°• ë°©ì‹</span>
//                                 <span class="font-semibold">ì˜¨ë¼ì¸ + 1:1 ì»¨ì„¤íŒ…</span>
//                             </div>
//                             <div class="flex justify-between items-center p-4 bg-white rounded-xl">
//                                 <span>ë‚œì´ë„</span>
//                                 <span class="font-semibold">ì¤‘ê¸‰-ê³ ê¸‰</span>
//                             </div>
//                         </div>
//                     </div>
//                 </div>
//             </div>
//         </section>
// 
//         <!-- CTA -->
//         <section class="py-24 px-6 gradient-purple">
//             <div class="max-w-4xl mx-auto text-center">
//                 <h2 class="text-4xl lg:text-5xl font-bold text-white mb-6">
//                     ë¬´ë£Œ ìƒë‹´ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”
//                 </h2>
//                 <p class="text-xl text-white/90 mb-10">
//                     ìš°ë¦¬ í•™ì›ì— ë§ëŠ” êµìœ¡ í”„ë¡œê·¸ë¨ì„ ì¶”ì²œí•´ë“œë¦½ë‹ˆë‹¤
//                 </p>
//                 <a href="/contact" class="inline-block bg-white text-purple-600 px-12 py-5 rounded-full text-lg font-medium shadow-xl hover:-translate-y-1 transition">
//                     ë¬´ë£Œ ìƒë‹´ ì‹ ì²­
//                 </a>
//             </div>
//         </section>
//     </body>
//     </html>
//   `)
// })

// í”„ë¡œê·¸ë¨ ëª©ë¡ í˜ì´ì§€
// app.get('/programs', (c) => {
//   return c.html(`
//     <!DOCTYPE html>
//     <html lang="ko">
//     <head>
//         <meta charset="UTF-8">
//         <meta name="viewport" content="width=device-width, initial-scale=1.0">
//         <title>êµìœ¡ í”„ë¡œê·¸ë¨ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
//         <script src="https://cdn.tailwindcss.com"></script>
//         <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
//         <style>
//             .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
//             .gradient-orange { background: linear-gradient(135deg, #fb923c 0%, #f97316 100%); }
//             .card-hover { transition: all 0.3s; }
//             .card-hover:hover { transform: translateY(-4px); }
//         </style>
//     </head>
//     <body class="bg-gray-50">
//         <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
//             <div class="max-w-7xl mx-auto px-6 py-4">
//                 <div class="flex justify-between items-center">
//                     <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
//                     <div class="flex items-center gap-6">
//                         <a href="/" class="text-gray-600 hover:text-purple-600">í™ˆ</a>
//                         <a href="/programs" class="text-purple-600 font-medium">êµìœ¡ í”„ë¡œê·¸ë¨</a>
//                         <a href="/tools" class="text-gray-600 hover:text-purple-600">ë§ˆì¼€íŒ… íˆ´</a>
//                         <a href="/contact" class="text-gray-600 hover:text-purple-600">ë¬¸ì˜í•˜ê¸°</a>
//                     </div>
//                 </div>
//             </div>
//         </nav>
// 
//         <div class="max-w-7xl mx-auto px-6 py-12">
//             <div class="text-center mb-12">
//                 <h1 class="text-5xl font-bold text-gray-900 mb-4">êµìœ¡ í”„ë¡œê·¸ë¨</h1>
//                 <p class="text-xl text-gray-600">ì‹¤ì „ì—ì„œ ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ í•™ì› ë§ˆì¼€íŒ… ì „ëµ</p>
//             </div>
// 
//             <div class="grid md:grid-cols-3 gap-8">
//                 <!-- ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ -->
//                 <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden card-hover">
//                     <div class="h-48 bg-gradient-to-br from-purple-300 to-purple-400 flex items-center justify-center">
//                         <i class="fas fa-map-marker-alt text-white text-6xl"></i>
//                     </div>
//                     <div class="p-8">
//                         <h2 class="text-2xl font-bold text-gray-900 mb-3">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤<br>ìƒìœ„ë…¸ì¶œ</h2>
//                         <p class="text-gray-600 mb-6">ì§€ì—­ ê²€ìƒ‰ 1ìœ„ ë‹¬ì„±ì„ ìœ„í•œ ì‹¤ì „ ë…¸í•˜ìš°</p>
//                         
//                         <div class="space-y-2 mb-6">
//                             <div class="flex items-center text-sm text-gray-700">
//                                 <i class="fas fa-check text-purple-600 mr-2"></i>
//                                 í‚¤ì›Œë“œ ìµœì í™” ì „ëµ
//                             </div>
//                             <div class="flex items-center text-sm text-gray-700">
//                                 <i class="fas fa-check text-purple-600 mr-2"></i>
//                                 ë¦¬ë·° ê´€ë¦¬ ì‹œìŠ¤í…œ
//                             </div>
//                             <div class="flex items-center text-sm text-gray-700">
//                                 <i class="fas fa-check text-purple-600 mr-2"></i>
//                                 ì§€ì—­ SEO ì™„ë²½ ê°€ì´ë“œ
//                             </div>
//                         </div>
// 
//                         <div class="flex items-center justify-between mb-6">
//                             <span class="text-2xl font-bold text-purple-600">â‚©300,000</span>
//                             <span class="text-sm text-gray-500">4ì£¼ ê³¼ì •</span>
//                         </div>
// 
//                         <a href="/programs/naver-place" class="block w-full py-3 text-center gradient-purple text-white rounded-xl font-bold hover:shadow-lg transition">
//                             ìì„¸íˆ ë³´ê¸°
//                         </a>
//                     </div>
//                 </div>
// 
//                 <!-- ë¸”ë¡œê·¸ ë§ˆì¼€íŒ… -->
//                 <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden card-hover">
//                     <div class="h-48 bg-gradient-to-br from-orange-500 to-red-600 flex items-center justify-center">
//                         <i class="fas fa-blog text-white text-6xl"></i>
//                     </div>
//                     <div class="p-8">
//                         <h2 class="text-2xl font-bold text-gray-900 mb-3">ë¸”ë¡œê·¸<br>ìƒìœ„ë…¸ì¶œ</h2>
//                         <p class="text-gray-600 mb-6">ê²€ìƒ‰ ìµœìƒìœ„ ì§„ì…ì„ ìœ„í•œ SEO ì „ëµ</p>
//                         
//                         <div class="space-y-2 mb-6">
//                             <div class="flex items-center text-sm text-gray-700">
//                                 <i class="fas fa-check text-orange-600 mr-2"></i>
//                                 ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ ì™„ë²½ ì´í•´
//                             </div>
//                             <div class="flex items-center text-sm text-gray-700">
//                                 <i class="fas fa-check text-orange-600 mr-2"></i>
//                                 íš¨ê³¼ì ì¸ ê¸€ì“°ê¸° ê¸°ë²•
//                             </div>
//                             <div class="flex items-center text-sm text-gray-700">
//                                 <i class="fas fa-check text-orange-600 mr-2"></i>
//                                 ì½˜í…ì¸  ì „ëµ ìˆ˜ë¦½
//                             </div>
//                         </div>
// 
//                         <div class="flex items-center justify-between mb-6">
//                             <span class="text-2xl font-bold text-orange-600">â‚©250,000</span>
//                             <span class="text-sm text-gray-500">3ì£¼ ê³¼ì •</span>
//                         </div>
// 
//                         <a href="/programs/blog" class="block w-full py-3 text-center gradient-orange text-white rounded-xl font-bold hover:shadow-lg transition">
//                             ìì„¸íˆ ë³´ê¸°
//                         </a>
//                     </div>
//                 </div>
// 
//                 <!-- í¼ë„ ë§ˆì¼€íŒ… -->
//                 <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden card-hover">
//                     <div class="h-48 bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center">
//                         <i class="fas fa-funnel-dollar text-white text-6xl"></i>
//                     </div>
//                     <div class="p-8">
//                         <h2 class="text-2xl font-bold text-gray-900 mb-3">í¼ë„<br>ë§ˆì¼€íŒ…</h2>
//                         <p class="text-gray-600 mb-6">24ì‹œê°„ ìë™ í•™ìƒ ëª¨ì§‘ ì‹œìŠ¤í…œ</p>
//                         
//                         <div class="space-y-2 mb-6">
//                             <div class="flex items-center text-sm text-gray-700">
//                                 <i class="fas fa-check text-purple-600 mr-2"></i>
//                                 ê³ ê° ì—¬ì • ì™„ë²½ ì„¤ê³„
//                             </div>
//                             <div class="flex items-center text-sm text-gray-700">
//                                 <i class="fas fa-check text-purple-600 mr-2"></i>
//                                 ë§ˆì¼€íŒ… ìë™í™” ë„êµ¬
//                             </div>
//                             <div class="flex items-center text-sm text-gray-700">
//                                 <i class="fas fa-check text-purple-600 mr-2"></i>
//                                 ì „í™˜ìœ¨ ê·¹ëŒ€í™” ì „ëµ
//                             </div>
//                         </div>
// 
//                         <div class="flex items-center justify-between mb-6">
//                             <span class="text-2xl font-bold text-purple-600">â‚©400,000</span>
//                             <span class="text-sm text-gray-500">6ì£¼ ê³¼ì •</span>
//                         </div>
// 
//                         <a href="/programs/funnel" class="block w-full py-3 text-center gradient-purple text-white rounded-xl font-bold hover:shadow-lg transition">
//                             ìì„¸íˆ ë³´ê¸°
//                         </a>
//                     </div>
//                 </div>
//             </div>
// 
//             <!-- CTA ì„¹ì…˜ -->
//             <div class="mt-16 bg-gradient-to-r from-purple-600 to-pink-600 rounded-3xl p-12 text-center text-white">
//                 <h2 class="text-4xl font-bold mb-4">ì „ì²´ íŒ¨í‚¤ì§€ë¡œ ë” ì €ë ´í•˜ê²Œ!</h2>
//                 <p class="text-xl mb-8 opacity-90">3ê°œ í”„ë¡œê·¸ë¨ ì „ì²´ ìˆ˜ê°• ì‹œ 30% í• ì¸</p>
//                 <div class="flex items-center justify-center gap-4 mb-8">
//                     <span class="text-3xl line-through opacity-75">â‚©950,000</span>
//                     <span class="text-5xl font-bold">â‚©665,000</span>
//                 </div>
//                 <a href="/contact" class="inline-block bg-white text-purple-600 px-12 py-4 rounded-full text-lg font-bold hover:shadow-2xl transition">
//                     íŒ¨í‚¤ì§€ ë¬¸ì˜í•˜ê¸°
//                 </a>
//             </div>
//         </div>
//     </body>
//     </html>
//   `)
// })

// ì„±ê³µ ì‚¬ë¡€ í˜ì´ì§€
// í”„ë¡œê·¸ë¨ ëª©ë¡ í˜ì´ì§€
app.get('/programs', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>êµìœ¡ ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet">
        <style>
          * { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-50">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-blue-600">SUPER PLACE</a>
                    <div class="flex gap-6 items-center">
                        <a href="/" class="text-gray-600 hover:text-blue-600">í™ˆ</a>
                        <a href="/dashboard" class="text-gray-600 hover:text-blue-600">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="/programs" class="text-blue-600 font-semibold">êµìœ¡ í”„ë¡œê·¸ë¨</a>
                        <a href="/login" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ë¡œê·¸ì¸</a>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Hero Section -->
        <section class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">í•™ì› ì „ë¬¸ ë§ˆì¼€íŒ… ì»¨ì„¤íŒ…</h1>
                <p class="text-xl md:text-2xl text-blue-100 mb-8">ì‹¤ì œ í¬ìŠ¤íŒ…ì˜ ì§‘ì¤‘ ì»¨ì„¤íŒ… ì‹œì‘í•˜ì‹¤ ë§ˆì¼€íŒ…!</p>
                <p class="text-lg text-blue-200">ë§ì¶¤í˜• 1:1 ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨</p>
            </div>
        </section>

        <!-- Products Grid -->
        <section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
            <div id="productsGrid" class="grid md:grid-cols-2 gap-8">
                <!-- í”„ë¡œê·¸ë¨ ì¹´ë“œê°€ ì—¬ê¸° ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-gray-900 text-white py-12 mt-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid md:grid-cols-3 gap-8">
                    <div>
                        <h3 class="text-xl font-bold mb-4">ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</h3>
                        <p class="text-gray-400 text-sm">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 142-88-02445</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">ì£¼ì†Œ</h4>
                        <p class="text-gray-400 text-sm">ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬ ì²­ë¼ì»¤ë‚¼ë¡œ 270, 2ì¸µ</p>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">ë¬¸ì˜</h4>
                        <p class="text-gray-400 text-sm">ì´ë©”ì¼: wangholy1@naver.com</p>
                        <p class="text-gray-400 text-sm">ì „í™”: 010-8739-9697</p>
                    </div>
                </div>
                <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-500 text-sm">
                    Â© 2024 ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤. All rights reserved.
                </div>
            </div>
        </footer>

        <script>
          // í•˜ë“œì½”ë”©ëœ í”„ë¡œê·¸ë¨ ë°ì´í„°
          const programs = [
            {
              program_id: 'naver-place-consulting',
              name: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œ ì»¨ì„¤íŒ…',
              description: 'ì‹¤ì œ í¬ìŠ¤íŒ…ì˜ ì§‘ì¤‘ ì»¨ì„¤íŒ… ì‹œì‘í•˜ì‹¤ ë§ˆì¼€íŒ…!',
              image_url: '/static/images/naver-place-consulting.jpg',
              price: 1210000,
              sessions: 6,
              details: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œì„ ìœ„í•œ 1:1 ë§ì¶¤ ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. 6íšŒì— ê±¸ì³ í”Œë ˆì´ìŠ¤ ë“±ë¡ë¶€í„° ìƒìœ„ë…¸ì¶œ ì „ëµ, ë¦¬ë·° ê´€ë¦¬, í‚¤ì›Œë“œ ìµœì í™”ê¹Œì§€ ì‹¤ì „ ë…¸í•˜ìš°ë¥¼ ì „ìˆ˜ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
              features: ["í”Œë ˆì´ìŠ¤ ìµœì í™” ì „ëµ", "ë¦¬ë·° ê´€ë¦¬ ë…¸í•˜ìš°", "í‚¤ì›Œë“œ ë¶„ì„ ë° íƒ€ê²ŸíŒ…", "ê²½ìŸì‚¬ ë¶„ì„", "ìƒìœ„ë…¸ì¶œ ì‹¤ì „ ê¸°ë²•", "1:1 ë§ì¶¤ ì»¨ì„¤íŒ…"],
              type: 'consulting'
            },
            {
              program_id: 'blog-consulting',
              name: 'ë¸”ë¡œê·¸ 1:1 ì»¨ì„¤íŒ…',
              description: 'ì‹¤ì œ í¬ìŠ¤íŒ…ì˜ ì§‘ì¤‘ ì»¨ì„¤íŒ… ì‹œì‘í•˜ì‹¤ ë§ˆì¼€íŒ…!',
              image_url: '/static/images/blog-consulting.jpg',
              price: 1210000,
              sessions: 6,
              details: 'ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œì„ ìœ„í•œ 1:1 ë§ì¶¤ ì»¨ì„¤íŒ… í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. 6íšŒì— ê±¸ì³ SEO ìµœì í™”, ì½˜í…ì¸  ì‘ì„±ë²•, í‚¤ì›Œë“œ ì „ëµ, ìœ ì… ì¦ëŒ€ ë°©ë²•ê¹Œì§€ ë¸”ë¡œê·¸ ë§ˆì¼€íŒ…ì˜ ëª¨ë“  ê²ƒì„ ë°°ìš°ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
              features: ["SEO ìµœì í™” ì „ëµ", "ì½˜í…ì¸  ê¸°íš ë° ì‘ì„±ë²•", "í‚¤ì›Œë“œ ë¦¬ì„œì¹˜", "ê²€ìƒ‰ ìƒìœ„ë…¸ì¶œ ê¸°ë²•", "ìœ ì… ë¶„ì„ ë° ê°œì„ ", "1:1 ë§ì¶¤ ì»¨ì„¤íŒ…"],
              type: 'consulting'
            },
            {
              program_id: 'landing-page-max',
              name: '(Max) ëœë”©í˜ì´ì§€ ì œì‘',
              description: 'ì „ë¬¸ê°€ê°€ ë§Œë“œëŠ” ê³ í€„ë¦¬í‹° ëœë”©í˜ì´ì§€',
              image_url: '/landing-page-service.jpg',
              price: null,
              sessions: null,
              details: 'í•™ì› ì „ë¬¸ ë§ˆì¼€íŒ… ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ì œì‘í•˜ëŠ” í”„ë¦¬ë¯¸ì—„ ëœë”©í˜ì´ì§€ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. ë°˜ì‘í˜• ë””ìì¸, SEO ìµœì í™”, ê³ ê° ì „í™˜ìœ¨ì„ ê·¹ëŒ€í™”í•œ í˜ì´ì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.',
              features: ["ë°˜ì‘í˜• ì›¹ ë””ìì¸", "SEO ìµœì í™” ì ìš©", "ê³ ê° ì „í™˜ìœ¨ ê·¹ëŒ€í™”", "ë¹ ë¥¸ ë¡œë”© ì†ë„", "ëª¨ë°”ì¼ ìµœì í™”", "ê´€ë¦¬ì í˜ì´ì§€ ì œê³µ", "ë¬´ì œí•œ ìˆ˜ì • ì§€ì›", "í˜¸ìŠ¤íŒ… 1ë…„ ë¬´ë£Œ"],
              type: 'inquiry'
            },
            {
              program_id: 'marketing-agency',
              name: 'í•™ì› ë§ˆì¼€íŒ… ëŒ€í–‰',
              description: 'í•™ì› ì „ë¬¸ ë§ˆì¼€íŒ… ëŒ€í–‰ ì„œë¹„ìŠ¤',
              image_url: '/marketing-agency.jpg',
              price: null,
              sessions: null,
              details: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤, ë¸”ë¡œê·¸, SNS ë“± ë‹¤ì–‘í•œ ì±„ë„ì„ í†µí•œ ì¢…í•© ë§ˆì¼€íŒ… ëŒ€í–‰ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. í•™ì›ì— ìµœì í™”ëœ ë§ˆì¼€íŒ… ì „ëµìœ¼ë¡œ í•™ìƒ ëª¨ì§‘ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.',
              features: ["ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ê´€ë¦¬", "ë¸”ë¡œê·¸ ì½˜í…ì¸  ì‘ì„±", "SNS ë§ˆì¼€íŒ… ëŒ€í–‰", "í‚¤ì›Œë“œ ê´‘ê³  ìš´ì˜", "ì›”ê°„ ë¦¬í¬íŠ¸ ì œê³µ", "ì‹¤ì‹œê°„ ìƒë‹´ ì§€ì›", "ê²½ìŸì‚¬ ë¶„ì„ ë¦¬í¬íŠ¸", "ë§ì¶¤í˜• ë§ˆì¼€íŒ… ì „ëµ"],
              type: 'inquiry'
            }
          ];

          function loadPrograms() {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = programs.map(program => {
              const features = program.features;
              return \`
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-xl transition duration-300">
                  <div class="aspect-w-16 aspect-h-9 bg-gray-200">
                    <img src="\${program.image_url}" alt="\${program.name}" class="w-full h-64 object-cover">
                  </div>
                  <div class="p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-3">\${program.name}</h2>
                    <p class="text-gray-600 mb-4">\${program.description}</p>
                    <div class="mb-6">
                      <p class="text-sm text-gray-700 mb-3 leading-relaxed">\${program.details}</p>
                      <div class="space-y-2">
                        \${features.map(f => \`
                          <div class="flex items-center text-sm text-gray-600">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span>\${f}</span>
                          </div>
                        \`).join('')}
                      </div>
                    </div>
                    <div class="flex items-center justify-between border-t pt-6">
                      <div>
                        \${program.type === 'consulting' ? \`
                          <p class="text-sm text-gray-500">ì´ \${program.sessions}íšŒ ì»¨ì„¤íŒ…</p>
                          <p class="text-3xl font-bold text-blue-600">\${(program.price / 10000).toFixed(0)}ë§Œì›</p>
                        \` : \`
                          <p class="text-sm text-gray-500">ë§ì¶¤í˜• ì„œë¹„ìŠ¤</p>
                          <p class="text-3xl font-bold text-blue-600">ê°€ê²© ë¬¸ì˜</p>
                        \`}
                      </div>
                      <a href="/consulting/\${program.program_id}" 
                         class="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 transition">
                        \${program.type === 'consulting' ? 'ìˆ˜ê°•í•˜ê¸°' : 'ë¬¸ì˜í•˜ê¸°'}
                      </a>
                    </div>
                  </div>
                </div>
              \`;
            }).join('');
          }

          loadPrograms();
        </script>
    </body>
    </html>
  `);
});
app.get('/success', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì„±ê³µ ì‚¬ë¡€ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
        </style>
    </head>
    <body class="bg-white">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <div class="hidden md:flex items-center space-x-10">
                        <a href="/" class="text-gray-700 hover:text-purple-600 font-medium transition">í™ˆ</a>
                        <a href="/programs" class="text-gray-700 hover:text-purple-600 font-medium transition">êµìœ¡ í”„ë¡œê·¸ë¨</a>
                        <a href="/success" class="text-purple-600 font-medium">ì„±ê³µ ì‚¬ë¡€</a>
                        <a href="/contact" class="text-gray-700 hover:text-purple-600 font-medium transition">ë¬¸ì˜í•˜ê¸°</a>
                        <a href="/login" class="gradient-purple text-white px-6 py-2.5 rounded-full font-medium">ë¡œê·¸ì¸</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero -->
        <section class="pt-32 pb-20 px-6">
            <div class="max-w-7xl mx-auto text-center">
                <h1 class="text-5xl lg:text-6xl font-bold text-gray-900 mb-6">ì„±ê³µ ì‚¬ë¡€</h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    500ê°œ ì´ìƒì˜ í•™ì›ì´ ìš°ë¦¬ì™€ í•¨ê»˜ ì„±ì¥í–ˆìŠµë‹ˆë‹¤
                </p>
            </div>
        </section>

        <!-- Success Stories -->
        <section class="pb-24 px-6">
            <div class="max-w-7xl mx-auto grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Story 1 -->
                <div class="bg-gradient-to-br from-purple-50 to-white rounded-2xl p-8 border border-purple-100">
                    <div class="flex items-start gap-4 mb-6">
                        <svg class="w-10 h-10 text-purple-600 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
                        </svg>
                        <div>
                            <div class="text-3xl font-bold text-purple-600 mb-2">2ë°°</div>
                            <div class="text-sm text-gray-600">ì‹ ê·œ ë¬¸ì˜ ì¦ê°€</div>
                        </div>
                    </div>
                    <p class="text-gray-700 mb-6 leading-relaxed">
                        í”Œë ˆì´ìŠ¤ ë§ˆì¼€íŒ… êµìœ¡ì„ ë°›ì€ í›„ 3ê°œì›” ë§Œì— ì‹ ê·œ ë¬¸ì˜ê°€ 2ë°° ì´ìƒ ëŠ˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì „ ë…¸í•˜ìš°ê°€ ì •ë§ ëŒ€ë‹¨í•©ë‹ˆë‹¤!
                    </p>
                    <div class="flex items-center gap-3 pt-4 border-t border-purple-100">
                        <div class="w-12 h-12 gradient-purple rounded-xl flex items-center justify-center text-white font-bold">ê¹€</div>
                        <div>
                            <div class="font-bold text-gray-900">ê¹€OO ì›ì¥ë‹˜</div>
                            <div class="text-sm text-gray-600">ì„œìš¸ ê°•ë‚¨êµ¬ ì˜ì–´í•™ì›</div>
                        </div>
                    </div>
                </div>

                <!-- Story 2 -->
                <div class="bg-gradient-to-br from-orange-50 to-white rounded-2xl p-8 border border-orange-100">
                    <div class="flex items-start gap-4 mb-6">
                        <svg class="w-10 h-10 text-orange-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
                        </svg>
                        <div>
                            <div class="text-3xl font-bold text-orange-500 mb-2">1ìœ„</div>
                            <div class="text-sm text-gray-600">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤</div>
                        </div>
                    </div>
                    <p class="text-gray-700 mb-6 leading-relaxed">
                        í‚¤ì›Œë“œ ë¶„ì„ê³¼ ë¦¬ë·° ê´€ë¦¬ ì „ëµì„ ë°°ìš´ í›„ ìš°ë¦¬ í•™ì›ì´ ì§€ì—­ ê²€ìƒ‰ 1ìœ„ì— ì˜¬ëì–´ìš”. ë“±ë¡ ë¬¸ì˜ê°€ ëŠì´ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    </p>
                    <div class="flex items-center gap-3 pt-4 border-t border-orange-100">
                        <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-orange-500 rounded-xl flex items-center justify-center text-white font-bold">ë°•</div>
                        <div>
                            <div class="font-bold text-gray-900">ë°•OO ì›ì¥ë‹˜</div>
                            <div class="text-sm text-gray-600">ë¶€ì‚° í•´ìš´ëŒ€êµ¬ ìˆ˜í•™í•™ì›</div>
                        </div>
                    </div>
                </div>

                <!-- Story 3 -->
                <div class="bg-gradient-to-br from-purple-50 to-white rounded-2xl p-8 border border-purple-100">
                    <div class="flex items-start gap-4 mb-6">
                        <svg class="w-10 h-10 text-purple-600 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
                        </svg>
                        <div>
                            <div class="text-3xl font-bold text-purple-600 mb-2">3ë°°</div>
                            <div class="text-sm text-gray-600">ë¸”ë¡œê·¸ ìœ ì…</div>
                        </div>
                    </div>
                    <p class="text-gray-700 mb-6 leading-relaxed">
                        ë¸”ë¡œê·¸ ë§ˆì¼€íŒ… ê°•ì˜ë¥¼ ë“£ê³  ì½˜í…ì¸  ì „ëµì„ ë°”ê¿¨ë”ë‹ˆ ë¸”ë¡œê·¸ ìœ ì…ì´ 3ë°°ë¡œ ëŠ˜ì—ˆìŠµë‹ˆë‹¤. í•™ë¶€ëª¨ë‹˜ë“¤ì˜ ì‹ ë¢°ë„ ë†’ì•„ì¡Œì–´ìš”.
                    </p>
                    <div class="flex items-center gap-3 pt-4 border-t border-purple-100">
                        <div class="w-12 h-12 gradient-purple rounded-xl flex items-center justify-center text-white font-bold">ì´</div>
                        <div>
                            <div class="font-bold text-gray-900">ì´OO ì›ì¥ë‹˜</div>
                            <div class="text-sm text-gray-600">ëŒ€ì „ ìœ ì„±êµ¬ ì˜ì–´í•™ì›</div>
                        </div>
                    </div>
                </div>

                <!-- Story 4 -->
                <div class="bg-gradient-to-br from-orange-50 to-white rounded-2xl p-8 border border-orange-100">
                    <div class="flex items-start gap-4 mb-6">
                        <svg class="w-10 h-10 text-orange-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
                        </svg>
                        <div>
                            <div class="text-3xl font-bold text-orange-500 mb-2">40%</div>
                            <div class="text-sm text-gray-600">ì „í™˜ìœ¨ ìƒìŠ¹</div>
                        </div>
                    </div>
                    <p class="text-gray-700 mb-6 leading-relaxed">
                        í¼ë„ ë§ˆì¼€íŒ… ì‹œìŠ¤í…œì„ êµ¬ì¶•í•œ í›„ ìƒë‹´-ë“±ë¡ ì „í™˜ìœ¨ì´ 40% ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤. ìë™í™”ë¡œ ì—…ë¬´ íš¨ìœ¨ë„ í¬ê²Œ ê°œì„ ëì–´ìš”.
                    </p>
                    <div class="flex items-center gap-3 pt-4 border-t border-orange-100">
                        <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-orange-500 rounded-xl flex items-center justify-center text-white font-bold">ìµœ</div>
                        <div>
                            <div class="font-bold text-gray-900">ìµœOO ì›ì¥ë‹˜</div>
                            <div class="text-sm text-gray-600">ì¸ì²œ ì„œêµ¬ ì¢…í•©í•™ì›</div>
                        </div>
                    </div>
                </div>

                <!-- Story 5 -->
                <div class="bg-gradient-to-br from-purple-50 to-white rounded-2xl p-8 border border-purple-100">
                    <div class="flex items-start gap-4 mb-6">
                        <svg class="w-10 h-10 text-purple-600 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
                        </svg>
                        <div>
                            <div class="text-3xl font-bold text-purple-600 mb-2">50ëª…</div>
                            <div class="text-sm text-gray-600">ì‹ ê·œ ë“±ë¡</div>
                        </div>
                    </div>
                    <p class="text-gray-700 mb-6 leading-relaxed">
                        êµìœ¡ ì´ìˆ˜ í›„ 6ê°œì›” ë§Œì— ì‹ ê·œ ë“±ë¡ í•™ìƒì´ 50ëª… ëŠ˜ì—ˆìŠµë‹ˆë‹¤. í•™ì› ìš´ì˜ì´ ì•ˆì •í™”ë˜ê³  ë§¤ì¶œë„ í¬ê²Œ ì¦ê°€í–ˆì–´ìš”.
                    </p>
                    <div class="flex items-center gap-3 pt-4 border-t border-purple-100">
                        <div class="w-12 h-12 gradient-purple rounded-xl flex items-center justify-center text-white font-bold">ì •</div>
                        <div>
                            <div class="font-bold text-gray-900">ì •OO ì›ì¥ë‹˜</div>
                            <div class="text-sm text-gray-600">ê´‘ì£¼ ë¶êµ¬ ì˜ì–´í•™ì›</div>
                        </div>
                    </div>
                </div>

                <!-- Story 6 -->
                <div class="bg-gradient-to-br from-orange-50 to-white rounded-2xl p-8 border border-orange-100">
                    <div class="flex items-start gap-4 mb-6">
                        <svg class="w-10 h-10 text-orange-500 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h3.983v10h-9.983z"/>
                        </svg>
                        <div>
                            <div class="text-3xl font-bold text-orange-500 mb-2">95%</div>
                            <div class="text-sm text-gray-600">ì¬ë“±ë¡ë¥ </div>
                        </div>
                    </div>
                    <p class="text-gray-700 mb-6 leading-relaxed">
                        ë§ˆì¼€íŒ… ìë™í™”ì™€ í•™ë¶€ëª¨ ì†Œí†µ ì „ëµì„ ë°°ìš´ í›„ ì¬ë“±ë¡ë¥ ì´ 95%ë¡œ ì˜¬ëìŠµë‹ˆë‹¤. í•™ìƒ ê´€ë¦¬ë„ í›¨ì”¬ ì²´ê³„ì ì´ì—ìš”.
                    </p>
                    <div class="flex items-center gap-3 pt-4 border-t border-orange-100">
                        <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-orange-500 rounded-xl flex items-center justify-center text-white font-bold">ê°•</div>
                        <div>
                            <div class="font-bold text-gray-900">ê°•OO ì›ì¥ë‹˜</div>
                            <div class="text-sm text-gray-600">ìˆ˜ì› ì˜í†µêµ¬ ìˆ˜í•™í•™ì›</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats -->
        <section class="py-24 px-6 bg-gray-50">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl font-bold text-gray-900 mb-4">ìˆ«ìë¡œ ë³´ëŠ” ì„±ê³¼</h2>
                    <p class="text-xl text-gray-600">ë°ì´í„°ê°€ ì¦ëª…í•˜ëŠ” í™•ì‹¤í•œ íš¨ê³¼</p>
                </div>
                <div class="grid md:grid-cols-4 gap-8">
                    <div class="text-center">
                        <div class="text-5xl font-bold text-purple-600 mb-2">500+</div>
                        <div class="text-gray-600">êµìœ¡ ìˆ˜ë£Œ í•™ì›</div>
                    </div>
                    <div class="text-center">
                        <div class="text-5xl font-bold text-purple-600 mb-2">95%</div>
                        <div class="text-gray-600">ë§Œì¡±ë„</div>
                    </div>
                    <div class="text-center">
                        <div class="text-5xl font-bold text-purple-600 mb-2">2.5ë°°</div>
                        <div class="text-gray-600">í‰ê·  ë¬¸ì˜ ì¦ê°€</div>
                    </div>
                    <div class="text-center">
                        <div class="text-5xl font-bold text-purple-600 mb-2">85%</div>
                        <div class="text-gray-600">ì¬ìˆ˜ê°•ë¥ </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- FAQ Section -->
        <section class="py-24 px-6 bg-gray-50">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-4">ìì£¼ ë¬»ëŠ” ì§ˆë¬¸</h2>
                    <p class="text-xl text-gray-600">í•™ì›ì¥ë‹˜ë“¤ì´ ê°€ì¥ ê¶ê¸ˆí•´í•˜ì‹œëŠ” ì§ˆë¬¸ë“¤ì…ë‹ˆë‹¤</p>
                </div>
                
                <div class="space-y-4">
                    <details class="bg-white rounded-2xl border border-gray-200 overflow-hidden group">
                        <summary class="px-8 py-6 cursor-pointer font-bold text-lg text-gray-900 hover:text-purple-600 transition flex items-center justify-between">
                            <span>ğŸ’° êµìœ¡ ë¹„ìš©ì€ ì–¼ë§ˆì¸ê°€ìš”?</span>
                            <svg class="w-6 h-6 transform group-open:rotate-180 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </summary>
                        <div class="px-8 pb-6 text-gray-600">
                            <p class="mb-4">í”„ë¡œê·¸ë¨ë³„ë¡œ ìƒì´í•˜ë©°, ë¬´ë£Œ ìƒë‹´ì„ í†µí•´ í•™ì› ê·œëª¨ì™€ ëª©í‘œì— ë§ëŠ” ë§ì¶¤ ê²¬ì ì„ ì œê³µí•´ë“œë¦½ë‹ˆë‹¤.</p>
                            <p class="text-sm text-purple-600">í‰ê·  ROI: 340% (íˆ¬ì ëŒ€ë¹„ 3.4ë°° ìˆ˜ìµ)</p>
                        </div>
                    </details>

                    <details class="bg-white rounded-2xl border border-gray-200 overflow-hidden group">
                        <summary class="px-8 py-6 cursor-pointer font-bold text-lg text-gray-900 hover:text-purple-600 transition flex items-center justify-between">
                            <span>â±ï¸ íš¨ê³¼ë¥¼ ë³´ê¸°ê¹Œì§€ ì–¼ë§ˆë‚˜ ê±¸ë¦¬ë‚˜ìš”?</span>
                            <svg class="w-6 h-6 transform group-open:rotate-180 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </summary>
                        <div class="px-8 pb-6 text-gray-600">
                            <p class="mb-2">â€¢ <strong>ì¦‰ì‹œ íš¨ê³¼</strong>: í•™ë¶€ëª¨ ì†Œí†µ ê°œì„  (1ì£¼ì¼ ë‚´)</p>
                            <p class="mb-2">â€¢ <strong>ë‹¨ê¸° íš¨ê³¼</strong>: ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë¬¸ì˜ ì¦ê°€ (2~4ì£¼)</p>
                            <p>â€¢ <strong>ì¥ê¸° íš¨ê³¼</strong>: ë¸”ë¡œê·¸ ìœ ì… ì¦ê°€, ë¸Œëœë“œ ì¸ì§€ë„ ìƒìŠ¹ (3ê°œì›”~)</p>
                        </div>
                    </details>

                    <details class="bg-white rounded-2xl border border-gray-200 overflow-hidden group">
                        <summary class="px-8 py-6 cursor-pointer font-bold text-lg text-gray-900 hover:text-purple-600 transition flex items-center justify-between">
                            <span>ğŸ¯ ì»´í“¨í„°ë¥¼ ì˜ ëª» ë‹¤ë¤„ë„ ê´œì°®ë‚˜ìš”?</span>
                            <svg class="w-6 h-6 transform group-open:rotate-180 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </summary>
                        <div class="px-8 pb-6 text-gray-600">
                            <p class="mb-4">ë„¤! ì „í˜€ ê±±ì •í•˜ì§€ ì•Šìœ¼ì…”ë„ ë©ë‹ˆë‹¤. ì €í¬ êµìœ¡ì€ ì´ˆë³´ìë„ ì‰½ê²Œ ë”°ë¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                            <ul class="space-y-2 text-sm">
                                <li>âœ“ 1:1 ë§ì¶¤ ì§€ë„</li>
                                <li>âœ“ ë‹¨ê³„ë³„ ì˜ìƒ ê°•ì˜</li>
                                <li>âœ“ 24ì‹œê°„ ì¹´ì¹´ì˜¤í†¡ ì§€ì›</li>
                            </ul>
                        </div>
                    </details>

                    <details class="bg-white rounded-2xl border border-gray-200 overflow-hidden group">
                        <summary class="px-8 py-6 cursor-pointer font-bold text-lg text-gray-900 hover:text-purple-600 transition flex items-center justify-between">
                            <span>ğŸ« ì–´ë–¤ í•™ì›ì— ì í•©í•œê°€ìš”?</span>
                            <svg class="w-6 h-6 transform group-open:rotate-180 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </summary>
                        <div class="px-8 pb-6 text-gray-600">
                            <p class="mb-4">ëª¨ë“  ê·œëª¨ì˜ í•™ì›ì— ì í•©í•©ë‹ˆë‹¤:</p>
                            <ul class="space-y-2">
                                <li>â€¢ ì˜ì–´í•™ì›, ìˆ˜í•™í•™ì›, ì¢…í•©í•™ì›</li>
                                <li>â€¢ ì†Œê·œëª¨ ê°œì¸í•™ì› ~ ëŒ€í˜• í”„ëœì°¨ì´ì¦ˆ</li>
                                <li>â€¢ ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ í•™ì› ëª¨ë‘ ê°€ëŠ¥</li>
                            </ul>
                        </div>
                    </details>

                    <details class="bg-white rounded-2xl border border-gray-200 overflow-hidden group">
                        <summary class="px-8 py-6 cursor-pointer font-bold text-lg text-gray-900 hover:text-purple-600 transition flex items-center justify-between">
                            <span>ğŸ“± ì˜¤í”„ë¼ì¸ ëª¨ì„ë„ ìˆë‚˜ìš”?</span>
                            <svg class="w-6 h-6 transform group-open:rotate-180 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </summary>
                        <div class="px-8 pb-6 text-gray-600">
                            <p class="mb-4">ë„¤! ì •ê¸°ì ìœ¼ë¡œ ì˜¤í”„ë¼ì¸ ì›Œí¬ìƒµê³¼ ë„¤íŠ¸ì›Œí‚¹ ëª¨ì„ì„ ì§„í–‰í•©ë‹ˆë‹¤.</p>
                            <p class="text-sm text-purple-600">â€¢ ì›” 1íšŒ ì˜¤í”„ë¼ì¸ íŠ¹ê°• (ì¸ì²œ/ì„œìš¸)</p>
                            <p class="text-sm text-purple-600">â€¢ ì—° 2íšŒ ì „êµ­ í•™ì›ì¥ ì»¨í¼ëŸ°ìŠ¤</p>
                        </div>
                    </details>

                    <details class="bg-white rounded-2xl border border-gray-200 overflow-hidden group">
                        <summary class="px-8 py-6 cursor-pointer font-bold text-lg text-gray-900 hover:text-purple-600 transition flex items-center justify-between">
                            <span>ğŸ”„ í™˜ë¶ˆ ì •ì±…ì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?</span>
                            <svg class="w-6 h-6 transform group-open:rotate-180 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </summary>
                        <div class="px-8 pb-6 text-gray-600">
                            <p class="mb-4">êµìœ¡ ì‹œì‘ í›„ 7ì¼ ì´ë‚´ 100% í™˜ë¶ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                            <p class="text-sm text-gray-500">ë§Œì¡±ë„ 95% ì´ìƒ! ëŒ€ë¶€ë¶„ì˜ í•™ì›ì¥ë‹˜ë“¤ì´ ë§Œì¡±í•˜ì‹œê³  ì¬êµ¬ë§¤í•˜ì‹­ë‹ˆë‹¤.</p>
                        </div>
                    </details>
                </div>

                <div class="mt-12 text-center">
                    <p class="text-gray-600 mb-6">ë” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹ ê°€ìš”?</p>
                    <a href="/contact" class="inline-block bg-purple-600 text-white px-8 py-4 rounded-full font-medium hover:bg-purple-700 transition">
                        1:1 ë¬´ë£Œ ìƒë‹´ ì‹ ì²­í•˜ê¸°
                    </a>
                </div>
            </div>
        </section>

        <!-- Customer Reviews Slider -->
        <section class="py-24 px-6 bg-white">
            <div class="max-w-6xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-4">ì‹¤ì œ í›„ê¸°</h2>
                    <p class="text-xl text-gray-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ì™€ í•¨ê»˜í•œ í•™ì›ì¥ë‹˜ë“¤ì˜ ìƒìƒí•œ í›„ê¸°ì…ë‹ˆë‹¤</p>
                </div>

                <div class="grid md:grid-cols-3 gap-8">
                    <!-- Review 1 -->
                    <div class="bg-gradient-to-br from-purple-50 to-white p-8 rounded-2xl border border-purple-100 hover:shadow-xl transition">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xl">ê¹€</div>
                            <div class="ml-4">
                                <div class="font-bold text-gray-900">ê¹€ì§€ìˆ˜ ì›ì¥ë‹˜</div>
                                <div class="text-sm text-gray-600">ì¸ì²œ ë¶€í‰êµ¬ ì˜ì–´í•™ì›</div>
                            </div>
                        </div>
                        <div class="text-yellow-500 mb-4">â˜…â˜…â˜…â˜…â˜…</div>
                        <p class="text-gray-700 mb-4">"ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ êµìœ¡ ë°›ê³  í•œ ë‹¬ ë§Œì— ë¬¸ì˜ê°€ 3ë°° ëŠ˜ì—ˆì–´ìš”! ì‹¤ì œë¡œ íš¨ê³¼ê°€ ìˆëŠ” ë§ˆì¼€íŒ…ì„ ë°°ìš¸ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤."</p>
                        <div class="text-sm text-purple-600 font-medium">ë¬¸ì˜ ìˆ˜ 3ë°° ì¦ê°€ â†‘</div>
                    </div>

                    <!-- Review 2 -->
                    <div class="bg-gradient-to-br from-orange-50 to-white p-8 rounded-2xl border border-orange-100 hover:shadow-xl transition">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center text-white font-bold text-xl">ë°•</div>
                            <div class="ml-4">
                                <div class="font-bold text-gray-900">ë°•ë¯¼ì¤€ ì›ì¥ë‹˜</div>
                                <div class="text-sm text-gray-600">ì„œìš¸ ê°•ë‚¨êµ¬ ìˆ˜í•™í•™ì›</div>
                            </div>
                        </div>
                        <div class="text-yellow-500 mb-4">â˜…â˜…â˜…â˜…â˜…</div>
                        <p class="text-gray-700 mb-4">"ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œ ì „ëµì„ ë°°ìš°ê³  ê²€ìƒ‰ ìœ ì…ì´ í­ë°œì ìœ¼ë¡œ ëŠ˜ì—ˆìŠµë‹ˆë‹¤. íˆ¬ì ëŒ€ë¹„ ìµœê³ ì˜ ì„ íƒì´ì—ˆì–´ìš”!"</p>
                        <div class="text-sm text-orange-600 font-medium">ë¸”ë¡œê·¸ ìœ ì… 500% ì¦ê°€ â†‘</div>
                    </div>

                    <!-- Review 3 -->
                    <div class="bg-gradient-to-br from-purple-50 to-white p-8 rounded-2xl border border-purple-100 hover:shadow-xl transition">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xl">ì´</div>
                            <div class="ml-4">
                                <div class="font-bold text-gray-900">ì´ì„œì—° ì›ì¥ë‹˜</div>
                                <div class="text-sm text-gray-600">ì¸ì²œ ì„œêµ¬ ì¢…í•©í•™ì›</div>
                            </div>
                        </div>
                        <div class="text-yellow-500 mb-4">â˜…â˜…â˜…â˜…â˜…</div>
                        <p class="text-gray-700 mb-4">"í•™ë¶€ëª¨ ì†Œí†µ ì‹œìŠ¤í…œ ë•ë¶„ì— ì¬ìˆ˜ê°•ë¥ ì´ í¬ê²Œ ì˜¬ëì–´ìš”. ì‹¤ì „ì—ì„œ ë°”ë¡œ ì¨ë¨¹ì„ ìˆ˜ ìˆëŠ” ë…¸í•˜ìš°ê°€ ìµœê³ ì…ë‹ˆë‹¤!"</p>
                        <div class="text-sm text-purple-600 font-medium">ì¬ìˆ˜ê°•ë¥  20% ì¦ê°€ â†‘</div>
                    </div>
                </div>

                <div class="mt-12 text-center">
                    <a href="/success" class="inline-block text-purple-600 font-medium hover:underline">
                        ë” ë§ì€ ì„±ê³µ ì‚¬ë¡€ ë³´ê¸° â†’
                    </a>
                </div>
            </div>
        </section>

        <!-- CTA -->
        <section class="py-24 px-6 gradient-purple">
            <div class="max-w-4xl mx-auto text-center">
                <h2 class="text-4xl lg:text-5xl font-bold text-white mb-6">
                    ë‹¤ìŒ ì„±ê³µ ì‚¬ë¡€ì˜ ì£¼ì¸ê³µì€ ì›ì¥ë‹˜ì…ë‹ˆë‹¤
                </h2>
                <p class="text-xl text-white/90 mb-10">
                    ì§€ê¸ˆ ë°”ë¡œ ì‹œì‘í•˜ì„¸ìš”
                </p>
                <a href="/contact" class="inline-block bg-white text-purple-600 px-12 py-5 rounded-full text-lg font-medium shadow-xl hover:-translate-y-1 transition">
                    ë¬´ë£Œ ìƒë‹´ ì‹ ì²­
                </a>
            </div>
        </section>
    </body>
    </html>
  `)
})

// í•™ì›ì¥ ì „ìš© ë¦¬ì†ŒìŠ¤ í˜ì´ì§€
app.get('/resources', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë§ˆì¼€íŒ… ë¦¬ì†ŒìŠ¤ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
          .resource-card:hover {
            transform: translateY(-4px);
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100 shadow-sm">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">ìŠˆí¼í”Œë ˆì´ìŠ¤</span>
                    </a>
                    <div class="flex items-center space-x-6">
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="/resources" class="text-purple-600 font-medium">ë¦¬ì†ŒìŠ¤</a>
                        <a href="/success" class="text-gray-600 hover:text-purple-600">ì„±ê³µì‚¬ë¡€</a>
                        <a href="/about" class="text-gray-600 hover:text-purple-600">íšŒì‚¬ì†Œê°œ</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero -->
        <div class="pt-24 pb-12 px-6 gradient-purple">
            <div class="max-w-7xl mx-auto text-center">
                <h1 class="text-4xl lg:text-5xl font-bold text-white mb-4">í•™ì› ë§ˆì¼€íŒ… ë¦¬ì†ŒìŠ¤</h1>
                <p class="text-xl text-white/90">ì‹¤ì „ì—ì„œ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸ì™€ ê°€ì´ë“œ</p>
            </div>
        </div>

        <!-- Resources Content -->
        <div class="py-12 px-6">
            <div class="max-w-7xl mx-auto">
                
                <!-- ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
                <section class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-900 mb-8">ğŸ“ ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
                    <div class="bg-white rounded-2xl p-8 border border-gray-200 resource-card transition">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-xl font-bold text-purple-600 mb-4">ê¸°ë³¸ ì •ë³´ ì™„ì„±ë„</h3>
                                <ul class="space-y-3 text-gray-700">
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">âœ“</span>
                                        <span><strong>í•™ì›ëª…:</strong> ì§€ì—­ëª… + ê³¼ëª© í¬í•¨ (ì˜ˆ: ì¸ì²œì„œêµ¬ì˜ì–´í•™ì›)</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">âœ“</span>
                                        <span><strong>ì¹´í…Œê³ ë¦¬:</strong> ì •í™•í•œ ì—…ì¢… ë¶„ë¥˜ (í•™ì› > ì˜ì–´í•™ì›)</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">âœ“</span>
                                        <span><strong>ì˜ì—…ì‹œê°„:</strong> ì •í™•í•œ ì‹œê°„ëŒ€ ì…ë ¥ (ë³€ë™ ì‹œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸)</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">âœ“</span>
                                        <span><strong>ì „í™”ë²ˆí˜¸:</strong> í´ë¦­ í†µí™” ê°€ëŠ¥í•œ ë²ˆí˜¸</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">âœ“</span>
                                        <span><strong>ì£¼ì†Œ:</strong> ì •í™•í•œ ì£¼ì†Œ + ìƒì„¸ ìœ„ì¹˜ (ê±´ë¬¼ëª…, ì¸µìˆ˜)</span>
                                    </li>
                                </ul>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-purple-600 mb-4">ì½˜í…ì¸  & ì´ë¯¸ì§€</h3>
                                <ul class="space-y-3 text-gray-700">
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">âœ“</span>
                                        <span><strong>ëŒ€í‘œ ì‚¬ì§„:</strong> ë°ê³  ê¹¨ë—í•œ í•™ì› ì „ê²½ (ìµœì†Œ 10ì¥)</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">âœ“</span>
                                        <span><strong>ê°•ì˜ì‹¤ ì‚¬ì§„:</strong> í•™ìŠµ í™˜ê²½ì´ ì˜ ë³´ì´ëŠ” ì‚¬ì§„</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">âœ“</span>
                                        <span><strong>ë©”ë‰´/ê°€ê²©:</strong> ê°•ì¢Œë³„ ìƒì„¸ ê°€ê²©í‘œ ë“±ë¡</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">âœ“</span>
                                        <span><strong>ì†Œê°œê¸€:</strong> 500ì ì´ìƒ, í‚¤ì›Œë“œ 3íšŒ ì´ìƒ í¬í•¨</span>
                                    </li>
                                    <li class="flex items-start">
                                        <span class="text-green-500 mr-2">âœ“</span>
                                        <span><strong>í¬ìŠ¤íŒ…:</strong> ì£¼ 2íšŒ ì´ìƒ ì—…ë°ì´íŠ¸</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="mt-8 p-6 bg-purple-50 rounded-xl">
                            <h4 class="font-bold text-purple-900 mb-3">ğŸ¯ ë¦¬ë·° ê´€ë¦¬ ì „ëµ</h4>
                            <ul class="space-y-2 text-gray-700">
                                <li>â€¢ <strong>ë¦¬ë·° ìš”ì²­:</strong> ìˆ˜ì—… ì¢…ë£Œ í›„ ë§Œì¡±ë„ ë†’ì„ ë•Œ ìš”ì²­</li>
                                <li>â€¢ <strong>ë¹ ë¥¸ ë‹µë³€:</strong> ëª¨ë“  ë¦¬ë·°ì— 24ì‹œê°„ ë‚´ ë‹µë³€</li>
                                <li>â€¢ <strong>ë¶€ì • ë¦¬ë·°:</strong> ê°ì •ì  ëŒ€ì‘ ê¸ˆì§€, ê°œì„  ì˜ì§€ í‘œí˜„</li>
                                <li>â€¢ <strong>ëª©í‘œ:</strong> ì›” 5ê°œ ì´ìƒ ì‹ ê·œ ë¦¬ë·° í™•ë³´</li>
                            </ul>
                        </div>

                        <div class="mt-6 text-center">
                            <button onclick="downloadChecklist('naver')" class="bg-purple-600 text-white px-8 py-3 rounded-full font-medium hover:bg-purple-700 transition">
                                ì²´í¬ë¦¬ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ (PDF)
                            </button>
                        </div>
                    </div>
                </section>

                <!-- ë¸”ë¡œê·¸ í‚¤ì›Œë“œ -->
                <section class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-900 mb-8">ğŸ“ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… í‚¤ì›Œë“œ ì¶”ì²œ</h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- ì˜ì–´í•™ì› í‚¤ì›Œë“œ -->
                        <div class="bg-white rounded-2xl p-8 border border-gray-200 resource-card transition">
                            <h3 class="text-xl font-bold text-orange-600 mb-4">ì˜ì–´í•™ì› í‚¤ì›Œë“œ</h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="text-sm text-gray-600 mb-2">ğŸ”¥ í•« í‚¤ì›Œë“œ (ê²€ìƒ‰ëŸ‰ ë†’ìŒ)</div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm">ì´ˆë“±ì˜ì–´í•™ì›</span>
                                        <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm">ì¤‘ë“±ì˜ì–´ë‚´ì‹ </span>
                                        <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm">ì˜ì–´íšŒí™”í•™ì›</span>
                                        <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm">íŒŒë‹‰ìŠ¤</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600 mb-2">ğŸ’ ë¡±í…Œì¼ í‚¤ì›Œë“œ (ê²½ìŸ ë‚®ìŒ)</div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">ì¸ì²œì„œêµ¬ì˜ì–´í•™ì›ì¶”ì²œ</span>
                                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">ì´ˆë“±ì˜ì–´ê³µë¶€ë²•</span>
                                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">ì˜ì–´í•™ì›ì„ íƒê¸°ì¤€</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ìˆ˜í•™í•™ì› í‚¤ì›Œë“œ -->
                        <div class="bg-white rounded-2xl p-8 border border-gray-200 resource-card transition">
                            <h3 class="text-xl font-bold text-purple-600 mb-4">ìˆ˜í•™í•™ì› í‚¤ì›Œë“œ</h3>
                            <div class="space-y-4">
                                <div>
                                    <div class="text-sm text-gray-600 mb-2">ğŸ”¥ í•« í‚¤ì›Œë“œ (ê²€ìƒ‰ëŸ‰ ë†’ìŒ)</div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">ì´ˆë“±ìˆ˜í•™í•™ì›</span>
                                        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">ì¤‘ë“±ìˆ˜í•™ë‚´ì‹ </span>
                                        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">ê³ ë“±ìˆ˜í•™</span>
                                        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">ìˆ˜í•™í•™ì›ë¹„êµ</span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600 mb-2">ğŸ’ ë¡±í…Œì¼ í‚¤ì›Œë“œ (ê²½ìŸ ë‚®ìŒ)</div>
                                    <div class="flex flex-wrap gap-2">
                                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">ìˆ˜í•™ê°œë…í•™ì›</span>
                                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">ì´ˆë“±ìˆ˜í•™ë¬¸ì œì§‘ì¶”ì²œ</span>
                                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">ìˆ˜í•™ì„ í–‰í•™ìŠµ</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- í•™ë¶€ëª¨ ì†Œí†µ ì˜ˆì‹œ -->
                <section class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-900 mb-8">ğŸ’¬ í•™ë¶€ëª¨ ì†Œí†µ ì˜ˆì‹œ ë¬¸êµ¬</h2>
                    <div class="bg-white rounded-2xl p-8 border border-gray-200 resource-card transition">
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="p-6 bg-green-50 rounded-xl">
                                <h4 class="font-bold text-green-900 mb-3">ğŸ“ˆ ì„±ì  í–¥ìƒ ì‹œ</h4>
                                <p class="text-sm text-gray-700">"í•™ë¶€ëª¨ë‹˜, ì´ë²ˆ ëª¨ì˜ê³ ì‚¬ì—ì„œ ìˆ˜í•™ ë“±ê¸‰ì´ 3ë“±ê¸‰ì—ì„œ 1ë“±ê¸‰ìœ¼ë¡œ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤! ê¾¸ì¤€íˆ ë…¸ë ¥í•œ ê²°ê³¼ê°€ ë“œëŸ¬ë‚˜ê³  ìˆìŠµë‹ˆë‹¤."</p>
                            </div>
                            <div class="p-6 bg-blue-50 rounded-xl">
                                <h4 class="font-bold text-blue-900 mb-3">ğŸ¯ í•™ìŠµ íƒœë„ ê°œì„ </h4>
                                <p class="text-sm text-gray-700">"ìµœê·¼ ìˆ˜ì—… ì°¸ì—¬ë„ê°€ ëˆˆì— ë„ê²Œ ì¢‹ì•„ì¡ŒìŠµë‹ˆë‹¤. ì§ˆë¬¸ë„ ì ê·¹ì ìœ¼ë¡œ í•˜ê³ , ê³¼ì œ ì™„ì„±ë„ë„ ë†’ì•„ì¡Œì–´ìš”. ì´ëŒ€ë¡œë§Œ ê°€ë©´ ë‹¤ìŒ ì‹œí—˜ì—ì„œ ì¢‹ì€ ê²°ê³¼ ê¸°ëŒ€ë©ë‹ˆë‹¤!"</p>
                            </div>
                            <div class="p-6 bg-purple-50 rounded-xl">
                                <h4 class="font-bold text-purple-900 mb-3">ğŸ“š ì¶”ê°€ í•™ìŠµ ì œì•ˆ</h4>
                                <p class="text-sm text-gray-700">"ê¸°ì´ˆê°€ íƒ„íƒ„í•´ì ¸ì„œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ë„ ì¢‹ì„ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì‹¬í™” ê³¼ì •ì„ ì¶”ì²œë“œë¦¬ë©°, ìì„¸í•œ ë‚´ìš©ì€ ìƒë‹´ ì‹œ ë§ì”€ë“œë¦¬ê² ìŠµë‹ˆë‹¤."</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ì›”ë³„ ë§ˆì¼€íŒ… ìº˜ë¦°ë” -->
                <section class="mb-16">
                    <h2 class="text-3xl font-bold text-gray-900 mb-8">ğŸ“… ì›”ë³„ í•™ì› ë§ˆì¼€íŒ… ìº˜ë¦°ë”</h2>
                    <div class="bg-white rounded-2xl p-8 border border-gray-200 resource-card transition">
                        <div class="space-y-6">
                            <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-xl">
                                <div class="w-20 text-center">
                                    <div class="text-2xl font-bold text-purple-600">1~2ì›”</div>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-900 mb-2">ê²¨ìš¸ë°©í•™ íŠ¹ê°• & ì‹ í•™ê¸° ì¤€ë¹„</h4>
                                    <p class="text-sm text-gray-700">â€¢ ê²¨ìš¸ë°©í•™ íŠ¹ê°• í™ë³´<br>â€¢ ì‹ í•™ê¸° ë“±ë¡ ì¡°ê¸° í• ì¸<br>â€¢ í•™ë¶€ëª¨ ì„¤ëª…íšŒ ê°œìµœ</p>
                                </div>
                            </div>

                            <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-xl">
                                <div class="w-20 text-center">
                                    <div class="text-2xl font-bold text-orange-600">3~4ì›”</div>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-900 mb-2">ì‹ í•™ê¸° ì§‘ì¤‘ ë§ˆì¼€íŒ…</h4>
                                    <p class="text-sm text-gray-700">â€¢ ì²« ì¤‘ê°„ê³ ì‚¬ ëŒ€ë¹„ë°˜ í™ë³´<br>â€¢ í•™ë¶€ëª¨ ê°„ë‹´íšŒ<br>â€¢ ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë¦¬ë·° ì´ë²¤íŠ¸</p>
                                </div>
                            </div>

                            <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-xl">
                                <div class="w-20 text-center">
                                    <div class="text-2xl font-bold text-green-600">5~6ì›”</div>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-900 mb-2">ì¤‘ê°„ê³ ì‚¬ í›„ ì¬ë“±ë¡ ì§‘ì¤‘</h4>
                                    <p class="text-sm text-gray-700">â€¢ ì„±ì  í–¥ìƒ ì‚¬ë¡€ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ…<br>â€¢ ê¸°ë§ê³ ì‚¬ ëŒ€ë¹„ë°˜ ì˜ˆì•½<br>â€¢ í˜•ì œ/ìë§¤ í• ì¸ í”„ë¡œëª¨ì…˜</p>
                                </div>
                            </div>

                            <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-xl">
                                <div class="w-20 text-center">
                                    <div class="text-2xl font-bold text-blue-600">7~8ì›”</div>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-900 mb-2">ì—¬ë¦„ë°©í•™ íŠ¹ê°• ì‹œì¦Œ</h4>
                                    <p class="text-sm text-gray-700">â€¢ ì—¬ë¦„ë°©í•™ ì§‘ì¤‘ ìº í”„<br>â€¢ 2í•™ê¸° ì„ í–‰ í•™ìŠµë°˜<br>â€¢ ì¶”ì²œ ì´ë²¤íŠ¸ (ì¹œêµ¬ ë°ë ¤ì˜¤ê¸°)</p>
                                </div>
                            </div>

                            <div class="flex items-start space-x-4 p-4 bg-gray-50 rounded-xl">
                                <div class="w-20 text-center">
                                    <div class="text-2xl font-bold text-purple-600">11~12ì›”</div>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-900 mb-2">ìˆ˜ëŠ¥ & ê¸°ë§ê³ ì‚¬ ë§ˆì¼€íŒ…</h4>
                                    <p class="text-sm text-gray-700">â€¢ ìˆ˜ëŠ¥ ëŒ€ë°• ì´ë²¤íŠ¸<br>â€¢ ì—°ë§ ì¬ë“±ë¡ ì¡°ê¸° í• ì¸<br>â€¢ í•™ë¶€ëª¨ ê°ì‚¬ ì´ë²¤íŠ¸</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </div>

        <script>
        function downloadChecklist(type) {
            if (type === 'naver') {
                alert('ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.\\n\\nì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” PDF íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.');
                // ì‹¤ì œë¡œëŠ” PDF íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë¡œì§ ì¶”ê°€
            }
        }
        </script>
    </body>
    </html>
  `)
})

// ëŒ€ì‹œë³´ë“œ í˜ì´ì§€
app.get('/dashboard', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ëŒ€ì‹œë³´ë“œ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <div class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">í•™ì›ì¥ ëŒ€ì‹œë³´ë“œ</span>
                    </div>
                    <div class="flex items-center space-x-6">
                        <a href="/" class="flex items-center space-x-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white px-5 py-2.5 rounded-lg hover:from-purple-700 hover:to-purple-800 transition-all shadow-md hover:shadow-lg font-medium">
                            <span>ğŸ  í™ˆìœ¼ë¡œ</span>
                        </a>
                        <a href="/consulting" class="flex items-center space-x-2 text-gray-700 hover:text-purple-600 transition font-medium">
                            <span>ğŸ“ êµìœ¡ í”„ë¡œê·¸ë¨</span>
                        </a>
                        <div id="smsNavDropdown" class="relative group">
                            <button class="flex items-center space-x-1 text-gray-700 hover:text-purple-600 transition font-medium">
                                <span>ğŸ“± SMS</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="hidden group-hover:block absolute top-full right-0 mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-100 py-2 z-50">
                                <a href="/features/sms-sender" class="block px-4 py-2 text-purple-600 bg-purple-50 font-semibold hover:bg-purple-100 transition border-b border-purple-100">
                                    â„¹ï¸ SMS ì†Œê°œ ë° ì‚¬ìš©ë²•
                                </a>
                                <a href="/sms/compose" class="block px-4 py-2 text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition">
                                    âœï¸ ë¬¸ì ì‘ì„±
                                </a>
                                <a href="/sms/senders" class="block px-4 py-2 text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition">
                                    ğŸ“ ë°œì‹ ë²ˆí˜¸ ê´€ë¦¬
                                </a>
                                <a href="/sms/logs" class="block px-4 py-2 text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition">
                                    ğŸ“‹ ë°œì†¡ ë‚´ì—­
                                </a>
                                <a href="/sms/points" class="block px-4 py-2 text-gray-700 hover:bg-purple-50 hover:text-purple-600 transition">
                                    ğŸ’° í¬ì¸íŠ¸ ê´€ë¦¬
                                </a>
                            </div>
                        </div>

                        <span id="userName" class="text-gray-700 font-medium"></span>
                        <a href="/profile" class="text-gray-600 hover:text-purple-600 transition">í”„ë¡œí•„</a>
                        <a id="adminDashboardBtn" href="/admin/dashboard" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition font-medium">
                            ğŸ” ê´€ë¦¬ì ì „ìš© ëŒ€ì‹œë³´ë“œ
                        </a>
                        <button onclick="logout()" class="text-gray-600 hover:text-purple-600 transition">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- êµ¬ë… ê²½ê³  ë°°ë„ˆ (ì¼ë°˜ ì‚¬ìš©ì ì „ìš©) -->
        <div id="subscriptionWarningBanner" class="hidden fixed top-20 left-0 right-0 z-40 bg-gradient-to-r from-red-500 to-orange-500 text-white shadow-lg">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <div>
                            <div class="font-bold text-lg mb-1">âš ï¸ êµ¬ë… í”Œëœì´ ì—†ìŠµë‹ˆë‹¤</div>
                            <div class="text-sm text-white text-opacity-90">
                                ëª¨ë“  ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ í”Œëœì„ êµ¬ë…í•´ì£¼ì„¸ìš”. ì§€ê¸ˆ êµ¬ë…í•˜ê³  í•™ì› ë§ˆì¼€íŒ…ì„ ì‹œì‘í•˜ì„¸ìš”!
                            </div>
                        </div>
                    </div>
                    <a href="/pricing" class="bg-white text-red-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition font-bold shadow-lg whitespace-nowrap">
                        í”Œëœ ì„ íƒí•˜ê¸° â†’
                    </a>
                </div>
            </div>
        </div>

        <!-- êµ¬ë… ì—†ëŠ” ì‚¬ìš©ììš© ë©”ì‹œì§€ -->
        <div id="noSubscriptionMessage" class="hidden pt-32 pb-24 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-xl border-2 border-red-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-red-500 to-orange-500 p-8 text-center">
                        <div class="w-24 h-24 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <h1 class="text-4xl font-bold text-white mb-3">âš ï¸ êµ¬ë… í”Œëœì´ ì—†ìŠµë‹ˆë‹¤</h1>
                        <p class="text-xl text-white text-opacity-90">ëŒ€ì‹œë³´ë“œë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ í”Œëœì„ êµ¬ë…í•´ì£¼ì„¸ìš”</p>
                    </div>
                    <div class="p-12">
                        <div class="text-center mb-8">
                            <p class="text-lg text-gray-600 mb-6">
                                ìŠˆí¼í”Œë ˆì´ìŠ¤ì˜ ê°•ë ¥í•œ í•™ì› ë§ˆì¼€íŒ… ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´<br>
                                ë¨¼ì € êµ¬ë… í”Œëœì„ ì„ íƒí•´ì£¼ì„¸ìš”.
                            </p>
                            <div class="bg-gray-50 rounded-xl p-6 mb-6">
                                <h3 class="font-bold text-lg text-gray-900 mb-4">âœ¨ êµ¬ë… ì‹œ ì´ìš© ê°€ëŠ¥í•œ ê¸°ëŠ¥</h3>
                                <div class="grid md:grid-cols-2 gap-4 text-left">
                                    <div class="flex items-start gap-3">
                                        <svg class="w-6 h-6 text-green-500 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span class="text-gray-700">í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ</span>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <svg class="w-6 h-6 text-green-500 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span class="text-gray-700">AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</span>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <svg class="w-6 h-6 text-green-500 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span class="text-gray-700">ëœë”©í˜ì´ì§€ ìƒì„±</span>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <svg class="w-6 h-6 text-green-500 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span class="text-gray-700">SMS ìë™ ë°œì†¡</span>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <svg class="w-6 h-6 text-green-500 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span class="text-gray-700">ì„ ìƒë‹˜ ê¶Œí•œ ê´€ë¦¬</span>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <svg class="w-6 h-6 text-green-500 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                        </svg>
                                        <span class="text-gray-700">ë§ˆì¼€íŒ… ìë™í™”</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center">
                            <a href="/pricing" class="inline-flex items-center justify-center gap-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white px-8 py-4 rounded-xl hover:from-purple-700 hover:to-purple-800 transition-all shadow-lg hover:shadow-xl font-bold text-lg">
                                <span>ğŸ’ í”Œëœ ì„ íƒí•˜ê¸°</span>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                </svg>
                            </a>
                            <a href="/" class="inline-flex items-center justify-center gap-2 bg-gray-100 text-gray-700 px-8 py-4 rounded-xl hover:bg-gray-200 transition-all font-bold text-lg">
                                <span>ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- êµ¬ë…í•œ ì‚¬ìš©ììš© ëŒ€ì‹œë³´ë“œ ì½˜í…ì¸  -->
        <div id="dashboardContent" class="pt-32 pb-24 px-6">
            <div class="max-w-7xl mx-auto">
                <div class="mb-10">
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">ì•ˆë…•í•˜ì„¸ìš”, <span id="userNameDisplay"></span>ë‹˜!</h1>
                    <p class="text-xl text-gray-600">í•™ì› ë§ˆì¼€íŒ… í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”</p>
                </div>

                <!-- í”Œëœ ì‚¬ìš©ëŸ‰ ë¹ ë¥¸ ë³´ê¸° (ìƒˆë¡œ ì¶”ê°€) -->
                <div id="quickUsageStats" class="hidden mb-8">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl p-6 text-white">
                        <h2 class="text-2xl font-bold mb-4">ğŸ“Š ì´ë²ˆ ë‹¬ ì‚¬ìš©ëŸ‰</h2>
                        <div class="grid md:grid-cols-4 gap-4">
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                <div class="text-sm text-purple-100 mb-1">ëœë”©í˜ì´ì§€</div>
                                <div class="text-3xl font-bold mb-1"><span id="quickLandingUsage">0</span> / <span id="quickLandingLimit">0</span></div>
                                <div class="w-full bg-white/20 rounded-full h-2 mt-2">
                                    <div id="quickLandingBar" class="bg-white h-2 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                <div class="text-sm text-purple-100 mb-1">AI ë¦¬í¬íŠ¸</div>
                                <div class="text-3xl font-bold mb-1"><span id="quickReportUsage">0</span> / <span id="quickReportLimit">0</span></div>
                                <div class="w-full bg-white/20 rounded-full h-2 mt-2">
                                    <div id="quickReportBar" class="bg-white h-2 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                <div class="text-sm text-purple-100 mb-1">í•™ìƒ ìˆ˜</div>
                                <div class="text-3xl font-bold mb-1"><span id="quickStudentUsage">0</span> / <span id="quickStudentLimit">0</span></div>
                                <div class="w-full bg-white/20 rounded-full h-2 mt-2">
                                    <div id="quickStudentBar" class="bg-white h-2 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                <div class="text-sm text-purple-100 mb-1">ì„ ìƒë‹˜ ìˆ˜</div>
                                <div class="text-3xl font-bold mb-1"><span id="quickTeacherUsage">0</span> / <span id="quickTeacherLimit">0</span></div>
                                <div class="w-full bg-white/20 rounded-full h-2 mt-2">
                                    <div id="quickTeacherBar" class="bg-white h-2 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid md:grid-cols-3 gap-6 mb-12">
                    <div class="bg-gradient-to-br from-blue-300 to-blue-400 rounded-2xl p-6 text-white shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-sm text-blue-100">ë³´ìœ  í¬ì¸íŠ¸</div>
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="text-4xl font-bold mb-4"><span id="userPoints">0</span>P</div>
                        <div class="space-y-2">
                            <button onclick="openDepositModal()" class="w-full bg-white text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-50 transition font-medium text-sm">
                                ğŸ’° ì…ê¸ˆ ì‹ ì²­
                            </button>
                            <a href="/my-deposits" class="block w-full bg-blue-50 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-100 transition font-medium text-sm text-center">
                                ğŸ“‹ ì…ê¸ˆ ë‚´ì—­
                            </a>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition">
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-sm text-gray-600">ë“±ë¡ í•™ìƒ í˜„í™©</div>
                            <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                        </div>
                        <div class="text-4xl font-bold text-gray-900 mb-2"><span id="studentCount">0</span>ëª…</div>
                        <a href="/students/list" class="text-sm text-purple-600 hover:text-purple-700 font-medium">
                            í•™ìƒ ê´€ë¦¬ â†’
                        </a>
                    </div>

                    <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition">
                        <div class="flex items-center justify-between mb-4">
                            <div class="text-sm text-gray-600">ì„ ìƒë‹˜ í˜„í™©</div>
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="text-4xl font-bold text-gray-900 mb-2"><span id="teacherCount">0</span>ëª…</div>
                        <a href="/teachers" class="text-sm text-green-600 hover:text-green-700 font-medium">
                            ì„ ìƒë‹˜ ê´€ë¦¬ â†’
                        </a>
                    </div>
                </div>

                <!-- SMS Quick Access -->
                <div id="smsSection" class="mb-12">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">ğŸ“± SMS ë¬¸ì ë°œì†¡</h2>
                        <a href="/sms/compose" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-lg hover:from-green-700 hover:to-green-800 transition-all shadow-md hover:shadow-lg font-medium flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>ë¬¸ì ì‘ì„±í•˜ê¸°</span>
                        </a>
                    </div>
                    <div class="grid md:grid-cols-4 gap-6">
                        <a href="/sms/compose" class="block bg-white rounded-xl p-6 border-2 border-gray-200 hover:border-green-500 hover:shadow-lg transition-all">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">ë¬¸ì ì‘ì„±</h3>
                                    <p class="text-sm text-gray-500">SMS/LMS ë°œì†¡</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 leading-relaxed">
                                í•™ë¶€ëª¨ë‹˜ê»˜ ê³µì§€ì‚¬í•­, ìƒë‹´ ì•ˆë‚´, ìˆ˜ì—… ì•Œë¦¼ì„ ê°„í¸í•˜ê²Œ ë°œì†¡í•˜ì„¸ìš”
                            </p>
                        </a>

                        <a href="/sms/senders" class="block bg-white rounded-xl p-6 border-2 border-gray-200 hover:border-blue-500 hover:shadow-lg transition-all">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">ë°œì‹ ë²ˆí˜¸</h3>
                                    <p class="text-sm text-gray-500">ë²ˆí˜¸ ê´€ë¦¬</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 leading-relaxed">
                                ë°œì‹ ë²ˆí˜¸ë¥¼ ë“±ë¡í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”. ì¸ì¦ëœ ë²ˆí˜¸ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤
                            </p>
                        </a>

                        <a href="/sms/logs" class="block bg-white rounded-xl p-6 border-2 border-gray-200 hover:border-purple-500 hover:shadow-lg transition-all">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">ë°œì†¡ ë‚´ì—­</h3>
                                    <p class="text-sm text-gray-500">ì „ì†¡ ê¸°ë¡</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 leading-relaxed">
                                ë¬¸ì ë°œì†¡ ë‚´ì—­ê³¼ í†µê³„ë¥¼ í™•ì¸í•˜ê³  ì„±ê³µ/ì‹¤íŒ¨ ë‚´ì—­ì„ ê´€ë¦¬í•˜ì„¸ìš”
                            </p>
                        </a>

                        <a href="/sms/points" class="block bg-white rounded-xl p-6 border-2 border-gray-200 hover:border-orange-500 hover:shadow-lg transition-all">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">í¬ì¸íŠ¸</h3>
                                    <p class="text-sm text-gray-500"><span id="dashboardPoints">0</span>P</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 leading-relaxed">
                                í¬ì¸íŠ¸ ì”ì•¡ í™•ì¸, ì¶©ì „, ì‚¬ìš© ë‚´ì—­ì„ ê´€ë¦¬í•˜ì„¸ìš”
                            </p>
                        </a>
                    </div>
                </div>

                <!-- Landing Page Builder Section -->
                <div id="landingSection" class="mb-12">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">ğŸ¨ ëœë”©í˜ì´ì§€ ìƒì„±ê¸°</h2>
                        <a href="/tools/landing-builder" class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-3 rounded-lg hover:from-purple-700 hover:to-purple-800 transition-all shadow-md hover:shadow-lg font-medium flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>ìƒˆë¡œ ë§Œë“¤ê¸°</span>
                        </a>
                    </div>
                    <div class="grid md:grid-cols-4 gap-6">
                        <a href="/tools/landing-builder" class="block bg-white rounded-xl p-6 border-2 border-gray-200 hover:border-purple-500 hover:shadow-lg transition-all">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">í˜ì´ì§€ ìƒì„±</h3>
                                    <p class="text-sm text-gray-500">AI ìë™ ìƒì„±</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 leading-relaxed">
                                AIê°€ ìë™ìœ¼ë¡œ ì „ë¬¸ì ì¸ ëœë”©í˜ì´ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
                            </p>
                        </a>

                        <a href="/tools/landing-manager" class="block bg-white rounded-xl p-6 border-2 border-gray-200 hover:border-blue-500 hover:shadow-lg transition-all">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">ë‚´ í˜ì´ì§€</h3>
                                    <p class="text-sm text-gray-500"><span id="landingPagesCount">0</span>ê°œ</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 leading-relaxed">
                                ìƒì„±í•œ ëœë”©í˜ì´ì§€ë¥¼ ë³´ê³  ê´€ë¦¬í•˜ì„¸ìš”
                            </p>
                        </a>

                        <a href="/tools/landing-folders" class="block bg-white rounded-xl p-6 border-2 border-gray-200 hover:border-green-500 hover:shadow-lg transition-all">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">í´ë” ê´€ë¦¬</h3>
                                    <p class="text-sm text-gray-500"><span id="landingFoldersCount">0</span>ê°œ</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 leading-relaxed">
                                í˜ì´ì§€ë¥¼ í´ë”ë¡œ ì •ë¦¬í•˜ê³  ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”
                            </p>
                        </a>

                        <div class="block bg-white rounded-xl p-6 border-2 border-gray-200 hover:border-orange-500 hover:shadow-lg transition-all">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-900">ì´ ì¡°íšŒìˆ˜</h3>
                                    <p class="text-sm text-gray-500"><span id="landingViewsCount">0</span>íšŒ</p>
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 leading-relaxed">
                                ëª¨ë“  ëœë”©í˜ì´ì§€ì˜ ëˆ„ì  ë°©ë¬¸ì ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”
                            </p>
                        </div>
                    </div>
                </div>

                <!-- My Landing Pages Section -->
                <div id="landingPagesSection" class="mb-12" style="display: none;">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">ğŸš€ ë‚´ ëœë”©í˜ì´ì§€</h2>
                        <a href="/tools/landing-builder" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all shadow-md hover:shadow-lg font-medium flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            <span>+ ìƒˆ ëœë”©í˜ì´ì§€</span>
                        </a>
                    </div>
                    <div id="landingPagesList" class="grid md:grid-cols-2 gap-6">
                        <div class="text-center text-gray-500 py-12 md:col-span-2">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                            ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <a href="/tools/landing-manager" class="inline-flex items-center text-blue-600 hover:text-blue-700 font-medium">
                            <span>ì „ì²´ ê´€ë¦¬</span>
                            <svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </a>
                    </div>
                </div>

                <!-- Marketing Tools -->
                <div id="marketingToolsSection" class="mb-12">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ¯ ë§ˆì¼€íŒ… ë„êµ¬</h2>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="block bg-gradient-to-br from-cyan-500 to-cyan-700 rounded-2xl p-8 hover:shadow-2xl transition-all hover:-translate-y-1">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white">ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ</h3>
                                    <p class="text-cyan-100 text-sm">ì‹¤ì‹œê°„ ê²€ìƒ‰ëŸ‰ ë¶„ì„</p>
                                </div>
                            </div>
                            <p class="text-white/90 leading-relaxed mb-4">
                                í‚¤ì›Œë“œ ê²€ìƒ‰ëŸ‰ê³¼ ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìˆœìœ„ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”. ê²½ìŸì‚¬ ë¶„ì„ê³¼ ìµœì  í‚¤ì›Œë“œ ë°œêµ´ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                            </p>
                            <div class="flex items-center gap-3">
                                <a href="/features/search-volume" class="flex-1 text-center py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-medium transition">
                                    ìì„¸íˆ ë³´ê¸°
                                </a>
                                <a href="/tools/search-volume" class="flex-1 text-center py-2 bg-white text-cyan-600 rounded-lg font-medium hover:bg-cyan-50 transition">
                                    ë°”ë¡œ ì‚¬ìš©í•˜ê¸° â†’
                                </a>
                            </div>
                        </div>

                        <div class="block bg-gradient-to-br from-blue-300 to-blue-400 rounded-2xl p-8 hover:shadow-2xl transition-all hover:-translate-y-1">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white">ëœë”©í˜ì´ì§€ ìƒì„±ê¸°</h3>
                                    <p class="text-blue-100 text-sm">AI ìë™ í˜ì´ì§€ ì œì‘</p>
                                </div>
                            </div>
                            <p class="text-white/90 leading-relaxed mb-4">
                                í•™ì› ì†Œê°œ, í”„ë¡œê·¸ë¨ í™ë³´, í•™ìƒ ë¦¬í¬íŠ¸ í˜ì´ì§€ë¥¼ ê°„ë‹¨í•œ ì…ë ¥ë§Œìœ¼ë¡œ ìë™ ìƒì„±í•©ë‹ˆë‹¤. ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ë°”ë¡œ ê³µìœ í•˜ì„¸ìš”.
                            </p>
                            <div class="flex items-center gap-3">
                                <a href="/features/landing-builder" class="flex-1 text-center py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-medium transition">
                                    ìì„¸íˆ ë³´ê¸°
                                </a>
                                <a href="/tools/landing-builder" class="flex-1 text-center py-2 bg-white text-blue-600 rounded-lg font-medium hover:bg-blue-50 transition">
                                    ë°”ë¡œ ì‚¬ìš©í•˜ê¸° â†’
                                </a>
                            </div>
                        </div>

                        <div class="block bg-gradient-to-br from-indigo-500 to-indigo-700 rounded-2xl p-8 hover:shadow-2xl transition-all hover:-translate-y-1">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white">í•™ìƒ ê´€ë¦¬</h3>
                                    <p class="text-indigo-100 text-sm">ì¶œê²°Â·ì„±ì Â·ìƒë‹´ ê¸°ë¡</p>
                                </div>
                            </div>
                            <p class="text-white/90 leading-relaxed mb-4">
                                í•™ìƒ ì •ë³´, ì¶œê²° ê´€ë¦¬, ì„±ì  ê¸°ë¡, ìƒë‹´ ë‚´ì—­ì„ í•œ ê³³ì—ì„œ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”.
                            </p>
                            <div class="flex items-center gap-3">
                                <a href="/features/student-management" class="flex-1 text-center py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-medium transition">
                                    ìì„¸íˆ ë³´ê¸°
                                </a>
                                <a href="/students" class="flex-1 text-center py-2 bg-white text-indigo-600 rounded-lg font-medium hover:bg-indigo-50 transition">
                                    ë°”ë¡œ ì‚¬ìš©í•˜ê¸° â†’
                                </a>
                            </div>
                        </div>

                        <!-- êµìœ¡ë¹„ ê´€ë¦¬ ì¹´ë“œ (ê´€ë¦¬ìì™€ í•™ì›ì¥ ì „ìš©) -->
                        <div id="tuitionManagementCard" class="bg-gradient-to-br from-green-500 to-emerald-700 rounded-2xl p-8 hover:shadow-2xl transition-all hover:-translate-y-1" style="display: none;">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white">êµìœ¡ë¹„ ê´€ë¦¬</h3>
                                    <p class="text-green-100 text-sm">ì›”ë³„ ë‚©ì… í˜„í™© ì¶”ì </p>
                                </div>
                            </div>
                            <p class="text-white/90 leading-relaxed mb-4">
                                í•™ìƒë³„ êµìœ¡ë¹„ ë‚©ì… í˜„í™©ì„ ì›”ë³„ë¡œ ê´€ë¦¬í•˜ê³ , ë¯¸ë‚© í•™ìƒì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”. ë©”ëª¨ ê¸°ëŠ¥ìœ¼ë¡œ ë‚©ì… ë‚´ì—­ì„ ê¸°ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                            <div class="flex items-center gap-3">
                                <a href="/tools/tuition-management" class="flex-1 text-center py-2 bg-white text-green-600 rounded-lg font-medium hover:bg-green-50 transition">
                                    ë°”ë¡œ ì‚¬ìš©í•˜ê¸° â†’
                                </a>
                            </div>
                        </div>

                        <!-- ë§¤ì¶œ ê´€ë¦¬ ì¹´ë“œ (ê´€ë¦¬ìì™€ í•™ì›ì¥ ì „ìš©) -->
                        <div id="revenueManagementCard" class="bg-gradient-to-br from-blue-500 to-indigo-700 rounded-2xl p-8 hover:shadow-2xl transition-all hover:-translate-y-1" style="display: none;">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white">ë§¤ì¶œ ê´€ë¦¬</h3>
                                    <p class="text-blue-100 text-sm">í•™ì› ë§¤ì¶œ ë¶„ì„ ë° í†µê³„</p>
                                </div>
                            </div>
                            <p class="text-white/90 leading-relaxed mb-4">
                                ì›”ë³„/ì—°ê°„ ë§¤ì¶œ ì¶”ì´ë¥¼ ê·¸ë˜í”„ë¡œ í™•ì¸í•˜ê³ , í•™ìƒë³„ ë§¤ì¶œ ê¸°ì—¬ë„ë¥¼ ë¶„ì„í•˜ì„¸ìš”. ìˆ˜ê¸ˆë¥ ê³¼ ë¯¸ìˆ˜ê¸ˆì„ ì‹¤ì‹œê°„ìœ¼ë¡œ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                            <div class="flex items-center gap-3">
                                <a href="/tools/revenue-management" class="flex-1 text-center py-2 bg-white text-blue-600 rounded-lg font-medium hover:bg-blue-50 transition">
                                    ë°”ë¡œ ì‚¬ìš©í•˜ê¸° â†’
                                </a>
                            </div>
                        </div>

                        <div class="block bg-gradient-to-br from-violet-500 to-fuchsia-700 rounded-2xl p-8 hover:shadow-2xl transition-all hover:-translate-y-1">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-white">AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</h3>
                                    <p class="text-violet-100 text-sm">ê°œì¸ë³„ ë§ì¶¤ í•™ìŠµ ë¶„ì„</p>
                                </div>
                            </div>
                            <p class="text-white/90 leading-relaxed mb-4">
                                AIê°€ í•™ìƒì˜ ì„±ì , ì¶œì„, í•™ìŠµ íƒœë„ë¥¼ ì¢…í•© ë¶„ì„í•˜ì—¬ ë§ì¶¤í˜• ë¦¬í¬íŠ¸ë¥¼ ìë™ ìƒì„±í•©ë‹ˆë‹¤.
                            </p>
                            <div class="flex items-center gap-3">
                                <a href="/features/ai-learning-report" class="flex-1 text-center py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg font-medium transition">
                                    ìì„¸íˆ ë³´ê¸°
                                </a>
                                <a href="/tools/ai-learning-report" class="flex-1 text-center py-2 bg-white text-violet-600 rounded-lg font-medium hover:bg-violet-50 transition">
                                    ë°”ë¡œ ì‚¬ìš©í•˜ê¸° â†’
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="space-y-8">
                    <!-- Subscription Status & Usage -->
                    <div id="subscriptionStatusMain" class="bg-white rounded-2xl p-8 border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“Š êµ¬ë… ë° ì‚¬ìš© í˜„í™©</h2>
                        <div class="text-center py-12">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                            <p class="text-gray-500">êµ¬ë… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div class="bg-white rounded-2xl p-8 border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ë°”ë¡œê°€ê¸°</h2>
                        <div class="space-y-3">
                            <a href="/programs" class="flex items-center justify-between p-5 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    <span class="font-medium text-gray-900">êµìœ¡ í”„ë¡œê·¸ë¨</span>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </a>

                            <a href="/success" class="flex items-center justify-between p-5 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                    </svg>
                                    <span class="font-medium text-gray-900">ì„±ê³µ ì‚¬ë¡€</span>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </a>

                            <a href="/resources" class="flex items-center justify-between p-5 bg-gradient-to-r from-purple-50 to-orange-50 rounded-xl hover:shadow-md transition border-2 border-purple-200">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    <div>
                                        <div class="font-bold text-gray-900">ë§ˆì¼€íŒ… ë¦¬ì†ŒìŠ¤</div>
                                        <div class="text-xs text-gray-600">ì²´í¬ë¦¬ìŠ¤íŠ¸ & ê°€ì´ë“œ</div>
                                    </div>
                                </div>
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </a>

                            <a href="/contact" class="flex items-center justify-between p-5 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                    </svg>
                                    <span class="font-medium text-gray-900">1:1 ìƒë‹´ ì‹ ì²­</span>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </a>

                            <a href="/" class="flex items-center justify-between p-5 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                                <div class="flex items-center">
                                    <svg class="w-6 h-6 text-purple-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                                    </svg>
                                    <span class="font-medium text-gray-900">ë©”ì¸ í˜ì´ì§€</span>
                                </div>
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Check authentication
            const user = JSON.parse(localStorage.getItem('user') || 'null')
            const isImpersonating = localStorage.getItem('is_impersonating') === 'true'
            
            console.log('[Dashboard Init] User from localStorage:', user)
            
            if (!user) {
                console.error('[Dashboard Init] No user in localStorage, redirecting to login')
                window.location.href = '/login'
            } else {
                console.log('[Dashboard Init] User ID:', user.id, 'Email:', user.email, 'Name:', user.name)
                
                document.getElementById('userName').textContent = user.name
                document.getElementById('userNameDisplay').textContent = user.name
                
                // ê´€ë¦¬ìì¼ ê²½ìš° ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ ë²„íŠ¼ í‘œì‹œ
                if (user.role === 'admin') {
                    document.getElementById('adminDashboardBtn').classList.remove('hidden')
                }
                
                // Impersonating ì¤‘ì´ë©´ ë³µê·€ ë²„íŠ¼ í‘œì‹œ
                if (isImpersonating) {
                    const nav = document.querySelector('nav .flex.items-center.space-x-4')
                    if (nav) {
                        const returnBtn = document.createElement('button')
                        returnBtn.onclick = returnToAdmin
                        returnBtn.className = 'px-4 py-2 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600 transition-all'
                        returnBtn.innerHTML = 'ğŸ”™ ê´€ë¦¬ìë¡œ ëŒì•„ê°€ê¸°'
                        nav.insertBefore(returnBtn, nav.firstChild)
                    }
                }
                
                // êµ¬ë… ìƒíƒœ ë¡œë“œ
                console.log('[Dashboard Init] Loading subscription status...')
                loadSubscriptionStatus()
                
                // ê¶Œí•œ ì²´í¬ ë° UI í‘œì‹œ/ìˆ¨ê¹€
                checkPermissions()
            }
            
            // êµ¬ë… ìƒíƒœ ë¡œë“œ í•¨ìˆ˜
            async function loadSubscriptionStatus() {
                try {
                    const response = await fetch('/api/subscriptions/status')
                    const data = await response.json()
                    
                    console.log('[Dashboard] Subscription Status Response:', data)
                    
                    const statusDiv = document.getElementById('subscriptionStatusMain')
                    const warningBanner = document.getElementById('subscriptionWarningBanner')
                    const marketingToolsSection = document.getElementById('marketingToolsSection')
                    
                    if (!statusDiv) {
                        console.error('subscriptionStatusMain element not found')
                        return
                    }
                    
                    // êµ¬ë… ì—¬ë¶€ í™•ì¸
                    const hasSubscription = data.success && data.hasSubscription
                    const isAdminPlan = hasSubscription && data.subscription && data.subscription.planName === 'ê´€ë¦¬ì ì„¤ì • í”Œëœ'
                    
                    console.log('[Dashboard] hasSubscription:', hasSubscription, 'isAdminPlan:', isAdminPlan)
                    
                    // ëŒ€ì‹œë³´ë“œ ì½˜í…ì¸  ìš”ì†Œ
                    const dashboardContent = document.getElementById('dashboardContent')
                    const noSubscriptionMessage = document.getElementById('noSubscriptionMessage')
                    
                    // êµ¬ë… ìƒíƒœì— ë”°ë¼ í‘œì‹œ/ìˆ¨ê¹€
                    if (!hasSubscription) {
                        console.log('[Dashboard] No subscription - showing message, hiding dashboard')
                        // êµ¬ë…ì´ ì—†ìœ¼ë©´ ëŒ€ì‹œë³´ë“œ ìˆ¨ê¸°ê³  ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
                        if (dashboardContent) dashboardContent.style.display = 'none'
                        if (noSubscriptionMessage) noSubscriptionMessage.classList.remove('hidden')
                        if (warningBanner) warningBanner.classList.add('hidden') // ë°°ë„ˆë„ ìˆ¨ê¹€ (ë©”ì‹œì§€ë¡œ ëŒ€ì²´)
                    } else {
                        console.log('[Dashboard] Has subscription - showing dashboard, hiding message')
                        // êµ¬ë…ì´ ìˆìœ¼ë©´ ëŒ€ì‹œë³´ë“œ í‘œì‹œí•˜ê³  ì•ˆë‚´ ë©”ì‹œì§€ ìˆ¨ê¹€
                        if (dashboardContent) dashboardContent.style.display = 'block'
                        if (noSubscriptionMessage) noSubscriptionMessage.classList.add('hidden')
                        if (warningBanner) warningBanner.classList.add('hidden')
                    }
                    
                    // ë§ˆì¼€íŒ… ë„êµ¬ ì„¹ì…˜ ì œì–´
                    if (!hasSubscription && marketingToolsSection) {
                        console.log('[Dashboard] Hiding marketing tools - no subscription')
                        marketingToolsSection.style.display = 'none'
                    } else if (marketingToolsSection) {
                        console.log('[Dashboard] Showing marketing tools - has subscription')
                        marketingToolsSection.style.display = 'block'
                    }
                    
                    // êµìœ¡ë¹„ ê´€ë¦¬ëŠ” êµ¬ë… ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ê¶Œí•œì— ë”°ë¼ í‘œì‹œ (ë¬´ë£Œ ê¸°ëŠ¥)
                    // checkPermissions()ì—ì„œ ë³„ë„ë¡œ ì²˜ë¦¬ë¨
                    console.log('[Dashboard] êµìœ¡ë¹„ ê´€ë¦¬ ì¹´ë“œëŠ” checkPermissions()ì—ì„œ ì²˜ë¦¬')
                    
                    if (hasSubscription) {
                        const sub = data.subscription
                        
                        // ë‚ ì§œ ê³„ì‚°
                        const parseDate = (dateStr) => {
                            if (!dateStr) return null
                            if (dateStr.includes('T')) return new Date(dateStr)
                            return new Date(dateStr + 'T00:00:00+09:00')
                        }
                        const startDate = parseDate(sub.startDate)
                        const endDate = parseDate(sub.endDate)
                        if (!startDate || !endDate || isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                            console.error('[Dashboard] Invalid dates')
                            statusDiv.innerHTML = '<div>Date error</div>'
                            return
                        }
                        const endOfDay = new Date(endDate)
                        endOfDay.setHours(23, 59, 59, 999)
                        const today = new Date()
                        const daysLeft = Math.max(0, Math.ceil((endDate - today) / (1000 * 60 * 60 * 24)))
                        const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24))
                        const daysUsed = totalDays - daysLeft
                        
                        // ë‚ ì§œ í¬ë§·íŒ…
                        const formatDate = (date) => {
                            const year = date.getFullYear()
                            const month = String(date.getMonth() + 1).padStart(2, '0')
                            const day = String(date.getDate()).padStart(2, '0')
                            return year + 'ë…„ ' + month + 'ì›” ' + day + 'ì¼'
                        }
                        
                        // ì‚¬ìš©ëŸ‰ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                        let usageHtml = ''
                        try {
                            console.log('[Dashboard] Fetching usage data...')
                            const usageRes = await fetch('/api/usage/check', {
                                method: 'GET',
                                credentials: 'include',
                                cache: 'no-cache'
                            })
                            console.log('[Dashboard] Usage API status:', usageRes.status)
                            
                            const usageData = await usageRes.json()
                            console.log('[Dashboard] ========== USAGE API RESPONSE ==========')
                            console.log('[Dashboard] Full Response:', JSON.stringify(usageData, null, 2))
                            console.log('[Dashboard] success:', usageData.success)
                            console.log('[Dashboard] error:', usageData.error)
                            console.log('[Dashboard] ==========================================')
                            
                            if (usageData.success) {
                                const { limits, usage } = usageData
                                
                                console.log('[Dashboard] ========== LIMITS ==========')
                                console.log('[Dashboard] Students Limit:', limits.students)
                                console.log('[Dashboard] AI Reports Limit:', limits.aiReports)
                                console.log('[Dashboard] Landing Pages Limit:', limits.landingPages)
                                console.log('[Dashboard] Teachers Limit:', limits.teachers)
                                console.log('[Dashboard] ========== USAGE ==========')
                                console.log('[Dashboard] Students Used:', usage.students)
                                console.log('[Dashboard] AI Reports Used:', usage.aiReports)
                                console.log('[Dashboard] Landing Pages Used:', usage.landingPages)
                                console.log('[Dashboard] Teachers Used:', usage.teachers)
                                console.log('[Dashboard] =======================================')
                                
                                // í¼ì„¼íŠ¸ ê³„ì‚° ë° ìƒ‰ìƒ ê²°ì •
                                const calcUsage = (current, limit) => {
                                    const percent = limit > 0 ? Math.min((current / limit) * 100, 100) : 0
                                    const remaining = Math.max(limit - current, 0)
                                    let color = 'blue'
                                    if (percent >= 100) color = 'red'
                                    else if (percent >= 80) color = 'orange'
                                    else if (percent >= 60) color = 'yellow'
                                    return { percent, remaining, color, current, limit }
                                }
                                
                                const studentUsage = calcUsage(usage.students || 0, limits.students || 0)
                                const reportUsage = calcUsage(usage.aiReports || 0, limits.aiReports || 0)
                                const landingUsage = calcUsage(usage.landingPages || 0, limits.landingPages || 0)
                                const teacherUsage = calcUsage(usage.teachers || 0, limits.teachers || 0)
                                
                                // ë¹ ë¥¸ ì‚¬ìš©ëŸ‰ í†µê³„ ì—…ë°ì´íŠ¸
                                const quickUsageStats = document.getElementById('quickUsageStats')
                                if (quickUsageStats) {
                                    quickUsageStats.classList.remove('hidden')
                                    document.getElementById('quickLandingUsage').textContent = landingUsage.current
                                    document.getElementById('quickLandingLimit').textContent = landingUsage.limit
                                    document.getElementById('quickLandingBar').style.width = landingUsage.percent + '%'
                                    document.getElementById('quickReportUsage').textContent = reportUsage.current
                                    document.getElementById('quickReportLimit').textContent = reportUsage.limit
                                    document.getElementById('quickReportBar').style.width = reportUsage.percent + '%'
                                    document.getElementById('quickStudentUsage').textContent = studentUsage.current
                                    document.getElementById('quickStudentLimit').textContent = studentUsage.limit
                                    document.getElementById('quickStudentBar').style.width = studentUsage.percent + '%'
                                    document.getElementById('quickTeacherUsage').textContent = teacherUsage.current
                                    document.getElementById('quickTeacherLimit').textContent = teacherUsage.limit
                                    document.getElementById('quickTeacherBar').style.width = teacherUsage.percent + '%'
                                }
                                
                                const renderUsageCard = (icon, title, usage) => {
                                    return '<div class="bg-white rounded-2xl p-6 shadow-lg border-2 ' + 
                                        (usage.color === 'red' ? 'border-red-300 bg-red-50' : 
                                         usage.color === 'orange' ? 'border-orange-300 bg-orange-50' :
                                         usage.color === 'yellow' ? 'border-yellow-300 bg-yellow-50' : 'border-blue-200 bg-blue-50') + '">' +
                                        '<div class="flex items-center gap-3 mb-4">' +
                                        '<span class="text-4xl">' + icon + '</span>' +
                                        '<div class="flex-1">' +
                                        '<h4 class="text-base font-bold text-gray-900">' + title + '</h4>' +
                                        '<p class="text-2xl font-bold mt-1 ' + 
                                        (usage.color === 'red' ? 'text-red-600' : 
                                         usage.color === 'orange' ? 'text-orange-600' :
                                         usage.color === 'yellow' ? 'text-yellow-600' : 'text-blue-600') + '">' +
                                        usage.current.toLocaleString() + ' / ' + usage.limit.toLocaleString() +
                                        '</p>' +
                                        '</div>' +
                                        '</div>' +
                                        '<div class="w-full bg-gray-300 rounded-full h-4 mb-3 overflow-hidden">' +
                                        '<div class="h-4 rounded-full transition-all duration-500 ' + 
                                        (usage.color === 'red' ? 'bg-gradient-to-r from-red-500 to-red-700' : 
                                         usage.color === 'orange' ? 'bg-gradient-to-r from-orange-500 to-orange-700' :
                                         usage.color === 'yellow' ? 'bg-gradient-to-r from-yellow-500 to-yellow-700' : 'bg-gradient-to-r from-blue-300 to-blue-400') + 
                                        '" style="width: ' + Math.min(usage.percent, 100) + '%"></div>' +
                                        '</div>' +
                                        '<div class="flex justify-between items-center">' +
                                        '<span class="text-sm font-semibold text-gray-700">' + usage.percent.toFixed(1) + '% ì‚¬ìš© ì¤‘</span>' +
                                        '<span class="text-sm font-bold px-3 py-1 rounded-full ' + 
                                        (usage.remaining === 0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700') + '">' +
                                        'ë‚¨ìŒ: ' + usage.remaining.toLocaleString() + 'ê°œ' +
                                        '</span>' +
                                        '</div>' +
                                        '</div>'
                                }
                                
                                usageHtml = '<div class="mt-6 pt-6 border-t-2 border-purple-200">' +
                                    '<div class="flex items-center justify-between mb-6">' +
                                    '<h3 class="text-xl font-bold text-gray-900">ğŸ“Š ì‹¤ì‹œê°„ ì‚¬ìš©ëŸ‰</h3>' +
                                    '<span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full">ìë™ ì—…ë°ì´íŠ¸ë¨</span>' +
                                    '</div>' +
                                    '<div class="space-y-4">' +
                                    renderUsageCard('ğŸ‘¥', 'í•™ìƒ', studentUsage) +
                                    renderUsageCard('ğŸ“Š', 'AI ë¦¬í¬íŠ¸', reportUsage) +
                                    renderUsageCard('ğŸ¨', 'ëœë”©í˜ì´ì§€', landingUsage) +
                                    renderUsageCard('ğŸ‘¨â€ğŸ«', 'ì„ ìƒë‹˜', teacherUsage) +
                                    '</div>' +
                                    '</div>'
                            } else {
                                console.error('[Dashboard] Usage API returned success=false:', usageData)
                                usageHtml = '<div class="mt-6 pt-6 border-t-2 border-red-200">' +
                                    '<div class="text-sm text-red-600">ì‚¬ìš©ëŸ‰ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (usageData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '</div>' +
                                    '</div>'
                            }
                        } catch (usageErr) {
                            console.error('[Usage] Error fetching usage:', usageErr)
                            usageHtml = '<div class="mt-6 pt-6 border-t-2 border-red-200">' +
                                '<div class="text-sm text-red-600">ì‚¬ìš©ëŸ‰ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + usageErr.message + '</div>' +
                                '</div>'
                        }
                        
                        statusDiv.innerHTML = 
                            '<div class="bg-gradient-to-r from-purple-100 to-blue-100 border-2 border-purple-300 rounded-xl p-6">' +
                                '<div class="flex items-center justify-between flex-wrap gap-4">' +
                                    '<div class="flex-1">' +
                                        '<div class="flex items-center gap-4 mb-4">' +
                                            '<div class="w-16 h-16 bg-gradient-to-br from-purple-300 to-purple-400 rounded-full flex items-center justify-center">' +
                                                '<svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>' +
                                                '</svg>' +
                                            '</div>' +
                                            '<div>' +
                                                '<div class="flex items-center gap-2 mb-1">' +
                                                    '<span class="text-lg font-bold text-gray-900">' + sub.planName + '</span>' +
                                                    '<span class="px-3 py-1 bg-green-500 text-white text-xs font-bold rounded-full">í™œì„±</span>' +
                                                '</div>' +
                                                '<div class="text-sm text-gray-700 font-medium mb-1">' +
                                                    'ğŸ“… ' + formatDate(startDate) + ' ~ ' + formatDate(endDate) +
                                                '</div>' +
                                                '<div class="flex items-center gap-4 text-xs">' +
                                                    '<span class="text-blue-600 font-bold">â³ ' + daysLeft + 'ì¼ ë‚¨ìŒ</span>' +
                                                    '<span class="text-gray-500">ì´ ' + totalDays + 'ì¼ ì¤‘ ' + daysUsed + 'ì¼ ì‚¬ìš©</span>' +
                                                '</div>' +
                                            '</div>' +
                                        '</div>' +
                                        usageHtml +
                                    '</div>' +
                                    '<a href="/pricing" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-medium whitespace-nowrap">' +
                                        'í”Œëœ ë³€ê²½' +
                                    '</a>' +
                                '</div>' +
                            '</div>'
                    } else {
                        statusDiv.innerHTML = 
                            '<div class="bg-gradient-to-r from-orange-100 to-red-100 border-2 border-orange-300 rounded-xl p-6">' +
                                '<div class="flex items-center justify-between flex-wrap gap-4">' +
                                    '<div class="flex items-center gap-4">' +
                                        '<div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-red-500 rounded-full flex items-center justify-center">' +
                                            '<svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>' +
                                            '</svg>' +
                                        '</div>' +
                                        '<div>' +
                                            '<div class="text-lg font-bold text-gray-900 mb-1">êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤</div>' +
                                            '<div class="text-sm text-gray-600">' +
                                                'í”Œëœì„ êµ¬ë…í•˜ê³  ëª¨ë“  ê¸°ëŠ¥ì„ ì´ìš©í•˜ì„¸ìš”' +
                                            '</div>' +
                                        '</div>' +
                                    '</div>' +
                                    '<a href="/pricing" class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition font-medium whitespace-nowrap">' +
                                        'í”Œëœ ì„ íƒí•˜ê¸°' +
                                    '</a>' +
                                '</div>' +
                            '</div>'
                    }
                } catch (error) {
                    console.error('[Subscription Status] Error:', error)
                }
            }
            
            // ê¶Œí•œ ì²´í¬ í•¨ìˆ˜
            async function checkPermissions() {
                try {
                    // ë¨¼ì € êµ¬ë… ìƒíƒœ í™•ì¸
                    const subResponse = await fetch('/api/subscriptions/status')
                    const subData = await subResponse.json()
                    const hasSubscription = subData.success && subData.hasSubscription
                    
                    console.log('[checkPermissions] Subscription status:', hasSubscription)
                    
                    // êµ¬ë…ì´ ì—†ìœ¼ë©´ ëª¨ë“  í”„ë¡œê·¸ë¨ ì¹´ë“œ ìˆ¨ê¸°ê¸°
                    if (!hasSubscription && user.role !== 'admin') {
                        console.log('âŒ êµ¬ë… ì—†ìŒ - ëª¨ë“  í”„ë¡œê·¸ë¨ ìˆ¨ê¹€ (êµìœ¡ë¹„ ê´€ë¦¬ ì œì™¸)')
                        const allToolCards = document.querySelectorAll('.tool-card, [href*="/tools/"], [href*="/programs/"], .program-card')
                        allToolCards.forEach(card => {
                            card.style.display = 'none'
                        })
                        // SMS ì„¹ì…˜ë„ ìˆ¨ê¹€
                        const smsSection = document.getElementById('smsSection')
                        if (smsSection) smsSection.style.display = 'none'
                        
                        // êµìœ¡ë¹„ ê´€ë¦¬ëŠ” êµ¬ë… ì—†ì´ë„ í‘œì‹œ (ë¬´ë£Œ ê¸°ëŠ¥)
                        const tuitionCard = document.getElementById('tuitionManagementCard')
                        if (tuitionCard) {
                            // ì„ ìƒë‹˜ë§Œ ìˆ¨ê¹€, ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ í‘œì‹œ
                            if (user.user_type === 'teacher') {
                                console.log('âŒ ì„ ìƒë‹˜ ê³„ì • - êµìœ¡ë¹„ ê´€ë¦¬ ì¹´ë“œ ìˆ¨ê¹€')
                                tuitionCard.style.display = 'none'
                            } else {
                                console.log('âœ… í•™ì›ì¥/ê´€ë¦¬ì ê³„ì • - êµìœ¡ë¹„ ê´€ë¦¬ ì¹´ë“œ í‘œì‹œ')
                                console.log('   user.role:', user.role, 'user.user_type:', user.user_type)
                                tuitionCard.style.display = 'block'
                            }
                        }
                        
                        // ë§¤ì¶œ ê´€ë¦¬ë„ êµ¬ë… ì—†ì´ í‘œì‹œ (ë¬´ë£Œ ê¸°ëŠ¥)
                        const revenueCard = document.getElementById('revenueManagementCard')
                        if (revenueCard) {
                            if (user.user_type === 'teacher') {
                                console.log('âŒ ì„ ìƒë‹˜ ê³„ì • - ë§¤ì¶œ ê´€ë¦¬ ì¹´ë“œ ìˆ¨ê¹€')
                                revenueCard.style.display = 'none'
                            } else {
                                console.log('âœ… í•™ì›ì¥/ê´€ë¦¬ì ê³„ì • - ë§¤ì¶œ ê´€ë¦¬ ì¹´ë“œ í‘œì‹œ')
                                revenueCard.style.display = 'block'
                            }
                        }
                        return
                    }
                    
                    const response = await fetch('/api/user/permissions?userId=' + user.id)
                    const data = await response.json()
                    
                    console.log('ğŸ” checkPermissions - ê¶Œí•œ ì¡°íšŒ ê²°ê³¼:', data)
                    
                    // êµìœ¡ë¹„ ê´€ë¦¬ ì¹´ë“œëŠ” í•­ìƒ ì²˜ë¦¬ (API ì„±ê³µ/ì‹¤íŒ¨ ë¬´ê´€)
                    const tuitionCard = document.getElementById('tuitionManagementCard')
                    if (tuitionCard) {
                        if (user.user_type === 'teacher') {
                            console.log('âŒ ì„ ìƒë‹˜ ê³„ì • - êµìœ¡ë¹„ ê´€ë¦¬ ì¹´ë“œ ìˆ¨ê¹€')
                            tuitionCard.style.display = 'none'
                        } else {
                            console.log('âœ… í•™ì›ì¥/ê´€ë¦¬ì ê³„ì • - êµìœ¡ë¹„ ê´€ë¦¬ ì¹´ë“œ í‘œì‹œ')
                            console.log('   user.role:', user.role, 'user.user_type:', user.user_type)
                            tuitionCard.style.display = 'block'
                        }
                    }
                    
                    // ë§¤ì¶œ ê´€ë¦¬ ì¹´ë“œë„ í•­ìƒ ì²˜ë¦¬ (API ì„±ê³µ/ì‹¤íŒ¨ ë¬´ê´€)
                    const revenueCard = document.getElementById('revenueManagementCard')
                    if (revenueCard) {
                        if (user.user_type === 'teacher') {
                            console.log('âŒ ì„ ìƒë‹˜ ê³„ì • - ë§¤ì¶œ ê´€ë¦¬ ì¹´ë“œ ìˆ¨ê¹€')
                            revenueCard.style.display = 'none'
                        } else {
                            console.log('âœ… í•™ì›ì¥/ê´€ë¦¬ì ê³„ì • - ë§¤ì¶œ ê´€ë¦¬ ì¹´ë“œ í‘œì‹œ')
                            revenueCard.style.display = 'block'
                        }
                    }
                    
                    if (data.success) {
                        const permissions = data.permissions
                        console.log('âœ… checkPermissions - í˜„ì¬ ê¶Œí•œ:', permissions)
                        
                        // ê´€ë¦¬ìëŠ” ëª¨ë“  ë„êµ¬ í‘œì‹œ
                        if (user.role === 'admin') {
                            console.log('âœ… ê´€ë¦¬ì ê³„ì • - ëª¨ë“  ë„êµ¬ í‘œì‹œ')
                            // ê´€ë¦¬ìëŠ” SMS ì„¹ì…˜ê³¼ ë„¤ë¹„ê²Œì´ì…˜ë„ ëª¨ë‘ í‘œì‹œ
                            const smsSection = document.getElementById('smsSection')
                            if (smsSection) smsSection.style.display = 'block'
                            const smsNavDropdown = document.getElementById('smsNavDropdown')
                            if (smsNavDropdown) smsNavDropdown.classList.remove('hidden')
                            return
                        }
                        
                        // ê° ë„êµ¬ë³„ ê¶Œí•œ ì²´í¬ ë° ìˆ¨ê¹€ ì²˜ë¦¬
                        const toolMapping = {
                            'search_volume': 'a[href="/tools/search-volume"]',
                            'parent_message': 'a[href="/tools/parent-message"]',
                            'blog_writer': 'a[href="/tools/blog-writer"]',
                            'landing_builder': 'a[href="/tools/landing-builder"]',
                            'sms_sender': 'a[href="/tools/sms-sender"]',
                            'student_management': 'a[href="/students"]',
                            'dashboard_analytics': 'a[href="/tools/dashboard-analytics"]',
                            'ai_learning_report': 'a[href="/tools/ai-learning-report"]',
                            'keyword_analyzer': 'a[href="/tools/keyword-analyzer"]',
                            'review_template': 'a[href="/tools/review-template"]',
                            'ad_copy_generator': 'a[href="/tools/ad-copy-generator"]',
                            'photo_optimizer': 'a[href="/tools/photo-optimizer"]',
                            'competitor_analysis': 'a[href="/tools/competitor-analysis"]',
                            'blog_checklist': 'a[href="/tools/blog-checklist"]',
                            'content_calendar': 'a[href="/tools/content-calendar"]',
                            'consultation_script': 'a[href="/tools/consultation-script"]',
                            'place_optimization': 'a[href="/tools/place-optimization"]',
                            'roi_calculator': 'a[href="/tools/roi-calculator"]'
                        }
                        
                        // ëª¨ë“  ë„êµ¬ ì¹´ë“œë¥¼ ë¨¼ì € ìˆ¨ê¹€
                        Object.values(toolMapping).forEach(selector => {
                            const elements = document.querySelectorAll(selector)
                            elements.forEach(el => {
                                el.style.display = 'none'
                            })
                        })
                        
                        // ê¶Œí•œì´ ìˆëŠ” ë„êµ¬ë§Œ í‘œì‹œ
                        Object.keys(permissions).forEach(permKey => {
                            if (permissions[permKey] && toolMapping[permKey]) {
                                const elements = document.querySelectorAll(toolMapping[permKey])
                                elements.forEach(el => {
                                    el.style.display = ''
                                })
                                console.log('âœ… ê¶Œí•œ ìˆìŒ:', permKey)
                            }
                        })
                        
                        // SMS ë„¤ë¹„ê²Œì´ì…˜ ë“œë¡­ë‹¤ìš´ ë° ì„¹ì…˜ (sms ë˜ëŠ” sms_sender ê¶Œí•œìœ¼ë¡œ ì²´í¬ - í˜¸í™˜ì„±)
                        if (permissions.sms || permissions.sms_sender) {
                            document.getElementById('smsNavDropdown')?.classList.remove('hidden')
                            document.getElementById('smsQuickAccess')?.classList.remove('hidden')
                            const smsSection = document.getElementById('smsSection')
                            if (smsSection) {
                                smsSection.style.display = 'block'
                            }
                            console.log('âœ… SMS ê¶Œí•œ ìˆìŒ (sms ë˜ëŠ” sms_sender)')
                        } else {
                            // SMS ê¶Œí•œì´ ì—†ìœ¼ë©´ ìˆ¨ê¹€
                            const smsSection = document.getElementById('smsSection')
                            if (smsSection) {
                                smsSection.style.display = 'none'
                            }
                            console.log('âŒ SMS ê¶Œí•œ ì—†ìŒ')
                        }
                    }
                } catch (err) {
                    console.error('ê¶Œí•œ ì¡°íšŒ ì‹¤íŒ¨:', err)
                    // ì—ëŸ¬ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë‘ ìˆ¨ê¹€ (ê´€ë¦¬ìëŠ” ì œì™¸)
                    if (user.role !== 'admin') {
                        // ëª¨ë“  ë„êµ¬ ì¹´ë“œ ìˆ¨ê¸°ê¸°
                        const allTools = document.querySelectorAll('a[href^="/tools/"], a[href="/students"]')
                        allTools.forEach(tool => {
                            tool.style.display = 'none'
                        })
                    }
                }
            }
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
            checkUserPermissions()
            loadUserPoints()
            loadMyLandingPages()
            loadLandingFolders()
            loadStudentCount()
            loadTeacherCount()
            
            // í•™ìƒ/ì„ ìƒë‹˜ ìˆ˜ ìë™ ê°±ì‹  (30ì´ˆë§ˆë‹¤)
            setInterval(() => {
                loadStudentCount()
                loadTeacherCount()
                loadMyLandingPages()
                loadLandingFolders()
            }, 30000) // 30ì´ˆ
            
            // í˜ì´ì§€ê°€ ë‹¤ì‹œ í¬ì»¤ìŠ¤ë¥¼ ë°›ì„ ë•Œ ê°±ì‹ 
            window.addEventListener('focus', () => {
                loadStudentCount()
                loadTeacherCount()
                loadMyLandingPages()
                loadLandingFolders()
            })
            
            // ë‹¤ë¥¸ íƒ­ì—ì„œ ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œ ê°±ì‹  (storage ì´ë²¤íŠ¸)
            window.addEventListener('storage', (e) => {
                if (e.key === 'students_updated' || e.key === 'teachers_updated') {
                    loadStudentCount()
                    loadTeacherCount()
                }
            })

            function returnToAdmin() {
                const originalAdmin = JSON.parse(localStorage.getItem('original_admin'))
                if (originalAdmin) {
                    localStorage.setItem('user', JSON.stringify(originalAdmin))
                    localStorage.removeItem('original_admin')
                    localStorage.removeItem('is_impersonating')
                    alert('ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ ë³µê·€í•©ë‹ˆë‹¤.')
                    window.location.href = '/admin/users.html'
                }
            }

            function logout() {
                localStorage.removeItem('user')
                localStorage.removeItem('original_admin')
                localStorage.removeItem('is_impersonating')
                window.location.href = '/'
            }

            // í¬ì¸íŠ¸ ì‹¤ì‹œê°„ ë¡œë“œ
            async function loadUserPoints() {
                const user = JSON.parse(localStorage.getItem('user'))
                if (user && user.id) {
                    try {
                        const response = await fetch('/api/users/' + user.id + '/points')
                        const data = await response.json()
                        if (data.success) {
                            const points = data.points || 0
                            document.getElementById('userPoints').textContent = points.toLocaleString()
                            // SMS ì„¹ì…˜ì˜ í¬ì¸íŠ¸ë„ ì—…ë°ì´íŠ¸
                            const dashboardPointsEl = document.getElementById('dashboardPoints')
                            if (dashboardPointsEl) {
                                dashboardPointsEl.textContent = points.toLocaleString()
                            }
                            
                            // localStorageë„ ì—…ë°ì´íŠ¸
                            user.points = points
                            localStorage.setItem('user', JSON.stringify(user))
                        }
                    } catch (err) {
                        console.error('í¬ì¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', err)
                    }
                }
            }

            async function loadStudentCount() {
                const user = JSON.parse(localStorage.getItem('user'))
                if (user && user.id) {
                    try {
                        // í—¤ë” ë°©ì‹ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ì „ë‹¬
                        const userDataHeader = btoa(unescape(encodeURIComponent(JSON.stringify(user))));
                        const response = await fetch('/api/students', {
                            headers: {
                                'X-User-Data-Base64': userDataHeader
                            }
                        })
                        const data = await response.json()
                        console.log('í•™ìƒ ìˆ˜ ë¡œë“œ:', data)
                        if (data.success && data.students) {
                            const count = data.students.length
                            document.getElementById('studentCount').textContent = count
                            console.log('í•™ìƒ ìˆ˜ ì—…ë°ì´íŠ¸:', count)
                        }
                    } catch (err) {
                        console.error('í•™ìƒ ìˆ˜ ë¡œë“œ ì‹¤íŒ¨:', err)
                    }
                }
            }

            async function loadTeacherCount() {
                const user = JSON.parse(localStorage.getItem('user'))
                if (user && user.id) {
                    try {
                        const response = await fetch('/api/teachers?userId=' + user.id)
                        const data = await response.json()
                        if (data.success && data.teachers) {
                            const count = data.teachers.length
                            document.getElementById('teacherCount').textContent = count
                        }
                    } catch (err) {
                        console.error('ì„ ìƒë‹˜ ìˆ˜ ë¡œë“œ ì‹¤íŒ¨:', err)
                    }
                }
            }

            // ì‚¬ìš©ì ê¶Œí•œ í™•ì¸ ë° ë©”ë‰´ í‘œì‹œ/ìˆ¨ê¹€
            async function checkUserPermissions() {
                const user = JSON.parse(localStorage.getItem('user'))
                if (!user || !user.id) return
                
                try {
                    const response = await fetch('/api/user/permissions?userId=' + user.id)
                    const data = await response.json()
                    
                    console.log('ğŸ” ì‚¬ìš©ì ê¶Œí•œ ì¡°íšŒ ê²°ê³¼:', data)
                    
                    if (data.success && data.permissions) {
                        const permissions = data.permissions
                        console.log('âœ… í˜„ì¬ ì‚¬ìš©ì ê¶Œí•œ:', permissions)
                        
                        // search_volume ê¶Œí•œ ì²´í¬ - ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ
                        const searchVolumeCard = document.querySelector('a[href="/tools/search-volume"]')
                        if (searchVolumeCard) {
                            if (!permissions.search_volume) {
                                searchVolumeCard.style.display = 'none'
                                console.log('âŒ search_volume ê¶Œí•œ ì—†ìŒ - ì¹´ë“œ ìˆ¨ê¹€')
                            } else {
                                console.log('âœ… search_volume ê¶Œí•œ ìˆìŒ - ì¹´ë“œ í‘œì‹œ')
                            }
                        }
                        
                        // sms ê¶Œí•œ ì²´í¬ - SMS ë¬¸ì ë°œì†¡ (sms ë˜ëŠ” sms_sender í˜¸í™˜ì„±)
                        const smsSection = document.getElementById('smsSection')
                        if (smsSection) {
                            if (!permissions.sms && !permissions.sms_sender) {
                                smsSection.style.display = 'none'
                                console.log('âŒ sms ê¶Œí•œ ì—†ìŒ - SMS ì„¹ì…˜ ìˆ¨ê¹€')
                            } else {
                                smsSection.style.display = 'block'
                                console.log('âœ… sms ê¶Œí•œ ìˆìŒ - SMS ì„¹ì…˜ í‘œì‹œ')
                            }
                        }
                        
                        // SMS ë„¤ë¹„ê²Œì´ì…˜ ë“œë¡­ë‹¤ìš´ë„ sms ë˜ëŠ” sms_sender ê¶Œí•œìœ¼ë¡œ ì²´í¬
                        const smsNavDropdown = document.getElementById('smsNavDropdown')
                        if (smsNavDropdown) {
                            if (!permissions.sms && !permissions.sms_sender) {
                                smsNavDropdown.style.display = 'none'
                                console.log('âŒ sms ê¶Œí•œ ì—†ìŒ - SMS ë„¤ë¹„ê²Œì´ì…˜ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¹€')
                            } else {
                                smsNavDropdown.classList.remove('hidden')
                                console.log('âœ… sms ê¶Œí•œ ìˆìŒ - SMS ë„¤ë¹„ê²Œì´ì…˜ ë“œë¡­ë‹¤ìš´ í‘œì‹œ')
                            }
                        }
                        
                        // landing_builder ê¶Œí•œ ì²´í¬ - ëœë”©í˜ì´ì§€
                        const landingSection = document.getElementById('landingSection')
                        if (landingSection) {
                            if (!permissions.landing_builder) {
                                landingSection.style.display = 'none'
                                console.log('âŒ landing_builder ê¶Œí•œ ì—†ìŒ - ëœë”©í˜ì´ì§€ ì„¹ì…˜ ìˆ¨ê¹€')
                            } else {
                                landingSection.style.display = 'block'
                                console.log('âœ… landing_builder ê¶Œí•œ ìˆìŒ - ëœë”©í˜ì´ì§€ ì„¹ì…˜ í‘œì‹œ')
                            }
                        }
                        
                        // landing_builder ë„êµ¬ ì¹´ë“œë„ ìˆ¨ê¹€
                        const landingBuilderCard = document.querySelector('a[href="/tools/landing-builder"]')
                        if (landingBuilderCard && landingBuilderCard.closest('.grid')) {
                            // ëŒ€ì‹œë³´ë“œ ì™¸ë¶€ì˜ landing-builder ë§í¬ë§Œ ì²´í¬
                            const isInDashboardSection = landingBuilderCard.closest('#landingSection')
                            if (!isInDashboardSection && !permissions.landing_builder) {
                                landingBuilderCard.style.display = 'none'
                                console.log('âŒ landing_builder ê¶Œí•œ ì—†ìŒ - ì™¸ë¶€ ì¹´ë“œ ìˆ¨ê¹€')
                            }
                        }
                    }
                } catch (err) {
                    console.error('ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨:', err)
                }
            }

            // ë‚´ ëœë”©í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
            async function loadMyLandingPages() {
                const user = JSON.parse(localStorage.getItem('user'))
                if (user && user.id) {
                    try {
                        const response = await fetch('/api/landing/my-pages?userId=' + user.id)
                        const data = await response.json()
                        
                        const container = document.getElementById('landingPagesList')
                        
                        if (data.success && data.pages && data.pages.length > 0) {
                            // í†µê³„ ì—…ë°ì´íŠ¸
                            const totalPages = data.pages.length
                            const totalViews = data.pages.reduce((sum, page) => sum + (page.view_count || 0), 0)
                            
                            // í˜ì´ì§€ ìˆ˜ ì—…ë°ì´íŠ¸
                            const pagesCountEl = document.getElementById('landingPagesCount')
                            if (pagesCountEl) pagesCountEl.textContent = totalPages
                            
                            // ì¡°íšŒìˆ˜ ì—…ë°ì´íŠ¸
                            const viewsCountEl = document.getElementById('landingViewsCount')
                            if (viewsCountEl) viewsCountEl.textContent = totalViews.toLocaleString()
                            
                            // ìµœê·¼ 4ê°œë§Œ í‘œì‹œ (2x2 ê·¸ë¦¬ë“œ)
                            const recentPages = data.pages.slice(0, 4)
                            container.innerHTML = recentPages.map(page => {
                                const pageUrl = window.location.origin + '/landing/' + page.slug
                                const statusBadge = page.status === 'active' 
                                    ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full">í™œì„±</span>'
                                    : '<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">ë¹„í™œì„±</span>'
                                
                                return '<div class="bg-white border border-gray-200 rounded-xl p-6 hover:shadow-lg transition">' +
                                    '<div class="flex justify-between items-start mb-3">' +
                                        '<h3 class="font-bold text-gray-900 text-lg">' + page.title + '</h3>' +
                                        statusBadge +
                                    '</div>' +
                                    '<div class="text-sm text-gray-600 mb-4">' +
                                        '<div class="flex items-center gap-2 mb-2">' +
                                            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>' +
                                            '<span>ì¡°íšŒìˆ˜: ' + (page.view_count || 0) + 'íšŒ</span>' +
                                        '</div>' +
                                        '<div class="text-xs text-gray-500">' +
                                            'ìƒì„±ì¼: ' + new Date(page.created_at).toLocaleDateString('ko-KR') +
                                        '</div>' +
                                    '</div>' +
                                    '<div class="flex gap-2">' +
                                        '<a href="' + pageUrl + '" target="_blank" class="flex-1 px-3 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition text-center">' +
                                            'ë¯¸ë¦¬ë³´ê¸°' +
                                        '</a>' +
                                        '<button onclick="copyUrl(' + "'" + pageUrl + "'" + ')" class="px-3 py-2 bg-gray-100 text-gray-700 text-sm rounded-lg hover:bg-gray-200 transition">' +
                                            'ğŸ”—' +
                                        '</button>' +
                                    '</div>' +
                                '</div>'
                            }).join('')
                        } else {
                            // ëœë”©í˜ì´ì§€ê°€ ì—†ì„ ë•Œ ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ ë° í†µê³„ ì´ˆê¸°í™”
                            const pagesCountEl = document.getElementById('landingPagesCount')
                            if (pagesCountEl) pagesCountEl.textContent = '0'
                            
                            const viewsCountEl = document.getElementById('landingViewsCount')
                            if (viewsCountEl) viewsCountEl.textContent = '0'
                            
                            container.innerHTML = '<div class="col-span-2 text-center py-12 text-gray-500">' +
                                '<p class="mb-4">ì•„ì§ ìƒì„±í•œ ëœë”©í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤</p>' +
                                '<a href="/tools/landing-builder" class="inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">' +
                                'ì²« ëœë”©í˜ì´ì§€ ë§Œë“¤ê¸°' +
                                '</a>' +
                                '</div>'
                        }
                    } catch (err) {
                        console.error('ëœë”©í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨:', err)
                        const container = document.getElementById('landingPagesList')
                        if (container) {
                            container.innerHTML = '<div class="col-span-2 text-center py-12 text-red-500">ë¡œë”© ì‹¤íŒ¨</div>'
                        }
                    }
                }
            }

            // ëœë”©í˜ì´ì§€ í´ë” ìˆ˜ ë¡œë“œ
            async function loadLandingFolders() {
                const user = JSON.parse(localStorage.getItem('user'))
                if (user && user.id) {
                    try {
                        const response = await fetch('/api/landing/folders?userId=' + user.id)
                        const data = await response.json()
                        
                        if (data.success && data.folders) {
                            const foldersCountEl = document.getElementById('landingFoldersCount')
                            if (foldersCountEl) {
                                foldersCountEl.textContent = data.folders.length
                            }
                        }
                    } catch (err) {
                        console.error('í´ë” ìˆ˜ ë¡œë“œ ì‹¤íŒ¨:', err)
                    }
                }
            }

            // URL ë³µì‚¬
            function copyUrl(url) {
                navigator.clipboard.writeText(url).then(() => {
                    alert('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ' + url)
                }).catch(err => {
                    alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err)
                })
            }

            // 5ì´ˆë§ˆë‹¤ í¬ì¸íŠ¸ ìë™ ê°±ì‹ 
            setInterval(loadUserPoints, 5000)

            // ì…ê¸ˆ ì‹ ì²­ ëª¨ë‹¬ ì—´ê¸°
            function openDepositModal() {
                document.getElementById('depositModal').classList.remove('hidden')
            }

            // ì…ê¸ˆ ì‹ ì²­ ëª¨ë‹¬ ë‹«ê¸°
            function closeDepositModal() {
                document.getElementById('depositModal').classList.add('hidden')
            }

            // ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬
            function copyAccountNumber() {
                const accountNumber = '746-910023-17004'
                navigator.clipboard.writeText(accountNumber).then(() => {
                    alert('ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ' + accountNumber)
                }).catch(err => {
                    alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err)
                })
            }

            // ì…ê¸ˆ ì‹ ì²­
            function calculateTotal() {
                const amountInput = document.getElementById('depositAmount');
                const amount = parseInt(amountInput.value) || 0;
                const vat = Math.round(amount * 0.1);
                const total = amount + vat;
                
                document.getElementById('displayPoints').textContent = amount.toLocaleString() + 'P';
                document.getElementById('displayVAT').textContent = '+' + vat.toLocaleString() + 'ì›';
                document.getElementById('displayTotal').textContent = total.toLocaleString() + 'ì›';
            }

            async function submitDeposit() {
                const user = JSON.parse(localStorage.getItem('user'))
                const amount = parseInt(document.getElementById('depositAmount').value) || 0
                const vat = Math.round(amount * 0.1)
                const totalAmount = amount + vat
                const bankName = document.getElementById('bankName').value
                const accountNumber = document.getElementById('accountNumber').value
                const depositorName = document.getElementById('depositorName').value
                const message = document.getElementById('depositMessage').value

                if (!amount || amount <= 0) {
                    alert('ì¶©ì „í•  í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.')
                    return
                }

                try {
                    const response = await fetch('/api/deposit/request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            userName: user.name,
                            userEmail: user.email,
                            amount: amount, // í¬ì¸íŠ¸ ê¸ˆì•¡ (ë¶€ê°€ì„¸ ì œì™¸)
                            totalAmount: totalAmount, // ì‹¤ì œ ì…ê¸ˆì•¡ (ë¶€ê°€ì„¸ í¬í•¨)
                            bankName,
                            accountNumber,
                            depositorName,
                            message: message + ' [í¬ì¸íŠ¸: ' + amount.toLocaleString() + 'P + ë¶€ê°€ì„¸: ' + vat.toLocaleString() + 'ì› = ì´ ' + totalAmount.toLocaleString() + 'ì›]'
                        })
                    })

                    const data = await response.json()
                    if (data.success) {
                        alert('ì…ê¸ˆ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nì¶©ì „ í¬ì¸íŠ¸: ' + amount.toLocaleString() + 'P\\në¶€ê°€ì„¸ (10%): ' + vat.toLocaleString() + 'ì›\\nì…ê¸ˆí•˜ì‹¤ ê¸ˆì•¡: ' + totalAmount.toLocaleString() + 'ì›\\n\\nê´€ë¦¬ì í™•ì¸ í›„ ' + amount.toLocaleString() + 'Pê°€ ì§€ê¸‰ë©ë‹ˆë‹¤.')
                        closeDepositModal()
                        // í¼ ì´ˆê¸°í™”
                        document.getElementById('depositAmount').value = ''
                        document.getElementById('bankName').value = ''
                        document.getElementById('accountNumber').value = ''
                        document.getElementById('depositorName').value = ''
                        document.getElementById('depositMessage').value = ''
                        calculateTotal() // ê¸ˆì•¡ í‘œì‹œ ì´ˆê¸°í™”
                    } else {
                        alert('ì˜¤ë¥˜: ' + data.error)
                    }
                } catch (err) {
                    alert('ì…ê¸ˆ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
                }
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ í¬ì¸íŠ¸ ë¡œë“œ
            loadUserPoints()
            
            document.addEventListener('DOMContentLoaded', () => {
                loadUserPoints()
            })
        </script>

        <!-- ì…ê¸ˆ ì‹ ì²­ ëª¨ë‹¬ -->
        <div id="depositModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 my-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">ğŸ’° ì…ê¸ˆ ì‹ ì²­</h3>
                    <button onclick="closeDepositModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- ê³„ì¢Œ ì •ë³´ -->
                <div class="bg-gradient-to-r from-blue-300 to-blue-400 rounded-xl p-5 mb-6 text-white">
                    <h4 class="font-bold mb-3 flex items-center gap-2">
                        <i class="fas fa-university"></i>
                        ì…ê¸ˆ ê³„ì¢Œ ì •ë³´
                    </h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-blue-100">ì€í–‰</span>
                            <span class="font-bold">í•˜ë‚˜ì€í–‰</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-100">ê³„ì¢Œë²ˆí˜¸</span>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-lg">746-910023-17004</span>
                                <button onclick="copyAccountNumber()" class="bg-white text-blue-600 px-3 py-1 rounded text-xs font-bold hover:bg-blue-50 transition">
                                    ë³µì‚¬
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-blue-100">ì˜ˆê¸ˆì£¼</span>
                            <span class="font-bold">ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì¶©ì „í•  í¬ì¸íŠ¸ *</label>
                        <input type="number" id="depositAmount" placeholder="10000" 
                               onkeyup="calculateTotal()" onchange="calculateTotal()"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">ì…ë ¥í•œ ê¸ˆì•¡ë§Œí¼ í¬ì¸íŠ¸ê°€ ì¶©ì „ë©ë‹ˆë‹¤</p>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">ì¶©ì „ í¬ì¸íŠ¸</span>
                            <span class="text-lg font-semibold text-gray-900" id="displayPoints">0P</span>
                        </div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">ë¶€ê°€ì„¸ (10%)</span>
                            <span class="text-lg font-semibold text-gray-900" id="displayVAT">+0ì›</span>
                        </div>
                        <div class="border-t border-blue-300 pt-2 mt-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-900">ìµœì¢… ì…ê¸ˆì•¡</span>
                                <span class="text-xl font-bold text-blue-600" id="displayTotal">0ì›</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì€í–‰ëª…</label>
                        <input type="text" id="bankName" placeholder="êµ­ë¯¼ì€í–‰" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê³„ì¢Œë²ˆí˜¸</label>
                        <input type="text" id="accountNumber" placeholder="123-45-678901" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì…ê¸ˆìëª…</label>
                        <input type="text" id="depositorName" placeholder="í™ê¸¸ë™" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë©”ëª¨</label>
                        <textarea id="depositMessage" rows="3" placeholder="ì¶”ê°€ ë©”ì‹œì§€ (ì„ íƒì‚¬í•­)" 
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button onclick="closeDepositModal()" 
                                class="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
                            ì·¨ì†Œ
                        </button>
                        <button onclick="submitDeposit()" 
                                class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            ì‹ ì²­í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="bg-gray-900 text-gray-300 py-12 mt-20">
            <div class="max-w-7xl mx-auto px-6">
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div>
                        <h3 class="text-white font-bold text-lg mb-4">ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</h3>
                        <div class="space-y-2 text-sm">
                            <p>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 142-88-02445</p>
                            <p>ì£¼ì†Œ: ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬ ì²­ë¼ì»¤ë‚¼ë¡œ 270, 2ì¸µ</p>
                            <p>ì´ë©”ì¼: wangholy1@naver.com | ì „í™”: 010-8739-9697</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-white font-bold text-lg mb-4">ë²•ì  ê³ ì§€</h3>
                        <div class="space-y-2 text-sm">
                            <a href="/privacy-policy" class="block hover:text-white transition">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
                            <a href="/signup" class="block hover:text-white transition">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</a>
                        </div>
                    </div>
                </div>
                <div class="border-t border-gray-700 pt-6 text-center text-sm">
                    <p>Â© 2024 ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </body>
    </html>
  `)
})

// SMS ë°œì†¡ í˜ì´ì§€
app.get('/tools/sms-sender', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ìë™ ë¬¸ì ë°œì†¡ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <span class="text-xl font-bold text-gray-900">ìë™ ë¬¸ì ë°œì†¡</span>
                    <div class="flex gap-4">
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <button onclick="logout()" class="text-gray-600 hover:text-red-600">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-7xl mx-auto">
                <div class="mb-8">
                    <h1 class="text-4xl font-bold text-gray-900 mb-3">ğŸ“± ìë™ ë¬¸ì ë°œì†¡ ì‹œìŠ¤í…œ</h1>
                    <p class="text-lg text-gray-600">í…œí”Œë¦¿ì„ ì„ íƒí•˜ê³  í•™ë¶€ëª¨ë‹˜ê»˜ ë¬¸ìë¥¼ ë°œì†¡í•˜ì„¸ìš”</p>
                </div>

                <!-- í†µê³„ -->
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 border border-gray-200">
                        <div class="text-sm text-gray-600 mb-2">ì˜¤ëŠ˜ ë°œì†¡</div>
                        <div class="text-3xl font-bold text-gray-900" id="statToday">0</div>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-gray-200">
                        <div class="text-sm text-gray-600 mb-2">ì´ë²ˆ ë‹¬ ë°œì†¡</div>
                        <div class="text-3xl font-bold text-gray-900" id="statMonth">0</div>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-gray-200">
                        <div class="text-sm text-gray-600 mb-2">ëŒ€ê¸°ì¤‘</div>
                        <div class="text-3xl font-bold text-orange-600" id="statPending">0</div>
                    </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- ë¬¸ì ë°œì†¡ í¼ -->
                    <div class="bg-white rounded-xl p-8 border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ë¬¸ì ë°œì†¡</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">í…œí”Œë¦¿ ì„ íƒ</label>
                                <select id="templateSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl" onchange="loadTemplate()">
                                    <option value="">í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ìˆ˜ì‹ ì ì´ë¦„</label>
                                <input type="text" id="recipientName" placeholder="í™ê¸¸ë™" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ìˆ˜ì‹ ì ì „í™”ë²ˆí˜¸</label>
                                <input type="tel" id="recipientPhone" placeholder="01012345678" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ë©”ì‹œì§€ ë‚´ìš©</label>
                                <textarea id="messageContent" rows="6" class="w-full px-4 py-3 border border-gray-300 rounded-xl" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                                <div class="text-sm text-gray-500 mt-2">
                                    <span id="charCount">0</span>/90ì (í•œê¸€ ê¸°ì¤€)
                                </div>
                            </div>

                            <div class="flex gap-3">
                                <button onclick="sendSMS()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">
                                    ì¦‰ì‹œ ë°œì†¡
                                </button>
                                <button onclick="scheduleSMS()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">
                                    ì˜ˆì•½ ë°œì†¡
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ë°œì†¡ ê¸°ë¡ -->
                    <div class="bg-white rounded-xl p-8 border border-gray-200">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ìµœê·¼ ë°œì†¡ ê¸°ë¡</h2>
                        <div id="historyList" class="space-y-3 max-h-[600px] overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">ë°œì†¡ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        let templates = [];
        let user = null;

        // ë¡œê·¸ì¸ ì²´í¬
        const userData = localStorage.getItem('user');
        if (userData) {
            user = JSON.parse(userData);
        } else {
            user = { id: 1, name: 'ê²ŒìŠ¤íŠ¸' };
        }

        function logout() {
            localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
            window.location.href = '/';
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        async function init() {
            await loadTemplates();
            await loadStats();
            await loadHistory();
        }

        // í…œí”Œë¦¿ ë¡œë“œ
        async function loadTemplates() {
            try {
                const response = await fetch('/api/sms/templates');
                const data = await response.json();
                if (data.success) {
                    templates = data.templates;
                    const select = document.getElementById('templateSelect');
                    select.innerHTML = '<option value="">í…œí”Œë¦¿ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    data.templates.forEach(t => {
                        select.innerHTML += \`<option value="\${t.id}">\${t.name} (\${t.category})</option>\`;
                    });
                }
            } catch (err) {
                console.error('í…œí”Œë¦¿ ë¡œë“œ ì˜¤ë¥˜:', err);
            }
        }

        // í…œí”Œë¦¿ ì„ íƒ ì‹œ
        function loadTemplate() {
            const templateId = document.getElementById('templateSelect').value;
            if (!templateId) return;
            
            const template = templates.find(t => t.id == templateId);
            if (template) {
                document.getElementById('messageContent').value = template.content;
                updateCharCount();
            }
        }

        // ê¸€ì ìˆ˜ ì¹´ìš´íŠ¸
        document.getElementById('messageContent').addEventListener('input', updateCharCount);
        function updateCharCount() {
            const text = document.getElementById('messageContent').value;
            document.getElementById('charCount').textContent = text.length;
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            try {
                const response = await fetch('/api/sms/stats');
                const data = await response.json();
                if (data.success) {
                    document.getElementById('statToday').textContent = data.stats.today;
                    document.getElementById('statMonth').textContent = data.stats.thisMonth;
                    const pending = data.stats.byStatus.find(s => s.status === 'pending' || s.status === 'scheduled');
                    document.getElementById('statPending').textContent = pending?.count || 0;
                }
            } catch (err) {
                console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', err);
            }
        }

        // ë°œì†¡ ê¸°ë¡ ë¡œë“œ
        async function loadHistory() {
            try {
                const response = await fetch('/api/sms/history');
                const data = await response.json();
                if (data.success && data.history.length > 0) {
                    const list = document.getElementById('historyList');
                    list.innerHTML = data.history.slice(0, 10).map(h => \`
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <div class="font-medium text-gray-900">\${h.recipient_name || 'ì´ë¦„ì—†ìŒ'}</div>
                                <span class="px-2 py-1 text-xs rounded \${h.status === 'sent' ? 'bg-green-100 text-green-700' : h.status === 'scheduled' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'}">\${h.status}</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-2">\${h.recipient_phone}</div>
                            <div class="text-sm text-gray-800 line-clamp-2">\${h.message_content}</div>
                            <div class="text-xs text-gray-500 mt-2">\${new Date(h.created_at).toLocaleString('ko-KR')}</div>
                        </div>
                    \`).join('');
                }
            } catch (err) {
                console.error('ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
            }
        }

        // ì¦‰ì‹œ ë°œì†¡
        async function sendSMS() {
            const name = document.getElementById('recipientName').value.trim();
            const phone = document.getElementById('recipientPhone').value.trim();
            const message = document.getElementById('messageContent').value.trim();
            const templateId = document.getElementById('templateSelect').value;

            if (!phone) {
                alert('ìˆ˜ì‹ ì ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            if (!message) {
                alert('ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            try {
                const userDataStr = JSON.stringify(user);
                const userDataBase64 = btoa(unescape(encodeURIComponent(userDataStr)));

                const response = await fetch('/api/sms/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-Data-Base64': userDataBase64
                    },
                    body: JSON.stringify({
                        recipient_phone: phone,
                        recipient_name: name,
                        message_content: message,
                        template_id: templateId || null
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('ë¬¸ìê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\\n' + (data.note || ''));
                    document.getElementById('recipientName').value = '';
                    document.getElementById('recipientPhone').value = '';
                    document.getElementById('messageContent').value = '';
                    document.getElementById('templateSelect').value = '';
                    await loadStats();
                    await loadHistory();
                } else {
                    alert('ë°œì†¡ ì‹¤íŒ¨: ' + data.error);
                }
            } catch (err) {
                console.error('ë°œì†¡ ì˜¤ë¥˜:', err);
                alert('ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
            }
        }

        // ì˜ˆì•½ ë°œì†¡
        function scheduleSMS() {
            const scheduledTime = prompt('ë°œì†¡ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD HH:MM í˜•ì‹)\\nì˜ˆ: 2024-12-20 14:00');
            if (!scheduledTime) return;

            alert('ì˜ˆì•½ ë°œì†¡ ê¸°ëŠ¥ì€ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤');
        }

        init();
        </script>
    </body>
    </html>
  `)
})

// í•™ë¶€ëª¨ ì†Œí†µ ì‹œìŠ¤í…œ í˜ì´ì§€
app.get('/tools/parent-message', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í•™ë¶€ëª¨ ì†Œí†µ ì‹œìŠ¤í…œ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
          .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
          }
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100 shadow-sm">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">ìŠˆí¼í”Œë ˆì´ìŠ¤</span>
                    </a>
                    <div class="flex items-center space-x-6">
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="/tools/parent-message" class="text-purple-600 font-medium">í•™ë¶€ëª¨ ì†Œí†µ</a>
                        <a href="/tools/blog-writer" class="text-gray-600 hover:text-purple-600">ë¸”ë¡œê·¸ ì‘ì„±</a>
                        <a href="/logout" class="text-gray-600 hover:text-purple-600">ë¡œê·¸ì•„ì›ƒ</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="pt-24 pb-12 px-6">
            <div class="max-w-5xl mx-auto">
                <div class="text-center mb-10">
                    <h1 class="text-4xl font-bold text-gray-900 mb-4">ğŸ“± í•™ë¶€ëª¨ ì†Œí†µ ì‹œìŠ¤í…œ</h1>
                    <p class="text-xl text-gray-600">ê°„ë‹¨í•œ ë©”ëª¨ë§Œ ì‘ì„±í•˜ë©´ AIê°€ ë”°ëœ»í•œ ë©”ì‹œì§€ë¡œ ë³€í™˜í•´ë“œë¦½ë‹ˆë‹¤</p>
                </div>

                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- ì…ë ¥ í¼ -->
                    <div class="bg-white rounded-2xl shadow-lg p-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">í•™ìƒ ì •ë³´ ì…ë ¥</h2>
                        
                        <form id="messageForm" class="space-y-6">
                            <!-- ê¸°ê°„ ì„ íƒ -->
                            <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4 mb-4">
                                <div class="text-sm font-medium text-blue-900 mb-3">ğŸ“… ì¡°íšŒ ê¸°ê°„ ì„¤ì •</div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-medium text-blue-800 mb-1">ì‹œì‘ì¼</label>
                                        <input type="date" id="startDate" required
                                               class="w-full px-3 py-2 border border-blue-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-blue-800 mb-1">ì¢…ë£Œì¼</label>
                                        <input type="date" id="endDate" required
                                               class="w-full px-3 py-2 border border-blue-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                                    </div>
                                </div>
                                <div class="mt-3 flex gap-2">
                                    <button type="button" onclick="setDateRange(7)" class="flex-1 px-3 py-1 text-xs bg-white border border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50">ìµœê·¼ 7ì¼</button>
                                    <button type="button" onclick="setDateRange(30)" class="flex-1 px-3 py-1 text-xs bg-white border border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50">ìµœê·¼ 30ì¼</button>
                                    <button type="button" onclick="setDateRange(90)" class="flex-1 px-3 py-1 text-xs bg-white border border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50">ìµœê·¼ 90ì¼</button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">í•™ìƒ ì„ íƒ *</label>
                                <select id="studentSelect" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                                        onchange="loadStudentRecords()">
                                    <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                                <p class="text-sm text-gray-500 mt-2">ğŸ’¡ í•™ìƒì„ ì„ íƒí•˜ë©´ ì„¤ì •í•œ ê¸°ê°„ì˜ í•™ìŠµ ê¸°ë¡ì„ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</p>
                            </div>

                            <div id="studentInfoDisplay" class="hidden bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4">
                                <div class="text-sm font-medium text-blue-900 mb-2">ğŸ“Š í•™ìƒ ì •ë³´</div>
                                <div id="studentDetails" class="text-sm text-blue-800"></div>
                            </div>

                            <div id="periodSummaryDisplay" class="hidden bg-purple-50 border-l-4 border-purple-500 rounded-lg p-4">
                                <div class="text-sm font-medium text-purple-900 mb-2">ğŸ“ˆ ì„ íƒ ê¸°ê°„ í†µê³„</div>
                                <div id="periodSummary" class="text-sm text-purple-800"></div>
                            </div>

                            <div id="recentRecordsDisplay" class="hidden">
                                <label class="block text-sm font-medium text-gray-900 mb-2">
                                    ì„ íƒ ê¸°ê°„ í•™ìŠµ ê¸°ë¡ (<span id="recordCount">0</span>ê±´)
                                </label>
                                <div id="recordsList" class="space-y-2 max-h-60 overflow-y-auto bg-gray-50 rounded-lg p-4"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì¶”ê°€ ë©”ëª¨ (ì„ íƒì‚¬í•­)</label>
                                <textarea id="shortMessage" rows="3"
                                          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none resize-none"
                                          placeholder="ì˜ˆ: ì´ë²ˆ ë‹¬ íŠ¹ë³„íˆ ì¹­ì°¬í•˜ê³  ì‹¶ì€ ì ì´ë‚˜ í•™ë¶€ëª¨ë‹˜ê»˜ ì¶”ê°€ë¡œ ì „ë‹¬í•  ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                                <p class="text-sm text-gray-500 mt-2">ğŸ’¡ í•™ìƒì˜ ì„ íƒ ê¸°ê°„ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ë©”ì‹œì§€ê°€ ìƒì„±ë©ë‹ˆë‹¤. ì¶”ê°€ë¡œ ì „ë‹¬í•  ë‚´ìš©ì´ ìˆìœ¼ë©´ ì…ë ¥í•˜ì„¸ìš”.</p>
                            </div>

                            <button type="submit" 
                                    class="w-full gradient-purple text-white py-4 rounded-xl text-lg font-medium hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                    id="generateBtn"
                                    disabled>
                                <span id="btnText">âœ¨ AI ë©”ì‹œì§€ ìƒì„±í•˜ê¸°</span>
                                <span id="btnLoading" class="hidden items-center justify-center">
                                    <span class="loading mr-2"></span>
                                    ìƒì„± ì¤‘...
                                </span>
                            </button>
                        </form>
                    </div>

                    <!-- ìƒì„±ëœ ë©”ì‹œì§€ -->
                    <div class="bg-white rounded-2xl shadow-lg p-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ìƒì„±ëœ ë©”ì‹œì§€</h2>
                        
                        <div id="resultArea" class="hidden">
                            <div class="bg-purple-50 border-l-4 border-purple-600 rounded-lg p-6 mb-6">
                                <div class="flex items-start gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center text-white flex-shrink-0">
                                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-bold text-gray-900 mb-1" id="studentInfo"></div>
                                        <div class="text-sm text-gray-600" id="subjectInfo"></div>
                                    </div>
                                </div>
                                
                                <div id="generatedMessage" class="text-gray-800 leading-relaxed whitespace-pre-wrap"></div>
                            </div>

                            <div class="flex gap-3">
                                <button onclick="copyMessage()" 
                                        class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-medium hover:bg-purple-700 transition">
                                    ğŸ“‹ ë³µì‚¬í•˜ê¸°
                                </button>
                                <button onclick="resetForm()" 
                                        class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-medium hover:bg-gray-300 transition">
                                    ğŸ”„ ìƒˆë¡œ ì‘ì„±
                                </button>
                            </div>
                        </div>

                        <div id="emptyState" class="text-center py-16">
                            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                </svg>
                            </div>
                            <p class="text-gray-500">ì™¼ìª½ í¼ì„ ì‘ì„±í•˜ê³ <br>ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ë³´ì„¸ìš”</p>
                        </div>
                    </div>
                </div>

                <!-- ì‚¬ìš© ê°€ì´ë“œ -->
                <div class="mt-12 bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-8">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6">ğŸ’¡ ì‚¬ìš© ê°€ì´ë“œ</h3>
                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-xl p-6">
                            <div class="text-3xl mb-3">1ï¸âƒ£</div>
                            <h4 class="font-bold text-gray-900 mb-2">ê¸°ê°„ ë° í•™ìƒ ì„ íƒ</h4>
                            <p class="text-sm text-gray-600">ì¡°íšŒí•  ê¸°ê°„ì„ ì„¤ì •í•˜ê³  (ìµœê·¼ 7ì¼/30ì¼/90ì¼ ë˜ëŠ” ì§ì ‘ ì„ íƒ) í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</p>
                        </div>
                        <div class="bg-white rounded-xl p-6">
                            <div class="text-3xl mb-3">2ï¸âƒ£</div>
                            <h4 class="font-bold text-gray-900 mb-2">AIê°€ ìë™ ë¶„ì„</h4>
                            <p class="text-sm text-gray-600">ì„ íƒí•œ ê¸°ê°„ì˜ ì¶œì„ë¥ , ê³¼ì œ ì™„ì„±ë¥ , ì´í•´ë„, ì°¸ì—¬ë„ ë“±ì„ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ê³  AIê°€ ë”°ëœ»í•œ ë©”ì‹œì§€ë¡œ ë³€í™˜í•©ë‹ˆë‹¤</p>
                        </div>
                        <div class="bg-white rounded-xl p-6">
                            <div class="text-3xl mb-3">3ï¸âƒ£</div>
                            <h4 class="font-bold text-gray-900 mb-2">ë³µì‚¬í•´ì„œ ì „ì†¡</h4>
                            <p class="text-sm text-gray-600">ìƒì„±ëœ ë©”ì‹œì§€ë¥¼ ë³µì‚¬í•´ì„œ ì¹´í†¡ì´ë‚˜ ë¬¸ìë¡œ í•™ë¶€ëª¨ë‹˜ê»˜ ì „ì†¡í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let generatedMessageText = '';
            let currentStudent = null;
            let recentRecords = [];
            let currentUser = null;

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì í™•ì¸ ë° ì´ˆê¸°í™”
            function initPage() {
                const userData = localStorage.getItem('user');
                if (userData) {
                    currentUser = JSON.parse(userData);
                } else {
                    // ê²ŒìŠ¤íŠ¸ ëª¨ë“œ (í…ŒìŠ¤íŠ¸ìš©)
                    currentUser = { id: 1, name: 'ê²ŒìŠ¤íŠ¸', academy_id: 1 };
                }
                
                // ê¸°ë³¸ ê¸°ê°„ ì„¤ì • (ìµœê·¼ 30ì¼)
                setDateRange(30);
                
                // í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                loadStudents();
            }

            // ê¸°ê°„ ì„¤ì • í•¨ìˆ˜ (í•œêµ­ ì‹œê°„ëŒ€ KST ê¸°ì¤€)
            function setDateRange(days) {
                // í•œêµ­ ì‹œê°„ëŒ€(KST, UTC+9) í˜„ì¬ ë‚ ì§œ
                const now = new Date();
                const kstOffset = 9 * 60; // 9ì‹œê°„ì„ ë¶„ìœ¼ë¡œ ë³€í™˜
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                const kstTime = new Date(utc + (kstOffset * 60000));
                
                // ì¢…ë£Œì¼: ì˜¤ëŠ˜ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
                const endDate = new Date(kstTime.getFullYear(), kstTime.getMonth(), kstTime.getDate());
                
                // ì‹œì‘ì¼: ì˜¤ëŠ˜ë¡œë¶€í„° Nì¼ ì „ (í•œêµ­ ì‹œê°„ ê¸°ì¤€)
                const startDate = new Date(kstTime.getFullYear(), kstTime.getMonth(), kstTime.getDate());
                startDate.setDate(startDate.getDate() - (days - 1)); // Nì¼ê°„ = ì˜¤ëŠ˜ í¬í•¨ Nì¼
                
                // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return year + '-' + month + '-' + day;
                };
                
                document.getElementById('startDate').value = formatDate(startDate);
                document.getElementById('endDate').value = formatDate(endDate);
                
                console.log('ê¸°ê°„ ì„¤ì •: ' + formatDate(startDate) + ' ~ ' + formatDate(endDate) + ' (ìµœê·¼ ' + days + 'ì¼, í•œêµ­ ì‹œê°„ ê¸°ì¤€)');
                
                // í•™ìƒì´ ì´ë¯¸ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ ê¸°ë¡ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
                if (currentStudent) {
                    loadStudentRecords();
                }
            }

            // ì‚¬ìš©ìì˜ í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            async function loadStudents() {
                try {
                    const academyId = currentUser.academy_id || 1;
                    const response = await fetch('/api/students?academyId=' + academyId);
                    const data = await response.json();
                    
                    if (data.success) {
                        const select = document.getElementById('studentSelect');
                        select.innerHTML = '<option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
                        
                        data.students.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.textContent = student.name + ' (' + student.grade + ', ' + (student.class_name || 'ë¯¸ë°°ì •') + ')';
                            option.dataset.student = JSON.stringify(student);
                            select.appendChild(option);
                        });
                    }
                } catch (err) {
                    console.error('Error loading students:', err);
                    alert('í•™ìƒ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // í•™ìƒ ì„ íƒ ì‹œ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
            async function loadStudentRecords() {
                const select = document.getElementById('studentSelect');
                const selectedOption = select.options[select.selectedIndex];
                
                if (!selectedOption.value) {
                    document.getElementById('studentInfoDisplay').classList.add('hidden');
                    document.getElementById('periodSummaryDisplay').classList.add('hidden');
                    document.getElementById('recentRecordsDisplay').classList.add('hidden');
                    document.getElementById('generateBtn').disabled = true;
                    return;
                }

                currentStudent = JSON.parse(selectedOption.dataset.student);
                
                // ê¸°ê°„ í™•ì¸
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                
                if (!startDate || !endDate) {
                    alert('ì¡°íšŒ ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                // í•™ìƒ ì •ë³´ í‘œì‹œ
                document.getElementById('studentDetails').innerHTML = 
                    '<div><strong>ì´ë¦„:</strong> ' + currentStudent.name + '</div>' +
                    '<div><strong>í•™ë…„:</strong> ' + currentStudent.grade + '</div>' +
                    '<div><strong>ê³¼ëª©:</strong> ' + currentStudent.subjects + '</div>' +
                    '<div><strong>í•™ë¶€ëª¨:</strong> ' + currentStudent.parent_name + ' (' + currentStudent.parent_phone + ')</div>';
                document.getElementById('studentInfoDisplay').classList.remove('hidden');

                // ì„ íƒ ê¸°ê°„ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                try {
                    const response = await fetch('/api/daily-records?studentId=' + currentStudent.id + '&startDate=' + startDate + '&endDate=' + endDate);
                    const data = await response.json();
                    
                    if (data.success) {
                        recentRecords = data.records || [];
                        displayRecords();
                        displayPeriodSummary();
                        document.getElementById('generateBtn').disabled = false;
                    }
                } catch (err) {
                    console.error('Error loading records:', err);
                    alert('í•™ìŠµ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    document.getElementById('generateBtn').disabled = false;
                }
            }

            // ê¸°ê°„ í†µê³„ í‘œì‹œ
            function displayPeriodSummary() {
                if (recentRecords.length === 0) {
                    document.getElementById('periodSummaryDisplay').classList.add('hidden');
                    return;
                }

                const totalDays = recentRecords.length;
                const attendanceCount = recentRecords.filter(r => r.attendance === 'ì¶œì„').length;
                const homeworkCompleted = recentRecords.filter(r => r.homework_status === 'ì™„ë£Œ').length;
                
                const understandingScores = recentRecords.filter(r => r.understanding_level).map(r => r.understanding_level);
                const participationScores = recentRecords.filter(r => r.participation_level).map(r => r.participation_level);
                
                const avgUnderstanding = understandingScores.length > 0 
                    ? (understandingScores.reduce((a, b) => a + b, 0) / understandingScores.length).toFixed(1)
                    : 0;
                
                const avgParticipation = participationScores.length > 0
                    ? (participationScores.reduce((a, b) => a + b, 0) / participationScores.length).toFixed(1)
                    : 0;

                const attendanceRate = ((attendanceCount / totalDays) * 100).toFixed(0);
                const homeworkRate = totalDays > 0 ? ((homeworkCompleted / totalDays) * 100).toFixed(0) : 0;

                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;

                document.getElementById('periodSummary').innerHTML = 
                    '<div class="grid grid-cols-2 gap-2">' +
                        '<div><strong>ì¡°íšŒ ê¸°ê°„:</strong> ' + daysDiff + 'ì¼</div>' +
                        '<div><strong>ìˆ˜ì—… ì¼ìˆ˜:</strong> ' + totalDays + 'ì¼</div>' +
                        '<div><strong>ì¶œì„ë¥ :</strong> ' + attendanceRate + '%</div>' +
                        '<div><strong>ê³¼ì œ ì™„ì„±ë¥ :</strong> ' + homeworkRate + '%</div>' +
                        '<div><strong>í‰ê·  ì´í•´ë„:</strong> ' + avgUnderstanding + '/5ì </div>' +
                        '<div><strong>í‰ê·  ì°¸ì—¬ë„:</strong> ' + avgParticipation + '/5ì </div>' +
                    '</div>';

                document.getElementById('periodSummaryDisplay').classList.remove('hidden');
            }

            // ê¸°ë¡ í‘œì‹œ
            function displayRecords() {
                const recordsList = document.getElementById('recordsList');
                document.getElementById('recordCount').textContent = recentRecords.length;
                
                if (recentRecords.length === 0) {
                    recordsList.innerHTML = '<p class="text-gray-500 text-sm">ì„ íƒí•œ ê¸°ê°„ì— ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    document.getElementById('recentRecordsDisplay').classList.remove('hidden');
                    return;
                }

                recordsList.innerHTML = recentRecords.map(record => {
                    let attendanceClass = 'bg-gray-100 text-gray-800';
                    if (record.attendance === 'ì¶œì„') attendanceClass = 'bg-green-100 text-green-800';
                    else if (record.attendance === 'ì§€ê°') attendanceClass = 'bg-yellow-100 text-yellow-800';
                    else if (record.attendance === 'ê²°ì„') attendanceClass = 'bg-red-100 text-red-800';
                    
                    let html = '<div class="bg-white border border-gray-200 rounded-lg p-3 text-sm">';
                    html += '<div class="flex justify-between items-start mb-2">';
                    html += '<span class="font-medium text-gray-900">' + record.record_date + '</span>';
                    html += '<span class="text-xs px-2 py-1 rounded-full ' + attendanceClass + '">' + (record.attendance || '-') + '</span>';
                    html += '</div>';
                    html += '<div class="space-y-1 text-gray-600">';
                    if (record.homework_status) html += '<div>ğŸ“ ê³¼ì œ: ' + record.homework_status + '</div>';
                    if (record.understanding_level) html += '<div>ğŸ’¡ ì´í•´ë„: ' + record.understanding_level + '/5</div>';
                    if (record.participation_level) html += '<div>ğŸ™‹ ì°¸ì—¬ë„: ' + record.participation_level + '/5</div>';
                    if (record.achievement) html += '<div>ğŸ¯ ì„±ê³¼: ' + record.achievement + '</div>';
                    if (record.memo) html += '<div class="text-gray-500">ğŸ“Œ ' + record.memo + '</div>';
                    html += '</div></div>';
                    return html;
                }).join('');

                document.getElementById('recentRecordsDisplay').classList.remove('hidden');
            }

            document.getElementById('messageForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!currentStudent) {
                    alert('í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const additionalMessage = document.getElementById('shortMessage').value;

                // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
                const btn = document.getElementById('generateBtn');
                const btnText = document.getElementById('btnText');
                const btnLoading = document.getElementById('btnLoading');
                
                btn.disabled = true;
                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');
                btnLoading.classList.add('flex');

                try {
                    const response = await fetch('/api/generate-parent-message-from-records', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            studentId: currentStudent.id,
                            studentName: currentStudent.name,
                            grade: currentStudent.grade,
                            subjects: currentStudent.subjects,
                            parentName: currentStudent.parent_name,
                            records: recentRecords,
                            additionalMessage,
                            startDate,
                            endDate
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        generatedMessageText = data.message;
                        
                        // ê²°ê³¼ í‘œì‹œ
                        const daysDiff = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
                        document.getElementById('studentInfo').textContent = currentStudent.name + ' í•™ìƒ';
                        document.getElementById('subjectInfo').textContent = currentStudent.grade + ' Â· ' + currentStudent.subjects + ' Â· ' + daysDiff + 'ì¼ê°„ (' + recentRecords.length + 'ê°œ ê¸°ë¡)';
                        document.getElementById('generatedMessage').textContent = data.message;
                        
                        document.getElementById('emptyState').classList.add('hidden');
                        document.getElementById('resultArea').classList.remove('hidden');
                    } else {
                        alert('ì˜¤ë¥˜: ' + data.error);
                    }
                } catch (err) {
                    console.error('Error:', err);
                    alert('ë©”ì‹œì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    btnLoading.classList.add('hidden');
                }
            });

            function copyMessage() {
                navigator.clipboard.writeText(generatedMessageText).then(() => {
                    alert('âœ… ë©”ì‹œì§€ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nì¹´í†¡ì´ë‚˜ ë¬¸ìë¡œ í•™ë¶€ëª¨ë‹˜ê»˜ ì „ì†¡í•˜ì„¸ìš”.');
                });
            }

            function resetForm() {
                document.getElementById('messageForm').reset();
                document.getElementById('studentInfoDisplay').classList.add('hidden');
                document.getElementById('periodSummaryDisplay').classList.add('hidden');
                document.getElementById('recentRecordsDisplay').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('resultArea').classList.add('hidden');
                document.getElementById('generateBtn').disabled = true;
                currentStudent = null;
                recentRecords = [];
                generatedMessageText = '';
                // ê¸°ë³¸ ê¸°ê°„ ì¬ì„¤ì •
                setDateRange(30);
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
            window.addEventListener('DOMContentLoaded', function() {
                initPage();
            });
        </script>
    </body>
    </html>
  `)
})

// ë¸”ë¡œê·¸ ì‘ì„± ë„êµ¬ í˜ì´ì§€
app.get('/tools/blog-writer', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¸”ë¡œê·¸ ì‘ì„± ë„êµ¬ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
          .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
          }
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100 shadow-sm">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">ìŠˆí¼í”Œë ˆì´ìŠ¤</span>
                    </a>
                    <div class="flex items-center space-x-6">
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="/tools/parent-message" class="text-gray-600 hover:text-purple-600">í•™ë¶€ëª¨ ì†Œí†µ</a>
                        <a href="/tools/blog-writer" class="text-purple-600 font-medium">ë¸”ë¡œê·¸ ì‘ì„±</a>
                        <a href="/logout" class="text-gray-600 hover:text-purple-600">ë¡œê·¸ì•„ì›ƒ</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="pt-24 pb-12 px-6">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-10">
                    <h1 class="text-4xl font-bold text-gray-900 mb-4">âœï¸ AI ë¸”ë¡œê·¸ ì‘ì„± ë„êµ¬</h1>
                    <p class="text-xl text-gray-600">ì£¼ì œë§Œ ì…ë ¥í•˜ë©´ SEO ìµœì í™”ëœ ë¸”ë¡œê·¸ ê¸€ì„ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤</p>
                </div>

                <div class="grid lg:grid-cols-3 gap-8">
                    <!-- ì…ë ¥ í¼ -->
                    <div class="lg:col-span-1">
                        <div class="bg-white rounded-2xl shadow-lg p-8 sticky top-24">
                            <h2 class="text-2xl font-bold text-gray-900 mb-6">ê¸€ ì •ë³´ ì…ë ¥</h2>
                            
                            <form id="blogForm" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">ì£¼ì œ *</label>
                                    <input type="text" id="topic" required 
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                                           placeholder="ì˜ˆ: ì´ˆë“± ì˜ì–´ í•™ìŠµë²•">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í‚¤ì›Œë“œ (ì„ íƒ)</label>
                                    <input type="text" id="keywords"
                                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none"
                                           placeholder="ì˜ˆ: ì˜ì–´í•™ì›, ì´ˆë“±ì˜ì–´">
                                    <p class="text-xs text-gray-500 mt-1">ì‰¼í‘œë¡œ êµ¬ë¶„</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í†¤ ì•¤ ë§¤ë„ˆ</label>
                                    <select id="tone"
                                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none">
                                        <option value="ì¹œê·¼í•˜ê³  ì „ë¬¸ì ì¸">ì¹œê·¼í•˜ê³  ì „ë¬¸ì ì¸</option>
                                        <option value="ë”°ëœ»í•˜ê³  ê³µê°í•˜ëŠ”">ë”°ëœ»í•˜ê³  ê³µê°í•˜ëŠ”</option>
                                        <option value="ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê° ìˆëŠ”">ì „ë¬¸ì ì´ê³  ì‹ ë¢°ê° ìˆëŠ”</option>
                                        <option value="ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê³  ì¬ë¯¸ìˆëŠ”">ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê³  ì¬ë¯¸ìˆëŠ”</option>
                                    </select>
                                </div>

                                <button type="submit" 
                                        class="w-full gradient-purple text-white py-4 rounded-xl text-lg font-medium hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                        id="generateBtn">
                                    <span id="btnText">âœ¨ ë¸”ë¡œê·¸ ê¸€ ìƒì„±í•˜ê¸°</span>
                                    <span id="btnLoading" class="hidden items-center justify-center">
                                        <span class="loading mr-2"></span>
                                        ìƒì„± ì¤‘... (30ì´ˆ ì†Œìš”)
                                    </span>
                                </button>

                                <div class="bg-blue-50 rounded-xl p-4 text-sm text-blue-800">
                                    ğŸ’¡ AIê°€ ì œëª©, ì„œë¡ , ë³¸ë¡ , ê²°ë¡ ì„ í¬í•¨í•œ ì™„ì„±ëœ ë¸”ë¡œê·¸ ê¸€ì„ ì‘ì„±í•©ë‹ˆë‹¤
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- ìƒì„±ëœ ë¸”ë¡œê·¸ ê¸€ -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-2xl shadow-lg p-8 min-h-[600px]">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-gray-900">ìƒì„±ëœ ë¸”ë¡œê·¸ ê¸€</h2>
                                <div id="wordCount" class="hidden text-sm text-gray-500"></div>
                            </div>
                            
                            <div id="resultArea" class="hidden">
                                <div id="generatedBlog" class="prose max-w-none">
                                    <!-- ìƒì„±ëœ ë¸”ë¡œê·¸ ë‚´ìš© -->
                                </div>

                                <div class="mt-8 flex gap-3">
                                    <button onclick="copyBlog()" 
                                            class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-medium hover:bg-purple-700 transition">
                                        ğŸ“‹ ì „ì²´ ë³µì‚¬í•˜ê¸°
                                    </button>
                                    <button onclick="resetForm()" 
                                            class="bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-medium hover:bg-gray-300 transition">
                                        ğŸ”„ ìƒˆë¡œ ì‘ì„±
                                    </button>
                                </div>
                            </div>

                            <div id="emptyState" class="text-center py-24">
                                <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </div>
                                <p class="text-gray-500 text-lg">ì£¼ì œë¥¼ ì…ë ¥í•˜ê³ <br>ë¸”ë¡œê·¸ ê¸€ì„ ìƒì„±í•´ë³´ì„¸ìš”</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ë¸”ë¡œê·¸ ì‘ì„± íŒ -->
                <div class="mt-12 bg-gradient-to-br from-orange-50 to-yellow-50 rounded-2xl p-8">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“ ë¸”ë¡œê·¸ SEO íŒ</h3>
                    <div class="grid md:grid-cols-4 gap-6">
                        <div class="bg-white rounded-xl p-6">
                            <div class="text-3xl mb-3">ğŸ¯</div>
                            <h4 class="font-bold text-gray-900 mb-2">í‚¤ì›Œë“œ ì„ íƒ</h4>
                            <p class="text-sm text-gray-600">ê²€ìƒ‰ëŸ‰ì´ ë§ì€ í‚¤ì›Œë“œë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ 3-5íšŒ ë°˜ë³µ</p>
                        </div>
                        <div class="bg-white rounded-xl p-6">
                            <div class="text-3xl mb-3">ğŸ“</div>
                            <h4 class="font-bold text-gray-900 mb-2">ì ì ˆí•œ ê¸¸ì´</h4>
                            <p class="text-sm text-gray-600">1500-2000ìê°€ SEOì— ê°€ì¥ íš¨ê³¼ì </p>
                        </div>
                        <div class="bg-white rounded-xl p-6">
                            <div class="text-3xl mb-3">ğŸ–¼ï¸</div>
                            <h4 class="font-bold text-gray-900 mb-2">ì´ë¯¸ì§€ ì¶”ê°€</h4>
                            <p class="text-sm text-gray-600">2-3ì¥ì˜ ê´€ë ¨ ì´ë¯¸ì§€ë¡œ ê°€ë…ì„± í–¥ìƒ</p>
                        </div>
                        <div class="bg-white rounded-xl p-6">
                            <div class="text-3xl mb-3">â°</div>
                            <h4 class="font-bold text-gray-900 mb-2">ê¾¸ì¤€í•œ í¬ìŠ¤íŒ…</h4>
                            <p class="text-sm text-gray-600">ì£¼ 2-3íšŒ ê·œì¹™ì ì¸ ì—…ë¡œë“œê°€ ì¤‘ìš”</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let generatedBlogText = '';

            document.getElementById('blogForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const topic = document.getElementById('topic').value;
                const keywords = document.getElementById('keywords').value;
                const tone = document.getElementById('tone').value;

                // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
                const btn = document.getElementById('generateBtn');
                const btnText = document.getElementById('btnText');
                const btnLoading = document.getElementById('btnLoading');
                
                btn.disabled = true;
                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');
                btnLoading.classList.add('flex');

                try {
                    const response = await fetch('/api/generate-blog-post', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            topic,
                            keywords,
                            tone
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        generatedBlogText = data.content;
                        
                        // ê²°ê³¼ í‘œì‹œ (ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜)
                        const formattedContent = data.content
                            .replace(/\\n\\n/g, '</p><p class="mb-4">')
                            .replace(/\\n/g, '<br>');
                        
                        document.getElementById('generatedBlog').innerHTML = 
                            '<div class="text-gray-800 leading-relaxed"><p class="mb-4">' + 
                            formattedContent + 
                            '</p></div>';
                        
                        document.getElementById('wordCount').textContent = 
                            'ì´ ' + data.metadata.wordCount + 'ì';
                        document.getElementById('wordCount').classList.remove('hidden');
                        
                        document.getElementById('emptyState').classList.add('hidden');
                        document.getElementById('resultArea').classList.remove('hidden');

                        // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                        document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        alert('ì˜¤ë¥˜: ' + data.error);
                    }
                } catch (err) {
                    console.error('Error:', err);
                    alert('ë¸”ë¡œê·¸ ê¸€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    btnLoading.classList.add('hidden');
                }
            });

            function copyBlog() {
                navigator.clipboard.writeText(generatedBlogText).then(() => {
                    alert('âœ… ë¸”ë¡œê·¸ ê¸€ì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\në„¤ì´ë²„ ë¸”ë¡œê·¸ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
                });
            }

            function resetForm() {
                document.getElementById('blogForm').reset();
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('resultArea').classList.add('hidden');
                document.getElementById('wordCount').classList.add('hidden');
                generatedBlogText = '';
            }
        </script>
    </body>
    </html>
  `)
})

// ëœë”©í˜ì´ì§€ ìƒì„± ë„êµ¬ - trailing slash redirect
app.get('/tools/landing-builder/', (c) => c.redirect('/tools/landing-builder', 301));

// ëœë”©í˜ì´ì§€ ìƒì„± ë„êµ¬
app.get('/tools/landing-builder', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ëœë”©í˜ì´ì§€ ìƒì„±ê¸° - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- Flatpickr CSS & JS for Date Picker -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', sans-serif; }
          .gradient-purple { background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <span class="text-xl font-bold text-gray-900">ëœë”©í˜ì´ì§€ ìƒì„±ê¸°</span>
                    <div class="flex gap-4">
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="/tools/landing-manager" class="text-gray-600 hover:text-purple-600">ë‚´ ëœë”©í˜ì´ì§€</a>
                        <button onclick="logout()" class="text-gray-600 hover:text-red-600">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="mb-8 flex justify-between items-start">
                    <div>
                        <h1 class="text-4xl font-bold text-gray-900 mb-3">ğŸ¨ AI ëœë”©í˜ì´ì§€ ìƒì„±ê¸°</h1>
                        <p class="text-lg text-gray-600">ê°„ë‹¨í•œ ì •ë³´ë§Œ ì…ë ¥í•˜ë©´ ì™„ì„±ëœ ëœë”©í˜ì´ì§€ë¥¼ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤</p>
                    </div>
                    <div class="flex gap-3">
                        <a href="/tools/landing-manager" class="px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 transition-all duration-200 font-medium shadow-lg hover:shadow-xl whitespace-nowrap">
                            ğŸ“ ë‚´ í˜ì´ì§€ ë³´ê¸°
                        </a>
                        <a href="/tools/landing-folders" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-all duration-200 font-medium shadow-lg hover:shadow-xl whitespace-nowrap">
                            ğŸ—‚ï¸ í´ë” ê´€ë¦¬
                        </a>
                    </div>
                </div>

                <!-- í†µê³„ ì¹´ë“œ -->
                <div class="grid md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                <span class="text-2xl">ğŸ“„</span>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ìƒì„±í•œ í˜ì´ì§€</p>
                                <p class="text-2xl font-bold text-gray-900"><span id="totalPagesCount">-</span>ê°œ</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                <span class="text-2xl">ğŸ“</span>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">í´ë” ìˆ˜</p>
                                <p class="text-2xl font-bold text-gray-900"><span id="totalFoldersCount">-</span>ê°œ</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                                <span class="text-2xl">ğŸ‘ï¸</span>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ì´ ì¡°íšŒìˆ˜</p>
                                <p class="text-2xl font-bold text-gray-900"><span id="totalViewsCount">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì‚¬ìš©ëŸ‰ í‘œì‹œ ë°°ë„ˆ (ìƒˆë¡œ ì¶”ê°€) -->
                <div id="usageBanner" class="bg-gradient-to-r from-purple-500 to-indigo-500 rounded-xl p-6 mb-8 text-white hidden">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center flex-shrink-0">
                                <span class="text-3xl">ğŸ¯</span>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold mb-1">ì´ë²ˆ ë‹¬ ëœë”©í˜ì´ì§€ ì‚¬ìš©ëŸ‰</h3>
                                <p class="text-white/90 text-sm">ì•„ë˜ ì‚¬ìš©ëŸ‰ì„ í™•ì¸í•˜ê³  í˜ì´ì§€ë¥¼ ìƒì„±í•˜ì„¸ìš”</p>
                            </div>
                        </div>
                        <div class="bg-white/20 backdrop-blur-sm rounded-xl px-6 py-4">
                            <div class="text-sm text-white/80 mb-1">ì‚¬ìš© í˜„í™©</div>
                            <div class="text-3xl font-bold">
                                <span id="currentUsage">-</span> / <span id="maxLimit">-</span>
                            </div>
                            <div class="w-48 bg-white/20 rounded-full h-2 mt-3">
                                <div id="usageBar" class="bg-white h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í…œí”Œë¦¿ ì„ íƒ -->
                <div class="bg-white rounded-xl p-8 border border-gray-200 mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">1ï¸âƒ£ í…œí”Œë¦¿ ì„ íƒ</h2>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <button onclick="selectTemplate('academy-intro', event)" class="template-btn group p-6 border-2 border-gray-200 rounded-xl hover:border-purple-500 hover:shadow-xl transition-all duration-300 text-left bg-white">
                            <div class="text-4xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸ«</div>
                            <div class="font-bold text-lg mb-2 text-gray-900 group-hover:text-purple-600 transition-colors">í•™ì› ì†Œê°œ í˜ì´ì§€</div>
                            <p class="text-sm text-gray-600 leading-relaxed">í•™ì›ì˜ ê°•ì ê³¼ íŠ¹ì§•ì„ íš¨ê³¼ì ìœ¼ë¡œ í™ë³´</p>
                        </button>
                        <button onclick="selectTemplate('program-promo', event)" class="template-btn group p-6 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:shadow-xl transition-all duration-300 text-left bg-white">
                            <div class="text-4xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸ“š</div>
                            <div class="font-bold text-lg mb-2 text-gray-900 group-hover:text-blue-600 transition-colors">í”„ë¡œê·¸ë¨ í™ë³´</div>
                            <p class="text-sm text-gray-600 leading-relaxed">íŠ¹ì • í”„ë¡œê·¸ë¨ ë“±ë¡ì„ ìœ ë„í•˜ëŠ” í˜ì´ì§€</p>
                        </button>
                        <button onclick="selectTemplate('event-promo', event)" class="template-btn group p-6 border-2 border-gray-200 rounded-xl hover:border-pink-500 hover:shadow-xl transition-all duration-300 text-left bg-white">
                            <div class="text-4xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸ‰</div>
                            <div class="font-bold text-lg mb-2 text-gray-900 group-hover:text-pink-600 transition-colors">ì´ë²¤íŠ¸ í”„ë¡œëª¨ì…˜</div>
                            <p class="text-sm text-gray-600 leading-relaxed">ê¸´ê¸‰ê° ìˆëŠ” í•œì • ì´ë²¤íŠ¸ í˜ì´ì§€</p>
                        </button>
                        <button onclick="selectTemplate('parent-letter', event)" class="template-btn group p-6 border-2 border-gray-200 rounded-xl hover:border-green-500 hover:shadow-xl transition-all duration-300 text-left bg-white">
                            <div class="text-4xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸ“§</div>
                            <div class="font-bold text-lg mb-2 text-gray-900 group-hover:text-green-600 transition-colors">ê°€ì •í†µì‹ ë¬¸</div>
                            <p class="text-sm text-gray-600 leading-relaxed">í•™ë¶€ëª¨ë‹˜ê»˜ ì „ë‹¬í•˜ëŠ” ê³µì§€ì‚¬í•­ í˜ì´ì§€</p>
                        </button>
                        <button onclick="selectTemplate('student-report', event)" class="template-btn group p-6 border-2 border-gray-200 rounded-xl hover:border-indigo-500 hover:shadow-xl transition-all duration-300 text-left bg-white">
                            <div class="text-4xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸ“Š</div>
                            <div class="font-bold text-lg mb-2 text-gray-900 group-hover:text-indigo-600 transition-colors">í•™ìƒ ì„±ê³¼ ë¦¬í¬íŠ¸</div>
                            <p class="text-sm text-gray-600 leading-relaxed">ì›”ê°„ í•™ìŠµ ë¦¬í¬íŠ¸ ê³µìœ  í˜ì´ì§€</p>
                        </button>
                        <button onclick="selectTemplate('admission-info', event)" class="template-btn group p-6 border-2 border-gray-200 rounded-xl hover:border-yellow-500 hover:shadow-xl transition-all duration-300 text-left bg-white">
                            <div class="text-4xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸ“</div>
                            <div class="font-bold text-lg mb-2 text-gray-900 group-hover:text-yellow-600 transition-colors">ì…í•™ ì„¤ëª…íšŒ</div>
                            <p class="text-sm text-gray-600 leading-relaxed">ì„¤ëª…íšŒ ì•ˆë‚´ ë° ì°¸ì„ ìœ ë„ í˜ì´ì§€</p>
                        </button>
                        <button onclick="selectTemplate('academy-stats', event)" class="template-btn group p-6 border-2 border-gray-200 rounded-xl hover:border-red-500 hover:shadow-xl transition-all duration-300 text-left bg-white">
                            <div class="text-4xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸ“ˆ</div>
                            <div class="font-bold text-lg mb-2 text-gray-900 group-hover:text-red-600 transition-colors">í•™ì› ì„±ê³¼ í†µê³„</div>
                            <p class="text-sm text-gray-600 leading-relaxed">ì‹¤ì ê³¼ ì„±ê³¼ë¥¼ ìˆ˜ì¹˜ë¡œ ë³´ì—¬ì£¼ëŠ” í˜ì´ì§€</p>
                        </button>
                        <button onclick="selectTemplate('teacher-intro', event)" class="template-btn group p-6 border-2 border-gray-200 rounded-xl hover:border-teal-500 hover:shadow-xl transition-all duration-300 text-left bg-white">
                            <div class="text-4xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸ‘¨â€ğŸ«</div>
                            <div class="font-bold text-lg mb-2 text-gray-900 group-hover:text-teal-600 transition-colors">ì„ ìƒë‹˜ ì†Œê°œ</div>
                            <p class="text-sm text-gray-600 leading-relaxed">ê°•ì‚¬ì§„ì˜ ê²½ë ¥ê³¼ ì „ë¬¸ì„±ì„ ì†Œê°œ</p>
                        </button>
                        <button onclick="selectTemplate('vacation-course', event)" class="template-btn group p-6 border-2 border-gray-200 rounded-xl hover:border-orange-500 hover:shadow-xl transition-all duration-300 text-left bg-white">
                            <div class="text-4xl mb-3 group-hover:scale-110 transition-transform duration-300">ğŸ“</div>
                            <div class="font-bold text-lg mb-2 text-gray-900 group-hover:text-orange-600 transition-colors">ë°©í•™ íŠ¹ê°• ì•ˆë‚´</div>
                            <p class="text-sm text-gray-600 leading-relaxed">ë°©í•™ íŠ¹ê°• í”„ë¡œê·¸ë¨ ë° ì»¤ë¦¬í˜ëŸ¼ ì•ˆë‚´</p>
                        </button>
                    </div>
                </div>

                <!-- ì…ë ¥ í¼ ì˜ì—­ -->
                <div id="formArea" class="hidden">
                    <div class="bg-white rounded-xl p-8 border border-gray-200 mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">2ï¸âƒ£ ì •ë³´ ì…ë ¥</h2>
                        <form id="landingForm" class="space-y-6"></form>
                    </div>

                    <!-- í´ë” ì„ íƒ -->
                    <div class="bg-white rounded-xl p-8 border border-gray-200 mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-3">3ï¸âƒ£ í´ë” ì„ íƒ (ì„ íƒì‚¬í•­)</h2>
                        <p class="text-sm text-gray-600 mb-4">ëœë”©í˜ì´ì§€ë¥¼ ì €ì¥í•  í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                        <div class="space-y-4">
                            <div class="flex gap-3">
                                <select id="folderSelect" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl">
                                    <option value="">í´ë” ì—†ìŒ (ë£¨íŠ¸ì— ì €ì¥)</option>
                                </select>
                                <button type="button" onclick="showNewFolderInput()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl hover:shadow-lg transition">
                                    + ìƒˆ í´ë”
                                </button>
                            </div>
                            <div id="newFolderInput" class="hidden">
                                <div class="flex gap-3">
                                    <input type="text" id="newFolderName" placeholder="ìƒˆ í´ë” ì´ë¦„ ì…ë ¥" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl">
                                    <button type="button" onclick="createFolder()" class="px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 transition">
                                        ìƒì„±
                                    </button>
                                    <button type="button" onclick="hideNewFolderInput()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 transition">
                                        ì·¨ì†Œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- í¼ ì„ íƒ -->
                    <div class="bg-white rounded-xl p-8 border border-gray-200 mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-3">3.5ï¸âƒ£ í¼ ì„ íƒ (ì„ íƒì‚¬í•­)</h2>
                        <p class="text-sm text-gray-600 mb-4">ëœë”©í˜ì´ì§€ì— ì¶”ê°€í•  ì‹ ì²­ í¼ì„ ì„ íƒí•˜ì„¸ìš”</p>
                        <div class="space-y-4">
                            <select id="formSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                <option value="">í¼ ì—†ìŒ</option>
                            </select>
                            <a href="/tools/form-manager" target="_blank" class="inline-block text-purple-600 hover:text-purple-800 text-sm font-medium">
                                <i class="fas fa-external-link-alt mr-1"></i>í¼ ê´€ë¦¬ í˜ì´ì§€ì—ì„œ ìƒˆ í¼ ë§Œë“¤ê¸°
                            </a>
                        </div>
                    </div>

                    <!-- ì¸ë„¤ì¼ ì—…ë¡œë“œ -->
                    <div class="bg-white rounded-xl p-8 border border-gray-200 mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-3">4ï¸âƒ£ ì¸ë„¤ì¼ ì„¤ì • (ì„ íƒì‚¬í•­)</h2>
                        <p class="text-sm text-gray-600 mb-6">ì¹´ì¹´ì˜¤í†¡, í˜ì´ìŠ¤ë¶ ë“±ì—ì„œ ë§í¬ ê³µìœ  ì‹œ ë³´ì—¬ì§ˆ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•˜ì„¸ìš”</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì¸ë„¤ì¼ ì´ë¯¸ì§€ URL</label>
                                <input type="text" id="thumbnailUrl" placeholder="https://example.com/image.jpg (ì„ íƒì‚¬í•­)" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                <p class="text-xs text-gray-500 mt-2">ğŸ’¡ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ê±°ë‚˜, íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš” (ê¶Œì¥ í¬ê¸°: 1200x630px)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ë˜ëŠ” íŒŒì¼ ì—…ë¡œë“œ</label>
                                <input type="file" id="thumbnailFile" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-xl" onchange="handleThumbnailUpload(event)">
                            </div>
                            <div id="thumbnailPreview" class="hidden">
                                <p class="text-sm font-medium text-gray-900 mb-2">ë¯¸ë¦¬ë³´ê¸°</p>
                                <img id="thumbnailPreviewImg" src="" alt="ì¸ë„¤ì¼ ë¯¸ë¦¬ë³´ê¸°" class="w-full max-w-md rounded-lg border border-gray-300 shadow-sm">
                            </div>
                        </div>
                    </div>

                    <!-- ê³µìœ  ì‹œ í‘œì‹œë  ì œëª©/ì„¤ëª… ì„¤ì • -->
                    <div class="bg-white rounded-xl p-8 border border-gray-200 mb-6">
                        <h2 class="text-2xl font-bold text-gray-900 mb-3">5ï¸âƒ£ ê³µìœ  ì‹œ í‘œì‹œ ë‚´ìš© (ì„ íƒì‚¬í•­)</h2>
                        <p class="text-sm text-gray-600 mb-6">ì¹´ì¹´ì˜¤í†¡, í˜ì´ìŠ¤ë¶ ë“±ì—ì„œ ë§í¬ ê³µìœ  ì‹œ ë³´ì—¬ì§ˆ ì œëª©ê³¼ ì„¤ëª…ì„ ì„¤ì •í•˜ì„¸ìš”</p>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">í° ê¸€ì (ì œëª©)</label>
                                <input type="text" id="ogTitle" placeholder="ì˜ˆ: ê¾¸ë©”ë•…í•™ì› ê²¨ìš¸ë°©í•™ íŠ¹ê°• ëª¨ì§‘" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                <p class="text-xs text-gray-500 mt-1">ğŸ’¡ ë¹„ì›Œë‘ë©´ ëœë”©í˜ì´ì§€ ì œëª©ì´ ìë™ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì‘ì€ ê¸€ì (ì„¤ëª…)</label>
                                <textarea id="ogDescription" rows="2" placeholder="ì˜ˆ: ì¤‘ë“± ì˜ì–´/ìˆ˜í•™ ì§‘ì¤‘ ì¼€ì–´! ì„ ì°©ìˆœ 20ëª… í•œì • í• ì¸ ì¤‘" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                                <p class="text-xs text-gray-500 mt-1">ğŸ’¡ ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ì„¤ëª…ì´ ì‚¬ìš©ë©ë‹ˆë‹¤</p>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <p class="text-sm text-blue-800">
                                    <strong>ğŸ“± ì¹´ì¹´ì˜¤í†¡ ë¯¸ë¦¬ë³´ê¸°</strong><br>
                                    <span class="text-base font-bold text-gray-900" id="previewOgTitle">ê¾¸ë©”ë•…í•™ì› ê²¨ìš¸ë°©í•™ íŠ¹ê°• ëª¨ì§‘</span><br>
                                    <span class="text-sm text-gray-600" id="previewOgDescription">ì¤‘ë“± ì˜ì–´/ìˆ˜í•™ ì§‘ì¤‘ ì¼€ì–´! ì„ ì°©ìˆœ 20ëª… í•œì • í• ì¸ ì¤‘</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <button onclick="generateLanding()" class="w-full gradient-purple text-white py-4 rounded-xl text-lg font-bold hover:shadow-xl transition">
                        ğŸš€ ëœë”©í˜ì´ì§€ ìƒì„±í•˜ê¸°
                    </button>
                    
                    <a href="https://developers.kakao.com/tool/debugger/sharing" target="_blank" class="block w-full text-center bg-yellow-500 hover:bg-yellow-600 text-white py-4 rounded-xl text-lg font-bold hover:shadow-xl transition mt-4">
                        ğŸ”„ ì¹´ì¹´ì˜¤í†¡ ìºì‹œ ì´ˆê¸°í™”í•˜ê¸°
                    </a>
                    
                    <button id="qrDownloadBtn" onclick="downloadQRCode()" class="hidden w-full text-center bg-orange-500 hover:bg-orange-600 text-white py-4 rounded-xl text-lg font-bold hover:shadow-xl transition mt-4">
                        ğŸ“± QR ì½”ë“œ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>

                <!-- ê²°ê³¼ ì˜ì—­ -->
                <div id="resultArea" class="hidden">
                    <div class="bg-white rounded-xl p-8 border-2 border-green-500">
                        <h2 class="text-2xl font-bold text-green-600 mb-4">âœ… ëœë”©í˜ì´ì§€ ìƒì„± ì™„ë£Œ!</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ê³µìœ  ë§í¬</label>
                                <div class="flex gap-2">
                                    <input type="text" id="shareUrl" readonly class="flex-1 px-4 py-3 border border-gray-300 rounded-lg bg-gray-50">
                                    <button onclick="copyUrl()" class="px-6 py-3 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700">
                                        ğŸ“‹ ë³µì‚¬
                                    </button>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <a id="previewBtn" href="#" target="_blank" class="flex-1 text-center py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                                    ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
                                </a>
                                <a href="/tools/landing-manager" class="flex-1 text-center py-3 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700">
                                    ğŸ“ ê´€ë¦¬ í˜ì´ì§€
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        let selectedTemplate = '';
        let user = null;
        let userFolders = [];
        let allForms = [];

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
        function previewImage(url, previewId) {
            const previewDiv = document.getElementById(previewId);
            const img = previewDiv.querySelector('img');
            
            if (url && url.trim() !== '') {
                img.src = url;
                previewDiv.classList.remove('hidden');
                
                // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
                img.onerror = function() {
                    previewDiv.classList.add('hidden');
                    console.error('ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', url);
                };
                
                // ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ ì‹œ
                img.onload = function() {
                    console.log('ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', url);
                };
            } else {
                previewDiv.classList.add('hidden');
            }
        }

        // íŒŒì¼ ì—…ë¡œë“œ ë° ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
        async function uploadImagePreview(input, previewId, hiddenInputId) {
            const file = input.files[0];
            if (!file) return;
            
            // íŒŒì¼ í¬ê¸° ì²´í¬ (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                input.value = '';
                return;
            }
            
            // ì´ë¯¸ì§€ íƒ€ì… ì²´í¬
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                input.value = '';
                return;
            }
            
            const previewDiv = document.getElementById(previewId);
            const img = previewDiv.querySelector('img');
            const statusText = previewDiv.querySelector('p');
            
            try {
                // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    previewDiv.classList.remove('hidden');
                    if (statusText) statusText.textContent = 'â³ ì—…ë¡œë“œ ì¤‘...';
                };
                reader.readAsDataURL(file);
                
                // ì„œë²„ì— ì—…ë¡œë“œ
                const formData = new FormData();
                formData.append('image', file);
                formData.append('userId', user.id);
                
                const response = await fetch('/api/upload/landing-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // hidden inputì— URL ì €ì¥
                    const hiddenInput = document.getElementById(hiddenInputId);
                    if (hiddenInput) {
                        hiddenInput.value = result.url;
                    }
                    
                    // ì„±ê³µ ë©”ì‹œì§€
                    if (statusText) statusText.textContent = 'âœ… ì—…ë¡œë“œ ì™„ë£Œ';
                    console.log('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì„±ê³µ:', result.url);
                } else {
                    throw new Error(result.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
                previewDiv.classList.add('hidden');
                input.value = '';
            }
        }

        // ìë™ ë¡œê·¸ì•„ì›ƒ ì²´í¬ í•¨ìˆ˜ (5ì‹œê°„)
        function checkAutoLogout() {
            const loginTime = localStorage.getItem('loginTime');
            const userData = localStorage.getItem('user');
            
            if (userData && loginTime) {
                const now = Date.now();
                const elapsed = now - parseInt(loginTime);
                const FIVE_HOURS = 5 * 60 * 60 * 1000; // 5ì‹œê°„
                
                if (elapsed > FIVE_HOURS) {
                    console.log('â° 5ì‹œê°„ ê²½ê³¼ - ìë™ ë¡œê·¸ì•„ì›ƒ');
                    localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                    localStorage.removeItem('loginTime');
                    alert('ë³´ì•ˆì„ ìœ„í•´ 5ì‹œê°„ í›„ ìë™ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    window.location.href = '/';
                    return false;
                }
            }
            return true;
        }

        // ë¡œê·¸ì¸ ì²´í¬ ë° ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        if (!checkAutoLogout()) {
            throw new Error('Auto logout');
        }
        
        // ì£¼ê¸°ì  ì²´í¬ (1ë¶„ë§ˆë‹¤)
        setInterval(checkAutoLogout, 60000);
        
        const userData = localStorage.getItem('user');
        if (userData) {
            user = JSON.parse(userData);
            console.log('âœ… User logged in:', user.name);
            // ì‚¬ìš©ì í´ë” ëª©ë¡ ë¡œë“œ
            loadUserFolders();
            // ì‚¬ìš©ì í¼ ëª©ë¡ ë¡œë“œ
            loadUserForms();
            // í†µê³„ ë¡œë“œ
            loadStats();
        } else {
            // ë¡œê·¸ì¸ ì—†ì´ë„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•˜ë„ë¡ ê¸°ë³¸ ì‚¬ìš©ì ì„¤ì •
            user = { id: 1, name: 'ê²ŒìŠ¤íŠ¸' };
            console.warn('âš ï¸ ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.');
            
            // ê²ŒìŠ¤íŠ¸ ëª¨ë“œ ê²½ê³  í‘œì‹œ (DOMì´ ë¡œë“œëœ í›„)
            setTimeout(() => {
                const container = document.querySelector('.container');
                if (container) {
                    const warning = document.createElement('div');
                    warning.className = 'mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-xl';
                    warning.innerHTML = '<div class="flex items-start">' +
                        '<i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3 mt-1"></i>' +
                        '<div class="flex-1">' +
                        '<h3 class="font-bold text-yellow-800 mb-1">ê²ŒìŠ¤íŠ¸ ëª¨ë“œ</h3>' +
                        '<p class="text-sm text-yellow-700 mb-2">ë¡œê·¸ì¸í•˜ì§€ ì•Šì•„ ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰ë©ë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>' +
                        '<a href="/" class="inline-block px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm font-bold hover:bg-yellow-700 transition">' +
                        '<i class="fas fa-sign-in-alt mr-2"></i>ë¡œê·¸ì¸í•˜ê¸°' +
                        '</a>' +
                        '</div>' +
                        '</div>';
                    container.insertBefore(warning, container.firstChild);
                }
            }, 100);
            
            loadUsage();
            loadUserFolders();
            loadUserForms();
            loadStats();
        }

        // ì‚¬ìš©ëŸ‰ ë¡œë“œ í•¨ìˆ˜
        async function loadUsage() {
            try {
                const response = await fetch('/api/usage/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success && data.limits && data.usage) {
                    const currentUsage = data.usage.landingPages || 0;
                    const maxLimit = data.limits.landingPages || 0;
                    const percentage = maxLimit > 0 ? Math.min((currentUsage / maxLimit) * 100, 100) : 0;
                    
                    // ë°°ë„ˆ í‘œì‹œ
                    const usageBanner = document.getElementById('usageBanner');
                    if (usageBanner) {
                        usageBanner.classList.remove('hidden');
                        document.getElementById('currentUsage').textContent = currentUsage;
                        document.getElementById('maxLimit').textContent = maxLimit;
                        document.getElementById('usageBar').style.width = percentage + '%';
                        
                        // í•œë„ ì´ˆê³¼ ì‹œ ê²½ê³  ìƒ‰ìƒ
                        if (currentUsage >= maxLimit) {
                            usageBanner.className = 'bg-gradient-to-r from-red-500 to-orange-500 rounded-xl p-6 mb-8 text-white';
                        } else if (percentage >= 80) {
                            usageBanner.className = 'bg-gradient-to-r from-orange-500 to-yellow-500 rounded-xl p-6 mb-8 text-white';
                        }
                    }
                }
            } catch (err) {
                console.error('ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨:', err);
            }
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            try {
                // í˜ì´ì§€ ëª©ë¡ ë¡œë“œ
                const pagesResponse = await fetch('/api/landing/my-pages?userId=' + user.id);
                const pagesResult = await pagesResponse.json();
                
                if (pagesResult.success) {
                    const pages = pagesResult.pages || [];
                    document.getElementById('totalPagesCount').textContent = pages.length;
                    
                    // ì´ ì¡°íšŒìˆ˜ ê³„ì‚° (view_count ì»¬ëŸ¼ ì‚¬ìš©)
                    const totalViews = pages.reduce((sum, page) => sum + (page.view_count || 0), 0);
                    document.getElementById('totalViewsCount').textContent = totalViews.toLocaleString();
                    
                    console.log('í†µê³„ ë¡œë“œ ì™„ë£Œ - í˜ì´ì§€:', pages.length, 'ì´ ì¡°íšŒìˆ˜:', totalViews);
                }
                
                // í´ë” ëª©ë¡ ë¡œë“œ
                const foldersResponse = await fetch('/api/landing/folders?userId=' + user.id);
                const foldersResult = await foldersResponse.json();
                
                if (foldersResult.success) {
                    const folders = foldersResult.folders || [];
                    document.getElementById('totalFoldersCount').textContent = folders.length;
                }
            } catch (err) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', err);
                document.getElementById('totalPagesCount').textContent = '0';
                document.getElementById('totalFoldersCount').textContent = '0';
                document.getElementById('totalViewsCount').textContent = '0';
            }
        }

        // ì‚¬ìš©ì í´ë” ëª©ë¡ ë¡œë“œ
        async function loadUserFolders() {
            try {
                const response = await fetch('/api/landing/folders?userId=' + user.id);
                const result = await response.json();
                if (result.success) {
                    userFolders = result.folders || [];
                    updateFolderSelect();
                }
            } catch (err) {
                console.error('í´ë” ë¡œë“œ ì‹¤íŒ¨:', err);
            }
        }
        
        // ì‚¬ìš©ì í¼ ëª©ë¡ ë¡œë“œ
        async function loadUserForms() {
            try {
                const response = await fetch('/api/form-templates', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                        return;
                    }
                    throw new Error('í¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                const templates = await response.json();
                allForms = templates || [];
                updateFormSelect();
            } catch (error) {
                console.error('í¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // í¼ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateFormSelect() {
            const select = document.getElementById('formSelect');
            if (!select) return;
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ "í¼ ì—†ìŒ" ì œì™¸)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // í¼ ëª©ë¡ ì¶”ê°€
            allForms.forEach(form => {
                const option = document.createElement('option');
                option.value = form.id;
                option.textContent = form.name;
                select.appendChild(option);
            });
        }

        // í´ë” ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateFolderSelect() {
            const select = document.getElementById('folderSelect');
            if (!select) return;
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ "í´ë” ì—†ìŒ" ì œì™¸)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // í´ë” ëª©ë¡ ì¶”ê°€
            userFolders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                select.appendChild(option);
            });
            
            // ë§ˆì§€ë§‰ ì„ íƒí•œ í´ë”ê°€ ìˆìœ¼ë©´ ìë™ ì„ íƒ
            const lastFolderId = localStorage.getItem('lastSelectedFolder');
            if (lastFolderId) {
                select.value = lastFolderId;
            }
        }

        // ìƒˆ í´ë” ì…ë ¥ì°½ í‘œì‹œ
        function showNewFolderInput() {
            document.getElementById('newFolderInput').classList.remove('hidden');
            document.getElementById('newFolderName').focus();
        }

        // ìƒˆ í´ë” ì…ë ¥ì°½ ìˆ¨ê¸°ê¸°
        function hideNewFolderInput() {
            document.getElementById('newFolderInput').classList.add('hidden');
            document.getElementById('newFolderName').value = '';
        }

        // ìƒˆ í´ë” ìƒì„±
        async function createFolder() {
            const folderName = document.getElementById('newFolderName').value.trim();
            if (!folderName) {
                alert('í´ë” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/landing/folders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        name: folderName
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('âœ… í´ë” "' + folderName + '"ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    hideNewFolderInput();
                    await loadUserFolders();
                    // ìƒˆë¡œ ìƒì„±í•œ í´ë” ìë™ ì„ íƒ
                    document.getElementById('folderSelect').value = result.folderId;
                } else {
                    alert('í´ë” ìƒì„± ì‹¤íŒ¨: ' + result.error);
                }
            } catch (err) {
                console.error('í´ë” ìƒì„± ì˜¤ë¥˜:', err);
                alert('í´ë” ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function logout() {
            localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
            window.location.href = '/';
        }

        function selectTemplate(type, event) {
            selectedTemplate = type;
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.classList.remove('border-purple-600', 'bg-purple-50');
            });
            event.target.closest('.template-btn').classList.add('border-purple-600', 'bg-purple-50');
            
            showForm(type);
        }

        function showForm(type) {
            const forms = {
                'academy-intro': \`
                    <div class="space-y-6">
                        <!-- ê¸°ë³¸ ì •ë³´ -->
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì›ëª… *</label>
                                    <input type="text" name="academyName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">ìœ„ì¹˜ *</label>
                                    <input type="text" name="location" placeholder="ì˜ˆ: ì¸ì²œ ì„œêµ¬ ì²­ë¼ë™" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í•œ ì¤„ ì†Œê°œ *</label>
                                    <input type="text" name="features" placeholder="ì˜ˆ: 1:1 ë§ì¶¤ êµìœ¡ìœ¼ë¡œ ì„±ì  í–¥ìƒì„ ì±…ì„ì§‘ë‹ˆë‹¤" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">ì—°ë½ì²˜ *</label>
                                    <input type="text" name="contact" placeholder="ì˜ˆ: 010-1234-5678" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í”Œë ˆì´ìŠ¤ ì£¼ì†Œ (ì„ íƒì‚¬í•­)</label>
                                    <input type="url" name="placeUrl" placeholder="ì˜ˆ: https://place.map.kakao.com/12345" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                    <p class="text-xs text-gray-500 mt-1">ğŸ—ºï¸ ì¹´ì¹´ì˜¤ë§µ, ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë“±ì˜ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ë©´ "í•™ì›ëª… ë°”ë¡œ ë³´ê¸°" ë²„íŠ¼ì´ ìƒì„±ë©ë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- í•™ì›ì¥ ì •ë³´ -->
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ‘¤ í•™ì›ì¥ ì •ë³´ (ì„ íƒì‚¬í•­)</h3>
                            <p class="text-sm text-gray-500 mb-4">ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ì„¹ì…˜ì´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì›ì¥ ì´ë¦„</label>
                                    <input type="text" name="directorName" placeholder="ì˜ˆ: í™ê¸¸ë™" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì›ì¥ ì‚¬ì§„</label>
                                    <input type="file" id="directorPhotoInput" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100" onchange="uploadImagePreview(this, 'directorPhotoPreview', 'directorPhotoUrl')">
                                    <input type="hidden" id="directorPhotoUrl" name="directorPhoto">
                                    <p class="text-xs text-gray-500 mt-1">ğŸ“¸ ì‚¬ì§„ íŒŒì¼ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ì—…ë¡œë“œë©ë‹ˆë‹¤ (ìµœëŒ€ 5MB)</p>
                                    <div id="directorPhotoPreview" class="mt-3 hidden">
                                        <img src="" alt="í•™ì›ì¥ ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸°" class="w-32 h-32 object-cover rounded-full border-4 border-purple-500 mx-auto">
                                        <p class="text-center text-sm text-green-600 mt-2">âœ… ì—…ë¡œë“œ ì™„ë£Œ</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì›ì¥ ê²½ë ¥</label>
                                    <textarea name="directorCareer" rows="4" placeholder="ì„œìš¸ëŒ€í•™êµ êµìœ¡í•™ê³¼ ì¡¸ì—…&#10;ì „ì§ ëŒ€ì¹˜ë™ ìœ ëª…í•™ì› ê°•ì‚¬ 10ë…„&#10;êµìœ¡ì²­ ì¸ì¦ ìš°ìˆ˜ê°•ì‚¬&#10;ì…ì‹œì»¨ì„¤íŒ… ìê²©ì¦ ë³´ìœ " class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- í•™ì› ì‚¬ì§„ -->
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“· í•™ì› ì‚¬ì§„ (ì„ íƒì‚¬í•­)</h3>
                            <p class="text-sm text-gray-500 mb-4">ğŸ“¸ ì‚¬ì§„ íŒŒì¼ì„ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ì—…ë¡œë“œë©ë‹ˆë‹¤</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì› ì‚¬ì§„ 1</label>
                                    <input type="file" id="academyPhoto1Input" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="uploadImagePreview(this, 'academyPhoto1Preview', 'academyPhoto1Url')">
                                    <input type="hidden" id="academyPhoto1Url" name="academyPhoto1">
                                    <div id="academyPhoto1Preview" class="mt-3 hidden">
                                        <img src="" alt="í•™ì› ì‚¬ì§„ 1 ë¯¸ë¦¬ë³´ê¸°" class="w-full h-48 object-cover rounded-xl border-2 border-gray-300">
                                        <p class="text-sm text-green-600 mt-2">âœ… ì—…ë¡œë“œ ì™„ë£Œ</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì› ì‚¬ì§„ 2</label>
                                    <input type="file" id="academyPhoto2Input" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="uploadImagePreview(this, 'academyPhoto2Preview', 'academyPhoto2Url')">
                                    <input type="hidden" id="academyPhoto2Url" name="academyPhoto2">
                                    <div id="academyPhoto2Preview" class="mt-3 hidden">
                                        <img src="" alt="í•™ì› ì‚¬ì§„ 2 ë¯¸ë¦¬ë³´ê¸°" class="w-full h-48 object-cover rounded-xl border-2 border-gray-300">
                                        <p class="text-sm text-green-600 mt-2">âœ… ì—…ë¡œë“œ ì™„ë£Œ</p>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì› ì‚¬ì§„ 3</label>
                                    <input type="file" id="academyPhoto3Input" accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-xl file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onchange="uploadImagePreview(this, 'academyPhoto3Preview', 'academyPhoto3Url')">
                                    <input type="hidden" id="academyPhoto3Url" name="academyPhoto3">
                                    <div id="academyPhoto3Preview" class="mt-3 hidden">
                                        <img src="" alt="í•™ì› ì‚¬ì§„ 3 ë¯¸ë¦¬ë³´ê¸°" class="w-full h-48 object-cover rounded-xl border-2 border-gray-300">
                                        <p class="text-sm text-green-600 mt-2">âœ… ì—…ë¡œë“œ ì™„ë£Œ</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- êµìœ¡ ì •ë³´ -->
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“š êµìœ¡ ì •ë³´ (ì„ íƒì‚¬í•­)</h3>
                            <p class="text-sm text-gray-500 mb-4">ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ì„¹ì…˜ì´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">êµìœ¡ ì² í•™</label>
                                    <textarea name="educationPhilosophy" rows="4" placeholder="ìš°ë¦¬ í•™ì›ì€ í•™ìƒ í•œ ëª… í•œ ëª…ì˜ ê¿ˆì„ ì†Œì¤‘íˆ ìƒê°í•©ë‹ˆë‹¤.&#10;ë‹¨ìˆœí•œ ì„±ì  í–¥ìƒì„ ë„˜ì–´ ì§„ì •í•œ í•™ìŠµ ëŠ¥ë ¥ì„ í‚¤ì›ë‹ˆë‹¤.&#10;í•™ìƒ ë§ì¶¤í˜• êµìœ¡ìœ¼ë¡œ ìµœê³ ì˜ ê²°ê³¼ë¥¼ ë§Œë“¤ì–´ê°‘ë‹ˆë‹¤." class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">êµìœ¡ í”„ë¡œê·¸ë¨</label>
                                    <textarea name="educationPrograms" rows="4" placeholder="ì¤‘ë“± ë‚´ì‹  ëŒ€ë¹„ë°˜ (ì£¼ 3íšŒ)&#10;ê³ ë“± ìˆ˜ëŠ¥ ì§‘ì¤‘ë°˜ (ì£¼ 5íšŒ)&#10;1:1 ë§ì¶¤ ê³¼ì™¸ (í˜‘ì˜)&#10;ë°©í•™ íŠ¹ê°• í”„ë¡œê·¸ë¨" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">ì»¤ë¦¬í˜ëŸ¼</label>
                                    <textarea name="curriculum" rows="4" placeholder="1ë‹¨ê³„: ê¸°ì´ˆ ê°œë… í™•ë¦½ (4ì£¼)&#10;2ë‹¨ê³„: ì‹¬í™” ë¬¸ì œ í’€ì´ (4ì£¼)&#10;3ë‹¨ê³„: ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ (4ì£¼)&#10;4ë‹¨ê³„: ìµœì¢… ì ê²€ ë° ë³´ì™„ (2ì£¼)" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- í•™ì› ê°•ì  -->
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 mb-4">â­ í•™ì› ê°•ì  (ì„ íƒì‚¬í•­)</h3>
                            <p class="text-sm text-gray-500 mb-4">ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ì„¹ì…˜ì´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">íŠ¹ë³„í•œ ê°•ì  (1ê°œë‹¹ í•œ ì¤„, ìµœëŒ€ 4ê°œ)</label>
                                <textarea name="specialties" rows="4" placeholder="10ë…„ ê²½ë ¥ì˜ ì „ë¬¸ ê°•ì‚¬ì§„&#10;ì†Œê·œëª¨ ê·¸ë£¹ ìˆ˜ì—…ìœ¼ë¡œ ì§‘ì¤‘ ì¼€ì–´&#10;ì…ì‹œ ì „ë¬¸ ì»¨ì„¤íŒ… ë¬´ë£Œ ì œê³µ&#10;ë‚´ì‹  í‰ê·  2ë“±ê¸‰ í–¥ìƒ ì‹¤ì " class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                            </div>
                        </div>
                    </div>
                \`,
                'program-promo': \`
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">í”„ë¡œê·¸ë¨ëª… *</label>
                            <input type="text" name="programName" placeholder="ì˜ˆ: ì¤‘ë“± ì˜ì–´ íŠ¹ê°•ë°˜" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ëŒ€ìƒ *</label>
                            <input type="text" name="target" placeholder="ì˜ˆ: ì¤‘1~ì¤‘3" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">í”„ë¡œê·¸ë¨ ì‚¬ì§„ URL</label>
                            <input type="text" name="programImage" placeholder="ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            <p class="text-xs text-gray-500 mt-1">ğŸ“Œ ì´ë¯¸ì§€ ì—…ë¡œë“œ: ë¯¸ë””ì–´ ê´€ë¦¬ â†’ ì‚¬ì§„ ì—…ë¡œë“œ â†’ URL ë³µì‚¬</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">íŠ¹ì§• (1ê°œë‹¹ í•œ ì¤„) *</label>
                            <textarea name="features" rows="3" placeholder="ë‚´ì‹  ëŒ€ë¹„ ì™„ë²½ ì¤€ë¹„&#10;ë¬¸ë²•ë¶€í„° ë…í•´ê¹Œì§€ ì²´ê³„ì  í•™ìŠµ&#10;ì£¼ 3íšŒ ì†Œê·¸ë£¹ ìˆ˜ì—…" required class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ê°€ê²© *</label>
                                <input type="text" name="price" placeholder="ì˜ˆ: 350,000" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ê¸°ê°„ *</label>
                                <input type="text" name="duration" placeholder="ì˜ˆ: 3ê°œì›” ê³¼ì •" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì‹ ì²­ ë§í¬ ë˜ëŠ” ì „í™”ë²ˆí˜¸</label>
                            <input type="text" name="cta" placeholder="ì˜ˆ: 010-1234-5678 ë˜ëŠ” URL" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                    </div>
                \`,
                'event-promo': \`
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì´ë²¤íŠ¸ëª… *</label>
                            <input type="text" name="eventName" placeholder="ì˜ˆ: ê²¨ìš¸ë°©í•™ íŠ¹ê°• ì¡°ê¸°ë“±ë¡ ì´ë²¤íŠ¸" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ê¸°ê°„ *</label>
                            <input type="text" name="period" placeholder="ì˜ˆ: 12ì›” 20ì¼ ~ 12ì›” 31ì¼" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ê¸´ê¸‰ê° ë¬¸êµ¬ *</label>
                            <input type="text" name="urgency" placeholder="ì˜ˆ: ì„ ì°©ìˆœ 20ëª… í•œì •" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">í˜œíƒ (1ê°œë‹¹ í•œ ì¤„) *</label>
                            <textarea name="benefits" rows="3" placeholder="ë“±ë¡ë¹„ 50% í• ì¸&#10;êµì¬ë¹„ ì „ì•¡ ë¬´ë£Œ&#10;1:1 ë ˆë²¨ í…ŒìŠ¤íŠ¸ ë¬´ë£Œ ì œê³µ" required class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì‹ ì²­ ë§í¬ ë˜ëŠ” ì „í™”ë²ˆí˜¸</label>
                            <input type="text" name="cta" placeholder="ì˜ˆ: 010-1234-5678" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                    </div>
                \`,
                'parent-letter': \`
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì›ëª… *</label>
                            <input type="text" name="academyName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ê³µì§€ì‚¬í•­ ì œëª© *</label>
                            <input type="text" name="noticeTitle" placeholder="ì˜ˆ: 2024ë…„ ê²¨ìš¸ë°©í•™ íŠ¹ê°• ì•ˆë‚´" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ë‚ ì§œ *</label>
                            <input type="text" name="noticeDate" placeholder="ì˜ˆ: 2024ë…„ 12ì›” 20ì¼" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ê³µì§€ ë‚´ìš© *</label>
                            <textarea name="noticeContent" rows="8" placeholder="ì•ˆë…•í•˜ì„¸ìš”, í•™ë¶€ëª¨ë‹˜.&#10;&#10;2024ë…„ ê²¨ìš¸ë°©í•™ì„ ë§ì´í•˜ì—¬ íŠ¹ë³„ í”„ë¡œê·¸ë¨ì„ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤.&#10;&#10;ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ì‹œê³  ë§ì€ ì°¸ì—¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤.&#10;&#10;ê°ì‚¬í•©ë‹ˆë‹¤." required class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì£¼ìš” ì•ˆë‚´ì‚¬í•­ (1ê°œë‹¹ í•œ ì¤„)</label>
                            <textarea name="keyPoints" rows="4" placeholder="ì¼ì‹œ: 2024ë…„ 12ì›” 26ì¼ ~ 2025ë…„ 1ì›” 31ì¼&#10;ëŒ€ìƒ: ì´ˆë“± 3í•™ë…„ ~ ì¤‘ë“± 3í•™ë…„&#10;ê³¼ëª©: ìˆ˜í•™, ì˜ì–´, êµ­ì–´&#10;ì‹ ì²­ ë§ˆê°: 2024ë…„ 12ì›” 24ì¼" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                            <p class="text-xs text-gray-500 mt-1">ğŸ’¡ ë¹„ì›Œë‘ë©´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ë¬¸ì˜ì²˜ *</label>
                            <input type="text" name="contactInfo" placeholder="ì˜ˆ: 032-123-4567 ë˜ëŠ” 010-1234-5678" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ë‹´ë‹¹ì</label>
                            <input type="text" name="staffName" placeholder="ì˜ˆ: êµë¬´íŒ€ ê¹€ì„ ìƒë‹˜" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                    </div>
                \`,
                'student-report': \`
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">í•™ìƒ ì„ íƒ *</label>
                                <select name="studentName" id="studentSelect" required class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white" onchange="handleStudentChange()">
                                    <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">ğŸ’¡ í•™ìƒ ëª©ë¡ì—ì„œ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì›” *</label>
                                <input type="text" name="month" placeholder="ì˜ˆ: 2024ë…„ 12ì›”" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                        </div>
                        
                        <!-- ğŸ“… ë‚ ì§œ ë²”ìœ„ ì„ íƒ -->
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 space-y-4">
                            <h3 class="text-lg font-bold text-blue-900 flex items-center gap-2">
                                <span>ğŸ“…</span>
                                <span>ì¶œì„ ë°ì´í„° ê¸°ê°„ ì„¤ì •</span>
                            </h3>
                            <p class="text-sm text-blue-700 mb-4">ì•„ë˜ ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ê¸°ê°„ì˜ ì¶œì„ë¥ ì´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">ì‹œì‘ì¼ ğŸ“†</label>
                                    <input type="text" id="startDate" placeholder="ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">ì¢…ë£Œì¼ ğŸ“†</label>
                                    <input type="text" id="endDate" placeholder="ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”" class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white">
                                </div>
                            </div>
                            <button type="button" onclick="calculateAttendance()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl font-medium hover:from-blue-700 hover:to-blue-800 transition-all shadow-md hover:shadow-lg">
                                ğŸ”„ ì¶œì„ë¥  ìë™ ê³„ì‚°í•˜ê¸°
                            </button>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì‚¬ìš© êµì¬ (1ê°œë‹¹ í•œ ì¤„, ìµœëŒ€ 5ê°œ)</label>
                            <textarea name="textbooks" rows="5" placeholder="ì¤‘ë“± ìˆ˜í•™ 2-1&#10;ë¬¸ë²•ì´ ì“°ê¸°ë‹¤&#10;ì˜ë‹¨ì–´ ì•”ê¸°ì¥ LEVEL 3&#10;ë…í•´ ì‹¤ë ¥ ë‹¤ì§€ê¸°&#10;ê¸°ì¶œ ë¬¸ì œì§‘ ì™„ì„±" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                            <p class="text-xs text-gray-500 mt-1">ğŸ’¡ ìµœëŒ€ 5ê°œê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•˜ë©°, ë¹„ì›Œë‘ë©´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
                        </div>
                        
                        <!-- ì¶œì„ í†µê³„ í‘œì‹œ -->
                        <div id="attendanceStats" class="hidden bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-6">
                            <h3 class="text-lg font-bold text-green-900 mb-4 flex items-center gap-2">
                                <span>âœ…</span>
                                <span>ìë™ ê³„ì‚°ëœ ì¶œì„ í†µê³„</span>
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-white rounded-lg p-4 text-center">
                                    <div class="text-sm text-gray-600 mb-1">ì¶œì„</div>
                                    <div id="stat-attended" class="text-2xl font-bold text-green-600">-</div>
                                </div>
                                <div class="bg-white rounded-lg p-4 text-center">
                                    <div class="text-sm text-gray-600 mb-1">ê²°ì„</div>
                                    <div id="stat-absent" class="text-2xl font-bold text-red-600">-</div>
                                </div>
                                <div class="bg-white rounded-lg p-4 text-center">
                                    <div class="text-sm text-gray-600 mb-1">ì§€ê°</div>
                                    <div id="stat-late" class="text-2xl font-bold text-yellow-600">-</div>
                                </div>
                                <div class="bg-white rounded-lg p-4 text-center">
                                    <div class="text-sm text-gray-600 mb-1">ì¡°í‡´</div>
                                    <div id="stat-early" class="text-2xl font-bold text-orange-600">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì¶œì„ë¥  (%)</label>
                                <input type="number" name="attendanceRate" id="attendanceRateInput" placeholder="95" min="0" max="100" readonly class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100">
                                <p class="text-xs text-gray-500 mt-1">ğŸ¤– ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì¶œì„ ì¼ìˆ˜</label>
                                <input type="number" name="attendanceDays" id="attendanceDaysInput" placeholder="19" min="0" readonly class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100">
                                <p class="text-xs text-gray-500 mt-1">ğŸ¤– ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì´ ì¼ìˆ˜</label>
                                <input type="number" name="totalDays" id="totalDaysInput" placeholder="20" min="0" readonly class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-100">
                                <p class="text-xs text-gray-500 mt-1">ğŸ¤– ìë™ ê³„ì‚°ë©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì´ë‹¬ì˜ ì„±ê³¼ (1ê°œë‹¹ í•œ ì¤„) *</label>
                            <textarea name="achievements" rows="3" placeholder="ì¤‘ê°„ê³ ì‚¬ ì˜ì–´ 90ì  ë‹¬ì„±&#10;ë‹¨ì–´ ì•”ê¸° 500ê°œ ì™„ë£Œ&#10;ëª¨ì˜ê³ ì‚¬ 3ë“±ê¸‰ì—ì„œ 2ë“±ê¸‰ í–¥ìƒ" required class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ (1ê°œë‹¹ í•œ ì¤„)</label>
                            <textarea name="improvements" rows="2" placeholder="ë…í•´ ì†ë„ í–¥ìƒ í•„ìš”&#10;ë¬¸ë²• ì‹¬í™” í•™ìŠµ ê¶Œì¥" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                            <p class="text-xs text-gray-500 mt-1">ğŸ’¡ ë¹„ì›Œë‘ë©´ í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ë‹¤ìŒ ë‹¬ ëª©í‘œ (1ê°œë‹¹ í•œ ì¤„) *</label>
                            <textarea name="nextGoals" rows="2" placeholder="ê¸°ë§ê³ ì‚¬ 95ì  ëª©í‘œ&#10;ë“£ê¸° í‰ê°€ ë§Œì  ë„ì „" required class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ë‹´ë‹¹ ì„ ìƒë‹˜</label>
                            <input type="text" name="teacherName" placeholder="ì˜ˆ: ê¹€ì˜í¬ ì„ ìƒë‹˜" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        
                        <!-- Hidden fields for chart data -->
                        <input type="hidden" name="understandingLevel" id="understandingLevelInput" value="0">
                        <input type="hidden" name="participationLevel" id="participationLevelInput" value="0">
                        <input type="hidden" name="homeworkRate" id="homeworkRateInput" value="0">
                    </div>
                \`,
                'admission-info': \`
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì„¤ëª…íšŒ ì œëª© *</label>
                            <input type="text" name="eventTitle" placeholder="ì˜ˆ: 2025í•™ë…„ë„ ì‹ ì…ìƒ ëª¨ì§‘ ì„¤ëª…íšŒ" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ë‚ ì§œ *</label>
                                <input type="text" name="eventDate" placeholder="ì˜ˆ: 2024ë…„ 12ì›” 28ì¼" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì‹œê°„ *</label>
                                <input type="text" name="eventTime" placeholder="ì˜ˆ: ì˜¤í›„ 2ì‹œ" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì¥ì†Œ *</label>
                            <input type="text" name="location" placeholder="ì˜ˆ: ê¾¸ë©”ë•…í•™ì› 2ì¸µ ì„¸ë¯¸ë‚˜ì‹¤" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ëŒ€ìƒ í•™ë…„</label>
                            <input type="text" name="targetGrade" placeholder="ì˜ˆ: ì˜ˆë¹„ ì´ˆ1~ì´ˆ6" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì„¤ëª…íšŒ ì•ˆë‚´ (1ê°œë‹¹ í•œ ì¤„) *</label>
                            <textarea name="agenda" rows="4" placeholder="í•™ì› êµìœ¡ ì² í•™ ì†Œê°œ&#10;ê°•ì‚¬ì§„ ì†Œê°œ ë° ì»¤ë¦¬í˜ëŸ¼ ì•ˆë‚´&#10;ì…í•™ ì ˆì°¨ ë° ë“±ë¡ ë°©ë²•&#10;ì§ˆì˜ì‘ë‹µ ì‹œê°„" required class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì°¸ì„ í˜œíƒ (1ê°œë‹¹ í•œ ì¤„) *</label>
                            <textarea name="benefits" rows="3" placeholder="ë“±ë¡ë¹„ 50% í• ì¸ ì¿ í°&#10;êµì¬ë¹„ ì „ì•¡ ë¬´ë£Œ&#10;ë ˆë²¨ í…ŒìŠ¤íŠ¸ ë¬´ë£Œ" required class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì—°ë½ì²˜ *</label>
                            <input type="text" name="contact" placeholder="ì˜ˆ: 032-123-4567" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                    </div>
                \`,
                'academy-stats': \`
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì›ëª… *</label>
                            <input type="text" name="academyName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ê¸°ê°„ *</label>
                            <input type="text" name="period" placeholder="ì˜ˆ: 2024ë…„ 2í•™ê¸°" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì´ ì¬í•™ìƒ ìˆ˜</label>
                                <input type="text" name="totalStudents" placeholder="ì˜ˆ: 150" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">í‰ê·  ì„±ì  í–¥ìƒ</label>
                                <input type="text" name="gradeImprovement" placeholder="ì˜ˆ: 2ë“±ê¸‰" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì¬ë“±ë¡ë¥ </label>
                                <input type="text" name="reEnrollmentRate" placeholder="ì˜ˆ: 95%" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ëª…ë¬¸ëŒ€ í•©ê²©ì ìˆ˜</label>
                                <input type="text" name="collegeAdmissions" placeholder="ì˜ˆ: 50ëª…" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">1ë“±ê¸‰ ë‹¬ì„± í•™ìƒ ìˆ˜</label>
                                <input type="text" name="topGradeStudents" placeholder="ì˜ˆ: 30ëª…" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì£¼ìš” ì„±ê³¼ (1ê°œë‹¹ í•œ ì¤„) *</label>
                            <textarea name="achievements" rows="4" placeholder="ì „êµ­ ëª¨ì˜ê³ ì‚¬ 1ë“±ê¸‰ ë‹¬ì„± 10ëª…&#10;ë‚´ì‹  í‰ê·  2ë“±ê¸‰ ì´ìƒ í–¥ìƒ&#10;ëª…ë¬¸ëŒ€ í•©ê²©ë¥  85%&#10;í•™ë¶€ëª¨ ë§Œì¡±ë„ 95%" required class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">í•™ë¶€ëª¨ í›„ê¸° (1ê°œë‹¹ í•œ ì¤„) *</label>
                            <textarea name="testimonials" rows="3" placeholder="ì•„ì´ ì„±ì ì´ 2ë“±ê¸‰ì´ë‚˜ ì˜¬ëì–´ìš”!&#10;ì„ ìƒë‹˜ë“¤ì´ ì •ë§ ì¹œì ˆí•˜ê³  ì—´ì •ì ì…ë‹ˆë‹¤&#10;ì²´ê³„ì ì¸ ê´€ë¦¬ ë•ë¶„ì— ì•ˆì‹¬í•˜ê³  ë§¡ê¹ë‹ˆë‹¤" required class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                        </div>
                    </div>
                \`,
                'teacher-intro': \`
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì„ ìƒë‹˜ ì´ë¦„ *</label>
                            <input type="text" name="teacherName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì„ ìƒë‹˜ ì‚¬ì§„ URL</label>
                            <input type="text" name="teacherPhoto" placeholder="ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            <p class="text-xs text-gray-500 mt-1">ğŸ“Œ ì´ë¯¸ì§€ ì—…ë¡œë“œ: ë¯¸ë””ì–´ ê´€ë¦¬ â†’ ì‚¬ì§„ ì—…ë¡œë“œ â†’ URL ë³µì‚¬</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì „ë¬¸ ê³¼ëª© *</label>
                                <input type="text" name="subject" placeholder="ì˜ˆ: ì˜ì–´" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ê²½ë ¥ (ë…„) *</label>
                                <input type="text" name="experience" placeholder="ì˜ˆ: 10" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">í•™ë ¥ *</label>
                            <input type="text" name="education" placeholder="ì˜ˆ: ì„œìš¸ëŒ€í•™êµ ì˜ì–´êµìœ¡ê³¼ ì¡¸ì—…" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì „ë¬¸ ë¶„ì•¼ *</label>
                            <input type="text" name="specialty" placeholder="ì˜ˆ: ìˆ˜ëŠ¥ ì˜ì–´, ë‚´ì‹  ëŒ€ë¹„, ì˜ë¬¸ë²• íŠ¹í™”" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì£¼ìš” ì‹¤ì  (1ê°œë‹¹ í•œ ì¤„) *</label>
                            <textarea name="achievements" rows="3" placeholder="ìˆ˜ëŠ¥ 1ë“±ê¸‰ í•™ìƒ 50ëª… ì´ìƒ ë°°ì¶œ&#10;í•™ìƒ í‰ê·  2ë“±ê¸‰ í–¥ìƒ ë‹¬ì„±&#10;í•™ë¶€ëª¨ ë§Œì¡±ë„ 98%" required class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ìˆ˜ì—… ë°©ì‹ *</label>
                            <textarea name="teachingStyle" rows="3" placeholder="ê°œì¸ë³„ ë§ì¶¤ ì§„ë„, ì²´ê³„ì ì¸ ì˜¤ë‹µ ê´€ë¦¬, ì‹¤ì „ ë¬¸ì œ í’€ì´ ì¤‘ì‹¬" required class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì—°ë½ì²˜</label>
                            <input type="text" name="contact" placeholder="ì˜ˆ: 032-123-4567" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                        </div>
                    </div>
                \`,
                'vacation-course': \`
                    <div class="space-y-6">
                        <!-- ê¸°ë³¸ ì •ë³´ -->
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì›ëª… *</label>
                                    <input type="text" name="academyName" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">íŠ¹ê°•ëª… *</label>
                                    <input type="text" name="courseName" placeholder="ì˜ˆ: ê²¨ìš¸ë°©í•™ ìˆ˜í•™ íŠ¹ê°•" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-900 mb-2">ê¸°ê°„ *</label>
                                        <input type="text" name="period" placeholder="ì˜ˆ: 2026.01.20 ~ 2026.02.10" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-900 mb-2">ìˆ˜ì—… ì‹œê°„ *</label>
                                        <input type="text" name="schedule" placeholder="ì˜ˆ: ì›”~ê¸ˆ 10:00-12:00" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">ëŒ€ìƒ í•™ë…„</label>
                                    <input type="text" name="targetGrade" placeholder="ì˜ˆ: ì¤‘1~ì¤‘3" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">ì—°ë½ì²˜ *</label>
                                    <input type="text" name="contact" placeholder="ì˜ˆ: 010-1234-5678" required class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">í”Œë ˆì´ìŠ¤ ì£¼ì†Œ (ì„ íƒì‚¬í•­)</label>
                                    <input type="url" name="placeUrl" placeholder="ì˜ˆ: https://place.map.kakao.com/12345" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                    <p class="text-xs text-gray-500 mt-1">ğŸ—ºï¸ ì¹´ì¹´ì˜¤ë§µ, ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë“±ì˜ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ë©´ ì˜¤ì‹œëŠ” ê¸¸ ë²„íŠ¼ì´ ìƒì„±ë©ë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- íŠ¹ê°• í”„ë¡œê·¸ë¨ -->
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“š íŠ¹ê°• í”„ë¡œê·¸ë¨ (ì„ íƒì‚¬í•­)</h3>
                            <p class="text-sm text-gray-500 mb-4">ê° í”„ë¡œê·¸ë¨ì„ í•œ ì¤„ì”© ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                            <div>
                                <textarea name="programs" rows="4" placeholder="ê°œë… ì™„ë²½ ì •ë¦¬ ë° ì‹¬í™” í•™ìŠµ&#10;ë¬¸ì œ í’€ì´ ì§‘ì¤‘ í›ˆë ¨&#10;ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ ëŒ€ë¹„&#10;1:1 ë§ì¶¤ í•™ìŠµ ì½”ì¹­" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                            </div>
                        </div>
                        
                        <!-- ì£¼ì°¨ë³„ ì»¤ë¦¬í˜ëŸ¼ -->
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“… ì£¼ì°¨ë³„ ì»¤ë¦¬í˜ëŸ¼ (ì„ íƒì‚¬í•­)</h3>
                            <p class="text-sm text-gray-500 mb-4">ê° ì£¼ì°¨ ë‚´ìš©ì„ í•œ ì¤„ì”© ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                            <div>
                                <textarea name="curriculum" rows="4" placeholder="ê¸°ì´ˆ ê°œë… ì™„ë²½ ì •ë¦¬&#10;ìœ í˜•ë³„ ë¬¸ì œ í’€ì´ ë§ˆìŠ¤í„°&#10;ì‹¤ì „ ëª¨ì˜ê³ ì‚¬ ë° ë¶„ì„&#10;ìµœì¢… ì ê²€ ë° ë³´ì™„" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                            </div>
                        </div>
                        
                        <!-- íŠ¹ê°• íŠ¹ì§• -->
                        <div class="border-b pb-4">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">â­ íŠ¹ê°• íŠ¹ì§• (ì„ íƒì‚¬í•­)</h3>
                            <p class="text-sm text-gray-500 mb-4">íŠ¹ê°•ë§Œì˜ ì¥ì ì„ í•œ ì¤„ì”© ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                            <div>
                                <textarea name="features" rows="4" placeholder="ì†Œê·œëª¨ ê·¸ë£¹ ìˆ˜ì—…ìœ¼ë¡œ ì§‘ì¤‘ ì¼€ì–´&#10;ë‚´ì‹ ê³¼ ìˆ˜ëŠ¥ ë™ì‹œ ëŒ€ë¹„&#10;ì „ë¬¸ ê°•ì‚¬ì§„ì˜ ì²´ê³„ì  ê´€ë¦¬&#10;ë§¤ì¼ ê³¼ì œ ê²€ì‚¬ ë° í”¼ë“œë°±" class="w-full px-4 py-3 border border-gray-300 rounded-xl"></textarea>
                            </div>
                        </div>
                        
                        <!-- ìˆ˜ê°•ë£Œ -->
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ’° ìˆ˜ê°•ë£Œ (ì„ íƒì‚¬í•­)</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">ìˆ˜ê°•ë£Œ</label>
                                    <input type="text" name="tuition" placeholder="ì˜ˆ: 350,000ì›" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-2">ì¡°ê¸° ë“±ë¡ í˜œíƒ</label>
                                    <input type="text" name="earlyBirdDiscount" placeholder="ì˜ˆ: 1ì›” 10ì¼ê¹Œì§€ ë“±ë¡ ì‹œ 30,000ì› í• ì¸" class="w-full px-4 py-3 border border-gray-300 rounded-xl">
                                </div>
                            </div>
                        </div>
                    </div>
                \`
            };

            document.getElementById('landingForm').innerHTML = forms[type];
            document.getElementById('formArea').classList.remove('hidden');
            document.getElementById('formArea').scrollIntoView({ behavior: 'smooth' });
            
            // í•™ì›ëª… ìë™ ì±„ìš°ê¸°
            setTimeout(() => {
                const academyNameInput = document.querySelector('input[name="academyName"]');
                if (academyNameInput && user && user.academy_name) {
                    academyNameInput.value = user.academy_name;
                }
            }, 100);
            
            // student-report í…œí”Œë¦¿ì¼ ë•Œ í•™ìƒ ëª©ë¡ ë¡œë“œ
            if (type === 'student-report') {
                loadStudentsForSelect();
                // ë‚ ì§œ ì„ íƒê¸° ì´ˆê¸°í™”
                setTimeout(initDatePickers, 100);
            }
        }

        // ğŸ“… ë‚ ì§œ ì„ íƒê¸° ì´ˆê¸°í™”
        let startDatePicker, endDatePicker;
        let selectedStudentId = null;
        
        function initDatePickers() {
            // Flatpickr í•œêµ­ì–´ ì„¤ì •
            flatpickr.localize(flatpickr.l10ns.ko);
            
            // ì‹œì‘ì¼ ì„ íƒê¸°
            startDatePicker = flatpickr('#startDate', {
                dateFormat: 'Y-m-d',
                locale: 'ko',
                onChange: function(selectedDates, dateStr, instance) {
                    console.log('ì‹œì‘ì¼ ì„ íƒ:', dateStr);
                }
            });
            
            // ì¢…ë£Œì¼ ì„ íƒê¸°
            endDatePicker = flatpickr('#endDate', {
                dateFormat: 'Y-m-d',
                locale: 'ko',
                onChange: function(selectedDates, dateStr, instance) {
                    console.log('ì¢…ë£Œì¼ ì„ íƒ:', dateStr);
                }
            });
        }
        
        // í•™ìƒ ì„ íƒ ë³€ê²½ ì‹œ í˜¸ì¶œ
        function handleStudentChange() {
            const select = document.getElementById('studentSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            // ì„ íƒëœ í•™ìƒì˜ IDë¥¼ data ì†ì„±ì—ì„œ ê°€ì ¸ì˜´
            selectedStudentId = selectedOption.getAttribute('data-student-id');
            console.log('ì„ íƒëœ í•™ìƒ ID:', selectedStudentId);
        }
        
        // ğŸ”„ ì¶œì„ë¥  ìë™ ê³„ì‚°
        async function calculateAttendance() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const select = document.getElementById('studentSelect');
            
            if (!select.value) {
                alert('âš ï¸ ë¨¼ì € í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            if (!startDate || !endDate) {
                alert('âš ï¸ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // ì„ íƒëœ í•™ìƒì˜ ID ê°€ì ¸ì˜¤ê¸°
            const selectedOption = select.options[select.selectedIndex];
            const studentId = selectedOption.getAttribute('data-student-id');
            
            if (!studentId) {
                alert('âš ï¸ í•™ìƒ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                // ë¡œë”© í‘œì‹œ
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'â³ ê³„ì‚° ì¤‘...';
                button.disabled = true;
                
                // API í˜¸ì¶œ - ì¶œì„ ë°ì´í„°
                const attendanceResponse = await fetch(
                    \`/api/students/\${studentId}/attendance?startDate=\${startDate}&endDate=\${endDate}\`
                );
                const attendanceResult = await attendanceResponse.json();
                
                // API í˜¸ì¶œ - ì„±ê³¼ ë°ì´í„° (ì´í•´ë„, ì°¸ì—¬ë„)
                const performanceResponse = await fetch(
                    \`/api/students/\${studentId}/performance?startDate=\${startDate}&endDate=\${endDate}\`
                );
                const performanceResult = await performanceResponse.json();
                
                button.textContent = originalText;
                button.disabled = false;
                
                if (attendanceResult.success && attendanceResult.data) {
                    const summary = attendanceResult.data.summary;
                    
                    // í†µê³„ í‘œì‹œ
                    document.getElementById('stat-attended').textContent = summary.attendedDays + 'ì¼';
                    document.getElementById('stat-absent').textContent = summary.absentDays + 'ì¼';
                    document.getElementById('stat-late').textContent = summary.lateDays + 'ì¼';
                    document.getElementById('stat-early').textContent = summary.earlyLeaveDays + 'ì¼';
                    document.getElementById('attendanceStats').classList.remove('hidden');
                    
                    // í¼ ì…ë ¥ í•„ë“œì— ê°’ ì„¤ì •
                    document.getElementById('attendanceRateInput').value = summary.attendanceRate;
                    document.getElementById('attendanceDaysInput').value = summary.attendedDays;
                    document.getElementById('totalDaysInput').value = summary.totalDays;
                    
                    // ì„±ê³¼ ë°ì´í„° ì €ì¥
                    if (performanceResult.success && performanceResult.data) {
                        const perfSummary = performanceResult.data.summary;
                        document.getElementById('understandingLevelInput').value = perfSummary.avgUnderstanding || 0;
                        document.getElementById('participationLevelInput').value = perfSummary.avgParticipation || 0;
                        document.getElementById('homeworkRateInput').value = perfSummary.homeworkRate || 0;
                    }
                    
                    let alertMessage = 
                        \`âœ… í•™ìŠµ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\n\` +
                        \`ğŸ“Š ì¶œì„ í˜„í™© (ì´ \${summary.totalDays}ì¼):\\n\` +
                        \`âœ… ì¶œì„: \${summary.attendedDays}ì¼\\n\` +
                        \`âŒ ê²°ì„: \${summary.absentDays}ì¼\\n\` +
                        \`â° ì§€ê°: \${summary.lateDays}ì¼\\n\` +
                        \`ğŸƒ ì¡°í‡´: \${summary.earlyLeaveDays}ì¼\\n\` +
                        \`ğŸ“ˆ ì¶œì„ë¥ : \${summary.attendanceRate}%\`;
                    
                    if (performanceResult.success && performanceResult.data) {
                        const perfSummary = performanceResult.data.summary;
                        alertMessage += 
                            \`\\n\\nğŸ“š í•™ìŠµ ì„±ê³¼:\\n\` +
                            \`ğŸ§  í‰ê·  ì´í•´ë„: \${perfSummary.avgUnderstanding}/5.0\\n\` +
                            \`ğŸ™‹ í‰ê·  ì°¸ì—¬ë„: \${perfSummary.avgParticipation}/5.0\\n\` +
                            \`ğŸ“ ìˆ™ì œ ì™„ë£Œìœ¨: \${perfSummary.homeworkRate}%\`;
                    }
                    
                    alert(alertMessage);
                } else {
                    alert('âš ï¸ ì¶œì„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\\n\\nì„ íƒí•œ ê¸°ê°„ì— ì¶œì„ ê¸°ë¡ì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('ì¶œì„ ê³„ì‚° ì˜¤ë¥˜:', error);
                alert('âŒ ì¶œì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\\n\\n' + error.message);
            }
        }

        // í•™ìƒ ëª©ë¡ì„ selectì— ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
        async function loadStudentsForSelect() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.id) return;
            
            try {
                const response = await fetch('/api/students?userId=' + user.id);
                const data = await response.json();
                
                if (data.success && data.students) {
                    const select = document.getElementById('studentSelect');
                    if (select) {
                        // ê¸°ì¡´ ì˜µì…˜ ìœ ì§€í•˜ê³  í•™ìƒ ì¶”ê°€
                        data.students.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.name;
                            option.setAttribute('data-student-id', student.id); // í•™ìƒ ID ì €ì¥
                            option.textContent = student.name + (student.grade ? ' (' + student.grade + ')' : '');
                            select.appendChild(option);
                        });
                        
                        if (data.students.length === 0) {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = 'ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤';
                            option.disabled = true;
                            select.appendChild(option);
                        }
                    }
                }
            } catch (err) {
                console.error('í•™ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
            }
        }

        // ì¸ë„¤ì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        async function handleThumbnailUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // íŒŒì¼ íƒ€ì… ì²´í¬
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                event.target.value = '';
                return;
            }

            // ë¡œë”© í‘œì‹œ
            alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...');

            try {
                // ì´ë¯¸ì§€ë¥¼ ë¦¬ì‚¬ì´ì§•í•˜ì—¬ Base64ë¡œ ë³€í™˜
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // ìµœëŒ€ í¬ê¸°: 1200x630 (OG ì´ë¯¸ì§€ ê¶Œì¥ ì‚¬ì´ì¦ˆ)
                    const maxWidth = 1200;
                    const maxHeight = 630;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.floor(width * ratio);
                        height = Math.floor(height * ratio);
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // JPEGë¡œ ì••ì¶• (í’ˆì§ˆ 0.85)
                    canvas.toBlob(async function(blob) {
                        // imgbb APIë¡œ ì—…ë¡œë“œ
                        const formData = new FormData();
                        formData.append('image', blob);
                        
                        try {
                            // imgbb ë¬´ë£Œ API í‚¤
                            const apiKey = 'a6acb7467153b3cf20cff3f57aa812a8';
                            
                            const response = await fetch(\`https://api.imgbb.com/1/upload?key=\${apiKey}\`, {
                                method: 'POST',
                                body: formData
                            });
                            
                            const result = await response.json();
                            
                            if (result.success && result.data && result.data.url) {
                                const imageUrl = result.data.url;
                                
                                // UI ì—…ë°ì´íŠ¸
                                document.getElementById('thumbnailUrl').value = imageUrl;
                                document.getElementById('thumbnailPreviewImg').src = imageUrl;
                                document.getElementById('thumbnailPreview').classList.remove('hidden');
                                
                                alert('âœ… ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nURL: ' + imageUrl);
                            } else {
                                // imgbb ì‹¤íŒ¨ ì‹œ Base64ë¡œ í´ë°±
                                const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                                
                                document.getElementById('thumbnailUrl').value = dataUrl;
                                document.getElementById('thumbnailPreviewImg').src = dataUrl;
                                document.getElementById('thumbnailPreview').classList.remove('hidden');
                                
                                alert('âœ… ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                            }
                        } catch (err) {
                            console.error('imgbb ì—…ë¡œë“œ ì˜¤ë¥˜:', err);
                            
                            // API ì‹¤íŒ¨ ì‹œ Base64ë¡œ í´ë°±
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                            
                            document.getElementById('thumbnailUrl').value = dataUrl;
                            document.getElementById('thumbnailPreviewImg').src = dataUrl;
                            document.getElementById('thumbnailPreview').classList.remove('hidden');
                            
                            alert('âœ… ì´ë¯¸ì§€ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        }
                    }, 'image/jpeg', 0.85);
                };
                
                img.onerror = function() {
                    alert('âŒ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    event.target.value = '';
                };
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
                
            } catch (err) {
                console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', err);
                alert('âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\\n\\nì´ë¯¸ì§€ URLì„ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                event.target.value = '';
            }
        }

        // OG ì œëª©/ì„¤ëª… ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            const ogTitleInput = document.getElementById('ogTitle');
            const ogDescInput = document.getElementById('ogDescription');
            const previewTitle = document.getElementById('previewOgTitle');
            const previewDesc = document.getElementById('previewOgDescription');

            if (ogTitleInput && previewTitle) {
                ogTitleInput.addEventListener('input', function() {
                    previewTitle.textContent = this.value || 'ê¾¸ë©”ë•…í•™ì› ê²¨ìš¸ë°©í•™ íŠ¹ê°• ëª¨ì§‘';
                });
            }

            if (ogDescInput && previewDesc) {
                ogDescInput.addEventListener('input', function() {
                    previewDesc.textContent = this.value || 'ì¤‘ë“± ì˜ì–´/ìˆ˜í•™ ì§‘ì¤‘ ì¼€ì–´! ì„ ì°©ìˆœ 20ëª… í•œì • í• ì¸ ì¤‘';
                });
            }
        });

        async function generateLanding() {
            if (!selectedTemplate) {
                alert('í…œí”Œë¦¿ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const formData = new FormData(document.getElementById('landingForm'));
            const data = Object.fromEntries(formData);
            
            // êµ¬ê¸€ ë“œë¼ì´ë¸Œ URL ë³€í™˜ í•¨ìˆ˜
            function convertGoogleDriveUrl(url) {
                if (!url) return url;
                // https://drive.google.com/file/d/FILE_ID/view í˜•ì‹ ê°ì§€
                const match = url.match(/drive\\.google\\.com\\/file\\/d\\/([^\\/]+)/);
                if (match) {
                    const fileId = match[1];
                    return 'https://drive.google.com/uc?export=view&id=' + fileId;
                }
                return url;
            }
            
            // ì´ë¯¸ì§€ URLë“¤ì„ êµ¬ê¸€ ë“œë¼ì´ë¸Œ í˜•ì‹ì´ë©´ ë³€í™˜
            if (data.directorPhoto) data.directorPhoto = convertGoogleDriveUrl(data.directorPhoto);
            if (data.academyPhoto1) data.academyPhoto1 = convertGoogleDriveUrl(data.academyPhoto1);
            if (data.academyPhoto2) data.academyPhoto2 = convertGoogleDriveUrl(data.academyPhoto2);
            if (data.academyPhoto3) data.academyPhoto3 = convertGoogleDriveUrl(data.academyPhoto3);

            // ì¸ë„¤ì¼ URL ê°€ì ¸ì˜¤ê¸°
            const thumbnailUrl = document.getElementById('thumbnailUrl').value || '';
            
            // OG ì œëª©/ì„¤ëª… ê°€ì ¸ì˜¤ê¸°
            const ogTitle = document.getElementById('ogTitle').value || '';
            const ogDescription = document.getElementById('ogDescription').value || '';
            
            // ì„ íƒëœ í´ë” ê°€ì ¸ì˜¤ê¸°
            const folderId = document.getElementById('folderSelect').value || null;
            
            // ì„ íƒëœ í¼ ê°€ì ¸ì˜¤ê¸°
            const formId = document.getElementById('formSelect').value || null;
            
            // ì„ íƒëœ í´ë”ë¥¼ localStorageì— ì €ì¥ (ë‹¤ìŒë²ˆì— ìë™ ì„ íƒ)
            if (folderId) {
                localStorage.setItem('lastSelectedFolder', folderId);
            } else {
                localStorage.removeItem('lastSelectedFolder');
            }

            // ë°°ì—´ë¡œ ë³€í™˜ì´ í•„ìš”í•œ í•„ë“œë“¤
            if (data.specialties) data.specialties = data.specialties.split('\\n').filter(s => s.trim());
            if (data.features) data.features = data.features.split('\\n').filter(s => s.trim());
            if (data.benefits) data.benefits = data.benefits.split('\\n').filter(s => s.trim());
            if (data.achievements) data.achievements = data.achievements.split('\\n').filter(s => s.trim());
            if (data.improvements) data.improvements = data.improvements.split('\\n').filter(s => s.trim());
            if (data.nextGoals) data.nextGoals = data.nextGoals.split('\\n').filter(s => s.trim());
            if (data.textbooks) {
                data.textbooks = data.textbooks.split('\\n').filter(s => s.trim());
                // ìµœëŒ€ 5ê°œë¡œ ì œí•œ
                if (data.textbooks.length > 5) {
                    alert('âš ï¸ ì‚¬ìš© êµì¬ëŠ” ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤. ì²˜ìŒ 5ê°œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.');
                    data.textbooks = data.textbooks.slice(0, 5);
                }
            }

            // ì œëª© ìƒì„±
            let title = '';
            if (selectedTemplate === 'academy-intro') title = data.academyName + ' ì†Œê°œ';
            else if (selectedTemplate === 'program-promo') title = data.programName;
            else if (selectedTemplate === 'event-promo') title = data.eventName;
            else if (selectedTemplate === 'student-report') title = data.studentName + ' ' + data.month + ' ë¦¬í¬íŠ¸';
            else if (selectedTemplate === 'admission-info') title = data.eventTitle;
            else if (selectedTemplate === 'academy-stats') title = data.academyName + ' ' + data.period + ' ì„±ê³¼';
            else if (selectedTemplate === 'teacher-intro') title = data.teacherName + ' ì„ ìƒë‹˜';
            else if (selectedTemplate === 'vacation-course') title = data.courseName;

            // ë°°ì—´ í•„ë“œ ì²˜ë¦¬ - ìƒˆë¡œìš´ í…œí”Œë¦¿ í¬í•¨
            if (data.agenda) data.agenda = data.agenda.split('\\n').filter(s => s.trim());
            if (data.testimonials) data.testimonials = data.testimonials.split('\\n').filter(s => s.trim());

            try {
                // ë””ë²„ê¹…: ì „ì†¡í•  ë°ì´í„° í™•ì¸
                console.log('ğŸ” ì „ì†¡í•  ë°ì´í„°:', {
                    title,
                    template_type: selectedTemplate,
                    thumbnail_url: thumbnailUrl,
                    og_title: ogTitle,
                    og_description: ogDescription,
                    folder_id: folderId
                });
                
                // í•œê¸€ í¬í•¨ëœ ì‚¬ìš©ì ë°ì´í„°ë¥¼ Base64ë¡œ ì¸ì½”ë”©
                const userDataStr = JSON.stringify(user || {id: 1});
                const userDataBase64 = btoa(unescape(encodeURIComponent(userDataStr)));
                
                const response = await fetch('/api/landing/create', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-User-Data-Base64': userDataBase64
                    },
                    body: JSON.stringify({
                        title,
                        template_type: selectedTemplate,
                        input_data: data,
                        thumbnail_url: thumbnailUrl,
                        og_title: ogTitle,
                        og_description: ogDescription,
                        folder_id: folderId,
                        form_id: formId
                    })
                });

                const result = await response.json();
                if (result.success) {
                    const fullUrl = window.location.origin + result.url;
                    document.getElementById('shareUrl').value = fullUrl;
                    document.getElementById('previewBtn').href = result.url;
                    document.getElementById('resultArea').classList.remove('hidden');
                    document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
                    
                    // QR ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ ë° slug ì €ì¥
                    const qrBtn = document.getElementById('qrDownloadBtn');
                    qrBtn.classList.remove('hidden');
                    qrBtn.dataset.slug = result.slug;
                    
                    // í¬ì¸íŠ¸ ì‚¬ìš© ì‹œ ì•Œë¦¼
                    if (result.usedPoints) {
                        alert('âœ… ëœë”©í˜ì´ì§€ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nğŸ’° ' + result.pointsDeducted.toLocaleString() + 'í¬ì¸íŠ¸ê°€ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                } else {
                    // í¬ì¸íŠ¸ ë¶€ì¡±ìœ¼ë¡œ ì¸í•œ ì—ëŸ¬ ì²˜ë¦¬
                    if (result.needsPoints) {
                        const goToCharge = confirm(result.error);
                        if (goToCharge) {
                            // ëŒ€ì‹œë³´ë“œì˜ í¬ì¸íŠ¸ ê´€ë¦¬ ì„¹ì…˜ìœ¼ë¡œ ì´ë™
                            window.location.href = '/dashboard#points';
                        }
                    } else {
                        alert('ì˜¤ë¥˜: ' + result.error);
                    }
                }
            } catch (err) {
                console.error('ëœë”©í˜ì´ì§€ ìƒì„± ì—ëŸ¬:', err);
                alert('ëœë”©í˜ì´ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”: ' + err.message);
            }
        }

        // í¼ ëª©ë¡ ë¡œë“œ
        async function loadForms() {
            try {
                const response = await fetch('/api/form-templates', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                        return;
                    }
                    throw new Error('í¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                const templates = await response.json();
                allForms = templates || [];
                populateFormSelect();
            } catch (error) {
                console.error('í¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // í¼ ì„ íƒ ì˜µì…˜ ì±„ìš°ê¸°
        function populateFormSelect() {
            const select = document.getElementById('formSelect');
            if (!select) return;
            
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ì œì™¸)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // í¼ ëª©ë¡ ì¶”ê°€
            allForms.forEach(form => {
                const option = document.createElement('option');
                option.value = form.id;
                option.textContent = form.name;
                select.appendChild(option);
            });
        }

        function copyUrl() {
            const input = document.getElementById('shareUrl');
            input.select();
            document.execCommand('copy');
            alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        
        async function downloadQRCode() {
            const qrBtn = document.getElementById('qrDownloadBtn');
            const slug = qrBtn.dataset.slug;
            
            if (!slug) {
                console.error('QR ì½”ë“œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const response = await fetch('/api/landing/' + slug + '/qr?size=500');
                const result = await response.json();
                
                if (result.success) {
                    // QR ì½”ë“œë¥¼ ë‹¤ìš´ë¡œë“œ
                    const qrImage = new Image();
                    qrImage.crossOrigin = 'anonymous';
                    qrImage.src = result.qrCodeUrl;
                    
                    qrImage.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = qrImage.width;
                        canvas.height = qrImage.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(qrImage, 0, 0);
                        
                        canvas.toBlob(function(blob) {
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = 'QR_' + result.title.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_') + '.png';
                            link.click();
                            console.log('âœ… QR ì½”ë“œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        });
                    };
                    
                    qrImage.onerror = function() {
                        // Fallback: ìƒˆ ì°½ì—ì„œ ì—´ê¸°
                        window.open(result.qrCodeUrl, '_blank');
                        console.log('QR ì½”ë“œê°€ ìƒˆ íƒ­ì—ì„œ ì—´ë ¸ìŠµë‹ˆë‹¤.');
                    };
                } else {
                    console.error('QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨:', result.error);
                }
            } catch (err) {
                console.error('QR download error:', err);
                console.error('QR ì½”ë“œ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', err);
            }
        }
        </script>
    </body>
    </html>
  `)
})

// ì‹ ì²­ì ê´€ë¦¬ í˜ì´ì§€
app.get('/landing/:slug/submissions', async (c) => {
  const slug = c.req.param('slug')
  
  return c.html(`<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ ì²­ì ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b-4 border-purple-600">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/tools/landing-builder" class="text-gray-700 hover:text-purple-600">ë‚´ ëœë”©í˜ì´ì§€</a>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center gap-2 text-sm text-gray-600 mb-4">
                <a href="/tools/landing-builder" class="hover:text-purple-600">ë‚´ ëœë”©í˜ì´ì§€</a>
                <i class="fas fa-chevron-right text-xs"></i>
                <span id="pageTitle" class="text-gray-900 font-medium">ì‹ ì²­ì ê´€ë¦¬</span>
            </div>
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        <i class="fas fa-users text-purple-600 mr-3"></i>ì‹ ì²­ì ê´€ë¦¬
                    </h1>
                    <p class="text-gray-600">ëœë”©í˜ì´ì§€ë¥¼ í†µí•´ ì‹ ì²­í•œ ê³ ê° ëª©ë¡ì…ë‹ˆë‹¤</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-600 mb-1">ì´ ì‹ ì²­ì</div>
                    <div id="totalCount" class="text-3xl font-bold text-purple-600">0</div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200 mb-6">
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="ì´ë¦„, ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..." 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
                <button onclick="exportToCSV()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                    <i class="fas fa-file-excel"></i>
                    ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                </button>
                <button onclick="loadSubmissions()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i>
                    ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
        </div>

        <!-- Submissions Table -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ë²ˆí˜¸</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ì´ë¦„</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ì—°ë½ì²˜</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ì´ë©”ì¼</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ì¶”ê°€ì •ë³´</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">ì‹ ì²­ì¼ì‹œ</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTableBody" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16">
            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">ì•„ì§ ì‹ ì²­ìê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p class="text-gray-500 mb-6">ëœë”©í˜ì´ì§€ë¥¼ ê³µìœ í•˜ê³  ì²« ì‹ ì²­ìë¥¼ ë°›ì•„ë³´ì„¸ìš”!</p>
            <a href="/tools/landing-builder" class="inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                <i class="fas fa-arrow-left mr-2"></i>ëœë”©í˜ì´ì§€ ëª©ë¡ìœ¼ë¡œ
            </a>
        </div>
    </div>

    <script>
        let allSubmissions = [];
        let landingPageData = null;
        
        // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function formatKoreanTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            // UTC ì‹œê°„ì„ KST (UTC+9)ë¡œ ë³€í™˜
            const kstDate = new Date(date.getTime() + (9 * 60 * 60 * 1000));
            return kstDate.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        async function loadSubmissions() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (!user.id) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }

                const userDataBase64 = btoa(JSON.stringify(user));
                const response = await fetch('/api/landing/${slug}/submissions', {
                    headers: {
                        'X-User-Data-Base64': userDataBase64
                    }
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    alert(result.error || 'ì‹ ì²­ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                landingPageData = result.landingPage;
                allSubmissions = result.submissions || [];
                
                document.getElementById('pageTitle').textContent = landingPageData.title;
                document.getElementById('totalCount').textContent = result.total;
                
                renderSubmissions(allSubmissions);
            } catch (err) {
                console.error('Error loading submissions:', err);
                alert('ì‹ ì²­ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function renderSubmissions(submissions) {
            const tbody = document.getElementById('submissionsTableBody');
            const emptyState = document.getElementById('emptyState');
            const table = tbody.closest('.bg-white');
            
            if (submissions.length === 0) {
                table.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            table.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            tbody.innerHTML = submissions.map((sub, index) => {
                const additionalData = sub.additional_data ? JSON.parse(sub.additional_data) : {};
                const additionalDataStr = Object.entries(additionalData)
                    .map(([key, value]) => \`\${key}: \${value}\`)
                    .join('<br>') || '-';
                
                return \`
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-900">\${submissions.length - index}</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">\${sub.name}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">\${sub.phone || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600">\${sub.email || '-'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-xs text-gray-600">\${additionalDataStr}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900">\${formatKoreanTime(sub.created_at)}</div>
                        </td>
                    </tr>
                \`;
            }).join('');
        }

        function exportToCSV() {
            if (allSubmissions.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const headers = ['ë²ˆí˜¸', 'ì´ë¦„', 'ì—°ë½ì²˜', 'ì´ë©”ì¼', 'ì¶”ê°€ì •ë³´', 'ì‹ ì²­ì¼ì‹œ'];
            const rows = allSubmissions.map((sub, index) => {
                const additionalData = sub.additional_data ? JSON.parse(sub.additional_data) : {};
                const additionalDataStr = Object.entries(additionalData)
                    .map(([key, value]) => \`\${key}: \${value}\`)
                    .join(' | ');
                
                return [
                    allSubmissions.length - index,
                    sub.name,
                    sub.phone || '-',
                    sub.email || '-',
                    additionalDataStr || '-',
                    formatKoreanTime(sub.created_at)
                ];
            });
            
            const csvContent = [headers, ...rows]
                .map(row => row.map(cell => \`"\${cell}"\`).join(','))
                .join('\\n');
            
            const BOM = '\\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = \`ì‹ ì²­ìëª©ë¡_\${landingPageData?.title || 'landing'}_\${new Date().toISOString().split('T')[0]}.csv\`;
            link.click();
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allSubmissions.filter(sub => 
                sub.name.toLowerCase().includes(searchTerm) ||
                (sub.phone && sub.phone.includes(searchTerm)) ||
                (sub.email && sub.email.toLowerCase().includes(searchTerm))
            );
            renderSubmissions(filtered);
        });

        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('loginTime');
            window.location.href = '/';
        }

        // Load on page load
        loadSubmissions();
    </script>
</body>
</html>`)
})


// ëœë”©í˜ì´ì§€ ê´€ë¦¬ í˜ì´ì§€
app.get('/tools/landing-manager', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë‚´ ëœë”©í˜ì´ì§€ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <span class="text-xl font-bold text-gray-900">ë‚´ ëœë”©í˜ì´ì§€</span>
                    <div class="flex gap-4">
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="/tools/landing-builder" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">+ ìƒˆë¡œ ë§Œë“¤ê¸°</a>
                        <button onclick="logout()" class="text-gray-600 hover:text-red-600">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="mb-8 flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ“ ë‚´ ëœë”©í˜ì´ì§€</h1>
                        <p class="text-gray-600">ìƒì„±í•œ ëœë”©í˜ì´ì§€ë¥¼ í´ë”ë¡œ ì •ë¦¬í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
                    </div>
                    <button onclick="openFolderModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                        + ìƒˆ í´ë”
                    </button>
                </div>

                <!-- Folders -->
                <div class="mb-8">
                    <div class="flex gap-3 overflow-x-auto pb-4" id="foldersList">
                        <button onclick="selectFolder(null)" id="folder-all" class="folder-btn px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 whitespace-nowrap">
                            ğŸ“ ì „ì²´ (0)
                        </button>
                    </div>
                </div>

                <!-- Pages List -->
                <div id="pagesList" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">ë¡œë”©ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- Folder Modal -->
        <div id="folderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ìƒˆ í´ë” ë§Œë“¤ê¸°</h2>
                <input type="text" id="folderName" placeholder="í´ë” ì´ë¦„ (ì˜ˆ: í•™ë¶€ëª¨ ê³µìœ ìš©)" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-6">
                <div class="flex gap-3">
                    <button onclick="closeFolderModal()" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200">
                        ì·¨ì†Œ
                    </button>
                    <button onclick="createFolder()" class="flex-1 px-4 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700">
                        ìƒì„±
                    </button>
                </div>
            </div>
        </div>

        <!-- Move to Folder Modal -->
        <div id="moveFolderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">í´ë”ë¡œ ì´ë™</h2>
                <div id="folderSelectList" class="space-y-2 mb-6 max-h-96 overflow-y-auto">
                    <!-- í´ë” ëª©ë¡ -->
                </div>
                <button onclick="closeMoveFolderModal()" class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>

        <script>
        let user = null;
        let currentFolder = null;
        let allFolders = [];
        let currentPageToMove = null;

        const userData = localStorage.getItem('user');
        if (!userData) {
            alert('\uB85C\uADF8\uC778\uC774 \uD544\uC694\uD569\uB2C8\uB2E4.');
            window.location.href = '/login';
        } else {
            user = JSON.parse(userData);
            loadFolders();
            loadPages();
        }

        function logout() {
            localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
            window.location.href = '/';
        }

        // í´ë” ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadFolders() {
            try {
                const response = await fetch('/api/landing/folders?userId=' + user.id);
                const result = await response.json();
                
                if (result.success && result.folders) {
                    allFolders = result.folders;
                    const foldersHtml = allFolders.map(f => 
                        '<button onclick="selectFolder(' + f.id + ')" id="folder-' + f.id + '" class="folder-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 whitespace-nowrap">' +
                            'ğŸ“ ' + f.name + ' (' + (f.page_count || 0) + ')' +
                        '</button>'
                    ).join('');
                    
                    document.getElementById('foldersList').innerHTML = 
                        '<button onclick="selectFolder(null)" id="folder-all" class="folder-btn px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 whitespace-nowrap">' +
                            'ğŸ“ \uC804\uCCB4 (' + (result.totalPages || 0) + ')' +
                        '</button>' + foldersHtml;
                }
            } catch (err) {
                console.error('\uD3F4\uB354 \uB85C\uB4DC \uC2E4\uD328:', err);
            }
        }

        // í´ë” ì„ íƒ
        function selectFolder(folderId) {
            currentFolder = folderId;
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.folder-btn').forEach(btn => {
                btn.className = 'folder-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 whitespace-nowrap';
            });
            
            const selectedBtn = document.getElementById('folder-' + (folderId || 'all'));
            if (selectedBtn) {
                selectedBtn.className = 'folder-btn px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 whitespace-nowrap';
            }
            
            loadPages();
        }

        // í˜ì´ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadPages() {
            try {
                let url = '/api/landing/my-pages?userId=' + user.id;
                if (currentFolder) {
                    url += '&folderId=' + currentFolder;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success && result.pages.length > 0) {
                    const html = result.pages.map(p => {
                        const typeNames = {
                            'academy-intro': '\uD83C\uDFEB \uD559\uC6D0 \uC18C\uAC1C',
                            'program-promo': '\uD83D\uDCDA \uD504\uB85C\uADF8\uB7A8 \uD64D\uBCF4',
                            'event-promo': '\uD83C\uDF89 \uC774\uBCA4\uD2B8',
                            'student-report': '\uD83D\uDCCA \uD559\uC0DD \uB9AC\uD3EC\uD2B8'
                        };
                        const url = window.location.origin + '/landing/' + p.slug;
                        return '<div class="bg-white rounded-xl p-6 border border-gray-200 hover:shadow-lg transition">' +
                                '<div class="flex items-start justify-between">' +
                                    '<div class="flex-1">' +
                                        '<div class="flex items-center gap-3 mb-2">' +
                                            '<span class="px-3 py-1 bg-purple-100 text-purple-700 text-xs rounded-full font-medium">' +
                                                (typeNames[p.template_type] || p.template_type) +
                                            '</span>' +
                                            '<span class="text-sm text-gray-500">\uC870\uD68C\uC218: ' + p.view_count + '</span>' +
                                        '</div>' +
                                        '<h3 class="text-xl font-bold text-gray-900 mb-3">' + p.title + '</h3>' +
                                        '<div class="flex items-center gap-2 mb-3">' +
                                            '<input type="text" value="' + url + '" readonly class="flex-1 px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm">' +
                                            '<button onclick="copyUrl(' + JSON.stringify(url) + ')" class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm hover:bg-gray-700">\uBCF5\uC0AC</button>' +
                                        '</div>' +
                                        '<p class="text-sm text-gray-500">\uC0DD\uC131\uC77C: ' + new Date(p.created_at).toLocaleString('ko-KR') + '</p>' +
                                    '</div>' +
                                    '<div class="flex flex-col gap-2 ml-4">' +
                                        '<a href="/landing/' + p.slug + '" target="_blank" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm text-center">\uBBF8\uB9AC\uBCF4\uAE30</a>' +
                                        '<a href="/tools/landing-editor/' + p.slug + '" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm text-center flex items-center justify-center gap-2"><i class="fas fa-edit"></i> \uC218\uC815</a>' +
                                        '<button onclick="generateQR(' + JSON.stringify(p.slug) + ')" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 text-sm flex items-center justify-center gap-2"><i class="fas fa-qrcode"></i> QR \\uC0DD\\uC131</button>' +
                                        '<a href="/landing/' + p.slug + '/submissions" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm text-center flex items-center justify-center gap-2"><i class="fas fa-users"></i> \uC2E0\uCCAD\uC790</a>' +
                                        '<button onclick="openMoveFolderModal(' + p.id + ')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">\uD3F4\uB354 \uC774\uB3D9</button>' +
                                        '<button onclick="deletePage(' + p.id + ')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">\uC0AD\uC81C</button>' +
                                    '</div>' +
                                '</div>' +
                            '</div>';
                    }).join('');
                    document.getElementById('pagesList').innerHTML = html;
                } else {
                    document.getElementById('pagesList').innerHTML = '<div class="text-center py-12">' +
                            '<p class="text-gray-500 mb-4">\uB79C\uB529\uD398\uC774\uC9C0\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4.</p>' +
                            '<a href="/tools/landing-builder" class="inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">\uCCAB \uB79C\uB529\uD398\uC774\uC9C0 \uB9CC\uB4E4\uAE30</a>' +
                        '</div>';
                }
            } catch (err) {
                document.getElementById('pagesList').innerHTML = '<div class="text-center py-12 text-red-500">\uB85C\uB529 \uC2E4\uD328</div>';
            }
        }

        function copyUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('\uB9C1\uD06C\uAC00 \uBCF5\uC0AC\uB418\uC5C8\uC2B5\uB2C8\uB2E4!');
            });
        }

        // QR ì½”ë“œ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
        async function generateQR(slug) {
            try {
                const response = await fetch('/api/landing/' + slug + '/qr?size=500');
                const result = await response.json();
                
                if (result.success) {
                    // QR ì½”ë“œë¥¼ ë‹¤ìš´ë¡œë“œ
                    const qrImage = new Image();
                    qrImage.crossOrigin = 'anonymous';
                    qrImage.src = result.qrCodeUrl;
                    
                    qrImage.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = qrImage.width;
                        canvas.height = qrImage.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(qrImage, 0, 0);
                        
                        canvas.toBlob(function(blob) {
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = 'QR_' + result.title.replace(/[^a-zA-Z0-9\uAC00-\uD7A3]/g, '_') + '.png';
                            link.click();
                            console.log('QR \uCF54\uB4DC\uAC00 \uB2E4\uC6B4\uB85C\uB4DC\uB418\uC5C8\uC2B5\uB2C8\uB2E4!');
                        });
                    };
                    
                    qrImage.onerror = function() {
                        // Fallback: ìƒˆ ì°½ì—ì„œ ì—´ê¸°
                        window.open(result.qrCodeUrl, '_blank');
                        console.log('QR \uCF54\uB4DC\uAC00 \uC0C8 \uD0ED\uC5D0\uC11C \uC5F4\uB838\uC2B5\uB2C8\uB2E4.');
                    };
                } else {
                    console.error('QR \uCF54\uB4DC \uC0DD\uC131 \uC2E4\uD328:', result.error);
                }
            } catch (err) {
                console.error('QR generation error:', err);
                console.error('QR \uCF54\uB4DC \uC0DD\uC131 \uC624\uB958:', err);
            }
        }

        // í´ë” ëª¨ë‹¬
        function openFolderModal() {
            document.getElementById('folderModal').classList.remove('hidden');
        }

        function closeFolderModal() {
            document.getElementById('folderModal').classList.add('hidden');
            document.getElementById('folderName').value = '';
        }

        async function createFolder() {
            const name = document.getElementById('folderName').value.trim();
            if (!name) {
                alert('\uD3F4\uB354 \uC774\uB984\uC744 \uC785\uB825\uD558\uC138\uC694.');
                return;
            }

            try {
                const response = await fetch('/api/landing/folders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id, name })
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('\uD3F4\uB354\uAC00 \uC0DD\uC131\uB418\uC5C8\uC2B5\uB2C8\uB2E4!');
                    closeFolderModal();
                    loadFolders();
                } else {
                    alert('\uD3F4\uB354 \uC0DD\uC131 \uC2E4\uD328: ' + result.error);
                }
            } catch (err) {
                alert('\uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.');
            }
        }

        // í´ë” ì´ë™ ëª¨ë‹¬
        function openMoveFolderModal(pageId) {
            currentPageToMove = pageId;
            
            const foldersHtml = allFolders.map(f =>
                '<button onclick="moveToFolder(' + f.id + ')" class="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg text-left border border-gray-200">' +
                    'ğŸ“ ' + f.name +
                '</button>'
            ).join('');
            
            document.getElementById('folderSelectList').innerHTML = 
                '<button onclick="moveToFolder(null)" class="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 rounded-lg text-left border border-gray-200">' +
                    'ğŸ“ \uD3F4\uB354 \uC5C6\uC74C (\uC804\uCCB4)' +
                '</button>' + foldersHtml;
            
            document.getElementById('moveFolderModal').classList.remove('hidden');
        }

        function closeMoveFolderModal() {
            document.getElementById('moveFolderModal').classList.add('hidden');
            currentPageToMove = null;
        }

        async function moveToFolder(folderId) {
            try {
                const response = await fetch('/api/landing/move-to-folder', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pageId: currentPageToMove, 
                        folderId: folderId 
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('\uD3F4\uB354\uB85C \uC774\uB3D9\uB418\uC5C8\uC2B5\uB2C8\uB2E4!');
                    closeMoveFolderModal();
                    loadFolders();
                    loadPages();
                } else {
                    alert('\uC774\uB3D9 \uC2E4\uD328: ' + result.error);
                }
            } catch (err) {
                alert('\uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.');
            }
        }

        async function deletePage(id) {
            if (!confirm('\uC815\uB9D0 \uC0AD\uC81C\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?')) return;
            
            try {
                const response = await fetch('/api/landing/' + id + '?userId=' + user.id, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    alert('\uC0AD\uC81C\uB418\uC5C8\uC2B5\uB2C8\uB2E4.');
                    loadFolders();
                    loadPages();
                } else {
                    alert('\uC0AD\uC81C \uC2E4\uD328: ' + (result.error || '\uC54C \uC218 \uC5C6\uB294 \uC624\uB958'));
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert('\uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4: ' + err.message);
            }
        }
        </script>
    </body>
    </html>
  `)
})
// í¼ ê´€ë¦¬ í˜ì´ì§€
app.get('/tools/form-manager', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í¼ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <span class="text-xl font-bold text-gray-900">í¼ ê´€ë¦¬</span>
                    <div class="flex gap-4">
                        <a href="/tools/form-builder" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium flex items-center gap-2">
                            <i class="fas fa-plus"></i> ìƒˆ í¼ ë§Œë“¤ê¸°
                        </a>
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="/tools/landing-builder" class="text-gray-600 hover:text-purple-600">ëœë”©í˜ì´ì§€</a>
                        <button onclick="logout()" class="text-gray-600 hover:text-red-600">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ“‹ ë‚´ í¼ ê´€ë¦¬</h1>
                    <p class="text-gray-600">ìƒì„±í•œ í¼ì„ ê´€ë¦¬í•˜ê³  ì œì¶œ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”</p>
                </div>

                <!-- Forms List -->
                <div id="formsList" class="space-y-4">
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-3xl mb-4"></i>
                        <p>ë¡œë”©ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- HTML ë³´ê¸° ëª¨ë‹¬ -->
        <div id="htmlModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">ğŸ“„ í¼ HTML ì½”ë“œ</h2>
                    <button onclick="closeHtmlModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">í¼ ì´ë¦„</label>
                    <div id="htmlFormName" class="px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg"></div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">HTML ì½”ë“œ</label>
                    <div class="relative">
                        <pre id="htmlCode" class="bg-gray-900 text-green-400 p-4 rounded-lg overflow-x-auto text-sm font-mono" style="max-height: 500px;"></pre>
                        <button onclick="copyHtmlCode()" class="absolute top-4 right-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm flex items-center gap-2">
                            <i class="fas fa-copy"></i> ë³µì‚¬
                        </button>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="closeHtmlModal()" class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 font-semibold">
                        ë‹«ê¸°
                    </button>
                </div>
            </div>
        </div>

        <script>
        let user = null;

        const userData = localStorage.getItem('user');
        if (!userData) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
        } else {
            user = JSON.parse(userData);
            loadForms();
        }
        
        // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function formatKoreanTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            // UTC ì‹œê°„ì„ KST (UTC+9)ë¡œ ë³€í™˜
            const kstDate = new Date(date.getTime() + (9 * 60 * 60 * 1000));
            return kstDate.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('loginTime');
            window.location.href = '/';
        }

        // UTF-8 safe base64 encoding
        function base64Encode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                return String.fromCharCode('0x' + p1);
            }));
        }

        async function loadForms() {
            try {
                const userDataBase64 = base64Encode(JSON.stringify(user));
                const response = await fetch('/api/form-templates', {
                    headers: {
                        'X-User-Data-Base64': userDataBase64
                    }
                });
                const forms = await response.json();
                
                if (Array.isArray(forms) && forms.length > 0) {
                    const html = forms.map(form => {
                        return \`
                            <div class="bg-white rounded-xl p-6 border border-gray-200 hover:shadow-lg transition">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <h3 class="text-xl font-bold text-gray-900">\${form.name}</h3>
                                            <span class="px-3 py-1 bg-\${form.status === 'active' ? 'green' : 'gray'}-100 text-\${form.status === 'active' ? 'green' : 'gray'}-700 text-xs rounded-full font-medium">
                                                \${form.status === 'active' ? 'í™œì„±' : 'ë¹„í™œì„±'}
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-600 mb-3">\${form.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                                        <div class="flex items-center gap-4 text-sm text-gray-500">
                                            <span><i class="fas fa-calendar mr-2"></i>ìƒì„±ì¼: \${formatKoreanTime(form.created_at)}</span>
                                            <span><i class="fas fa-paper-plane mr-2"></i>ì œì¶œ: \${form.submission_count || 0}ê±´</span>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2 ml-4">
                                        <button onclick="viewSubmissions(\${form.id}, '\${form.name}')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm flex items-center gap-2">
                                            <i class="fas fa-list"></i> ì œì¶œ ë‚´ì—­
                                        </button>
                                        <button onclick="editForm(\${form.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm flex items-center gap-2">
                                            <i class="fas fa-edit"></i> ìˆ˜ì •
                                        </button>
                                        <button onclick="viewFormHtml(\${form.id}, '\${form.name}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm flex items-center gap-2">
                                            <i class="fas fa-code"></i> HTML ë³´ê¸°
                                        </button>
                                        <button onclick="deleteForm(\${form.id}, '\${form.name}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm flex items-center gap-2">
                                            <i class="fas fa-trash"></i> ì‚­ì œ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        \`;
                    }).join('');
                    document.getElementById('formsList').innerHTML = html;
                } else {
                    document.getElementById('formsList').innerHTML = \`
                        <div class="text-center py-12">
                            <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 mb-4">ìƒì„±ëœ í¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p class="text-sm text-gray-400 mb-6">í¼ì„ ë§Œë“¤ì–´ì„œ ëœë”©í˜ì´ì§€ì— ì¶”ê°€í•˜ê±°ë‚˜ ì§ì ‘ ì‚¬ìš©í•˜ì„¸ìš”</p>
                            <a href="/tools/form-builder" class="inline-block px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">
                                <i class="fas fa-plus mr-2"></i>ì²« í¼ ë§Œë“¤ê¸°
                            </a>
                        </div>
                    \`;
                }
            } catch (err) {
                console.error('Forms loading error:', err);
                document.getElementById('formsList').innerHTML = \`
                    <div class="text-center py-12 text-red-500">
                        <i class="fas fa-exclamation-triangle text-3xl mb-4"></i>
                        <p>í¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                \`;
            }
        }

        function viewSubmissions(formId, formName) {
            // ì œì¶œ ë‚´ì—­ ë³´ê¸° - ëª¨ë‹¬ë¡œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
            window.open(\`/forms/\${formId}/submissions\`, '_blank');
        }

        function editForm(formId) {
            window.location.href = \`/tools/form-editor/\${formId}\`;
        }

        async function deleteForm(formId, formName) {
            if (!confirm(\`ì •ë§ '\${formName}' í¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì—°ê²°ëœ ëœë”©í˜ì´ì§€ì— ì˜í–¥ì„ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\`)) {
                return;
            }
            
            try {
                const userDataBase64 = base64Encode(JSON.stringify(user));
                const response = await fetch(\`/api/form-templates/\${formId}\`, {
                    method: 'DELETE',
                    headers: {
                        'X-User-Data-Base64': userDataBase64
                    }
                });
                const result = await response.json();
                if (response.ok) {
                    alert('í¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadForms();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }

        // HTML ë³´ê¸° í•¨ìˆ˜ë“¤
        async function viewFormHtml(formId, formName) {
            try {
                const response = await fetch(\`/api/form-templates/\${formId}/html\`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    document.getElementById('htmlFormName').textContent = formName;
                    document.getElementById('htmlCode').textContent = data.html;
                    document.getElementById('htmlModal').classList.remove('hidden');
                } else {
                    alert('HTMLì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (err) {
                console.error('HTML view error:', err);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }

        function closeHtmlModal() {
            document.getElementById('htmlModal').classList.add('hidden');
        }

        async function copyHtmlCode() {
            const htmlCode = document.getElementById('htmlCode').textContent;
            try {
                await navigator.clipboard.writeText(htmlCode);
                alert('âœ… HTML ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (err) {
                console.error('Copy error:', err);
                // Fallback: select and copy
                const range = document.createRange();
                range.selectNode(document.getElementById('htmlCode'));
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                alert('âœ… HTML ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }
        </script>
    </body>
    </html>
  `)
})

// í¼ ìˆ˜ì • í˜ì´ì§€
app.get('/tools/form-editor/:id', async (c) => {
  const formId = c.req.param('id')
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í¼ ìˆ˜ì • - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <span class="text-xl font-bold text-gray-900">í¼ ìˆ˜ì •</span>
                    <div class="flex gap-4">
                        <a href="/tools/form-manager" class="text-gray-600 hover:text-purple-600">í¼ ê´€ë¦¬</a>
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <button onclick="logout()" class="text-gray-600 hover:text-red-600">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="mb-8">
                    <a href="/tools/form-manager" class="text-purple-600 hover:text-purple-700 inline-flex items-center mb-4">
                        <i class="fas fa-arrow-left mr-2"></i>í¼ ê´€ë¦¬ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">âœï¸ í¼ ìˆ˜ì •</h1>
                    <p class="text-gray-600">í¼ ì´ë¦„ê³¼ ì»¤ìŠ¤í…€ í•­ëª©ì„ ìˆ˜ì •í•˜ì„¸ìš”</p>
                </div>

                <!-- ë¡œë”© ìƒíƒœ -->
                <div id="loading" class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
                    <p class="text-gray-600">í¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>

                <!-- í¼ í¸ì§‘ ì˜ì—­ -->
                <div id="formEditor" class="hidden">
                    <div class="bg-white rounded-xl p-8 border border-gray-200 shadow-sm mb-6">
                        <h2 class="text-xl font-bold mb-6">ğŸ“ ê¸°ë³¸ ì •ë³´</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">í¼ ì´ë¦„ *</label>
                                <input type="text" id="formName" placeholder="ì˜ˆ: ìˆ˜í•™ í•™ì› ìƒë‹´ ì‹ ì²­" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ì„¤ëª…</label>
                                <textarea id="formDescription" rows="3" placeholder="í¼ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ì•½ê´€ ë¬¸êµ¬</label>
                                <input type="text" id="termsText" placeholder="ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤." 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ì„±ê³µ ë©”ì‹œì§€</label>
                                <input type="text" id="successMessage" placeholder="ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-8 border border-gray-200 shadow-sm mb-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold">ğŸ“‹ ì»¤ìŠ¤í…€ í•­ëª©</h2>
                            <button onclick="addField()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                                <i class="fas fa-plus"></i> í•­ëª© ì¶”ê°€
                            </button>
                        </div>

                        <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                <strong>ê¸°ë³¸ í•­ëª©:</strong> ì´ë¦„, ì—°ë½ì²˜(ì „í™”ë²ˆí˜¸), ì´ë©”ì¼ì€ ê¸°ë³¸ìœ¼ë¡œ ì œê³µë©ë‹ˆë‹¤. 
                                ì¶”ê°€ë¡œ í•„ìš”í•œ í•­ëª©(í•™ë…„, ìë…€ ì´ë¦„ ë“±)ì„ ì•„ë˜ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.
                            </p>
                        </div>

                        <div id="fieldsList" class="space-y-4">
                            <!-- ì»¤ìŠ¤í…€ í•­ëª©ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>

                        <div id="emptyFields" class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-3"></i>
                            <p>ì¶”ê°€ëœ ì»¤ìŠ¤í…€ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            <p class="text-sm text-gray-400 mt-2">ì˜ˆ: í•™ë…„, ìë…€ ì´ë¦„, í•™ìŠµ í¬ë§ ê³¼ëª© ë“±</p>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="saveForm()" class="flex-1 px-6 py-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold text-lg flex items-center justify-center gap-2">
                            <i class="fas fa-save"></i> ì €ì¥í•˜ê¸°
                        </button>
                        <button onclick="cancelEdit()" class="px-6 py-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold text-lg">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
        let user = null;
        let formData = null;
        let fields = [];
        const formId = ${formId};

        const userData = localStorage.getItem('user');
        if (!userData) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
        } else {
            user = JSON.parse(userData);
            loadFormData();
        }

        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('loginTime');
            window.location.href = '/';
        }

        async function loadFormData() {
            try {
                const response = await fetch(\`/api/forms/\${formId}\`);
                const result = await response.json();
                
                if (result.success && result.form) {
                    formData = result.form;
                    
                    // ê¸°ë³¸ ì •ë³´ ì±„ìš°ê¸°
                    document.getElementById('formName').value = formData.name || '';
                    document.getElementById('formDescription').value = formData.description || '';
                    document.getElementById('termsText').value = formData.terms_text || 'ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.';
                    document.getElementById('successMessage').value = formData.success_message || 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!';
                    
                    // í•„ë“œ ë°ì´í„° íŒŒì‹±
                    try {
                        fields = formData.fields ? JSON.parse(formData.fields) : [];
                    } catch (e) {
                        fields = [];
                    }
                    
                    renderFields();
                    
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('formEditor').classList.remove('hidden');
                } else {
                    alert('í¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    window.location.href = '/tools/form-manager';
                }
            } catch (err) {
                console.error('Load error:', err);
                alert('í¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                window.location.href = '/tools/form-manager';
            }
        }

        function renderFields() {
            const container = document.getElementById('fieldsList');
            const emptyState = document.getElementById('emptyFields');
            
            if (fields.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            const html = fields.map((field, index) => \`
                <div class="flex items-center gap-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">í•­ëª©ëª…</label>
                            <input type="text" value="\${field.label}" onchange="updateField(\${index}, 'label', this.value)"
                                placeholder="ì˜ˆ: í•™ë…„" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">ì…ë ¥ íƒ€ì…</label>
                            <select onchange="updateField(\${index}, 'type', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="text" \${field.type === 'text' ? 'selected' : ''}>í…ìŠ¤íŠ¸</option>
                                <option value="select" \${field.type === 'select' ? 'selected' : ''}>ì„ íƒ (ë“œë¡­ë‹¤ìš´)</option>
                                <option value="textarea" \${field.type === 'textarea' ? 'selected' : ''}>ì¥ë¬¸ í…ìŠ¤íŠ¸</option>
                                <option value="number" \${field.type === 'number' ? 'selected' : ''}>ìˆ«ì</option>
                                <option value="date" \${field.type === 'date' ? 'selected' : ''}>ë‚ ì§œ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">
                                í•„ìˆ˜ ì—¬ë¶€
                                <input type="checkbox" \${field.required ? 'checked' : ''} onchange="updateField(\${index}, 'required', this.checked)"
                                    class="ml-2">
                            </label>
                            <input type="text" value="\${field.placeholder || ''}" onchange="updateField(\${index}, 'placeholder', this.value)"
                                placeholder="ì…ë ¥ íŒíŠ¸ (ì„ íƒì‚¬í•­)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mt-1">
                        </div>
                    </div>
                    <button onclick="removeField(\${index})" class="px-3 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 flex-shrink-0">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                \${field.type === 'select' ? \`
                    <div class="ml-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <label class="block text-xs font-medium text-gray-700 mb-2">ì„ íƒ ì˜µì…˜ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
                        <input type="text" value="\${(field.options || []).join(', ')}" 
                            onchange="updateField(\${index}, 'options', this.value.split(',').map(o => o.trim()).filter(o => o))"
                            placeholder="ì˜ˆ: ì´ˆë“± 1í•™ë…„, ì´ˆë“± 2í•™ë…„, ì´ˆë“± 3í•™ë…„"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                \` : ''}
            \`).join('');
            
            container.innerHTML = html;
        }

        function addField() {
            fields.push({
                label: '',
                type: 'text',
                required: false,
                placeholder: ''
            });
            renderFields();
        }

        function updateField(index, key, value) {
            fields[index][key] = value;
        }

        function removeField(index) {
            if (confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                fields.splice(index, 1);
                renderFields();
            }
        }

        async function saveForm() {
            const name = document.getElementById('formName').value.trim();
            const description = document.getElementById('formDescription').value.trim();
            const termsText = document.getElementById('termsText').value.trim();
            const successMessage = document.getElementById('successMessage').value.trim();
            
            if (!name) {
                alert('í¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            // í•„ë“œ ìœ íš¨ì„± ê²€ì‚¬
            for (let i = 0; i < fields.length; i++) {
                if (!fields[i].label || !fields[i].label.trim()) {
                    alert(\`\${i + 1}ë²ˆì§¸ í•­ëª©ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.\`);
                    return;
                }
            }
            
            try {
                const response = await fetch(\`/api/forms/\${formId}\`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        description,
                        fields,
                        termsText,
                        successMessage,
                        customHtml: formData.custom_html || '',
                        headerScript: formData.header_script || '',
                        pixelScript: formData.pixel_script || ''
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… í¼ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    window.location.href = '/tools/form-manager';
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (err) {
                console.error('Save error:', err);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }

        function cancelEdit() {
            if (confirm('ìˆ˜ì •ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì €ì¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
                window.location.href = '/tools/form-manager';
            }
        }
        </script>
    </body>
    </html>
  `)
})


// ëœë”©í˜ì´ì§€ ìˆ˜ì • í˜ì´ì§€
app.get('/tools/landing-editor/:slug', async (c) => {
  const slug = c.req.param('slug')
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ëœë”©í˜ì´ì§€ ìˆ˜ì • - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    </head>
    <body class="bg-gray-50">
        <nav class="fixed w-full top-0 z-50 bg-white border-b">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <span class="text-xl font-bold">ëœë”©í˜ì´ì§€ ìˆ˜ì •</span>
                    <div class="flex gap-4">
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <button onclick="logout()" class="text-gray-600 hover:text-red-600">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-6xl mx-auto">
                <div id="loading" class="text-center py-12">
                    <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
                    <p>ë¡œë”©ì¤‘...</p>
                </div>

                <div id="editor" class="hidden">
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold mb-2">ğŸ“ ëœë”©í˜ì´ì§€ ìˆ˜ì •</h1>
                        <p class="text-gray-600">HTMLê³¼ í”½ì…€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”</p>
                    </div>

                    <!-- í”½ì…€ ìŠ¤í¬ë¦½íŠ¸ ì„¹ì…˜ -->
                    <div class="bg-white rounded-xl p-8 border shadow-sm mb-6">
                        <h2 class="text-xl font-bold mb-6">ğŸ¯ í”½ì…€ ìŠ¤í¬ë¦½íŠ¸</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block font-semibold mb-2">í—¤ë” í”½ì…€ (Meta Pixel, Google Analytics ë“±)</label>
                                <p class="text-sm text-gray-600 mb-3">&lt;head&gt; íƒœê·¸ ì•ˆì— ì‚½ì…ë©ë‹ˆë‹¤. í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ë©ë‹ˆë‹¤.</p>
                                <textarea id="headerPixel" rows="6" placeholder="<script>
  // Meta Pixel
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', 'YOUR_PIXEL_ID');
  fbq('track', 'PageView');
</script>" class="w-full px-4 py-3 border rounded-xl font-mono text-sm"></textarea>
                            </div>

                            <div>
                                <label class="block font-semibold mb-2">ë³¸ë¬¸ í”½ì…€ (noscript, ì¶”ê°€ ì´ë¯¸ì§€ íƒœê·¸ ë“±)</label>
                                <p class="text-sm text-gray-600 mb-3">&lt;body&gt; íƒœê·¸ ì§í›„ì— ì‚½ì…ë©ë‹ˆë‹¤.</p>
                                <textarea id="bodyPixel" rows="4" placeholder="<noscript><img height='1' width='1' style='display:none' src='https://www.facebook.com/tr?id=YOUR_PIXEL_ID&ev=PageView&noscript=1'/></noscript>" class="w-full px-4 py-3 border rounded-xl font-mono text-sm"></textarea>
                            </div>

                            <div>
                                <label class="block font-semibold mb-2">ì „í™˜ í”½ì…€ (í¼ ì œì¶œ ì„±ê³µ ì‹œ ì‹¤í–‰)</label>
                                <p class="text-sm text-gray-600 mb-3">í¼ ì œì¶œ ì„±ê³µ ì‹œ ì‹¤í–‰ë©ë‹ˆë‹¤. JavaScript ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
                                <textarea id="conversionPixel" rows="6" placeholder="// Meta Pixel ì „í™˜ ì¶”ì 
fbq('track', 'Lead');

// Google Ads ì „í™˜ ì¶”ì 
gtag('event', 'conversion', {
    'send_to': 'AW-CONVERSION_ID/CONVERSION_LABEL'
});

// TikTok Pixel ì „í™˜ ì¶”ì 
ttq.track('SubmitForm');" class="w-full px-4 py-3 border rounded-xl font-mono text-sm"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- HTML í¸ì§‘ (ì„ íƒì‚¬í•­) -->
                    <div class="bg-white rounded-xl p-8 border shadow-sm mb-6">
                        <h2 class="text-xl font-bold mb-6">ğŸ“„ HTML í¸ì§‘ (ì„ íƒì‚¬í•­)</h2>
                        <textarea id="htmlContent" rows="15" class="w-full px-4 py-3 border rounded-xl font-mono text-sm"></textarea>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="savePage()" class="flex-1 px-6 py-4 bg-purple-600 text-white rounded-xl hover:bg-purple-700 font-semibold text-lg">
                            <i class="fas fa-save mr-2"></i>ì €ì¥í•˜ê¸°
                        </button>
                        <a href="/dashboard" class="px-6 py-4 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 font-semibold text-lg">
                            ì·¨ì†Œ
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <script>
        let user = null;
        const slug = '${slug}';

        const userData = localStorage.getItem('user');
        if (!userData) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
        } else {
            user = JSON.parse(userData);
            loadPage();
        }

        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('loginTime');
            window.location.href = '/';
        }

        async function loadPage() {
            try {
                const response = await fetch(\`/api/landing/\${slug}\`);
                const result = await response.json();
                
                if (result.success && result.page) {
                    document.getElementById('htmlContent').value = result.page.html_content || '';
                    document.getElementById('headerPixel').value = result.page.header_pixel || '';
                    document.getElementById('bodyPixel').value = result.page.body_pixel || '';
                    document.getElementById('conversionPixel').value = result.page.conversion_pixel || '';
                    
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('editor').classList.remove('hidden');
                } else {
                    alert('ëœë”©í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    window.location.href = '/dashboard';
                }
            } catch (err) {
                console.error('Load error:', err);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                window.location.href = '/dashboard';
            }
        }

        async function savePage() {
            const htmlContent = document.getElementById('htmlContent').value;
            const headerPixel = document.getElementById('headerPixel').value;
            const bodyPixel = document.getElementById('bodyPixel').value;
            const conversionPixel = document.getElementById('conversionPixel').value;
            
            try {
                const response = await fetch(\`/api/landing/\${slug}/edit\`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        html_content: htmlContent,
                        header_pixel: headerPixel,
                        body_pixel: bodyPixel,
                        conversion_pixel: conversionPixel
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('âœ… ëœë”©í˜ì´ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\ní”½ì…€ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
                    window.open(\`/landing/\${slug}\`, '_blank');
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (err) {
                console.error('Save error:', err);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }
        </script>
    </body>
    </html>
  `)
})

// í´ë” ê´€ë¦¬ í˜ì´ì§€
app.get('/tools/landing-folders', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í´ë” ê´€ë¦¬ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <span class="text-xl font-bold text-gray-900">ğŸ“ í´ë” ê´€ë¦¬</span>
                    <div class="flex gap-4">
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="/tools/landing-builder" class="text-gray-600 hover:text-purple-600">ìƒˆë¡œ ë§Œë“¤ê¸°</a>
                        <a href="/tools/landing-manager" class="text-gray-600 hover:text-purple-600">ë‚´ ëœë”©í˜ì´ì§€</a>
                        <button onclick="logout()" class="text-gray-600 hover:text-red-600">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-6xl mx-auto">
                <div class="mb-8 flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ—‚ï¸ í´ë” ê´€ë¦¬</h1>
                        <p class="text-gray-600">ëœë”©í˜ì´ì§€ë¥¼ í´ë”ë³„ë¡œ ì •ë¦¬í•˜ì„¸ìš”</p>
                    </div>
                    <button onclick="openNewFolderModal()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl hover:from-purple-700 hover:to-blue-700 font-medium shadow-lg hover:shadow-xl transition-all duration-200">
                        + ìƒˆ í´ë” ë§Œë“¤ê¸°
                    </button>
                </div>

                <!-- í†µê³„ ì¹´ë“œ -->
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ì „ì²´ í´ë”</p>
                                <p class="text-3xl font-bold text-gray-900"><span id="totalFolders">-</span></p>
                            </div>
                            <div class="w-14 h-14 bg-purple-100 rounded-xl flex items-center justify-center">
                                <span class="text-3xl">ğŸ“</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ì „ì²´ í˜ì´ì§€</p>
                                <p class="text-3xl font-bold text-gray-900"><span id="totalPages">-</span></p>
                            </div>
                            <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                                <span class="text-3xl">ğŸ“„</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ì´ ì¡°íšŒìˆ˜</p>
                                <p class="text-3xl font-bold text-gray-900"><span id="totalViews">-</span></p>
                            </div>
                            <div class="w-14 h-14 bg-green-100 rounded-xl flex items-center justify-center">
                                <span class="text-3xl">ğŸ‘ï¸</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ë¯¸ë¶„ë¥˜ í˜ì´ì§€</p>
                                <p class="text-3xl font-bold text-gray-900"><span id="uncategorizedPages">-</span></p>
                            </div>
                            <div class="w-14 h-14 bg-gray-100 rounded-xl flex items-center justify-center">
                                <span class="text-3xl">ğŸ“‹</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- í´ë” ëª©ë¡ -->
                <div class="bg-white rounded-xl border border-gray-200 p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">í´ë” ëª©ë¡</h2>
                    <div id="foldersList" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">ë¡œë”©ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìƒˆ í´ë” ë§Œë“¤ê¸° ëª¨ë‹¬ -->
        <div id="newFolderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ìƒˆ í´ë” ë§Œë“¤ê¸°</h2>
                <input type="text" id="newFolderName" placeholder="í´ë” ì´ë¦„ ì…ë ¥ (ì˜ˆ: í•™ë¶€ëª¨ìš©, ì‹ ê·œìƒìš©)" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <textarea id="newFolderDescription" placeholder="í´ë” ì„¤ëª… (ì„ íƒì‚¬í•­)" 
                          class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-6 resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" rows="3"></textarea>
                <div class="flex gap-3">
                    <button onclick="closeNewFolderModal()" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors">
                        ì·¨ì†Œ
                    </button>
                    <button onclick="createNewFolder()" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl hover:from-purple-700 hover:to-blue-700 transition-all shadow-md hover:shadow-lg">
                        ìƒì„±
                    </button>
                </div>
            </div>
        </div>

        <!-- í´ë” ìˆ˜ì • ëª¨ë‹¬ -->
        <div id="editFolderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">í´ë” ìˆ˜ì •</h2>
                <input type="hidden" id="editFolderId">
                <input type="text" id="editFolderName" placeholder="í´ë” ì´ë¦„" 
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                <textarea id="editFolderDescription" placeholder="í´ë” ì„¤ëª…" 
                          class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-6 resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent" rows="3"></textarea>
                <div class="flex gap-3">
                    <button onclick="closeEditFolderModal()" class="flex-1 px-4 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors">
                        ì·¨ì†Œ
                    </button>
                    <button onclick="updateFolder()" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl hover:from-purple-700 hover:to-blue-700 transition-all shadow-md hover:shadow-lg">
                        ìˆ˜ì •
                    </button>
                </div>
            </div>
        </div>

        <script>
        let user = null;
        let allFolders = [];
        let allPages = [];

        // ë¡œê·¸ì¸ í™•ì¸
        const userData = localStorage.getItem('user');
        if (!userData) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
        } else {
            user = JSON.parse(userData);
            loadData();
        }

        async function loadData() {
            await loadFolders();
            await loadPages();
            updateStats();
            renderFolders();
        }

        async function loadFolders() {
            try {
                const response = await fetch('/api/landing/folders?userId=' + user.id);
                const result = await response.json();
                
                if (result.success) {
                    allFolders = result.folders || [];
                } else {
                    allFolders = [];
                }
            } catch (err) {
                console.error('Failed to load folders:', err);
                allFolders = [];
            }
        }

        async function loadPages() {
            try {
                const response = await fetch('/api/landing/my-pages?userId=' + user.id);
                const result = await response.json();
                
                if (result.success) {
                    allPages = result.pages || [];
                } else {
                    allPages = [];
                }
            } catch (err) {
                console.error('Failed to load pages:', err);
                allPages = [];
            }
        }

        function updateStats() {
            document.getElementById('totalFolders').textContent = allFolders.length;
            document.getElementById('totalPages').textContent = allPages.length;
            
            // ì´ ì¡°íšŒìˆ˜ ê³„ì‚°
            const totalViews = allPages.reduce((sum, page) => sum + (page.view_count || 0), 0);
            document.getElementById('totalViews').textContent = totalViews.toLocaleString();
            
            // ë¯¸ë¶„ë¥˜ í˜ì´ì§€
            const uncategorized = allPages.filter(p => !p.folder_id).length;
            document.getElementById('uncategorizedPages').textContent = uncategorized;
        }

        function renderFolders() {
            const container = document.getElementById('foldersList');
            
            if (allFolders.length === 0) {
                container.innerHTML = 
                    '<div class="text-center py-12">' +
                        '<div class="text-6xl mb-4">ğŸ“</div>' +
                        '<p class="text-gray-600 mb-4">ì•„ì§ ìƒì„±ëœ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤</p>' +
                        '<button onclick="openNewFolderModal()" class="px-6 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-colors">' +
                            'ì²« í´ë” ë§Œë“¤ê¸°' +
                        '</button>' +
                    '</div>';
                return;
            }

            const foldersHtml = allFolders.map(folder => {
                const pagesInFolder = allPages.filter(p => p.folder_id === folder.id).length;
                const viewsInFolder = allPages.filter(p => p.folder_id === folder.id).reduce((sum, page) => sum + (page.view_count || 0), 0);
                const lastUpdated = folder.updated_at ? new Date(folder.updated_at).toLocaleDateString('ko-KR') : '-';
                
                return \`
                    <div class="border border-gray-200 rounded-xl p-6 hover:shadow-lg transition-all duration-200 bg-gradient-to-br from-white to-gray-50">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-blue-500 rounded-xl flex items-center justify-center shadow-md">
                                    <span class="text-2xl">ğŸ“</span>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">\${folder.name}</h3>
                                    \${folder.description ? '<p class="text-sm text-gray-600 mt-1">' + folder.description + '</p>' : ''}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openEditFolderModal(\${folder.id}, '\${folder.name}', '\${folder.description || ''}')" 
                                        class="px-3 py-2 text-sm bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors">
                                    âœï¸ ìˆ˜ì •
                                </button>
                                <button onclick="deleteFolder(\${folder.id})" 
                                        class="px-3 py-2 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
                                    ğŸ—‘ï¸ ì‚­ì œ
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-4 pt-4 border-t border-gray-200">
                            <div class="text-center">
                                <p class="text-sm text-gray-600">í˜ì´ì§€</p>
                                <p class="text-2xl font-bold text-purple-600">\${pagesInFolder}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-600">ì¡°íšŒìˆ˜</p>
                                <p class="text-2xl font-bold text-green-600">\${viewsInFolder.toLocaleString()}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-600">ìƒì„±ì¼</p>
                                <p class="text-sm font-medium text-gray-900">\${new Date(folder.created_at).toLocaleDateString('ko-KR')}</p>
                            </div>
                            <div class="text-center">
                                <p class="text-sm text-gray-600">ìµœì¢… ìˆ˜ì •</p>
                                <p class="text-sm font-medium text-gray-900">\${lastUpdated}</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <a href="/tools/landing-manager" class="block text-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                ğŸ“„ í´ë” ë‚´ í˜ì´ì§€ ë³´ê¸°
                            </a>
                        </div>
                    </div>
                \`;
            }).join('');

            container.innerHTML = foldersHtml;
        }

        // ìƒˆ í´ë” ë§Œë“¤ê¸° ëª¨ë‹¬
        function openNewFolderModal() {
            document.getElementById('newFolderName').value = '';
            document.getElementById('newFolderDescription').value = '';
            document.getElementById('newFolderModal').classList.remove('hidden');
        }

        function closeNewFolderModal() {
            document.getElementById('newFolderModal').classList.add('hidden');
        }

        async function createNewFolder() {
            const name = document.getElementById('newFolderName').value.trim();
            const description = document.getElementById('newFolderDescription').value.trim();
            
            if (!name) {
                alert('í´ë” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/landing/folders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: user.id, 
                        name,
                        description: description || null
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('í´ë”ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closeNewFolderModal();
                    loadData();
                } else {
                    alert('í´ë” ìƒì„± ì‹¤íŒ¨: ' + result.error);
                }
            } catch (err) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }

        // í´ë” ìˆ˜ì • ëª¨ë‹¬
        function openEditFolderModal(id, name, description) {
            document.getElementById('editFolderId').value = id;
            document.getElementById('editFolderName').value = name;
            document.getElementById('editFolderDescription').value = description;
            document.getElementById('editFolderModal').classList.remove('hidden');
        }

        function closeEditFolderModal() {
            document.getElementById('editFolderModal').classList.add('hidden');
        }

        async function updateFolder() {
            const id = document.getElementById('editFolderId').value;
            const name = document.getElementById('editFolderName').value.trim();
            const description = document.getElementById('editFolderDescription').value.trim();
            
            if (!name) {
                alert('í´ë” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch('/api/landing/folders/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description: description || null })
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('í´ë”ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closeEditFolderModal();
                    loadData();
                } else {
                    alert('í´ë” ìˆ˜ì • ì‹¤íŒ¨: ' + result.error);
                }
            } catch (err) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }

        async function deleteFolder(id) {
            const folder = allFolders.find(f => f.id === id);
            const pagesInFolder = allPages.filter(p => p.folder_id === id).length;
            
            if (pagesInFolder > 0) {
                if (!confirm(\`ì´ í´ë”ì—ëŠ” \${pagesInFolder}ê°œì˜ í˜ì´ì§€ê°€ ìˆìŠµë‹ˆë‹¤.\\ní´ë”ë¥¼ ì‚­ì œí•˜ë©´ í˜ì´ì§€ë“¤ì€ ë¯¸ë¶„ë¥˜ ìƒíƒœê°€ ë©ë‹ˆë‹¤.\\nì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) {
                    return;
                }
            } else {
                if (!confirm('í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }
            }

            try {
                const response = await fetch('/api/landing/folders/' + id + '?userId=' + user.id, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('í´ë”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadData();
                } else {
                    alert('í´ë” ì‚­ì œ ì‹¤íŒ¨: ' + result.error);
                }
            } catch (err) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }

        function logout() {
            localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
            window.location.href = '/';
        }
        </script>
    </body>
    </html>
  `)
})

// ê³„ì¢Œì´ì²´ ì‹ ì²­ í˜ì´ì§€
app.get('/payment/bank-transfer', (c) => {
  const planName = c.req.query('plan') || ''
  const amount = c.req.query('amount') || '0'
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê³„ì¢Œì´ì²´ ì‹ ì²­ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', sans-serif; }
        </style>
    </head>
    <body class="bg-gradient-to-br from-blue-50 via-white to-purple-50">
        <nav class="fixed w-full top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center">
                <a href="/" class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</a>
                <div class="flex gap-6">
                    <a href="/pricing" class="text-gray-600 hover:text-purple-600">â† ìš”ê¸ˆì œ</a>
                    <a href="/dashboard" class="px-6 py-2.5 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-full hover:shadow-lg transition">ëŒ€ì‹œë³´ë“œ</a>
                </div>
            </div>
        </nav>

        <div class="pt-32 pb-24 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="text-center mb-12">
                    <h1 class="text-4xl font-bold text-gray-900 mb-4">ğŸ’° ê³„ì¢Œì´ì²´ ì‹ ì²­</h1>
                    <p class="text-lg text-gray-600">ì•„ë˜ ê³„ì¢Œë¡œ ì…ê¸ˆ í›„ ì‹ ì²­ì„œë¥¼ ì œì¶œí•´ì£¼ì„¸ìš”</p>
                </div>

                <div class="grid md:grid-cols-2 gap-8 mb-12">
                    <!-- ê³„ì¢Œ ì •ë³´ -->
                    <div class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl p-8 text-white shadow-2xl">
                        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                            </svg>
                            ì…ê¸ˆ ê³„ì¢Œ
                        </h2>
                        <div class="space-y-4">
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                <p class="text-sm text-blue-100 mb-1">ì€í–‰</p>
                                <p class="text-2xl font-bold">í•˜ë‚˜ì€í–‰</p>
                            </div>
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                <p class="text-sm text-blue-100 mb-1">ê³„ì¢Œë²ˆí˜¸</p>
                                <p class="text-2xl font-bold font-mono">746-910023-17004</p>
                                <button onclick="copyAccount()" class="mt-2 text-sm bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
                                    ğŸ“‹ ê³„ì¢Œë²ˆí˜¸ ë³µì‚¬
                                </button>
                            </div>
                            <div class="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                                <p class="text-sm text-blue-100 mb-1">ì˜ˆê¸ˆì£¼</p>
                                <p class="text-lg font-bold">ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ”ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</p>
                            </div>
                        </div>
                    </div>

                    <!-- ì‹ ì²­ ì •ë³´ -->
                    <div class="bg-white rounded-2xl p-8 border-2 border-gray-200 shadow-lg">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ì‹ ì²­ ì •ë³´</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì„ íƒ í”Œëœ</label>
                                <input type="text" id="planName" readonly 
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl font-bold text-purple-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ê²°ì œ ê¸ˆì•¡</label>
                                <input type="text" id="amount" readonly 
                                       class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-xl font-bold text-2xl text-gray-900">
                            </div>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                                <p class="text-sm text-yellow-800">
                                    <strong>ğŸ’¡ ì•ˆë‚´ì‚¬í•­</strong><br>
                                    ì…ê¸ˆìëª…ì„ ì‹ ì²­ì„œì˜ ì´ë¦„ê³¼ ë™ì¼í•˜ê²Œ ì…ê¸ˆí•´ì£¼ì„¸ìš”
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ì‹ ì²­ì„œ ì‘ì„± -->
                <div class="bg-white rounded-2xl p-8 border-2 border-gray-200 shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">ì‹ ì²­ì„œ ì‘ì„±</h2>
                    <form id="transferForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì´ë¦„ (ì…ê¸ˆìëª…) *</label>
                            <input type="text" id="userName" required
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="í™ê¸¸ë™">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì´ë©”ì¼ *</label>
                            <input type="email" id="userEmail" required
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="email@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì—°ë½ì²˜ *</label>
                            <input type="tel" id="userPhone" required
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="010-1234-5678">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì…ê¸ˆ ì˜ˆì •ì¼ *</label>
                            <input type="date" id="depositDate" required
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ë©”ëª¨ (ì„ íƒ)</label>
                            <textarea id="note" rows="3"
                                      class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                                      placeholder="ì¶”ê°€ ìš”ì²­ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                        </div>
                        <div class="flex items-start gap-3 p-4 bg-blue-50 rounded-xl">
                            <input type="checkbox" id="agreeTerms" required class="w-5 h-5 mt-1">
                            <label for="agreeTerms" class="text-sm text-gray-700">
                                ì…ê¸ˆ ì •ë³´ì™€ ì‹ ì²­ ë‚´ìš©ì´ ì •í™•í•¨ì„ í™•ì¸í•˜ì˜€ìœ¼ë©°, ì…ê¸ˆ í›„ ìŠ¹ì¸ê¹Œì§€ ì˜ì—…ì¼ ê¸°ì¤€ 1-2ì¼ ì†Œìš”ë  ìˆ˜ ìˆìŒì„ ë™ì˜í•©ë‹ˆë‹¤.
                            </label>
                        </div>
                        <button type="submit" 
                                class="w-full py-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold text-lg hover:shadow-2xl hover:from-blue-700 hover:to-purple-700 transition-all">
                            ğŸ’° ê³„ì¢Œì´ì²´ ì‹ ì²­í•˜ê¸°
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <script>
        const urlParams = new URLSearchParams(window.location.search)
        const planName = urlParams.get('plan') || 'í”Œëœ'
        const amount = parseInt(urlParams.get('amount') || '0')
        
        document.getElementById('planName').value = planName
        document.getElementById('amount').value = 'â‚©' + amount.toLocaleString()

        // ì‚¬ìš©ì ì •ë³´ ìë™ ì…ë ¥
        const user = JSON.parse(localStorage.getItem('user') || 'null')
        if (user) {
            if (user.name) document.getElementById('userName').value = user.name
            if (user.email) document.getElementById('userEmail').value = user.email
            if (user.phone) document.getElementById('userPhone').value = user.phone
        }

        // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
        const today = new Date().toISOString().split('T')[0]
        document.getElementById('depositDate').value = today
        document.getElementById('depositDate').min = today

        function copyAccount() {
            navigator.clipboard.writeText('746-910023-17004').then(() => {
                alert('âœ… ê³„ì¢Œë²ˆí˜¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!')
            }).catch(err => {
                alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err)
            })
        }

        document.getElementById('transferForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            if (!user || !user.id) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.')
                window.location.href = '/login'
                return
            }

            const userName = document.getElementById('userName').value
            const userEmail = document.getElementById('userEmail').value
            const userPhone = document.getElementById('userPhone').value
            const depositDate = document.getElementById('depositDate').value
            const note = document.getElementById('note').value

            try {
                const response = await fetch('/api/bank-transfer/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: user.id,
                        userName,
                        userEmail,
                        userPhone,
                        planName,
                        amount,
                        note: note + ' (ì…ê¸ˆì˜ˆì •ì¼: ' + depositDate + ')'
                    })
                })

                const result = await response.json()
                
                if (result.success) {
                    alert('âœ… ê³„ì¢Œì´ì²´ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ì„œë¹„ìŠ¤ê°€ í™œì„±í™”ë©ë‹ˆë‹¤.\\nìŠ¹ì¸ê¹Œì§€ ì˜ì—…ì¼ ê¸°ì¤€ 1-2ì¼ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
                    window.location.href = '/dashboard'
                } else {
                    alert('âŒ ì‹ ì²­ ì‹¤íŒ¨: ' + result.error)
                }
            } catch (err) {
                alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message)
            }
        })
        </script>
    </body>
    </html>
  `)
})

// íšŒì‚¬ ì†Œê°œ í˜ì´ì§€
app.get('/about', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>íšŒì‚¬ ì†Œê°œ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
        </style>
    </head>
    <body class="bg-white">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <div class="hidden md:flex items-center space-x-10">
                        <a href="/" class="text-gray-700 hover:text-purple-600 font-medium">í™ˆ</a>
                        <a href="/programs" class="text-gray-700 hover:text-purple-600 font-medium">êµìœ¡ í”„ë¡œê·¸ë¨</a>
                        <a href="/success" class="text-gray-700 hover:text-purple-600 font-medium">ì„±ê³µ ì‚¬ë¡€</a>
                        <a href="/about" class="text-purple-600 font-medium">íšŒì‚¬ ì†Œê°œ</a>
                        <a href="/contact" class="text-gray-700 hover:text-purple-600 font-medium">ë¬¸ì˜í•˜ê¸°</a>
                        <a href="/login" class="gradient-purple text-white px-6 py-2.5 rounded-full font-medium">ë¡œê·¸ì¸</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="pt-32 pb-20 px-6 bg-gradient-to-br from-purple-50 to-white">
            <div class="max-w-7xl mx-auto text-center">
                <h1 class="text-5xl lg:text-6xl font-bold text-gray-900 mb-6">
                    ìš°ë¦¬ëŠ”<br>
                    <span class="text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                </h1>
                <p class="text-xl lg:text-2xl text-gray-600 max-w-3xl mx-auto leading-relaxed">
                    í˜„ì—… í•™ì›ì¥ì´ ì§ì ‘ ìš´ì˜í•˜ë©°<br>
                    ì „êµ­ 500ê°œ í•™ì›ì˜ ì„±ê³µì„ í•¨ê»˜í•œ<br>
                    <span class="font-bold text-gray-900">í•™ì› ë§ˆì¼€íŒ… ì „ë¬¸ êµìœ¡ ê¸°ì—…</span>ì…ë‹ˆë‹¤
                </p>
            </div>
        </section>

        <!-- Story Section -->
        <section class="py-20 px-6">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-4">ìš°ë¦¬ì˜ ì‹œì‘</h2>
                    <div class="w-24 h-1 bg-gradient-to-r from-purple-600 to-orange-500 mx-auto"></div>
                </div>

                <!-- CEO Profile and Story -->
                <div class="grid lg:grid-cols-[400px_1fr] gap-12 items-start mb-20">
                    <!-- Left: CEO Photo -->
                    <div class="flex justify-center lg:justify-start">
                        <div class="relative">
                            <img src="/static/images/ceo-profile.jpg" 
                                 alt="ê³ í¬ì¤€ ëŒ€í‘œì´ì‚¬" 
                                 class="w-full max-w-sm rounded-3xl shadow-2xl object-cover">
                            <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 bg-white px-8 py-4 rounded-full shadow-xl border-2 border-purple-200">
                                <p class="font-bold text-gray-900 text-lg whitespace-nowrap">ê³ í¬ì¤€ ëŒ€í‘œì´ì‚¬</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Story Content -->
                    <div class="space-y-8 pt-8">
                        <div class="fade-in-up" style="animation-delay: 0.2s">
                            <p class="text-xl text-gray-700 leading-relaxed">
                                <strong class="text-purple-600 text-2xl">ì¸ì²œ ì„œêµ¬ì—ì„œ ê³µë¶€ë°©ì„ ìš´ì˜í•˜ë˜ ì €í¬</strong>ëŠ” 
                                ì²˜ìŒì— í•™ìƒ ëª¨ì§‘ì— í° ì–´ë ¤ì›€ì„ ê²ªì—ˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>

                        <div class="fade-in-up" style="animation-delay: 0.4s">
                            <p class="text-xl text-gray-700 leading-relaxed">
                                í•˜ì§€ë§Œ <strong class="text-orange-500">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìµœì í™”, ë¸”ë¡œê·¸ ë§ˆì¼€íŒ…, í¼ë„ ì‹œìŠ¤í…œ</strong>ì„ 
                                ì§ì ‘ ê³µë¶€í•˜ê³  ì ìš©í•˜ë©´ì„œ ë†€ë¼ìš´ ë³€í™”ë¥¼ ê²½í—˜í–ˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>

                        <div class="fade-in-up bg-gradient-to-r from-purple-50 to-orange-50 rounded-2xl p-8" style="animation-delay: 0.6s">
                            <div class="grid sm:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-5xl font-bold text-purple-600 mb-2">2ë°°</p>
                                    <p class="text-lg font-semibold text-gray-900">ì‹ ê·œ ë¬¸ì˜ ì¦ê°€</p>
                                    <p class="text-gray-600">3ê°œì›” ë§Œì— ë‹¬ì„±</p>
                                </div>
                                <div>
                                    <p class="text-5xl font-bold text-orange-500 mb-2">3ë°°</p>
                                    <p class="text-lg font-semibold text-gray-900">í•™ì› ê·œëª¨ ì„±ì¥</p>
                                    <p class="text-gray-600">ëª‡ ë…„ ë§Œì— ë‹¬ì„±</p>
                                </div>
                            </div>
                        </div>

                        <div class="fade-in-up" style="animation-delay: 0.8s">
                            <p class="text-xl text-gray-700 leading-relaxed">
                                í•˜ì§€ë§Œ í•™ì›ìƒì´ ë“±ë¡í•˜ëŠ” ë§Œí¼ <strong class="text-red-600">ì´íƒˆ í•™ì›ìƒë„ ë§ì•˜ìŠµë‹ˆë‹¤.</strong>
                            </p>
                        </div>

                        <div class="fade-in-up" style="animation-delay: 1s">
                            <p class="text-xl text-gray-700 leading-relaxed">
                                ê·¸ë˜ì„œ ì €í¬ëŠ” <strong class="text-purple-600">í•™ì›ìƒ ëª¨ì§‘ë¶€í„° ì›ìƒ ê´€ë¦¬, í•™ë¶€ëª¨ ê´€ë¦¬ê¹Œì§€ 
                                ëª¨ë‘ ìë™í™”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” í”„ë¡œê·¸ë¨, ì‹œìŠ¤í…œì„ ì™„ë²½íˆ êµ¬ì¶•</strong>í•˜ì˜€ìŠµë‹ˆë‹¤.
                            </p>
                        </div>

                        <div class="fade-in-up bg-cyan-50 rounded-2xl p-8 border-2 border-cyan-200" style="animation-delay: 1.2s">
                            <h4 class="font-bold text-gray-900 text-2xl mb-4 flex items-center gap-3">
                                <svg class="w-8 h-8 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                </svg>
                                AI ê¸°ë°˜ í•™ìƒ ë¶„ì„ ì‹œìŠ¤í…œ
                            </h4>
                            <p class="text-lg text-gray-700 leading-relaxed mb-3">
                                ì•„ì´ë“¤ì´ ìˆ™ì œí•˜ë©´ì„œ AIì™€ ëŒ€í™”ë¥¼ í•˜ë©° ë‚˜ëˆˆ ëª¨ë“  ë°ì´í„°ë¥¼ ì‹¬ë¦¬ ë¶„ì„í•˜ì—¬ 
                                ì•„ì´ë“¤ì˜ <strong class="text-cyan-700">ì°¸ì—¬ë„, ì´í•´ë„ ë“±ì„ ëª¨ë‘ ë¶„ì„</strong>í•©ë‹ˆë‹¤.
                            </p>
                            <p class="text-lg text-gray-700 leading-relaxed">
                                í•™ìƒ ì´ë¦„ë§Œ ì„ íƒí•˜ë©´ <strong class="text-purple-600">ëœë”©í˜ì´ì§€ë¡œ ìë™ ì œì‘</strong>ë˜ì–´ í•™ë¶€ëª¨ì—ê²Œ ì „ë‹¬ë©ë‹ˆë‹¤.
                            </p>
                        </div>

                        <div class="fade-in-up bg-gradient-to-r from-purple-600 to-purple-800 rounded-2xl p-8 text-white" style="animation-delay: 1.4s">
                            <p class="text-3xl font-bold mb-4">
                                "ì´ ë…¸í•˜ìš°ë¥¼ ë‹¤ë¥¸ í•™ì›ì¥ë‹˜ë“¤ê³¼ ë‚˜ëˆ„ê³  ì‹¶ë‹¤"
                            </p>
                            <p class="text-2xl">
                                ê·¸ë ‡ê²Œ <strong class="text-orange-300">'ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤'</strong>ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Timeline with Animation -->
                <div class="mt-20">
                    <h3 class="text-4xl font-bold text-gray-900 text-center mb-16">ì„±ì¥ ìŠ¤í† ë¦¬</h3>
                    <div class="grid md:grid-cols-4 gap-8 max-w-6xl mx-auto">
                        <div class="timeline-item text-center" style="animation-delay: 0.2s">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center mx-auto mb-6 shadow-xl">
                                <span class="text-4xl font-bold text-white">1</span>
                            </div>
                            <h4 class="text-2xl font-bold text-gray-900 mb-3">2015ë…„</h4>
                            <p class="text-gray-600 leading-relaxed">ê¾¸ë©”ë•…í•™ì› ê°œì›<br>í•™ìƒ ëª¨ì§‘ ì–´ë ¤ì›€</p>
                        </div>
                        <div class="timeline-item text-center" style="animation-delay: 0.4s">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center mx-auto mb-6 shadow-xl">
                                <span class="text-4xl font-bold text-white">2</span>
                            </div>
                            <h4 class="text-2xl font-bold text-gray-900 mb-3">2020ë…„</h4>
                            <p class="text-gray-600 leading-relaxed">í”Œë ˆì´ìŠ¤ ë§ˆì¼€íŒ… ë…í•™<br>ì§€ì—­ 1ìœ„ ë‹¬ì„±</p>
                        </div>
                        <div class="timeline-item text-center" style="animation-delay: 0.6s">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center mx-auto mb-6 shadow-xl">
                                <span class="text-4xl font-bold text-white">3</span>
                            </div>
                            <h4 class="text-2xl font-bold text-gray-900 mb-3">2021ë…„</h4>
                            <p class="text-gray-600 leading-relaxed">ì˜¤í”ˆì±„íŒ…ë°© ì‹œì‘<br>ë…¸í•˜ìš° ê³µìœ </p>
                        </div>
                        <div class="timeline-item text-center" style="animation-delay: 0.8s">
                            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center mx-auto mb-6 shadow-xl">
                                <span class="text-4xl font-bold text-white">4</span>
                            </div>
                            <h4 class="text-2xl font-bold text-gray-900 mb-3">2022ë…„~í˜„ì¬</h4>
                            <p class="text-gray-600 leading-relaxed">ì „êµ­ 500ê°œ í•™ì›<br>êµìœ¡ ì§„í–‰</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <style>
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes scaleIn {
                from {
                    opacity: 0;
                    transform: scale(0.8);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .fade-in-up {
                animation: fadeInUp 0.8s ease-out forwards;
                opacity: 0;
            }

            .timeline-item {
                animation: scaleIn 0.6s ease-out forwards;
                opacity: 0;
            }
        </style>

        <!-- Marketing Team Leader Section -->
        <section class="py-20 px-6 bg-gradient-to-br from-gray-50 to-white">
            <div class="max-w-7xl mx-auto">
                <div class="grid lg:grid-cols-[400px_1fr] gap-12 items-start">
                    <!-- Left: Team Leader Photo -->
                    <div class="flex justify-center lg:justify-start">
                        <div class="relative">
                            <img src="/static/images/team-ko-sunwoo.jpg" 
                                 alt="ê³ ì„ ìš° ë§ˆì¼€íŒ… 1íŒ€ì¥" 
                                 class="w-full max-w-sm rounded-3xl shadow-2xl object-cover">
                            <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 bg-white px-8 py-4 rounded-full shadow-xl border-2 border-orange-200">
                                <p class="font-bold text-gray-900 text-lg whitespace-nowrap">ê³ ì„ ìš° ë§ˆì¼€íŒ… 1íŒ€ì¥</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Introduction -->
                    <div class="space-y-6 pt-8">
                        <div class="bg-white rounded-2xl p-8 shadow-lg border-2 border-orange-200">
                            <h3 class="text-3xl font-bold text-gray-900 mb-6">ë§ˆì¼€íŒ… ì „ë¬¸ê°€</h3>
                            <div class="space-y-4 text-lg text-gray-700">
                                <div class="flex items-start gap-3">
                                    <svg class="w-6 h-6 text-orange-500 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <p><strong class="text-orange-600">ìë™í™” í¼ë„ ì „ë¬¸ê°€</strong><br>
                                    <span class="text-gray-600 text-base">í•™ìƒ ëª¨ì§‘ë¶€í„° ë“±ë¡ê¹Œì§€ ìë™í™” ì‹œìŠ¤í…œ êµ¬ì¶•</span></p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <svg class="w-6 h-6 text-orange-500 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <p><strong class="text-orange-600">ì¸ìŠ¤íƒ€ê·¸ë¨ ë°”ì´ëŸ´ ì˜ìƒ ì œì‘</strong><br>
                                    <span class="text-gray-600 text-base">SNS ë§ˆì¼€íŒ… ë° ì½˜í…ì¸  ì œì‘ ì „ë¬¸</span></p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <svg class="w-6 h-6 text-orange-500 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <p><strong class="text-orange-600">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œ</strong><br>
                                    <span class="text-gray-600 text-base">ì§€ì—­ ê²€ìƒ‰ ìµœì í™” ë° ë¦¬ë·° ê´€ë¦¬</span></p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <svg class="w-6 h-6 text-orange-500 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <p><strong class="text-orange-600">ëœë”©í˜ì´ì§€ ì œì‘ ë° ê°œë°œ</strong><br>
                                    <span class="text-gray-600 text-base">ì „í™˜ìœ¨ ë†’ì€ í˜ì´ì§€ ë””ìì¸ ë° ê°œë°œ</span></p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <svg class="w-6 h-6 text-orange-500 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <p><strong class="text-orange-600">ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œ ê¸€ ì‘ì„±</strong><br>
                                    <span class="text-gray-600 text-base">SEO ìµœì í™” ì½˜í…ì¸  ì‘ì„±</span></p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <svg class="w-6 h-6 text-orange-500 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <p><strong class="text-orange-600">AI ì»¨ì„¤í„´íŠ¸ ì „ë¬¸ê°€</strong><br>
                                    <span class="text-gray-600 text-base">AI ë„êµ¬ í™œìš© ë° ìë™í™” ì»¨ì„¤íŒ…</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Values Section -->
        <section class="py-20 px-6 bg-gray-50">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl font-bold text-gray-900 mb-4">ìš°ë¦¬ì˜ ê°€ì¹˜</h2>
                    <p class="text-xl text-gray-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ë¥¼ ë§Œë“œëŠ” 3ê°€ì§€ ì›ì¹™</p>
                </div>

                <div class="grid md:grid-cols-3 gap-8">
                    <div class="bg-white rounded-3xl p-10 text-center">
                        <div class="w-20 h-20 gradient-purple rounded-2xl flex items-center justify-center mx-auto mb-6">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">ì‹¤ì „ ê²½í—˜</h3>
                        <p class="text-gray-600 leading-relaxed">
                            ì´ë¡ ì´ ì•„ë‹Œ ìš°ë¦¬ê°€ ì§ì ‘ í•™ì›ì„ ìš´ì˜í•˜ë©° ê²€ì¦í•œ 
                            ì‹¤ì „ ë§ˆì¼€íŒ… ë…¸í•˜ìš°ë§Œ ì „ë‹¬í•©ë‹ˆë‹¤
                        </p>
                    </div>

                    <div class="bg-white rounded-3xl p-10 text-center">
                        <div class="w-20 h-20 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-6">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">ì»¤ë®¤ë‹ˆí‹°</h3>
                        <p class="text-gray-600 leading-relaxed">
                            ì˜¤í”ˆì±„íŒ…ë°©ê³¼ ì˜¤í”„ë¼ì¸ ëª¨ì„ì„ í†µí•´ 
                            ì „êµ­ í•™ì›ì¥ë‹˜ë“¤ê³¼ í•¨ê»˜ ì„±ì¥í•©ë‹ˆë‹¤
                        </p>
                    </div>

                    <div class="bg-white rounded-3xl p-10 text-center">
                        <div class="w-20 h-20 gradient-purple rounded-2xl flex items-center justify-center mx-auto mb-6">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">ì§€ì† ì„±ì¥</h3>
                        <p class="text-gray-600 leading-relaxed">
                            ì¼íšŒì„± êµìœ¡ì´ ì•„ë‹Œ ì§€ì†ì ì¸ ì½˜í…ì¸  ì—…ë°ì´íŠ¸ì™€ 
                            ì‹¤ì‹œê°„ Q&Aë¡œ ê³„ì† í•¨ê»˜í•©ë‹ˆë‹¤
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Achievements Section -->
        <section class="py-20 px-6">
            <div class="max-w-7xl mx-auto">
                <div class="text-center mb-16">
                    <h2 class="text-4xl font-bold text-gray-900 mb-4">ìš°ë¦¬ì˜ ì„±ê³¼</h2>
                    <p class="text-xl text-gray-600">ìˆ«ìë¡œ ì¦ëª…í•˜ëŠ” ì‹¤ì „ ë…¸í•˜ìš°</p>
                </div>

                <div class="grid md:grid-cols-4 gap-8">
                    <div class="text-center">
                        <div class="text-5xl font-bold text-purple-600 mb-3">500+</div>
                        <div class="text-lg text-gray-700 font-medium">êµìœ¡ ìˆ˜ë£Œ í•™ì›</div>
                        <div class="text-sm text-gray-500 mt-2">ì „êµ­ ê°ì§€ì˜ í•™ì›</div>
                    </div>
                    <div class="text-center">
                        <div class="text-5xl font-bold text-orange-500 mb-3">95%</div>
                        <div class="text-lg text-gray-700 font-medium">ë§Œì¡±ë„</div>
                        <div class="text-sm text-gray-500 mt-2">ì‹¤ì œ íš¨ê³¼ ì²´ê°</div>
                    </div>
                    <div class="text-center">
                        <div class="text-5xl font-bold text-purple-600 mb-3">24/7</div>
                        <div class="text-lg text-gray-700 font-medium">ì»¤ë®¤ë‹ˆí‹° ìš´ì˜</div>
                        <div class="text-sm text-gray-500 mt-2">ì‹¤ì‹œê°„ ì§ˆì˜ì‘ë‹µ</div>
                    </div>
                    <div class="text-center">
                        <div class="text-5xl font-bold text-orange-500 mb-3">4ë…„+</div>
                        <div class="text-lg text-gray-700 font-medium">ìš´ì˜ ê²½í—˜</div>
                        <div class="text-sm text-gray-500 mt-2">ì¶•ì ëœ ë…¸í•˜ìš°</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA Section -->
        <section class="py-20 px-6 gradient-purple">
            <div class="max-w-4xl mx-auto text-center">
                <h2 class="text-4xl lg:text-5xl font-bold text-white mb-8">
                    í•¨ê»˜ ì„±ì¥í•˜ëŠ” í•™ì›ì„<br>
                    ë§Œë“¤ì–´ê°€ì‹¤ ì¤€ë¹„ê°€ ë˜ì…¨ë‚˜ìš”?
                </h2>
                <p class="text-xl text-white/90 mb-12">
                    ìš°ë¦¬ì˜ ê²½í—˜ê³¼ ë…¸í•˜ìš°ê°€ ì—¬ëŸ¬ë¶„ì˜ í•™ì› ì„±ê³µì— ë„ì›€ì´ ë˜ê¸¸ ë°”ëë‹ˆë‹¤
                </p>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="/contact" class="bg-white text-purple-600 px-12 py-5 rounded-full text-lg font-medium shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all">
                        ë¬´ë£Œ ìƒë‹´ ì‹ ì²­í•˜ê¸°
                    </a>
                    <a href="/programs" class="bg-white/10 backdrop-blur-sm border-2 border-white/40 text-white px-12 py-5 rounded-full text-lg font-medium hover:bg-white hover:text-purple-600 transition-all">
                        êµìœ¡ í”„ë¡œê·¸ë¨ ë³´ê¸°
                    </a>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-gray-50 text-gray-600 py-20 px-6 border-t border-gray-100">
            <div class="max-w-7xl mx-auto">
                <div class="grid md:grid-cols-4 gap-12 mb-16">
                    <div>
                        <div class="flex items-center space-x-2 mb-4">
                            <span class="text-xl font-bold text-gray-900">ìŠˆí¼í”Œë ˆì´ìŠ¤</span>
                        </div>
                        <p class="text-gray-500 text-sm leading-relaxed">
                            í•™ì› ë§ˆì¼€íŒ…ì˜ ìƒˆë¡œìš´ ê¸°ì¤€
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-4">ì„œë¹„ìŠ¤</h4>
                        <ul class="space-y-3 text-sm">
                            <li><a href="/programs" class="hover:text-purple-600 transition">êµìœ¡ í”„ë¡œê·¸ë¨</a></li>
                            <li><a href="/success" class="hover:text-purple-600 transition">ì„±ê³µ ì‚¬ë¡€</a></li>
                            <li><a href="/contact" class="hover:text-purple-600 transition">ë¬¸ì˜í•˜ê¸°</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-4">íšŒì‚¬</h4>
                        <ul class="space-y-3 text-sm">
                            <li><a href="/about" class="hover:text-purple-600 transition">íšŒì‚¬ ì†Œê°œ</a></li>
                            <li><a href="/terms" class="hover:text-purple-600 transition">ì´ìš©ì•½ê´€</a></li>
                            <li><a href="/privacy" class="hover:text-purple-600 transition">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a></li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-4">ì—°ë½ì²˜</h4>
                        <ul class="space-y-3 text-sm">
                            <li>ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬</li>
                            <li>wangholy1@naver.com</li>
                            <li>ë¬¸ì˜ ì–‘ì‹ ì´ìš© ê°€ëŠ¥</li>
                        </ul>
                    </div>
                </div>
                <div class="border-t border-gray-200 pt-8 text-center text-gray-500 text-sm">
                    <p>&copy; 2024 ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤. All rights reserved.</p>
                </div>
            </div>
        </footer>
    </body>
    </html>
  `)
})

// ëœë”©í˜ì´ì§€ ë³´ê¸° ë¼ìš°íŠ¸
app.get('/landing/:slug', async (c) => {
  try {
    const slug = c.req.param('slug')
    const query = 'SELECT * FROM landing_pages WHERE slug = ? AND status = ?'
    const page = await c.env.DB.prepare(query).bind(slug, 'active').first()
    
    if (!page) {
      return c.html('<h1>í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</h1>', 404)
    }
    
    // ì¡°íšŒìˆ˜ ì¦ê°€
    await c.env.DB.prepare('UPDATE landing_pages SET view_count = view_count + 1 WHERE slug = ?').bind(slug).run()
    
    // OG ë©”íƒ€ íƒœê·¸ ì¶”ê°€
    let htmlContent = page.html_content as string
    const fullUrl = `${c.req.header('origin') || 'https://superplace-academy.pages.dev'}/landing/${slug}`
    const thumbnailUrl = (page.thumbnail_url as string) || 'https://via.placeholder.com/1200x630.png?text=Super+Place+Academy'
    
    // ì»¤ìŠ¤í…€ OG ì œëª©/ì„¤ëª… ë˜ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©
    const ogTitle = (page.og_title as string) || (page.title as string) || 'ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤'
    const ogDescription = (page.og_description as string) || 'ê¾¸ë©”ë•…í•™ì›ì˜ ì „ë¬¸ì ì¸ êµìœ¡ ì„œë¹„ìŠ¤ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”'
    
    console.log('[Landing Page Debug] form_id:', page.form_id, 'Type:', typeof page.form_id)
    
    // í¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    let formHtml = ''
    let formHeaderScript = ''
    if (page.form_id) {
      console.log('[Landing Page Debug] Fetching form with ID:', page.form_id)
      const form = await c.env.DB.prepare('SELECT * FROM form_templates WHERE id = ?').bind(page.form_id).first()
      console.log('[Landing Page Debug] Form found:', !!form)
      if (form) {
        // í—¤ë” ìŠ¤í¬ë¦½íŠ¸ (í”½ì…€ ë“±)
        if (form.header_script) {
          formHeaderScript = form.header_script as string
        }
        
        // ì»¤ìŠ¤í…€ fields íŒŒì‹±
        let customFields = []
        try {
          customFields = form.fields ? JSON.parse(form.fields as string) : []
        } catch (e) {
          console.error('Failed to parse form fields:', e)
        }
        
        // ëª¨ë“  í•„ë“œ HTML ìƒì„± (ì»¤ìŠ¤í…€ í•„ë“œë§Œ ì‚¬ìš©, ì¤‘ë³µ ì œê±°)
        let allFieldsHtml = ''
        for (const field of customFields) {
          const required = field.required ? 'required' : ''
          const requiredStar = field.required ? ' *' : ''
          const fieldName = field.name || field.label.replace(/\s+/g, '_')
          
          if (field.type === 'textarea') {
            allFieldsHtml += `
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">${field.label}${requiredStar}</label>
                        <textarea name="${fieldName}" ${required} class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="${field.placeholder || ''}" rows="4"></textarea>
                    </div>`
          } else if (field.type === 'select') {
            let options = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>'
            for (const opt of (field.options || [])) {
              options += `<option value="${opt}">${opt}</option>`
            }
            allFieldsHtml += `
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">${field.label}${requiredStar}</label>
                        <select name="${fieldName}" ${required} class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            ${options}
                        </select>
                    </div>`
          } else if (field.type === 'radio') {
            let radioOptions = ''
            for (const opt of (field.options || [])) {
              radioOptions += `
                        <div class="flex items-center mb-2">
                            <input type="radio" name="${fieldName}" value="${opt}" ${required} class="mr-2 h-4 w-4 text-purple-600 focus:ring-purple-500">
                            <label class="text-sm text-gray-700">${opt}</label>
                        </div>`
            }
            allFieldsHtml += `
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">${field.label}${requiredStar}</label>
                        ${radioOptions}
                    </div>`
          } else if (field.type === 'checkbox') {
            allFieldsHtml += `
                    <div class="flex items-start">
                        <input type="checkbox" name="${fieldName}" ${required} class="mt-1 mr-3 h-5 w-5 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                        <label class="text-sm text-gray-700">${field.label}</label>
                    </div>`
          } else {
            const inputType = field.type || 'text'
            allFieldsHtml += `
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">${field.label}${requiredStar}</label>
                        <input type="${inputType}" name="${fieldName}" ${required} class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="${field.placeholder || ''}">
                    </div>`
          }
        }
        
        // í¼ HTML ìƒì„±
        formHtml = `
        <!-- ì‹ ì²­ í¼ ì„¹ì…˜ -->
        <div class="container mx-auto px-4 py-12" id="apply-form-section">
            <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-8">
                <h2 class="text-3xl font-bold text-center mb-2 bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-pink-600">
                    ğŸ“ ${form.name || 'ì‹ ì²­í•˜ê¸°'}
                </h2>
                <p class="text-center text-gray-600 mb-8">${form.description || 'ì•„ë˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ì‹ ì²­í•´ì£¼ì„¸ìš”'}</p>
                
                ${form.custom_html || ''}
                
                <form id="applicationForm" class="space-y-6">
                    ${allFieldsHtml}
                    
                    <div class="flex items-start">
                        <input type="checkbox" name="agreedToTerms" required class="mt-1 mr-3 h-5 w-5 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                        <label class="text-sm text-gray-700">
                            ${form.terms_text || 'ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.'}
                        </label>
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl text-lg font-bold hover:shadow-xl transition transform hover:scale-105">
                        ì‹ ì²­í•˜ê¸°
                    </button>
                </form>
                
                <div id="formResult" class="hidden mt-6 p-4 rounded-xl"></div>
            </div>
        </div>
        
        <script>
        document.getElementById('applicationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const allData = {};
            for (const [key, value] of formData.entries()) {
                allData[key] = value;
            }
            
            const data = {
                form_template_id: ${form.id},
                landing_page_id: null,
                submission_data: JSON.stringify({
                    ...allData,
                    submittedFrom: 'landing_page',
                    landingPageSlug: '${slug}'
                })
            };
            
            try {
                const response = await fetch('/api/form-submissions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                const resultDiv = document.getElementById('formResult');
                resultDiv.classList.remove('hidden');
                
                if (result.success) {
                    resultDiv.className = 'mt-6 p-4 rounded-xl bg-green-100 border-2 border-green-500 text-green-800';
                    resultDiv.innerHTML = '<p class="font-bold text-center">âœ… ${form.success_message || 'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!'}</p>';
                    e.target.reset();
                    
                    // í¼ í”½ì…€ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
                    ${form.pixel_script || ''}
                    
                    // ëœë”©í˜ì´ì§€ ì „í™˜ í”½ì…€ ì‹¤í–‰
                    try {
                        const conversionPixel = ${JSON.stringify(page.conversion_pixel || '')};
                        if (conversionPixel) {
                            eval(conversionPixel);
                        }
                    } catch (e) {
                        console.error('Conversion pixel error:', e);
                    }
                } else {
                    resultDiv.className = 'mt-6 p-4 rounded-xl bg-red-100 border-2 border-red-500 text-red-800';
                    resultDiv.innerHTML = '<p class="font-bold text-center">âŒ ' + (result.error || result.message || 'ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.') + '</p>';
                    console.error('Form submission failed:', result);
                }
            } catch (error) {
                console.error('Form submission error:', error);
                const resultDiv = document.getElementById('formResult');
                resultDiv.classList.remove('hidden');
                resultDiv.className = 'mt-6 p-4 rounded-xl bg-red-100 border-2 border-red-500 text-red-800';
                resultDiv.innerHTML = '<p class="font-bold text-center">âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</p>';
            }
        });
        </script>
        `
      }
    }
    
    // <head> íƒœê·¸ì— OG ë©”íƒ€ íƒœê·¸ + í¼ í—¤ë” ìŠ¤í¬ë¦½íŠ¸ + í—¤ë” í”½ì…€ ì£¼ì…
    const headerPixel = (page.header_pixel as string) || ''
    const bodyPixel = (page.body_pixel as string) || ''
    
    const ogTags = `
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="${fullUrl}">
    <meta property="og:title" content="${ogTitle}">
    <meta property="og:description" content="${ogDescription}">
    <meta property="og:image" content="${thumbnailUrl}">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="${fullUrl}">
    <meta property="twitter:title" content="${ogTitle}">
    <meta property="twitter:description" content="${ogDescription}">
    <meta property="twitter:image" content="${thumbnailUrl}">
    
    ${formHeaderScript}
    ${headerPixel}
    `
    
    // </head> ì§ì „ì— OG íƒœê·¸ ì¶”ê°€
    htmlContent = htmlContent.replace('</head>', `${ogTags}</head>`)
    
    // <body> ì§í›„ì— ë³¸ë¬¸ í”½ì…€ ì¶”ê°€
    if (bodyPixel) {
      htmlContent = htmlContent.replace(/<body[^>]*>/i, (match) => `${match}\n${bodyPixel}`)
    }
    
    // Footer ì§ì „ì— í¼ ì¶”ê°€ (ê³µë°±/ë“¤ì—¬ì“°ê¸° ë¬´ì‹œ)
    if (formHtml) {
      // ì—¬ëŸ¬ íŒ¨í„´ ì‹œë„
      if (htmlContent.includes('<footer>')) {
        htmlContent = htmlContent.replace(/<footer>/i, `${formHtml}\n        <footer>`)
      } else if (htmlContent.includes('<!-- Footer -->')) {
        htmlContent = htmlContent.replace(/<!-- Footer -->/i, `${formHtml}\n        <!-- Footer -->`)
      } else {
        // footerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìœ¼ë©´ </body> ì•ì— ì‚½ì…
        htmlContent = htmlContent.replace('</body>', `${formHtml}\n    </body>`)
      }
    }
    
    // HTML ë°˜í™˜
    return c.html(htmlContent)
  } catch (err) {
    console.error('Landing page error:', err)
    return c.html('<h1>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</h1>', 500)
  }
})

// ê´€ë¦¬ì í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ë¡œì»¬ ê°œë°œìš©)
// í”„ë¡œë•ì…˜ì—ì„œëŠ” Cloudflare Pagesê°€ ìë™ìœ¼ë¡œ dist/admin/*.htmlì„ ì„œë¹™í•©ë‹ˆë‹¤
// Admin redirects removed - using direct routes

// ==================== SMS ë°œì†¡ í—¬í¼ í•¨ìˆ˜ ====================

// Aligo SMS API ë°œì†¡ í•¨ìˆ˜
// Aligo SMS API ë°œì†¡ í•¨ìˆ˜
async function sendSMSAligo(phone: string, message: string, apiKey: string, userId: string, sender: string, realMode: string): Promise<any> {
  const formData = new FormData()
  formData.append('key', apiKey)
  formData.append('user_id', userId)
  formData.append('sender', sender)
  formData.append('receiver', phone)
  formData.append('msg', message)
  formData.append('testmode_yn', realMode === 'Y' ? 'N' : 'Y') // realMode=Yë©´ ì‹¤ì œë°œì†¡
  
  try {
    const response = await fetch('https://apis.aligo.in/send/', {
      method: 'POST',
      body: formData
    })
    return await response.json()
  } catch (err) {
    console.error('Aligo SMS error:', err)
    return { result_code: -1, message: 'SMS ë°œì†¡ ì‹¤íŒ¨' }
  }
}

// Solapi SMS API ë°œì†¡ í•¨ìˆ˜
async function sendSMSSolapi(phone: string, message: string, apiKey: string, apiSecret: string): Promise<any> {
  try {
    const response = await fetch('https://api.solapi.com/messages/v4/send', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        message: {
          to: phone,
          from: '01012345678', // ë°œì‹ ë²ˆí˜¸
          text: message
        }
      })
    })
    return await response.json()
  } catch (err) {
    console.error('Solapi SMS error:', err)
    return { statusCode: 500, message: 'SMS ë°œì†¡ ì‹¤íŒ¨' }
  }
}

// ==================== SMS ê´€ë¦¬ API ====================

// SMS í…œí”Œë¦¿ ëª©ë¡
app.get('/api/sms/templates', async (c) => {
  try {
    const { results } = await c.env.DB.prepare(`
      SELECT * FROM sms_templates WHERE is_active = 1 ORDER BY category, name
    `).all()
    
    return c.json({ success: true, templates: results })
  } catch (err) {
    console.error('Get templates error:', err)
    return c.json({ success: false, error: 'í…œí”Œë¦¿ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// SMS í…œí”Œë¦¿ ì¶”ê°€
app.post('/api/sms/templates', async (c) => {
  try {
    const { name, category, content, variables } = await c.req.json()
    const user = JSON.parse(c.req.header('X-User-Data-Base64') ? decodeURIComponent(escape(atob(c.req.header('X-User-Data-Base64') || ''))) : '{"id":1}')
    
    const result = await c.env.DB.prepare(`
      INSERT INTO sms_templates (name, category, content, variables, created_by)
      VALUES (?, ?, ?, ?, ?)
    `).bind(name, category, content, JSON.stringify(variables || []), user.id).run()
    
    return c.json({ success: true, message: 'í…œí”Œë¦¿ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', id: result.meta.last_row_id })
  } catch (err) {
    console.error('Add template error:', err)
    return c.json({ success: false, error: 'í…œí”Œë¦¿ ì¶”ê°€ ì‹¤íŒ¨' }, 500)
  }
})

// SMS ì¦‰ì‹œ ë°œì†¡
app.post('/api/sms/send', async (c) => {
  try {
    const { recipient_phone, recipient_name, message_content, template_id } = await c.req.json()
    const user = JSON.parse(c.req.header('X-User-Data-Base64') ? decodeURIComponent(escape(atob(c.req.header('X-User-Data-Base64') || ''))) : '{"id":1}')
    
    // í™˜ê²½ë³€ìˆ˜ì—ì„œ API í‚¤ ê°€ì ¸ì˜¤ê¸°
    const apiKey = c.env.ALIGO_API_KEY || ''
    const userId = c.env.ALIGO_USER_ID || ''
    const sender = c.env.ALIGO_SENDER || '01012345678'
    const realMode = c.env.SMS_REAL_MODE || 'N'
    
    let smsResult = null
    let status = 'sent'
    let resultCode = null
    let resultMessage = null
    
    // API í‚¤ê°€ ìˆìœ¼ë©´ ì‹¤ì œ ë°œì†¡ ì‹œë„
    if (apiKey && userId) {
      smsResult = await sendSMSAligo(recipient_phone, message_content, apiKey, userId, sender, realMode)
      resultCode = smsResult.result_code?.toString() || null
      resultMessage = smsResult.message || null
      
      // ë°œì†¡ ì‹¤íŒ¨ ì‹œ statusë¥¼ failedë¡œ
      if (smsResult.result_code !== 1) {
        status = 'failed'
      }
    }
    
    // DBì— ê¸°ë¡
    const result = await c.env.DB.prepare(`
      INSERT INTO sms_history (template_id, recipient_name, recipient_phone, message_content, status, sent_at, result_code, result_message, created_by)
      VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP, ?, ?, ?)
    `).bind(template_id || null, recipient_name, recipient_phone, message_content, status, resultCode, resultMessage, user.id).run()
    
    return c.json({ 
      success: status !== 'failed', 
      message: status === 'failed' ? 'SMS ë°œì†¡ ì‹¤íŒ¨: ' + resultMessage : 'SMSê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
      id: result.meta.last_row_id,
      note: apiKey ? (realMode === 'Y' ? 'ì‹¤ì œ ë°œì†¡ ì™„ë£Œ' : 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ (ì‹¤ì œ ë°œì†¡ ì•ˆë¨)') : 'API í‚¤ë¥¼ ì„¤ì •í•˜ë©´ ì‹¤ì œ ë°œì†¡ë©ë‹ˆë‹¤.',
      smsResult: smsResult
    })
  } catch (err) {
    console.error('Send SMS error:', err)
    return c.json({ success: false, error: 'SMS ë°œì†¡ ì‹¤íŒ¨' }, 500)
  }
})

// SMS ì˜ˆì•½ ë°œì†¡
app.post('/api/sms/schedule', async (c) => {
  try {
    const { recipient_phone, recipient_name, message_content, template_id, scheduled_at } = await c.req.json()
    const user = JSON.parse(c.req.header('X-User-Data-Base64') ? decodeURIComponent(escape(atob(c.req.header('X-User-Data-Base64') || ''))) : '{"id":1}')
    
    const result = await c.env.DB.prepare(`
      INSERT INTO sms_history (template_id, recipient_name, recipient_phone, message_content, status, scheduled_at, created_by)
      VALUES (?, ?, ?, ?, 'scheduled', ?, ?)
    `).bind(template_id || null, recipient_name, recipient_phone, message_content, scheduled_at, user.id).run()
    
    return c.json({ 
      success: true, 
      message: 'SMSê°€ ì˜ˆì•½ë˜ì—ˆìŠµë‹ˆë‹¤.',
      id: result.meta.last_row_id
    })
  } catch (err) {
    console.error('Schedule SMS error:', err)
    return c.json({ success: false, error: 'SMS ì˜ˆì•½ ì‹¤íŒ¨' }, 500)
  }
})

// SMS ë°œì†¡ ê¸°ë¡ ì¡°íšŒ
app.get('/api/sms/history', async (c) => {
  try {
    const { results } = await c.env.DB.prepare(`
      SELECT 
        sh.*,
        st.name as template_name
      FROM sms_history sh
      LEFT JOIN sms_templates st ON sh.template_id = st.id
      ORDER BY sh.created_at DESC
      LIMIT 100
    `).all()
    
    return c.json({ success: true, history: results })
  } catch (err) {
    console.error('Get SMS history error:', err)
    return c.json({ success: false, error: 'ë°œì†¡ ê¸°ë¡ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// SMS ë°œì†¡ í†µê³„
app.get('/api/sms/stats', async (c) => {
  try {
    // ì˜¤ëŠ˜ ë°œì†¡ ìˆ˜
    const today = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM sms_history 
      WHERE DATE(created_at) = DATE('now')
    `).first()
    
    // ì´ë²ˆ ë‹¬ ë°œì†¡ ìˆ˜
    const thisMonth = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM sms_history 
      WHERE strftime('%Y-%m', created_at) = strftime('%Y-%m', 'now')
    `).first()
    
    // ìƒíƒœë³„ í†µê³„
    const byStatus = await c.env.DB.prepare(`
      SELECT status, COUNT(*) as count FROM sms_history 
      GROUP BY status
    `).all()
    
    return c.json({ 
      success: true, 
      stats: {
        today: today?.count || 0,
        thisMonth: thisMonth?.count || 0,
        byStatus: byStatus.results || []
      }
    })
  } catch (err) {
    console.error('Get SMS stats error:', err)
    return c.json({ success: false, error: 'í†µê³„ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// í•™ìƒ ê´€ë¦¬ API

// GET /api/students/:id/stats - í•™ìƒ í†µê³„ ì¡°íšŒ (ê°€ì¥ êµ¬ì²´ì ì¸ ë¼ìš°íŠ¸ ë¨¼ì €) - VERIFIED
app.get('/api/students/:id/stats', async (c) => {
  try {
    const studentId = c.req.param('id')
    const startDate = c.req.query('startDate')
    const endDate = c.req.query('endDate')
    
    if (!studentId) {
      return c.json({ success: false, error: 'í•™ìƒ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // daily_records í…Œì´ë¸”ì´ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê¸°ë³¸ê°’ ë°˜í™˜
    try {
      const stats = await c.env.DB.prepare('SELECT COUNT(*) as total_records, AVG(CASE WHEN attendance = \'ì¶œì„\' THEN 1 ELSE 0 END) * 100 as attendance_rate, AVG(understanding_level) as avg_understanding, AVG(homework_completion) as avg_homework FROM daily_records WHERE student_id = ? AND date BETWEEN ? AND ?').bind(studentId, startDate || '2020-01-01', endDate || '2099-12-31').first()
      
      return c.json({ 
        success: true, 
        stats: stats || {
          total_records: 0,
          attendance_rate: 0,
          avg_understanding: 0,
          avg_homework: 0
        }
      })
    } catch (dbError) {
      console.error('[GetStudentStats] DB Error:', dbError)
      // í…Œì´ë¸”ì´ ì—†ê±°ë‚˜ ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
      return c.json({ 
        success: true, 
        stats: {
          total_records: 0,
          attendance_rate: 0,
          avg_understanding: 0,
          avg_homework: 0
        }
      })
    }
  } catch (error) {
    console.error('[GetStudentStats] Error:', error)
    return c.json({ 
      success: true,
      stats: {
        total_records: 0,
        attendance_rate: 0,
        avg_understanding: 0,
        avg_homework: 0
      }
    })
  }
})

// GET /api/students/:id - í•™ìƒ ìƒì„¸ ì •ë³´ ì¡°íšŒ
app.get('/api/students/:id', async (c) => {
  try {
    const studentId = c.req.param('id')
    
    if (!studentId) {
      return c.json({ success: false, error: 'í•™ìƒ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // í•™ìƒ ì •ë³´ì™€ ë°˜ ì •ë³´ë¥¼ í•¨ê»˜ ì¡°íšŒ
    const student = await c.env.DB.prepare('SELECT s.*, c.class_name FROM students s LEFT JOIN classes c ON s.class_id = c.id WHERE s.id = ? AND s.status = \'active\'').bind(studentId).first()
    
    if (!student) {
      return c.json({ 
        success: false, 
        error: 'í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' 
      }, 404)
    }
    
    return c.json({ 
      success: true, 
      student: student 
    })
  } catch (error) {
    console.error('[GetStudentDetail] Error:', error)
    return c.json({ 
      success: false, 
      error: 'í•™ìƒ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    }, 500)
  }
})

// GET /api/students - í•™ìƒ ëª©ë¡ ì¡°íšŒ (ë§¤ê°œë³€ìˆ˜ ì—†ëŠ” ë¼ìš°íŠ¸ëŠ” ë‚˜ì¤‘ì—)
// GET /api/students - í•™ìƒ ëª©ë¡ ì¡°íšŒ (ì™„ì „ ì¬ì‘ì„± - ë‹¨ìˆœ ë²„ì „)
app.get('/api/students', async (c) => {
  console.log('\nğŸ‘¥ [GetStudents] ==========================================')
  console.log('ğŸ‘¥ [GetStudents] Request started')
  
  try {
    // Step 1: DB ì—°ê²° í™•ì¸
    if (!c.env.DB) {
      console.error('âŒ [GetStudents] FATAL: DB not available')
      return c.json({ success: false, error: 'DB ì—°ê²° ì‹¤íŒ¨' }, 500)
    }
    console.log('âœ… [GetStudents] DB connection OK')
    
    // Step 2: ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ (academy_id í¬í•¨)
    let userId
    let academyId
    let userType
    let userPermissions
    
    try {
      const userHeader = c.req.header('X-User-Data-Base64')
      if (userHeader) {
        const userData = JSON.parse(decodeURIComponent(escape(atob(userHeader))))
        userId = userData.id
        academyId = userData.academy_id || userData.id  // âœ… academy_id ìš°ì„  ì‚¬ìš©
        userType = userData.user_type
        userPermissions = userData.permissions
        console.log('ğŸ‘¥ [GetStudents] Got user from header:', {
          userId,
          academyId,
          userType
        })
      }
    } catch (headerErr) {
      console.log('âš ï¸  [GetStudents] Header parse failed, trying session')
    }
    
    // ì„¸ì…˜ì—ì„œ ì‹œë„
    if (!userId) {
      const sessionId = c.req.header('cookie')?.match(/session_id=([^;]+)/)?.[1]
      if (sessionId) {
        const session = await c.env.DB.prepare(
          "SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')"
        ).bind(sessionId).first()
        userId = session?.user_id
        console.log('ğŸ‘¥ [GetStudents] Got userId from session:', userId)
        
        // âœ… ì„¸ì…˜ì—ì„œ ê°€ì ¸ì˜¨ ê²½ìš° DBì—ì„œ academy_id ì¡°íšŒ
        if (userId) {
          const user = await c.env.DB.prepare(
            'SELECT academy_id, user_type FROM users WHERE id = ?'
          ).bind(userId).first()
          academyId = user?.academy_id || userId
          userType = user?.user_type
          console.log('ğŸ‘¥ [GetStudents] Got academyId from DB:', academyId)
        }
      }
    }
    
    if (!userId || !academyId) {
      console.error('âŒ [GetStudents] No userId or academyId')
      return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }
    
    console.log('ğŸ‘¥ [GetStudents] Final userId:', userId, 'academyId:', academyId)
    console.log('ğŸ‘¥ [GetStudents] userType:', userType)
    console.log('ğŸ‘¥ [GetStudents] Query will use academyId:', academyId)
    
    // Step 3: ê¶Œí•œì— ë”°ë¥¸ í•™ìƒ ì¡°íšŒ
    let students = []
    
    console.log('ğŸ‘¥ [GetStudents] User type:', userType)
    console.log('ğŸ‘¥ [GetStudents] User permissions:', userPermissions)
    
    // ì„ ìƒë‹˜ì´ê³  ë°°ì •ëœ ë°˜ë§Œ í—ˆìš©ëœ ê²½ìš°
    if (userType === 'teacher' && 
        userPermissions && 
        !userPermissions.canViewAllStudents && 
        userPermissions.assignedClasses && 
        userPermissions.assignedClasses.length > 0) {
      
      console.log('ğŸ‘¥ [GetStudents] Teacher with assigned classes only:', userPermissions.assignedClasses)
      
      // ë°°ì •ëœ ë°˜ì˜ í•™ìƒë§Œ ì¡°íšŒ
      const placeholders = userPermissions.assignedClasses.map(() => '?').join(',')
      const query = `SELECT * FROM students WHERE class_id IN (${placeholders}) AND (status IS NULL OR status != 'deleted') ORDER BY id DESC`
      
      try {
        const result = await c.env.DB.prepare(query)
          .bind(...userPermissions.assignedClasses)
          .all()
        
        students = result.results || []
        console.log('âœ… [GetStudents] Found', students.length, 'students in assigned classes')
      } catch (err) {
        console.error('âŒ [GetStudents] Assigned classes query failed:', err.message)
        students = []
      }
      
    } else {
      // ì›ì¥ë‹˜ ë˜ëŠ” ëª¨ë“  ê¶Œí•œì´ ìˆëŠ” ì„ ìƒë‹˜ - academy_idë¡œ ëª¨ë“  í•™ìƒ ì¡°íšŒ
      console.log('ğŸ‘¥ [GetStudents] Full access - loading all students')
      console.log('ğŸ‘¥ [GetStudents] Using academyId:', academyId)
      
      // âœ… academy_idë¡œ ì¡°íšŒ + classes JOINìœ¼ë¡œ class_fee ê°€ì ¸ì˜¤ê¸°
      try {
        console.log('ğŸ‘¥ [GetStudents] Query: WHERE academy_id =', academyId)
        const result1 = await c.env.DB.prepare(`
          SELECT 
            s.*,
            c.class_name,
            c.monthly_fee as class_fee
          FROM students s
          LEFT JOIN classes c ON s.class_id = c.id
          WHERE s.academy_id = ? 
            AND (s.status IS NULL OR s.status != 'deleted') 
          ORDER BY s.id DESC
        `).bind(academyId).all()
        
        students = result1.results || []
        console.log('âœ… [GetStudents] SUCCESS! Found', students.length, 'students')
        
        // âœ… ë””ë²„ê·¸: ë§Œì•½ 0ëª…ì´ë©´ ì „ì²´ í•™ìƒ ìˆ˜ í™•ì¸
        if (students.length === 0) {
          console.log('âš ï¸ [GetStudents] No students for academy_id:', academyId)
          
          // ì „ì²´ í•™ìƒ ìˆ˜ í™•ì¸
          const totalResult = await c.env.DB.prepare(
            "SELECT COUNT(*) as count FROM students"
          ).first()
          console.log('ğŸ“Š [GetStudents] Total students in DB:', totalResult?.count || 0)
          
          // academy_idë³„ í•™ìƒ ìˆ˜ í™•ì¸
          const byAcademyResult = await c.env.DB.prepare(
            "SELECT academy_id, COUNT(*) as count FROM students GROUP BY academy_id"
          ).all()
          console.log('ğŸ“Š [GetStudents] Students by academy_id:', byAcademyResult.results)
        }
      } catch (err1) {
        console.log('âš ï¸  [GetStudents] Try 1 failed:', err1.message)
        
        // Try 2: ëª¨ë“  active í•™ìƒ
        try {
          console.log('ğŸ‘¥ [GetStudents] Try 2: All active students')
          const result2 = await c.env.DB.prepare(
            "SELECT * FROM students WHERE (status IS NULL OR status != 'deleted') ORDER BY id DESC LIMIT 1000"
          ).all()
          
          students = result2.results || []
          console.log('âœ… [GetStudents] Found', students.length, 'active students')
        } catch (err2) {
          console.log('âš ï¸  [GetStudents] Try 2 failed:', err2.message)
          
          // Try 3: ëª¨ë“  í•™ìƒ (í•„í„° ì—†ì´)
          try {
            console.log('ğŸ‘¥ [GetStudents] Try 3: All students (no filter)')
            const result3 = await c.env.DB.prepare(
              'SELECT * FROM students ORDER BY id DESC LIMIT 1000'
            ).all()
            
            students = result3.results || []
            console.log('âœ… [GetStudents] Found', students.length, 'total students')
          } catch (err3) {
            console.error('âŒ [GetStudents] ALL queries failed!')
            throw err3
          }
        }
      }
    }
    
    console.log('âœ… [GetStudents] Returning', students.length, 'students')
    console.log('ğŸ‘¥ [GetStudents] ==========================================\n')
    
    return c.json({ success: true, students })
    
  } catch (error) {
    console.error('âŒ [GetStudents] FATAL ERROR:', error)
    console.error('âŒ [GetStudents] Message:', error.message)
    console.error('âŒ [GetStudents] Stack:', error.stack)
    console.log('ğŸ‘¥ [GetStudents] ==========================================\n')
    
    return c.json({ 
      success: false, 
      error: 'í•™ìƒ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message
    }, 500)
  }
})

// ğŸ“… í•™ìƒ ì¶œì„ ë°ì´í„° ì¡°íšŒ API (ë‚ ì§œ ë²”ìœ„)
app.get('/api/students/:studentId/attendance', async (c) => {
  try {
    const studentId = c.req.param('studentId')
    const startDate = c.req.query('startDate') // YYYY-MM-DD í˜•ì‹
    const endDate = c.req.query('endDate') // YYYY-MM-DD í˜•ì‹
    
    if (!c.env.DB) {
      return c.json({ success: false, error: 'DB ì—°ê²° ì‹¤íŒ¨' }, 500)
    }
    
    if (!studentId || !startDate || !endDate) {
      return c.json({ 
        success: false, 
        error: 'í•™ìƒ ID, ì‹œì‘ì¼, ì¢…ë£Œì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.' 
      }, 400)
    }
    
    console.log('ğŸ“… [GetAttendance] Student:', studentId, 'Period:', startDate, '-', endDate)
    
    // í•´ë‹¹ ê¸°ê°„ì˜ ì¶œì„ ë°ì´í„° ì¡°íšŒ
    const query = `
      SELECT 
        attendance_date,
        status
      FROM attendance
      WHERE student_id = ?
        AND attendance_date >= ?
        AND attendance_date <= ?
      ORDER BY attendance_date ASC
    `
    
    const result = await c.env.DB.prepare(query)
      .bind(studentId, startDate, endDate)
      .all()
    
    const attendanceRecords = result.results || []
    
    // ì¶œì„ í†µê³„ ê³„ì‚°
    let attendedDays = 0
    let absentDays = 0
    let lateDays = 0
    let earlyLeaveDays = 0
    
    attendanceRecords.forEach(record => {
      if (record.status === 'ì¶œì„') attendedDays++
      else if (record.status === 'ê²°ì„') absentDays++
      else if (record.status === 'ì§€ê°') lateDays++
      else if (record.status === 'ì¡°í‡´') earlyLeaveDays++
    })
    
    const totalDays = attendanceRecords.length
    const attendanceRate = totalDays > 0 
      ? Math.round((attendedDays / totalDays) * 100) 
      : 0
    
    console.log('âœ… [GetAttendance] Found', totalDays, 'records')
    console.log('   ì¶œì„:', attendedDays, 'ê²°ì„:', absentDays, 'ì§€ê°:', lateDays)
    
    return c.json({
      success: true,
      data: {
        records: attendanceRecords,
        summary: {
          totalDays,
          attendedDays,
          absentDays,
          lateDays,
          earlyLeaveDays,
          attendanceRate
        }
      }
    })
    
  } catch (error) {
    console.error('âŒ [GetAttendance] Error:', error)
    return c.json({ 
      success: false, 
      error: 'ì¶œì„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ' + error.message 
    }, 500)
  }
})

// ğŸ“Š í•™ìƒ í•™ìŠµ ì„±ê³¼ ë°ì´í„° ì¡°íšŒ API (ì´í•´ë„, ì°¸ì—¬ë„)
app.get('/api/students/:studentId/performance', async (c) => {
  try {
    const studentId = c.req.param('studentId')
    const startDate = c.req.query('startDate') // YYYY-MM-DD í˜•ì‹
    const endDate = c.req.query('endDate') // YYYY-MM-DD í˜•ì‹
    
    if (!c.env.DB) {
      return c.json({ success: false, error: 'DB ì—°ê²° ì‹¤íŒ¨' }, 500)
    }
    
    if (!studentId || !startDate || !endDate) {
      return c.json({ 
        success: false, 
        error: 'í•™ìƒ ID, ì‹œì‘ì¼, ì¢…ë£Œì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.' 
      }, 400)
    }
    
    console.log('ğŸ“Š [GetPerformance] Student:', studentId, 'Period:', startDate, '-', endDate)
    
    // daily_recordsì—ì„œ ì´í•´ë„ì™€ ì°¸ì—¬ë„ ë°ì´í„° ì¡°íšŒ
    const query = `
      SELECT 
        record_date,
        attendance,
        understanding_level,
        participation_level,
        homework_status,
        achievement,
        memo
      FROM daily_records
      WHERE student_id = ?
        AND record_date >= ?
        AND record_date <= ?
      ORDER BY record_date ASC
    `
    
    const result = await c.env.DB.prepare(query)
      .bind(studentId, startDate, endDate)
      .all()
    
    const records = result.results || []
    
    // í†µê³„ ê³„ì‚°
    let totalUnderstanding = 0
    let totalParticipation = 0
    let countUnderstanding = 0
    let countParticipation = 0
    let homeworkCompleted = 0
    let homeworkTotal = 0
    
    records.forEach(record => {
      if (record.understanding_level) {
        totalUnderstanding += record.understanding_level
        countUnderstanding++
      }
      if (record.participation_level) {
        totalParticipation += record.participation_level
        countParticipation++
      }
      if (record.homework_status) {
        homeworkTotal++
        if (record.homework_status === 'ì™„ë£Œ') homeworkCompleted++
      }
    })
    
    const avgUnderstanding = countUnderstanding > 0 
      ? (totalUnderstanding / countUnderstanding).toFixed(1)
      : 0
    
    const avgParticipation = countParticipation > 0 
      ? (totalParticipation / countParticipation).toFixed(1)
      : 0
    
    const homeworkRate = homeworkTotal > 0
      ? Math.round((homeworkCompleted / homeworkTotal) * 100)
      : 0
    
    console.log('âœ… [GetPerformance] Found', records.length, 'records')
    console.log('   í‰ê·  ì´í•´ë„:', avgUnderstanding, 'í‰ê·  ì°¸ì—¬ë„:', avgParticipation)
    
    return c.json({
      success: true,
      data: {
        records,
        summary: {
          avgUnderstanding: parseFloat(avgUnderstanding),
          avgParticipation: parseFloat(avgParticipation),
          homeworkRate,
          totalRecords: records.length
        }
      }
    })
    
  } catch (error) {
    console.error('âŒ [GetPerformance] Error:', error)
    return c.json({ 
      success: false, 
      error: 'ì„±ê³¼ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ' + error.message 
    }, 500)
  }
})

// ğŸ” DB ë””ë²„ê·¸ API - ì‹¤ì œ DB ìƒíƒœ í™•ì¸
app.get('/api/debug/db-status', async (c) => {
  try {
    console.log('ğŸ” [DebugDB] Checking database status...')
    
    // 1. ëª¨ë“  ì‚¬ìš©ì ì¡°íšŒ
    const users = await c.env.DB.prepare(
      'SELECT id, email, name, user_type, academy_id, parent_user_id FROM users'
    ).all()
    
    // 2. ëª¨ë“  í•™ìƒ ì¡°íšŒ
    const students = await c.env.DB.prepare(
      'SELECT id, academy_id, name, class_id FROM students LIMIT 100'
    ).all()
    
    // 3. ëª¨ë“  ë°˜ ì¡°íšŒ
    const classes = await c.env.DB.prepare(
      'SELECT id, academy_id, class_name FROM classes'
    ).all()
    
    // 4. academy_idë³„ í†µê³„
    const studentsByAcademy = await c.env.DB.prepare(
      'SELECT academy_id, COUNT(*) as count FROM students GROUP BY academy_id'
    ).all()
    
    const classesByAcademy = await c.env.DB.prepare(
      'SELECT academy_id, COUNT(*) as count FROM classes GROUP BY academy_id'
    ).all()
    
    console.log('ğŸ“Š [DebugDB] Users:', users.results?.length || 0)
    console.log('ğŸ“Š [DebugDB] Students:', students.results?.length || 0)
    console.log('ğŸ“Š [DebugDB] Classes:', classes.results?.length || 0)
    
    return c.json({
      success: true,
      users: users.results || [],
      students: students.results || [],
      classes: classes.results || [],
      studentsByAcademy: studentsByAcademy.results || [],
      classesByAcademy: classesByAcademy.results || []
    })
  } catch (error) {
    console.error('âŒ [DebugDB] Error:', error)
    return c.json({ 
      success: false, 
      error: error.message 
    }, 500)
  }
})

// ğŸ” íŠ¹ì • ì´ë©”ì¼ ì‚¬ìš©ì ë””ë²„ê·¸ API
app.get('/api/debug/user-by-email', async (c) => {
  try {
    const email = c.req.query('email')
    
    if (!email) {
      return c.json({ success: false, error: 'Email parameter required' }, 400)
    }
    
    console.log('ğŸ” [DebugUser] Looking up user:', email)
    
    // ì‚¬ìš©ì ì¡°íšŒ
    const user = await c.env.DB.prepare(
      'SELECT id, email, name, user_type, academy_id, parent_user_id, role FROM users WHERE email = ?'
    ).bind(email).first()
    
    if (!user) {
      return c.json({ success: false, error: 'User not found' }, 404)
    }
    
    console.log('ğŸ‘¤ [DebugUser] Found user:', user)
    
    // í•´ë‹¹ academy_idì˜ í•™ìƒ ìˆ˜
    const studentCount = await c.env.DB.prepare(
      'SELECT COUNT(*) as count FROM students WHERE academy_id = ? AND status = \'active\''
    ).bind(user.academy_id || user.id).first()
    
    // í•´ë‹¹ academy_idì˜ ë°˜ ìˆ˜
    const classCount = await c.env.DB.prepare(
      'SELECT COUNT(*) as count FROM classes WHERE academy_id = ?'
    ).bind(user.academy_id || user.id).first()
    
    // ìƒ˜í”Œ í•™ìƒ ë°ì´í„°
    const sampleStudents = await c.env.DB.prepare(
      'SELECT id, name, academy_id, class_id FROM students WHERE academy_id = ? LIMIT 5'
    ).bind(user.academy_id || user.id).all()
    
    // ìƒ˜í”Œ ë°˜ ë°ì´í„°
    const sampleClasses = await c.env.DB.prepare(
      'SELECT id, class_name, academy_id FROM classes WHERE academy_id = ? LIMIT 5'
    ).bind(user.academy_id || user.id).all()
    
    return c.json({
      success: true,
      user: user,
      stats: {
        studentCount: studentCount?.count || 0,
        classCount: classCount?.count || 0
      },
      sampleStudents: sampleStudents.results || [],
      sampleClasses: sampleClasses.results || []
    })
  } catch (error) {
    console.error('âŒ [DebugUser] Error:', error)
    return c.json({ 
      success: false, 
      error: error.message 
    }, 500)
  }
})

// ğŸ”§ ì‚¬ìš©ì íƒ€ì… ë³€ê²½ API (ë””ë²„ê¹…ìš©)
app.post('/api/debug/fix-user-type', async (c) => {
  try {
    const { email, userType } = await c.req.json()
    
    if (!email || !userType) {
      return c.json({ success: false, error: 'Email and userType required' }, 400)
    }
    
    console.log('ğŸ”§ [FixUserType] Updating user:', email, 'to:', userType)
    
    // ì‚¬ìš©ì ì—…ë°ì´íŠ¸
    const result = await c.env.DB.prepare(
      'UPDATE users SET user_type = ? WHERE email = ?'
    ).bind(userType, email).run()
    
    if (result.meta.changes === 0) {
      return c.json({ success: false, error: 'User not found or not updated' }, 404)
    }
    
    // ì—…ë°ì´íŠ¸ëœ ì‚¬ìš©ì ì¡°íšŒ
    const updatedUser = await c.env.DB.prepare(
      'SELECT id, email, name, user_type, academy_id FROM users WHERE email = ?'
    ).bind(email).first()
    
    console.log('âœ… [FixUserType] Updated user:', updatedUser)
    
    return c.json({
      success: true,
      message: 'User type updated successfully',
      user: updatedUser
    })
  } catch (error) {
    console.error('âŒ [FixUserType] Error:', error)
    return c.json({ 
      success: false, 
      error: error.message 
    }, 500)
  }
})

// ğŸ”§ academy_id ìˆ˜ì • API (ë””ë²„ê¹…ìš©)
app.post('/api/debug/fix-academy-id', async (c) => {
  try {
    const { email, academyId } = await c.req.json()
    
    if (!email || !academyId) {
      return c.json({ success: false, error: 'Email and academyId required' }, 400)
    }
    
    console.log('ğŸ”§ [FixAcademyId] Updating user:', email, 'academy_id to:', academyId)
    
    // ì‚¬ìš©ì ì—…ë°ì´íŠ¸
    const result = await c.env.DB.prepare(
      'UPDATE users SET academy_id = ? WHERE email = ?'
    ).bind(academyId, email).run()
    
    if (result.meta.changes === 0) {
      return c.json({ success: false, error: 'User not found or not updated' }, 404)
    }
    
    // ì—…ë°ì´íŠ¸ëœ ì‚¬ìš©ì ì¡°íšŒ
    const updatedUser = await c.env.DB.prepare(
      'SELECT id, email, name, user_type, academy_id, parent_user_id FROM users WHERE email = ?'
    ).bind(email).first()
    
    console.log('âœ… [FixAcademyId] Updated user:', updatedUser)
    
    return c.json({
      success: true,
      message: 'Academy ID updated successfully',
      user: updatedUser
    })
  } catch (error) {
    console.error('âŒ [FixAcademyId] Error:', error)
    return c.json({ 
      success: false, 
      error: error.message 
    }, 500)
  }
})

// ğŸ”§ Debug API - í•™ìƒ ëŒ€ëŸ‰ ì‚­ì œ (ì´ë¦„ ê¸°ë°˜)
app.post('/api/debug/delete-students-by-name', async (c) => {
  try {
    const { academyId, names } = await c.req.json()
    
    if (!academyId || !names || !Array.isArray(names)) {
      return c.json({ success: false, error: 'academyId and names array required' }, 400)
    }
    
    console.log('ğŸ—‘ï¸ [DeleteStudentsByName] Deleting students:', { academyId, names })
    
    // ê° ì´ë¦„ì— ëŒ€í•´ ì‚­ì œ ì²˜ë¦¬
    const results = []
    for (const name of names) {
      const result = await c.env.DB.prepare(
        "UPDATE students SET status = 'deleted', updated_at = CURRENT_TIMESTAMP WHERE academy_id = ? AND name = ?"
      ).bind(academyId, name).run()
      
      results.push({
        name,
        changes: result.meta.changes,
        success: result.meta.changes > 0
      })
    }
    
    console.log('âœ… [DeleteStudentsByName] Results:', results)
    
    return c.json({
      success: true,
      message: 'Students deleted',
      results
    })
  } catch (error) {
    console.error('âŒ [DeleteStudentsByName] Error:', error)
    return c.json({ 
      success: false, 
      error: error.message 
    }, 500)
  }
})

// âœ… ë°ì´í„° ì´ˆê¸°í™” API - í•™ìƒ/ë°˜ ë°ì´í„° ìë™ ìƒì„±
app.post('/api/init-test-data', async (c) => {
  try {
    console.log('ğŸš€ [InitTestData] Starting test data initialization...')
    
    const data = await c.req.json()
    const { academyId } = data
    
    if (!academyId) {
      return c.json({ success: false, error: 'academyId is required' }, 400)
    }
    
    console.log('ğŸš€ [InitTestData] Creating test data for academy_id:', academyId)
    
    // 1. ë°˜ ë°ì´í„° ìƒì„± (5ê°œ)
    const classNames = ['ì¤‘1 ìˆ˜í•™', 'ì¤‘2 ì˜ì–´', 'ì¤‘3 ê³¼í•™', 'ê³ 1 êµ­ì–´', 'ê³ 2 ìˆ˜í•™']
    const classIds = []
    
    for (const className of classNames) {
      // ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
      const existing = await c.env.DB.prepare(
        'SELECT id FROM classes WHERE academy_id = ? AND class_name = ?'
      ).bind(academyId, className).first()
      
      if (!existing) {
        const result = await c.env.DB.prepare(`
          INSERT INTO classes (academy_id, class_name, grade, description, created_at) 
          VALUES (?, ?, ?, ?, datetime('now'))
        `).bind(
          academyId,
          className,
          className.includes('ì¤‘') ? className.substring(0, 2) : className.substring(0, 2),
          `${className} ìˆ˜ì—…`,
        ).run()
        
        classIds.push(result.meta.last_row_id)
        console.log('âœ… [InitTestData] Created class:', className, 'ID:', result.meta.last_row_id)
      } else {
        classIds.push(existing.id)
        console.log('âœ… [InitTestData] Class already exists:', className, 'ID:', existing.id)
      }
    }
    
    // 2. í•™ìƒ ë°ì´í„° ìƒì„± (ê° ë°˜ì— 10ëª…ì”©, ì´ 50ëª…)
    let totalStudents = 0
    const studentNames = [
      'ê¹€ë¯¼ì¤€', 'ì´ì„œì—°', 'ë°•ì§€ìš°', 'ìµœìˆ˜ì•„', 'ì •ì˜ˆì¤€',
      'ê°•í•˜ì€', 'ì¡°ë¯¼ì„œ', 'ìœ¤ì‹œìš°', 'ì¥ì„œì¤€', 'ì„ìœ ë‚˜'
    ]
    
    for (let classIdx = 0; classIdx < classIds.length; classIdx++) {
      const classId = classIds[classIdx]
      
      for (let i = 0; i < 10; i++) {
        const name = `${studentNames[i]} (${classNames[classIdx]})`
        
        // ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        const existing = await c.env.DB.prepare(
          'SELECT id FROM students WHERE academy_id = ? AND name = ?'
        ).bind(academyId, name).first()
        
        if (!existing) {
          await c.env.DB.prepare(`
            INSERT INTO students (
              academy_id, name, phone, parent_name, parent_phone, 
              grade, class_id, enrollment_date, status, created_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'active', datetime('now'))
          `).bind(
            academyId,
            name,
            `010-1234-${String(classIdx * 10 + i).padStart(4, '0')}`,
            `${studentNames[i]} í•™ë¶€ëª¨`,
            `010-5678-${String(classIdx * 10 + i).padStart(4, '0')}`,
            classNames[classIdx].includes('ì¤‘') ? classNames[classIdx].substring(0, 2) : classNames[classIdx].substring(0, 2),
            classId,
            new Date().toISOString().split('T')[0]
          ).run()
          
          totalStudents++
        }
      }
    }
    
    console.log('ğŸ‰ [InitTestData] Test data created successfully!')
    console.log('ğŸ“Š [InitTestData] Total classes:', classIds.length)
    console.log('ğŸ“Š [InitTestData] Total new students:', totalStudents)
    
    return c.json({ 
      success: true, 
      message: `í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ! (ë°˜: ${classIds.length}ê°œ, í•™ìƒ: ${totalStudents}ëª…)`,
      classes: classIds.length,
      students: totalStudents
    })
  } catch (error) {
    console.error('âŒ [InitTestData] Error:', error)
    return c.json({ 
      success: false, 
      error: 'í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì‹¤íŒ¨: ' + error.message 
    }, 500)
  }
})

// í•™ìƒ ì¶”ê°€
app.post('/api/students', async (c) => {
  try {
    console.log('â• [AddStudent] ==================== START ====================')
    
    // DB ì—°ê²° í™•ì¸
    if (!c.env.DB) {
      console.error('âŒ [AddStudent] DB not available')
      return c.json({ success: false, error: 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨' }, 500)
    }
    console.log('âœ… [AddStudent] DB connected')
    
    const data = await c.req.json()
    console.log('â• [AddStudent] Received data:', JSON.stringify(data, null, 2))
    
    const { 
      name, phone, grade, subjects, school,
      parent_name, parentName,
      parent_phone, parentPhone,
      notes, memo,
      classId, class_id,
      enrollmentDate, enrollment_date,
      academyId
    } = data
    
    // academyId ê²°ì •
    let finalAcademyId = academyId || data.academyId
    
    // í—¤ë”ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
    try {
      const userHeader = c.req.header('X-User-Data-Base64')
      if (userHeader && !finalAcademyId) {
        const userData = JSON.parse(decodeURIComponent(escape(atob(userHeader))))
        finalAcademyId = userData.id || userData.academy_id
        console.log('â• [AddStudent] Academy ID from header:', finalAcademyId)
      }
    } catch (err) {
      console.error('â• [AddStudent] Header parse error:', err)
    }
    
    // í•„ë“œëª… í†µì¼ (camelCaseì™€ snake_case ëª¨ë‘ ì§€ì›)
    const finalParentName = parentName || parent_name
    const finalParentPhone = parentPhone || parent_phone
    const finalNotes = memo || notes
    const finalClassId = classId || class_id
    const finalEnrollmentDate = enrollmentDate || enrollment_date || new Date().toISOString().split('T')[0]
    
    console.log('â• [AddStudent] Final values:', {
      name,
      grade,
      finalParentName,
      finalParentPhone,
      finalAcademyId,
      finalClassId
    })
    
    // í•„ìˆ˜ í•­ëª© í™•ì¸
    if (!name || !grade || !finalParentName || !finalParentPhone) {
      return c.json({ 
        success: false, 
        error: 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì´ë¦„, í•™ë…„, í•™ë¶€ëª¨ ì´ë¦„, í•™ë¶€ëª¨ ì—°ë½ì²˜)' 
      }, 400)
    }
    
    if (!finalAcademyId) {
      return c.json({ success: false, error: 'í•™ì› IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // âœ… í•™ìƒ ìˆ˜ í•œë„ ì²´í¬
    console.log('ğŸ” [AddStudent] Checking student limit...')
    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(finalAcademyId).first()

    if (!subscription) {
      return c.json({ 
        success: false, 
        error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤. ìš”ê¸ˆì œë¥¼ êµ¬ë§¤í•´ì£¼ì„¸ìš”.' 
      }, 403)
    }

    const usage = await c.env.DB.prepare(`
      SELECT * FROM usage_tracking 
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(finalAcademyId, subscription.id).first()

    const currentStudents = usage?.current_students || 0
    if (currentStudents >= subscription.student_limit) {
      return c.json({ 
        success: false, 
        error: `â›” ì‚¬ìš© í•œë„ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.\n\ní˜„ì¬ í•™ìƒ ìˆ˜: ${currentStudents}ëª… / í•œë„: ${subscription.student_limit}ëª…\n\në” ë§ì€ í•™ìƒì„ ë“±ë¡í•˜ì‹œë ¤ë©´ ìƒìœ„ í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•´ì£¼ì„¸ìš”.` 
      }, 403)
    }
    console.log(`âœ… [AddStudent] Limit check passed: ${currentStudents}/${subscription.student_limit}`)
    
    // ê°€ì¥ ê¸°ë³¸ì ì¸ ì»¬ëŸ¼ë§Œ ì‚¬ìš© (enrollment_date ëŒ€ì‹  created_at ì‚¬ìš©)
    let result
    try {
      // ë¨¼ì € ê¸°ë³¸ ì»¬ëŸ¼ë§Œìœ¼ë¡œ ì‹œë„
      result = await c.env.DB.prepare(`
        INSERT INTO students (
          name, phone, grade, subjects, school, parent_name, parent_phone, 
          academy_id, class_id, notes, status, created_at
        )
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', datetime('now'))
      `).bind(
        name, 
        phone || null, 
        grade, 
        subjects || '', 
        school || null,
        finalParentName, 
        finalParentPhone, 
        finalAcademyId, 
        finalClassId || null,
        finalNotes || null
      ).run()
    } catch (err1) {
      console.error('â• [AddStudent] First attempt failed:', err1.message)
      
      // enrollment_date ì»¬ëŸ¼ì´ ìˆëŠ” ê²½ìš° ì‹œë„
      try {
        result = await c.env.DB.prepare(`
          INSERT INTO students (
            name, phone, grade, subjects, school, parent_name, parent_phone, 
            academy_id, enrollment_date, notes, status, class_id
          )
          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', ?)
        `).bind(
          name, 
          phone || null, 
          grade, 
          subjects || '', 
          school || null,
          finalParentName, 
          finalParentPhone, 
          finalAcademyId, 
          finalEnrollmentDate,
          finalNotes || null,
          finalClassId || null
        ).run()
      } catch (err2) {
        console.error('â• [AddStudent] Second attempt failed:', err2.message)
        
        // ê°€ì¥ ìµœì†Œí•œì˜ ì»¬ëŸ¼ë§Œ ì‚¬ìš© (school ì œì™¸)
        result = await c.env.DB.prepare(`
          INSERT INTO students (
            name, grade, parent_name, parent_phone, academy_id, status
          )
          VALUES (?, ?, ?, ?, ?, 'active')
        `).bind(
          name, 
          grade, 
          finalParentName, 
          finalParentPhone, 
          finalAcademyId
        ).run()
        
        // class_idë¥¼ ë³„ë„ë¡œ ì—…ë°ì´íŠ¸
        if (finalClassId && result.meta.last_row_id) {
          try {
            await c.env.DB.prepare(
              'UPDATE students SET class_id = ? WHERE id = ?'
            ).bind(finalClassId, result.meta.last_row_id).run()
          } catch (err3) {
            console.error('â• [AddStudent] Class ID update failed:', err3.message)
          }
        }
      }
    }
    
    const studentId = result.meta.last_row_id
    console.log('âœ… [AddStudent] Success! Student ID:', studentId)
    console.log('âœ… [AddStudent] Changes:', result.meta.changes)
    
    // ì¶”ê°€ëœ í•™ìƒì„ ë‹¤ì‹œ ì¡°íšŒí•´ì„œ í™•ì¸
    try {
      const verifyResult = await c.env.DB.prepare(
        'SELECT id, name, grade, academy_id FROM students WHERE id = ?'
      ).bind(studentId).first()
      console.log('âœ… [AddStudent] Verified student:', verifyResult)
    } catch (verifyErr) {
      console.error('âš ï¸ [AddStudent] Verification failed:', verifyErr.message)
    }
    
    console.log('â• [AddStudent] ==================== END ====================')
    
    // âœ… ì‚¬ìš©ëŸ‰ ì¦ê°€
    try {
      await c.env.DB.prepare(`
        UPDATE usage_tracking 
        SET current_students = current_students + 1, updated_at = CURRENT_TIMESTAMP
        WHERE academy_id = ? AND subscription_id = ?
      `).bind(finalAcademyId, subscription.id).run()
      console.log('ğŸ“ˆ [AddStudent] Usage incremented successfully')
    } catch (usageErr) {
      console.error('âš ï¸ [AddStudent] Failed to increment usage:', usageErr)
    }
    
    return c.json({ 
      success: true, 
      message: 'í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 
      id: studentId 
    })
  } catch (err) {
    console.error('â• [AddStudent] Error:', err)
    console.error('â• [AddStudent] Stack:', err.stack)
    return c.json({ 
      success: false, 
      error: `í•™ìƒ ì¶”ê°€ ì‹¤íŒ¨: ${err.message || err}` 
    }, 500)
  }
})



// DELETE /api/students/:id - í•™ìƒ ì‚­ì œ (Soft Delete)
app.delete('/api/students/:id', async (c) => {
  try {
    const studentId = c.req.param('id')
    
    console.log('[DeleteStudent] ğŸ—‘ï¸ Starting deletion for student:', studentId)
    
    if (!studentId) {
      return c.json({ success: false, error: 'í•™ìƒ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // ğŸ”’ ë³´ì•ˆ 1ë‹¨ê³„: X-User-Data-Base64 í—¤ë”ì—ì„œ academy_id ì¶”ì¶œ
    let academyId
    let userData
    try {
      const userHeader = c.req.header('X-User-Data-Base64')
      console.log('[DeleteStudent] ğŸ“¡ User header exists:', !!userHeader)
      console.log('[DeleteStudent] ğŸ“¡ User header length:', userHeader?.length)
      
      if (!userHeader) {
        console.error('[DeleteStudent] âŒ No X-User-Data-Base64 header found')
        return c.json({ success: false, error: 'ì¸ì¦ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.' }, 401)
      }
      
      // Base64 ë””ì½”ë”© - ë‹¤ë¥¸ APIì™€ ë™ì¼í•œ ë°©ì‹ ì‚¬ìš©
      const decoded = atob(userHeader)
      console.log('[DeleteStudent] ğŸ”“ Decoded length:', decoded.length)
      
      // JSON íŒŒì‹±
      userData = JSON.parse(decoded)
      console.log('[DeleteStudent] ğŸ‘¤ Parsed user data:', {
        id: userData.id,
        academy_id: userData.academy_id,
        user_type: userData.user_type,
        email: userData.email
      })
      
      academyId = userData.academy_id || userData.id
      console.log('[DeleteStudent] ğŸ« Extracted academy ID:', academyId)
      
    } catch (err) {
      console.error('[DeleteStudent] âŒ Failed to parse user header:', err)
      console.error('[DeleteStudent] âŒ Error stack:', err.stack)
      return c.json({ 
        success: false, 
        error: 'ì¸ì¦ ì •ë³´ íŒŒì‹± ì‹¤íŒ¨. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.',
        details: err.message 
      }, 400)
    }
    
    if (!academyId) {
      console.error('[DeleteStudent] âŒ No academy ID in user data:', userData)
      return c.json({ success: false, error: 'í•™ì› IDê°€ í•„ìš”í•©ë‹ˆë‹¤. ì‚¬ìš©ì ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.' }, 400)
    }
    
    console.log('[DeleteStudent] Soft deleting student:', studentId, 'academy:', academyId)
    
    // ğŸ”’ ë³´ì•ˆ 2ë‹¨ê³„: í•´ë‹¹ í•™ìƒì´ í˜„ì¬ ì‚¬ìš©ìì˜ í•™ì› ì†Œì†ì¸ì§€ í™•ì¸
    const studentCheck = await c.env.DB.prepare(`
      SELECT id, academy_id FROM students WHERE id = ?
    `).bind(studentId).first()
    
    if (!studentCheck) {
      return c.json({ 
        success: false, 
        error: 'í•´ë‹¹ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' 
      }, 404)
    }
    
    if (studentCheck.academy_id !== academyId) {
      console.error('[DeleteStudent] Security breach attempt:', {
        studentId,
        studentAcademyId: studentCheck.academy_id,
        userAcademyId: academyId
      })
      return c.json({ success: false, error: 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
    }
    
    // ğŸ”’ ë³´ì•ˆ 3ë‹¨ê³„: academy_id ì¡°ê±´ ì¶”ê°€í•˜ì—¬ ì´ì¤‘ í™•ì¸
    const result = await c.env.DB.prepare(`
      UPDATE students 
      SET status = 'deleted', updated_at = CURRENT_TIMESTAMP
      WHERE id = ? AND academy_id = ?
    `).bind(studentId, academyId).run()
    
    if (result.meta.changes === 0) {
      return c.json({ 
        success: false, 
        error: 'í•™ìƒ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' 
      }, 400)
    }
    
    console.log('[DeleteStudent] Successfully soft deleted student')
    return c.json({ 
      success: true, 
      message: 'í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' 
    })
  } catch (error) {
    console.error('[DeleteStudent] Error:', error)
    return c.json({ 
      success: false, 
      error: 'í•™ìƒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    }, 500)
  }
})

// í•™ìƒ ì •ë³´ ìˆ˜ì •
app.put('/api/students/:id', async (c) => {
  try {
    const studentId = c.req.param('id')
    const data = await c.req.json()
    
    console.log('âœï¸ [UpdateStudent] Updating student:', studentId)
    console.log('âœï¸ [UpdateStudent] Data:', data)
    
    const { 
      name, phone, grade, subjects, school,
      parentName, parentPhone,
      classId, enrollmentDate, memo
    } = data
    
    // í•„ìˆ˜ í•­ëª© í™•ì¸
    if (!name || !grade || !parentName || !parentPhone) {
      return c.json({ 
        success: false, 
        error: 'í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì´ë¦„, í•™ë…„, í•™ë¶€ëª¨ ì´ë¦„, í•™ë¶€ëª¨ ì—°ë½ì²˜)' 
      }, 400)
    }
    
    // UPDATE ì¿¼ë¦¬ (ê°€ëŠ¥í•œ ëª¨ë“  í•„ë“œ ì—…ë°ì´íŠ¸)
    try {
      const result = await c.env.DB.prepare(`
        UPDATE students 
        SET name = ?, phone = ?, grade = ?, subjects = ?, school = ?,
            parent_name = ?, parent_phone = ?, class_id = ?, 
            enrollment_date = ?, notes = ?
        WHERE id = ?
      `).bind(
        name,
        phone || null,
        grade,
        subjects || '',
        school || null,
        parentName,
        parentPhone,
        classId || null,
        enrollmentDate || null,
        memo || null,
        studentId
      ).run()
      
      console.log('âœ… [UpdateStudent] Updated rows:', result.meta.changes)
      
      if (result.meta.changes === 0) {
        return c.json({ success: false, error: 'í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
      }
      
      return c.json({ 
        success: true, 
        message: 'í•™ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.',
        id: studentId
      })
      
    } catch (err) {
      console.error('âŒ [UpdateStudent] Error:', err)
      return c.json({ 
        success: false, 
        error: 'í•™ìƒ ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        details: err.message 
      }, 500)
    }
    
  } catch (error) {
    console.error('âŒ [UpdateStudent] Fatal error:', error)
    return c.json({ 
      success: false, 
      error: 'í•™ìƒ ì •ë³´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' 
    }, 500)
  }
})

// í•™ìƒ ê´€ë¦¬ í˜ì´ì§€ (ë¦¬ë‹¤ì´ë ‰íŠ¸)
app.get('/tools/student-management', (c) => {
  return c.redirect('/students')
})

// AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ í˜ì´ì§€ - trailing slash redirect
app.get('/tools/ai-learning-report/', (c) => c.redirect('/tools/ai-learning-report', 301));

// AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ í˜ì´ì§€
app.get('/tools/ai-learning-report', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen">
        <div class="max-w-7xl mx-auto p-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">ğŸ¤– AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
                <a href="/dashboard" class="px-6 py-3 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition">
                    ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                </a>
            </div>

            <!-- ì•ˆë‚´ ì¹´ë“œ -->
            <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-2xl p-8 text-white mb-8">
                <h2 class="text-2xl font-bold mb-4">âœ¨ AIê°€ ìë™ìœ¼ë¡œ í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤</h2>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                        <div class="text-3xl mb-2">ğŸ“Š</div>
                        <div class="font-bold mb-1">ì„±ì  ë¶„ì„</div>
                        <div class="text-sm text-white/90">ê³¼ëª©ë³„ ì„±ì  ì¶”ì´ì™€ ê°•ì•½ì  íŒŒì•…</div>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                        <div class="text-3xl mb-2">ğŸ“ˆ</div>
                        <div class="font-bold mb-1">í•™ìŠµ íŒ¨í„´</div>
                        <div class="text-sm text-white/90">ì¶œì„ë¥ , í•™ìŠµ íƒœë„ ì¢…í•© ë¶„ì„</div>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm rounded-xl p-4">
                        <div class="text-3xl mb-2">ğŸ’¡</div>
                        <div class="font-bold mb-1">ë§ì¶¤ ì¶”ì²œ</div>
                        <div class="text-sm text-white/90">ê°œì¸ë³„ í•™ìŠµ ì „ëµ ì œì‹œ</div>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš©ëŸ‰ í‘œì‹œ ë°°ë„ˆ (ìƒˆë¡œ ì¶”ê°€) -->
            <div id="usageBanner" class="bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl p-6 mb-8 text-white hidden">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center flex-shrink-0">
                            <span class="text-3xl">ğŸ¤–</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-1">ì´ë²ˆ ë‹¬ AI ë¦¬í¬íŠ¸ ì‚¬ìš©ëŸ‰</h3>
                            <p class="text-white/90 text-sm">ì•„ë˜ ì‚¬ìš©ëŸ‰ì„ í™•ì¸í•˜ê³  ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                    <div class="bg-white/20 backdrop-blur-sm rounded-xl px-6 py-4">
                        <div class="text-sm text-white/80 mb-1">ì‚¬ìš© í˜„í™©</div>
                        <div class="text-3xl font-bold">
                            <span id="currentReportUsage">-</span> / <span id="maxReportLimit">-</span>
                        </div>
                        <div class="w-48 bg-white/20 rounded-full h-2 mt-3">
                            <div id="reportUsageBar" class="bg-white h-2 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í´ë” ê´€ë¦¬ ì„¹ì…˜ -->
            <div class="bg-white rounded-2xl p-8 border border-gray-200 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ğŸ“ ë¦¬í¬íŠ¸ í´ë”</h2>
                    <button onclick="showCreateFolderModal()" class="px-4 py-2 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition">
                        + ìƒˆ í´ë”
                    </button>
                </div>
                
                <div id="foldersList" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <p class="text-gray-500 col-span-full text-center py-8">í´ë”ë¥¼ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- ë¦¬í¬íŠ¸ ìƒì„± ì„¹ì…˜ -->
            <div class="bg-white rounded-2xl p-8 border border-gray-200 mb-8">
                <h2 class="text-2xl font-bold mb-6">ğŸ“ ë¦¬í¬íŠ¸ ìƒì„±</h2>
                
                <div class="grid md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì €ì¥í•  í´ë”</label>
                        <select id="folderSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">í´ë” ì„ íƒ (ì„ íƒì‚¬í•­)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">í•™ìƒ ì„ íƒ</label>
                        <select id="studentSelect" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì‹œì‘ ë‚ ì§œ</label>
                        <input type="date" id="startDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì¢…ë£Œ ë‚ ì§œ</label>
                        <input type="date" id="endDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>

                <button onclick="generateReport()" class="w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-bold text-lg hover:from-purple-700 hover:to-pink-700 transition-all">
                    ğŸ¤– AI ë¦¬í¬íŠ¸ ìë™ ìƒì„±
                </button>

                <div id="generateResult" class="mt-4"></div>
            </div>

            <!-- ìƒì„±ëœ ë¦¬í¬íŠ¸ ëª©ë¡ -->
            <div class="bg-white rounded-2xl p-8 border border-gray-200">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">ğŸ“š ìƒì„±ëœ ë¦¬í¬íŠ¸</h2>
                    <select id="filterFolder" onchange="filterReportsByFolder()" class="px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500">
                        <option value="">ì „ì²´ í´ë”</option>
                    </select>
                </div>
                <div id="reportsList" class="space-y-4">
                    <p class="text-gray-500 text-center py-12">ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- í´ë” ìƒì„± ëª¨ë‹¬ -->
            <div id="folderModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl max-w-md w-full p-6">
                    <h3 class="text-xl font-bold mb-4">ìƒˆ í´ë” ë§Œë“¤ê¸°</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í´ë” ì´ë¦„</label>
                            <input type="text" id="folderName" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500" placeholder="ì˜ˆ: 2024ë…„ 1í•™ê¸°">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì„¤ëª… (ì„ íƒì‚¬í•­)</label>
                            <textarea id="folderDescription" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500" placeholder="í´ë” ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í´ë” ìƒ‰ìƒ</label>
                            <div class="grid grid-cols-6 gap-2">
                                <button onclick="selectFolderColor('#6366f1')" class="w-10 h-10 rounded-lg bg-indigo-500 hover:ring-2 ring-indigo-600" data-color="#6366f1"></button>
                                <button onclick="selectFolderColor('#8b5cf6')" class="w-10 h-10 rounded-lg bg-purple-500 hover:ring-2 ring-purple-600" data-color="#8b5cf6"></button>
                                <button onclick="selectFolderColor('#ec4899')" class="w-10 h-10 rounded-lg bg-pink-500 hover:ring-2 ring-pink-600" data-color="#ec4899"></button>
                                <button onclick="selectFolderColor('#f43f5e')" class="w-10 h-10 rounded-lg bg-rose-500 hover:ring-2 ring-rose-600" data-color="#f43f5e"></button>
                                <button onclick="selectFolderColor('#10b981')" class="w-10 h-10 rounded-lg bg-emerald-500 hover:ring-2 ring-emerald-600" data-color="#10b981"></button>
                                <button onclick="selectFolderColor('#06b6d4')" class="w-10 h-10 rounded-lg bg-cyan-500 hover:ring-2 ring-cyan-600" data-color="#06b6d4"></button>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="selectedColor" value="#6366f1">
                    <div class="flex space-x-3 mt-6">
                        <button onclick="createFolder()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition">
                            ìƒì„±
                        </button>
                        <button onclick="closeFolderModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 transition">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ë¦¬í¬íŠ¸ ìƒì„¸ ëª¨ë‹¬ -->
            <div id="reportModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
                        <h3 class="text-2xl font-bold">í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</h3>
                        <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="reportDetail" class="p-6"></div>
                </div>
            </div>

            <!-- ë¦¬í¬íŠ¸ ìˆ˜ì • ëª¨ë‹¬ -->
            <div id="editReportModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
                        <h3 class="text-2xl font-bold">ğŸ“ ë¦¬í¬íŠ¸ ìˆ˜ì •</h3>
                        <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div id="editReportDetail" class="p-6"></div>
                </div>
            </div>
        </div>

        <script>
            let currentUser = null;
            let folders = [];
            let allReports = [];

            // ë¡œê·¸ì¸ ì²´í¬
            window.addEventListener('DOMContentLoaded', () => {
                const userData = localStorage.getItem('user');
                if (!userData) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }
                currentUser = JSON.parse(userData);
                loadUsage();
                loadFolders();
                loadStudents();
                setDefaultMonth();
            });

            // ì‚¬ìš©ëŸ‰ ë¡œë“œ í•¨ìˆ˜
            async function loadUsage() {
                try {
                    const response = await fetch('/api/usage/check', {
                        method: 'GET',
                        credentials: 'include'
                    });
                    const data = await response.json();
                    
                    if (data.success && data.limits && data.usage) {
                        const currentUsage = data.usage.aiReports || 0;
                        const maxLimit = data.limits.aiReports || 0;
                        const percentage = maxLimit > 0 ? Math.min((currentUsage / maxLimit) * 100, 100) : 0;
                        
                        // ë°°ë„ˆ í‘œì‹œ
                        const usageBanner = document.getElementById('usageBanner');
                        if (usageBanner) {
                            usageBanner.classList.remove('hidden');
                            document.getElementById('currentReportUsage').textContent = currentUsage;
                            document.getElementById('maxReportLimit').textContent = maxLimit;
                            document.getElementById('reportUsageBar').style.width = percentage + '%';
                            
                            // í•œë„ ì´ˆê³¼ ì‹œ ê²½ê³  ìƒ‰ìƒ
                            if (currentUsage >= maxLimit) {
                                usageBanner.className = 'bg-gradient-to-r from-red-500 to-orange-500 rounded-2xl p-6 mb-8 text-white';
                            } else if (percentage >= 80) {
                                usageBanner.className = 'bg-gradient-to-r from-orange-500 to-yellow-500 rounded-2xl p-6 mb-8 text-white';
                            }
                        }
                    }
                } catch (err) {
                    console.error('ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì‹¤íŒ¨:', err);
                }
            }

            // í´ë” ëª©ë¡ ë¡œë“œ
            async function loadFolders() {
                try {
                    const response = await fetch(\`/api/report-folders?academyId=\${currentUser.id}\`);
                    const data = await response.json();
                    
                    if (data.success && data.folders) {
                        folders = data.folders;
                        renderFolders();
                        updateFolderSelects();
                    }
                } catch (err) {
                    console.error('í´ë” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
                }
            }

            // í´ë” ë Œë”ë§
            function renderFolders() {
                const container = document.getElementById('foldersList');
                if (folders.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">í´ë”ë¥¼ ìƒì„±í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
                    return;
                }

                container.innerHTML = folders.map(folder => \`
                    <div class="p-4 rounded-xl border-2 hover:shadow-lg transition cursor-pointer group" 
                         style="border-color: \${folder.color}20; background: \${folder.color}10;"
                         onclick="filterByFolder(\${folder.id})">
                        <div class="flex items-center space-x-3 mb-2">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white text-xl" 
                                 style="background: \${folder.color};">
                                ğŸ“
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-gray-900">\${folder.folder_name}</div>
                                <div class="text-xs text-gray-500">\${folder.description || ''}</div>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteFolder(\${folder.id})" 
                                class="text-xs text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition">
                            ì‚­ì œ
                        </button>
                    </div>
                \`).join('');
            }

            // í´ë” ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
            function updateFolderSelects() {
                const folderSelect = document.getElementById('folderSelect');
                const filterFolder = document.getElementById('filterFolder');
                
                const folderOptions = folders.map(f => \`<option value="\${f.id}">\${f.folder_name}</option>\`).join('');
                
                folderSelect.innerHTML = '<option value="">í´ë” ì„ íƒ (ì„ íƒì‚¬í•­)</option>' + folderOptions;
                filterFolder.innerHTML = '<option value="">ì „ì²´ í´ë”</option>' + folderOptions;
            }

            // í´ë” ìƒì„± ëª¨ë‹¬ ì—´ê¸°
            function showCreateFolderModal() {
                document.getElementById('folderModal').classList.remove('hidden');
            }

            // í´ë” ìƒì„± ëª¨ë‹¬ ë‹«ê¸°
            function closeFolderModal() {
                document.getElementById('folderModal').classList.add('hidden');
                document.getElementById('folderName').value = '';
                document.getElementById('folderDescription').value = '';
            }

            // í´ë” ìƒ‰ìƒ ì„ íƒ
            function selectFolderColor(color) {
                document.getElementById('selectedColor').value = color;
                document.querySelectorAll('[data-color]').forEach(btn => {
                    btn.classList.remove('ring-2');
                });
                event.target.classList.add('ring-2');
            }

            // í´ë” ìƒì„±
            async function createFolder() {
                const folderName = document.getElementById('folderName').value.trim();
                const description = document.getElementById('folderDescription').value.trim();
                const color = document.getElementById('selectedColor').value;

                if (!folderName) {
                    alert('í´ë” ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    const response = await fetch('/api/report-folders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            academyId: currentUser.id,
                            folderName,
                            description,
                            color
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        closeFolderModal();
                        loadFolders();
                        alert('í´ë”ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('í´ë” ìƒì„± ì‹¤íŒ¨: ' + data.error);
                    }
                } catch (err) {
                    console.error('í´ë” ìƒì„± ì‹¤íŒ¨:', err);
                    alert('í´ë” ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // í´ë” ì‚­ì œ
            async function deleteFolder(folderId) {
                if (!confirm('ì´ í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í´ë” ë‚´ ë¦¬í¬íŠ¸ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) {
                    return;
                }

                try {
                    const response = await fetch(\`/api/report-folders/\${folderId}\`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    if (data.success) {
                        loadFolders();
                        alert('í´ë”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (err) {
                    console.error('í´ë” ì‚­ì œ ì‹¤íŒ¨:', err);
                }
            }

            // í´ë”ë³„ í•„í„°ë§
            function filterByFolder(folderId) {
                document.getElementById('filterFolder').value = folderId;
                filterReportsByFolder();
            }

            function filterReportsByFolder() {
                const folderId = document.getElementById('filterFolder').value;
                // ë¦¬í¬íŠ¸ ëª©ë¡ì„ folderIdë¡œ í•„í„°ë§í•˜ì—¬ í‘œì‹œ
                // loadReportsForStudent í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬
            }

            // ê¸°ë³¸ ì›” ì„¤ì • (ì´ë²ˆ ë‹¬)
            function setDefaultMonth() {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                
                // ì´ë²ˆ ë‹¬ 1ì¼
                const startDate = new Date(year, month, 1);
                const startDateStr = startDate.toISOString().split('T')[0];
                
                // ì´ë²ˆ ë‹¬ ë§ˆì§€ë§‰ ë‚ 
                const endDate = new Date(year, month + 1, 0);
                const endDateStr = endDate.toISOString().split('T')[0];
                
                const startInput = document.getElementById('startDate');
                const endInput = document.getElementById('endDate');
                
                if (startInput) startInput.value = startDateStr;
                if (endInput) endInput.value = endDateStr;
            }

            // í•™ìƒ ëª©ë¡ ë¡œë“œ
            // í•™ë…„ ì •ë ¬ í•¨ìˆ˜
            function sortByGrade(students) {
                const gradeOrder = {
                    'ì´ˆ1': 1, 'ì´ˆ2': 2, 'ì´ˆ3': 3, 'ì´ˆ4': 4, 'ì´ˆ5': 5, 'ì´ˆ6': 6,
                    'ì¤‘1': 7, 'ì¤‘2': 8, 'ì¤‘3': 9,
                    'ê³ 1': 10, 'ê³ 2': 11, 'ê³ 3': 12
                };
                
                return students.sort((a, b) => {
                    const orderA = gradeOrder[a.grade] || 999;
                    const orderB = gradeOrder[b.grade] || 999;
                    
                    if (orderA !== orderB) {
                        return orderA - orderB;
                    }
                    
                    // ê°™ì€ í•™ë…„ì´ë©´ ì´ë¦„ìˆœ
                    return a.name.localeCompare(b.name, 'ko');
                });
            }

            async function loadStudents() {
                try {
                    console.log('ğŸ‘¥ [LoadStudents] Starting to load students...');
                    
                    const userDataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(currentUser))));
                    const response = await fetch('/api/students', {
                        headers: {
                            'X-User-Data-Base64': userDataBase64
                        }
                    });
                    const data = await response.json();
                    
                    console.log('ğŸ‘¥ [LoadStudents] Response:', data.success, 'Students count:', data.students?.length);
                    
                    const select = document.getElementById('studentSelect');
                    select.innerHTML = '<option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    
                    if (data.success && data.students && data.students.length > 0) {
                        // í•™ë…„ë³„ë¡œ ì •ë ¬
                        const sortedStudents = sortByGrade([...data.students]);
                        
                        console.log('ğŸ‘¥ [LoadStudents] Sorted students:', sortedStudents.length);
                        
                        // ì •ë ¬ëœ í•™ìƒ ëª©ë¡ í‘œì‹œ
                        sortedStudents.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.textContent = \`\${student.name} (\${student.grade})\`;
                            select.appendChild(option);
                        });
                        
                        console.log('âœ… [LoadStudents] Students loaded successfully');
                    } else {
                        console.warn('âš ï¸ [LoadStudents] No students found');
                        select.innerHTML += '<option disabled>ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤</option>';
                    }
                } catch (err) {
                    console.error('âŒ [LoadStudents] Error:', err);
                    console.error('âŒ [LoadStudents] Error message:', err.message);
                    console.error('âŒ [LoadStudents] Error stack:', err.stack);
                }
            }

            // AI ë¦¬í¬íŠ¸ ìƒì„±
            async function generateReport() {
                const studentId = document.getElementById('studentSelect').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const folderId = document.getElementById('folderSelect').value;
                const resultDiv = document.getElementById('generateResult');

                if (!studentId) {
                    resultDiv.innerHTML = '<div class="p-4 bg-red-50 text-red-600 rounded-xl">í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
                    return;
                }

                if (!startDate || !endDate) {
                    resultDiv.innerHTML = '<div class="p-4 bg-red-50 text-red-600 rounded-xl">ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
                    return;
                }

                if (new Date(startDate) > new Date(endDate)) {
                    resultDiv.innerHTML = '<div class="p-4 bg-red-50 text-red-600 rounded-xl">ì‹œì‘ ë‚ ì§œëŠ” ì¢…ë£Œ ë‚ ì§œë³´ë‹¤ ì´ì „ì´ì–´ì•¼ í•©ë‹ˆë‹¤.</div>';
                    return;
                }

                resultDiv.innerHTML = '<div class="p-4 bg-blue-50 text-blue-600 rounded-xl">ğŸ¤– AIê°€ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>';

                try {
                    const response = await fetch('/api/learning-reports/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            student_id: studentId,
                            start_date: startDate,
                            end_date: endDate,
                            folder_id: folderId || null
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        resultDiv.innerHTML = \`
                            <div class="p-6 bg-green-50 border-2 border-green-200 rounded-xl">
                                <div class="text-green-600 font-bold text-lg mb-3">âœ… AI ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ!</div>
                                <div class="grid grid-cols-3 gap-4 text-sm">
                                    <div>
                                        <div class="text-gray-600 mb-1">í‰ê·  ì ìˆ˜</div>
                                        <div class="text-2xl font-bold text-green-600">\${data.preview.overall_score}ì </div>
                                    </div>
                                    <div>
                                        <div class="text-gray-600 mb-1">ì¶œì„ë¥ </div>
                                        <div class="text-2xl font-bold text-blue-600">\${data.preview.attendance_rate}%</div>
                                    </div>
                                    <div>
                                        <div class="text-gray-600 mb-1">í•™ìŠµ íƒœë„</div>
                                        <div class="text-2xl font-bold text-purple-600">\${data.preview.study_attitude}</div>
                                    </div>
                                </div>
                                <button onclick="viewReport(\${data.report_id})" class="mt-4 w-full px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 transition">
                                    ğŸ“„ ë¦¬í¬íŠ¸ ìì„¸íˆ ë³´ê¸°
                                </button>
                            </div>
                        \`;
                        loadReportsForStudent(studentId);
                    } else {
                        resultDiv.innerHTML = \`
                            <div class="p-6 bg-red-50 border-2 border-red-200 rounded-xl">
                                <div class="text-red-600 font-bold text-lg mb-3">âŒ AI ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨</div>
                                <div class="text-gray-700 whitespace-pre-line">\${data.error}</div>
                            </div>
                        \`;
                    }
                } catch (err) {
                    console.error('ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨:', err);
                    resultDiv.innerHTML = '<div class="p-4 bg-red-50 text-red-600 rounded-xl">ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                }
            }

            // í•™ìƒë³„ ë¦¬í¬íŠ¸ ëª©ë¡ ë¡œë“œ
            async function loadReportsForStudent(studentId) {
                try {
                    const response = await fetch(\`/api/learning-reports/\${studentId}\`);
                    const data = await response.json();

                    const listDiv = document.getElementById('reportsList');
                    
                    if (data.success && data.reports && data.reports.length > 0) {
                        listDiv.innerHTML = data.reports.map(report => \`
                            <div class="p-6 border-2 border-gray-200 rounded-xl hover:border-purple-400 transition">
                                <div class="flex justify-between items-start mb-4">
                                    <div onclick="viewReport(\${report.id})" class="cursor-pointer flex-1">
                                        <div class="text-lg font-bold text-gray-900">\${report.report_month} ë¦¬í¬íŠ¸</div>
                                        <div class="text-sm text-gray-600">\${new Date(report.created_at).toLocaleDateString('ko-KR')}</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">\${report.study_attitude}</span>
                                        <button onclick="event.stopPropagation(); editReport(\${report.id})" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition text-sm">
                                            <i class="fas fa-edit"></i> ìˆ˜ì •
                                        </button>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm" onclick="viewReport(\${report.id})" class="cursor-pointer">
                                    <div class="text-gray-600">í‰ê·  ì ìˆ˜: <span class="font-bold text-gray-900">\${report.overall_score}ì </span></div>
                                    <div class="text-gray-600">ìƒì„±ì¼: <span class="font-bold text-gray-900">\${new Date(report.created_at).toLocaleDateString('ko-KR')}</span></div>
                                </div>
                            </div>
                        \`).join('');
                    } else {
                        listDiv.innerHTML = \`
                            <div class="text-center py-12 bg-gray-50 rounded-xl">
                                <div class="text-6xl mb-4">ğŸ“‹</div>
                                <div class="text-xl font-bold text-gray-900 mb-2">ìƒì„±ëœ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                                <div class="text-gray-600">í•™ìƒê³¼ ë¦¬í¬íŠ¸ ì›”ì„ ì„ íƒí•œ í›„ 'ë¦¬í¬íŠ¸ ìƒì„±í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
                            </div>
                        \`;
                    }
                } catch (err) {
                    console.error('ë¦¬í¬íŠ¸ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
                }
            }

            // ë¦¬í¬íŠ¸ ìƒì„¸ ë³´ê¸°
            async function viewReport(reportId) {
                try {
                    const response = await fetch(\`/api/learning-reports/detail/\${reportId}\`);
                    const data = await response.json();

                    if (data.success && data.report) {
                        const report = data.report;
                        document.getElementById('reportDetail').innerHTML = \`
                            <div class="space-y-6">
                                <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-xl">
                                    <div class="text-sm text-gray-600 mb-2">\${report.report_month}</div>
                                    <div class="text-2xl font-bold text-gray-900 mb-2">\${report.student_name} í•™ìƒ í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</div>
                                    <div class="flex gap-4 text-sm">
                                        <span class="px-3 py-1 bg-purple-500 text-white rounded-full">\${report.study_attitude}</span>
                                        <span class="px-3 py-1 bg-pink-500 text-white rounded-full">í‰ê·  \${report.overall_score}ì </span>
                                    </div>
                                </div>

                                <div class="border-l-4 border-green-500 pl-4">
                                    <div class="text-sm text-gray-600 mb-1">ğŸ’ª ê°•ì </div>
                                    <div class="text-gray-900">\${report.strengths}</div>
                                </div>

                                <div class="border-l-4 border-yellow-500 pl-4">
                                    <div class="text-sm text-gray-600 mb-1">ğŸ¯ ê°œì„  í•„ìš”</div>
                                    <div class="text-gray-900">\${report.weaknesses}</div>
                                </div>

                                <div class="border-l-4 border-blue-500 pl-4">
                                    <div class="text-sm text-gray-600 mb-1">ğŸ“ ê°œì„ ì‚¬í•­</div>
                                    <div class="text-gray-900">\${report.improvements}</div>
                                </div>

                                <div class="border-l-4 border-purple-500 pl-4">
                                    <div class="text-sm text-gray-600 mb-1">ğŸ’¡ ì„ ìƒë‹˜ì˜ ì¶”ì²œ</div>
                                    <div class="text-gray-900">\${report.recommendations}</div>
                                </div>

                                <div class="border-l-4 border-pink-500 pl-4">
                                    <div class="text-sm text-gray-600 mb-1">ğŸ¯ ë‹¤ìŒ ë‹¬ ëª©í‘œ</div>
                                    <div class="text-gray-900">\${report.next_month_goals}</div>
                                </div>

                                <div class="bg-gray-50 p-6 rounded-xl">
                                    <div class="text-sm text-gray-600 mb-2">ğŸ¤– AI ì¢…í•© ë¶„ì„</div>
                                    <div class="text-gray-900 whitespace-pre-line">\${report.ai_analysis}</div>
                                </div>

                                <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-xl border-2 border-purple-200">
                                    <div class="text-sm text-gray-600 mb-2">ğŸ’Œ í•™ë¶€ëª¨ë‹˜ê»˜ ë³´ë‚¼ ë©”ì‹œì§€</div>
                                    <div id="parentMessage\${report.id}" class="text-gray-900 whitespace-pre-line text-sm leading-relaxed">\${report.parent_message}</div>
                                    <button onclick="copyMessageById('parentMessage\${report.id}')" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition">
                                        ğŸ“‹ ë©”ì‹œì§€ ë³µì‚¬í•˜ê¸°
                                    </button>
                                </div>
                            </div>
                        \`;
                        document.getElementById('reportModal').classList.remove('hidden');
                    }
                } catch (err) {
                    console.error('ë¦¬í¬íŠ¸ ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', err);
                    alert('ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ë¦¬í¬íŠ¸ ìˆ˜ì •
            async function editReport(reportId) {
                try {
                    const response = await fetch(\`/api/learning-reports/detail/\${reportId}\`);
                    const data = await response.json();

                    if (data.success && data.report) {
                        const report = data.report;
                        document.getElementById('editReportDetail').innerHTML = \`
                            <div class="space-y-6">
                                <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-6 rounded-xl">
                                    <div class="text-sm text-gray-600 mb-2">\${report.report_month}</div>
                                    <div class="text-2xl font-bold text-gray-900 mb-2">\${report.student_name} í•™ìƒ í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ ìˆ˜ì •</div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">í‰ê·  ì ìˆ˜</label>
                                    <input type="number" id="edit_overall_score" value="\${report.overall_score}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" step="0.1">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">í•™ìŠµ íƒœë„</label>
                                    <select id="edit_study_attitude" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                        <option value="ë§¤ìš° ìš°ìˆ˜" \${report.study_attitude === 'ë§¤ìš° ìš°ìˆ˜' ? 'selected' : ''}>ë§¤ìš° ìš°ìˆ˜</option>
                                        <option value="ìš°ìˆ˜" \${report.study_attitude === 'ìš°ìˆ˜' ? 'selected' : ''}>ìš°ìˆ˜</option>
                                        <option value="ì–‘í˜¸" \${report.study_attitude === 'ì–‘í˜¸' ? 'selected' : ''}>ì–‘í˜¸</option>
                                        <option value="ê°œì„  í•„ìš”" \${report.study_attitude === 'ê°œì„  í•„ìš”' ? 'selected' : ''}>ê°œì„  í•„ìš”</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’ª ê°•ì </label>
                                    <textarea id="edit_strengths" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg">\${report.strengths}</textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¯ ì•½ì </label>
                                    <textarea id="edit_weaknesses" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg">\${report.weaknesses}</textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ ê°œì„ ì‚¬í•­</label>
                                    <textarea id="edit_improvements" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg">\${report.improvements}</textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’¡ ì¶”ì²œì‚¬í•­</label>
                                    <textarea id="edit_recommendations" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg">\${report.recommendations}</textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¯ ë‹¤ìŒ ë‹¬ ëª©í‘œ</label>
                                    <textarea id="edit_next_month_goals" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg">\${report.next_month_goals}</textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¤– AI ì¢…í•© ë¶„ì„</label>
                                    <textarea id="edit_ai_analysis" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg">\${report.ai_analysis}</textarea>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’Œ í•™ë¶€ëª¨ë‹˜ê»˜ ë³´ë‚¼ ë©”ì‹œì§€</label>
                                    <textarea id="edit_parent_message" rows="8" class="w-full px-4 py-2 border border-gray-300 rounded-lg">\${report.parent_message}</textarea>
                                </div>

                                <div class="flex gap-3">
                                    <button onclick="saveReport(\${reportId})" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-bold">
                                        ğŸ’¾ ì €ì¥í•˜ê¸°
                                    </button>
                                    <button onclick="closeEditModal()" class="px-6 py-3 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 transition font-bold">
                                        ì·¨ì†Œ
                                    </button>
                                </div>
                            </div>
                        \`;
                        document.getElementById('editReportModal').classList.remove('hidden');
                    }
                } catch (err) {
                    console.error('ë¦¬í¬íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', err);
                    alert('ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ë¦¬í¬íŠ¸ ì €ì¥
            async function saveReport(reportId) {
                try {
                    const payload = {
                        overall_score: parseFloat(document.getElementById('edit_overall_score').value),
                        study_attitude: document.getElementById('edit_study_attitude').value,
                        strengths: document.getElementById('edit_strengths').value,
                        weaknesses: document.getElementById('edit_weaknesses').value,
                        improvements: document.getElementById('edit_improvements').value,
                        recommendations: document.getElementById('edit_recommendations').value,
                        next_month_goals: document.getElementById('edit_next_month_goals').value,
                        ai_analysis: document.getElementById('edit_ai_analysis').value,
                        parent_message: document.getElementById('edit_parent_message').value
                    };

                    const response = await fetch(\`/api/learning-reports/\${reportId}\`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('ë¦¬í¬íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        closeEditModal();
                        const studentId = document.getElementById('studentSelect').value;
                        if (studentId) {
                            loadReportsForStudent(studentId);
                        }
                    } else {
                        alert('ì €ì¥ ì‹¤íŒ¨: ' + data.error);
                    }
                } catch (err) {
                    console.error('ë¦¬í¬íŠ¸ ì €ì¥ ì‹¤íŒ¨:', err);
                    alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
            function closeEditModal() {
                document.getElementById('editReportModal').classList.add('hidden');
            }

            // ëª¨ë‹¬ ë‹«ê¸°
            function closeModal() {
                document.getElementById('reportModal').classList.add('hidden');
            }

            // ë©”ì‹œì§€ ë³µì‚¬
            function copyMessageById(elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    const message = element.textContent;
                    navigator.clipboard.writeText(message).then(() => {
                        alert('ë©”ì‹œì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }).catch(err => {
                        console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                    });
                }
            }
        </script>
    </body>
    </html>
  `)
})

// ê²€ìƒ‰ëŸ‰ ì¡°íšŒ í˜ì´ì§€ - trailing slash redirect
app.get('/tools/search-volume/', (c) => c.redirect('/tools/search-volume', 301));

// ê²€ìƒ‰ëŸ‰ ì¡°íšŒ í˜ì´ì§€
app.get('/tools/search-volume', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê²€ìƒ‰ëŸ‰ ì¡°íšŒ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="max-w-7xl mx-auto p-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">ğŸ” ê²€ìƒ‰ëŸ‰ ì¡°íšŒ</h1>
                <a href="/dashboard" class="px-6 py-3 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition">
                    ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                </a>
            </div>

            <!-- ê²€ìƒ‰ ì…ë ¥ ì„¹ì…˜ -->
            <div class="bg-white rounded-2xl p-8 shadow-lg mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">í‚¤ì›Œë“œ ë¶„ì„</h2>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë¶„ì„ í‚¤ì›Œë“œ</label>
                        <input type="text" id="keyword" placeholder="ì˜ˆ: ì¸ì²œì˜ì–´í•™ì›" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="text-sm text-red-600 font-bold mt-2">âš ï¸ ì¤‘ìš”: ë„ì–´ì“°ê¸° ì—†ì´ ì…ë ¥í•´ì£¼ì„¸ìš”! (ì˜ˆ: ê²€ë‹¨ì˜ì–´í•™ì› â­• / ê²€ë‹¨ ì˜ì–´í•™ì› âŒ)</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ URL (ì„ íƒ)</label>
                        <input type="text" id="placeUrl" placeholder="https://m.place.naver.com/..." 
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-2">â€» ë³¸ì¸ í•™ì›ì˜ ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ URLì„ ì…ë ¥í•˜ë©´ ìˆœìœ„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                    </div>

                    <button onclick="analyzeKeyword()" 
                            class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white px-8 py-4 rounded-xl hover:from-purple-700 hover:to-purple-800 transition-all shadow-lg hover:shadow-xl font-bold text-lg">
                        ğŸ” ë¶„ì„ ì‹œì‘
                    </button>
                </div>
            </div>

            <!-- ë¡œë”© ìƒíƒœ -->
            <div id="loading" class="hidden bg-white rounded-2xl p-12 shadow-lg text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
                <p class="text-gray-600 text-lg">ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                <p class="text-gray-500 text-sm mt-2">ë„¤ì´ë²„ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
            </div>

            <!-- ê²€ìƒ‰ëŸ‰ ê²°ê³¼ -->
            <div id="searchVolumeResult" class="hidden bg-white rounded-2xl p-8 shadow-lg mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“Š ê²€ìƒ‰ëŸ‰ ë¶„ì„ ê²°ê³¼</h2>
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                        <div class="text-sm text-blue-700 mb-2">ì›” í‰ê·  ê²€ìƒ‰ëŸ‰</div>
                        <div class="text-4xl font-bold text-blue-900" id="monthlyVolume">-</div>
                        <div class="text-xs text-blue-600 mt-2" id="searchDetails">PC: - / ëª¨ë°”ì¼: -</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                        <div class="text-sm text-green-700 mb-2">ê²½ìŸ ê°•ë„</div>
                        <div class="text-4xl font-bold text-green-900" id="competition">-</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
                        <div class="text-sm text-purple-700 mb-2">ì¶”ì²œë„</div>
                        <div class="text-4xl font-bold text-purple-900" id="recommendation">-</div>
                    </div>
                </div>
                
                <!-- í´ë¦­ë¥  ì •ë³´ -->
                <div class="bg-yellow-50 rounded-xl p-6 border border-yellow-200">
                    <h3 class="text-lg font-bold text-yellow-900 mb-4">ğŸ–±ï¸ í‰ê·  í´ë¦­ë¥  (CTR)</h3>
                    <div class="grid md:grid-cols-3 gap-4">
                        <div>
                            <div class="text-sm text-yellow-700 mb-1">ì „ì²´ í‰ê· </div>
                            <div class="text-2xl font-bold text-yellow-900" id="averageCtr">-</div>
                        </div>
                        <div>
                            <div class="text-sm text-yellow-700 mb-1">PC í´ë¦­ë¥ </div>
                            <div class="text-2xl font-bold text-yellow-900" id="pcCtr">-</div>
                        </div>
                        <div>
                            <div class="text-sm text-yellow-700 mb-1">ëª¨ë°”ì¼ í´ë¦­ë¥ </div>
                            <div class="text-2xl font-bold text-yellow-900" id="mobileCtr">-</div>
                        </div>
                    </div>
                    <p class="text-xs text-yellow-700 mt-3">ğŸ’¡ í´ë¦­ë¥ ì´ ë†’ì„ìˆ˜ë¡ ê´‘ê³  íš¨ê³¼ê°€ ì¢‹ìŠµë‹ˆë‹¤</p>
                </div>
            </div>

            <!-- ê´€ë ¨ í‚¤ì›Œë“œ ê²°ê³¼ -->
            <div id="relatedKeywordsResult" class="hidden bg-white rounded-2xl p-8 shadow-lg mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ”‘ ê´€ë ¨ í‚¤ì›Œë“œ TOP 10</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left p-3 text-gray-700 font-bold">ìˆœìœ„</th>
                                <th class="text-left p-3 text-gray-700 font-bold">í‚¤ì›Œë“œ</th>
                                <th class="text-right p-3 text-gray-700 font-bold">ì›” ê²€ìƒ‰ëŸ‰</th>
                                <th class="text-right p-3 text-gray-700 font-bold">í‰ê·  CTR</th>
                                <th class="text-center p-3 text-gray-700 font-bold">ê²½ìŸë„</th>
                            </tr>
                        </thead>
                        <tbody id="relatedKeywordsList">
                            <!-- ê´€ë ¨ í‚¤ì›Œë“œ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>
            </div>

            <!-- ìˆœìœ„ ê²°ê³¼ -->
            <div id="rankingResult" class="hidden bg-white rounded-2xl p-8 shadow-lg mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ† í”Œë ˆì´ìŠ¤ ìˆœìœ„</h2>
                <div class="bg-gradient-to-r from-purple-600 to-purple-700 rounded-xl p-6 text-white mb-6">
                    <div class="text-lg mb-2">ë‚´ ìˆœìœ„ (ê´‘ê³  ì œì™¸)</div>
                    <div class="text-5xl font-bold" id="myRanking">-</div>
                </div>
                
                <h3 class="text-xl font-bold text-gray-900 mb-4">ê²½ìŸì‚¬ ìˆœìœ„</h3>
                <div id="competitorList" class="space-y-3">
                    <!-- ê²½ìŸì‚¬ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- í‚¤ì›Œë“œ ë¶„ì„ ê²°ê³¼ -->
            <div id="keywordResult" class="hidden bg-white rounded-2xl p-8 shadow-lg">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ·ï¸ ê²½ìŸì‚¬ í‚¤ì›Œë“œ ë¶„ì„</h2>
                <div id="competitorKeywords" class="grid md:grid-cols-2 gap-6">
                    <!-- í‚¤ì›Œë“œ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mt-8">
                <h3 class="text-lg font-bold text-yellow-900 mb-3">âš ï¸ ì‚¬ìš© ì•ˆë‚´</h3>
                <ul class="space-y-2 text-yellow-800 text-sm">
                    <li>â€¢ ê²€ìƒ‰ëŸ‰ ë°ì´í„°ëŠ” ë„¤ì´ë²„ ê´‘ê³  APIë¥¼ í†µí•´ ì œê³µë©ë‹ˆë‹¤</li>
                    <li>â€¢ ìˆœìœ„ ì¡°íšŒëŠ” ì‹¤ì‹œê°„ í¬ë¡¤ë§ìœ¼ë¡œ ì§„í–‰ë˜ë©°, 2-3ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                    <li>â€¢ ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´ ì •í™•í•œ í”Œë ˆì´ìŠ¤ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”</li>
                    <li>â€¢ ì¼ì¼ ì¡°íšŒ í•œë„: 100íšŒ (í¬ì¸íŠ¸ ì°¨ê° ì—†ìŒ)</li>
                </ul>
            </div>
        </div>

        <script>
            async function analyzeKeyword() {
                const keyword = document.getElementById('keyword').value.trim();
                const placeUrl = document.getElementById('placeUrl').value.trim();

                if (!keyword) {
                    alert('ë¶„ì„í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                // placeUrlì€ ì„ íƒì‚¬í•­ìœ¼ë¡œ ë³€ê²½

                // ë¡œë”© í‘œì‹œ
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('searchVolumeResult').classList.add('hidden');
                document.getElementById('relatedKeywordsResult').classList.add('hidden');
                document.getElementById('rankingResult').classList.add('hidden');
                document.getElementById('keywordResult').classList.add('hidden');

                try {
                    const user = JSON.parse(localStorage.getItem('user'));
                    
                    const response = await fetch('/api/search-analysis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: user?.id,
                            keyword: keyword,
                            placeUrl: placeUrl
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // ê²€ìƒ‰ëŸ‰ ê²°ê³¼ í‘œì‹œ (ê¸°ë³¸)
                        document.getElementById('monthlyVolume').textContent = 
                            data.searchVolume?.monthlyAvg?.toLocaleString() || 'ì§‘ê³„ì¤‘';
                        document.getElementById('competition').textContent = 
                            data.searchVolume?.competition || 'ë³´í†µ';
                        document.getElementById('recommendation').textContent = 
                            data.searchVolume?.recommendation || 'ë¶„ì„ì¤‘';
                        
                        // í™•ì¥ ë°ì´í„° í‘œì‹œ (CTR í¬í•¨)
                        if (data.searchVolumeExtended) {
                            const ext = data.searchVolumeExtended;
                            const pcSearch = ext.monthlyPcSearch?.toLocaleString() || 0;
                            const mobileSearch = ext.monthlyMobileSearch?.toLocaleString() || 0;
                            document.getElementById('searchDetails').textContent = 
                                'PC: ' + pcSearch + ' / ëª¨ë°”ì¼: ' + mobileSearch;
                            document.getElementById('averageCtr').textContent = 
                                ((ext.averageCtr || 0) * 100).toFixed(2) + '%';
                            document.getElementById('pcCtr').textContent = 
                                ((ext.pcCtr || 0) * 100).toFixed(2) + '%';
                            document.getElementById('mobileCtr').textContent = 
                                ((ext.mobileCtr || 0) * 100).toFixed(2) + '%';
                        }
                        
                        document.getElementById('searchVolumeResult').classList.remove('hidden');
                        
                        // ê´€ë ¨ í‚¤ì›Œë“œ í‘œì‹œ
                        if (data.relatedKeywords && data.relatedKeywords.length > 0) {
                            const keywordsHtml = data.relatedKeywords.map((kw, idx) => {
                                const compClass = kw.competition === 'ë‚®ìŒ' ? 'bg-green-100 text-green-700' :
                                                 kw.competition === 'ë³´í†µ' ? 'bg-yellow-100 text-yellow-700' :
                                                 kw.competition === 'ë†’ìŒ' ? 'bg-orange-100 text-orange-700' :
                                                 'bg-red-100 text-red-700';
                                return '<tr class="border-b border-gray-100 hover:bg-gray-50">' +
                                    '<td class="p-3 text-gray-600 font-bold">' + (idx + 1) + '</td>' +
                                    '<td class="p-3 text-gray-900 font-medium">' + kw.keyword + '</td>' +
                                    '<td class="p-3 text-right text-blue-600 font-bold">' + (kw.monthlySearchVolume?.toLocaleString() || 0) + '</td>' +
                                    '<td class="p-3 text-right text-green-600 font-bold">' + ((kw.averageCtr || 0) * 100).toFixed(2) + '%</td>' +
                                    '<td class="p-3 text-center">' +
                                    '<span class="px-3 py-1 rounded-full text-xs font-bold ' + compClass + '">' + kw.competition + '</span>' +
                                    '</td>' +
                                    '</tr>';
                            }).join('');
                            document.getElementById('relatedKeywordsList').innerHTML = keywordsHtml;
                            document.getElementById('relatedKeywordsResult').classList.remove('hidden');
                        }

                        // ìˆœìœ„ ê²°ê³¼ í‘œì‹œ
                        if (data.ranking) {
                            document.getElementById('myRanking').textContent = 
                                data.ranking.myRank ? data.ranking.myRank + 'ìœ„' : 'ìˆœìœ„ê¶Œ ë°–';
                            
                            // ê²½ìŸì‚¬ ëª©ë¡ í‘œì‹œ
                            const competitorHtml = data.ranking.competitors.map((comp, idx) => \`
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-200">
                                    <div class="flex items-center gap-4">
                                        <div class="text-2xl font-bold text-gray-400">\${idx + 1}</div>
                                        <div>
                                            <div class="font-bold text-gray-900">\${comp.name}</div>
                                            <div class="text-sm text-gray-600">\${comp.category || 'ì—…ì¢… ì •ë³´ ì—†ìŒ'}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-600">ë¦¬ë·°</div>
                                        <div class="font-bold text-gray-900">\${comp.reviewCount || 0}ê°œ</div>
                                    </div>
                                </div>
                            \`).join('');
                            document.getElementById('competitorList').innerHTML = competitorHtml;
                            document.getElementById('rankingResult').classList.remove('hidden');
                        }

                        // í‚¤ì›Œë“œ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
                        if (data.keywords && data.keywords.length > 0) {
                            const keywordHtml = data.keywords.map(item => \`
                                <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                                    <div class="font-bold text-gray-900 mb-3">\${item.businessName}</div>
                                    <div class="flex flex-wrap gap-2">
                                        \${item.keywords.map(kw => \`
                                            <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm">
                                                \${kw}
                                            </span>
                                        \`).join('')}
                                    </div>
                                </div>
                            \`).join('');
                            document.getElementById('competitorKeywords').innerHTML = keywordHtml;
                            document.getElementById('keywordResult').classList.remove('hidden');
                        }
                    } else {
                        alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (err) {
                    console.error('ë¶„ì„ ì˜¤ë¥˜:', err);
                    alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                }
            }

            // ì—”í„° í‚¤ë¡œ ê²€ìƒ‰
            document.getElementById('keyword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') analyzeKeyword();
            });
            document.getElementById('placeUrl').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') analyzeKeyword();
            });
        </script>
    </body>
    </html>
  `)
})

// í†µí•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ í˜ì´ì§€
app.get('/tools/dashboard-analytics', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í†µí•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body class="bg-gradient-to-br from-teal-50 to-blue-50 min-h-screen">
        <div class="max-w-7xl mx-auto p-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-bold text-gray-900">ğŸ“Š í†µí•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h1>
                <a href="/dashboard" class="px-6 py-3 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition">
                    ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                </a>
            </div>

            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-2xl p-6 border-2 border-green-200">
                    <div class="text-sm text-gray-600 mb-2">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div>
                    <div class="text-3xl font-bold text-green-600">â‚©0</div>
                </div>
                <div class="bg-white rounded-2xl p-6 border-2 border-blue-200">
                    <div class="text-sm text-gray-600 mb-2">ì‹ ê·œ í•™ìƒ</div>
                    <div class="text-3xl font-bold text-blue-600">0ëª…</div>
                </div>
                <div class="bg-white rounded-2xl p-6 border-2 border-purple-200">
                    <div class="text-sm text-gray-600 mb-2">ì „ì²´ í•™ìƒ</div>
                    <div class="text-3xl font-bold text-purple-600">0ëª…</div>
                </div>
                <div class="bg-white rounded-2xl p-6 border-2 border-orange-200">
                    <div class="text-sm text-gray-600 mb-2">í‰ê·  ì¶œì„ë¥ </div>
                    <div class="text-3xl font-bold text-orange-600">0%</div>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl p-8 border border-gray-200">
                    <h2 class="text-xl font-bold mb-4">ì›”ë³„ ë§¤ì¶œ ì¶”ì´</h2>
                    <canvas id="revenueChart" height="200"></canvas>
                </div>

                <div class="bg-white rounded-2xl p-8 border border-gray-200">
                    <h2 class="text-xl font-bold mb-4">í•™ìƒ í˜„í™©</h2>
                    <canvas id="studentChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <script>
            // ë§¤ì¶œ ì¶”ì´ ì°¨íŠ¸
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”'],
                    datasets: [{
                        label: 'ë§¤ì¶œ (ë§Œì›)',
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });

            // í•™ìƒ í˜„í™© ì°¨íŠ¸
            const studentCtx = document.getElementById('studentChart').getContext('2d');
            new Chart(studentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ìˆ˜ê°• ì¤‘', 'ì¼ì‹œì •ì§€', 'ì¡¸ì—…'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgb(34, 197, 94)',
                            'rgb(234, 179, 8)',
                            'rgb(156, 163, 175)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        </script>
    </body>
    </html>
  `)
})

// AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ API

// í•™ìƒë³„ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
app.get('/api/students/has-data/:student_id', async (c) => {
  try {
    const studentId = c.req.param('student_id')
    const month = c.req.query('month') || new Date().toISOString().slice(0, 7)
    
    console.log('ğŸ” [CheckData] Checking data for student:', studentId, 'month:', month)
    
    let hasGrades = false
    let hasAttendance = false
    let hasDailyRecords = false
    
    // ì„±ì  ë°ì´í„° í™•ì¸
    try {
      const gradesResult = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM grades 
        WHERE student_id = ? AND strftime('%Y-%m', test_date) = ?
      `).bind(studentId, month).first()
      hasGrades = gradesResult && gradesResult.count > 0
      console.log('ğŸ“ [CheckData] Grades:', hasGrades, '(count:', gradesResult?.count, ')')
    } catch (err) {
      console.warn('âš ï¸ [CheckData] Grades table not found:', err.message)
    }
    
    // ì¶œì„ ë°ì´í„° í™•ì¸
    try {
      const attendanceResult = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM attendance 
        WHERE student_id = ? AND strftime('%Y-%m', attendance_date) = ?
      `).bind(studentId, month).first()
      hasAttendance = attendanceResult && attendanceResult.count > 0
      console.log('ğŸ“… [CheckData] Attendance:', hasAttendance, '(count:', attendanceResult?.count, ')')
    } catch (err) {
      console.warn('âš ï¸ [CheckData] Attendance table not found:', err.message)
    }
    
    // ì¼ì¼ ì„±ê³¼ ê¸°ë¡ í™•ì¸
    try {
      const dailyResult = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM daily_records 
        WHERE student_id = ? AND strftime('%Y-%m', record_date) = ?
      `).bind(studentId, month).first()
      hasDailyRecords = dailyResult && dailyResult.count > 0
      console.log('ğŸ“‹ [CheckData] Daily records:', hasDailyRecords, '(count:', dailyResult?.count, ')')
    } catch (err) {
      console.warn('âš ï¸ [CheckData] Daily records table not found:', err.message)
    }
    
    const hasData = hasGrades || hasAttendance || hasDailyRecords
    
    console.log('âœ… [CheckData] Final result - hasData:', hasData)
    
    return c.json({ 
      success: true, 
      hasData,
      details: {
        hasGrades,
        hasAttendance,
        hasDailyRecords,
        month
      }
    })
  } catch (err) {
    console.error('âŒ [CheckData] Error:', err)
    console.error('âŒ [CheckData] Stack:', err.stack)
    // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì¼ë‹¨ trueë¡œ ë°˜í™˜ (ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
    return c.json({ 
      success: true, 
      hasData: true, 
      error: 'ë°ì´í„° í™•ì¸ ì‹¤íŒ¨ - ê¸°ë³¸ì ìœ¼ë¡œ ì„ íƒ ê°€ëŠ¥'
    }, 200)
  }
})

// í•™ìƒë³„ ë¦¬í¬íŠ¸ ëª©ë¡ ì¡°íšŒ
app.get('/api/learning-reports/:student_id', async (c) => {
  try {
    const studentId = c.req.param('student_id')
    
    const { results } = await c.env.DB.prepare(`
      SELECT * FROM learning_reports 
      WHERE student_id = ? 
      ORDER BY report_month DESC
    `).bind(studentId).all()
    
    return c.json({ success: true, reports: results })
  } catch (err) {
    console.error('Get learning reports error:', err)
    return c.json({ success: false, error: 'ë¦¬í¬íŠ¸ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ============================================
// ë¦¬í¬íŠ¸ í´ë” ê´€ë¦¬ API
// ============================================

// í´ë” ëª©ë¡ ì¡°íšŒ
app.get('/api/report-folders', async (c) => {
  try {
    const academyId = c.req.query('academyId')
    
    if (!academyId) {
      return c.json({ success: false, error: 'í•™ì› IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    try {
      const result = await c.env.DB.prepare(`
        SELECT * FROM report_folders
        WHERE academy_id = ?
        ORDER BY created_at DESC
      `).bind(academyId).all()
      
      return c.json({ success: true, folders: result.results || [] })
    } catch (err) {
      console.warn('âš ï¸ report_folders table not found:', err.message)
      // í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
      return c.json({ success: true, folders: [] })
    }
  } catch (error) {
    console.error('âŒ Get report folders error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// í´ë” ìƒì„±
app.post('/api/report-folders', async (c) => {
  try {
    const { academyId, folderName, description, color } = await c.req.json()
    
    console.log('ğŸ“ [CreateFolder] Creating folder')
    console.log('ğŸ“ [CreateFolder] academyId:', academyId)
    console.log('ğŸ“ [CreateFolder] folderName:', folderName)
    console.log('ğŸ“ [CreateFolder] description:', description)
    console.log('ğŸ“ [CreateFolder] color:', color)
    
    if (!academyId || !folderName) {
      console.error('âŒ [CreateFolder] Missing required fields')
      return c.json({ success: false, error: 'í•™ì› IDì™€ í´ë” ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    const result = await c.env.DB.prepare(`
      INSERT INTO report_folders (academy_id, folder_name, description, color)
      VALUES (?, ?, ?, ?)
    `).bind(academyId, folderName, description || '', color || '#6366f1').run()
    
    console.log('âœ… [CreateFolder] Folder created successfully, ID:', result.meta.last_row_id)
    
    return c.json({ success: true, folderId: result.meta.last_row_id })
  } catch (error) {
    console.error('âŒ [CreateFolder] Error:', error)
    console.error('âŒ [CreateFolder] Error message:', error.message)
    console.error('âŒ [CreateFolder] Error stack:', error.stack)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// í´ë” ì‚­ì œ
app.delete('/api/report-folders/:folderId', async (c) => {
  try {
    const folderId = c.req.param('folderId')
    
    // í´ë” ë‚´ ë¦¬í¬íŠ¸ì˜ folder_idë¥¼ NULLë¡œ ì„¤ì •
    await c.env.DB.prepare(`
      UPDATE learning_reports SET folder_id = NULL WHERE folder_id = ?
    `).bind(folderId).run()
    
    // í´ë” ì‚­ì œ
    await c.env.DB.prepare(`
      DELETE FROM report_folders WHERE id = ?
    `).bind(folderId).run()
    
    return c.json({ success: true })
  } catch (error) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// AI ë¦¬í¬íŠ¸ ìë™ ìƒì„±
app.post('/api/learning-reports/generate', async (c) => {
  try {
    const { student_id, start_date, end_date, folder_id } = await c.req.json()
    
    // ë¦¬í¬íŠ¸ ê¸°ê°„ ë¬¸ìì—´ ìƒì„± (ë§¨ ì•ì— ì •ì˜)
    const reportPeriod = `${start_date} ~ ${end_date}`;
    
    console.log('ğŸ“Š [GenerateReport] Starting report generation')
    console.log('ğŸ“Š [GenerateReport] Student ID:', student_id)
    console.log('ğŸ“Š [GenerateReport] Date range:', reportPeriod)
    
    // í•™ìƒ ì •ë³´ ì¡°íšŒ
    const student = await c.env.DB.prepare(`
      SELECT * FROM students WHERE id = ?
    `).bind(student_id).first()
    
    if (!student) {
      console.error('âŒ [GenerateReport] Student not found:', student_id)
      return c.json({ success: false, error: 'í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    console.log('âœ… [GenerateReport] Student found:', student.name)
    
    // âœ… AI ë¦¬í¬íŠ¸ ì›”ê°„ í•œë„ ì²´í¬
    console.log('ğŸ” [GenerateReport] Checking AI report limit...')
    const subscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(student.academy_id).first()

    if (!subscription) {
      return c.json({ 
        success: false, 
        error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤. ìš”ê¸ˆì œë¥¼ êµ¬ë§¤í•´ì£¼ì„¸ìš”.' 
      }, 403)
    }

    const usage = await c.env.DB.prepare(`
      SELECT * FROM usage_tracking 
      WHERE academy_id = ? AND subscription_id = ?
    `).bind(student.academy_id, subscription.id).first()

    // ğŸ”¥ usage_tracking ë ˆì½”ë“œê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„±
    let currentReports = 0
    if (!usage) {
      console.log('âš ï¸ [GenerateReport] No usage_tracking record, creating...')
      try {
        await c.env.DB.prepare(`
          INSERT INTO usage_tracking (
            academy_id, subscription_id, current_students, ai_reports_used_this_month,
            landing_pages_created, current_teachers, sms_sent_this_month,
            created_at, updated_at
          ) VALUES (?, ?, 0, 0, 0, 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
        `).bind(student.academy_id, subscription.id).run()
        console.log('âœ… [GenerateReport] Auto-created usage_tracking')
        currentReports = 0
      } catch (createErr) {
        console.error('âŒ [GenerateReport] Failed to create usage_tracking:', createErr.message)
        currentReports = 0
      }
    } else {
      currentReports = usage.ai_reports_used_this_month || 0
    }
    
    if (currentReports >= subscription.ai_report_limit) {
      return c.json({ 
        success: false, 
        error: `â›” ì‚¬ìš© í•œë„ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì´ë²ˆ ë‹¬ AI ë¦¬í¬íŠ¸ ìƒì„± ìˆ˜: ${currentReports}ê°œ / í•œë„: ${subscription.ai_report_limit}ê°œ\n\në” ë§ì€ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì‹œë ¤ë©´ ìƒìœ„ í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•˜ê±°ë‚˜ ë‹¤ìŒ ë‹¬ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.` 
      }, 403)
    }
    console.log(`âœ… [GenerateReport] Limit check passed: ${currentReports}/${subscription.ai_report_limit}`)
    
    // ì„±ì  ë°ì´í„° ì¡°íšŒ (í…Œì´ë¸”ì´ ì—†ì„ ê²½ìš° ëŒ€ë¹„)
    let grades = []
    try {
      const gradesResult = await c.env.DB.prepare(`
        SELECT * FROM grades 
        WHERE student_id = ? 
        AND DATE(test_date) BETWEEN ? AND ?
        ORDER BY test_date DESC
      `).bind(student_id, start_date, end_date).all()
      grades = gradesResult.results || []
      console.log('ğŸ“ [GenerateReport] Grades found:', grades.length)
    } catch (err) {
      console.warn('âš ï¸ [GenerateReport] Grades table not found or error:', err.message)
    }
    
    // ì¶œì„ ë°ì´í„° ì¡°íšŒ (í…Œì´ë¸”ì´ ì—†ì„ ê²½ìš° ëŒ€ë¹„)
    let attendance = []
    try {
      const attendanceResult = await c.env.DB.prepare(`
        SELECT status, COUNT(*) as count
        FROM attendance 
        WHERE student_id = ? 
        AND DATE(attendance_date) BETWEEN ? AND ?
        GROUP BY status
      `).bind(student_id, start_date, end_date).all()
      attendance = attendanceResult.results || []
      console.log('ğŸ“… [GenerateReport] Attendance records found:', attendance.length)
    } catch (err) {
      console.warn('âš ï¸ [GenerateReport] Attendance table not found or error:', err.message)
    }
    
    // ìƒë‹´ ê¸°ë¡ ì¡°íšŒ (í…Œì´ë¸”ì´ ì—†ì„ ê²½ìš° ëŒ€ë¹„)
    let counselings = []
    try {
      const counselingResult = await c.env.DB.prepare(`
        SELECT * FROM counseling 
        WHERE student_id = ? 
        AND DATE(counseling_date) BETWEEN ? AND ?
        ORDER BY counseling_date DESC
        LIMIT 3
      `).bind(student_id, start_date, end_date).all()
      counselings = counselingResult.results || []
      console.log('ğŸ’¬ [GenerateReport] Counseling records found:', counselings.length)
    } catch (err) {
      console.warn('âš ï¸ [GenerateReport] Counseling table not found or error:', err.message)
    }
    
    // ì¼ì¼ ì„±ê³¼ ê¸°ë¡ ì¡°íšŒ (ëŒ€ì²´ ë°ì´í„° ì†ŒìŠ¤)
    let dailyRecords = []
    try {
      const dailyResult = await c.env.DB.prepare(`
        SELECT * FROM daily_records 
        WHERE student_id = ? 
        AND DATE(record_date) BETWEEN ? AND ?
        ORDER BY record_date DESC
      `).bind(student_id, start_date, end_date).all()
      dailyRecords = dailyResult.results || []
      console.log('ğŸ“‹ [GenerateReport] Daily records found:', dailyRecords.length)
    } catch (err) {
      console.warn('âš ï¸ [GenerateReport] Daily records table not found or error:', err.message)
    }
    
    // ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    const hasData = grades.length > 0 || attendance.length > 0 || dailyRecords.length > 0
    
    if (!hasData) {
      console.warn('âš ï¸ [GenerateReport] No data available for this period')
      return c.json({ 
        success: false, 
        error: `${start_date} ~ ${end_date} ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\në‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n1. ì„±ì  ë°ì´í„°ê°€ ì…ë ¥ë˜ì—ˆëŠ”ì§€\n2. ì¶œì„ ë°ì´í„°ê°€ ì…ë ¥ë˜ì—ˆëŠ”ì§€\n3. ì¼ì¼ ì„±ê³¼ ê¸°ë¡ì´ ìˆëŠ”ì§€\n\në°ì´í„°ë¥¼ ë¨¼ì € ì…ë ¥í•œ í›„ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.` 
      }, 400)
    }
    
    console.log('âœ… [GenerateReport] Data found - proceeding with report generation')
    
    // ì¶œì„ë¥  ê³„ì‚°
    let attendanceRate = null
    let totalAttendance = 0
    let presentCount = 0
    let attendanceSource = 'none'
    
    if (attendance.length > 0) {
      totalAttendance = attendance.reduce((sum, a) => sum + (a.count || 0), 0)
      presentCount = attendance.find(a => a.status === 'present')?.count || 0
      attendanceRate = totalAttendance > 0 ? (presentCount / totalAttendance * 100).toFixed(1) : 0
      attendanceSource = 'attendance'
    } else if (dailyRecords.length > 0) {
      // ì¼ì¼ ì„±ê³¼ ê¸°ë¡ì—ì„œ ì¶œì„ ë°ì´í„° ì¶”ì¶œ
      const attendanceData = dailyRecords.filter(r => r.attendance)
      totalAttendance = attendanceData.length
      presentCount = attendanceData.filter(r => r.attendance === 'ì¶œì„').length
      if (totalAttendance > 0) {
        attendanceRate = (presentCount / totalAttendance * 100).toFixed(1)
        attendanceSource = 'daily_records'
      }
    }
    
    if (attendanceRate === null) {
      console.error('âŒ [GenerateReport] No attendance data available')
      return c.json({ 
        success: false, 
        error: `${reportPeriod} ê¸°ê°„ì— ì¶œì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nì¶œì„ ë°ì´í„°ë¥¼ ë¨¼ì € ì…ë ¥í•œ í›„ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.` 
      }, 400)
    }
    
    console.log('ğŸ“Š [GenerateReport] Attendance rate:', attendanceRate + '%', '(source:', attendanceSource + ')')
    
    // í‰ê·  ì ìˆ˜ ê³„ì‚°
    let avgScore = null
    let scoreSource = 'none'
    
    if (grades.length > 0) {
      avgScore = (grades.reduce((sum, g) => sum + (g.score / g.max_score * 100), 0) / grades.length).toFixed(1)
      scoreSource = 'grades'
    } else if (dailyRecords.length > 0) {
      // ì¼ì¼ ì„±ê³¼ì—ì„œ ì´í•´ë„, ì°¸ì—¬ë„ í‰ê· 
      const understandingScores = dailyRecords.filter(r => r.lesson_understanding).map(r => parseFloat(r.lesson_understanding))
      const participationScores = dailyRecords.filter(r => r.lesson_participation).map(r => parseFloat(r.lesson_participation))
      
      if (understandingScores.length > 0 || participationScores.length > 0) {
        const allScores = [...understandingScores, ...participationScores]
        avgScore = (allScores.reduce((sum, s) => sum + s, 0) / allScores.length * 10).toFixed(1)
        scoreSource = 'daily_records'
      }
    }
    
    if (avgScore === null) {
      console.error('âŒ [GenerateReport] No score data available')
      return c.json({ 
        success: false, 
        error: `${reportPeriod} ê¸°ê°„ì— ì„±ì /í•™ìŠµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nì„±ì  ë°ì´í„° ë˜ëŠ” ì¼ì¼ ì„±ê³¼ ê¸°ë¡ì„ ë¨¼ì € ì…ë ¥í•œ í›„ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.` 
      }, 400)
    }
    
    console.log('ğŸ“Š [GenerateReport] Average score:', avgScore, '(source:', scoreSource + ')')
    
    // í•™ìŠµ íƒœë„ íŒë‹¨
    let studyAttitude = 'í‰ê°€ ë¶ˆê°€'
    if (attendanceRate >= 95 && avgScore >= 85) studyAttitude = 'ë§¤ìš° ìš°ìˆ˜'
    else if (attendanceRate >= 90 && avgScore >= 80) studyAttitude = 'ìš°ìˆ˜'
    else if (attendanceRate >= 80 && avgScore >= 70) studyAttitude = 'ì–‘í˜¸'
    else studyAttitude = 'ê°œì„  í•„ìš”'
    
    // ê°•ì  ë¶„ì„
    let strengths = ''
    const topSubject = grades.length > 0 
      ? grades.reduce((max, g) => (g.score / g.max_score) > (max.score / max.max_score) ? g : max)
      : null
    
    if (topSubject) {
      strengths = topSubject.subject + ' ê³¼ëª©ì—ì„œ ' + (topSubject.score / topSubject.max_score * 100).toFixed(1) + 'ì ìœ¼ë¡œ ìš°ìˆ˜í•œ ì„±ì ì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ê¾¸ì¤€í•œ ë…¸ë ¥ì´ ë‹ë³´ì…ë‹ˆë‹¤.'
    } else if (dailyRecords.length > 0 && dailyRecords.filter(r => r.lesson_participation).length > 0) {
      const avgParticipation = (dailyRecords.filter(r => r.lesson_participation).reduce((sum, r) => sum + parseFloat(r.lesson_participation), 0) / dailyRecords.filter(r => r.lesson_participation).length).toFixed(1)
      strengths = 'ìˆ˜ì—… ì°¸ì—¬ë„ê°€ í‰ê·  ' + avgParticipation + 'ì ìœ¼ë¡œ ì ê·¹ì ì¸ í•™ìŠµ íƒœë„ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.'
    } else {
      strengths = 'í˜„ì¬ ê¸°ê°„ì˜ ì„±ì  ë°ì´í„°ê°€ ë¶€ì¡±í•˜ì—¬ ê°•ì ì„ íŒŒì•…í•˜ê¸° ì–´ë µìŠµë‹ˆë‹¤. ì§€ì†ì ì¸ í•™ìŠµ í™œë™ ê¸°ë¡ì´ í•„ìš”í•©ë‹ˆë‹¤.'
    }
    
    // ì•½ì  ë¶„ì„
    let weaknesses = ''
    const weakSubject = grades.length > 0 
      ? grades.reduce((min, g) => (g.score / g.max_score) < (min.score / min.max_score) ? g : min)
      : null
    
    if (weakSubject && (weakSubject.score / weakSubject.max_score * 100) < 75) {
      weaknesses = weakSubject.subject + ' ê³¼ëª©ì—ì„œ ' + (weakSubject.score / weakSubject.max_score * 100).toFixed(1) + 'ì ìœ¼ë¡œ ë³´ì™„ì´ í•„ìš”í•©ë‹ˆë‹¤.'
    } else if (dailyRecords.length > 0 && dailyRecords.filter(r => r.homework_status === 'ë¯¸ì™„ë£Œ').length > 0) {
      weaknesses = 'ê³¼ì œ ì™„ì„±ë¥ ì´ ë‚®ìŠµë‹ˆë‹¤. ë³µìŠµ ì‹œê°„ì„ ëŠ˜ë ¤ ê³¼ì œë¥¼ ì™„ë£Œí•˜ëŠ” ìŠµê´€ì„ ê¸°ë¥´ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.'
    } else {
      weaknesses = 'ì „ë°˜ì ìœ¼ë¡œ ê· í˜•ì¡íŒ í•™ìŠµì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.'
    }
    
    // ê°œì„ ì‚¬í•­
    const improvements = attendanceRate < 90 
      ? 'ì¶œì„ë¥  ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤. ê·œì¹™ì ì¸ ìˆ˜ì—… ì°¸ì—¬ê°€ ì„±ì  í–¥ìƒì˜ ê¸°ë³¸ì…ë‹ˆë‹¤.'
      : avgScore < 80
      ? 'ê¸°ë³¸ ê°œë… ë³µìŠµì— ë” ë§ì€ ì‹œê°„ì„ íˆ¬ìí•˜ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.'
      : 'í˜„ì¬ í•™ìŠµ íŒ¨í„´ì„ ìœ ì§€í•˜ë©´ì„œ ì‹¬í™” í•™ìŠµìœ¼ë¡œ ë‚˜ì•„ê°€ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤.'
    
    // ì¶”ì²œì‚¬í•­
    const recommendations = avgScore >= 85
      ? 'ìƒìœ„ê¶Œ ìœ ì§€ë¥¼ ìœ„í•´ ì‹¬í™” ë¬¸ì œ í’€ì´ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤. ê²½ì‹œëŒ€íšŒ ì¤€ë¹„ë„ ê³ ë ¤í•´ë³¼ ë§Œí•©ë‹ˆë‹¤.'
      : avgScore >= 75
      ? 'ê¸°ë³¸ê¸° ê°•í™”ì™€ í•¨ê»˜ ë¬¸ì œ í’€ì´ ì†ë„ë¥¼ ë†’ì´ëŠ” ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.'
      : 'ê°œë… ì´í•´ë¥¼ ìœ„í•œ 1:1 ë³´ì¶© ìˆ˜ì—…ì„ ì¶”ì²œí•©ë‹ˆë‹¤. ê¸°ì´ˆë¶€í„° ì°¨ê·¼ì°¨ê·¼ ë‹¤ì ¸ê°€ë©´ ì¶©ë¶„íˆ ì„±ì ì´ ì˜¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
    
    // ë‹¤ìŒ ë‹¬ ëª©í‘œ
    const nextMonthGoals = avgScore >= 85
      ? 'í˜„ì¬ í‰ê·  ' + avgScore + 'ì  ìˆ˜ì¤€ì„ ìœ ì§€í•˜ë©´ì„œ, ' + (weakSubject?.subject || 'ì·¨ì•½ ê³¼ëª©') + 'ì—ì„œ 5ì  ì´ìƒ í–¥ìƒ ëª©í‘œ'
      : 'í‰ê·  ì ìˆ˜ ' + avgScore + 'ì ì—ì„œ ' + Math.min(100, parseFloat(avgScore) + 10).toFixed(0) + 'ì ìœ¼ë¡œ í–¥ìƒ, ì¶œì„ë¥  ' + attendanceRate + '%ì—ì„œ 95% ì´ìƒ ë‹¬ì„±'
    
    // AI ì¢…í•© ë¶„ì„
    const aiAnalysis = student.name + ' í•™ìƒì€ ì´ë²ˆ ë‹¬ í‰ê·  ' + avgScore + 'ì ì˜ ì„±ì ì„ ê¸°ë¡í–ˆìœ¼ë©°, ì¶œì„ë¥ ì€ ' + attendanceRate + '%ì…ë‹ˆë‹¤. ' +
      (studyAttitude === 'ë§¤ìš° ìš°ìˆ˜' || studyAttitude === 'ìš°ìˆ˜' 
        ? 'ì „ë°˜ì ìœ¼ë¡œ ì„±ì‹¤í•˜ê²Œ í•™ì—…ì— ì„í•˜ê³  ìˆìœ¼ë©°, ì§€ì†ì ì¸ ì„±ì¥ì´ ê¸°ëŒ€ë©ë‹ˆë‹¤.' 
        : 'í•™ìŠµ íƒœë„ì™€ ì¶œì„ ê´€ë¦¬ì— ë” ë§ì€ ê´€ì‹¬ì´ í•„ìš”í•©ë‹ˆë‹¤.') +
      (topSubject ? ' íŠ¹íˆ ' + topSubject.subject + ' ê³¼ëª©ì—ì„œ ê°•ì ì„ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.' : '') +
      ' ê¾¸ì¤€í•œ ë…¸ë ¥ìœ¼ë¡œ ë”ìš± ë°œì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
    
    // í•™ë¶€ëª¨ ë©”ì‹œì§€
    const parentMessage = `í•™ë¶€ëª¨ë‹˜, ì•ˆë…•í•˜ì„¸ìš”.

${student.name} í•™ìƒì˜ ${reportPeriod} í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ì „ë‹¬ë“œë¦½ë‹ˆë‹¤.

ğŸ“Š ì´ë²ˆ ë‹¬ ì„±ê³¼
- í‰ê·  ì ìˆ˜: ${avgScore}ì 
- ì¶œì„ë¥ : ${attendanceRate}%
- í•™ìŠµ íƒœë„: ${studyAttitude}

ğŸ’ª ê°•ì 
${strengths}

ğŸ¯ ê°œì„  í•„ìš” ì‚¬í•­
${weaknesses}

ğŸ“ ì„ ìƒë‹˜ì˜ ì¶”ì²œ
${recommendations}

ë‹¤ìŒ ë‹¬ ëª©í‘œ: ${nextMonthGoals}

ì•ìœ¼ë¡œë„ ${student.name} í•™ìƒì´ ë”ìš± ì„±ì¥í•  ìˆ˜ ìˆë„ë¡ ìµœì„ ì„ ë‹¤í•˜ê² ìŠµë‹ˆë‹¤.
ê¶ê¸ˆí•˜ì‹  ì ì€ ì–¸ì œë“  ì—°ë½ ì£¼ì„¸ìš”!

- ìŠˆí¼í”Œë ˆì´ìŠ¤ ${counselings[0]?.counselor_name || 'ì„ ìƒë‹˜'}`
    
    console.log('ğŸ’¾ [GenerateReport] Saving report to database')
    
    // ë¦¬í¬íŠ¸ ì €ì¥
    const result = await c.env.DB.prepare(`
      INSERT INTO learning_reports 
      (student_id, report_month, overall_score, study_attitude, strengths, weaknesses, improvements, recommendations, next_month_goals, ai_analysis, parent_message, folder_id)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      student_id, 
      reportPeriod, 
      avgScore, 
      studyAttitude, 
      strengths, 
      weaknesses, 
      improvements, 
      recommendations, 
      nextMonthGoals, 
      aiAnalysis, 
      parentMessage,
      folder_id || null
    ).run()
    
    console.log('âœ… [GenerateReport] Report saved successfully, ID:', result.meta.last_row_id)
    
    // âœ… ì‚¬ìš©ëŸ‰ ì¦ê°€
    try {
      const updateResult = await c.env.DB.prepare(`
        UPDATE usage_tracking 
        SET ai_reports_used_this_month = ai_reports_used_this_month + 1, updated_at = CURRENT_TIMESTAMP
        WHERE academy_id = ? AND subscription_id = ?
      `).bind(student.academy_id, subscription.id).run()
      
      // ğŸ”¥ UPDATEê°€ ì‹¤íŒ¨í•˜ë©´ (ë ˆì½”ë“œê°€ ì—†ìœ¼ë©´) INSERT
      if (updateResult.meta.changes === 0) {
        console.log('âš ï¸ [GenerateReport] No usage_tracking to update, creating with count=1...')
        await c.env.DB.prepare(`
          INSERT INTO usage_tracking (
            academy_id, subscription_id, current_students, ai_reports_used_this_month,
            landing_pages_created, current_teachers, sms_sent_this_month,
            created_at, updated_at
          ) VALUES (?, ?, 0, 1, 0, 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
        `).bind(student.academy_id, subscription.id).run()
        console.log('âœ… [GenerateReport] Auto-created usage_tracking with ai_reports=1')
      } else {
        console.log('ğŸ“ˆ [GenerateReport] Usage incremented successfully')
      }
    } catch (usageErr) {
      console.error('âš ï¸ [GenerateReport] Failed to increment usage:', usageErr)
    }
    
    return c.json({ 
      success: true, 
      message: 'AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      report_id: result.meta.last_row_id,
      preview: {
        overall_score: avgScore,
        attendance_rate: attendanceRate,
        study_attitude: studyAttitude
      }
    })
  } catch (err) {
    console.error('âŒ [GenerateReport] Fatal error:', err)
    console.error('âŒ [GenerateReport] Error message:', err.message)
    console.error('âŒ [GenerateReport] Error stack:', err.stack)
    return c.json({ 
      success: false, 
      error: 'AI ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨: ' + err.message 
    }, 500)
  }
})

// ë¦¬í¬íŠ¸ ìƒì„¸ ì¡°íšŒ
app.get('/api/learning-reports/detail/:report_id', async (c) => {
  try {
    const reportId = c.req.param('report_id')
    
    const report = await c.env.DB.prepare(`
      SELECT lr.*, s.name as student_name, s.parent_name, s.parent_phone
      FROM learning_reports lr
      JOIN students s ON lr.student_id = s.id
      WHERE lr.id = ?
    `).bind(reportId).first()
    
    if (!report) {
      return c.json({ success: false, error: 'ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    return c.json({ success: true, report })
  } catch (err) {
    console.error('Get report detail error:', err)
    return c.json({ success: false, error: 'ë¦¬í¬íŠ¸ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// ë¦¬í¬íŠ¸ í•„ë“œ ì—…ë°ì´íŠ¸ API
app.put('/api/learning-reports/:report_id/update-field', async (c) => {
  try {
    const reportId = c.req.param('report_id')
    const { field, value } = await c.req.json()
    
    const allowedFields = ['strengths', 'weaknesses', 'improvements', 'recommendations', 'next_month_goals', 'ai_analysis', 'parent_message', 'study_attitude']
    
    if (!allowedFields.includes(field)) {
      return c.json({ success: false, error: 'í—ˆìš©ë˜ì§€ ì•Šì€ í•„ë“œì…ë‹ˆë‹¤.' }, 400)
    }
    
    const report = await c.env.DB.prepare('SELECT id FROM learning_reports WHERE id = ?').bind(reportId).first()
    
    if (!report) {
      return c.json({ success: false, error: 'ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    try {
      // updated_at ì»¬ëŸ¼ì´ ìˆëŠ” ê²½ìš°
      await c.env.DB.prepare(`UPDATE learning_reports SET ${field} = ?, updated_at = datetime('now') WHERE id = ?`).bind(value, reportId).run()
    } catch (updateErr) {
      console.warn('âš ï¸ updated_at column not found, trying without it')
      // updated_at ì»¬ëŸ¼ì´ ì—†ëŠ” ê²½ìš°
      await c.env.DB.prepare(`UPDATE learning_reports SET ${field} = ? WHERE id = ?`).bind(value, reportId).run()
    }
    
    console.log(`Report ${reportId} field ${field} updated`)
    
    return c.json({ success: true, message: 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', field, value })
  } catch (err) {
    console.error('Update report field error:', err)
    return c.json({ success: false, error: 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ë¦¬í¬íŠ¸ ì „ì²´ ì—…ë°ì´íŠ¸ API
app.put('/api/learning-reports/:report_id', async (c) => {
  try {
    const reportId = c.req.param('report_id')
    const data = await c.req.json()
    
    console.log('âœï¸ [UpdateReport] Updating report:', reportId)
    console.log('âœï¸ [UpdateReport] Data:', JSON.stringify(data))
    
    // ë¦¬í¬íŠ¸ ì¡´ì¬ í™•ì¸
    const report = await c.env.DB.prepare('SELECT id FROM learning_reports WHERE id = ?').bind(reportId).first()
    
    if (!report) {
      console.error('âŒ [UpdateReport] Report not found:', reportId)
      return c.json({ success: false, error: 'ë¦¬í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    console.log('âœ… [UpdateReport] Report found:', reportId)
    
    const { 
      overall_score, study_attitude, strengths, weaknesses, 
      improvements, recommendations, next_month_goals, 
      ai_analysis, parent_message 
    } = data
    
    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    if (overall_score === undefined || !study_attitude) {
      console.error('âŒ [UpdateReport] Missing required fields')
      return c.json({ success: false, error: 'í•„ìˆ˜ í•„ë“œê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)
    }
    
    console.log('âœï¸ [UpdateReport] Executing UPDATE query...')
    
    try {
      // updated_at ì»¬ëŸ¼ì´ ìˆëŠ” ê²½ìš°
      const result = await c.env.DB.prepare(`
        UPDATE learning_reports 
        SET overall_score = ?, study_attitude = ?, strengths = ?, 
            weaknesses = ?, improvements = ?, recommendations = ?, 
            next_month_goals = ?, ai_analysis = ?, parent_message = ?,
            updated_at = datetime('now')
        WHERE id = ?
      `).bind(
        overall_score,
        study_attitude,
        strengths,
        weaknesses,
        improvements,
        recommendations,
        next_month_goals,
        ai_analysis,
        parent_message,
        reportId
      ).run()
      
      console.log('âœ… [UpdateReport] UPDATE result:', JSON.stringify(result.meta))
    } catch (updateErr) {
      console.warn('âš ï¸ [UpdateReport] updated_at column not found, trying without it:', updateErr.message)
      
      // updated_at ì»¬ëŸ¼ì´ ì—†ëŠ” ê²½ìš° (fallback)
      const result = await c.env.DB.prepare(`
        UPDATE learning_reports 
        SET overall_score = ?, study_attitude = ?, strengths = ?, 
            weaknesses = ?, improvements = ?, recommendations = ?, 
            next_month_goals = ?, ai_analysis = ?, parent_message = ?
        WHERE id = ?
      `).bind(
        overall_score,
        study_attitude,
        strengths,
        weaknesses,
        improvements,
        recommendations,
        next_month_goals,
        ai_analysis,
        parent_message,
        reportId
      ).run()
      
      console.log('âœ… [UpdateReport] UPDATE result (without updated_at):', JSON.stringify(result.meta))
    }
    
    console.log('âœ… [UpdateReport] Report updated successfully')
    
    return c.json({ success: true, message: 'ë¦¬í¬íŠ¸ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('âŒ [UpdateReport] Fatal error:', err)
    console.error('âŒ [UpdateReport] Error message:', err.message)
    console.error('âŒ [UpdateReport] Error stack:', err.stack)
    return c.json({ 
      success: false, 
      error: 'ë¦¬í¬íŠ¸ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      details: err.message 
    }, 500)
  }
})

// í”„ë¡œí•„ ìˆ˜ì • í˜ì´ì§€
app.get('/profile', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í”„ë¡œí•„ ìˆ˜ì • - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .gradient-purple {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <a href="/dashboard" class="text-xl font-bold text-purple-600">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</a>
                    <div class="flex items-center space-x-4">
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <a href="/profile" class="text-purple-600 font-medium">í”„ë¡œí•„</a>
                        <button onclick="logout()" class="text-red-600 hover:text-red-700">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-4xl mx-auto">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">í”„ë¡œí•„ ìˆ˜ì •</h1>
                    <p class="text-gray-600">íšŒì› ì •ë³´ë¥¼ ìˆ˜ì •í•˜ê³  ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- í”„ë¡œí•„ ì •ë³´ ìˆ˜ì • -->
                    <div class="bg-white rounded-2xl border border-gray-200 p-8">
                        <h2 class="text-xl font-bold text-gray-900 mb-6">ğŸ“ ê¸°ë³¸ ì •ë³´</h2>
                        <form id="profileForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì´ë©”ì¼</label>
                                <input type="email" id="email" readonly class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì›ì¥ë‹˜ ì„±í•¨ <span class="text-red-500">*</span></label>
                                <input type="text" id="name" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì—°ë½ì²˜ <span class="text-red-500">*</span></label>
                                <input type="tel" id="phone" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì› ì´ë¦„ <span class="text-red-500">*</span></label>
                                <input type="text" id="academy_name" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì› ìœ„ì¹˜ <span class="text-red-500">*</span></label>
                                <input type="text" id="academy_location" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                            </div>
                            <button type="submit" class="w-full gradient-purple text-white py-3 rounded-xl font-medium hover:shadow-xl transition-all">
                                í”„ë¡œí•„ ì €ì¥
                            </button>
                            <div id="profileMessage" class="hidden mt-4 p-4 rounded-xl"></div>
                        </form>
                    </div>

                    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
                    <div class="bg-white rounded-2xl border border-gray-200 p-8">
                        <h2 class="text-xl font-bold text-gray-900 mb-6">ğŸ” ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
                        <form id="passwordForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ <span class="text-red-500">*</span></label>
                                <input type="password" id="current_password" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ìƒˆ ë¹„ë°€ë²ˆí˜¸ <span class="text-red-500">*</span></label>
                                <input type="password" id="new_password" required minlength="6" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                                <p class="text-xs text-gray-500 mt-1">ìµœì†Œ 6ì ì´ìƒ</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="text-red-500">*</span></label>
                                <input type="password" id="new_password_confirm" required minlength="6" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition">
                            </div>
                            <button type="submit" class="w-full bg-orange-500 text-white py-3 rounded-xl font-medium hover:bg-orange-600 transition-all">
                                ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                            </button>
                            <div id="passwordMessage" class="hidden mt-4 p-4 rounded-xl"></div>
                        </form>
                    </div>
                </div>

                <!-- ê°€ì… ì •ë³´ -->
                <div class="mt-6 bg-white rounded-2xl border border-gray-200 p-6">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">â„¹ï¸ ê³„ì • ì •ë³´</h2>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">ê°€ì…ì¼:</span>
                            <span id="created_at" class="ml-2 font-medium text-gray-900"></span>
                        </div>
                        <div>
                            <span class="text-gray-600">íšŒì› ë“±ê¸‰:</span>
                            <span id="role" class="ml-2 font-medium text-purple-600"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        const user = JSON.parse(localStorage.getItem('user') || 'null')
        if (!user) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.')
            window.location.href = '/login'
        }

        function logout() {
            localStorage.removeItem('user')
            window.location.href = '/'
        }

        // í”„ë¡œí•„ ë¡œë“œ
        async function loadProfile() {
            try {
                const res = await fetch('/api/user/profile', {
                    headers: { 'X-User-Id': user.id }
                })
                const data = await res.json()
                if (data.success) {
                    document.getElementById('email').value = data.user.email
                    document.getElementById('name').value = data.user.name
                    document.getElementById('phone').value = data.user.phone || ''
                    document.getElementById('academy_name').value = data.user.academy_name || ''
                    document.getElementById('academy_location').value = data.user.academy_location || ''
                    document.getElementById('created_at').textContent = new Date(data.user.created_at).toLocaleDateString()
                    document.getElementById('role').textContent = data.user.role === 'admin' ? 'ê´€ë¦¬ì' : 'ì¼ë°˜ íšŒì›'
                }
            } catch (err) {
                console.error('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', err)
            }
        }

        // í”„ë¡œí•„ ìˆ˜ì •
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const data = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                academy_name: document.getElementById('academy_name').value,
                academy_location: document.getElementById('academy_location').value
            }

            try {
                const res = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-User-Id': user.id
                    },
                    body: JSON.stringify(data)
                })
                const result = await res.json()
                const messageEl = document.getElementById('profileMessage')
                messageEl.classList.remove('hidden')

                if (result.success) {
                    messageEl.className = 'mt-4 p-4 rounded-xl bg-green-50 text-green-800 border border-green-200'
                    messageEl.textContent = result.message
                    
                    // localStorage ì—…ë°ì´íŠ¸
                    user.name = data.name
                    user.academy_name = data.academy_name
                    localStorage.setItem('user', JSON.stringify(user))
                } else {
                    messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                    messageEl.textContent = result.error
                }
            } catch (err) {
                const messageEl = document.getElementById('profileMessage')
                messageEl.classList.remove('hidden')
                messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                messageEl.textContent = 'í”„ë¡œí•„ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
            }
        })

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const current_password = document.getElementById('current_password').value
            const new_password = document.getElementById('new_password').value
            const new_password_confirm = document.getElementById('new_password_confirm').value

            if (new_password !== new_password_confirm) {
                const messageEl = document.getElementById('passwordMessage')
                messageEl.classList.remove('hidden')
                messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                messageEl.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'
                return
            }

            try {
                const res = await fetch('/api/user/change-password', {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-User-Id': user.id
                    },
                    body: JSON.stringify({ current_password, new_password })
                })
                const result = await res.json()
                const messageEl = document.getElementById('passwordMessage')
                messageEl.classList.remove('hidden')

                if (result.success) {
                    messageEl.className = 'mt-4 p-4 rounded-xl bg-green-50 text-green-800 border border-green-200'
                    messageEl.textContent = result.message
                    document.getElementById('passwordForm').reset()
                } else {
                    messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                    messageEl.textContent = result.error
                }
            } catch (err) {
                const messageEl = document.getElementById('passwordMessage')
                messageEl.classList.remove('hidden')
                messageEl.className = 'mt-4 p-4 rounded-xl bg-red-50 text-red-800 border border-red-200'
                messageEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
            }
        })

        loadProfile()
        </script>
    </body>
    </html>
  `)
})

// íšŒì› í”„ë¡œí•„ ì¡°íšŒ API
app.get('/api/user/profile', async (c) => {
  try {
    // ì„¸ì…˜ ë˜ëŠ” í—¤ë”ì—ì„œ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
    let userId = c.req.header('X-User-Id');
    
    // í—¤ë”ì— ì—†ìœ¼ë©´ ì„¸ì…˜ì—ì„œ í™•ì¸
    if (!userId) {
      try {
        const cookies = c.req.header('Cookie');
        if (cookies) {
          const sessionIdMatch = cookies.split(';').find(c => c.trim().startsWith('session_id='));
          if (sessionIdMatch) {
            const sessionId = sessionIdMatch.split('=')[1];
            const session = await c.env.DB.prepare('SELECT user_id FROM sessions WHERE id = ?').bind(sessionId).first();
            if (session) {
              userId = session.user_id.toString();
            }
          }
        }
      } catch (cookieErr) {
        console.error('Error parsing cookies:', cookieErr);
      }
    }
    
    if (!userId) {
      return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }

    const user = await c.env.DB.prepare(`
      SELECT id, email, name, phone, academy_name, role, created_at, 
             user_type, academy_id, parent_user_id, points
      FROM users WHERE id = ?
    `).bind(userId).first()

    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    return c.json({ success: true, user })
  } catch (err) {
    console.error('Get profile error:', err);
    console.error('Error stack:', err.stack);
    return c.json({ success: false, error: 'í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨', details: err.message }, 500)
  }
})

// íšŒì› í”„ë¡œí•„ ìˆ˜ì • API
app.put('/api/user/profile', async (c) => {
  try {
    const userId = c.req.header('X-User-Id')
    if (!userId) {
      return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }

    const { name, phone, academy_name, academy_location } = await c.req.json()

    if (!name || !phone || !academy_name || !academy_location) {
      return c.json({ success: false, error: 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    await c.env.DB.prepare(`
      UPDATE users 
      SET name = ?, phone = ?, academy_name = ?, academy_location = ?, updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(name, phone, academy_name, academy_location, userId).run()

    return c.json({ success: true, message: 'í”„ë¡œí•„ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Update profile error:', err)
    return c.json({ success: false, error: 'í”„ë¡œí•„ ìˆ˜ì • ì‹¤íŒ¨' }, 500)
  }
})

// íšŒì› ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ API
app.put('/api/user/change-password', async (c) => {
  try {
    const userId = c.req.header('X-User-Id')
    if (!userId) {
      return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }

    const { current_password, new_password } = await c.req.json()

    if (!current_password || !new_password) {
      return c.json({ success: false, error: 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }

    if (new_password.length < 6) {
      return c.json({ success: false, error: 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.' }, 400)
    }

    // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
    const user = await c.env.DB.prepare(`
      SELECT id FROM users WHERE id = ? AND password = ?
    `).bind(userId, current_password).first()

    if (!user) {
      return c.json({ success: false, error: 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' }, 400)
    }

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
    await c.env.DB.prepare(`
      UPDATE users SET password = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(new_password, userId).run()

    return c.json({ success: true, message: 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (err) {
    console.error('Change password error:', err)
    return c.json({ success: false, error: 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨' }, 500)
  }
})

// ê´€ë¦¬ì - íšŒì›ìœ¼ë¡œ ë¡œê·¸ì¸ (Impersonate)
app.post('/api/admin/impersonate', async (c) => {
  try {
    const adminId = c.req.header('X-User-Id')
    if (!adminId) {
      return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 401)
    }

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await c.env.DB.prepare(`
      SELECT role FROM users WHERE id = ? AND role = 'admin'
    `).bind(adminId).first()

    if (!admin) {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.' }, 403)
    }

    const { user_id } = await c.req.json()

    // ëŒ€ìƒ ì‚¬ìš©ì ì¡°íšŒ
    const targetUser = await c.env.DB.prepare(`
      SELECT id, email, name, role, academy_name FROM users WHERE id = ?
    `).bind(user_id).first()

    if (!targetUser) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    return c.json({ 
      success: true, 
      message: 'ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.',
      user: targetUser,
      is_impersonating: true,
      original_admin_id: adminId
    })
  } catch (err) {
    console.error('Impersonate error:', err)
    return c.json({ success: false, error: 'ì‚¬ìš©ì ë¡œê·¸ì¸ ì‹¤íŒ¨' }, 500)
  }
})

// ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë§ˆì¼€íŒ… ë„êµ¬
app.get('/programs/naver-place', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë§ˆì¼€íŒ… ë„êµ¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    </head>
    <body class="bg-gray-50">
        <!-- í—¤ë” -->
        <nav class="bg-white shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-8">
                        <a href="/programs" class="text-2xl font-bold text-blue-600">ğŸ—ºï¸ ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë„êµ¬</a>
                        <div class="hidden md:flex gap-6">
                            <a href="#keyword" class="text-gray-600 hover:text-blue-600">í‚¤ì›Œë“œ ë¶„ì„</a>
                            <a href="#competitor" class="text-gray-600 hover:text-blue-600">ê²½ìŸì‚¬ ë¶„ì„</a>
                            <a href="#review" class="text-gray-600 hover:text-blue-600">ë¦¬ë·° ê´€ë¦¬</a>
                            <a href="#optimization" class="text-gray-600 hover:text-blue-600">ìµœì í™”</a>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="history.back()" class="px-4 py-2 text-gray-600 hover:text-gray-900">
                            <i class="fas fa-arrow-left mr-2"></i>ë’¤ë¡œ
                        </button>
                        <a href="/programs" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            í”„ë¡œê·¸ë¨ ëª©ë¡
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- 1. í‚¤ì›Œë“œ ê²€ìƒ‰ëŸ‰ ë¶„ì„ -->
            <section id="keyword" class="mb-12">
                <div class="bg-white rounded-2xl shadow-sm p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-search text-blue-600 mr-3"></i>
                        í‚¤ì›Œë“œ ê²€ìƒ‰ëŸ‰ ë¶„ì„
                    </h2>
                    <p class="text-gray-600 mb-6">ìš°ë¦¬ í•™ì›ì´ íƒ€ê²Ÿí•´ì•¼ í•  ì§€ì—­ + ì—…ì¢… í‚¤ì›Œë“œì˜ ì˜ˆìƒ ê²€ìƒ‰ëŸ‰ì„ í™•ì¸í•˜ì„¸ìš”</p>
                    
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì§€ì—­ ì„ íƒ</label>
                            <input type="text" id="location" placeholder="ì˜ˆ: ì¸ì²œ ì„œêµ¬, ê°•ë‚¨êµ¬, ëª©ë™" 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì—…ì¢…/í‚¤ì›Œë“œ</label>
                            <input type="text" id="keyword" placeholder="ì˜ˆ: ì˜ì–´í•™ì›, ìˆ˜í•™í•™ì›, ì½”ë”©í•™ì›" 
                                   class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <button onclick="analyzeKeyword()" class="w-full md:w-auto px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
                        <i class="fas fa-chart-line mr-2"></i>ê²€ìƒ‰ëŸ‰ ë¶„ì„í•˜ê¸°
                    </button>
                    
                    <div id="keywordResult" class="hidden mt-8">
                        <div class="bg-blue-50 border-l-4 border-blue-600 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">ë¶„ì„ ê²°ê³¼</h3>
                            <div class="grid md:grid-cols-3 gap-6">
                                <div class="bg-white p-4 rounded-lg">
                                    <div class="text-sm text-gray-600 mb-1">ì›”í‰ê·  ê²€ìƒ‰ëŸ‰</div>
                                    <div class="text-3xl font-bold text-blue-600" id="searchVolume">-</div>
                                    <div class="text-xs text-gray-500 mt-1">ì§€ì—­ ë‚´ ê²€ìƒ‰ ì¶”ì •ì¹˜</div>
                                </div>
                                <div class="bg-white p-4 rounded-lg">
                                    <div class="text-sm text-gray-600 mb-1">ê²½ìŸ ê°•ë„</div>
                                    <div class="text-3xl font-bold" id="competition">-</div>
                                    <div class="text-xs text-gray-500 mt-1">ë‚®ì„ìˆ˜ë¡ ìœ ë¦¬</div>
                                </div>
                                <div class="bg-white p-4 rounded-lg">
                                    <div class="text-sm text-gray-600 mb-1">ì¶”ì²œ ì ìˆ˜</div>
                                    <div class="text-3xl font-bold text-green-600" id="score">-</div>
                                    <div class="text-xs text-gray-500 mt-1">/100ì </div>
                                </div>
                            </div>
                            <div class="mt-6 p-4 bg-white rounded-lg">
                                <h4 class="font-semibold text-gray-900 mb-3">ì¶”ì²œ í‚¤ì›Œë“œ ì¡°í•©</h4>
                                <div id="keywordSuggestions" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. ê²½ìŸì‚¬ ë¶„ì„ -->
            <section id="competitor" class="mb-12">
                <div class="bg-white rounded-2xl shadow-sm p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-users text-purple-600 mr-3"></i>
                        ê²½ìŸì‚¬ ë²¤ì¹˜ë§ˆí‚¹
                    </h2>
                    <p class="text-gray-600 mb-6">ì£¼ë³€ ê²½ìŸ í•™ì›ê³¼ ìš°ë¦¬ í•™ì›ì„ ë¹„êµ ë¶„ì„í•˜ì„¸ìš”</p>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìš°ë¦¬ í•™ì› ì •ë³´</label>
                        <div class="grid md:grid-cols-3 gap-4">
                            <input type="text" id="myAcademy" placeholder="í•™ì›ëª…" class="px-4 py-3 border rounded-lg">
                            <input type="number" id="myReviews" placeholder="ë¦¬ë·° ìˆ˜" class="px-4 py-3 border rounded-lg">
                            <input type="number" id="myRating" placeholder="í‰ì  (1-5)" step="0.1" max="5" class="px-4 py-3 border rounded-lg">
                        </div>
                    </div>
                    
                    <button onclick="analyzeCompetitor()" class="w-full md:w-auto px-8 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                        <i class="fas fa-chart-bar mr-2"></i>ê²½ìŸë ¥ ë¶„ì„í•˜ê¸°
                    </button>
                    
                    <div id="competitorResult" class="hidden mt-8">
                        <div class="bg-purple-50 border-l-4 border-purple-600 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">ë²¤ì¹˜ë§ˆí‚¹ ê²°ê³¼</h3>
                            <canvas id="competitorChart" class="max-w-2xl mx-auto"></canvas>
                            <div class="mt-6 grid md:grid-cols-2 gap-4">
                                <div class="bg-white p-4 rounded-lg">
                                    <h4 class="font-semibold mb-3 text-green-600">ğŸ’ª ìš°ë¦¬ì˜ ê°•ì </h4>
                                    <ul id="strengths" class="space-y-2 text-sm"></ul>
                                </div>
                                <div class="bg-white p-4 rounded-lg">
                                    <h4 class="font-semibold mb-3 text-orange-600">ğŸ“ˆ ê°œì„  í¬ì¸íŠ¸</h4>
                                    <ul id="improvements" class="space-y-2 text-sm"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. ë¦¬ë·° ì‘ë‹µ í…œí”Œë¦¿ ìƒì„±ê¸° -->
            <section id="review" class="mb-12">
                <div class="bg-white rounded-2xl shadow-sm p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-star text-yellow-500 mr-3"></i>
                        ë¦¬ë·° ì‘ë‹µ ìë™ ìƒì„±ê¸°
                    </h2>
                    <p class="text-gray-600 mb-6">ê³ ê° ë¦¬ë·°ì— ë§ì¶¤í˜• ì‘ë‹µì„ ìë™ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”</p>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë¦¬ë·° ìœ í˜• ì„ íƒ</label>
                        <select id="reviewType" class="w-full px-4 py-3 border rounded-lg">
                            <option value="positive">ê¸ì •ì  ë¦¬ë·° (â­â­â­â­â­)</option>
                            <option value="neutral">ë³´í†µ ë¦¬ë·° (â­â­â­)</option>
                            <option value="negative">ë¶€ì •ì  ë¦¬ë·° (â­â­)</option>
                        </select>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë¦¬ë·° ë‚´ìš© (ì„ íƒ)</label>
                        <textarea id="reviewContent" rows="3" placeholder="ì˜ˆ: ì„ ìƒë‹˜ì´ ì¹œì ˆí•˜ì‹œê³  ì„¤ëª…ì„ ì˜í•´ì£¼ì…”ì„œ ì•„ì´ê°€ ì¢‹ì•„í•©ë‹ˆë‹¤" 
                                  class="w-full px-4 py-3 border rounded-lg"></textarea>
                    </div>
                    
                    <button onclick="generateReviewResponse()" class="w-full md:w-auto px-8 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold">
                        <i class="fas fa-magic mr-2"></i>ì‘ë‹µ ìƒì„±í•˜ê¸°
                    </button>
                    
                    <div id="reviewResponse" class="hidden mt-8">
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded-lg">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">ì¶”ì²œ ì‘ë‹µ</h3>
                            <div class="bg-white p-6 rounded-lg mb-4">
                                <p id="responseText" class="text-gray-800 leading-relaxed whitespace-pre-wrap"></p>
                            </div>
                            <button onclick="copyResponse()" class="px-6 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                                <i class="fas fa-copy mr-2"></i>ë³µì‚¬í•˜ê¸°
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. í”Œë ˆì´ìŠ¤ ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
            <section id="optimization" class="mb-12">
                <div class="bg-white rounded-2xl shadow-sm p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-check-circle text-green-600 mr-3"></i>
                        í”Œë ˆì´ìŠ¤ ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸
                    </h2>
                    <p class="text-gray-600 mb-6">ìƒìœ„ë…¸ì¶œì„ ìœ„í•œ í•„ìˆ˜ ì²´í¬ í¬ì¸íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                    
                    <div class="space-y-4">
                        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <input type="checkbox" id="check1" class="w-6 h-6 mt-1 text-green-600 rounded">
                            <label for="check1" class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-900">ì •í™•í•œ ì¹´í…Œê³ ë¦¬ ì„¤ì •</div>
                                <div class="text-sm text-gray-600">ì—…ì¢…ì— ë§ëŠ” ì •í™•í•œ ì¹´í…Œê³ ë¦¬ë¥¼ 1ìˆœìœ„ë¡œ ì„¤ì •í–ˆë‚˜ìš”?</div>
                            </label>
                        </div>
                        
                        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <input type="checkbox" id="check2" class="w-6 h-6 mt-1 text-green-600 rounded">
                            <label for="check2" class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-900">ìƒì„¸ ì •ë³´ 100% ì…ë ¥</div>
                                <div class="text-sm text-gray-600">ì˜ì—…ì‹œê°„, ì „í™”ë²ˆí˜¸, ì£¼ì†Œ, í™ˆí˜ì´ì§€ ë“± ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í–ˆë‚˜ìš”?</div>
                            </label>
                        </div>
                        
                        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <input type="checkbox" id="check3" class="w-6 h-6 mt-1 text-green-600 rounded">
                            <label for="check3" class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-900">ê³ í€„ë¦¬í‹° ì‚¬ì§„ ë“±ë¡</div>
                                <div class="text-sm text-gray-600">ë‚´ë¶€/ì™¸ë¶€ ì‚¬ì§„ 10ì¥ ì´ìƒ, í•´ìƒë„ ë†’ì€ ì‚¬ì§„ì„ ë“±ë¡í–ˆë‚˜ìš”?</div>
                            </label>
                        </div>
                        
                        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <input type="checkbox" id="check4" class="w-6 h-6 mt-1 text-green-600 rounded">
                            <label for="check4" class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-900">ì •ê¸°ì ì¸ ê²Œì‹œê¸€ ì—…ë¡œë“œ</div>
                                <div class="text-sm text-gray-600">ì£¼ 2-3íšŒ ì´ìƒ ì†Œì‹, ì´ë²¤íŠ¸, ìˆ˜ì—… í›„ê¸° ë“±ì„ ì˜¬ë¦¬ê³  ìˆë‚˜ìš”?</div>
                            </label>
                        </div>
                        
                        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <input type="checkbox" id="check5" class="w-6 h-6 mt-1 text-green-600 rounded">
                            <label for="check5" class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-900">ë¦¬ë·° ê´€ë¦¬ (ì‘ë‹µë¥  80% ì´ìƒ)</div>
                                <div class="text-sm text-gray-600">ëª¨ë“  ë¦¬ë·°ì— 24ì‹œê°„ ë‚´ ì •ì„±ìŠ¤ëŸ¬ìš´ ë‹µë³€ì„ ë‹¬ê³  ìˆë‚˜ìš”?</div>
                            </label>
                        </div>
                        
                        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <input type="checkbox" id="check6" class="w-6 h-6 mt-1 text-green-600 rounded">
                            <label for="check6" class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-900">ì˜ˆì•½ / ë¬¸ì˜ ê¸°ëŠ¥ í™œì„±í™”</div>
                                <div class="text-sm text-gray-600">ë„¤ì´ë²„ ì˜ˆì•½ ë˜ëŠ” í†¡í†¡ ìƒë‹´ì„ ì¼œë‘ì—ˆë‚˜ìš”?</div>
                            </label>
                        </div>
                        
                        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <input type="checkbox" id="check7" class="w-6 h-6 mt-1 text-green-600 rounded">
                            <label for="check7" class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-900">ë©”ë‰´/ê°€ê²© ì •ë³´ ê³µê°œ</div>
                                <div class="text-sm text-gray-600">ìˆ˜ì—…ë£Œ, ìˆ˜ê°• í”„ë¡œê·¸ë¨ ë“± íˆ¬ëª…í•œ ê°€ê²© ì •ë³´ë¥¼ ì œê³µí•˜ë‚˜ìš”?</div>
                            </label>
                        </div>
                        
                        <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                            <input type="checkbox" id="check8" class="w-6 h-6 mt-1 text-green-600 rounded">
                            <label for="check8" class="flex-1 cursor-pointer">
                                <div class="font-semibold text-gray-900">í‚¤ì›Œë“œ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨</div>
                                <div class="text-sm text-gray-600">ì†Œê°œê¸€ê³¼ ê²Œì‹œê¸€ì— ì§€ì—­+ì—…ì¢… í‚¤ì›Œë“œê°€ ìì—°ìŠ¤ëŸ½ê²Œ ë“¤ì–´ê°€ ìˆë‚˜ìš”?</div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mt-8 p-6 bg-green-50 rounded-lg">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-lg font-semibold text-gray-900">ìµœì í™” ì ìˆ˜</span>
                            <span id="optimizationScore" class="text-3xl font-bold text-green-600">0/8</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div id="optimizationBar" class="bg-green-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-gray-600 mt-3">ğŸ’¡ 8ê°œ í•­ëª©ì„ ëª¨ë‘ ì²´í¬í•˜ë©´ ìƒìœ„ë…¸ì¶œ í™•ë¥ ì´ í¬ê²Œ ë†’ì•„ì§‘ë‹ˆë‹¤!</p>
                    </div>
                </div>
            </section>

            <!-- 5. ìµœì  ì˜ì—…ì‹œê°„ ì¶”ì²œ -->
            <section class="mb-12">
                <div class="bg-white rounded-2xl shadow-sm p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">
                        <i class="fas fa-clock text-indigo-600 mr-3"></i>
                        ìµœì  ì˜ì—…ì‹œê°„ & ê²Œì‹œ ì‹œê°„ ì¶”ì²œ
                    </h2>
                    <p class="text-gray-600 mb-6">í•™ì› ì—…ì¢… íŠ¹ì„±ì— ë§ëŠ” ìµœì ì˜ ìš´ì˜ ì‹œê°„ì„ ì¶”ì²œí•©ë‹ˆë‹¤</p>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="p-6 bg-indigo-50 rounded-lg">
                            <h3 class="font-bold text-gray-900 mb-4">ğŸ“Œ ì¶”ì²œ ì˜ì—…ì‹œê°„</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">í‰ì¼</span>
                                    <span class="font-semibold">14:00 - 22:00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">ì£¼ë§</span>
                                    <span class="font-semibold">09:00 - 18:00</span>
                                </div>
                                <p class="text-xs text-gray-500 mt-3">* í•™ì› ì—…ì¢…ì€ ë°©ê³¼ í›„ ~ ì €ë… ì‹œê°„ëŒ€ ì§‘ì¤‘ ë…¸ì¶œì´ ìœ ë¦¬í•©ë‹ˆë‹¤</p>
                            </div>
                        </div>
                        
                        <div class="p-6 bg-indigo-50 rounded-lg">
                            <h3 class="font-bold text-gray-900 mb-4">ğŸ“± ì¶”ì²œ ê²Œì‹œê¸€ ì—…ë¡œë“œ ì‹œê°„</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex items-center gap-2">
                                    <span class="w-24 text-gray-600">í‰ì¼ ì˜¤ì „</span>
                                    <span class="font-semibold">10:00 - 11:00</span>
                                    <span class="text-xs text-gray-500">(í•™ë¶€ëª¨ í™œë™ ì‹œê°„)</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-24 text-gray-600">í‰ì¼ ì €ë…</span>
                                    <span class="font-semibold">19:00 - 20:00</span>
                                    <span class="text-xs text-gray-500">(í‡´ê·¼ í›„ ê²€ìƒ‰)</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-24 text-gray-600">ì£¼ë§</span>
                                    <span class="font-semibold">11:00 - 13:00</span>
                                    <span class="text-xs text-gray-500">(ì£¼ë§ í•™ì› ê²€ìƒ‰)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>

        <script>
            // í‚¤ì›Œë“œ ë¶„ì„
            function analyzeKeyword() {
                const location = document.getElementById('location').value.trim();
                const keyword = document.getElementById('keyword').value.trim();
                
                if (!location || !keyword) {
                    alert('ì§€ì—­ê³¼ í‚¤ì›Œë“œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°
                const searchVolume = Math.floor(Math.random() * 1500) + 500;
                const competition = ['ë‚®ìŒ', 'ë³´í†µ', 'ë†’ìŒ'][Math.floor(Math.random() * 3)];
                const score = Math.floor(Math.random() * 30) + 70;
                
                document.getElementById('searchVolume').textContent = searchVolume.toLocaleString();
                document.getElementById('competition').textContent = competition;
                document.getElementById('competition').className = 'text-3xl font-bold ' + 
                    (competition === 'ë‚®ìŒ' ? 'text-green-600' : competition === 'ë³´í†µ' ? 'text-yellow-600' : 'text-red-600');
                document.getElementById('score').textContent = score;
                
                // ì¶”ì²œ í‚¤ì›Œë“œ
                const suggestions = [
                    \`\${location} \${keyword}\`,
                    \`\${location} \${keyword} ì¶”ì²œ\`,
                    \`\${location} \${keyword} ê°€ê²©\`,
                    \`\${location} ì´ˆë“± \${keyword}\`,
                    \`\${location} ì¤‘ë“± \${keyword}\`,
                ];
                
                const suggestionsHTML = suggestions.map(s => 
                    \`<div class="flex items-center gap-3 text-sm">
                        <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full font-medium">\${s}</span>
                        <span class="text-gray-500">ê²€ìƒ‰ëŸ‰: \${Math.floor(Math.random() * 500) + 100}</span>
                    </div>\`
                ).join('');
                
                document.getElementById('keywordSuggestions').innerHTML = suggestionsHTML;
                document.getElementById('keywordResult').classList.remove('hidden');
                
                // ìŠ¤í¬ë¡¤
                document.getElementById('keywordResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            // ê²½ìŸì‚¬ ë¶„ì„
            let competitorChart = null;
            
            function analyzeCompetitor() {
                const myAcademy = document.getElementById('myAcademy').value.trim();
                const myReviews = parseInt(document.getElementById('myReviews').value) || 0;
                const myRating = parseFloat(document.getElementById('myRating').value) || 0;
                
                if (!myAcademy) {
                    alert('í•™ì›ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°
                const competitors = [
                    { name: 'ê²½ìŸì‚¬ A', reviews: Math.floor(Math.random() * 100) + 50, rating: (Math.random() * 1 + 4).toFixed(1) },
                    { name: 'ê²½ìŸì‚¬ B', reviews: Math.floor(Math.random() * 100) + 50, rating: (Math.random() * 1 + 4).toFixed(1) },
                    { name: 'ê²½ìŸì‚¬ C', reviews: Math.floor(Math.random() * 100) + 50, rating: (Math.random() * 1 + 4).toFixed(1) },
                ];
                
                const avgReviews = Math.floor((competitors.reduce((sum, c) => sum + c.reviews, 0)) / 3);
                const avgRating = (competitors.reduce((sum, c) => sum + parseFloat(c.rating), 0) / 3).toFixed(1);
                
                // ì°¨íŠ¸ ìƒì„±
                const ctx = document.getElementById('competitorChart');
                if (competitorChart) competitorChart.destroy();
                
                competitorChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [myAcademy, ...competitors.map(c => c.name), 'í‰ê· '],
                        datasets: [{
                            label: 'ë¦¬ë·° ìˆ˜',
                            data: [myReviews, ...competitors.map(c => c.reviews), avgReviews],
                            backgroundColor: ['#3B82F6', '#E5E7EB', '#E5E7EB', '#E5E7EB', '#FCD34D'],
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
                
                // ê°•ì /ê°œì„ ì 
                const strengths = [];
                const improvements = [];
                
                if (myReviews > avgReviews) strengths.push('ë¦¬ë·° ìˆ˜ê°€ í‰ê· ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤');
                else improvements.push(\`ë¦¬ë·°ë¥¼ \${avgReviews - myReviews}ê°œ ë” í™•ë³´í•˜ì„¸ìš”\`);
                
                if (myRating >= parseFloat(avgRating)) strengths.push('í‰ì ì´ í‰ê·  ì´ìƒì…ë‹ˆë‹¤');
                else improvements.push('í‰ì ì„ ë†’ì´ê¸° ìœ„í•´ ì„œë¹„ìŠ¤ í’ˆì§ˆ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤');
                
                if (myReviews < 50) improvements.push('ë¦¬ë·° 50ê°œ ì´ìƒ í™•ë³´ë¥¼ ëª©í‘œë¡œ í•˜ì„¸ìš”');
                if (myRating < 4.5) improvements.push('4.5ì  ì´ìƒ í‰ì  ìœ ì§€ë¥¼ ìœ„í•´ ë…¸ë ¥í•˜ì„¸ìš”');
                
                document.getElementById('strengths').innerHTML = strengths.map(s => 
                    \`<li class="flex items-start gap-2"><span class="text-green-600">âœ“</span><span>\${s}</span></li>\`
                ).join('') || '<li class="text-gray-500">ë¶„ì„ ê²°ê³¼ ì—†ìŒ</li>';
                
                document.getElementById('improvements').innerHTML = improvements.map(s => 
                    \`<li class="flex items-start gap-2"><span class="text-orange-600">â†’</span><span>\${s}</span></li>\`
                ).join('') || '<li class="text-gray-500">ë¶„ì„ ê²°ê³¼ ì—†ìŒ</li>';
                
                document.getElementById('competitorResult').classList.remove('hidden');
                document.getElementById('competitorResult').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            // ë¦¬ë·° ì‘ë‹µ ìƒì„±
            function generateReviewResponse() {
                const type = document.getElementById('reviewType').value;
                const content = document.getElementById('reviewContent').value.trim();
                
                const responses = {
                    positive: [
                        "ì†Œì¤‘í•œ ë¦¬ë·° ì •ë§ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤! ğŸ˜Š\\n{name} í•™ë¶€ëª¨ë‹˜ì˜ ë”°ëœ»í•œ ë§ì”€ì— ì €í¬ ëª¨ë“  ì„ ìƒë‹˜ë“¤ì´ í° í˜ì„ ì–»ìŠµë‹ˆë‹¤.\\nì•ìœ¼ë¡œë„ í•™ìƒì˜ ì„±ì¥ì„ ìœ„í•´ ìµœì„ ì„ ë‹¤í•˜ëŠ” {academy}ì´ ë˜ê² ìŠµë‹ˆë‹¤.\\ní•­ìƒ ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ™",
                        "ë¦¬ë·° ë‚¨ê²¨ì£¼ì…”ì„œ ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬í•©ë‹ˆë‹¤! â¤ï¸\\ní•™ìƒì´ ì¦ê²ê²Œ ê³µë¶€í•˜ëŠ” ëª¨ìŠµì„ ë³´ë‹ˆ ì €í¬ë„ ì •ë§ ë¿Œë“¯í•©ë‹ˆë‹¤.\\në” ë‚˜ì€ ìˆ˜ì—…, ë” ì¢‹ì€ ê²°ê³¼ë¡œ ë³´ë‹µí•˜ê² ìŠµë‹ˆë‹¤.\\nì–¸ì œë“ ì§€ ê¶ê¸ˆí•œ ì  ìˆìœ¼ì‹œë©´ í¸í•˜ê²Œ ì—°ë½ì£¼ì„¸ìš”! ğŸ˜Š"
                    ],
                    neutral: [
                        "ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤.\\në” ë‚˜ì€ ìˆ˜ì—… í™˜ê²½ì„ ë§Œë“¤ê¸° ìœ„í•´ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤.\\ní˜¹ì‹œ ê°œì„ ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ì–¸ì œë“  ë§ì”€í•´ ì£¼ì„¸ìš”!\\n{name} í•™ìƒì˜ ë°œì „ì„ ìœ„í•´ ìµœì„ ì„ ë‹¤í•˜ê² ìŠµë‹ˆë‹¤. ğŸ™",
                        "ë¦¬ë·° ë‚¨ê²¨ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!\\ní•™ë¶€ëª¨ë‹˜ì˜ ì˜ê²¬ì„ ë°˜ì˜í•˜ì—¬ ë” ë‚˜ì€ í•™ì›ì´ ë˜ë„ë¡ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤.\\nì•ìœ¼ë¡œë„ ë§ì€ ê´€ì‹¬ ë¶€íƒë“œë¦½ë‹ˆë‹¤. ğŸ˜Š"
                    ],
                    negative: [
                        "ë¶ˆí¸ì„ ë“œë ¤ ì •ë§ ì£„ì†¡í•©ë‹ˆë‹¤. ğŸ˜”\\në§ì”€í•´ì£¼ì‹  ë¶€ë¶„ì€ ì¦‰ì‹œ ê°œì„ í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.\\ní•™ë¶€ëª¨ë‹˜ê³¼ ì§ì ‘ í†µí™”í•˜ì—¬ ìì„¸í•œ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ„ê³  ì‹¶ìŠµë‹ˆë‹¤.\\ní•™ì›ìœ¼ë¡œ ì—°ë½ ì£¼ì‹œë©´ ì„±ì‹¬ì„±ì˜ê» í•´ê²°í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\\në‹¤ì‹œ í•œë²ˆ ì£„ì†¡í•˜ë‹¤ëŠ” ë§ì”€ ë“œë¦½ë‹ˆë‹¤.",
                        "ê·€í•œ ì˜ê²¬ ê°ì‚¬ë“œë¦¬ë©°, ë¶ˆí¸ì„ ë“œë¦° ì  ì§„ì‹¬ìœ¼ë¡œ ì‚¬ê³¼ë“œë¦½ë‹ˆë‹¤.\\nì¦‰ì‹œ ë¬¸ì œë¥¼ íŒŒì•…í•˜ì—¬ ê°œì„  ì¡°ì¹˜ë¥¼ ì·¨í•˜ê² ìŠµë‹ˆë‹¤.\\nì§ì ‘ ì°¾ì•„ëµ™ê³  ë§ì”€ë“œë¦¬ê³  ì‹¶ìŠµë‹ˆë‹¤.\\ní•™ì›ìœ¼ë¡œ ì—°ë½ ë¶€íƒë“œë¦½ë‹ˆë‹¤. ğŸ™"
                    ]
                };
                
                const templates = responses[type];
                const response = templates[Math.floor(Math.random() * templates.length)]
                    .replace('{name}', 'í•™ìƒ')
                    .replace('{academy}', 'í•™ì›');
                
                document.getElementById('responseText').textContent = response;
                document.getElementById('reviewResponse').classList.remove('hidden');
                document.getElementById('reviewResponse').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            
            function copyResponse() {
                const text = document.getElementById('responseText').textContent;
                navigator.clipboard.writeText(text).then(() => {
                    alert('âœ… ì‘ë‹µì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                });
            }
            
            // ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateOptimizationScore);
            });
            
            function updateOptimizationScore() {
                const total = 8;
                const checked = document.querySelectorAll('input[type="checkbox"]:checked').length;
                const percentage = Math.round((checked / total) * 100);
                
                document.getElementById('optimizationScore').textContent = \`\${checked}/\${total}\`;
                document.getElementById('optimizationBar').style.width = percentage + '%';
            }
        </script>
    </body>
    </html>
  \`)
})
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œ êµìœ¡ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <meta name="description" content="ë„¤ì´ë²„ ë¸”ë¡œê·¸ ê²€ìƒ‰ ìµœìƒìœ„ ì§„ì…ì„ ìœ„í•œ SEO ìµœì í™” ì‹¤ì „ êµìœ¡">
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm fixed w-full top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold gradient-orange bg-clip-text text-transparent">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <div class="hidden md:flex space-x-8">
                        <a href="/" class="text-gray-600 hover:text-orange-500">í™ˆ</a>
                        <a href="/about" class="text-gray-600 hover:text-orange-500">íšŒì‚¬ ì†Œê°œ</a>
                        <a href="/contact" class="text-gray-600 hover:text-orange-500">ëŒ€í–‰ ë¬¸ì˜</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-20">
            <!-- Hero Section -->
            <section class="bg-gradient-to-br from-pink-50 to-white py-20 px-6">
                <div class="max-w-4xl mx-auto text-center">
                    <div class="w-20 h-20 gradient-orange rounded-3xl flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-blog text-3xl text-white"></i>
                    </div>
                    <h1 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-6">
                        ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œ
                    </h1>
                    <p class="text-xl text-gray-600 mb-8">
                        ë„¤ì´ë²„ ë¸”ë¡œê·¸ ê²€ìƒ‰ ìµœìƒìœ„ ì§„ì… ì „ëµ<br>
                        SEO ìµœì í™”ì™€ ì½˜í…ì¸  ê¸°íšì˜ ëª¨ë“  ê²ƒ
                    </p>
                    <div class="flex flex-wrap justify-center gap-4">
                        <a href="/contact" class="px-8 py-4 gradient-orange text-white rounded-full font-bold hover:shadow-lg transition-all">
                            êµìœ¡ ì‹ ì²­í•˜ê¸°
                        </a>
                        <a href="/" class="px-8 py-4 bg-white text-gray-700 rounded-full font-bold border-2 border-gray-200 hover:border-pink-500 transition-all">
                            ëŒì•„ê°€ê¸°
                        </a>
                    </div>
                </div>
            </section>

            <!-- êµìœ¡ ë‚´ìš© -->
            <section class="py-20 px-6">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-900 mb-12 text-center">ë¬´ì—‡ì„ ë°°ìš°ë‚˜ìš”?</h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="bg-white rounded-2xl p-8 shadow-sm">
                            <div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-brain text-pink-600 text-xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-3">ê²€ìƒ‰ ì•Œê³ ë¦¬ì¦˜ ì™„ë²½ ì´í•´</h3>
                            <ul class="space-y-2 text-gray-600">
                                <li>âœ“ ë„¤ì´ë²„ ê²€ìƒ‰ ë¡œì§ ë¶„ì„</li>
                                <li>âœ“ ìƒìœ„ë…¸ì¶œ í•µì‹¬ ìš”ì†Œ</li>
                                <li>âœ“ C-Rank, DA ì ìˆ˜ ì´í•´</li>
                                <li>âœ“ ì•Œê³ ë¦¬ì¦˜ ë³€í™” ëŒ€ì‘ë²•</li>
                            </ul>
                        </div>

                        <div class="bg-white rounded-2xl p-8 shadow-sm">
                            <div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-pen text-pink-600 text-xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-3">SEO ìµœì í™” ê¸€ì“°ê¸°</h3>
                            <ul class="space-y-2 text-gray-600">
                                <li>âœ“ í‚¤ì›Œë“œ ë¦¬ì„œì¹˜ ë°©ë²•</li>
                                <li>âœ“ ì œëª©/ë³¸ë¬¸ ìµœì í™”</li>
                                <li>âœ“ ì´ë¯¸ì§€ SEO ì „ëµ</li>
                                <li>âœ“ ë‚´ë¶€ë§í¬ í™œìš©ë²•</li>
                            </ul>
                        </div>

                        <div class="bg-white rounded-2xl p-8 shadow-sm">
                            <div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-lightbulb text-pink-600 text-xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-3">ì½˜í…ì¸  ê¸°íš ì „ëµ</h3>
                            <ul class="space-y-2 text-gray-600">
                                <li>âœ“ í•™ì›ì—… íŠ¹í™” ì£¼ì œ ë°œêµ´</li>
                                <li>âœ“ ì‹œë¦¬ì¦ˆ ì½˜í…ì¸  ê¸°íš</li>
                                <li>âœ“ ê³„ì ˆë³„ ì½˜í…ì¸  ì „ëµ</li>
                                <li>âœ“ ë°”ì´ëŸ´ ì½˜í…ì¸  ì œì‘</li>
                            </ul>
                        </div>

                        <div class="bg-white rounded-2xl p-8 shadow-sm">
                            <div class="w-12 h-12 bg-pink-100 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-rocket text-pink-600 text-xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-3">ì§€ì† ì„±ì¥ ì „ëµ</h3>
                            <ul class="space-y-2 text-gray-600">
                                <li>âœ“ í¬ìŠ¤íŒ… ì£¼ê¸° ê´€ë¦¬</li>
                                <li>âœ“ ì´ì›ƒ ê´€ë¦¬ ë…¸í•˜ìš°</li>
                                <li>âœ“ ê³µê°/ëŒ“ê¸€ ì „ëµ</li>
                                <li>âœ“ í†µê³„ ë¶„ì„ ë° ê°œì„ </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ì‹¤ì œ ì„±ê³¼ -->
            <section class="py-20 px-6 bg-white">
                <div class="max-w-4xl mx-auto text-center">
                    <h2 class="text-3xl font-bold text-gray-900 mb-12">ì‹¤ì œ ì„±ê³¼</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div>
                            <div class="text-5xl font-bold text-pink-600 mb-2">Top 3</div>
                            <div class="text-gray-600">í‰ê·  ë‹¬ì„± ê¸°ê°„<br>1-2ê°œì›”</div>
                        </div>
                        <div>
                            <div class="text-5xl font-bold text-pink-600 mb-2">500%</div>
                            <div class="text-gray-600">í‰ê·  ë°©ë¬¸ì ì¦ê°€ìœ¨</div>
                        </div>
                        <div>
                            <div class="text-5xl font-bold text-pink-600 mb-2">50+</div>
                            <div class="text-gray-600">ì›”í‰ê·  ì‹ ê·œ ë¬¸ì˜</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CTA -->
            <section class="py-20 px-6 gradient-orange">
                <div class="max-w-4xl mx-auto text-center">
                    <h2 class="text-4xl font-bold text-white mb-8">
                        ì§€ê¸ˆ ë°”ë¡œ ì‹œì‘í•˜ì„¸ìš”
                    </h2>
                    <p class="text-xl text-white/90 mb-12">
                        ê²€ìƒ‰ 1í˜ì´ì§€ ì§„ì…, ë” ì´ìƒ ì–´ë µì§€ ì•ŠìŠµë‹ˆë‹¤
                    </p>
                    <a href="/contact" class="inline-block px-12 py-5 bg-white text-pink-600 rounded-full font-bold text-lg hover:shadow-2xl transition-all">
                        êµìœ¡ ì‹ ì²­í•˜ê¸° â†’
                    </a>
                </div>
            </section>
        </div>
    </body>
    </html>
  `)
})

// êµìœ¡ í”„ë¡œê·¸ë¨ ìƒì„¸ í˜ì´ì§€ - í¼ë„ ë§ˆì¼€íŒ…
app.get('/programs/funnel', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í¼ë„ ë§ˆì¼€íŒ… êµìœ¡ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <meta name="description" content="ìë™í™” í¼ë„ë¡œ 24ì‹œê°„ í•™ìƒ ëª¨ì§‘ ì‹œìŠ¤í…œ êµ¬ì¶• ì‹¤ì „ êµìœ¡">
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm fixed w-full top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold gradient-purple bg-clip-text text-transparent">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <div class="hidden md:flex space-x-8">
                        <a href="/" class="text-gray-600 hover:text-purple-600">í™ˆ</a>
                        <a href="/about" class="text-gray-600 hover:text-purple-600">íšŒì‚¬ ì†Œê°œ</a>
                        <a href="/contact" class="text-gray-600 hover:text-purple-600">ëŒ€í–‰ ë¬¸ì˜</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-20">
            <!-- Hero Section -->
            <section class="bg-gradient-to-br from-purple-50 to-white py-20 px-6">
                <div class="max-w-4xl mx-auto text-center">
                    <div class="w-20 h-20 gradient-purple rounded-3xl flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-filter text-3xl text-white"></i>
                    </div>
                    <h1 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-6">
                        í¼ë„ ë§ˆì¼€íŒ…
                    </h1>
                    <p class="text-xl text-gray-600 mb-8">
                        ìë™í™” í¼ë„ë¡œ 24ì‹œê°„ í•™ìƒ ëª¨ì§‘<br>
                        ëœë”©í˜ì´ì§€ë¶€í„° ì „í™˜ê¹Œì§€ ì™„ë²½í•œ ì‹œìŠ¤í…œ êµ¬ì¶•
                    </p>
                    <div class="flex flex-wrap justify-center gap-4">
                        <a href="/contact" class="px-8 py-4 gradient-purple text-white rounded-full font-bold hover:shadow-lg transition-all">
                            êµìœ¡ ì‹ ì²­í•˜ê¸°
                        </a>
                        <a href="/" class="px-8 py-4 bg-white text-gray-700 rounded-full font-bold border-2 border-gray-200 hover:border-purple-600 transition-all">
                            ëŒì•„ê°€ê¸°
                        </a>
                    </div>
                </div>
            </section>

            <!-- êµìœ¡ ë‚´ìš© -->
            <section class="py-20 px-6">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-900 mb-12 text-center">ë¬´ì—‡ì„ ë°°ìš°ë‚˜ìš”?</h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="bg-white rounded-2xl p-8 shadow-sm">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-file-alt text-purple-600 text-xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-3">ëœë”©í˜ì´ì§€ ì œì‘</h3>
                            <ul class="space-y-2 text-gray-600">
                                <li>âœ“ ê³ ì „í™˜ ëœë”©í˜ì´ì§€ ì„¤ê³„</li>
                                <li>âœ“ ì¹´í”¼ë¼ì´íŒ… ê¸°ë²•</li>
                                <li>âœ“ CTA ìµœì í™” ì „ëµ</li>
                                <li>âœ“ ë¬´ë£Œ ë„êµ¬ í™œìš©ë²•</li>
                            </ul>
                        </div>

                        <div class="bg-white rounded-2xl p-8 shadow-sm">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-ad text-purple-600 text-xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-3">ê´‘ê³  ìš´ì˜ ì „ëµ</h3>
                            <ul class="space-y-2 text-gray-600">
                                <li>âœ“ ë„¤ì´ë²„/êµ¬ê¸€ ê´‘ê³  ì„¸íŒ…</li>
                                <li>âœ“ íƒ€ê²ŸíŒ… ìµœì í™”</li>
                                <li>âœ“ ì˜ˆì‚° ê´€ë¦¬ ë…¸í•˜ìš°</li>
                                <li>âœ“ A/B í…ŒìŠ¤íŠ¸ ë°©ë²•</li>
                            </ul>
                        </div>

                        <div class="bg-white rounded-2xl p-8 shadow-sm">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-robot text-purple-600 text-xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-3">ìë™í™” ì‹œìŠ¤í…œ êµ¬ì¶•</h3>
                            <ul class="space-y-2 text-gray-600">
                                <li>âœ“ ì±—ë´‡ ìƒë‹´ ì‹œìŠ¤í…œ</li>
                                <li>âœ“ ìë™ SMS/ì´ë©”ì¼</li>
                                <li>âœ“ CRM ë„êµ¬ í™œìš©</li>
                                <li>âœ“ ë¦¬íƒ€ê²ŒíŒ… ì „ëµ</li>
                            </ul>
                        </div>

                        <div class="bg-white rounded-2xl p-8 shadow-sm">
                            <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                                <i class="fas fa-chart-pie text-purple-600 text-xl"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-900 mb-3">ì „í™˜ìœ¨ ìµœì í™”</h3>
                            <ul class="space-y-2 text-gray-600">
                                <li>âœ“ ê³ ê° ì—¬ì • ì„¤ê³„</li>
                                <li>âœ“ ë°ì´í„° ë¶„ì„ ë° ê°œì„ </li>
                                <li>âœ“ ì „í™˜ í¬ì¸íŠ¸ ìµœì í™”</li>
                                <li>âœ“ ROI ê·¹ëŒ€í™” ì „ëµ</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ì‹¤ì œ ì„±ê³¼ -->
            <section class="py-20 px-6 bg-white">
                <div class="max-w-4xl mx-auto text-center">
                    <h2 class="text-3xl font-bold text-gray-900 mb-12">ì‹¤ì œ ì„±ê³¼</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div>
                            <div class="text-5xl font-bold text-purple-600 mb-2">24ì‹œê°„</div>
                            <div class="text-gray-600">ìë™ ìƒë‹´ ì‹œìŠ¤í…œ<br>ìš´ì˜</div>
                        </div>
                        <div>
                            <div class="text-5xl font-bold text-purple-600 mb-2">800%</div>
                            <div class="text-gray-600">í‰ê·  ROI<br>ê´‘ê³ ë¹„ ëŒ€ë¹„</div>
                        </div>
                        <div>
                            <div class="text-5xl font-bold text-purple-600 mb-2">70%</div>
                            <div class="text-gray-600">í‰ê·  ì „í™˜ìœ¨<br>ë¬¸ì˜â†’ë“±ë¡</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CTA -->
            <section class="py-20 px-6 gradient-purple">
                <div class="max-w-4xl mx-auto text-center">
                    <h2 class="text-4xl font-bold text-white mb-8">
                        ì§€ê¸ˆ ë°”ë¡œ ì‹œì‘í•˜ì„¸ìš”
                    </h2>
                    <p class="text-xl text-white/90 mb-12">
                        ìëŠ” ë™ì•ˆì—ë„ í•™ìƒì´ ëª¨ì§‘ë˜ëŠ” ì‹œìŠ¤í…œì„ ë§Œë“œì„¸ìš”
                    </p>
                    <a href="/contact" class="inline-block px-12 py-5 bg-white text-purple-600 rounded-full font-bold text-lg hover:shadow-2xl transition-all">
                        êµìœ¡ ì‹ ì²­í•˜ê¸° â†’
                    </a>
                </div>
            </section>
        </div>
    </body>
    </html>
  `)
})



// SNS ë§ˆì¼€íŒ…
app.get('/programs/sns', (c) => c.html(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>SNS ë§ˆì¼€íŒ… - ìŠˆí¼í”Œë ˆì´ìŠ¤</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"></head><body class="bg-gray-50"><nav class="bg-white shadow-sm border-b sticky top-0 z-50"><div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center"><a href="/" class="text-2xl font-bold text-blue-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a><div class="flex gap-4"><button onclick="history.back()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"><i class="fas fa-arrow-left mr-2"></i>ë’¤ë¡œ ê°€ê¸°</button><a href="/programs" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">í”„ë¡œê·¸ë¨ ëª©ë¡</a></div></div></nav><main class="max-w-5xl mx-auto px-6 py-16"><div class="text-center mb-12"><div class="text-6xl mb-4">ğŸ“±</div><h1 class="text-4xl font-bold text-gray-900 mb-4">SNS ë§ˆì¼€íŒ…</h1><p class="text-xl text-gray-600">ì¸ìŠ¤íƒ€ê·¸ë¨, í˜ì´ìŠ¤ë¶ìœ¼ë¡œ í•™ìƒ ëª¨ì§‘</p></div><div class="bg-white rounded-2xl p-8 shadow-sm mb-8"><h2 class="text-2xl font-bold mb-6">ğŸ¯ í”„ë¡œê·¸ë¨ ì§„í–‰ì¤‘</h2><p class="text-gray-600 text-center py-8">ì´ í”„ë¡œê·¸ë¨ì€ í˜„ì¬ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>ìì„¸í•œ ë‚´ìš©ì€ êµìœ¡ ì‹ ì²­ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div><div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-2xl p-12 text-center text-white"><h2 class="text-3xl font-bold mb-4">í”„ë¡œê·¸ë¨ ì‹œì‘í•˜ê¸°</h2><p class="text-xl mb-8">SNS ë§ˆì¼€íŒ…ìœ¼ë¡œ í•™ì›ì„ ì„±ì¥ì‹œí‚¤ì„¸ìš”</p><a href="/contact" class="inline-block px-8 py-4 bg-white text-blue-600 rounded-lg font-semibold hover:shadow-lg">êµìœ¡ ì‹ ì²­í•˜ê¸° â†’</a></div></main></body></html>`))

// ì˜ìƒ ë§ˆì¼€íŒ…
app.get('/programs/video', (c) => c.html(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ì˜ìƒ ë§ˆì¼€íŒ… - ìŠˆí¼í”Œë ˆì´ìŠ¤</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"></head><body class="bg-gray-50"><nav class="bg-white shadow-sm border-b sticky top-0 z-50"><div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center"><a href="/" class="text-2xl font-bold text-red-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a><div class="flex gap-4"><button onclick="history.back()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"><i class="fas fa-arrow-left mr-2"></i>ë’¤ë¡œ ê°€ê¸°</button><a href="/programs" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">í”„ë¡œê·¸ë¨ ëª©ë¡</a></div></div></nav><main class="max-w-5xl mx-auto px-6 py-16"><div class="text-center mb-12"><div class="text-6xl mb-4">ğŸ¥</div><h1 class="text-4xl font-bold text-gray-900 mb-4">ì˜ìƒ ë§ˆì¼€íŒ…</h1><p class="text-xl text-gray-600">ìœ íŠœë¸Œ, ìˆí¼ìœ¼ë¡œ í•™ì› í™ë³´</p></div><div class="bg-white rounded-2xl p-8 shadow-sm mb-8"><h2 class="text-2xl font-bold mb-6">ğŸ¯ í”„ë¡œê·¸ë¨ ì§„í–‰ì¤‘</h2><p class="text-gray-600 text-center py-8">ì´ í”„ë¡œê·¸ë¨ì€ í˜„ì¬ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>ìì„¸í•œ ë‚´ìš©ì€ êµìœ¡ ì‹ ì²­ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div><div class="bg-gradient-to-r from-red-600 to-red-700 rounded-2xl p-12 text-center text-white"><h2 class="text-3xl font-bold mb-4">í”„ë¡œê·¸ë¨ ì‹œì‘í•˜ê¸°</h2><p class="text-xl mb-8">ì˜ìƒ ë§ˆì¼€íŒ…ìœ¼ë¡œ í•™ì›ì„ ì„±ì¥ì‹œí‚¤ì„¸ìš”</p><a href="/contact" class="inline-block px-8 py-4 bg-white text-red-600 rounded-lg font-semibold hover:shadow-lg">êµìœ¡ ì‹ ì²­í•˜ê¸° â†’</a></div></main></body></html>`))

// ì˜¨ë¼ì¸ ê´‘ê³ 
app.get('/programs/ad', (c) => c.html(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ì˜¨ë¼ì¸ ê´‘ê³  - ìŠˆí¼í”Œë ˆì´ìŠ¤</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"></head><body class="bg-gray-50"><nav class="bg-white shadow-sm border-b sticky top-0 z-50"><div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center"><a href="/" class="text-2xl font-bold text-green-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a><div class="flex gap-4"><button onclick="history.back()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"><i class="fas fa-arrow-left mr-2"></i>ë’¤ë¡œ ê°€ê¸°</button><a href="/programs" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">í”„ë¡œê·¸ë¨ ëª©ë¡</a></div></div></nav><main class="max-w-5xl mx-auto px-6 py-16"><div class="text-center mb-12"><div class="text-6xl mb-4">ğŸ’°</div><h1 class="text-4xl font-bold text-gray-900 mb-4">ì˜¨ë¼ì¸ ê´‘ê³ </h1><p class="text-xl text-gray-600">ë„¤ì´ë²„, êµ¬ê¸€ ê´‘ê³  ìš´ì˜ ì „ëµ</p></div><div class="bg-white rounded-2xl p-8 shadow-sm mb-8"><h2 class="text-2xl font-bold mb-6">ğŸ¯ í”„ë¡œê·¸ë¨ ì§„í–‰ì¤‘</h2><p class="text-gray-600 text-center py-8">ì´ í”„ë¡œê·¸ë¨ì€ í˜„ì¬ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>ìì„¸í•œ ë‚´ìš©ì€ êµìœ¡ ì‹ ì²­ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div><div class="bg-gradient-to-r from-green-600 to-green-700 rounded-2xl p-12 text-center text-white"><h2 class="text-3xl font-bold mb-4">í”„ë¡œê·¸ë¨ ì‹œì‘í•˜ê¸°</h2><p class="text-xl mb-8">ì˜¨ë¼ì¸ ê´‘ê³ ìœ¼ë¡œ í•™ì›ì„ ì„±ì¥ì‹œí‚¤ì„¸ìš”</p><a href="/contact" class="inline-block px-8 py-4 bg-white text-green-600 rounded-lg font-semibold hover:shadow-lg">êµìœ¡ ì‹ ì²­í•˜ê¸° â†’</a></div></main></body></html>`))

// ì»¤ë®¤ë‹ˆí‹° ë§ˆì¼€íŒ…
app.get('/programs/community', (c) => c.html(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ì»¤ë®¤ë‹ˆí‹° ë§ˆì¼€íŒ… - ìŠˆí¼í”Œë ˆì´ìŠ¤</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"></head><body class="bg-gray-50"><nav class="bg-white shadow-sm border-b sticky top-0 z-50"><div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center"><a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a><div class="flex gap-4"><button onclick="history.back()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"><i class="fas fa-arrow-left mr-2"></i>ë’¤ë¡œ ê°€ê¸°</button><a href="/programs" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">í”„ë¡œê·¸ë¨ ëª©ë¡</a></div></div></nav><main class="max-w-5xl mx-auto px-6 py-16"><div class="text-center mb-12"><div class="text-6xl mb-4">ğŸ‘¥</div><h1 class="text-4xl font-bold text-gray-900 mb-4">ì»¤ë®¤ë‹ˆí‹° ë§ˆì¼€íŒ…</h1><p class="text-xl text-gray-600">í•™ë¶€ëª¨ ì»¤ë®¤ë‹ˆí‹° í™œì„±í™” ì „ëµ</p></div><div class="bg-white rounded-2xl p-8 shadow-sm mb-8"><h2 class="text-2xl font-bold mb-6">ğŸ¯ í”„ë¡œê·¸ë¨ ì§„í–‰ì¤‘</h2><p class="text-gray-600 text-center py-8">ì´ í”„ë¡œê·¸ë¨ì€ í˜„ì¬ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>ìì„¸í•œ ë‚´ìš©ì€ êµìœ¡ ì‹ ì²­ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div><div class="bg-gradient-to-r from-purple-600 to-purple-700 rounded-2xl p-12 text-center text-white"><h2 class="text-3xl font-bold mb-4">í”„ë¡œê·¸ë¨ ì‹œì‘í•˜ê¸°</h2><p class="text-xl mb-8">ì»¤ë®¤ë‹ˆí‹° ë§ˆì¼€íŒ…ìœ¼ë¡œ í•™ì›ì„ ì„±ì¥ì‹œí‚¤ì„¸ìš”</p><a href="/contact" class="inline-block px-8 py-4 bg-white text-purple-600 rounded-lg font-semibold hover:shadow-lg">êµìœ¡ ì‹ ì²­í•˜ê¸° â†’</a></div></main></body></html>`))

// ë¸Œëœë”©
app.get('/programs/branding', (c) => c.html(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ë¸Œëœë”© - ìŠˆí¼í”Œë ˆì´ìŠ¤</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"></head><body class="bg-gray-50"><nav class="bg-white shadow-sm border-b sticky top-0 z-50"><div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center"><a href="/" class="text-2xl font-bold text-pink-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a><div class="flex gap-4"><button onclick="history.back()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"><i class="fas fa-arrow-left mr-2"></i>ë’¤ë¡œ ê°€ê¸°</button><a href="/programs" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700">í”„ë¡œê·¸ë¨ ëª©ë¡</a></div></div></nav><main class="max-w-5xl mx-auto px-6 py-16"><div class="text-center mb-12"><div class="text-6xl mb-4">ğŸ¨</div><h1 class="text-4xl font-bold text-gray-900 mb-4">ë¸Œëœë”©</h1><p class="text-xl text-gray-600">í•™ì› ë¸Œëœë“œ ì•„ì´ë´í‹°í‹° êµ¬ì¶•</p></div><div class="bg-white rounded-2xl p-8 shadow-sm mb-8"><h2 class="text-2xl font-bold mb-6">ğŸ¯ í”„ë¡œê·¸ë¨ ì§„í–‰ì¤‘</h2><p class="text-gray-600 text-center py-8">ì´ í”„ë¡œê·¸ë¨ì€ í˜„ì¬ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>ìì„¸í•œ ë‚´ìš©ì€ êµìœ¡ ì‹ ì²­ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div><div class="bg-gradient-to-r from-pink-600 to-pink-700 rounded-2xl p-12 text-center text-white"><h2 class="text-3xl font-bold mb-4">í”„ë¡œê·¸ë¨ ì‹œì‘í•˜ê¸°</h2><p class="text-xl mb-8">ë¸Œëœë”©ìœ¼ë¡œ í•™ì›ì„ ì„±ì¥ì‹œí‚¤ì„¸ìš”</p><a href="/contact" class="inline-block px-8 py-4 bg-white text-pink-600 rounded-lg font-semibold hover:shadow-lg">êµìœ¡ ì‹ ì²­í•˜ê¸° â†’</a></div></main></body></html>`))

// ë°ì´í„° ë¶„ì„
// ê²€ìƒ‰ëŸ‰ ì¡°íšŒ í”„ë¡œê·¸ë¨ ë¦¬ë‹¤ì´ë ‰íŠ¸
app.get('/programs/data', (c) => {
  return c.redirect('/tools/search-volume')
})

// ë‹¹ê·¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë§ˆì¼€íŒ…
app.get('/programs/carrot', (c) => c.html(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ë‹¹ê·¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë§ˆì¼€íŒ… - ìŠˆí¼í”Œë ˆì´ìŠ¤</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"></head><body class="bg-gray-50"><nav class="bg-white shadow-sm border-b sticky top-0 z-50"><div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center"><a href="/" class="text-2xl font-bold text-orange-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a><div class="flex gap-4"><button onclick="history.back()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"><i class="fas fa-arrow-left mr-2"></i>ë’¤ë¡œ ê°€ê¸°</button><a href="/programs" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">í”„ë¡œê·¸ë¨ ëª©ë¡</a></div></div></nav><main class="max-w-5xl mx-auto px-6 py-16"><div class="text-center mb-12"><div class="text-6xl mb-4">ğŸ¥•</div><h1 class="text-4xl font-bold text-gray-900 mb-4">ë‹¹ê·¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë§ˆì¼€íŒ…</h1><p class="text-xl text-gray-600">ì§€ì—­ ê¸°ë°˜ ë‹¹ê·¼ë§ˆì¼“ í™œìš© ì „ëµ</p></div><div class="bg-white rounded-2xl p-8 shadow-sm mb-8"><h2 class="text-2xl font-bold mb-6">ğŸ¯ í”„ë¡œê·¸ë¨ ì§„í–‰ì¤‘</h2><p class="text-gray-600 text-center py-8">ì´ í”„ë¡œê·¸ë¨ì€ í˜„ì¬ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>ìì„¸í•œ ë‚´ìš©ì€ êµìœ¡ ì‹ ì²­ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div><div class="bg-gradient-to-r from-orange-600 to-orange-700 rounded-2xl p-12 text-center text-white"><h2 class="text-3xl font-bold mb-4">í”„ë¡œê·¸ë¨ ì‹œì‘í•˜ê¸°</h2><p class="text-xl mb-8">ë‹¹ê·¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë§ˆì¼€íŒ…ìœ¼ë¡œ í•™ì›ì„ ì„±ì¥ì‹œí‚¤ì„¸ìš”</p><a href="/contact" class="inline-block px-8 py-4 bg-white text-orange-600 rounded-lg font-semibold hover:shadow-lg">êµìœ¡ ì‹ ì²­í•˜ê¸° â†’</a></div></main></body></html>`))

// ë©”íƒ€ ê´‘ê³ 
app.get('/programs/meta', (c) => c.html(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ë©”íƒ€ ê´‘ê³  - ìŠˆí¼í”Œë ˆì´ìŠ¤</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"></head><body class="bg-gray-50"><nav class="bg-white shadow-sm border-b sticky top-0 z-50"><div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center"><a href="/" class="text-2xl font-bold text-blue-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a><div class="flex gap-4"><button onclick="history.back()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"><i class="fas fa-arrow-left mr-2"></i>ë’¤ë¡œ ê°€ê¸°</button><a href="/programs" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">í”„ë¡œê·¸ë¨ ëª©ë¡</a></div></div></nav><main class="max-w-5xl mx-auto px-6 py-16"><div class="text-center mb-12"><div class="text-6xl mb-4">ğŸ“˜</div><h1 class="text-4xl font-bold text-gray-900 mb-4">ë©”íƒ€ ê´‘ê³ </h1><p class="text-xl text-gray-600">Facebook/Instagram ê´‘ê³  ìš´ì˜</p></div><div class="bg-white rounded-2xl p-8 shadow-sm mb-8"><h2 class="text-2xl font-bold mb-6">ğŸ¯ í”„ë¡œê·¸ë¨ ì§„í–‰ì¤‘</h2><p class="text-gray-600 text-center py-8">ì´ í”„ë¡œê·¸ë¨ì€ í˜„ì¬ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>ìì„¸í•œ ë‚´ìš©ì€ êµìœ¡ ì‹ ì²­ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div><div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-2xl p-12 text-center text-white"><h2 class="text-3xl font-bold mb-4">í”„ë¡œê·¸ë¨ ì‹œì‘í•˜ê¸°</h2><p class="text-xl mb-8">ë©”íƒ€ ê´‘ê³ ìœ¼ë¡œ í•™ì›ì„ ì„±ì¥ì‹œí‚¤ì„¸ìš”</p><a href="/contact" class="inline-block px-8 py-4 bg-white text-blue-600 rounded-lg font-semibold hover:shadow-lg">êµìœ¡ ì‹ ì²­í•˜ê¸° â†’</a></div></main></body></html>`))

// ìœ íŠœë¸Œ ê´‘ê³ 
app.get('/programs/youtube-ad', (c) => c.html(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ìœ íŠœë¸Œ ê´‘ê³  - ìŠˆí¼í”Œë ˆì´ìŠ¤</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"></head><body class="bg-gray-50"><nav class="bg-white shadow-sm border-b sticky top-0 z-50"><div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center"><a href="/" class="text-2xl font-bold text-red-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a><div class="flex gap-4"><button onclick="history.back()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"><i class="fas fa-arrow-left mr-2"></i>ë’¤ë¡œ ê°€ê¸°</button><a href="/programs" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">í”„ë¡œê·¸ë¨ ëª©ë¡</a></div></div></nav><main class="max-w-5xl mx-auto px-6 py-16"><div class="text-center mb-12"><div class="text-6xl mb-4">ğŸ“º</div><h1 class="text-4xl font-bold text-gray-900 mb-4">ìœ íŠœë¸Œ ê´‘ê³ </h1><p class="text-xl text-gray-600">ìœ íŠœë¸Œ ê´‘ê³  ìº í˜ì¸ ìš´ì˜</p></div><div class="bg-white rounded-2xl p-8 shadow-sm mb-8"><h2 class="text-2xl font-bold mb-6">ğŸ¯ í”„ë¡œê·¸ë¨ ì§„í–‰ì¤‘</h2><p class="text-gray-600 text-center py-8">ì´ í”„ë¡œê·¸ë¨ì€ í˜„ì¬ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>ìì„¸í•œ ë‚´ìš©ì€ êµìœ¡ ì‹ ì²­ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div><div class="bg-gradient-to-r from-red-600 to-red-700 rounded-2xl p-12 text-center text-white"><h2 class="text-3xl font-bold mb-4">í”„ë¡œê·¸ë¨ ì‹œì‘í•˜ê¸°</h2><p class="text-xl mb-8">ìœ íŠœë¸Œ ê´‘ê³ ìœ¼ë¡œ í•™ì›ì„ ì„±ì¥ì‹œí‚¤ì„¸ìš”</p><a href="/contact" class="inline-block px-8 py-4 bg-white text-red-600 rounded-lg font-semibold hover:shadow-lg">êµìœ¡ ì‹ ì²­í•˜ê¸° â†’</a></div></main></body></html>`))

// ì“°ë ˆë“œ ë§ˆì¼€íŒ…
app.get('/programs/threads', (c) => c.html(`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ì“°ë ˆë“œ ë§ˆì¼€íŒ… - ìŠˆí¼í”Œë ˆì´ìŠ¤</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"></head><body class="bg-gray-50"><nav class="bg-white shadow-sm border-b sticky top-0 z-50"><div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center"><a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a><div class="flex gap-4"><button onclick="history.back()" class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200"><i class="fas fa-arrow-left mr-2"></i>ë’¤ë¡œ ê°€ê¸°</button><a href="/programs" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">í”„ë¡œê·¸ë¨ ëª©ë¡</a></div></div></nav><main class="max-w-5xl mx-auto px-6 py-16"><div class="text-center mb-12"><div class="text-6xl mb-4">ğŸ§µ</div><h1 class="text-4xl font-bold text-gray-900 mb-4">ì“°ë ˆë“œ ë§ˆì¼€íŒ…</h1><p class="text-xl text-gray-600">Meta Threads í™œìš© ì „ëµ</p></div><div class="bg-white rounded-2xl p-8 shadow-sm mb-8"><h2 class="text-2xl font-bold mb-6">ğŸ¯ í”„ë¡œê·¸ë¨ ì§„í–‰ì¤‘</h2><p class="text-gray-600 text-center py-8">ì´ í”„ë¡œê·¸ë¨ì€ í˜„ì¬ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>ìì„¸í•œ ë‚´ìš©ì€ êµìœ¡ ì‹ ì²­ í›„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div><div class="bg-gradient-to-r from-purple-600 to-purple-700 rounded-2xl p-12 text-center text-white"><h2 class="text-3xl font-bold mb-4">í”„ë¡œê·¸ë¨ ì‹œì‘í•˜ê¸°</h2><p class="text-xl mb-8">ì“°ë ˆë“œ ë§ˆì¼€íŒ…ìœ¼ë¡œ í•™ì›ì„ ì„±ì¥ì‹œí‚¤ì„¸ìš”</p><a href="/contact" class="inline-block px-8 py-4 bg-white text-purple-600 rounded-lg font-semibold hover:shadow-lg">êµìœ¡ ì‹ ì²­í•˜ê¸° â†’</a></div></main></body></html>`))

// ëŒ€í–‰ ë¬¸ì˜ í˜ì´ì§€
app.get('/contact', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ëŒ€í–‰ ë¬¸ì˜ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <meta name="description" content="í•™ì› ë§ˆì¼€íŒ… ëŒ€í–‰ ë° êµìœ¡ ë¬¸ì˜">
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm fixed w-full top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold gradient-purple bg-clip-text text-transparent">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <div class="hidden md:flex space-x-8">
                        <a href="/" class="text-gray-600 hover:text-purple-600">í™ˆ</a>
                        <a href="/about" class="text-gray-600 hover:text-purple-600">íšŒì‚¬ ì†Œê°œ</a>
                        <a href="/contact" class="text-purple-600 font-bold">ëŒ€í–‰ ë¬¸ì˜</a>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-20">
            <!-- Hero Section -->
            <section class="bg-gradient-to-br from-purple-50 to-white py-20 px-6">
                <div class="max-w-4xl mx-auto text-center">
                    <h1 class="text-4xl lg:text-5xl font-bold text-gray-900 mb-6">
                        ëŒ€í–‰ ë¬¸ì˜
                    </h1>
                    <p class="text-xl text-gray-600 mb-8">
                        í•™ì› ë§ˆì¼€íŒ… êµìœ¡ ë° ëŒ€í–‰ ì„œë¹„ìŠ¤ ë¬¸ì˜<br>
                        24ì‹œê°„ ë‚´ì— ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤
                    </p>
                </div>
            </section>

            <!-- ë¬¸ì˜ ì–‘ì‹ -->
            <section class="py-20 px-6">
                <div class="max-w-3xl mx-auto">
                    <!-- ì¹´ì¹´ì˜¤ì±„ë„ ë¬¸ì˜ ë²„íŠ¼ -->
                    <div class="mb-8">
                        <a href="https://pf.kakao.com/_tnZzn/chat" target="_blank" rel="noopener noreferrer"
                            class="block bg-gradient-to-r from-yellow-400 to-yellow-500 text-gray-900 rounded-2xl shadow-lg p-6 hover:shadow-xl transition-all transform hover:-translate-y-1">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-16 h-16 bg-yellow-300 rounded-2xl flex items-center justify-center">
                                        <svg class="w-10 h-10" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12 3C6.5 3 2 6.58 2 11c0 2.95 2.03 5.53 5 6.74V22l4.5-3.5c.67.09 1.36.14 2.5.14 5.5 0 10-3.58 10-8s-4.5-8-10-8z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold mb-1">ğŸ’¬ ì¹´ì¹´ì˜¤ì±„ë„ë¡œ ë¹ ë¥¸ ë¬¸ì˜</h3>
                                        <p class="text-sm text-gray-700">ì‹¤ì‹œê°„ ìƒë‹´ ê°€ëŠ¥ (í‰ì¼ 9:00-18:00)</p>
                                    </div>
                                </div>
                                <div class="text-2xl">â†’</div>
                            </div>
                        </a>
                    </div>

                    <div class="text-center mb-8">
                        <span class="inline-block px-4 py-2 bg-gray-100 rounded-full text-sm text-gray-600">
                            ë˜ëŠ” ì•„ë˜ ì–‘ì‹ìœ¼ë¡œ ë¬¸ì˜í•˜ì„¸ìš”
                        </span>
                    </div>

                    <div class="bg-white rounded-3xl shadow-lg p-8 md:p-12">
                        <form id="contactForm" class="space-y-6">
                            <!-- ë¬¸ì˜ ìœ í˜• -->
                            <div>
                                <label class="block text-gray-700 font-bold mb-3">ë¬¸ì˜ ìœ í˜• *</label>
                                <div class="grid md:grid-cols-2 gap-4">
                                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-purple-600">
                                        <input type="radio" name="type" value="êµìœ¡" required class="mr-3">
                                        <span>êµìœ¡ í”„ë¡œê·¸ë¨ ë¬¸ì˜</span>
                                    </label>
                                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-purple-600">
                                        <input type="radio" name="type" value="ëŒ€í–‰" required class="mr-3">
                                        <span>ë§ˆì¼€íŒ… ëŒ€í–‰ ë¬¸ì˜</span>
                                    </label>
                                </div>
                            </div>

                            <!-- í•™ì›ëª… -->
                            <div>
                                <label class="block text-gray-700 font-bold mb-3">í•™ì›ëª… *</label>
                                <input type="text" name="academy" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-600 focus:outline-none"
                                    placeholder="ì˜ˆ: ê¾¸ë©”ë•…í•™ì›">
                            </div>

                            <!-- ì›ì¥ë‹˜ ì„±í•¨ -->
                            <div>
                                <label class="block text-gray-700 font-bold mb-3">ì›ì¥ë‹˜ ì„±í•¨ *</label>
                                <input type="text" name="name" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-600 focus:outline-none"
                                    placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
                            </div>

                            <!-- ì—°ë½ì²˜ -->
                            <div>
                                <label class="block text-gray-700 font-bold mb-3">ì—°ë½ì²˜ *</label>
                                <input type="tel" name="phone" required 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-600 focus:outline-none"
                                    placeholder="010-0000-0000">
                            </div>

                            <!-- ì´ë©”ì¼ -->
                            <div>
                                <label class="block text-gray-700 font-bold mb-3">ì´ë©”ì¼</label>
                                <input type="email" name="email" 
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-600 focus:outline-none"
                                    placeholder="academy@example.com">
                            </div>

                            <!-- ê´€ì‹¬ í”„ë¡œê·¸ë¨ -->
                            <div>
                                <label class="block text-gray-700 font-bold mb-3">ê´€ì‹¬ í”„ë¡œê·¸ë¨</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" name="program" value="ë„¤ì´ë²„í”Œë ˆì´ìŠ¤" class="mr-2">
                                        <span>ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œ</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="program" value="ë¸”ë¡œê·¸" class="mr-2">
                                        <span>ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œ</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="program" value="í¼ë„" class="mr-2">
                                        <span>í¼ë„ ë§ˆì¼€íŒ…</span>
                                    </label>
                                </div>
                            </div>

                            <!-- ë¬¸ì˜ ë‚´ìš© -->
                            <div>
                                <label class="block text-gray-700 font-bold mb-3">ë¬¸ì˜ ë‚´ìš© *</label>
                                <textarea name="message" required rows="6"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-600 focus:outline-none"
                                    placeholder="ê¶ê¸ˆí•˜ì‹  ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”"></textarea>
                            </div>

                            <!-- ì œì¶œ ë²„íŠ¼ -->
                            <button type="submit" 
                                class="w-full py-4 gradient-purple text-white rounded-xl font-bold text-lg hover:shadow-lg transition-all">
                                ë¬¸ì˜í•˜ê¸°
                            </button>

                            <p class="text-center text-sm text-gray-500">
                                * í‘œì‹œëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤
                            </p>
                        </form>

                        <!-- ì„±ê³µ ë©”ì‹œì§€ (ìˆ¨ê¹€) -->
                        <div id="successMessage" class="hidden text-center py-12">
                            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-check text-3xl text-green-600"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-4">ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
                            <p class="text-gray-600 mb-8">
                                ë¹ ë¥¸ ì‹œê°„ ë‚´ì— ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.<br>
                                ê°ì‚¬í•©ë‹ˆë‹¤.
                            </p>
                            <a href="/" class="inline-block px-8 py-3 gradient-purple text-white rounded-full font-bold hover:shadow-lg transition-all">
                                í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ì—°ë½ì²˜ ì •ë³´ -->
            <section class="py-20 px-6 bg-white">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-900 mb-12 text-center">ì—°ë½ì²˜</h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-phone text-purple-600 text-2xl"></i>
                            </div>
                            <h3 class="font-bold text-gray-900 mb-2">ì „í™” ë¬¸ì˜</h3>
                            <p class="text-gray-600">010-8739-9697</p>
                        </div>
                        <div class="text-center">
                            <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-envelope text-purple-600 text-2xl"></i>
                            </div>
                            <h3 class="font-bold text-gray-900 mb-2">ì´ë©”ì¼</h3>
                            <p class="text-gray-600">wangholy1@naver.com</p>
                        </div>
                        <div class="text-center">
                            <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-map-marker-alt text-purple-600 text-2xl"></i>
                            </div>
                            <h3 class="font-bold text-gray-900 mb-2">ìœ„ì¹˜</h3>
                            <p class="text-gray-600">ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬ ì²­ë¼ì»¤ë‚¼ë¡œ 270, 2ì¸µ</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <script>
            document.getElementById('contactForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const data = {
                    type: formData.get('type'),
                    academy: formData.get('academy'),
                    name: formData.get('name'),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    programs: formData.getAll('program'),
                    message: formData.get('message')
                };

                try {
                    const response = await fetch('/api/contact', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        document.getElementById('contactForm').classList.add('hidden');
                        document.getElementById('successMessage').classList.remove('hidden');
                    } else {
                        alert('ë¬¸ì˜ ì ‘ìˆ˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                } catch (err) {
                    alert('ë¬¸ì˜ ì ‘ìˆ˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            });
        </script>
    </body>
    </html>
  `)
})

// ============================================
// ë§ˆì¼€íŒ… íˆ´ 10ê°œ
// ============================================

// 1. ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í‚¤ì›Œë“œ ë¶„ì„ê¸°
app.get('/tools/keyword-analyzer', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í‚¤ì›Œë“œ ë¶„ì„ê¸° - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <div class="text-center mb-12">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">ğŸ” ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í‚¤ì›Œë“œ ë¶„ì„ê¸°</h1>
                <p class="text-xl text-gray-600">í•™ì› ì£¼ë³€ ê²½ìŸ í‚¤ì›Œë“œë¥¼ ë¶„ì„í•˜ê³  ìµœì ì˜ í‚¤ì›Œë“œë¥¼ ì°¾ì•„ë³´ì„¸ìš”</p>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                <form id="keywordForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">ì§€ì—­ ì…ë ¥</label>
                        <input type="text" id="location" placeholder="ì˜ˆ: ì¸ì²œ ì„œêµ¬ ê²€ë‹¨ë™" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì› ì¢…ë¥˜</label>
                        <input type="text" id="type" placeholder="ì˜ˆ: ì˜ì–´í•™ì›, ìˆ˜í•™í•™ì›" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <button type="submit" class="w-full gradient-purple text-white py-4 rounded-xl font-bold hover:shadow-xl transition">
                        í‚¤ì›Œë“œ ë¶„ì„í•˜ê¸°
                    </button>
                </form>
            </div>

            <div id="results" class="hidden bg-white rounded-2xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ë¶„ì„ ê²°ê³¼</h2>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="p-4 bg-purple-50 rounded-xl">
                        <h3 class="font-bold text-purple-900 mb-2">ì¶”ì²œ í‚¤ì›Œë“œ</h3>
                        <ul id="recommendedKeywords" class="space-y-2 text-sm"></ul>
                    </div>
                    <div class="p-4 bg-orange-50 rounded-xl">
                        <h3 class="font-bold text-orange-900 mb-2">ê²½ìŸ ë¶„ì„</h3>
                        <ul id="competition" class="space-y-2 text-sm"></ul>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.getElementById('keywordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const location = document.getElementById('location').value;
                const type = document.getElementById('type').value;
                
                const results = document.getElementById('results');
                results.classList.remove('hidden');
                
                const recommended = [
                    location + ' ' + type,
                    location + ' ' + type + ' ì¶”ì²œ',
                    location + ' ' + type + ' ì˜í•˜ëŠ”ê³³',
                    type + ' ' + location + ' í‰ì ë†’ì€',
                    'ì´ˆë“± ' + type + ' ' + location
                ];
                
                const recommendedEl = document.getElementById('recommendedKeywords');
                recommendedEl.innerHTML = recommended.map(k => 
                    '<li class="flex items-center"><i class="fas fa-check-circle text-purple-600 mr-2"></i>' + k + '</li>'
                ).join('');
                
                const competitionEl = document.getElementById('competition');
                competitionEl.innerHTML = \`
                    <li>ê²½ìŸ í•™ì› ìˆ˜: <span class="font-bold">12ê°œ</span></li>
                    <li>í‰ê·  ë¦¬ë·° ìˆ˜: <span class="font-bold">23ê°œ</span></li>
                    <li>í‰ê·  í‰ì : <span class="font-bold">4.5ì </span></li>
                    <li>ê²½ìŸ ê°•ë„: <span class="font-bold text-orange-600">ì¤‘ê°„</span></li>
                \`;
            });
        </script>
    </body>
    </html>
  `)
})

// 2. ë¦¬ë·° ì‘ë‹µ í…œí”Œë¦¿ ìƒì„±ê¸°
app.get('/tools/review-template', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¦¬ë·° ì‘ë‹µ í…œí”Œë¦¿ ìƒì„±ê¸° - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>.gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }</style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4 text-center">ğŸ’¬ ë¦¬ë·° ì‘ë‹µ í…œí”Œë¦¿ ìƒì„±ê¸°</h1>
            <p class="text-xl text-gray-600 text-center mb-12">ê³ ê° ë¦¬ë·°ì— ë§ì¶¤í˜• ë‹µë³€ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤</p>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">ë¦¬ë·° ìœ í˜• ì„ íƒ</label>
                        <select id="reviewType" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                            <option value="positive">ê¸ì • ë¦¬ë·°</option>
                            <option value="negative">ë¶€ì • ë¦¬ë·°</option>
                            <option value="neutral">ì¤‘ë¦½ ë¦¬ë·°</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">ë¦¬ë·° ë‚´ìš©</label>
                        <textarea id="reviewContent" rows="4" placeholder="ê³ ê°ì´ ë‚¨ê¸´ ë¦¬ë·° ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none"></textarea>
                    </div>
                    <button onclick="generateTemplate()" class="w-full gradient-purple text-white py-4 rounded-xl font-bold hover:shadow-xl transition">
                        ì‘ë‹µ í…œí”Œë¦¿ ìƒì„±
                    </button>
                </div>
            </div>

            <div id="templateResult" class="hidden bg-white rounded-2xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">ìƒì„±ëœ ì‘ë‹µ</h2>
                <div class="p-6 bg-gray-50 rounded-xl mb-4">
                    <p id="generatedResponse" class="text-gray-800 whitespace-pre-wrap"></p>
                </div>
                <button onclick="copyResponse()" class="gradient-purple text-white px-6 py-3 rounded-xl font-medium hover:shadow-lg transition">
                    ğŸ“‹ ë³µì‚¬í•˜ê¸°
                </button>
            </div>
        </div>

        <script>
            function generateTemplate() {
                const type = document.getElementById('reviewType').value;
                const content = document.getElementById('reviewContent').value;
                
                let response = '';
                if(type === 'positive') {
                    response = content + '\\n\\nì†Œì¤‘í•œ ë¦¬ë·° ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ˜Š\\nì•ìœ¼ë¡œë„ ë” ë‚˜ì€ êµìœ¡ìœ¼ë¡œ ë³´ë‹µí•˜ê² ìŠµë‹ˆë‹¤.\\ní•­ìƒ ì‘ì›í•´ì£¼ì„¸ìš”!\\n\\n- ê¾¸ë©”ë•…í•™ì› ì›ì¥ ë“œë¦¼';
                } else if(type === 'negative') {
                    response = 'ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.\\në§ì”€í•´ì£¼ì‹  ë¶€ë¶„ì— ëŒ€í•´ ê¹Šì´ ë°˜ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.\\nì¦‰ì‹œ ê°œì„ í•˜ì—¬ ë” ë‚˜ì€ ì„œë¹„ìŠ¤ë¡œ ë³´ë‹µí•˜ê² ìŠµë‹ˆë‹¤.\\në‹¤ì‹œ í•œ ë²ˆ ì£„ì†¡í•©ë‹ˆë‹¤.\\n\\n- ê¾¸ë©”ë•…í•™ì› ì›ì¥ ë“œë¦¼';
                } else {
                    response = 'ë¦¬ë·° ë‚¨ê²¨ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.\\në” ì¢‹ì€ êµìœ¡ í™˜ê²½ì„ ë§Œë“¤ê¸° ìœ„í•´ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤.\\nê°ì‚¬í•©ë‹ˆë‹¤.\\n\\n- ê¾¸ë©”ë•…í•™ì› ì›ì¥ ë“œë¦¼';
                }
                
                document.getElementById('generatedResponse').textContent = response;
                document.getElementById('templateResult').classList.remove('hidden');
            }
            
            function copyResponse() {
                const text = document.getElementById('generatedResponse').textContent;
                navigator.clipboard.writeText(text);
                alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        </script>
    </body>
    </html>
  `)
})

// 3. í•™ì› í™ë³´ ë¬¸êµ¬ ìƒì„±ê¸°
app.get('/tools/ad-copy-generator', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í•™ì› í™ë³´ ë¬¸êµ¬ ìƒì„±ê¸° - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>.gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }</style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4 text-center">âœ¨ í•™ì› í™ë³´ ë¬¸êµ¬ ìƒì„±ê¸°</h1>
            <p class="text-xl text-gray-600 text-center mb-12">íš¨ê³¼ì ì¸ í•™ì› ê´‘ê³  ë¬¸êµ¬ë¥¼ ìë™ìœ¼ë¡œ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤</p>

            <div class="bg-white rounded-2xl shadow-lg p-8">
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì›ëª…</label>
                        <input type="text" id="academyName" placeholder="ì˜ˆ: ê¾¸ë©”ë•…í•™ì›" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">ê³¼ëª©</label>
                        <input type="text" id="subject" placeholder="ì˜ˆ: ì˜ì–´, ìˆ˜í•™" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">ê°•ì </label>
                        <input type="text" id="strength" placeholder="ì˜ˆ: ì†Œìˆ˜ì •ì˜ˆ, 1:1 ë§ì¶¤" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <button onclick="generateAdCopy()" class="w-full gradient-purple text-white py-4 rounded-xl font-bold hover:shadow-xl transition">
                        í™ë³´ ë¬¸êµ¬ ìƒì„±
                    </button>
                </div>

                <div id="copyResults" class="hidden mt-8 space-y-4">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">ìƒì„±ëœ í™ë³´ ë¬¸êµ¬ (5ê°œ)</h2>
                    <div id="copyList"></div>
                </div>
            </div>
        </div>

        <script>
            function generateAdCopy() {
                const name = document.getElementById('academyName').value;
                const subject = document.getElementById('subject').value;
                const strength = document.getElementById('strength').value;
                
                const copies = [
                    name + 'ì—ì„œ ' + subject + ' ì‹¤ë ¥ì„ ì™„ì„±í•˜ì„¸ìš”! ' + strength + ' ìˆ˜ì—…ìœ¼ë¡œ ì„±ì  UP! ğŸ“ˆ',
                    subject + ' ê³ ë¯¼ë˜ì‹œì£ ? ' + name + 'ì˜ ' + strength + ' ì‹œìŠ¤í…œì´ ë‹µì…ë‹ˆë‹¤! ğŸ¯',
                    'ìš°ë¦¬ ì•„ì´ ' + subject + ' ì„±ì , ' + name + 'ì—ì„œ ì±…ì„ì§‘ë‹ˆë‹¤! ' + strength + ' êµìœ¡ ğŸ’ª',
                    name + ' | ' + subject + ' ì „ë¬¸ | ' + strength + ' | ì§€ê¸ˆ ìƒë‹´ ì‹ ì²­í•˜ì„¸ìš”! â˜ï¸',
                    strength + 'ë¡œ ì°¨ë³„í™”ëœ ' + subject + ' êµìœ¡, ' + name + 'ì…ë‹ˆë‹¤! âœ¨'
                ];
                
                const listEl = document.getElementById('copyList');
                listEl.innerHTML = copies.map((copy, i) => \`
                    <div class="p-4 bg-purple-50 rounded-xl">
                        <div class="flex justify-between items-start">
                            <p class="text-gray-800 flex-1">\${i+1}. \${copy}</p>
                            <button onclick="copySingle('\${copy}')" class="ml-4 text-purple-600 hover:text-purple-700">
                                ğŸ“‹
                            </button>
                        </div>
                    </div>
                \`).join('');
                
                document.getElementById('copyResults').classList.remove('hidden');
            }
            
            function copySingle(text) {
                navigator.clipboard.writeText(text);
                alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        </script>
    </body>
    </html>
  `)
})

// 4. ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ì‚¬ì§„ ìµœì í™” ê°€ì´ë“œ
app.get('/tools/photo-optimizer', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í”Œë ˆì´ìŠ¤ ì‚¬ì§„ ìµœì í™” ê°€ì´ë“œ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>.gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }</style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4 text-center">ğŸ“¸ í”Œë ˆì´ìŠ¤ ì‚¬ì§„ ìµœì í™” ê°€ì´ë“œ</h1>
            <p class="text-xl text-gray-600 text-center mb-12">í´ë¦­ë¥ ì„ ë†’ì´ëŠ” ì‚¬ì§„ ì´¬ì˜ ê°€ì´ë“œ</p>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-green-600 mb-6">âœ… ì¢‹ì€ ì‚¬ì§„</h2>
                    <ul class="space-y-4">
                        <li class="flex items-start">
                            <span class="text-2xl mr-3">ğŸ“</span>
                            <div>
                                <div class="font-bold text-gray-900">ì •ë°©í˜• (1:1) ë¹„ìœ¨</div>
                                <div class="text-sm text-gray-600">í”Œë ˆì´ìŠ¤ì—ì„œ ê°€ì¥ ì˜ ë³´ì´ëŠ” ë¹„ìœ¨</div>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <span class="text-2xl mr-3">â˜€ï¸</span>
                            <div>
                                <div class="font-bold text-gray-900">ë°ê³  ì„ ëª…í•œ ì¡°ëª…</div>
                                <div class="text-sm text-gray-600">ìì—°ê´‘ì´ë‚˜ ë°ì€ ì‹¤ë‚´</div>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <span class="text-2xl mr-3">ğŸ¯</span>
                            <div>
                                <div class="font-bold text-gray-900">í¬ì¸íŠ¸ê°€ ëª…í™•</div>
                                <div class="text-sm text-gray-600">êµì‹¤, í•™ìŠµìë£Œ, ìˆ˜ì—… ì¥ë©´</div>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <span class="text-2xl mr-3">ğŸ§¹</span>
                            <div>
                                <div class="font-bold text-gray-900">ê¹”ë”í•œ ì •ë¦¬ ìƒíƒœ</div>
                                <div class="text-sm text-gray-600">ë¶ˆí•„ìš”í•œ ë¬¼ê±´ ì œê±°</div>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-red-600 mb-6">âŒ í”¼í•´ì•¼ í•  ì‚¬ì§„</h2>
                    <ul class="space-y-4">
                        <li class="flex items-start">
                            <span class="text-2xl mr-3">ğŸŒ‘</span>
                            <div>
                                <div class="font-bold text-gray-900">ì–´ë‘¡ê³  íë¦¿í•¨</div>
                                <div class="text-sm text-gray-600">ë…¸ì¶œ ë¶€ì¡±, ì´ˆì  ë¶ˆëŸ‰</div>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <span class="text-2xl mr-3">ğŸ¤³</span>
                            <div>
                                <div class="font-bold text-gray-900">ì‚¬ëŒ ì–¼êµ´ ë…¸ì¶œ</div>
                                <div class="text-sm text-gray-600">ì´ˆìƒê¶Œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥</div>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <span class="text-2xl mr-3">ğŸ“±</span>
                            <div>
                                <div class="font-bold text-gray-900">ìŠ¤í¬ë¦°ìƒ·ì´ë‚˜ ìº¡ì²˜</div>
                                <div class="text-sm text-gray-600">ì§ì ‘ ì´¬ì˜í•œ ì‚¬ì§„ ì‚¬ìš©</div>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <span class="text-2xl mr-3">ğŸ—‘ï¸</span>
                            <div>
                                <div class="font-bold text-gray-900">ì–´ì§€ëŸ¬ìš´ ë°°ê²½</div>
                                <div class="text-sm text-gray-600">ì£¼ëª©ë„ ë–¨ì–´ì§</div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="mt-8 bg-gradient-to-br from-purple-50 to-white rounded-2xl p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“‹ ì¶”ì²œ ì‚¬ì§„ êµ¬ì„± (ì´ 10ì¥)</h2>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="p-4 bg-white rounded-xl border border-purple-200">
                        <div class="font-bold text-purple-600 mb-2">1. ì™¸ë¶€ ì „ê²½ (2ì¥)</div>
                        <div class="text-sm text-gray-600">ê±´ë¬¼ ì™¸ê´€, ê°„íŒ</div>
                    </div>
                    <div class="p-4 bg-white rounded-xl border border-purple-200">
                        <div class="font-bold text-purple-600 mb-2">2. êµì‹¤ ë‚´ë¶€ (3ì¥)</div>
                        <div class="text-sm text-gray-600">ì±…ìƒ ë°°ì¹˜, ì¹ íŒ, í•™ìŠµ í™˜ê²½</div>
                    </div>
                    <div class="p-4 bg-white rounded-xl border border-purple-200">
                        <div class="font-bold text-purple-600 mb-2">3. ìˆ˜ì—… ìë£Œ (2ì¥)</div>
                        <div class="text-sm text-gray-600">êµì¬, í•™ìŠµ ë„êµ¬</div>
                    </div>
                    <div class="p-4 bg-white rounded-xl border border-purple-200">
                        <div class="font-bold text-purple-600 mb-2">4. ë¶€ëŒ€ì‹œì„¤ (2ì¥)</div>
                        <div class="text-sm text-gray-600">ìƒë‹´ì‹¤, ëŒ€ê¸°ì‹¤, í™”ì¥ì‹¤</div>
                    </div>
                    <div class="p-4 bg-white rounded-xl border border-purple-200">
                        <div class="font-bold text-purple-600 mb-2">5. ì´ë²¤íŠ¸/ì„±ê³¼ (1ì¥)</div>
                        <div class="text-sm text-gray-600">ìˆ˜ìƒ ë‚´ì—­, íŠ¹ë³„ í”„ë¡œê·¸ë¨</div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
  `)
})

// 5. ê²½ìŸ í•™ì› ë¶„ì„ ë„êµ¬
app.get('/tools/competitor-analysis', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê²½ìŸ í•™ì› ë¶„ì„ ë„êµ¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>.gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }</style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4 text-center">ğŸ” ê²½ìŸ í•™ì› ë¶„ì„ ë„êµ¬</h1>
            <p class="text-xl text-gray-600 text-center mb-12">ì£¼ë³€ ê²½ìŸ í•™ì›ì„ ë¶„ì„í•˜ê³  ì°¨ë³„í™” ì „ëµì„ ìˆ˜ë¦½í•˜ì„¸ìš”</p>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ë¶„ì„ ì²´í¬ë¦¬ìŠ¤íŠ¸</h2>
                <div class="space-y-6">
                    <div class="p-6 bg-purple-50 rounded-xl">
                        <h3 class="font-bold text-purple-900 mb-4">1. ê¸°ë³¸ ì •ë³´ ì¡°ì‚¬</h3>
                        <div class="space-y-2 text-sm">
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">í•™ì›ëª…ê³¼ ìœ„ì¹˜ í™•ì¸</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">ìš´ì˜ ì‹œê°„ ë° ìš”ì¼ í™•ì¸</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">ê³¼ëª© ë° í”„ë¡œê·¸ë¨ ì¢…ë¥˜</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">í•™ì› ê·œëª¨ (ê°•ì‚¬ ìˆ˜, êµì‹¤ ìˆ˜)</label>
                        </div>
                    </div>

                    <div class="p-6 bg-orange-50 rounded-xl">
                        <h3 class="font-bold text-orange-900 mb-4">2. ì˜¨ë¼ì¸ í‰íŒ ë¶„ì„</h3>
                        <div class="space-y-2 text-sm">
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í‰ì </label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">ë¦¬ë·° ê°œìˆ˜ ë° ìµœê·¼ ë¦¬ë·°</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">ë¦¬ë·° ì‘ë‹µë¥ </label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">ë¸”ë¡œê·¸ ìš´ì˜ í˜„í™©</label>
                        </div>
                    </div>

                    <div class="p-6 bg-green-50 rounded-xl">
                        <h3 class="font-bold text-green-900 mb-4">3. ë§ˆì¼€íŒ… ì „ëµ íŒŒì•…</h3>
                        <div class="space-y-2 text-sm">
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">í™ˆí˜ì´ì§€/SNS í™œë™</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">í”„ë¡œëª¨ì…˜ ë° ì´ë²¤íŠ¸</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">ìˆ˜ê°•ë£Œ ì •ì±…</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">ë¬´ë£Œ ì²´í—˜ ì œê³µ ì—¬ë¶€</label>
                        </div>
                    </div>

                    <div class="p-6 bg-blue-50 rounded-xl">
                        <h3 class="font-bold text-blue-900 mb-4">4. ì°¨ë³„í™” í¬ì¸íŠ¸ ì°¾ê¸°</h3>
                        <div class="space-y-2 text-sm">
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">ê²½ìŸì‚¬ì˜ ì•½ì  íŒŒì•…</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">ìš°ë¦¬ë§Œì˜ ê°•ì  ì •ë¦¬</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">í‹ˆìƒˆì‹œì¥ ë°œê²¬</label>
                            <label class="flex items-center"><input type="checkbox" class="mr-3 w-4 h-4">ì°¨ë³„í™” ë©”ì‹œì§€ ì‘ì„±</label>
                        </div>
                    </div>
                </div>

                <div class="mt-8 p-6 bg-gradient-to-br from-purple-100 to-orange-100 rounded-xl">
                    <h3 class="font-bold text-gray-900 mb-3">ğŸ’¡ ë¶„ì„ í›„ ì‹¤í–‰ TIP</h3>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li>âœ… ê²½ìŸì‚¬ë³´ë‹¤ ë¹ ë¥¸ ë¦¬ë·° ì‘ë‹µ</li>
                        <li>âœ… ì°¨ë³„í™”ëœ í”„ë¡œê·¸ë¨ í™ë³´</li>
                        <li>âœ… ì •ê¸°ì ì¸ ë¸”ë¡œê·¸/SNS ì—…ë°ì´íŠ¸</li>
                        <li>âœ… ê³ ê° ë§ì¶¤ ìƒë‹´ ì‹œìŠ¤í…œ êµ¬ì¶•</li>
                    </ul>
                </div>
            </div>
        </div>
    </body>
    </html>
  `)
})

// 6. ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ì²´í¬ë¦¬ìŠ¤íŠ¸
app.get('/tools/blog-checklist', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ì²´í¬ë¦¬ìŠ¤íŠ¸ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>.gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }</style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4 text-center">ğŸ“ ë¸”ë¡œê·¸ í¬ìŠ¤íŒ… ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>
            <p class="text-xl text-gray-600 text-center mb-12">SEO ìµœì í™”ëœ ë¸”ë¡œê·¸ ê¸€ ì‘ì„± ê°€ì´ë“œ</p>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-purple-600 mb-6">âœï¸ ì‘ì„± ì „ ì¤€ë¹„</h2>
                    <div class="space-y-3">
                        <label class="flex items-start p-3 hover:bg-purple-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">í‚¤ì›Œë“œ ì„ ì •</div>
                                <div class="text-sm text-gray-600">ê²€ìƒ‰ëŸ‰ ë§ì€ í‚¤ì›Œë“œ 3-5ê°œ</div>
                            </div>
                        </label>
                        <label class="flex items-start p-3 hover:bg-purple-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">ëª©ì°¨ êµ¬ì„±</div>
                                <div class="text-sm text-gray-600">ì„œë¡ -ë³¸ë¡ -ê²°ë¡  3ë‹¨ êµ¬ì„±</div>
                            </div>
                        </label>
                        <label class="flex items-start p-3 hover:bg-purple-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">ì´ë¯¸ì§€ ì¤€ë¹„</div>
                                <div class="text-sm text-gray-600">2-3ì¥ì˜ ê³ í’ˆì§ˆ ì´ë¯¸ì§€</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-orange-600 mb-6">âœ… ì‘ì„± ì¤‘ ì²´í¬</h2>
                    <div class="space-y-3">
                        <label class="flex items-start p-3 hover:bg-orange-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">ì œëª© ìµœì í™”</div>
                                <div class="text-sm text-gray-600">í‚¤ì›Œë“œ í¬í•¨, 25ì ì´ë‚´</div>
                            </div>
                        </label>
                        <label class="flex items-start p-3 hover:bg-orange-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">ì ì ˆí•œ ê¸¸ì´</div>
                                <div class="text-sm text-gray-600">1500-2000ì ì‘ì„±</div>
                            </div>
                        </label>
                        <label class="flex items-start p-3 hover:bg-orange-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">ì†Œì œëª© í™œìš©</div>
                                <div class="text-sm text-gray-600">3-4ê°œì˜ ì†Œì œëª©</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-green-600 mb-6">ğŸ¨ í¸ì§‘ ë° ë””ìì¸</h2>
                    <div class="space-y-3">
                        <label class="flex items-start p-3 hover:bg-green-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">ë‹¨ë½ êµ¬ë¶„</div>
                                <div class="text-sm text-gray-600">3-4ì¤„ë§ˆë‹¤ ë‹¨ë½ ë‚˜ëˆ„ê¸°</div>
                            </div>
                        </label>
                        <label class="flex items-start p-3 hover:bg-green-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">ê°•ì¡° í‘œì‹œ</div>
                                <div class="text-sm text-gray-600">ì¤‘ìš” ë‚´ìš© ë³¼ë“œ/ì»¬ëŸ¬</div>
                            </div>
                        </label>
                        <label class="flex items-start p-3 hover:bg-green-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">ì´ë¯¸ì§€ ALT</div>
                                <div class="text-sm text-gray-600">ì´ë¯¸ì§€ ì„¤ëª… í…ìŠ¤íŠ¸ ì¶”ê°€</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-blue-600 mb-6">ğŸš€ ë°œí–‰ í›„ ê´€ë¦¬</h2>
                    <div class="space-y-3">
                        <label class="flex items-start p-3 hover:bg-blue-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">SNS ê³µìœ </div>
                                <div class="text-sm text-gray-600">ì¹´ì¹´ì˜¤í†¡, ë°´ë“œ, ì¸ìŠ¤íƒ€</div>
                            </div>
                        </label>
                        <label class="flex items-start p-3 hover:bg-blue-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">ëŒ“ê¸€ í™•ì¸</div>
                                <div class="text-sm text-gray-600">24ì‹œê°„ ë‚´ ëŒ“ê¸€ ì‘ë‹µ</div>
                            </div>
                        </label>
                        <label class="flex items-start p-3 hover:bg-blue-50 rounded-lg cursor-pointer">
                            <input type="checkbox" class="mt-1 mr-3 w-5 h-5">
                            <div>
                                <div class="font-bold text-gray-900">ì¡°íšŒìˆ˜ ëª¨ë‹ˆí„°ë§</div>
                                <div class="text-sm text-gray-600">ì¼ì£¼ì¼ê°„ í†µê³„ í™•ì¸</div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-gradient-to-br from-purple-50 to-orange-50 rounded-2xl p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ¯ ê¸€ê° ì¶”ì²œ TOP 10</h2>
                <div class="grid md:grid-cols-2 gap-3">
                    <div class="p-3 bg-white rounded-lg">1. ìš°ë¦¬ í•™ì› ì†Œê°œ ë° íŠ¹ì§•</div>
                    <div class="p-3 bg-white rounded-lg">2. ìˆ˜ì—… ì»¤ë¦¬í˜ëŸ¼ ì•ˆë‚´</div>
                    <div class="p-3 bg-white rounded-lg">3. í•™ìƒ ì„±ê³µ ì‚¬ë¡€ (ì„±ì  í–¥ìƒ)</div>
                    <div class="p-3 bg-white rounded-lg">4. í•™ë¶€ëª¨ í›„ê¸° ë° ì¸í„°ë·°</div>
                    <div class="p-3 bg-white rounded-lg">5. íš¨ê³¼ì ì¸ í•™ìŠµë²• íŒ</div>
                    <div class="p-3 bg-white rounded-lg">6. êµì¬ ë° í•™ìŠµ ìë£Œ ì†Œê°œ</div>
                    <div class="p-3 bg-white rounded-lg">7. í•™ì› ì‹œì„¤ ë° í™˜ê²½ ì†Œê°œ</div>
                    <div class="p-3 bg-white rounded-lg">8. ê°•ì‚¬ ì†Œê°œ ë° ê²½ë ¥</div>
                    <div class="p-3 bg-white rounded-lg">9. ì´ë²¤íŠ¸ ë° í”„ë¡œëª¨ì…˜ ì•ˆë‚´</div>
                    <div class="p-3 bg-white rounded-lg">10. ì§€ì—­ë³„ êµìœ¡ ì •ë³´</div>
                </div>
            </div>
        </div>
    </body>
    </html>
  `)
})

// 7. SNS ì½˜í…ì¸  ìº˜ë¦°ë”
app.get('/tools/content-calendar', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SNS ì½˜í…ì¸  ìº˜ë¦°ë” - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>.gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }</style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-6xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4 text-center">ğŸ“… SNS ì½˜í…ì¸  ìº˜ë¦°ë”</h1>
            <p class="text-xl text-gray-600 text-center mb-12">í•œ ë‹¬ ì½˜í…ì¸ ë¥¼ ë¯¸ë¦¬ ê³„íší•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ì£¼ê°„ ì½˜í…ì¸  ì¶”ì²œ (ì˜ˆì‹œ)</h2>
                <div class="grid md:grid-cols-7 gap-2">
                    <div class="p-4 bg-purple-50 rounded-xl">
                        <div class="font-bold text-purple-900 mb-2">ì›”ìš”ì¼</div>
                        <div class="text-sm text-gray-700">ë™ê¸°ë¶€ì—¬ ëª…ì–¸</div>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-xl">
                        <div class="font-bold text-blue-900 mb-2">í™”ìš”ì¼</div>
                        <div class="text-sm text-gray-700">í•™ìŠµ íŒ ê³µìœ </div>
                    </div>
                    <div class="p-4 bg-green-50 rounded-xl">
                        <div class="font-bold text-green-900 mb-2">ìˆ˜ìš”ì¼</div>
                        <div class="text-sm text-gray-700">í•™ì› ì¼ìƒ</div>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-xl">
                        <div class="font-bold text-yellow-900 mb-2">ëª©ìš”ì¼</div>
                        <div class="text-sm text-gray-700">êµì¬/ìë£Œ ì†Œê°œ</div>
                    </div>
                    <div class="p-4 bg-orange-50 rounded-xl">
                        <div class="font-bold text-orange-900 mb-2">ê¸ˆìš”ì¼</div>
                        <div class="text-sm text-gray-700">í•™ìƒ ì„±ê³¼ ì†Œì‹</div>
                    </div>
                    <div class="p-4 bg-red-50 rounded-xl">
                        <div class="font-bold text-red-900 mb-2">í† ìš”ì¼</div>
                        <div class="text-sm text-gray-700">ì´ë²¤íŠ¸ ì•ˆë‚´</div>
                    </div>
                    <div class="p-4 bg-pink-50 rounded-xl">
                        <div class="font-bold text-pink-900 mb-2">ì¼ìš”ì¼</div>
                        <div class="text-sm text-gray-700">íœ´ì‹ & ê³µê°</div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ì›”ê°„ ì½˜í…ì¸  ì•„ì´ë””ì–´ (30ê°œ)</h2>
                <div class="grid md:grid-cols-3 gap-4">
                    ${Array.from({length: 30}, (_, i) => `
                        <div class="p-4 bg-gray-50 rounded-xl hover:bg-purple-50 transition cursor-pointer">
                            <div class="font-bold text-purple-600">${i+1}ì¼ì°¨</div>
                            <div class="text-sm text-gray-700 mt-1">
                                ${['í•™ì› ì†Œê°œ', 'ìˆ˜ì—… í˜„ì¥', 'í•™ìŠµ íŒ', 'ëª…ì–¸', 'ì´ë²¤íŠ¸', 'í›„ê¸°', 'ì‹œì„¤ ì•ˆë‚´', 'ê°•ì‚¬ ì†Œê°œ', 'ì„±ì  í–¥ìƒ', 'í”„ë¡œëª¨ì…˜'][i % 10]}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="bg-gradient-to-br from-purple-50 to-orange-50 rounded-2xl p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ¯ ì½˜í…ì¸  ì œì‘ TIP</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold text-purple-900 mb-3">âœ… ì¸ìŠ¤íƒ€ê·¸ë¨</h3>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li>â€¢ ì •ë°©í˜•(1:1) ì´ë¯¸ì§€ ì‚¬ìš©</li>
                            <li>â€¢ í•´ì‹œíƒœê·¸ 10-15ê°œ</li>
                            <li>â€¢ ìŠ¤í† ë¦¬ ë§¤ì¼ 1-2ê°œ</li>
                            <li>â€¢ ë¦´ìŠ¤ ì£¼ 2-3íšŒ</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-orange-900 mb-3">âœ… ë¸”ë¡œê·¸</h3>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li>â€¢ ì£¼ 2-3íšŒ ì •ê¸° í¬ìŠ¤íŒ…</li>
                            <li>â€¢ 1500ì ì´ìƒ ì‘ì„±</li>
                            <li>â€¢ ì´ë¯¸ì§€ 2-3ì¥ í¬í•¨</li>
                            <li>â€¢ í‚¤ì›Œë“œ ìì—°ìŠ¤ëŸ½ê²Œ ë°°ì¹˜</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
  `)
})

// 8. í•™ì› ìƒë‹´ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ê¸°
app.get('/tools/consultation-script', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í•™ì› ìƒë‹´ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ê¸° - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>.gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }</style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4 text-center">ğŸ’¬ í•™ì› ìƒë‹´ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ê¸°</h1>
            <p class="text-xl text-gray-600 text-center mb-12">íš¨ê³¼ì ì¸ í•™ë¶€ëª¨ ìƒë‹´ ëŒ€ë³¸ì„ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤</p>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                <div class="space-y-8">
                    <div class="p-6 bg-purple-50 rounded-xl">
                        <h3 class="font-bold text-purple-900 mb-4 text-lg">1ë‹¨ê³„: ì¸ì‚¬ ë° ê´€ì‹¬ í™•ì¸</h3>
                        <div class="p-4 bg-white rounded-lg text-gray-700">
                            "ì•ˆë…•í•˜ì„¸ìš”, [í•™ì›ëª…]ì…ë‹ˆë‹¤. ë¬¸ì˜ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ğŸ˜Š<br>
                            í˜¹ì‹œ ì–´ë–¤ ê³¼ëª©ì— ê´€ì‹¬ì´ ìˆìœ¼ì‹ ê°€ìš”?<br>
                            ì•„ì´ì˜ í˜„ì¬ í•™ë…„ê³¼ í•™ìŠµ ëª©í‘œë¥¼ ë§ì”€í•´ì£¼ì‹œë©´<br>
                            ë§ì¶¤ ìƒë‹´ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
                        </div>
                    </div>

                    <div class="p-6 bg-blue-50 rounded-xl">
                        <h3 class="font-bold text-blue-900 mb-4 text-lg">2ë‹¨ê³„: ë‹ˆì¦ˆ íŒŒì•…</h3>
                        <div class="p-4 bg-white rounded-lg text-gray-700">
                            "í˜„ì¬ í•™ìŠµì—ì„œ ê°€ì¥ ì–´ë ¤ìš´ ë¶€ë¶„ì€ ë¬´ì—‡ì¸ê°€ìš”?<br><br>
                            <strong>ì£¼ìš” ì§ˆë¬¸ ì˜ˆì‹œ:</strong><br>
                            â€¢ ì„±ì  í–¥ìƒì´ ëª©í‘œì´ì‹ ê°€ìš”?<br>
                            â€¢ ë‚´ì‹  ëŒ€ë¹„ì¸ê°€ìš”, ìˆ˜ëŠ¥ ëŒ€ë¹„ì¸ê°€ìš”?<br>
                            â€¢ í•™ìŠµ ìŠµê´€ ê°œì„ ì´ í•„ìš”í•˜ì‹ ê°€ìš”?<br>
                            â€¢ íŠ¹ì • ë‹¨ì›ì´ë‚˜ ì˜ì—­ì— ì•½ì ì´ ìˆë‚˜ìš”?"
                        </div>
                    </div>

                    <div class="p-6 bg-green-50 rounded-xl">
                        <h3 class="font-bold text-green-900 mb-4 text-lg">3ë‹¨ê³„: í•™ì› ê°•ì  ì†Œê°œ</h3>
                        <div class="p-4 bg-white rounded-lg text-gray-700">
                            "ì €í¬ í•™ì›ì˜ <strong>[ì°¨ë³„í™” í¬ì¸íŠ¸]</strong>ë¥¼ ì†Œê°œí•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.<br><br>
                            <strong>ì˜ˆì‹œ:</strong><br>
                            âœ… ì†Œìˆ˜ì •ì˜ˆ ë§ì¶¤ ìˆ˜ì—… (í•™ìƒ 1:4 ë¹„ìœ¨)<br>
                            âœ… ë§¤ì£¼ í•™ìŠµ ë¦¬í¬íŠ¸ ì œê³µ<br>
                            âœ… 20ë…„ ê²½ë ¥ ì „ë¬¸ ê°•ì‚¬ì§„<br>
                            âœ… ì²´ê³„ì ì¸ ë ˆë²¨ í…ŒìŠ¤íŠ¸<br>
                            âœ… í•™ë¶€ëª¨ ìƒë‹´ ì›” 1íšŒ ì§„í–‰"
                        </div>
                    </div>

                    <div class="p-6 bg-orange-50 rounded-xl">
                        <h3 class="font-bold text-orange-900 mb-4 text-lg">4ë‹¨ê³„: í–‰ë™ ìœ ë„ (CTA)</h3>
                        <div class="p-4 bg-white rounded-lg text-gray-700">
                            "ë¬´ë£Œ ë ˆë²¨ í…ŒìŠ¤íŠ¸ì™€ 1íšŒ ì²´í—˜ ìˆ˜ì—…ì„ ì œê³µí•´ë“œë¦¬ê³  ìˆìŠµë‹ˆë‹¤.<br>
                            ì´ë²ˆ ì£¼ ì¤‘ ë°©ë¬¸ ê°€ëŠ¥í•˜ì‹  ë‚ ì§œê°€ ìˆìœ¼ì‹ ê°€ìš”?<br><br>
                            <strong>ìƒë‹´ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„:</strong><br>
                            â€¢ í‰ì¼: ì˜¤í›„ 3ì‹œ~8ì‹œ<br>
                            â€¢ í† ìš”ì¼: ì˜¤ì „ 10ì‹œ~ì˜¤í›„ 5ì‹œ<br><br>
                            í¸í•˜ì‹  ì‹œê°„ì— ë°©ë¬¸í•´ì£¼ì‹œë©´<br>
                            ìì„¸í•œ ì»¤ë¦¬í˜ëŸ¼ê³¼ ìˆ˜ê°•ë£Œë¥¼ ì•ˆë‚´í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤."
                        </div>
                    </div>

                    <div class="p-6 bg-pink-50 rounded-xl">
                        <h3 class="font-bold text-pink-900 mb-4 text-lg">5ë‹¨ê³„: ë§ˆë¬´ë¦¬</h3>
                        <div class="p-4 bg-white rounded-lg text-gray-700">
                            "ì¶”ê°€ë¡œ ê¶ê¸ˆí•˜ì‹  ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ì—°ë½ ì£¼ì„¸ìš”!<br>
                            ì¹´ì¹´ì˜¤í†¡/ì „í™” ìƒë‹´ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤. ğŸ˜Š<br><br>
                            <strong>ì—°ë½ì²˜:</strong><br>
                            ğŸ“ ì „í™”: 010-XXXX-XXXX<br>
                            ğŸ’¬ ì¹´í†¡: [ì¹´ì¹´ì˜¤í†¡ ID]<br>
                            ğŸ“§ ì´ë©”ì¼: [ì´ë©”ì¼ ì£¼ì†Œ]<br><br>
                            ê°ì‚¬í•©ë‹ˆë‹¤!"
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ¯ ìƒë‹´ ì„±ê³µ TIP</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="font-bold text-purple-900 mb-3">âœ… í•´ì•¼ í•  ê²ƒ</h3>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li>â€¢ í•™ë¶€ëª¨ ì´ë¦„ìœ¼ë¡œ í˜¸ì¹­í•˜ê¸°</li>
                            <li>â€¢ ê²½ì²­í•˜ê³  ê³µê° í‘œí˜„í•˜ê¸°</li>
                            <li>â€¢ êµ¬ì²´ì ì¸ ìˆ«ì/ì‚¬ë¡€ ì œì‹œ</li>
                            <li>â€¢ ê¸ì •ì ì¸ í†¤ ìœ ì§€í•˜ê¸°</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="font-bold text-red-900 mb-3">âŒ í•˜ì§€ ë§ì•„ì•¼ í•  ê²ƒ</h3>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li>â€¢ ë‹¤ë¥¸ í•™ì› ë¹„ë°©í•˜ê¸°</li>
                            <li>â€¢ ê³¼ë„í•œ ì•½ì†í•˜ê¸°</li>
                            <li>â€¢ ê°•ì••ì ì¸ ë“±ë¡ ìœ ë„</li>
                            <li>â€¢ ì¼ë°©ì ìœ¼ë¡œ ë§í•˜ê¸°</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
  `)
})

// 9. ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìµœì í™” ì ê²€í‘œ
app.get('/tools/place-optimization', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í”Œë ˆì´ìŠ¤ ìµœì í™” ì ê²€í‘œ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>.gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }</style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4 text-center">âœ… ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìµœì í™” ì ê²€í‘œ</h1>
            <p class="text-xl text-gray-600 text-center mb-12">100ì  ë§Œì  í”Œë ˆì´ìŠ¤ ë§Œë“¤ê¸°</p>

            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                <div class="mb-6 p-4 bg-purple-50 rounded-xl text-center">
                    <div class="text-4xl font-bold text-purple-600" id="score">0</div>
                    <div class="text-gray-600 mt-2">í˜„ì¬ ì ìˆ˜ / 100ì </div>
                </div>

                <div class="space-y-6">
                    <div class="p-6 bg-gray-50 rounded-xl">
                        <h3 class="font-bold text-gray-900 mb-4">ê¸°ë³¸ ì •ë³´ (30ì )</h3>
                        <div class="space-y-3">
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">ì •í™•í•œ í•™ì›ëª… (5ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">ì •í™•í•œ ì£¼ì†Œ ë° ì§€ë„ ìœ„ì¹˜ (5ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">ì „í™”ë²ˆí˜¸ ë“±ë¡ (5ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">ìš´ì˜ ì‹œê°„ ì •í™•íˆ ì…ë ¥ (5ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">ìƒì„¸í•œ ì†Œê°œê¸€ ì‘ì„± (5ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">í‚¤ì›Œë“œ 3ê°œ ì´ìƒ ì„¤ì • (5ì )</span>
                            </label>
                        </div>
                    </div>

                    <div class="p-6 bg-gray-50 rounded-xl">
                        <h3 class="font-bold text-gray-900 mb-4">ì‚¬ì§„ ê´€ë¦¬ (25ì )</h3>
                        <div class="space-y-3">
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="10">
                                <span class="flex-1">ì‚¬ì§„ 10ì¥ ì´ìƒ ë“±ë¡ (10ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">ê³ í’ˆì§ˆ ì‚¬ì§„ (ë°ê³  ì„ ëª…) (5ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">ë‹¤ì–‘í•œ ê°ë„ ì´¬ì˜ (5ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">ì •ê¸°ì  ì—…ë°ì´íŠ¸ (ì›” 1íšŒ) (5ì )</span>
                            </label>
                        </div>
                    </div>

                    <div class="p-6 bg-gray-50 rounded-xl">
                        <h3 class="font-bold text-gray-900 mb-4">ë¦¬ë·° ê´€ë¦¬ (30ì )</h3>
                        <div class="space-y-3">
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="10">
                                <span class="flex-1">ë¦¬ë·° 10ê°œ ì´ìƒ (10ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="10">
                                <span class="flex-1">í‰ê·  í‰ì  4.5ì  ì´ìƒ (10ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="10">
                                <span class="flex-1">ëª¨ë“  ë¦¬ë·°ì— ì‘ë‹µ (10ì )</span>
                            </label>
                        </div>
                    </div>

                    <div class="p-6 bg-gray-50 rounded-xl">
                        <h3 class="font-bold text-gray-900 mb-4">í™œë™ì„± (15ì )</h3>
                        <div class="space-y-3">
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">ì†Œì‹ ì£¼ 1íšŒ ì—…ë°ì´íŠ¸ (5ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜ ë“±ë¡ (5ì )</span>
                            </label>
                            <label class="flex items-center p-3 hover:bg-white rounded-lg cursor-pointer transition">
                                <input type="checkbox" class="score-checkbox mr-3 w-5 h-5" data-score="5">
                                <span class="flex-1">ë©”ë‰´/ì„œë¹„ìŠ¤ ì •ë³´ ìƒì„¸ (5ì )</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mt-8 p-6 rounded-xl" id="result">
                    <div class="text-center">
                        <button onclick="location.reload()" class="gradient-purple text-white px-8 py-3 rounded-xl font-bold hover:shadow-xl transition">
                            ë‹¤ì‹œ ì²´í¬í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const checkboxes = document.querySelectorAll('.score-checkbox');
            const scoreEl = document.getElementById('score');
            const resultEl = document.getElementById('result');
            
            checkboxes.forEach(cb => {
                cb.addEventListener('change', updateScore);
            });
            
            function updateScore() {
                let total = 0;
                checkboxes.forEach(cb => {
                    if(cb.checked) {
                        total += parseInt(cb.dataset.score);
                    }
                });
                
                scoreEl.textContent = total;
                
                let resultHTML = '';
                let bgColor = '';
                
                if(total >= 90) {
                    bgColor = 'bg-green-50 border border-green-200';
                    resultHTML = '<div class="text-green-800 text-center"><div class="text-2xl font-bold mb-2">ğŸ‰ ì™„ë²½í•©ë‹ˆë‹¤!</div><div>í”Œë ˆì´ìŠ¤ê°€ ìµœì í™”ë˜ì—ˆìŠµë‹ˆë‹¤!</div></div>';
                } else if(total >= 70) {
                    bgColor = 'bg-blue-50 border border-blue-200';
                    resultHTML = '<div class="text-blue-800 text-center"><div class="text-2xl font-bold mb-2">ğŸ‘ ì¢‹ìŠµë‹ˆë‹¤!</div><div>ì¡°ê¸ˆë§Œ ë” ë³´ì™„í•˜ë©´ ì™„ë²½í•´ìš”!</div></div>';
                } else if(total >= 50) {
                    bgColor = 'bg-orange-50 border border-orange-200';
                    resultHTML = '<div class="text-orange-800 text-center"><div class="text-2xl font-bold mb-2">ğŸ’ª ê´œì°®ìŠµë‹ˆë‹¤!</div><div>ì²´í¬ ì•ˆ ëœ í•­ëª©ë“¤ì„ ë³´ì™„í•´ë³´ì„¸ìš”!</div></div>';
                } else if(total > 0) {
                    bgColor = 'bg-red-50 border border-red-200';
                    resultHTML = '<div class="text-red-800 text-center"><div class="text-2xl font-bold mb-2">âš ï¸ ê°œì„  í•„ìš”!</div><div>ê¸°ë³¸ í•­ëª©ë¶€í„° ì°¨ê·¼ì°¨ê·¼ ì§„í–‰í•˜ì„¸ìš”!</div></div>';
                }
                
                resultEl.className = 'mt-8 p-6 rounded-xl ' + bgColor;
                if(total > 0) {
                    resultEl.innerHTML = resultHTML + '<div class="text-center mt-4"><button onclick="location.reload()" class="gradient-purple text-white px-8 py-3 rounded-xl font-bold hover:shadow-xl transition">ë‹¤ì‹œ ì²´í¬í•˜ê¸°</button></div>';
                }
            }
        </script>
    </body>
    </html>
  `)
})

// 10. í•™ì› ë§ˆì¼€íŒ… ROI ê³„ì‚°ê¸°
app.get('/tools/roi-calculator', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë§ˆì¼€íŒ… ROI ê³„ì‚°ê¸° - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>.gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }</style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4 text-center">ğŸ’° í•™ì› ë§ˆì¼€íŒ… ROI ê³„ì‚°ê¸°</h1>
            <p class="text-xl text-gray-600 text-center mb-12">ë§ˆì¼€íŒ… íˆ¬ì ëŒ€ë¹„ ìˆ˜ìµë¥ ì„ ê³„ì‚°í•˜ì„¸ìš”</p>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">ì…ë ¥ ì •ë³´</h2>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì›” ë§ˆì¼€íŒ… ë¹„ìš© (ì›)</label>
                            <input type="number" id="marketingCost" placeholder="300000" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">ì‹ ê·œ ë“±ë¡ í•™ìƒ ìˆ˜ (ëª…)</label>
                            <input type="number" id="newStudents" placeholder="10" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">í•™ìƒ 1ëª…ë‹¹ ì›” ìˆ˜ê°•ë£Œ (ì›)</label>
                            <input type="number" id="tuitionPerStudent" placeholder="400000" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">í‰ê·  ìˆ˜ê°• ê¸°ê°„ (ê°œì›”)</label>
                            <input type="number" id="avgDuration" placeholder="12" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                        </div>
                        <button onclick="calculate()" class="w-full gradient-purple text-white py-4 rounded-xl font-bold hover:shadow-xl transition">
                            ROI ê³„ì‚°í•˜ê¸°
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">ê³„ì‚° ê²°ê³¼</h2>
                    <div id="results" class="hidden space-y-6">
                        <div class="p-6 bg-purple-50 rounded-xl">
                            <div class="text-sm text-gray-600 mb-1">ì´ ë§¤ì¶œ</div>
                            <div class="text-3xl font-bold text-purple-600" id="totalRevenue">0ì›</div>
                        </div>
                        <div class="p-6 bg-blue-50 rounded-xl">
                            <div class="text-sm text-gray-600 mb-1">ìˆœì´ìµ</div>
                            <div class="text-3xl font-bold text-blue-600" id="profit">0ì›</div>
                        </div>
                        <div class="p-6 bg-green-50 rounded-xl">
                            <div class="text-sm text-gray-600 mb-1">ROI (íˆ¬ì ëŒ€ë¹„ ìˆ˜ìµë¥ )</div>
                            <div class="text-4xl font-bold text-green-600" id="roi">0%</div>
                        </div>
                        <div class="p-6 bg-orange-50 rounded-xl">
                            <div class="text-sm text-gray-600 mb-1">í•™ìƒ 1ëª…ë‹¹ íšë“ ë¹„ìš©</div>
                            <div class="text-2xl font-bold text-orange-600" id="cpa">0ì›</div>
                        </div>
                    </div>

                    <div id="tips" class="hidden mt-8">
                        <h3 class="font-bold text-gray-900 mb-4">ğŸ’¡ ë¶„ì„ TIP</h3>
                        <div class="space-y-3 text-sm">
                            <div class="p-4 bg-green-50 rounded-xl">
                                <div class="font-bold text-green-900 mb-1">âœ… ROI 300% ì´ìƒ</div>
                                <div class="text-gray-700">ë§¤ìš° íš¨ìœ¨ì ! ë§ˆì¼€íŒ… ìœ ì§€</div>
                            </div>
                            <div class="p-4 bg-blue-50 rounded-xl">
                                <div class="font-bold text-blue-900 mb-1">âœ… ROI 150-300%</div>
                                <div class="text-gray-700">ì¢‹ì€ ìˆ˜ì¤€! ìµœì í™” ê°€ëŠ¥</div>
                            </div>
                            <div class="p-4 bg-orange-50 rounded-xl">
                                <div class="font-bold text-orange-900 mb-1">âš ï¸ ROI 100-150%</div>
                                <div class="text-gray-700">ê°œì„  í•„ìš”, ì „ëµ ì¬ê²€í† </div>
                            </div>
                            <div class="p-4 bg-red-50 rounded-xl">
                                <div class="font-bold text-red-900 mb-1">âŒ ROI 100% ë¯¸ë§Œ</div>
                                <div class="text-gray-700">ë§ˆì¼€íŒ… ì „ëµ ì „ë©´ ìˆ˜ì • í•„ìš”</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 bg-gradient-to-br from-purple-50 to-blue-50 rounded-2xl p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“Š í•™ì› ë§ˆì¼€íŒ… ROI ê°œì„  ì „ëµ</h2>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="p-6 bg-white rounded-xl">
                        <div class="text-3xl mb-3">ğŸ¯</div>
                        <h3 class="font-bold text-gray-900 mb-2">íƒ€ê²ŸíŒ… ì •êµí™”</h3>
                        <p class="text-sm text-gray-600">ìš°ë¦¬ í•™ì›ì— ê¼­ ë§ëŠ” í•™ë¶€ëª¨ë§Œ ê³µëµ</p>
                    </div>
                    <div class="p-6 bg-white rounded-xl">
                        <div class="text-3xl mb-3">ğŸ’¬</div>
                        <h3 class="font-bold text-gray-900 mb-2">ì „í™˜ìœ¨ í–¥ìƒ</h3>
                        <p class="text-sm text-gray-600">ìƒë‹´ì—ì„œ ë“±ë¡ê¹Œì§€ì˜ ì „í™˜ìœ¨ ë†’ì´ê¸°</p>
                    </div>
                    <div class="p-6 bg-white rounded-xl">
                        <div class="text-3xl mb-3">ğŸ”„</div>
                        <h3 class="font-bold text-gray-900 mb-2">ì¬ë“±ë¡ë¥  ê´€ë¦¬</h3>
                        <p class="text-sm text-gray-600">ê¸°ì¡´ í•™ìƒ ë§Œì¡±ë„ ë†’ì—¬ ì¥ê¸° ìˆ˜ê°•</p>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function calculate() {
                const cost = parseInt(document.getElementById('marketingCost').value) || 0;
                const students = parseInt(document.getElementById('newStudents').value) || 0;
                const tuition = parseInt(document.getElementById('tuitionPerStudent').value) || 0;
                const duration = parseInt(document.getElementById('avgDuration').value) || 0;
                
                if(cost === 0 || students === 0 || tuition === 0 || duration === 0) {
                    alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                    return;
                }
                
                const totalRevenue = students * tuition * duration;
                const profit = totalRevenue - cost;
                const roi = ((profit / cost) * 100).toFixed(1);
                const cpa = (cost / students).toFixed(0);
                
                document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString() + 'ì›';
                document.getElementById('profit').textContent = profit.toLocaleString() + 'ì›';
                document.getElementById('roi').textContent = roi + '%';
                document.getElementById('cpa').textContent = parseInt(cpa).toLocaleString() + 'ì›';
                
                document.getElementById('results').classList.remove('hidden');
                document.getElementById('tips').classList.remove('hidden');
            }
        </script>
    </body>
    </html>
  `)
})

// ë§ˆì¼€íŒ… íˆ´ ëª©ë¡ í˜ì´ì§€
app.get('/tools', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë§ˆì¼€íŒ… íˆ´ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
            .card-hover { transition: all 0.3s ease; }
            .card-hover:hover { transform: translateY(-8px); box-shadow: 0 20px 40px -10px rgba(124, 58, 237, 0.3); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/" class="text-gray-600 hover:text-purple-600">â† í™ˆìœ¼ë¡œ</a>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-12">
            <div class="text-center mb-16">
                <h1 class="text-5xl font-bold text-gray-900 mb-6">ğŸš€ ë§ˆì¼€íŒ… íˆ´ ëª¨ìŒ</h1>
                <p class="text-2xl text-gray-600">í•™ì› ë§ˆì¼€íŒ…ì— í•„ìš”í•œ ëª¨ë“  ë„êµ¬ë¥¼ í•œ ê³³ì—ì„œ</p>
                <div class="mt-6 inline-flex items-center px-6 py-3 bg-purple-50 rounded-full text-purple-700 font-medium">
                    <i class="fas fa-check-circle mr-2"></i>
                    100% ë¬´ë£Œ Â· íšŒì›ê°€ì… ë¶ˆí•„ìš” Â· ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥
                </div>
            </div>

            <div class="grid md:grid-cols-3 gap-8">
                <a href="/tools/keyword-analyzer" class="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-purple-300 card-hover">
                    <div class="w-16 h-16 gradient-purple rounded-2xl flex items-center justify-center mb-6">
                        <i class="fas fa-search text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">í‚¤ì›Œë“œ ë¶„ì„ê¸°</h3>
                    <p class="text-gray-600 mb-4">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìµœì  í‚¤ì›Œë“œ ë°œêµ´</p>
                    <div class="flex items-center text-purple-600 font-medium">
                        ìì„¸íˆ ë³´ê¸° <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </a>

                <a href="/tools/review-template" class="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-purple-300 card-hover">
                    <div class="w-16 h-16 gradient-purple rounded-2xl flex items-center justify-center mb-6">
                        <i class="fas fa-comment-dots text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ë¦¬ë·° ì‘ë‹µ ìƒì„±ê¸°</h3>
                    <p class="text-gray-600 mb-4">ê³ ê° ë¦¬ë·°ì— ë§ì¶¤í˜• ë‹µë³€ ìë™ ìƒì„±</p>
                    <div class="flex items-center text-purple-600 font-medium">
                        ìì„¸íˆ ë³´ê¸° <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </a>

                <a href="/tools/ad-copy-generator" class="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-purple-300 card-hover">
                    <div class="w-16 h-16 gradient-purple rounded-2xl flex items-center justify-center mb-6">
                        <i class="fas fa-bullhorn text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">í™ë³´ ë¬¸êµ¬ ìƒì„±ê¸°</h3>
                    <p class="text-gray-600 mb-4">íš¨ê³¼ì ì¸ í•™ì› ê´‘ê³  ë¬¸êµ¬ 5ê°œ ìë™ ìƒì„±</p>
                    <div class="flex items-center text-purple-600 font-medium">
                        ìì„¸íˆ ë³´ê¸° <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </a>

                <a href="/tools/photo-optimizer" class="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-purple-300 card-hover">
                    <div class="w-16 h-16 gradient-purple rounded-2xl flex items-center justify-center mb-6">
                        <i class="fas fa-camera text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ì‚¬ì§„ ìµœì í™” ê°€ì´ë“œ</h3>
                    <p class="text-gray-600 mb-4">í´ë¦­ë¥  ë†’ì´ëŠ” í”Œë ˆì´ìŠ¤ ì‚¬ì§„ ì´¬ì˜ë²•</p>
                    <div class="flex items-center text-purple-600 font-medium">
                        ìì„¸íˆ ë³´ê¸° <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </a>

                <a href="/tools/competitor-analysis" class="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-purple-300 card-hover">
                    <div class="w-16 h-16 gradient-purple rounded-2xl flex items-center justify-center mb-6">
                        <i class="fas fa-chart-line text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ê²½ìŸ í•™ì› ë¶„ì„</h3>
                    <p class="text-gray-600 mb-4">ì£¼ë³€ ê²½ìŸì‚¬ ë¶„ì„ ë° ì°¨ë³„í™” ì „ëµ</p>
                    <div class="flex items-center text-purple-600 font-medium">
                        ìì„¸íˆ ë³´ê¸° <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </a>

                <a href="/tools/blog-checklist" class="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-purple-300 card-hover">
                    <div class="w-16 h-16 gradient-purple rounded-2xl flex items-center justify-center mb-6">
                        <i class="fas fa-check-square text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ë¸”ë¡œê·¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
                    <p class="text-gray-600 mb-4">SEO ìµœì í™” ë¸”ë¡œê·¸ ì‘ì„± ì™„ë²½ ê°€ì´ë“œ</p>
                    <div class="flex items-center text-purple-600 font-medium">
                        ìì„¸íˆ ë³´ê¸° <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </a>

                <a href="/tools/content-calendar" class="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-purple-300 card-hover">
                    <div class="w-16 h-16 gradient-purple rounded-2xl flex items-center justify-center mb-6">
                        <i class="fas fa-calendar-alt text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ì½˜í…ì¸  ìº˜ë¦°ë”</h3>
                    <p class="text-gray-600 mb-4">í•œ ë‹¬ SNS ì½˜í…ì¸  ë¯¸ë¦¬ ê³„íší•˜ê¸°</p>
                    <div class="flex items-center text-purple-600 font-medium">
                        ìì„¸íˆ ë³´ê¸° <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </a>

                <a href="/tools/consultation-script" class="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-purple-300 card-hover">
                    <div class="w-16 h-16 gradient-purple rounded-2xl flex items-center justify-center mb-6">
                        <i class="fas fa-comments text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ìƒë‹´ ìŠ¤í¬ë¦½íŠ¸</h3>
                    <p class="text-gray-600 mb-4">íš¨ê³¼ì ì¸ í•™ë¶€ëª¨ ìƒë‹´ ëŒ€ë³¸ 5ë‹¨ê³„</p>
                    <div class="flex items-center text-purple-600 font-medium">
                        ìì„¸íˆ ë³´ê¸° <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </a>

                <a href="/tools/place-optimization" class="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-purple-300 card-hover">
                    <div class="w-16 h-16 gradient-purple rounded-2xl flex items-center justify-center mb-6">
                        <i class="fas fa-tasks text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">í”Œë ˆì´ìŠ¤ ì ê²€í‘œ</h3>
                    <p class="text-gray-600 mb-4">100ì  ë§Œì  í”Œë ˆì´ìŠ¤ ë§Œë“¤ê¸° ì²´í¬ë¦¬ìŠ¤íŠ¸</p>
                    <div class="flex items-center text-purple-600 font-medium">
                        ìì„¸íˆ ë³´ê¸° <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </a>

                <a href="/tools/roi-calculator" class="bg-white rounded-2xl p-8 shadow-lg border-2 border-transparent hover:border-purple-300 card-hover">
                    <div class="w-16 h-16 gradient-purple rounded-2xl flex items-center justify-center mb-6">
                        <i class="fas fa-calculator text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">ROI ê³„ì‚°ê¸°</h3>
                    <p class="text-gray-600 mb-4">ë§ˆì¼€íŒ… íˆ¬ì ëŒ€ë¹„ ìˆ˜ìµë¥  ë¶„ì„ ë„êµ¬</p>
                    <div class="flex items-center text-purple-600 font-medium">
                        ìì„¸íˆ ë³´ê¸° <i class="fas fa-arrow-right ml-2"></i>
                    </div>
                </a>
            </div>

            <div class="mt-16 bg-gradient-to-br from-purple-50 to-white rounded-3xl p-12 text-center">
                <h2 class="text-3xl font-bold text-gray-900 mb-4">ë” ë§ì€ ë§ˆì¼€íŒ… ì§€ì›ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</h2>
                <p class="text-xl text-gray-600 mb-8">ì „ë¬¸ ì»¨ì„¤í„´íŠ¸ì™€ 1:1 ìƒë‹´ì„ ì§„í–‰í•´ë³´ì„¸ìš”</p>
                <a href="/contact" class="inline-block gradient-purple text-white px-12 py-4 rounded-full text-lg font-bold shadow-xl hover:shadow-2xl transition-all hover:-translate-y-1">
                    ë¬´ë£Œ ìƒë‹´ ì‹ ì²­í•˜ê¸°
                </a>
            </div>
        </div>
    </body>
    </html>
  `)
})

// ê²€ìƒ‰ëŸ‰ ì¡°íšŒ ë° ìˆœìœ„ ë¶„ì„ API
app.post('/api/search-analysis', async (c) => {
  try {
    const { userId, keyword, placeUrl } = await c.req.json()

    if (!keyword) {
      return c.json({ success: false, error: 'í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }

    // Python í¬ë¡¤ë§ ì„œë²„ì™€ í†µì‹ 
    const CRAWLER_API_URL = 'https://web-production-14c4.up.railway.app/analyze'
    
    try {
      // Cloudflare Workersì—ì„œëŠ” fetchì— ì§ì ‘ íƒ€ì„ì•„ì›ƒì„ ì„¤ì •í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ
      // Promise.raceë¥¼ ì‚¬ìš©í•˜ì—¬ íƒ€ì„ì•„ì›ƒ êµ¬í˜„
      const fetchPromise = fetch(CRAWLER_API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          keyword: keyword,
          placeUrl: placeUrl || null
        })
      })

      const timeoutPromise = new Promise((_, reject) =>
        setTimeout(() => reject(new Error('Request timeout')), 50000)
      )

      const crawlerResponse = await Promise.race([fetchPromise, timeoutPromise]) as Response

      if (!crawlerResponse.ok) {
        throw new Error(`Crawler API error: ${crawlerResponse.status}`)
      }

      const analysisResult = await crawlerResponse.json()

      // ë¶„ì„ ê¸°ë¡ ì €ì¥
      const { env } = c
      if (userId) {
        try {
          await env.DB.prepare(`
            INSERT INTO search_analysis_logs (user_id, keyword, place_url, result_data, created_at)
            VALUES (?, ?, ?, ?, datetime('now'))
          `).bind(userId, keyword, placeUrl || '', JSON.stringify(analysisResult)).run()
        } catch (dbError) {
          console.error('DB save error:', dbError)
          // DB ì €ì¥ ì‹¤íŒ¨í•´ë„ ê²°ê³¼ëŠ” ë°˜í™˜
        }
      }

      return c.json(analysisResult)
      
    } catch (crawlerError) {
      console.error('Crawler API error:', crawlerError)
      
      // í¬ë¡¤ëŸ¬ ì„œë²„ ì˜¤ë¥˜ ì‹œ ì„ì‹œ ì‘ë‹µ ë°˜í™˜
      const fallbackResponse = {
        success: false,
        error: 'í¬ë¡¤ë§ ì„œë²„ ì—°ê²° ì‹¤íŒ¨',
        message: `ì˜¤ë¥˜: ${crawlerError instanceof Error ? crawlerError.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`,
        searchVolume: {
          monthlyAvg: 0,
          competition: 'ë¶„ì„ ë¶ˆê°€',
          recommendation: 'ì„œë²„ ì˜¤ë¥˜'
        },
        ranking: {
          myRank: null,
          competitors: []
        },
        keywords: []
      }

      return c.json(fallbackResponse)
    }
  } catch (err) {
    console.error('Search analysis error:', err)
    return c.json({ success: false, error: 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ëŒ€í–‰ ë¬¸ì˜ API
app.post('/api/contact', async (c) => {
  try {
    const { type, academy, name, phone, email, programs, message } = await c.req.json()
    
    // ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
    const { env } = c
    await env.DB.prepare(`
      INSERT INTO contacts (inquiry, academy, name, phone, email, programs, message, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(type, academy, name, phone, email || '', JSON.stringify(programs || []), message).run()

    return c.json({ success: true, message: 'ë¬¸ì˜ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (err) {
    console.error('Contact error:', err)
    return c.json({ success: false, error: 'ë¬¸ì˜ ì ‘ìˆ˜ ì‹¤íŒ¨' }, 500)
  }
})

// ë¡œê·¸ì¸ API
app.post('/api/login', async (c) => {
  try {
    const { email, password } = await c.req.json()
    const { env } = c
    
    // ì‚¬ìš©ì ì¡°íšŒ
    const user = await env.DB.prepare('SELECT * FROM users WHERE email = ?').bind(email).first()
    
    if (!user) {
      return c.json({ success: false, error: 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤' }, 401)
    }
    
    // ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (ì‹¤ì œë¡œëŠ” í•´ì‹œ ë¹„êµë¥¼ í•´ì•¼ í•˜ì§€ë§Œ, í˜„ì¬ëŠ” ë‹¨ìˆœ ë¹„êµ)
    if (user.password !== password) {
      return c.json({ success: false, error: 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤' }, 401)
    }
    
    // ë¹„ë°€ë²ˆí˜¸ ì œì™¸í•˜ê³  ì‚¬ìš©ì ì •ë³´ ë°˜í™˜
    const userInfo: any = {
      id: user.id,
      email: user.email,
      name: user.name,
      phone: user.phone,
      academy_id: user.academy_id,
      academy_name: user.academy_name,
      role: user.role,
      user_type: user.user_type || user.role, // user_type ìš°ì„ , ì—†ìœ¼ë©´ role ì‚¬ìš©
      parent_user_id: user.parent_user_id || null
    }
    
    // âœ… STEP 1: ì›ì¥ë‹˜ì¸ë° academy_idê°€ ì—†ìœ¼ë©´ user.idë¡œ ì„¤ì •í•˜ê³  DB ì—…ë°ì´íŠ¸
    const isDirector = (user.user_type === 'director' || user.role === 'director' || !user.user_type || user.role === 'user');
    const isTeacher = (user.user_type === 'teacher' || user.role === 'teacher');
    
    if (isDirector && !userInfo.academy_id) {
      console.log('ğŸ”§ [Login] Director without academy_id, setting to user.id:', user.id)
      userInfo.academy_id = user.id
      
      try {
        await env.DB.prepare(
          'UPDATE users SET academy_id = ? WHERE id = ?'
        ).bind(user.id, user.id).run()
        console.log('âœ… [Login] Updated director academy_id in DB:', user.id)
      } catch (err) {
        console.error('Failed to update director academy_id:', err)
      }
    }
    
    // âœ… STEP 2: ì„ ìƒë‹˜ì¸ë° academy_idê°€ ì—†ìœ¼ë©´ ì›ì¥ë‹˜ì—ê²Œì„œ ê°€ì ¸ì˜¤ê¸°
    if (isTeacher && !userInfo.academy_id && user.parent_user_id) {
      try {
        const director = await env.DB.prepare(
          'SELECT id, academy_id FROM users WHERE id = ?'
        ).bind(user.parent_user_id).first()
        
        if (director) {
          // ì›ì¥ë‹˜ì˜ academy_id ë˜ëŠ” ì›ì¥ë‹˜ì˜ id ì‚¬ìš©
          const directorAcademyId = director.academy_id || director.id
          userInfo.academy_id = directorAcademyId
          console.log('ğŸ”§ [Login] Set teacher academy_id from director:', directorAcademyId)
          
          // ì„ ìƒë‹˜ DB ì—…ë°ì´íŠ¸
          await env.DB.prepare(
            'UPDATE users SET academy_id = ? WHERE id = ?'
          ).bind(directorAcademyId, user.id).run()
          console.log('âœ… [Login] Updated teacher academy_id in DB')
          
          // ì›ì¥ë‹˜ë„ academy_idê°€ ì—†ì—ˆë‹¤ë©´ ì›ì¥ë‹˜ DBë„ ì—…ë°ì´íŠ¸
          if (!director.academy_id) {
            await env.DB.prepare(
              'UPDATE users SET academy_id = ? WHERE id = ?'
            ).bind(director.id, director.id).run()
            console.log('âœ… [Login] Also updated director academy_id in DB:', director.id)
          }
        }
      } catch (err) {
        console.error('Failed to fetch director academy_id:', err)
      }
    }
    
    console.log('ğŸ” [Login] Final user info:', {
      id: userInfo.id,
      academy_id: userInfo.academy_id,
      user_type: userInfo.user_type,
      role: userInfo.role
    })
    
    // ì„ ìƒë‹˜ì¸ ê²½ìš° ê¶Œí•œ ì •ë³´ ì¡°íšŒ
    if (isTeacher) {
      try {
        const permData = await env.DB.prepare(`
          SELECT permissions 
          FROM teacher_permissions 
          WHERE teacher_id = ?
        `).bind(user.id).first()
        
        if (permData && permData.permissions) {
          userInfo.permissions = JSON.parse(permData.permissions)
          console.log('Teacher permissions loaded:', userInfo.permissions)
        } else {
          // ê¸°ë³¸ ê¶Œí•œ ì„¤ì •
          userInfo.permissions = {
            canViewAllStudents: false,
            canWriteDailyReports: false,
            assignedClasses: []
          }
          console.log('No permissions found, using defaults')
        }
      } catch (permErr) {
        console.error('Error loading teacher permissions:', permErr)
        // ê¶Œí•œ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ê¶Œí•œ
        userInfo.permissions = {
          canViewAllStudents: false,
          canWriteDailyReports: false,
          assignedClasses: []
        }
      }
    }
    
    return c.json({ success: true, message: 'ë¡œê·¸ì¸ ì„±ê³µ', user: userInfo })
  } catch (err) {
    console.error('Login error:', err)
    return c.json({ success: false, error: 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// SMS ë°œì†¡ API (ì•Œë¦¬ê³ )
app.post('/api/sms/send', async (c) => {
  try {
    const { userId, receivers, message, subject } = await c.req.json()
    
    // í•„ìˆ˜ íŒŒë¼ë¯¸í„° ì²´í¬
    if (!receivers || receivers.length === 0) {
      return c.json({ success: false, error: 'ìˆ˜ì‹ ì ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    if (!message) {
      return c.json({ success: false, error: 'ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”' }, 400)
    }
    
    // ì•Œë¦¬ê³  API ì„¤ì •
    const ALIGO_API_KEY = '4bbi3l27pb5qh11tkujl578bttz6vb5j'
    const ALIGO_USER_ID = 'wangholy'
    const SENDER_PHONE = '010-8739-9697'
    
    // ìˆ˜ì‹ ì ë²ˆí˜¸ í¬ë§·íŒ… (í•˜ì´í”ˆ ì œê±°)
    const formattedReceivers = receivers.map((phone: string) => phone.replace(/-/g, ''))
    
    // ì•Œë¦¬ê³  API í˜¸ì¶œ
    const aligoUrl = 'https://apis.aligo.in/send/'
    const formData = new URLSearchParams()
    formData.append('key', ALIGO_API_KEY)
    formData.append('user_id', ALIGO_USER_ID)
    formData.append('sender', SENDER_PHONE.replace(/-/g, ''))
    formData.append('receiver', formattedReceivers.join(','))
    formData.append('msg', message)
    
    if (subject) {
      formData.append('title', subject) // LMS/MMSì˜ ê²½ìš° ì œëª©
    }
    
    // ë©”ì‹œì§€ íƒ€ì… ìë™ ê²°ì • (90ì ì´í•˜: SMS, ì´ìƒ: LMS)
    const msgType = message.length <= 90 ? 'SMS' : 'LMS'
    formData.append('msg_type', msgType)
    
    console.log('ì•Œë¦¬ê³  SMS ë°œì†¡ ì‹œë„:', {
      receivers: formattedReceivers,
      messageLength: message.length,
      msgType: msgType
    })
    
    const response = await fetch(aligoUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData.toString()
    })
    
    const result = await response.json()
    
    console.log('ì•Œë¦¬ê³  API ì‘ë‹µ:', result)
    
    // ê²°ê³¼ í™•ì¸
    if (result.result_code === '1') {
      // ë°œì†¡ ì„±ê³µ - DBì— ê¸°ë¡
      const { env } = c
      
      for (const receiver of formattedReceivers) {
        try {
          await env.DB.prepare(`
            INSERT INTO sms_history (
              recipient_phone, message_content, status, sent_at, 
              result_code, result_message, cost, created_by, created_at
            )
            VALUES (?, ?, ?, datetime('now'), ?, ?, ?, ?, datetime('now'))
          `).bind(
            receiver,
            message,
            'sent',
            result.result_code,
            result.message || 'ë°œì†¡ ì„±ê³µ',
            20, // SMS 1ê±´ë‹¹ 20ì› (ì˜ˆìƒ ë¹„ìš©)
            userId || null
          ).run()
        } catch (dbError) {
          console.error('SMS ë¡œê·¸ ì €ì¥ ì˜¤ë¥˜:', dbError)
        }
      }
      
      return c.json({
        success: true,
        message: 'ë¬¸ì ë°œì†¡ ì„±ê³µ',
        data: {
          sentCount: result.success_cnt || formattedReceivers.length,
          failCount: result.error_cnt || 0,
          msgType: msgType,
          details: result
        }
      })
    } else {
      // ë°œì†¡ ì‹¤íŒ¨
      const { env } = c
      
      for (const receiver of formattedReceivers) {
        try {
          await env.DB.prepare(`
            INSERT INTO sms_logs (user_id, receiver, message, subject, status, result_code, result_message, created_at)
            VALUES (?, ?, ?, ?, ?, ?, ?, datetime('now'))
          `).bind(
            userId || null,
            receiver,
            message,
            subject || '',
            'failed',
            result.result_code || '-1',
            result.message || 'ë°œì†¡ ì‹¤íŒ¨'
          ).run()
        } catch (dbError) {
          console.error('SMS ë¡œê·¸ ì €ì¥ ì˜¤ë¥˜:', dbError)
        }
      }
      
      return c.json({
        success: false,
        error: 'ë¬¸ì ë°œì†¡ ì‹¤íŒ¨',
        message: result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜',
        resultCode: result.result_code
      }, 400)
    }
    
  } catch (err) {
    console.error('SMS ë°œì†¡ ì˜¤ë¥˜:', err)
    return c.json({ 
      success: false, 
      error: 'ë¬¸ì ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
      details: error instanceof Error ? error.message : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'
    }, 500)
  }
})

// SMS ë°œì†¡ ë‚´ì—­ ì¡°íšŒ API
app.get('/api/sms/logs', async (c) => {
  try {
    const userId = c.req.query('userId')
    const { env } = c
    
    let query = 'SELECT * FROM sms_history'
    let params: any[] = []
    
    if (userId) {
      query += ' WHERE created_by = ?'
      params.push(userId)
    }
    
    query += ' ORDER BY created_at DESC LIMIT 100'
    
    const { results } = await env.DB.prepare(query).bind(...params).all()
    
    return c.json({
      success: true,
      logs: results || []
    })
  } catch (err) {
    console.error('SMS ë¡œê·¸ ì¡°íšŒ ì˜¤ë¥˜:', err)
    return c.json({ success: false, error: 'SMS ë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨' }, 500)
  }
})

// íšŒì›ê°€ì… API
// ============================================
// ë§ˆì¼€íŒ… íˆ´ 10ê°œ
// ============================================

// 1. ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í‚¤ì›Œë“œ ë¶„ì„ê¸°
app.get('/tools/place-keyword-analyzer', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í‚¤ì›Œë“œ ë¶„ì„ê¸° - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-12">
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-search text-purple-600 mr-3"></i>
                    ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í‚¤ì›Œë“œ ë¶„ì„ê¸°
                </h1>
                <p class="text-xl text-gray-600">ì§€ì—­ë³„ ê²€ìƒ‰ëŸ‰ê³¼ ê²½ìŸë„ë¥¼ ë¶„ì„í•˜ì—¬ ìµœì ì˜ í‚¤ì›Œë“œë¥¼ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤</p>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sticky top-24">
                        <h2 class="text-xl font-bold text-gray-900 mb-6">í‚¤ì›Œë“œ ì…ë ¥</h2>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì§€ì—­</label>
                                <input type="text" id="region" placeholder="ì˜ˆ: ì¸ì²œ ì„œêµ¬" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-900 mb-2">ì—…ì¢…</label>
                                <input type="text" id="keyword" placeholder="ì˜ˆ: ì˜ì–´í•™ì›" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                            </div>

                            <button onclick="analyzeKeyword()" 
                                    class="w-full gradient-purple text-white py-4 rounded-xl font-bold hover:shadow-lg transition">
                                <i class="fas fa-chart-line mr-2"></i>ë¶„ì„ ì‹œì‘
                            </button>
                        </div>

                        <div class="mt-6 p-4 bg-blue-50 rounded-xl text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            ì‹¤ì‹œê°„ ê²€ìƒ‰ëŸ‰ê³¼ ê²½ìŸ ì—…ì²´ ìˆ˜ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                        <h2 class="text-2xl font-bold text-gray-900 mb-6">ë¶„ì„ ê²°ê³¼</h2>
                        
                        <div id="result" class="hidden">
                            <div class="grid md:grid-cols-3 gap-4 mb-8">
                                <div class="bg-purple-50 rounded-xl p-6 text-center">
                                    <div class="text-3xl font-bold text-purple-600 mb-2" id="searchVolume">-</div>
                                    <div class="text-sm text-gray-600">ì›” í‰ê·  ê²€ìƒ‰ëŸ‰</div>
                                </div>
                                <div class="bg-orange-50 rounded-xl p-6 text-center">
                                    <div class="text-3xl font-bold text-orange-600 mb-2" id="competition">-</div>
                                    <div class="text-sm text-gray-600">ê²½ìŸ ì—…ì²´ ìˆ˜</div>
                                </div>
                                <div class="bg-green-50 rounded-xl p-6 text-center">
                                    <div class="text-3xl font-bold text-green-600 mb-2" id="difficulty">-</div>
                                    <div class="text-sm text-gray-600">ë‚œì´ë„</div>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <h3 class="text-xl font-bold text-gray-900">ì¶”ì²œ í‚¤ì›Œë“œ</h3>
                                <div id="recommendations" class="space-y-3"></div>
                            </div>

                            <div class="mt-8 p-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl">
                                <h4 class="font-bold text-gray-900 mb-3">ğŸ’¡ ìµœì í™” íŒ</h4>
                                <ul class="space-y-2 text-sm text-gray-700">
                                    <li>âœ“ ì§€ì—­ëª… + ì—…ì¢…ì„ í•¨ê»˜ ì‚¬ìš©í•˜ì„¸ìš”</li>
                                    <li>âœ“ ê²½ìŸì´ ë‚®ì€ ë¡±í…Œì¼ í‚¤ì›Œë“œë¥¼ í™œìš©í•˜ì„¸ìš”</li>
                                    <li>âœ“ ì •ê¸°ì ìœ¼ë¡œ í‚¤ì›Œë“œ ìˆœìœ„ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”</li>
                                </ul>
                            </div>
                        </div>

                        <div id="empty" class="text-center py-20">
                            <div class="text-6xl mb-4">ğŸ”</div>
                            <p class="text-gray-500 text-lg">í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ê³  ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function analyzeKeyword() {
                const region = document.getElementById('region').value;
                const keyword = document.getElementById('keyword').value;

                if (!region || !keyword) {
                    alert('ì§€ì—­ê³¼ ì—…ì¢…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }

                // ì‹œë®¬ë ˆì´ì…˜ ë°ì´í„°
                const searchVolume = Math.floor(Math.random() * 5000) + 1000;
                const competition = Math.floor(Math.random() * 100) + 20;
                const difficulty = competition > 70 ? 'ë†’ìŒ' : competition > 40 ? 'ë³´í†µ' : 'ë‚®ìŒ';

                document.getElementById('searchVolume').textContent = searchVolume.toLocaleString();
                document.getElementById('competition').textContent = competition + 'ê°œ';
                document.getElementById('difficulty').textContent = difficulty;

                const recommendations = [
                    { keyword: region + ' ' + keyword, score: 95 },
                    { keyword: region + ' ' + keyword + ' ì¶”ì²œ', score: 88 },
                    { keyword: region + ' ì´ˆë“± ' + keyword, score: 82 },
                    { keyword: region + ' ì¤‘ë“± ' + keyword, score: 78 },
                    { keyword: 'ê²€ë‹¨ ' + keyword, score: 75 }
                ];

                const recommendationsHTML = recommendations.map(item => \`
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition">
                        <div>
                            <div class="font-medium text-gray-900">\${item.keyword}</div>
                            <div class="text-sm text-gray-500">ì¶”ì²œë„: \${item.score}ì </div>
                        </div>
                        <div class="text-purple-600 font-bold">\${item.score}</div>
                    </div>
                \`).join('');

                document.getElementById('recommendations').innerHTML = recommendationsHTML;
                document.getElementById('empty').classList.add('hidden');
                document.getElementById('result').classList.remove('hidden');
            }
        </script>
    </body>
    </html>
  `)
})

// 2. ë¸”ë¡œê·¸ ì œëª© ìƒì„±ê¸°
app.get('/tools/blog-title-generator', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¸”ë¡œê·¸ ì œëª© ìƒì„±ê¸° - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-lightbulb text-purple-600 mr-3"></i>
                    ë¸”ë¡œê·¸ ì œëª© ìƒì„±ê¸°
                </h1>
                <p class="text-xl text-gray-600">í´ë¦­ë¥ ì„ ë†’ì´ëŠ” ë§¤ë ¥ì ì¸ ë¸”ë¡œê·¸ ì œëª©ì„ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤</p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-900 mb-3">ì£¼ì œ ì…ë ¥</label>
                    <input type="text" id="topic" placeholder="ì˜ˆ: ì´ˆë“±ì˜ì–´ í•™ìŠµë²•" 
                           class="w-full px-6 py-4 text-lg border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                </div>

                <div class="mb-8 grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">í†¤ì•¤ë§¤ë„ˆ</label>
                        <select id="tone" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                            <option value="professional">ì „ë¬¸ì ì¸</option>
                            <option value="friendly">ì¹œê·¼í•œ</option>
                            <option value="exciting">í¥ë¯¸ë¡œìš´</option>
                            <option value="urgent">ê¸´ê¸‰í•œ</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">íƒ€ê²Ÿ</label>
                        <select id="target" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                            <option value="parents">í•™ë¶€ëª¨</option>
                            <option value="students">í•™ìƒ</option>
                            <option value="teachers">ì„ ìƒë‹˜</option>
                            <option value="general">ì¼ë°˜</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">ê°œìˆ˜</label>
                        <select id="count" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                            <option value="5">5ê°œ</option>
                            <option value="10" selected>10ê°œ</option>
                            <option value="15">15ê°œ</option>
                            <option value="20">20ê°œ</option>
                        </select>
                    </div>
                </div>

                <button onclick="generateTitles()" 
                        class="w-full gradient-purple text-white py-4 rounded-xl text-lg font-bold hover:shadow-lg transition">
                    <i class="fas fa-magic mr-2"></i>ì œëª© ìƒì„±í•˜ê¸°
                </button>

                <div id="results" class="mt-8 hidden">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">ìƒì„±ëœ ì œëª©</h3>
                    <div id="titleList" class="space-y-3"></div>
                </div>
            </div>

            <div class="mt-8 bg-gradient-to-r from-purple-50 to-blue-50 rounded-2xl p-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4">ğŸ’¡ ì¢‹ì€ ë¸”ë¡œê·¸ ì œëª©ì˜ ì¡°ê±´</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-bold text-purple-600 mb-2">âœ“ í¬í•¨í•´ì•¼ í•  ìš”ì†Œ</h4>
                        <ul class="space-y-1 text-sm text-gray-700">
                            <li>â€¢ êµ¬ì²´ì ì¸ ìˆ«ìë‚˜ ìˆ˜ì¹˜</li>
                            <li>â€¢ íƒ€ê²Ÿ ë…ìì¸µ ëª…ì‹œ</li>
                            <li>â€¢ ëª…í™•í•œ í˜œíƒ ì œì‹œ</li>
                            <li>â€¢ ê¶ê¸ˆì¦ì„ ìœ ë°œí•˜ëŠ” ë¬¸êµ¬</li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-bold text-orange-600 mb-2">âœ— í”¼í•´ì•¼ í•  ìš”ì†Œ</h4>
                        <ul class="space-y-1 text-sm text-gray-700">
                            <li>â€¢ ê³¼ì¥ëœ í‘œí˜„ ë‚¨ë°œ</li>
                            <li>â€¢ ë„ˆë¬´ ê¸´ ì œëª© (50ì ì´ìƒ)</li>
                            <li>â€¢ ëª¨í˜¸í•˜ê³  ì¶”ìƒì ì¸ ë‹¨ì–´</li>
                            <li>â€¢ í´ë¦­ë² ì´íŠ¸ì„± ì œëª©</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function generateTitles() {
                const topic = document.getElementById('topic').value;
                const count = parseInt(document.getElementById('count').value);

                if (!topic) {
                    alert('ì£¼ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }

                const templates = [
                    \`\${topic}, ì´ë ‡ê²Œ í•˜ë©´ ì„±ê³µí•©ë‹ˆë‹¤\`,
                    \`\${topic} ì™„ë²½ ê°€ì´ë“œ (2025ë…„ ìµœì‹ )\`,
                    \`\${topic} ì²˜ìŒ ì‹œì‘í•˜ëŠ” ë¶„ë“¤ì„ ìœ„í•œ 5ë‹¨ê³„\`,
                    \`ì „ë¬¸ê°€ê°€ ì•Œë ¤ì£¼ëŠ” \${topic} í•µì‹¬ ì „ëµ\`,
                    \`\${topic} ì‹¤ìˆ˜í•˜ì§€ ì•ŠëŠ” ë°©ë²• 7ê°€ì§€\`,
                    \`\${topic}ë¡œ ì„±ê³¼ 200% ë†’ì´ëŠ” ë²•\`,
                    \`í•™ë¶€ëª¨ê°€ ê¼­ ì•Œì•„ì•¼ í•  \${topic} ì •ë³´\`,
                    \`\${topic} íš¨ê³¼ ê·¹ëŒ€í™”í•˜ëŠ” ê¿€íŒ\`,
                    \`\${topic} ì „ì— ë°˜ë“œì‹œ ì•Œì•„ì•¼ í•  ê²ƒë“¤\`,
                    \`\${topic} ì„±ê³µ ì‚¬ë¡€ì™€ ë…¸í•˜ìš° ëŒ€ê³µê°œ\`,
                    \`ì™œ \${topic}ì´ ì¤‘ìš”í•œê°€? (ì‹¤ì „ ê²½í—˜ë‹´)\`,
                    \`\${topic} ë¹„ìš©ë¶€í„° íš¨ê³¼ê¹Œì§€ ì™„ë²½ ë¶„ì„\`,
                    \`\${topic} ê³ ë¯¼ í•´ê²°! ì „ë¬¸ê°€ Q&A\`,
                    \`\${topic} 1ë“±ì˜ ë¹„ë°€, ì´ê²ƒ ë•Œë¬¸ì´ì—ˆì–´ìš”\`,
                    \`\${topic} ì‹œì‘ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸ 10ê°€ì§€\`,
                    \`\${topic}ì˜ ëª¨ë“  ê²ƒ A to Z\`,
                    \`\${topic} ì‹¤ì „ ì ìš© í›„ê¸° (ì†”ì§ ë¦¬ë·°)\`,
                    \`\${topic}, ì´ ë°©ë²•ìœ¼ë¡œ ë°”ë¡œ ì‹œì‘í•˜ì„¸ìš”\`,
                    \`\${topic} ì „ë¬¸ê°€ê°€ ì¶”ì²œí•˜ëŠ” ìµœê³ ì˜ ë°©ë²•\`,
                    \`\${topic} ì„±ê³µë¥  ë†’ì´ëŠ” 3ê°€ì§€ ì›ì¹™\`
                ];

                const selectedTitles = templates.sort(() => 0.5 - Math.random()).slice(0, count);

                const titlesHTML = selectedTitles.map((title, index) => \`
                    <div class="flex items-start gap-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition group">
                        <div class="flex-shrink-0 w-8 h-8 gradient-purple rounded-lg flex items-center justify-center text-white font-bold text-sm">
                            \${index + 1}
                        </div>
                        <div class="flex-1">
                            <div class="text-gray-900 font-medium">\${title}</div>
                            <div class="text-xs text-gray-500 mt-1">\${title.length}ì</div>
                        </div>
                        <button onclick="copyTitle('\${title.replace(/'/g, "\\\\'")}', this)" 
                                class="flex-shrink-0 px-4 py-2 text-sm text-purple-600 hover:text-purple-700 hover:bg-purple-50 rounded-lg transition opacity-0 group-hover:opacity-100">
                            <i class="fas fa-copy mr-1"></i>ë³µì‚¬
                        </button>
                    </div>
                \`).join('');

                document.getElementById('titleList').innerHTML = titlesHTML;
                document.getElementById('results').classList.remove('hidden');
            }

            function copyTitle(title, button) {
                navigator.clipboard.writeText(title).then(() => {
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check mr-1"></i>ë³µì‚¬ë¨';
                    button.classList.add('text-green-600');
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('text-green-600');
                    }, 2000);
                });
            }
        </script>
    </body>
    </html>
  `)
})

// 3. ìƒë‹´ ì˜ˆì•½ ìº˜ë¦°ë”
app.get('/tools/consultation-calendar', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ìƒë‹´ ì˜ˆì•½ ìº˜ë¦°ë” - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
            .calendar-day { min-height: 100px; }
            .time-slot { cursor: pointer; transition: all 0.2s; }
            .time-slot:hover { transform: scale(1.05); }
            .time-slot.selected { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); color: white; }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-12">
            <div class="mb-8">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-calendar-check text-purple-600 mr-3"></i>
                    ìƒë‹´ ì˜ˆì•½ ìº˜ë¦°ë”
                </h1>
                <p class="text-xl text-gray-600">ì›í•˜ì‹œëŠ” ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì—¬ ë¬´ë£Œ ìƒë‹´ì„ ì˜ˆì•½í•˜ì„¸ìš”</p>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-900">2025ë…„ 1ì›”</h2>
                            <div class="flex gap-2">
                                <button class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-7 gap-2 mb-4">
                            <div class="text-center text-sm font-medium text-red-500 py-2">ì¼</div>
                            <div class="text-center text-sm font-medium text-gray-600 py-2">ì›”</div>
                            <div class="text-center text-sm font-medium text-gray-600 py-2">í™”</div>
                            <div class="text-center text-sm font-medium text-gray-600 py-2">ìˆ˜</div>
                            <div class="text-center text-sm font-medium text-gray-600 py-2">ëª©</div>
                            <div class="text-center text-sm font-medium text-gray-600 py-2">ê¸ˆ</div>
                            <div class="text-center text-sm font-medium text-blue-500 py-2">í† </div>
                        </div>

                        <div class="grid grid-cols-7 gap-2" id="calendar"></div>

                        <div class="mt-8">
                            <h3 class="text-lg font-bold text-gray-900 mb-4">ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„</h3>
                            <div id="timeSlots" class="grid grid-cols-4 gap-3"></div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 sticky top-24">
                        <h2 class="text-xl font-bold text-gray-900 mb-6">ì˜ˆì•½ ì •ë³´</h2>
                        
                        <div class="space-y-4 mb-6">
                            <div class="p-4 bg-purple-50 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">ì„ íƒí•œ ë‚ ì§œ</div>
                                <div class="font-bold text-gray-900" id="selectedDate">ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                            </div>

                            <div class="p-4 bg-purple-50 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">ì„ íƒí•œ ì‹œê°„</div>
                                <div class="font-bold text-gray-900" id="selectedTime">ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”</div>
                            </div>
                        </div>

                        <div class="space-y-3 mb-6">
                            <input type="text" id="name" placeholder="ì´ë¦„" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                            <input type="tel" id="phone" placeholder="ì—°ë½ì²˜" 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                            <textarea id="message" placeholder="ë¬¸ì˜ ë‚´ìš©" rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 outline-none resize-none"></textarea>
                        </div>

                        <button onclick="submitReservation()" 
                                class="w-full gradient-purple text-white py-4 rounded-xl font-bold hover:shadow-lg transition">
                            <i class="fas fa-check mr-2"></i>ì˜ˆì•½í•˜ê¸°
                        </button>

                        <div class="mt-6 p-4 bg-blue-50 rounded-xl text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            ìƒë‹´ì€ ì•½ 30ë¶„ ì†Œìš”ë©ë‹ˆë‹¤
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let selectedDate = null;
            let selectedTimeSlot = null;

            function generateCalendar() {
                const calendar = document.getElementById('calendar');
                const today = new Date();
                const daysInMonth = 31;
                const startDay = 3; // 1ì›” 1ì¼ì´ ìˆ˜ìš”ì¼

                let html = '';
                for (let i = 0; i < startDay; i++) {
                    html += '<div></div>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const isPast = day < today.getDate();
                    const isToday = day === today.getDate();
                    
                    html += \`
                        <div onclick="selectDate(\${day})" 
                             class="calendar-day border border-gray-200 rounded-lg p-2 text-center cursor-pointer hover:border-purple-400 transition \${isPast ? 'bg-gray-100 cursor-not-allowed' : ''} \${isToday ? 'border-purple-600 bg-purple-50' : ''}">
                            <div class="font-medium \${isPast ? 'text-gray-400' : 'text-gray-900'}">\${day}</div>
                            \${!isPast ? '<div class="text-xs text-green-600 mt-1">ì˜ˆì•½ê°€ëŠ¥</div>' : ''}
                        </div>
                    \`;
                }

                calendar.innerHTML = html;
            }

            function selectDate(day) {
                const today = new Date();
                if (day < today.getDate()) return;

                selectedDate = \`2025ë…„ 1ì›” \${day}ì¼\`;
                document.getElementById('selectedDate').textContent = selectedDate;

                const timeSlots = document.getElementById('timeSlots');
                const times = ['10:00', '11:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
                
                timeSlots.innerHTML = times.map(time => \`
                    <button onclick="selectTime('\${time}')" 
                            class="time-slot px-4 py-3 border-2 border-gray-200 rounded-lg text-sm font-medium hover:border-purple-400 transition">
                        \${time}
                    </button>
                \`).join('');
            }

            function selectTime(time) {
                selectedTimeSlot = time;
                document.getElementById('selectedTime').textContent = time;

                document.querySelectorAll('.time-slot').forEach(slot => {
                    slot.classList.remove('selected');
                });
                event.target.classList.add('selected');
            }

            function submitReservation() {
                const name = document.getElementById('name').value;
                const phone = document.getElementById('phone').value;

                if (!selectedDate || !selectedTimeSlot) {
                    alert('ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                    return;
                }

                if (!name || !phone) {
                    alert('ì´ë¦„ê³¼ ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }

                alert(\`ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\në‚ ì§œ: \${selectedDate}\\nì‹œê°„: \${selectedTimeSlot}\\nì´ë¦„: \${name}\`);
            }

            generateCalendar();
        </script>
    </body>
    </html>
  `)
})

// 4. í•™ì› í™ë³´ ë¬¸êµ¬ ìƒì„±ê¸°
app.get('/tools/promo-generator', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í•™ì› í™ë³´ ë¬¸êµ¬ ìƒì„±ê¸° - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                <i class="fas fa-bullhorn text-purple-600 mr-3"></i>í•™ì› í™ë³´ ë¬¸êµ¬ ìƒì„±ê¸°
            </h1>
            <p class="text-xl text-gray-600 mb-8">í•™ìƒ ëª¨ì§‘ì— íš¨ê³¼ì ì¸ í™ë³´ ë¬¸êµ¬ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤</p>

            <div class="bg-white rounded-2xl shadow-sm border p-8 mb-8">
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">í•™ì› ìœ í˜•</label>
                        <select id="type" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                            <option>ì˜ì–´í•™ì›</option>
                            <option>ìˆ˜í•™í•™ì›</option>
                            <option>ê³¼í•™í•™ì›</option>
                            <option>ë…¼ìˆ í•™ì›</option>
                            <option>ì…ì‹œí•™ì›</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">íƒ€ê²Ÿ í•™ë…„</label>
                        <select id="grade" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                            <option>ì´ˆë“±</option>
                            <option>ì¤‘ë“±</option>
                            <option>ê³ ë“±</option>
                            <option>ì „í•™ë…„</option>
                        </select>
                    </div>
                </div>
                <button onclick="generate()" class="w-full gradient-purple text-white py-4 rounded-xl font-bold">
                    <i class="fas fa-magic mr-2"></i>ë¬¸êµ¬ ìƒì„±í•˜ê¸°
                </button>
            </div>

            <div id="results" class="hidden space-y-4"></div>
        </div>

        <script>
            function generate() {
                const type = document.getElementById('type').value;
                const grade = document.getElementById('grade').value;
                const templates = [
                    \`\${grade} \${type} 1ë“±ì˜ ë¹„ê²°, ì§€ê¸ˆ ë°”ë¡œ í™•ì¸í•˜ì„¸ìš”!\`,
                    \`\${grade}ìƒ ì„±ì  í–¥ìƒ í”„ë¡œê·¸ë¨ ë¬´ë£Œ ì²´í—˜ ì´ë²¤íŠ¸\`,
                    \`ì†Œìˆ˜ ì •ì˜ˆ \${grade} \${type} - 1:1 ë§ì¶¤ ê´€ë¦¬\`,
                    \`\${grade} ë‚´ì‹ Â·ìˆ˜ëŠ¥ ì™„ë²½ ëŒ€ë¹„ \${type}\`,
                    \`í•©ê²©ë¥  98%! \${grade} ì „ë¬¸ \${type}\`,
                    \`\${grade} \${type} ê²¨ìš¸ë°©í•™ íŠ¹ê°• ëª¨ì§‘ ì¤‘\`,
                    \`\${grade}ìƒ í•™ë¶€ëª¨ë‹˜, ì„±ì  ê±±ì • ë! ê²€ì¦ëœ ì»¤ë¦¬í˜ëŸ¼\`,
                    \`\${grade} \${type} ì‹ ê·œ ì˜¤í”ˆ ì´ë²¤íŠ¸ - ì²«ë‹¬ 50% í• ì¸\`,
                    \`\${grade}ìƒ ì „ë¬¸ ê°•ì‚¬ì§„ì˜ 1:1 ì¼€ì–´ ì‹œìŠ¤í…œ\`,
                    \`\${grade} \${type} ì„±ì  ë³´ì¥ë°˜ ìš´ì˜ ì¤‘\`
                ];

                const html = templates.map((text, i) => \`
                    <div class="bg-white rounded-xl p-6 shadow-sm border">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="text-sm text-purple-600 font-medium mb-2">í™ë³´ ë¬¸êµ¬ \${i+1}</div>
                                <div class="text-lg font-medium text-gray-900">\${text}</div>
                            </div>
                            <button onclick="copy('\${text.replace(/'/g, "\\\\'")}', this)" 
                                    class="px-4 py-2 text-sm text-purple-600 hover:bg-purple-50 rounded-lg">
                                <i class="fas fa-copy"></i> ë³µì‚¬
                            </button>
                        </div>
                    </div>
                \`).join('');

                document.getElementById('results').innerHTML = html;
                document.getElementById('results').classList.remove('hidden');
            }

            function copy(text, btn) {
                navigator.clipboard.writeText(text);
                btn.innerHTML = '<i class="fas fa-check"></i> ë³µì‚¬ë¨';
                setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i> ë³µì‚¬', 2000);
            }
        </script>
    </body>
    </html>
  `)
})

// 5. ë¦¬ë·° ë‹µë³€ í…œí”Œë¦¿
app.get('/tools/review-template', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¦¬ë·° ë‹µë³€ í…œí”Œë¦¿ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                <i class="fas fa-comment-dots text-purple-600 mr-3"></i>ë¦¬ë·° ë‹µë³€ í…œí”Œë¦¿
            </h1>
            <p class="text-xl text-gray-600 mb-8">ê¸ì •/ë¶€ì • ë¦¬ë·°ì— ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•œ ì „ë¬¸ì ì¸ ë‹µë³€ í…œí”Œë¦¿</p>

            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl p-6 shadow-sm border">
                    <h2 class="text-xl font-bold text-green-600 mb-4">
                        <i class="fas fa-smile mr-2"></i>ê¸ì • ë¦¬ë·° ë‹µë³€
                    </h2>
                    <div class="space-y-4">
                        ${['ê°ì‚¬í•©ë‹ˆë‹¤! ì•ìœ¼ë¡œë„ ìµœì„ ì„ ë‹¤í•˜ê² ìŠµë‹ˆë‹¤.', 'ì†Œì¤‘í•œ í›„ê¸° ê°ì‚¬ë“œë¦½ë‹ˆë‹¤. ë”ìš± ë°œì „í•˜ëŠ” í•™ì›ì´ ë˜ê² ìŠµë‹ˆë‹¤.', 'ì•„ì´ë“¤ì˜ ì„±ì¥ì´ ì €í¬ì˜ ê°€ì¥ í° ë³´ëŒì…ë‹ˆë‹¤. í•­ìƒ ì‘ì›í•´ì£¼ì„¸ìš”!'].map((text, i) => `
                            <div class="p-4 bg-green-50 rounded-xl">
                                <div class="text-sm text-gray-600 mb-2">í…œí”Œë¦¿ ${i+1}</div>
                                <div class="text-gray-900">${text}</div>
                                <button onclick="copyText('${text}')" class="mt-2 text-sm text-green-600 hover:underline">
                                    <i class="fas fa-copy"></i> ë³µì‚¬
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-white rounded-2xl p-6 shadow-sm border">
                    <h2 class="text-xl font-bold text-orange-600 mb-4">
                        <i class="fas fa-frown mr-2"></i>ë¶€ì • ë¦¬ë·° ë‹µë³€
                    </h2>
                    <div class="space-y-4">
                        ${['ì†Œì¤‘í•œ ì˜ê²¬ ê°ì‚¬í•©ë‹ˆë‹¤. ë” ë‚˜ì€ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ë„ë¡ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤.', 'ë¶ˆí¸ì„ ë“œë ¤ ì£„ì†¡í•©ë‹ˆë‹¤. ë¹ ë¥´ê²Œ ê°œì„ í•˜ê² ìŠµë‹ˆë‹¤.', 'ì „í™” ì£¼ì‹œë©´ ìì„¸íˆ ìƒë‹´ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.'].map((text, i) => `
                            <div class="p-4 bg-orange-50 rounded-xl">
                                <div class="text-sm text-gray-600 mb-2">í…œí”Œë¦¿ ${i+1}</div>
                                <div class="text-gray-900">${text}</div>
                                <button onclick="copyText('${text}')" class="mt-2 text-sm text-orange-600 hover:underline">
                                    <i class="fas fa-copy"></i> ë³µì‚¬
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        </div>

        <script>
            function copyText(text) {
                navigator.clipboard.writeText(text);
                alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        </script>
    </body>
    </html>
  `)
})

// 6. í•™ë¶€ëª¨ ë¬¸ì ë©”ì‹œì§€ í…œí”Œë¦¿
app.get('/tools/parent-sms-template', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í•™ë¶€ëª¨ ë¬¸ì í…œí”Œë¦¿ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold mb-4">
                <i class="fas fa-sms text-purple-600 mr-3"></i>í•™ë¶€ëª¨ ë¬¸ì ë©”ì‹œì§€ í…œí”Œë¦¿
            </h1>
            <p class="text-xl text-gray-600 mb-8">ìƒí™©ë³„ë¡œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•œ í•™ë¶€ëª¨ ë¬¸ì í…œí”Œë¦¿</p>

            <div class="grid md:grid-cols-3 gap-6">
                ${[
                    {title: 'ì„±ì  í–¥ìƒ ì•ˆë‚´', icon: 'chart-line', color: 'green', messages: [
                        'ì•ˆë…•í•˜ì„¸ìš”. ì´ë²ˆ ì‹œí—˜ì—ì„œ ìˆ˜í•™ ì„±ì ì´ ë§ì´ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤! ì•ìœ¼ë¡œë„ ì‘ì› ë¶€íƒë“œë¦½ë‹ˆë‹¤.',
                        'í•™ìƒì˜ ê¾¸ì¤€í•œ ë…¸ë ¥ìœ¼ë¡œ ì„±ì ì´ ì˜¬ëìŠµë‹ˆë‹¤. ì¶•í•˜ë“œë¦½ë‹ˆë‹¤!',
                        'ì´ë²ˆ ë‹¬ í•™ìŠµ ì§„ë„ê°€ ìš°ìˆ˜í•©ë‹ˆë‹¤. ê³„ì† ì‘ì›í•´ì£¼ì„¸ìš”.'
                    ]},
                    {title: 'ê²°ì„ í™•ì¸', icon: 'calendar-times', color: 'orange', messages: [
                        'ì•ˆë…•í•˜ì„¸ìš”. ì˜¤ëŠ˜ ìˆ˜ì—…ì— ë¶ˆì°¸í•˜ì…¨ëŠ”ë° ê´œì°®ìœ¼ì‹ ê°€ìš”?',
                        'ê²°ì„ ì‚¬ìœ  í™•ì¸ ë¶€íƒë“œë¦½ë‹ˆë‹¤. ë³´ê°• ìˆ˜ì—… ì•ˆë‚´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
                        'ìˆ˜ì—… ë¶ˆì°¸ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ê±´ê°• ìƒíƒœ ê´œì°®ìœ¼ì‹ ì§€ìš”?'
                    ]},
                    {title: 'ì´ë²¤íŠ¸ ì•ˆë‚´', icon: 'gift', color: 'purple', messages: [
                        '[ì´ë²¤íŠ¸] ì¹œêµ¬ ì¶”ì²œ ì‹œ ìƒí’ˆê¶Œ ì¦ì •! ìì„¸í•œ ë‚´ìš©ì€ í•™ì›ìœ¼ë¡œ ë¬¸ì˜ì£¼ì„¸ìš”.',
                        'ê²¨ìš¸ë°©í•™ íŠ¹ê°• ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤. ì¡°ê¸° ë“±ë¡ ì‹œ í• ì¸ í˜œíƒ!',
                        'í•™ë¶€ëª¨ ìƒë‹´ ì£¼ê°„ ìš´ì˜ ì¤‘ì…ë‹ˆë‹¤. ì˜ˆì•½ ë¶€íƒë“œë¦½ë‹ˆë‹¤.'
                    ]}
                ].map(category => `
                    <div class="bg-white rounded-2xl p-6 shadow-sm border">
                        <h2 class="text-lg font-bold text-${category.color}-600 mb-4">
                            <i class="fas fa-${category.icon} mr-2"></i>${category.title}
                        </h2>
                        <div class="space-y-3">
                            ${category.messages.map((msg, i) => `
                                <div class="p-3 bg-gray-50 rounded-lg text-sm">
                                    <div class="text-gray-900 mb-2">${msg}</div>
                                    <button onclick="copy('${msg.replace(/'/g, "\\\\'")}', this)" 
                                            class="text-xs text-purple-600 hover:underline">
                                        ë³µì‚¬í•˜ê¸°
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>

        <script>
            function copy(text, btn) {
                navigator.clipboard.writeText(text);
                btn.textContent = 'ë³µì‚¬ë¨!';
                setTimeout(() => btn.textContent = 'ë³µì‚¬í•˜ê¸°', 2000);
            }
        </script>
    </body>
    </html>
  `)
})

// 7. í•™ì› í¬ìŠ¤í„° ë¬¸êµ¬ ìƒì„±ê¸°
app.get('/tools/poster-generator', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í•™ì› í¬ìŠ¤í„° ë¬¸êµ¬ ìƒì„±ê¸° - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
            .poster-preview { aspect-ratio: 3/4; }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-6xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold mb-4">
                <i class="fas fa-image text-purple-600 mr-3"></i>í•™ì› í¬ìŠ¤í„° ë¬¸êµ¬ ìƒì„±ê¸°
            </h1>
            <p class="text-xl text-gray-600 mb-8">ëˆˆì— ë„ëŠ” í•™ì› í™ë³´ í¬ìŠ¤í„° ë¬¸êµ¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤</p>

            <div class="grid lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-2xl p-8 shadow-sm">
                    <h2 class="text-xl font-bold mb-6">í¬ìŠ¤í„° ì„¤ì •</h2>
                    <div class="space-y-4 mb-6">
                        <input type="text" id="title" placeholder="ë©”ì¸ ë¬¸êµ¬ (ì˜ˆ: ê²¨ìš¸ë°©í•™ íŠ¹ê°•)" 
                               class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="text" id="subtitle" placeholder="ë¶€ì œëª© (ì˜ˆ: ì„±ì  í–¥ìƒ ë³´ì¥)" 
                               class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                        <input type="text" id="discount" placeholder="í• ì¸ìœ¨ (ì˜ˆ: 30% í• ì¸)" 
                               class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none">
                    </div>
                    <button onclick="generatePoster()" class="w-full gradient-purple text-white py-4 rounded-xl font-bold">
                        í¬ìŠ¤í„° ë¯¸ë¦¬ë³´ê¸°
                    </button>
                </div>

                <div class="bg-white rounded-2xl p-8 shadow-sm">
                    <h2 class="text-xl font-bold mb-6">ë¯¸ë¦¬ë³´ê¸°</h2>
                    <div id="preview" class="poster-preview bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl p-8 flex flex-col justify-center items-center text-white">
                        <div class="text-center">
                            <div id="previewTitle" class="text-4xl font-bold mb-4">ê²¨ìš¸ë°©í•™ íŠ¹ê°•</div>
                            <div id="previewSubtitle" class="text-2xl mb-4">ì„±ì  í–¥ìƒ ë³´ì¥</div>
                            <div id="previewDiscount" class="text-5xl font-bold mb-4">30% í• ì¸</div>
                            <div class="text-lg">ìŠˆí¼í”Œë ˆì´ìŠ¤ í•™ì›</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function generatePoster() {
                const title = document.getElementById('title').value || 'ê²¨ìš¸ë°©í•™ íŠ¹ê°•';
                const subtitle = document.getElementById('subtitle').value || 'ì„±ì  í–¥ìƒ ë³´ì¥';
                const discount = document.getElementById('discount').value || '30% í• ì¸';

                document.getElementById('previewTitle').textContent = title;
                document.getElementById('previewSubtitle').textContent = subtitle;
                document.getElementById('previewDiscount').textContent = discount;
            }
        </script>
    </body>
    </html>
  `)
})

// 8. ê²½ìŸì‚¬ ë¶„ì„ ë„êµ¬
app.get('/tools/competitor-analysis', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê²½ìŸì‚¬ ë¶„ì„ ë„êµ¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold mb-4">
                <i class="fas fa-chart-bar text-purple-600 mr-3"></i>ê²½ìŸì‚¬ ë¶„ì„ ë„êµ¬
            </h1>
            <p class="text-xl text-gray-600 mb-8">ì£¼ë³€ í•™ì› ì •ë³´ë¥¼ ë¶„ì„í•˜ì—¬ ì°¨ë³„í™” ì „ëµì„ ìˆ˜ë¦½í•˜ì„¸ìš”</p>

            <div class="grid lg:grid-cols-3 gap-6">
                <div class="bg-white rounded-2xl p-6 shadow-sm">
                    <h2 class="text-lg font-bold mb-4">
                        <i class="fas fa-map-marker-alt text-purple-600 mr-2"></i>ì§€ì—­ ê²€ìƒ‰
                    </h2>
                    <input type="text" id="location" placeholder="ì˜ˆ: ì¸ì²œ ì„œêµ¬" 
                           class="w-full px-4 py-3 border rounded-xl mb-4 focus:ring-2 focus:ring-purple-500 outline-none">
                    <button onclick="analyze()" class="w-full gradient-purple text-white py-3 rounded-xl font-bold">
                        ë¶„ì„ ì‹œì‘
                    </button>
                </div>

                <div class="lg:col-span-2 bg-white rounded-2xl p-6 shadow-sm">
                    <h2 class="text-lg font-bold mb-4">ë¶„ì„ ê²°ê³¼</h2>
                    <div id="results" class="space-y-4">
                        <div class="text-center py-12 text-gray-500">
                            ì§€ì—­ì„ ì…ë ¥í•˜ê³  ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function analyze() {
                const location = document.getElementById('location').value;
                if (!location) {
                    alert('ì§€ì—­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }

                const data = [
                    { name: 'A ì˜ì–´í•™ì›', rating: 4.5, reviews: 120, price: 'ì¤‘ê°„' },
                    { name: 'B í•™ì›', rating: 4.2, reviews: 85, price: 'ë†’ìŒ' },
                    { name: 'C ì˜ì–´', rating: 4.7, reviews: 200, price: 'ë‚®ìŒ' }
                ];

                const html = data.map(item => \`
                    <div class="p-4 border rounded-xl hover:border-purple-400 transition">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg">\${item.name}</h3>
                            <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">
                                â­ \${item.rating}
                            </span>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <div>ë¦¬ë·°: \${item.reviews}ê°œ</div>
                            <div>ê°€ê²©ëŒ€: \${item.price}</div>
                        </div>
                    </div>
                \`).join('');

                document.getElementById('results').innerHTML = html;
            }
        </script>
    </body>
    </html>
  `)
})

// 9. í•™ì› ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
app.get('/tools/operation-checklist', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í•™ì› ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-4xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold mb-4">
                <i class="fas fa-tasks text-purple-600 mr-3"></i>í•™ì› ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
            </h1>
            <p class="text-xl text-gray-600 mb-8">ë§¤ì¼ í™•ì¸í•´ì•¼ í•  í•„ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</p>

            <div class="space-y-6">
                ${[
                    {title: 'ì˜¤ì „ ì—…ë¬´', items: ['êµì‹¤ ì²­ì†Œ ë° í™˜ê¸°', 'í•™ìƒ ì¶œê²° í™•ì¸', 'ì˜¤ëŠ˜ì˜ ìˆ˜ì—… ìë£Œ ì¤€ë¹„', 'í•™ë¶€ëª¨ ë¬¸ì˜ ë‹µë³€']},
                    {title: 'ìˆ˜ì—… ì¤‘', items: ['í•™ìƒ ì§‘ì¤‘ë„ ì²´í¬', 'ìˆ™ì œ ê²€ì‚¬', 'ì´í•´ë„ í™•ì¸', 'ë³´ì¶© í•„ìš” í•™ìƒ íŒŒì•…']},
                    {title: 'ìˆ˜ì—… í›„', items: ['ì˜¤ëŠ˜ì˜ ì§„ë„ ê¸°ë¡', 'í•™ë¶€ëª¨ ìƒë‹´ ì˜ˆì•½', 'ë‹¤ìŒ ìˆ˜ì—… ì¤€ë¹„', 'ì‹œì„¤ ì ê²€']}
                ].map(section => `
                    <div class="bg-white rounded-2xl p-6 shadow-sm">
                        <h2 class="text-xl font-bold text-purple-600 mb-4">
                            <i class="fas fa-clock mr-2"></i>${section.title}
                        </h2>
                        <div class="space-y-3">
                            ${section.items.map((item, i) => `
                                <label class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                                    <input type="checkbox" class="w-5 h-5 text-purple-600 rounded">
                                    <span class="text-gray-900">${item}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="mt-8 text-center">
                <button onclick="resetAll()" class="px-8 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300">
                    ì „ì²´ ì´ˆê¸°í™”
                </button>
            </div>
        </div>

        <script>
            function resetAll() {
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            }
        </script>
    </body>
    </html>
  `)
})

// 10. ë§ˆì¼€íŒ… ìº í˜ì¸ í”Œë˜ë„ˆ
app.get('/tools/campaign-planner', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë§ˆì¼€íŒ… ìº í˜ì¸ í”Œë˜ë„ˆ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/tools" class="text-gray-600 hover:text-purple-600">â† íˆ´ ëª©ë¡</a>
                </div>
            </div>
        </nav>

        <div class="max-w-5xl mx-auto px-6 py-12">
            <h1 class="text-4xl font-bold mb-4">
                <i class="fas fa-calendar-alt text-purple-600 mr-3"></i>ë§ˆì¼€íŒ… ìº í˜ì¸ í”Œë˜ë„ˆ
            </h1>
            <p class="text-xl text-gray-600 mb-8">ì›”ë³„ ë§ˆì¼€íŒ… ìº í˜ì¸ì„ ì²´ê³„ì ìœ¼ë¡œ ê³„íší•˜ì„¸ìš”</p>

            <div class="bg-white rounded-2xl p-8 shadow-sm mb-8">
                <h2 class="text-2xl font-bold mb-6">2025ë…„ ì—°ê°„ ìº í˜ì¸ ê³„íš</h2>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${[
                        {month: '1ì›”', campaign: 'ê²¨ìš¸ë°©í•™ íŠ¹ê°•', status: 'active'},
                        {month: '2ì›”', campaign: 'ì‹ í•™ê¸° ì¤€ë¹„ë°˜', status: 'planning'},
                        {month: '3ì›”', campaign: 'ë´„ ì‹ ê·œ ë“±ë¡ ì´ë²¤íŠ¸', status: 'upcoming'},
                        {month: '4ì›”', campaign: 'ì¤‘ê°„ê³ ì‚¬ ëŒ€ë¹„ë°˜', status: 'upcoming'},
                        {month: '7ì›”', campaign: 'ì—¬ë¦„ë°©í•™ ìº í”„', status: 'upcoming'},
                        {month: '12ì›”', campaign: 'ì—°ë§ ê²°ì‚° ì´ë²¤íŠ¸', status: 'upcoming'}
                    ].map(item => `
                        <div class="p-6 border-2 ${item.status === 'active' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'} rounded-xl">
                            <div class="flex justify-between items-start mb-3">
                                <h3 class="font-bold text-lg">${item.month}</h3>
                                <span class="px-2 py-1 text-xs rounded-full ${
                                    item.status === 'active' ? 'bg-purple-200 text-purple-700' : 
                                    item.status === 'planning' ? 'bg-blue-200 text-blue-700' : 
                                    'bg-gray-200 text-gray-700'
                                }">
                                    ${item.status === 'active' ? 'ì§„í–‰ì¤‘' : item.status === 'planning' ? 'ì¤€ë¹„ì¤‘' : 'ì˜ˆì •'}
                                </span>
                            </div>
                            <p class="text-gray-700">${item.campaign}</p>
                            <button onclick="alert('ìº í˜ì¸ ìƒì„¸ í˜ì´ì§€')" 
                                    class="mt-4 w-full py-2 text-sm text-purple-600 border border-purple-300 rounded-lg hover:bg-purple-50">
                                ìì„¸íˆ ë³´ê¸°
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>

            <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-2xl p-8">
                <h3 class="text-xl font-bold mb-4">ğŸ’¡ íš¨ê³¼ì ì¸ ìº í˜ì¸ ì „ëµ</h3>
                <div class="grid md:grid-cols-3 gap-6">
                    <div>
                        <h4 class="font-bold text-purple-600 mb-2">íƒ€ì´ë°</h4>
                        <p class="text-sm text-gray-700">ë°©í•™ 2ì£¼ ì „ë¶€í„° í™ë³´ ì‹œì‘</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-purple-600 mb-2">ì±„ë„</h4>
                        <p class="text-sm text-gray-700">ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤, ë¸”ë¡œê·¸, ë¬¸ì</p>
                    </div>
                    <div>
                        <h4 class="font-bold text-purple-600 mb-2">í˜œíƒ</h4>
                        <p class="text-sm text-gray-700">ì¡°ê¸° ë“±ë¡ í• ì¸ + ì‚¬ì€í’ˆ</p>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
  `)
})

// íˆ´ ë©”ì¸ í˜ì´ì§€ (ëª©ë¡)
app.get('/tools', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë§ˆì¼€íŒ… íˆ´ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
            .tool-card { transition: all 0.3s; }
            .tool-card:hover { transform: translateY(-4px); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/" class="text-gray-600 hover:text-purple-600">â† í™ˆìœ¼ë¡œ</a>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-12">
            <div class="text-center mb-12">
                <h1 class="text-5xl font-bold text-gray-900 mb-4">ë§ˆì¼€íŒ… íˆ´</h1>
                <p class="text-xl text-gray-600">í•™ì› ë§ˆì¼€íŒ…ì— í•„ìš”í•œ ëª¨ë“  ë„êµ¬ë¥¼ í•œ ê³³ì—ì„œ</p>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${[
                    {url: '/tools/landing-builder', icon: 'rocket', title: 'ëœë”©í˜ì´ì§€ ìƒì„±ê¸°', desc: 'í•™ì› ë§ì¶¤ ëœë”©í˜ì´ì§€ ì œì‘', color: 'purple'},
                    {url: '/tools/place-keyword-analyzer', icon: 'search', title: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ í‚¤ì›Œë“œ ë¶„ì„ê¸°', desc: 'ìµœì ì˜ í‚¤ì›Œë“œë¡œ ìƒìœ„ ë…¸ì¶œ', color: 'blue'},
                    {url: '/tools/blog-title-generator', icon: 'lightbulb', title: 'ë¸”ë¡œê·¸ ì œëª© ìƒì„±ê¸°', desc: 'í´ë¦­ë¥  ë†’ì€ ì œëª© ìë™ ìƒì„±', color: 'orange'},
                    {url: '/tools/consultation-calendar', icon: 'calendar-check', title: 'ìƒë‹´ ì˜ˆì•½ ìº˜ë¦°ë”', desc: 'ê°„í¸í•œ ìƒë‹´ ì˜ˆì•½ ì‹œìŠ¤í…œ', color: 'green'},
                    {url: '/tools/promo-generator', icon: 'bullhorn', title: 'í•™ì› í™ë³´ ë¬¸êµ¬ ìƒì„±ê¸°', desc: 'íš¨ê³¼ì ì¸ í™ë³´ ë¬¸êµ¬ ìƒì„±', color: 'cyan'},
                    {url: '/tools/review-template', icon: 'comment-dots', title: 'ë¦¬ë·° ë‹µë³€ í…œí”Œë¦¿', desc: 'ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•œ ë‹µë³€', color: 'pink'},
                    {url: '/tools/parent-sms-template', icon: 'sms', title: 'í•™ë¶€ëª¨ ë¬¸ì í…œí”Œë¦¿', desc: 'ìƒí™©ë³„ ë¬¸ì ë©”ì‹œì§€', color: 'indigo'},
                    {url: '/tools/poster-generator', icon: 'image', title: 'í¬ìŠ¤í„° ë¬¸êµ¬ ìƒì„±ê¸°', desc: 'ëˆˆì— ë„ëŠ” í¬ìŠ¤í„° ì œì‘', color: 'red'},
                    {url: '/tools/competitor-analysis', icon: 'chart-bar', title: 'ê²½ìŸì‚¬ ë¶„ì„ ë„êµ¬', desc: 'ì£¼ë³€ í•™ì› ì •ë³´ ë¶„ì„', color: 'teal'},
                    {url: '/tools/operation-checklist', icon: 'tasks', title: 'í•™ì› ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸', desc: 'í•„ìˆ˜ ì—…ë¬´ ê´€ë¦¬', color: 'yellow'},
                    {url: '/tools/campaign-planner', icon: 'calendar-alt', title: 'ë§ˆì¼€íŒ… ìº í˜ì¸ í”Œë˜ë„ˆ', desc: 'ì—°ê°„ ìº í˜ì¸ ê³„íš', color: 'emerald'}
                ].map(tool => `
                    <a href="${tool.url}" class="tool-card block bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-lg">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-${tool.color}-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-${tool.icon} text-${tool.color}-600 text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-gray-900 mb-2">${tool.title}</h3>
                                <p class="text-sm text-gray-600">${tool.desc}</p>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </a>
                `).join('')}
            </div>

            <div class="mt-12 text-center">
                <div class="inline-block bg-gradient-to-r from-purple-50 to-blue-50 rounded-2xl p-8">
                    <h3 class="text-2xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-rocket text-purple-600 mr-2"></i>
                        ë” ë§ì€ ê¸°ëŠ¥ì´ ê³„ì† ì¶”ê°€ë©ë‹ˆë‹¤!
                    </h3>
                    <p class="text-gray-600 mb-6">í•™ì› ìš´ì˜ì— í•„ìš”í•œ íˆ´ì´ ìˆë‹¤ë©´ ì œì•ˆí•´ì£¼ì„¸ìš”</p>
                    <a href="/contact" class="inline-block gradient-purple text-white px-8 py-4 rounded-xl font-bold hover:shadow-lg">
                        ê¸°ëŠ¥ ì œì•ˆí•˜ê¸°
                    </a>
                </div>
            </div>
        </div>
    </body>
    </html>
  `)
})

// ============================================
// ê´€ë¦¬ì í˜ì´ì§€
// ============================================

// ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
app.get('/admin', async (c) => {
  // /admin â†’ /admin/dashboard ë¦¬ë‹¤ì´ë ‰íŠ¸
  return c.redirect('/admin/dashboard', 301)
})

// ì‚¬ìš©ì ê´€ë¦¬ í˜ì´ì§€
app.get('/admin/users', async (c) => {
  const { env } = c
  
  // ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ (í¬ì¸íŠ¸ í¬í•¨)
  const users = await env.DB.prepare('SELECT id, email, name, phone, academy_name, role, points, created_at FROM users ORDER BY created_at DESC').all()
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì‚¬ìš©ì ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
        <script>
            // v2.0 - All functions defined immediately in head
            // ì „ì—­ ë³€ìˆ˜
            var currentUsageUserId = null;
            
            // ì¦‰ì‹œ í•¨ìˆ˜ ì •ì˜
            window.manageUsageLimits = function(userId, userName) {
                console.log('manageUsageLimits called:', userId, userName);
                currentUsageUserId = userId;
                document.getElementById('usageModalUserName').textContent = userName + 'ë‹˜ì˜ ì‚¬ìš© í•œë„';
                document.getElementById('usageLimitsModal').classList.remove('hidden');
                
                fetch('/api/admin/usage/' + userId)
                    .then(res => res.json())
                    .then(data => {
                        var content = document.getElementById('usageLimitsContent');
                        if (!data.success || !data.hasSubscription) {
                            content.innerHTML = '<div class="space-y-6">' +
                                '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">' +
                                '<p class="text-sm text-yellow-800"><i class="fas fa-exclamation-triangle mr-2"></i><strong>ì•ˆë‚´:</strong> í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ í•œë„ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></div>' +
                                '<div class="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-4 mb-4">' +
                                '<div class="flex items-center mb-3"><span class="text-sm font-semibold text-gray-800">ğŸ“… êµ¬ë… ê¸°ê°„ (ì¼/ê°œì›”)</span></div>' +
                                '<div><input type="number" id="subscriptionMonths" value="1" min="1" max="120" placeholder="ì˜ˆ: 1ì¼, 3ê°œì›”, 12ê°œì›”" class="w-full px-3 py-2 text-sm border-2 border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500">' +
                                '<p class="text-xs text-gray-600 mt-2">ğŸ’¡ 1ì¼ë¶€í„° 120ê°œì›”ê¹Œì§€ ì„¤ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.</p></div></div>' +
                                '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
                                '<div class="border-2 border-blue-200 rounded-lg p-4 bg-blue-50"><div class="flex items-center mb-3"><span class="text-sm font-semibold text-gray-800">ğŸ‘¥ í•™ìƒ ìˆ˜ í•œë„</span></div>' +
                                '<div><input type="number" id="studentLimit" value="30" min="1" placeholder="ìµœì†Œ 1ëª…" class="w-full px-3 py-2 text-sm border-2 border-blue-300 rounded-lg"><p class="text-xs text-gray-500 mt-1">ìµœì†Œ 1ëª…ë¶€í„° ì„¤ì • ê°€ëŠ¥</p></div></div>' +
                                '<div class="border-2 border-green-200 rounded-lg p-4 bg-green-50"><div class="flex items-center mb-3"><span class="text-sm font-semibold text-gray-800">ğŸ“Š AI ë¦¬í¬íŠ¸ í•œë„ (ê°œ/ì›”)</span></div>' +
                                '<div><input type="number" id="aiReportLimit" value="30" min="1" placeholder="ìµœì†Œ 1ê°œ" class="w-full px-3 py-2 text-sm border-2 border-green-300 rounded-lg"><p class="text-xs text-gray-500 mt-1">ìµœì†Œ 1ê°œë¶€í„° ì„¤ì • ê°€ëŠ¥</p></div></div>' +
                                '<div class="border-2 border-purple-200 rounded-lg p-4 bg-purple-50"><div class="flex items-center mb-3"><span class="text-sm font-semibold text-gray-800">ğŸ¨ ëœë”©í˜ì´ì§€ í•œë„ (ê°œ)</span></div>' +
                                '<div><input type="number" id="landingPageLimit" value="40" min="1" placeholder="ìµœì†Œ 1ê°œ" class="w-full px-3 py-2 text-sm border-2 border-purple-300 rounded-lg"><p class="text-xs text-gray-500 mt-1">ìµœì†Œ 1ê°œë¶€í„° ì„¤ì • ê°€ëŠ¥</p></div></div>' +
                                '<div class="border-2 border-orange-200 rounded-lg p-4 bg-orange-50"><div class="flex items-center mb-3"><span class="text-sm font-semibold text-gray-800">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ í•œë„ (ëª…)</span></div>' +
                                '<div><input type="number" id="teacherLimit" value="2" min="1" placeholder="ìµœì†Œ 1ëª…" class="w-full px-3 py-2 text-sm border-2 border-orange-300 rounded-lg"><p class="text-xs text-gray-500 mt-1">ìµœì†Œ 1ëª…ë¶€í„° ì„¤ì • ê°€ëŠ¥</p></div></div></div></div>';
                        } else {
                            var sub = data.subscription;
                            var use = data.usage;
                            content.innerHTML = '<div class="space-y-6"><div class="bg-gradient-to-br from-teal-50 to-cyan-50 rounded-xl p-4 border border-teal-200">' +
                                '<div class="flex justify-between items-start"><div><h4 class="text-lg font-bold text-gray-900">' + sub.planName + '</h4>' +
                                '<p class="text-sm text-gray-600 mt-1">' + sub.startDate + ' ~ ' + sub.endDate + '</p></div>' +
                                '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">í™œì„±</span></div></div>' +
                                '<div class="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-4"><div class="flex items-center mb-3"><span class="text-sm font-semibold text-gray-800">ğŸ“… êµ¬ë… ê¸°ê°„ (ì¼/ê°œì›”)</span></div>' +
                                '<div><input type="number" id="subscriptionMonths" value="1" min="1" max="120" placeholder="1ì¼ ~ 120ê°œì›”" class="w-full px-3 py-2 text-sm border-2 border-indigo-300 rounded-lg"><p class="text-xs text-gray-500 mt-1">1ì¼ë¶€í„° 120ê°œì›”ê¹Œì§€</p></div></div>' +
                                '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">' +
                                '<div class="border-2 border-blue-200 rounded-lg p-4 bg-blue-50"><div class="text-sm font-semibold text-gray-700 mb-2">ğŸ‘¥ í•™ìƒ ìˆ˜ í•œë„ (ëª…)</div><input type="number" id="studentLimit" value="' + sub.studentLimit + '" min="1" class="w-full px-3 py-2 text-sm border-2 border-blue-300 rounded-lg"><p class="text-xs text-gray-500 mt-1">ìµœì†Œ 1ëª…</p></div>' +
                                '<div class="border-2 border-green-200 rounded-lg p-4 bg-green-50"><div class="text-sm font-semibold text-gray-700 mb-2">ğŸ“Š AI ë¦¬í¬íŠ¸ í•œë„ (ê°œ/ì›”)</div><input type="number" id="aiReportLimit" value="' + sub.aiReportLimit + '" min="1" class="w-full px-3 py-2 text-sm border-2 border-green-300 rounded-lg"><p class="text-xs text-gray-500 mt-1">ìµœì†Œ 1ê°œ</p></div>' +
                                '<div class="border-2 border-purple-200 rounded-lg p-4 bg-purple-50"><div class="text-sm font-semibold text-gray-700 mb-2">ğŸ¨ ëœë”©í˜ì´ì§€ í•œë„ (ê°œ)</div><input type="number" id="landingPageLimit" value="' + sub.landingPageLimit + '" min="1" class="w-full px-3 py-2 text-sm border-2 border-purple-300 rounded-lg"><p class="text-xs text-gray-500 mt-1">ìµœì†Œ 1ê°œ</p></div>' +
                                '<div class="border-2 border-orange-200 rounded-lg p-4 bg-orange-50"><div class="text-sm font-semibold text-gray-700 mb-2">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ í•œë„ (ëª…)</div><input type="number" id="teacherLimit" value="' + sub.teacherLimit + '" min="1" class="w-full px-3 py-2 text-sm border-2 border-orange-300 rounded-lg"><p class="text-xs text-gray-500 mt-1">ìµœì†Œ 1ëª…</p></div></div></div>';
                        }
                        
                        setTimeout(function() {
                            var saveBtn = document.getElementById('saveUsageLimitsBtn');
                            if (saveBtn) {
                                console.log('âœ… Save button found and ready');
                                saveBtn.onclick = function() {
                                    window.saveUsageLimits();
                                };
                            }
                        }, 300);
                    })
                    .catch(function(err) {
                        console.error('Error:', err);
                        document.getElementById('usageLimitsContent').innerHTML = '<div class="text-center py-12 text-red-500">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>';
                    });
            };
            
            window.saveUsageLimits = function() {
                console.log('ğŸ’¾ saveUsageLimits called');
                if (!currentUsageUserId) {
                    alert('âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                var studentLimit = parseInt(document.getElementById('studentLimit').value);
                var aiReportLimit = parseInt(document.getElementById('aiReportLimit').value);
                var landingPageLimit = parseInt(document.getElementById('landingPageLimit').value);
                var teacherLimit = parseInt(document.getElementById('teacherLimit').value);
                
                // ì¼/ì›” ë‹¨ìœ„ êµ¬ë¶„
                var durationType = document.querySelector('input[name="durationType"]:checked').value;
                var subscriptionDays = 0;
                var subscriptionMonths = 0;
                var displayPeriod = '';
                
                if (durationType === 'days') {
                    subscriptionDays = parseInt(document.getElementById('subscriptionDays').value) || 1;
                    if (subscriptionDays < 1 || subscriptionDays > 3650) {
                        alert('âŒ ì¼ ìˆ˜ëŠ” 1 ~ 3650ì¼ ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”');
                        return;
                    }
                    displayPeriod = subscriptionDays + 'ì¼';
                } else {
                    subscriptionMonths = parseInt(document.getElementById('subscriptionMonths').value) || 1;
                    if (subscriptionMonths < 1 || subscriptionMonths > 120) {
                        alert('âŒ ê°œì›” ìˆ˜ëŠ” 1 ~ 120ê°œì›” ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”');
                        return;
                    }
                    displayPeriod = subscriptionMonths + 'ê°œì›”';
                }
                
                if (isNaN(studentLimit) || isNaN(aiReportLimit) || isNaN(landingPageLimit) || isNaN(teacherLimit)) {
                    alert('âŒ ëª¨ë“  í•œë„ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                if (studentLimit < 1 || aiReportLimit < 1 || landingPageLimit < 1 || teacherLimit < 1) {
                    alert('âŒ ëª¨ë“  í•œë„ëŠ” ìµœì†Œ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
                    return;
                }
                
                if (!confirm('ì •ë§ ì‚¬ìš© í•œë„ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nêµ¬ë… ê¸°ê°„: ' + displayPeriod + '\\ní•™ìƒ: ' + studentLimit + 'ëª…\\nAI ë¦¬í¬íŠ¸: ' + aiReportLimit + 'ê°œ/ì›”\\nëœë”©í˜ì´ì§€: ' + landingPageLimit + 'ê°œ\\nì„ ìƒë‹˜: ' + teacherLimit + 'ëª…')) {
                    return;
                }
                
                fetch('/api/admin/usage/' + currentUsageUserId + '/update-limits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        studentLimit: studentLimit, 
                        aiReportLimit: aiReportLimit, 
                        landingPageLimit: landingPageLimit, 
                        teacherLimit: teacherLimit, 
                        subscriptionDays: subscriptionDays,
                        subscriptionMonths: subscriptionMonths,
                        durationType: durationType
                    })
                })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.success) {
                        alert('âœ… ì‚¬ìš© í•œë„ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        window.closeUsageLimitsModal();
                        location.reload();
                    } else {
                        alert('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                })
                .catch(function(err) {
                    alert('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + err.message);
                });
            };
            
            window.closeUsageLimitsModal = function() {
                document.getElementById('usageLimitsModal').classList.add('hidden');
                currentUsageUserId = null;
            };
            
            window.revokePlan = function() {
                console.log('ğŸš« revokePlan called');
                if (!currentUsageUserId) {
                    alert('âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    return;
                }
                
                if (!confirm('âš ï¸ ì •ë§ë¡œ ì´ ì‚¬ìš©ìì˜ í”Œëœì„ íšŒìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nì´ ì‘ì—…ì€ ë‹¤ìŒì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:\\n- êµ¬ë… ì¢…ë£Œ\\n- ëª¨ë“  ì‚¬ìš© í•œë„ 0ìœ¼ë¡œ ì„¤ì •\\n\\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    return;
                }
                
                fetch('/api/admin/revoke-plan/' + currentUsageUserId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.success) {
                        alert('âœ… í”Œëœì´ ì„±ê³µì ìœ¼ë¡œ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        window.closeUsageLimitsModal();
                        location.reload();
                    } else {
                        alert('âŒ í”Œëœ íšŒìˆ˜ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                })
                .catch(function(err) {
                    alert('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + err.message);
                });
            };
            
            window.changePassword = function(userId, userName) {
                var newPassword = prompt(userName + 'ë‹˜ì˜ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                if (newPassword && newPassword.trim()) {
                    fetch('/api/admin/users/' + userId + '/password', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newPassword: newPassword.trim() })
                    }).then(function(res) { return res.json(); }).then(function(data) {
                        alert(data.success ? 'âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!' : 'âŒ ë³€ê²½ ì‹¤íŒ¨');
                    });
                }
            };
            
            window.givePoints = function(userId, userName, currentPoints) {
                var amount = prompt(userName + 'ë‹˜ì—ê²Œ ì§€ê¸‰í•  í¬ì¸íŠ¸ (í˜„ì¬: ' + currentPoints.toLocaleString() + 'P):');
                if (amount && !isNaN(amount) && parseInt(amount) > 0) {
                    fetch('/api/admin/users/' + userId + '/points', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ points: parseInt(amount) })
                    }).then(function(res) { return res.json(); }).then(function(data) {
                        if (data.success) { 
                            alert('âœ… ' + amount + 'Pê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤! ìƒˆ ì”ì•¡: ' + data.newPoints.toLocaleString() + 'P'); 
                            location.reload(); 
                        } else {
                            alert('âŒ ì˜¤ë¥˜: ' + (data.error || 'í¬ì¸íŠ¸ ì§€ê¸‰ ì‹¤íŒ¨'));
                        }
                    }).catch(function(err) {
                        alert('âŒ í¬ì¸íŠ¸ ì§€ê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                    });
                }
            };
            
            window.deductPoints = function(userId, userName, currentPoints) {
                var amount = prompt(userName + 'ë‹˜ì˜ í¬ì¸íŠ¸ë¥¼ ì°¨ê°í•©ë‹ˆë‹¤ (í˜„ì¬: ' + currentPoints.toLocaleString() + 'P) - ì°¨ê°í•  í¬ì¸íŠ¸:');
                if (amount && !isNaN(amount) && parseInt(amount) > 0) {
                    if (parseInt(amount) > currentPoints) {
                        if (!confirm('ê²½ê³ : í˜„ì¬ í¬ì¸íŠ¸(' + currentPoints.toLocaleString() + 'P)ë³´ë‹¤ ë§ì€ ê¸ˆì•¡(' + amount + 'P)ì„ ì°¨ê°í•˜ë©´ í¬ì¸íŠ¸ê°€ ë§ˆì´ë„ˆìŠ¤ê°€ ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            return;
                        }
                    }
                    if (!confirm(userName + 'ë‹˜ì˜ í¬ì¸íŠ¸ë¥¼ ' + amount + 'P ì°¨ê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì°¨ê° í›„ ì”ì•¡: ' + (currentPoints - parseInt(amount)).toLocaleString() + 'P)')) {
                        return;
                    }
                    fetch('/api/admin/users/' + userId + '/points/deduct', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ points: parseInt(amount) })
                    }).then(function(res) { return res.json(); }).then(function(data) {
                        if (data.success) { 
                            alert('âœ… ' + amount + 'Pê°€ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤! ìƒˆ ì”ì•¡: ' + data.newPoints.toLocaleString() + 'P'); 
                            location.reload(); 
                        } else {
                            alert('âŒ ì˜¤ë¥˜: ' + (data.error || 'í¬ì¸íŠ¸ ì°¨ê° ì‹¤íŒ¨'));
                        }
                    }).catch(function(err) {
                        alert('âŒ í¬ì¸íŠ¸ ì°¨ê° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                    });
                }
            };
            
            window.loginAs = function(userId, userName) {
                if (!confirm(userName + 'ë‹˜ì˜ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                
                fetch('/api/admin/login-as/' + userId, { method: 'POST' })
                    .then(function(res) { return res.json(); })
                    .then(function(data) {
                        if (data.success) {
                            localStorage.setItem('user', JSON.stringify(data.user));
                            alert('âœ… ' + userName + 'ë‹˜ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
                            window.location.href = '/dashboard';
                        } else {
                            alert('âŒ ì˜¤ë¥˜: ' + (data.error || 'ë¡œê·¸ì¸ ì‹¤íŒ¨'));
                        }
                    })
                    .catch(function(err) {
                        alert('âŒ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                    });
            };
            
            window.managePermissions = function(userId, userName) {
                // admin-users.jsì˜ managePermissions í•¨ìˆ˜ í˜¸ì¶œ
                if (typeof managePermissions === 'function') {
                    managePermissions(userId, userName);
                } else {
                    console.error('managePermissions function not found');
                    alert('âŒ ê¶Œí•œ ê´€ë¦¬ ê¸°ëŠ¥ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            };
            
            window.deleteUser = function(userId, userName) {
                if (confirm('âš ï¸ ì •ë§ ' + userName + 'ë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    fetch('/api/admin/users/' + userId, { method: 'DELETE' })
                        .then(function(res) { return res.json(); })
                        .then(function(data) {
                            if (data.success) { alert('âœ… ì‚­ì œ ì™„ë£Œ'); location.reload(); }
                        });
                }
            };
            window.logout = function() {
                if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    document.cookie = 'session_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    window.location.href = '/login';
                }
            };
            
            console.log('âœ… All functions loaded in head');
        </script>
    </head>
    <body class="bg-gray-50">
        <!-- í—¤ë” -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-full mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-8">
                        <a href="/admin/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a>
                        <div class="flex gap-4">
                            <a href="/admin/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                            <a href="/admin/users" class="text-purple-600 font-medium">ì‚¬ìš©ì</a>
                            <a href="/admin/contacts" class="text-gray-600 hover:text-purple-600">ë¬¸ì˜</a>
                            <a href="/admin/bank-transfers" class="text-gray-600 hover:text-purple-600">ê³„ì¢Œì´ì²´</a>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </nav>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="max-w-full mx-auto px-6 py-8">
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">ì‚¬ìš©ì ê´€ë¦¬</h1>
                        <p class="text-gray-600">ì „ì²´ <span id="totalUsers">${users?.results?.length || 0}</span>ëª…ì˜ ì‚¬ìš©ì (<span id="filteredUsers">${users?.results?.length || 0}</span>ëª… í‘œì‹œ)</p>
                    </div>
                </div>
                
                <!-- ê²€ìƒ‰ ë°” -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                    <div class="flex gap-4 items-center">
                        <div class="flex-1">
                            <input type="text" id="searchInput" placeholder="ğŸ” ì´ë¦„, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸, í•™ì›ëª…ìœ¼ë¡œ ê²€ìƒ‰..." 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                onkeyup="filterUsers()">
                        </div>
                        <button onclick="clearSearch()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                            ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš©ì ëª©ë¡ í…Œì´ë¸” -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì´ë©”ì¼</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì´ë¦„</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì „í™”ë²ˆí˜¸</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">í•™ì›ëª…</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">í¬ì¸íŠ¸</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê¶Œí•œ</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê°€ì…ì¼</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${users?.results?.map(user => {
                                // data ì†ì„±ìœ¼ë¡œ ì „ë‹¬ (HTML ì•ˆì „)
                                const userName = (user.name || '').replace(/"/g, '&quot;')
                                return `
                                <tr class="hover:bg-gray-50" data-user="${user.id}">
                                    <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-900">${user.id}</td>
                                    <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-900">${user.email}</td>
                                    <td class="px-3 py-3 whitespace-nowrap text-xs font-medium text-gray-900">${user.name}</td>
                                    <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-600">${user.phone || '-'}</td>
                                    <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-600">${user.academy_name || '-'}</td>
                                    <td class="px-3 py-3 whitespace-nowrap text-xs font-medium text-blue-600">${(user.points || 0).toLocaleString()}P</td>
                                    <td class="px-3 py-3 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'}">
                                            ${user.role === 'admin' ? 'ê´€ë¦¬ì' : 'íšŒì›'}
                                        </span>
                                    </td>
                                    <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-600">${new Date(user.created_at).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit', day: '2-digit' })}</td>
                                    <td class="px-3 py-3 whitespace-nowrap text-xs">
                                        ${user.role !== 'admin' ? `
                                            <div class="flex gap-1">
                                                <button onclick="changePassword(${user.id}, '${userName}')" class="px-2 py-1 bg-orange-600 text-white rounded hover:bg-orange-700 text-xs" title="ë¹„ë°€ë²ˆí˜¸">
                                                    ğŸ”‘
                                                </button>
                                                <button onclick="givePoints(${user.id}, '${userName}', ${user.points || 0})" class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs" title="í¬ì¸íŠ¸ ì§€ê¸‰">
                                                    ğŸ’°
                                                </button>
                                                <button onclick="deductPoints(${user.id}, '${userName}', ${user.points || 0})" class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs" title="í¬ì¸íŠ¸ ì°¨ê°">
                                                    âŒ
                                                </button>
                                                <button onclick="loginAs(${user.id}, '${userName}')" class="px-2 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 text-xs" title="ë¡œê·¸ì¸">
                                                    ğŸ‘¤
                                                </button>
                                                <button onclick="managePermissions(${user.id}, '${userName}')" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs" title="ê¶Œí•œ">
                                                    âš™ï¸
                                                </button>
                                                <button onclick="manageUsageLimits(${user.id}, '${userName}')" class="px-2 py-1 bg-teal-600 text-white rounded hover:bg-teal-700 text-xs" title="ì‚¬ìš© í•œë„">
                                                    ğŸ“Š
                                                </button>
                                                <a href="/admin/users/${user.id}" class="px-2 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-xs inline-block" title="ìƒì„¸">
                                                    ğŸ“‹
                                                </a>
                                                <button onclick="deleteUser(${user.id}, '${userName}')" class="px-2 py-1 bg-red-700 text-white rounded hover:bg-red-800 text-xs" title="ì‚­ì œ">
                                                    ğŸ—‘ï¸
                                                </button>
                                            </div>
                                        ` : '-'}
                                    </td>
                                </tr>
                            `}).join('') || '<tr><td colspan="9" class="px-6 py-8 text-center text-gray-500">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ê¶Œí•œ ê´€ë¦¬ ëª¨ë‹¬ -->
        <div id="permissionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200 sticky top-0 bg-white z-10">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">í”„ë¡œê·¸ë¨ ê¶Œí•œ ê´€ë¦¬</h2>
                            <p id="modalUserName" class="text-gray-600 mt-1"></p>
                        </div>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>ê¶Œí•œ ì„¤ì •:</strong> ì²´í¬ë°•ìŠ¤ë¥¼ ì„ íƒ/í•´ì œí•˜ì—¬ ì‚¬ìš©ìê°€ ëŒ€ì‹œë³´ë“œì—ì„œ ë³¼ ìˆ˜ ìˆëŠ” ë„êµ¬ë¥¼ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                    
                    <!-- ê¶Œí•œ ëª©ë¡ (ì¹´í…Œê³ ë¦¬ë³„ë¡œ JSì—ì„œ ë™ì  ë Œë”ë§) -->
                    <div id="systemPermissions" class="space-y-6">
                        <!-- ê¶Œí•œ ì²´í¬ë°•ìŠ¤ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <div class="p-6 border-t border-gray-200 bg-gray-50 sticky bottom-0 flex justify-between items-center">
                    <div class="flex gap-2">
                        <button onclick="selectDefaultPermissions()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                            ê¸°ë³¸ ê¶Œí•œ (4ê°œ)
                        </button>
                        <button onclick="selectAllPermissions()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-sm font-medium">
                            ì „ì²´ ì„ íƒ
                        </button>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="closeModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            ì·¨ì†Œ
                        </button>
                        <button onclick="savePermissions()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            ì €ì¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ì‚¬ìš© í•œë„ ê´€ë¦¬ ëª¨ë‹¬ -->
        <div id="usageLimitsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200 sticky top-0 bg-white z-10">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900">ğŸ“Š ì‚¬ìš© í•œë„ ê´€ë¦¬</h2>
                            <p id="usageModalUserName" class="text-gray-600 mt-1"></p>
                        </div>
                        <button onclick="closeUsageLimitsModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div id="usageLimitsContent">
                        <div class="animate-pulse flex space-x-4">
                            <div class="flex-1 space-y-4 py-1">
                                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                                <div class="space-y-2">
                                    <div class="h-4 bg-gray-200 rounded"></div>
                                    <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-t border-gray-200 bg-gray-50 sticky bottom-0 flex justify-between gap-3" style="z-index: 9999 !important; position: relative !important;">
                    <button id="revokePlanBtn" onclick="revokePlan()" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium cursor-pointer" style="pointer-events: auto !important; cursor: pointer !important; z-index: 10000 !important; position: relative !important;">
                        í”Œëœ íšŒìˆ˜
                    </button>
                    <div class="flex gap-3">
                        <button id="closeUsageLimitsBtn" onclick="closeUsageLimitsModal()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer" style="pointer-events: auto !important; cursor: pointer !important; z-index: 10000 !important; position: relative !important;">
                            ì·¨ì†Œ
                        </button>
                        <button id="saveUsageLimitsBtn" onclick="saveUsageLimits()" class="px-6 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-medium cursor-pointer" style="pointer-events: auto !important; cursor: pointer !important; z-index: 10000 !important; position: relative !important;">
                            ì €ì¥
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
        // filterUsersì™€ clearSearchë§Œ ì •ì˜
        window.filterUsers = function() {
            var searchInput = document.getElementById('searchInput').value.toLowerCase().trim();
            var rows = document.querySelectorAll('tbody tr[data-user]');
            var visibleCount = 0;
            
            rows.forEach(function(row) {
                var email = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                var name = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                var phone = (row.querySelector('td:nth-child(4)').textContent || '').toLowerCase();
                var academy = (row.querySelector('td:nth-child(5)').textContent || '').toLowerCase();
                
                if (email.includes(searchInput) || name.includes(searchInput) || 
                    phone.includes(searchInput) || academy.includes(searchInput)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            document.getElementById('filteredUsers').textContent = visibleCount;
        };
        
        window.clearSearch = function() {
            document.getElementById('searchInput').value = '';
            window.filterUsers();
        };
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ì „ì²´ ì‚¬ìš©ì ìˆ˜ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            var rows = document.querySelectorAll('tbody tr[data-user]');
            document.getElementById('totalUsers').textContent = rows.length;
            document.getElementById('filteredUsers').textContent = rows.length;
        });
    </script>
    <!-- admin-users.jsë¥¼ body ëì— ë¡œë“œí•˜ì—¬ ëª¨ë“  í•¨ìˆ˜ê°€ ì¤€ë¹„ëœ í›„ ì‹¤í–‰ -->
    <script src="/static/admin-users.js"></script>
    </body>
    </html>
  `)
})

// ì‚¬ìš©ì: ë‚´ ì…ê¸ˆ ë‚´ì—­ í˜ì´ì§€ (v3 - 2026-01-17 12:00 FORCED UPDATE)
app.get('/my-deposits', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë‚´ ì…ê¸ˆ ë‚´ì—­ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
            @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
            * { font-family: 'Pretendard Variable', sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="mb-8 flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ’° ë‚´ ì…ê¸ˆ ë‚´ì—­</h1>
                    <p class="text-gray-600">í¬ì¸íŠ¸ ì¶©ì „ ì‹ ì²­ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”</p>
                </div>
                <a href="/dashboard" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    <i class="fas fa-arrow-left mr-2"></i> ëŒ€ì‹œë³´ë“œ
                </a>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ì‹ ì²­ì¼ì‹œ</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ì¶©ì „ í¬ì¸íŠ¸</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ë¶€ê°€ì„¸ (10%)</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ì´ ì…ê¸ˆì•¡</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ì…ê¸ˆìëª…</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ì€í–‰</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ìƒíƒœ</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ì²˜ë¦¬ì¼ì‹œ</th>
                            </tr>
                        </thead>
                        <tbody id="depositList" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                    ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            async function loadDeposits() {
                const user = JSON.parse(localStorage.getItem('user'));
                if (!user || !user.id) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/';
                    return;
                }

                try {
                    const response = await fetch('/api/deposit/my-requests/' + user.id);
                    const data = await response.json();

                    const depositList = document.getElementById('depositList');
                    
                    if (!data.success || !data.requests || data.requests.length === 0) {
                        depositList.innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500"><i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i><div>ì…ê¸ˆ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div></td></tr>';
                        return;
                    }

                    depositList.innerHTML = data.requests.map(req => {
                        const createdDate = new Date(req.created_at);
                        const processedDate = req.processed_at ? new Date(req.processed_at) : null;
                        
                        // ë¶€ê°€ì„¸ ê³„ì‚° (í¬ì¸íŠ¸ ê¸ˆì•¡ì˜ 10%)
                        const points = parseInt(req.amount) || 0;
                        const vat = Math.round(points * 0.1);
                        const totalAmount = points + vat;

                        let statusBadge = '';
                        if (req.status === 'approved') {
                            statusBadge = '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">âœ“ ìŠ¹ì¸</span>';
                        } else if (req.status === 'rejected') {
                            statusBadge = '<span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium">âœ— ê±°ì ˆ</span>';
                        } else {
                            statusBadge = '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-medium">â³ ëŒ€ê¸°ì¤‘</span>';
                        }

                        return '<tr class="hover:bg-gray-50">' +
                            '<td class="px-6 py-4 text-sm text-gray-900">' + createdDate.toLocaleString('ko-KR') + '</td>' +
                            '<td class="px-6 py-4 text-sm font-bold text-blue-600">' + points.toLocaleString() + 'P</td>' +
                            '<td class="px-6 py-4 text-sm text-gray-600">+' + vat.toLocaleString() + 'ì›</td>' +
                            '<td class="px-6 py-4 text-sm font-bold text-gray-900">' + totalAmount.toLocaleString() + 'ì›</td>' +
                            '<td class="px-6 py-4 text-sm text-gray-700">' + (req.depositor_name || '-') + '</td>' +
                            '<td class="px-6 py-4 text-sm text-gray-600">' + (req.bank_name || '-') + '</td>' +
                            '<td class="px-6 py-4">' + statusBadge + '</td>' +
                            '<td class="px-6 py-4 text-sm text-gray-600">' + (processedDate ? processedDate.toLocaleString('ko-KR') : '-') + '</td>' +
                        '</tr>';
                    }).join('');
                } catch (error) {
                    console.error('ì…ê¸ˆ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', error);
                    const depositList = document.getElementById('depositList');
                    depositList.innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-red-500"><i class="fas fa-exclamation-circle text-4xl mb-4"></i><div>ì…ê¸ˆ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div></td></tr>';
                }
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
            window.addEventListener('DOMContentLoaded', loadDeposits);
        </script>
    </body>
    </html>
  `)
})

// ============================================
// ì„ ìƒë‹˜ ê´€ë¦¬ API
// ============================================

// ì„ ìƒë‹˜: ë“±ë¡ ì‹ ì²­ (íšŒì›ê°€ì…)
app.post('/api/teachers/apply', async (c) => {
  try {
    // DB ìŠ¤í‚¤ë§ˆ í™•ì¸ ë° ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜
    try {
      await c.env.DB.prepare(`
        ALTER TABLE users ADD COLUMN user_type TEXT DEFAULT 'director'
      `).run()
      console.log('[Migration] user_type column added')
    } catch (e) {
      // ì»¬ëŸ¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì—ëŸ¬ ë¬´ì‹œ
    }
    
    try {
      await c.env.DB.prepare(`
        ALTER TABLE users ADD COLUMN parent_user_id INTEGER
      `).run()
      console.log('[Migration] parent_user_id column added')
    } catch (e) {
      // ì»¬ëŸ¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì—ëŸ¬ ë¬´ì‹œ
    }
    
    try {
      await c.env.DB.prepare(`
        ALTER TABLE users ADD COLUMN assigned_class TEXT
      `).run()
      console.log('[Migration] assigned_class column added')
    } catch (e) {
      // ì»¬ëŸ¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì—ëŸ¬ ë¬´ì‹œ
    }
    
    // âœ… ê¸°ì¡´ ì„ ìƒë‹˜ë“¤ì˜ academy_idë¥¼ ì›ì¥ë‹˜ì˜ academy_idë¡œ ì—…ë°ì´íŠ¸
    try {
      const result = await c.env.DB.prepare(`
        UPDATE users 
        SET academy_id = (
          SELECT academy_id 
          FROM users AS directors 
          WHERE directors.id = users.parent_user_id 
          LIMIT 1
        )
        WHERE user_type = 'teacher' 
        AND parent_user_id IS NOT NULL 
        AND (academy_id IS NULL OR academy_id = 1)
      `).run()
      console.log('[Migration] Updated academy_id for', result.meta.changes, 'teachers')
    } catch (e) {
      console.error('[Migration] Failed to update teacher academy_id:', e.message)
    }
    
    // teacher_applications í…Œì´ë¸” ìë™ ìƒì„±
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS teacher_applications (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          email TEXT NOT NULL,
          password TEXT NOT NULL,
          name TEXT NOT NULL,
          phone TEXT,
          academy_name TEXT NOT NULL,
          director_email TEXT,
          verification_code TEXT,
          status TEXT DEFAULT 'pending',
          applied_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          processed_at DATETIME,
          processed_by INTEGER,
          reject_reason TEXT,
          FOREIGN KEY (processed_by) REFERENCES users(id)
        )
      `).run()
      console.log('[Migration] teacher_applications table created')
    } catch (e) {
      console.log('[Migration] teacher_applications table already exists')
    }
    
    try {
      await c.env.DB.prepare(`
        CREATE INDEX IF NOT EXISTS idx_teacher_applications_status ON teacher_applications(status)
      `).run()
      await c.env.DB.prepare(`
        CREATE INDEX IF NOT EXISTS idx_teacher_applications_email ON teacher_applications(email)
      `).run()
      console.log('[Migration] teacher_applications indexes created')
    } catch (e) {
      // ì¸ë±ìŠ¤ê°€ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì—ëŸ¬ ë¬´ì‹œ
    }
    
    const { email, password, name, phone, academyName, verificationCode } = await c.req.json()
    
    // í•„ìˆ˜ í•„ë“œ í™•ì¸
    if (!email || !password || !name || !academyName || !verificationCode) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }
    
    // ì¸ì¦ ì½”ë“œ í™•ì¸ (ë¨¼ì € í™•ì¸)
    const codeInfo = await c.env.DB.prepare(`
      SELECT avc.*, u.id as director_id, u.email as director_email, u.name as director_name, u.academy_name
      FROM academy_verification_codes avc
      JOIN users u ON avc.user_id = u.id
      WHERE avc.code = ? AND avc.is_active = 1
    `).bind(verificationCode.toUpperCase()).first()
    
    if (!codeInfo) {
      return c.json({ success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì¸ì¦ ì½”ë“œì…ë‹ˆë‹¤.' }, 400)
    }
    
    // í•™ì›ëª…ì€ ì›ì¥ë‹˜ì˜ academy_name ì‚¬ìš© (ì…ë ¥ê°’ ë¬´ì‹œ)
    // ì¸ì¦ ì½”ë“œë¡œ ì´ë¯¸ í•™ì›ì´ ê²€ì¦ë˜ì—ˆìœ¼ë¯€ë¡œ í•™ì›ëª… ë¶ˆì¼ì¹˜ ì²´í¬ ë¶ˆí•„ìš”
    const directorAcademyName = codeInfo.academy_name || academyName
    
    // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸ - ê¸°ì¡´ ì‚¬ìš©ì ì²˜ë¦¬
    const existingUser = await c.env.DB.prepare(
      'SELECT id, email, name FROM users WHERE email = ?'
    ).bind(email).first()
    
    if (existingUser) {
      // ê¸°ì¡´ ì‚¬ìš©ìê°€ ìˆìœ¼ë©´ í•™ì› ì—°ê²° ì‹ ì²­ìœ¼ë¡œ ì²˜ë¦¬
      console.log('[TeacherApply] Existing user found, creating connection request:', existingUser)
      
      // ì´ë¯¸ ì´ í•™ì›ì— ì‹ ì²­í–ˆëŠ”ì§€ í™•ì¸
      const existingApplication = await c.env.DB.prepare(
        'SELECT id, name, phone FROM teacher_applications WHERE email = ? AND director_email = ? AND status = "pending"'
      ).bind(email, codeInfo.director_email).first()
      
      if (existingApplication) {
        // ê¸°ì¡´ pending ì‹ ì²­ì´ ìˆìœ¼ë©´ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸
        console.log('[TeacherApply] Updating existing pending application:', existingApplication.id)
        
        await c.env.DB.prepare(`
          UPDATE teacher_applications 
          SET name = ?, phone = ?, academy_name = ?, verification_code = ?, applied_at = datetime('now')
          WHERE id = ?
        `).bind(
          existingUser.name || name,
          phone || null,
          directorAcademyName,
          verificationCode.toUpperCase(),
          existingApplication.id
        ).run()
        
        return c.json({ 
          success: true, 
          applicationId: existingApplication.id,
          message: `ì´ë¯¸ ì‹ ì²­í•˜ì‹  ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤.\nì‹ ì²­ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìœ¼ë©°, ${codeInfo.director_name} ì›ì¥ë‹˜ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.`,
          directorName: codeInfo.director_name,
          isExistingUser: true,
          updated: true
        })
      }
      
      // í•™ì› ì—°ê²° ì‹ ì²­ ìƒì„± (ë¹„ë°€ë²ˆí˜¸ ë¶ˆí•„ìš”)
      const result = await c.env.DB.prepare(`
        INSERT INTO teacher_applications (
          email, password, name, phone, academy_name, 
          director_email, verification_code, status, applied_at
        )
        VALUES (?, ?, ?, ?, ?, ?, ?, 'pending', datetime('now'))
      `).bind(
        email, 
        'EXISTING_USER', // ê¸°ì¡´ ì‚¬ìš©ìëŠ” ë¹„ë°€ë²ˆí˜¸ ë¶ˆí•„ìš”
        existingUser.name || name, 
        phone || null, 
        directorAcademyName,
        codeInfo.director_email,
        verificationCode.toUpperCase()
      ).run()
      
      return c.json({ 
        success: true, 
        applicationId: result.meta.last_row_id,
        message: `ê¸°ì¡´ ê³„ì •ìœ¼ë¡œ í•™ì› ì—°ê²° ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n${codeInfo.director_name} ì›ì¥ë‹˜ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`,
        directorName: codeInfo.director_name,
        isExistingUser: true
      })
    }
    
    // ì‹ ê·œ ì‚¬ìš©ì - ì´ í•™ì›ì— ì´ë¯¸ ì‹ ì²­í–ˆëŠ”ì§€ í™•ì¸
    const existingApplication = await c.env.DB.prepare(
      'SELECT id FROM teacher_applications WHERE email = ? AND director_email = ? AND status = "pending"'
    ).bind(email, codeInfo.director_email).first()
    
    if (existingApplication) {
      // ê¸°ì¡´ pending ì‹ ì²­ì´ ìˆìœ¼ë©´ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸
      console.log('[TeacherApply] Updating existing pending application for new user:', existingApplication.id)
      
      await c.env.DB.prepare(`
        UPDATE teacher_applications 
        SET name = ?, phone = ?, password = ?, academy_name = ?, verification_code = ?, applied_at = datetime('now')
        WHERE id = ?
      `).bind(
        name,
        phone || null,
        password,
        directorAcademyName,
        verificationCode.toUpperCase(),
        existingApplication.id
      ).run()
      
      return c.json({ 
        success: true, 
        applicationId: existingApplication.id,
        message: `ì´ë¯¸ ì‹ ì²­í•˜ì‹  ë‚´ì—­ì´ ìˆìŠµë‹ˆë‹¤.\nì‹ ì²­ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìœ¼ë©°, ${codeInfo.director_name} ì›ì¥ë‹˜ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.`,
        directorName: codeInfo.director_name,
        updated: true
      })
    }
    
    // ì‹ ê·œ ì‚¬ìš©ì - ë“±ë¡ ì‹ ì²­ ì €ì¥
    const result = await c.env.DB.prepare(`
      INSERT INTO teacher_applications (
        email, password, name, phone, academy_name, 
        director_email, verification_code, status, applied_at
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, 'pending', datetime('now'))
    `).bind(
      email, 
      password, 
      name, 
      phone || null, 
      directorAcademyName,
      codeInfo.director_email,
      verificationCode.toUpperCase()
    ).run()
    
    return c.json({ 
      success: true, 
      applicationId: result.meta.last_row_id,
      message: `ë“±ë¡ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ${codeInfo.director_name} ì›ì¥ë‹˜ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.`,
      directorName: codeInfo.director_name
    })
  } catch (error) {
    console.error('[TeacherApply] Error:', error)
    console.error('[TeacherApply] Error stack:', error.stack)
    console.error('[TeacherApply] Error message:', error.message)
    return c.json({ 
      success: false, 
      error: 'ë“±ë¡ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 
      details: error.message,
      stack: error.stack
    }, 500)
  }
})

// ì›ì¥ë‹˜: ì„ ìƒë‹˜ ë“±ë¡ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ
app.get('/api/teachers/applications', async (c) => {
  try {
    const directorId = c.req.query('directorId')
    const status = c.req.query('status') || 'pending'
    
    if (!directorId) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // ì›ì¥ë‹˜ì˜ ì´ë©”ì¼ë¡œ ì‹ ì²­í•œ ëª©ë¡ ì¡°íšŒ
    const director = await c.env.DB.prepare(
      'SELECT email FROM users WHERE id = ?'
    ).bind(directorId).first()
    
    if (!director) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    console.log('[GetApplications] Director:', director.email, 'Status:', status)
    
    const applications = await c.env.DB.prepare(`
      SELECT * FROM teacher_applications
      WHERE director_email = ? AND status = ?
      ORDER BY applied_at DESC
    `).bind(director.email, status).all()
    
    console.log('[GetApplications] Found applications:', applications.results?.length || 0)
    
    return c.json({ 
      success: true, 
      applications: applications.results || [],
      debug: {
        directorEmail: director.email,
        status: status,
        count: applications.results?.length || 0
      }
    })
  } catch (error) {
    console.error('Get applications error:', error)
    return c.json({ success: false, error: 'ì‹ ì²­ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì›ì¥ë‹˜: ì„ ìƒë‹˜ ë“±ë¡ ì‹ ì²­ ìŠ¹ì¸
app.post('/api/teachers/applications/:id/approve', async (c) => {
  try {
    const applicationId = c.req.param('id')
    const { directorId } = await c.req.json()
    
    if (!directorId) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // ì‹ ì²­ ì •ë³´ ì¡°íšŒ
    const application = await c.env.DB.prepare(
      'SELECT * FROM teacher_applications WHERE id = ? AND status = "pending"'
    ).bind(applicationId).first()
    
    if (!application) {
      return c.json({ success: false, error: 'ì‹ ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // ì›ì¥ë‹˜ ì •ë³´ í™•ì¸
    const director = await c.env.DB.prepare(
      'SELECT id, academy_name FROM users WHERE id = ?'
    ).bind(directorId).first()
    
    if (!director) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // ğŸ”¥ ì„ ìƒë‹˜ í•œë„ ì²´í¬ (ì‹ ê·œ ì„ ìƒë‹˜ë§Œ, ê¸°ì¡´ ì‚¬ìš©ìëŠ” ì œì™¸)
    const existingUser = await c.env.DB.prepare(
      'SELECT id, email, name, user_type, parent_user_id FROM users WHERE email = ?'
    ).bind(application.email).first()
    
    if (!existingUser) {
      // ì‹ ê·œ ì„ ìƒë‹˜ë§Œ í•œë„ ì²´í¬
      console.log('[ApproveTeacher] New teacher - checking limit')
      
      // êµ¬ë… ì¡°íšŒ
      const subscription = await c.env.DB.prepare(`
        SELECT * FROM subscriptions 
        WHERE academy_id = ? AND status = 'active'
        ORDER BY created_at DESC LIMIT 1
      `).bind(directorId).first()
      
      if (!subscription) {
        return c.json({ 
          success: false, 
          error: 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤. í”Œëœì„ ë¨¼ì € êµ¬ë…í•´ì£¼ì„¸ìš”.' 
        }, 403)
      }
      
      // í˜„ì¬ ì„ ìƒë‹˜ ìˆ˜ ì¡°íšŒ (academy_id ë˜ëŠ” parent_user_id)
      const countByAcademyId = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM users 
        WHERE academy_id = ? AND user_type = 'teacher'
      `).bind(directorId).first()
      
      const countByParentId = await c.env.DB.prepare(`
        SELECT COUNT(*) as count FROM users 
        WHERE parent_user_id = ? AND user_type = 'teacher'
      `).bind(directorId).first()
      
      const currentTeachers = Math.max(countByAcademyId?.count || 0, countByParentId?.count || 0)
      const teacherLimit = subscription.teacher_limit
      
      console.log('[ApproveTeacher] By academy_id:', countByAcademyId?.count, 'By parent_user_id:', countByParentId?.count)
      console.log('[ApproveTeacher] Current teachers:', currentTeachers, 'Limit:', teacherLimit)
      
      if (currentTeachers >= teacherLimit) {
        return c.json({ 
          success: false, 
          error: `ì„ ìƒë‹˜ ê³„ì • í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. (${currentTeachers}/${teacherLimit})\ní”Œëœì„ ì—…ê·¸ë ˆì´ë“œí•˜ê±°ë‚˜ ê¸°ì¡´ ì„ ìƒë‹˜ì„ ì‚­ì œí•´ì£¼ì„¸ìš”.`,
          currentTeachers,
          teacherLimit
        }, 403)
      }
    }
    
    let teacherId
    
    if (existingUser) {
      // ê¸°ì¡´ ì‚¬ìš©ì - í•™ì› ì—°ê²°ë§Œ ìˆ˜í–‰ (password ê°’ì— ê´€ê³„ì—†ì´)
      console.log('[ApproveTeacher] Existing user found, updating connection:', existingUser)
      
      teacherId = existingUser.id
      
      // parent_user_id, academy_id, user_type ëª¨ë‘ ì—…ë°ì´íŠ¸
      await c.env.DB.prepare(`
        UPDATE users 
        SET parent_user_id = ?, academy_name = ?, academy_id = ?, user_type = 'teacher', role = 'teacher'
        WHERE id = ?
      `).bind(directorId, director.academy_name, directorId, existingUser.id).run()
      
      console.log('[ApproveTeacher] User connected to academy')
      
    } else {
      // ì‹ ê·œ ì‚¬ìš©ì - ê³„ì • ìƒì„±
      console.log('[ApproveTeacher] New user, creating account')
      
      const userResult = await c.env.DB.prepare(`
        INSERT INTO users (
          email, password, name, phone, role, user_type,
          parent_user_id, academy_name, academy_id, created_at
        )
        VALUES (?, ?, ?, ?, 'teacher', 'teacher', ?, ?, ?, datetime('now'))
      `).bind(
        application.email,
        application.password,
        application.name,
        application.phone,
        directorId,
        director.academy_name,
        directorId
      ).run()
      
      teacherId = userResult.meta.last_row_id
      console.log('[ApproveTeacher] New teacher created with ID:', teacherId)
    }
    
    // ì‹ ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE teacher_applications 
      SET status = 'approved', processed_at = datetime('now'), processed_by = ?
      WHERE id = ?
    `).bind(directorId, applicationId).run()
    
    return c.json({ 
      success: true, 
      teacherId: teacherId,
      message: `${application.name} ì„ ìƒë‹˜ì˜ ë“±ë¡ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`
    })
  } catch (error) {
    console.error('[ApproveTeacher] Error:', error)
    console.error('[ApproveTeacher] Error message:', error.message)
    console.error('[ApproveTeacher] Error stack:', error.stack)
    return c.json({ 
      success: false, 
      error: 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      details: error.message,
      stack: error.stack
    }, 500)
  }
})

// ì›ì¥ë‹˜: ì„ ìƒë‹˜ ë“±ë¡ ì‹ ì²­ ê±°ë¶€
app.post('/api/teachers/applications/:id/reject', async (c) => {
  try {
    const applicationId = c.req.param('id')
    const { directorId, reason } = await c.req.json()
    
    if (!directorId) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // ì‹ ì²­ ì •ë³´ ì¡°íšŒ
    const application = await c.env.DB.prepare(
      'SELECT * FROM teacher_applications WHERE id = ? AND status = "pending"'
    ).bind(applicationId).first()
    
    if (!application) {
      return c.json({ success: false, error: 'ì‹ ì²­ì„ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì´ë¯¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // ì‹ ì²­ ìƒíƒœ ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE teacher_applications 
      SET status = 'rejected', processed_at = datetime('now'), 
          processed_by = ?, reject_reason = ?
      WHERE id = ?
    `).bind(directorId, reason || 'ì›ì¥ë‹˜ì— ì˜í•´ ê±°ë¶€ë¨', applicationId).run()
    
    return c.json({ 
      success: true, 
      message: `${application.name} ì„ ìƒë‹˜ì˜ ë“±ë¡ ì‹ ì²­ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.`
    })
  } catch (error) {
    console.error('Reject application error:', error)
    return c.json({ success: false, error: 'ê±°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì›ì¥ë‹˜: ì„ ìƒë‹˜ ì§ì ‘ ì¶”ê°€ (ìŠ¹ì¸ ì—†ì´ ì¦‰ì‹œ ê³„ì • ìƒì„±)
app.post('/api/teachers/add', async (c) => {
  try {
    // DB ìŠ¤í‚¤ë§ˆ ë§ˆì´ê·¸ë ˆì´ì…˜: assigned_class ì»¬ëŸ¼ ì¶”ê°€
    try {
      await c.env.DB.prepare(`
        ALTER TABLE users ADD COLUMN assigned_class TEXT
      `).run()
      console.log('[Migration] assigned_class column added to users table')
    } catch (e) {
      // ì»¬ëŸ¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì—ëŸ¬ ë¬´ì‹œ
      console.log('[Migration] assigned_class column already exists or migration skipped')
    }
    
    const { name, email, phone, assigned_class, user_id, directorId, password } = await c.req.json()
    
    // user_id ë˜ëŠ” directorId ì¤‘ í•˜ë‚˜ëŠ” ìˆì–´ì•¼ í•¨
    const userId = user_id || directorId
    
    if (!userId || !name || !email) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }
    
    // ğŸ”¥ ì„ ìƒë‹˜ ì¶”ê°€ í•œë„ ì²´í¬
    // First, get the user's academy_id and ensure it exists
    const directorRecord = await c.env.DB.prepare(`SELECT id, academy_id FROM users WHERE id = ?`).bind(userId).first()
    
    let academyIdToUse = directorRecord?.academy_id
    if (!academyIdToUse) {
      // If user doesn't have academy_id, set it to userId
      academyIdToUse = userId
      try {
        await c.env.DB.prepare(`UPDATE users SET academy_id = ? WHERE id = ?`).bind(academyIdToUse, userId).run()
        console.log('ğŸ”§ [AddTeacher] Auto-set academy_id for director:', userId)
      } catch (e) {
        console.error('Failed to set academy_id:', e)
      }
    }
    
    const activeSubscription = await c.env.DB.prepare(`
      SELECT id, teacher_limit 
      FROM subscriptions 
      WHERE academy_id = ?
        AND status = 'active' 
        AND subscription_end_date >= date('now')
      ORDER BY created_at DESC 
      LIMIT 1
    `).bind(academyIdToUse).first()
    
    if (!activeSubscription) {
      return c.json({ 
        success: false, 
        error: 'í™œì„±í™”ëœ êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤. í”Œëœì„ êµ¬ë§¤í•´ì£¼ì„¸ìš”.' 
      }, 403)
    }
    
    // ğŸ”¥ í˜„ì¬ ì„ ìƒë‹˜ ìˆ˜ ì¡°íšŒ (academy_id ë˜ëŠ” parent_user_id)
    const countByAcademyId = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM users 
      WHERE academy_id = ? AND user_type = 'teacher'
    `).bind(academyIdToUse).first()
    
    const countByParentId = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM users 
      WHERE parent_user_id = ? AND user_type = 'teacher'
    `).bind(academyIdToUse).first()
    
    const currentTeachers = Math.max(countByAcademyId?.count || 0, countByParentId?.count || 0)
    const teacherLimit = activeSubscription.teacher_limit
    
    console.log('[AddTeacher] By academy_id:', countByAcademyId?.count, 'By parent_user_id:', countByParentId?.count)
    console.log('[AddTeacher] Current teachers:', currentTeachers, 'Limit:', teacherLimit)
    
    if (currentTeachers >= teacherLimit) {
      return c.json({ 
        success: false, 
        error: `â›” ì‚¬ìš© í•œë„ê°€ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.\n\ní˜„ì¬ ì„ ìƒë‹˜ ê³„ì • ìˆ˜: ${currentTeachers}ëª… / í•œë„: ${teacherLimit}ëª…\n\në” ë§ì€ ì„ ìƒë‹˜ì„ ì¶”ê°€í•˜ì‹œë ¤ë©´ ìƒìœ„ í”Œëœìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•´ì£¼ì„¸ìš”.` 
      }, 403)
    }
    
    // ì›ì¥ë‹˜ ì •ë³´ ì¡°íšŒ
    const director = await c.env.DB.prepare(
      'SELECT id, academy_name, email FROM users WHERE id = ?'
    ).bind(userId).first()
    
    if (!director) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸
    const existingUser = await c.env.DB.prepare(
      'SELECT id, name, user_type, parent_user_id FROM users WHERE email = ?'
    ).bind(email).first()
    
    let teacherId
    
    if (existingUser) {
      // ê¸°ì¡´ ì‚¬ìš©ìê°€ ìˆìœ¼ë©´ í•™ì› ì—°ê²°
      console.log('[AddTeacher] Existing user found, connecting to academy:', existingUser)
      
      // ì´ë¯¸ ì´ í•™ì›ì˜ ì„ ìƒë‹˜ì¸ì§€ í™•ì¸
      if (existingUser.parent_user_id === parseInt(userId)) {
        return c.json({ success: false, error: 'ì´ë¯¸ ì´ í•™ì›ì˜ ì„ ìƒë‹˜ì…ë‹ˆë‹¤.' }, 400)
      }
      
      teacherId = existingUser.id
      
      // ê¸°ì¡´ ì‚¬ìš©ìë¥¼ ì´ í•™ì›ì˜ ì„ ìƒë‹˜ìœ¼ë¡œ ì—°ê²°
      await c.env.DB.prepare(`
        UPDATE users 
        SET parent_user_id = ?, academy_name = ?, academy_id = ?, user_type = 'teacher', assigned_class = ?, updated_at = datetime('now')
        WHERE id = ?
      `).bind(userId, director.academy_name, academyIdToUse, assigned_class || null, existingUser.id).run()
      
      console.log('âœ… [AddTeacher] Existing teacher connected. Total teachers:', currentTeachers + 1, '/', teacherLimit)
      
      return c.json({ 
        success: true, 
        teacherId: teacherId,
        message: `${existingUser.name || name} ì„ ìƒë‹˜ì´ ì´ í•™ì›ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        isExistingUser: true,
        usage: {
          current: currentTeachers + 1,
          limit: teacherLimit
        }
      })
    }
    
    // ì‹ ê·œ ì‚¬ìš©ì - ì„ ìƒë‹˜ ê³„ì • ìƒì„± (ë¹„ë°€ë²ˆí˜¸ëŠ” ê¸°ë³¸ê°’ ë˜ëŠ” ì œê³µëœ ê°’)
    const defaultPassword = password || 'teacher123' // ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸
    const result = await c.env.DB.prepare(`
      INSERT INTO users (
        email, password, name, phone, role, user_type, 
        parent_user_id, academy_name, academy_id, assigned_class, created_at
      )
      VALUES (?, ?, ?, ?, 'user', 'teacher', ?, ?, ?, ?, datetime('now'))
    `).bind(
      email,
      defaultPassword,
      name,
      phone || null,
      userId,
      director.academy_name,
      academyIdToUse,
      assigned_class || null
    ).run()
    
    teacherId = result.meta.last_row_id
    
    console.log('âœ… [AddTeacher] New teacher added. Total teachers:', currentTeachers + 1, '/', teacherLimit)
    
    return c.json({ 
      success: true, 
      teacherId: teacherId,
      message: `${name} ì„ ìƒë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      isExistingUser: false,
      usage: {
        current: currentTeachers + 1,
        limit: teacherLimit
      }
    })
  } catch (error) {
    console.error('Add teacher error:', error)
    return c.json({ 
      success: false, 
      error: 'ì„ ìƒë‹˜ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      details: error.message 
    }, 500)
  }
})

// ì›ì¥ë‹˜: ì¸ì¦ ì½”ë“œ ìƒì„±/ì¡°íšŒ
app.get('/api/teachers/verification-code', async (c) => {
  try {
    const directorId = c.req.query('directorId')
    
    if (!directorId) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    console.log('[VerificationCode] GET request for directorId:', directorId)
    
    // í…Œì´ë¸” ì¡´ì¬ í™•ì¸ ë° ìë™ ìƒì„±
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS academy_verification_codes (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          code TEXT NOT NULL UNIQUE,
          is_active INTEGER DEFAULT 1,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          expires_at DATETIME,
          FOREIGN KEY (user_id) REFERENCES users(id)
        )
      `).run()
      
      await c.env.DB.prepare(`
        CREATE INDEX IF NOT EXISTS idx_verification_codes_user ON academy_verification_codes(user_id)
      `).run()
      
      await c.env.DB.prepare(`
        CREATE INDEX IF NOT EXISTS idx_verification_codes_code ON academy_verification_codes(code)
      `).run()
      
      console.log('[VerificationCode] Table and indexes ensured')
    } catch (tableError) {
      console.log('[VerificationCode] Table already exists or creation skipped')
    }
    
    // ì›ì¥ë‹˜ ì •ë³´ ë¨¼ì € ì¡°íšŒ
    const director = await c.env.DB.prepare(
      'SELECT id, academy_name, email FROM users WHERE id = ?'
    ).bind(directorId).first()
    
    if (!director) {
      console.error('[VerificationCode] Director not found:', directorId)
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    console.log('[VerificationCode] Director found:', director)
    
    // ê¸°ì¡´ í™œì„± ì½”ë“œ ì¡°íšŒ
    let codeData = null
    try {
      codeData = await c.env.DB.prepare(
        'SELECT * FROM academy_verification_codes WHERE user_id = ? AND is_active = 1 ORDER BY created_at DESC LIMIT 1'
      ).bind(directorId).first()
    } catch (selectError) {
      console.log('[VerificationCode] SELECT error (table might not exist):', selectError)
    }
    
    console.log('[VerificationCode] Existing code:', codeData)
    
    // ì½”ë“œê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ìƒì„±
    if (!codeData || (!codeData.code && !codeData.verification_code)) {
      console.log('[VerificationCode] Creating new code for director:', directorId)
      
      // 6ìë¦¬ ëœë¤ ì½”ë“œ ìƒì„± (ì˜ë¬¸ ëŒ€ë¬¸ì + ìˆ«ì)
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
      let newCode = ''
      for (let i = 0; i < 6; i++) {
        newCode += chars.charAt(Math.floor(Math.random() * chars.length))
      }
      
      console.log('[VerificationCode] Generated new code:', newCode)
      
      try {
        const result = await c.env.DB.prepare(`
          INSERT INTO academy_verification_codes (user_id, code, is_active, created_at)
          VALUES (?, ?, 1, datetime('now'))
        `).bind(directorId, newCode).run()
        
        console.log('[VerificationCode] Insert result:', result)
        
        codeData = {
          id: result.meta.last_row_id,
          user_id: parseInt(directorId),
          code: newCode,
          is_active: 1,
          created_at: new Date().toISOString()
        }
      } catch (insertError) {
        console.error('[VerificationCode] Insert error:', insertError)
        throw insertError
      }
    }
    
    const responseCode = codeData.code || codeData.verification_code || 'ERROR'
    console.log('[VerificationCode] Final response code:', responseCode)
    
    return c.json({ 
      success: true, 
      code: responseCode,
      codeData: codeData,
      debug: {
        directorId: directorId,
        directorEmail: director.email,
        hasCode: !!codeData,
        codeValue: responseCode
      }
    })
  } catch (error) {
    console.error('[VerificationCode] Error:', error)
    return c.json({ 
      success: false, 
      error: 'ì¸ì¦ ì½”ë“œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 
      details: error.message,
      stack: error.stack
    }, 500)
  }
})

// ì›ì¥ë‹˜: ì¸ì¦ ì½”ë“œ ì¬ìƒì„±
app.post('/api/teachers/verification-code/regenerate', async (c) => {
  try {
    const { directorId } = await c.req.json()
    
    if (!directorId) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    console.log('[RegenerateCode] POST request for directorId:', directorId)
    
    const director = await c.env.DB.prepare(
      'SELECT id, academy_name, email FROM users WHERE id = ?'
    ).bind(directorId).first()
    
    if (!director) {
      console.error('[RegenerateCode] Director not found:', directorId)
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    console.log('[RegenerateCode] Director found:', director)
    
    // ê¸°ì¡´ ì½”ë“œ ë¹„í™œì„±í™”
    await c.env.DB.prepare(
      'UPDATE academy_verification_codes SET is_active = 0 WHERE user_id = ?'
    ).bind(directorId).run()
    
    // 6ìë¦¬ ëœë¤ ì½”ë“œ ìƒì„± (ì˜ë¬¸ ëŒ€ë¬¸ì + ìˆ«ì)
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
    let newCode = ''
    for (let i = 0; i < 6; i++) {
      newCode += chars.charAt(Math.floor(Math.random() * chars.length))
    }
    
    console.log('[RegenerateCode] Generated new code:', newCode)
    
    const result = await c.env.DB.prepare(`
      INSERT INTO academy_verification_codes (user_id, code, is_active, created_at)
      VALUES (?, ?, 1, datetime('now'))
    `).bind(directorId, newCode).run()
    
    console.log('[RegenerateCode] Insert result:', result)
    
    return c.json({ 
      success: true, 
      code: newCode,
      codeData: {
        id: result.meta.last_row_id,
        code: newCode,
        verification_code: newCode,
        user_id: parseInt(directorId),
        is_active: 1,
        created_at: new Date().toISOString()
      },
      message: 'ìƒˆë¡œìš´ ì¸ì¦ ì½”ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.',
      debug: {
        directorId: directorId,
        directorEmail: director.email,
        newCode: newCode
      }
    })
  } catch (error) {
    console.error('[RegenerateCode] Error:', error)
    return c.json({ 
      success: false, 
      error: 'ì¸ì¦ ì½”ë“œ ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 
      details: error.message,
      stack: error.stack
    }, 500)
  }
})

// ì›ì¥ë‹˜: ì„ ìƒë‹˜ ê³„ì • ìƒì„±
app.post('/api/teachers/create', async (c) => {
  try {
    const { email, password, name, phone, directorId } = await c.req.json()
    
    // í•„ìˆ˜ í•„ë“œ í™•ì¸
    if (!email || !password || !name || !directorId) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }
    
    // ì›ì¥ë‹˜ ì •ë³´ í™•ì¸ (academy_id í¬í•¨)
    const director = await c.env.DB.prepare(
      'SELECT id, academy_id, academy_name, user_type FROM users WHERE id = ?'
    ).bind(directorId).first()
    
    if (!director) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    console.log('ğŸ« [CreateTeacher] Director info:', {
      id: director.id,
      academy_id: director.academy_id,
      academy_name: director.academy_name,
      user_type: director.user_type
    })
    
    // ì´ë©”ì¼ ì¤‘ë³µ í™•ì¸
    const existing = await c.env.DB.prepare(
      'SELECT id FROM users WHERE email = ?'
    ).bind(email).first()
    
    if (existing) {
      return c.json({ success: false, error: 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.' }, 400)
    }
    
    // âœ… ì„ ìƒë‹˜ ê³„ì • ìƒì„± - ì›ì¥ë‹˜ì˜ academy_idë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬
    const result = await c.env.DB.prepare(`
      INSERT INTO users (email, password, name, phone, role, user_type, parent_user_id, academy_id, academy_name, created_at)
      VALUES (?, ?, ?, ?, 'user', 'teacher', ?, ?, ?, datetime('now'))
    `).bind(email, password, name, phone || null, directorId, director.academy_id, director.academy_name).run()
    
    console.log('âœ… [CreateTeacher] Teacher created with academy_id:', director.academy_id)
    
    return c.json({ 
      success: true, 
      teacherId: result.meta.last_row_id,
      message: 'ì„ ìƒë‹˜ ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error) {
    console.error('Create teacher error:', error)
    return c.json({ success: false, error: 'ì„ ìƒë‹˜ ê³„ì • ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì›ì¥ë‹˜: ì†Œì† ì„ ìƒë‹˜ ëª©ë¡ ì¡°íšŒ
app.get('/api/teachers/list', async (c) => {
  try {
    const directorId = c.req.query('directorId')
    
    if (!directorId) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    const teachers = await c.env.DB.prepare(`
      SELECT id, email, name, phone, created_at
      FROM users 
      WHERE parent_user_id = ? AND user_type = 'teacher'
      ORDER BY created_at DESC
    `).bind(directorId).all()
    
    return c.json({ success: true, teachers: teachers.results || [] })
  } catch (error) {
    console.error('[TeachersList] Error:', error)
    console.error('[TeachersList] Error message:', error.message)
    console.error('[TeachersList] Error stack:', error.stack)
    return c.json({ 
      success: false, 
      error: 'ì„ ìƒë‹˜ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      details: error.message
    }, 500)
  }
})

// GET /api/teachers - ì„ ìƒë‹˜ ëª©ë¡ ì¡°íšŒ (userIdë¡œ)
app.get('/api/teachers', async (c) => {
  try {
    const userId = c.req.query('userId')
    
    if (!userId) {
      return c.json({ success: false, error: 'userIdê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // ì„ ìƒë‹˜ ëª©ë¡ ì¡°íšŒ (assigned_class í¬í•¨)
    const teachers = await c.env.DB.prepare(`
      SELECT 
        id, 
        email, 
        name, 
        phone, 
        assigned_class,
        0 as student_count,
        created_at
      FROM users 
      WHERE parent_user_id = ? AND user_type = 'teacher'
      ORDER BY created_at DESC
    `).bind(userId).all()
    
    return c.json({ success: true, teachers: teachers.results || [] })
  } catch (error) {
    console.error('[Teachers] Error:', error)
    return c.json({ 
      success: false, 
      error: 'ì„ ìƒë‹˜ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      details: error.message
    }, 500)
  }
})

// POST /api/teachers/:id/assign-class - ë°˜ ë°°ì •
app.post('/api/teachers/:id/assign-class', async (c) => {
  try {
    const teacherId = c.req.param('id')
    const { assigned_class } = await c.req.json()
    
    if (!teacherId || !assigned_class) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.' }, 400)
    }
    
    // ë°˜ ë°°ì • ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE users 
      SET assigned_class = ?
      WHERE id = ? AND user_type = 'teacher'
    `).bind(assigned_class, teacherId).run()
    
    return c.json({ 
      success: true, 
      message: 'ë°˜ ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' 
    })
  } catch (error) {
    console.error('[AssignClass] Error:', error)
    return c.json({ 
      success: false, 
      error: 'ë°˜ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      details: error.message
    }, 500)
  }
})

// DELETE /api/teachers/:id - ì„ ìƒë‹˜ ì‚­ì œ
app.delete('/api/teachers/:id', async (c) => {
  try {
    const teacherId = c.req.param('id')
    
    if (!teacherId) {
      return c.json({ success: false, error: 'ì„ ìƒë‹˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // ì„ ìƒë‹˜ ì‚­ì œ (ì‹¤ì œë¡œëŠ” parent_user_idë¥¼ NULLë¡œ ì„¤ì •)
    await c.env.DB.prepare(`
      UPDATE users 
      SET parent_user_id = NULL, user_type = 'user', assigned_class = NULL
      WHERE id = ? AND user_type = 'teacher'
    `).bind(teacherId).run()
    
    return c.json({ 
      success: true, 
      message: 'ì„ ìƒë‹˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' 
    })
  } catch (error) {
    console.error('[DeleteTeacher] Error:', error)
    return c.json({ 
      success: false, 
      error: 'ì„ ìƒë‹˜ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      details: error.message
    }, 500)
  }
})

// ì„ ìƒë‹˜ ê¶Œí•œ ì¡°íšŒ
app.get('/api/teachers/:id/permissions', async (c) => {
  try {
    const teacherId = c.req.param('id')
    const directorId = c.req.query('directorId')
    
    console.log('ğŸ” [GetPermissions] teacherId:', teacherId, 'directorId:', directorId)
    
    if (!directorId) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // ì„ ìƒë‹˜ ì •ë³´ ì¡°íšŒ
    const teacher = await c.env.DB.prepare(
      'SELECT id, name, email, user_type, parent_user_id FROM users WHERE id = ?'
    ).bind(teacherId).first()
    
    if (!teacher) {
      console.error('âŒ [GetPermissions] Teacher not found:', teacherId)
      return c.json({ success: false, error: 'ì„ ìƒë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    console.log('âœ… [GetPermissions] Teacher found:', teacher)
    
    // user_typeì´ teacherì¸ì§€ í™•ì¸
    if (teacher.user_type !== 'teacher') {
      return c.json({ success: false, error: 'ì„ ìƒë‹˜ ê³„ì •ì´ ì•„ë‹™ë‹ˆë‹¤.' }, 400)
    }
    
    // parent_user_idê°€ directorIdì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸ (ìˆëŠ” ê²½ìš°ë§Œ)
    if (teacher.parent_user_id && teacher.parent_user_id !== parseInt(directorId)) {
      console.error('âŒ [GetPermissions] Permission denied:', teacher.parent_user_id, '!=', directorId)
      return c.json({ success: false, error: 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
    }
    
    // teacher_permissions í…Œì´ë¸”ì—ì„œ ê¶Œí•œ ì¡°íšŒ
    const rows = await c.env.DB.prepare(
      'SELECT permission_key, permission_value FROM teacher_permissions WHERE teacher_id = ?'
    ).bind(teacherId).all()
    
    console.log('ğŸ“‹ [GetPermissions] Found permission rows:', rows.results?.length || 0)
    
    // ê¸°ë³¸ ê¶Œí•œ ê°ì²´
    const permissions = {
      canViewAllStudents: false,
      canWriteDailyReports: false,
      assignedClasses: []
    }
    
    // ì €ì¥ëœ ê¶Œí•œ ì ìš©
    if (rows.results) {
      for (const row of rows.results) {
        const key = row.permission_key
        const value = row.permission_value
        
        // JSON ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹±
        if (key === 'assignedClasses' && typeof value === 'string') {
          try {
            permissions[key] = JSON.parse(value)
            console.log('ğŸ”„ [GetPermissions] Parsed JSON:', key, '=', permissions[key])
          } catch (e) {
            console.error('âŒ [GetPermissions] JSON parse error:', e)
            permissions[key] = []
          }
        } else if (typeof value === 'string' && (value === '1' || value === '0')) {
          permissions[key] = value === '1'
        } else if (typeof value === 'number') {
          permissions[key] = value === 1
        } else {
          permissions[key] = !!value
        }
        
        console.log('â¡ï¸ [GetPermissions] Permission:', key, '=', permissions[key])
      }
    }
    
    console.log('âœ… [GetPermissions] Final permissions:', permissions)
    
    return c.json({ 
      success: true, 
      teacher: {
        id: teacher.id,
        name: teacher.name,
        email: teacher.email
      },
      permissions
    })
  } catch (error) {
    console.error('âŒ [GetPermissions] Error:', error)
    console.error('âŒ [GetPermissions] Stack:', error.stack)
    return c.json({ 
      success: false, 
      error: 'ê¶Œí•œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      details: error.message
    }, 500)
  }
})

// ì„ ìƒë‹˜ ê¶Œí•œ ì €ì¥
app.post('/api/teachers/:id/permissions', async (c) => {
  try {
    const teacherId = c.req.param('id')
    const { directorId, permissions } = await c.req.json()
    
    console.log('ğŸ“ [SaveTeacherPermissions] teacherId:', teacherId, 'directorId:', directorId)
    console.log('ğŸ“ [SaveTeacherPermissions] permissions:', permissions)
    
    if (!directorId) {
      return c.json({ success: false, error: 'ì›ì¥ë‹˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // ì„ ìƒë‹˜ í™•ì¸
    const teacher = await c.env.DB.prepare(
      'SELECT id, user_type, parent_user_id FROM users WHERE id = ?'
    ).bind(teacherId).first()
    
    if (!teacher) {
      return c.json({ success: false, error: 'ì„ ìƒë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // user_typeì´ teacherì¸ì§€ í™•ì¸
    if (teacher.user_type !== 'teacher') {
      return c.json({ success: false, error: 'ì„ ìƒë‹˜ ê³„ì •ì´ ì•„ë‹™ë‹ˆë‹¤.' }, 400)
    }
    
    // parent_user_idê°€ directorIdì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
    if (teacher.parent_user_id && teacher.parent_user_id !== parseInt(directorId)) {
      return c.json({ success: false, error: 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
    }
    
    console.log('âœ… [SaveTeacherPermissions] Teacher verified:', teacher)
    
    // teacher_permissions í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„±
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS teacher_permissions (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          teacher_id INTEGER NOT NULL,
          permission_key TEXT NOT NULL,
          permission_value TEXT,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (teacher_id) REFERENCES users(id),
          UNIQUE(teacher_id, permission_key)
        )
      `).run()
      console.log('âœ… [SaveTeacherPermissions] Table ensured')
    } catch (tableError) {
      console.error('âš ï¸ [SaveTeacherPermissions] Table creation warning:', tableError.message)
    }
    
    // ê¸°ì¡´ ê¶Œí•œ ì‚­ì œ
    await c.env.DB.prepare(
      'DELETE FROM teacher_permissions WHERE teacher_id = ?'
    ).bind(teacherId).run()
    
    console.log('ğŸ—‘ï¸ [SaveTeacherPermissions] Old permissions deleted')
    
    // ìƒˆ ê¶Œí•œ ì‚½ì…
    if (permissions && typeof permissions === 'object') {
      for (const [key, value] of Object.entries(permissions)) {
        let permissionValue: string | number = value
        
        // ë°°ì—´ì¸ ê²½ìš° JSON ë¬¸ìì—´ë¡œ ë³€í™˜
        if (Array.isArray(value)) {
          permissionValue = JSON.stringify(value)
          console.log('ğŸ”„ [SaveTeacherPermissions] Converting array to JSON:', key, '=', permissionValue)
        } else if (typeof value === 'boolean') {
          permissionValue = value ? 1 : 0
        } else if (typeof value === 'string') {
          permissionValue = value
        } else {
          permissionValue = value ? 1 : 0
        }
        
        await c.env.DB.prepare(`
          INSERT INTO teacher_permissions (teacher_id, permission_key, permission_value, created_at, updated_at)
          VALUES (?, ?, ?, datetime('now'), datetime('now'))
        `).bind(teacherId, key, permissionValue).run()
        
        console.log('â• [SaveTeacherPermissions] Added permission:', key, '=', permissionValue)
      }
    }
    
    console.log('âœ… [SaveTeacherPermissions] All permissions saved successfully')
    
    return c.json({ 
      success: true, 
      message: 'ê¶Œí•œì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error) {
    console.error('âŒ [SaveTeacherPermissions] Error:', error)
    console.error('âŒ [SaveTeacherPermissions] Stack:', error.stack)
    return c.json({ 
      success: false, 
      error: 'ê¶Œí•œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message
    }, 500)
  }
})

// ì›ì¥ë‹˜: ë°˜ ìƒì„±
app.post('/api/classes/create', async (c) => {
  try {
    const { name, description, userId, teacherId, gradeLevel, subject, maxStudents } = await c.req.json()
    
    if (!name || !userId) {
      return c.json({ success: false, error: 'ë°˜ ì´ë¦„ê³¼ ì›ì¥ë‹˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // classes í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„±
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS classes (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          name TEXT NOT NULL,
          description TEXT,
          user_id INTEGER NOT NULL,
          teacher_id INTEGER,
          grade_level TEXT,
          subject TEXT,
          max_students INTEGER DEFAULT 20,
          status TEXT DEFAULT 'active',
          created_at TEXT NOT NULL,
          updated_at TEXT,
          FOREIGN KEY (user_id) REFERENCES users(id),
          FOREIGN KEY (teacher_id) REFERENCES users(id)
        )
      `).run()
    } catch (tableError) {
      console.error('Create classes table error:', tableError)
    }
    
    const result = await c.env.DB.prepare(`
      INSERT INTO classes (name, description, user_id, teacher_id, grade_level, subject, max_students, status, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, 'active', datetime('now'))
    `).bind(name, description || null, userId, teacherId || null, gradeLevel || null, subject || null, maxStudents || 20).run()
    
    return c.json({ 
      success: true, 
      classId: result.meta.last_row_id,
      message: 'ë°˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error) {
    console.error('Create class error:', error)
    return c.json({ 
      success: false, 
      error: 'ë°˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
      details: error.message 
    }, 500)
  }
})

// ì›ì¥ë‹˜/ì„ ìƒë‹˜: ë°˜ ëª©ë¡ ì¡°íšŒ
app.get('/api/classes/list', async (c) => {
  try {
    const userId = c.req.query('userId')
    const userType = c.req.query('userType')
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // classes í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
    try {
      let query = ''
      // ì›ì¥ë‹˜ì€ academy_idë¡œ ëª¨ë“  ë°˜ ì¡°íšŒ (teacher_id ì œê±°)
      query = `
        SELECT c.id, c.class_name as name, c.grade as grade_level, c.description, 
               c.created_at,
               (SELECT COUNT(*) FROM students WHERE class_id = c.id AND status = 'active') as student_count
        FROM classes c
        WHERE c.academy_id = ?
        ORDER BY c.created_at DESC
      `
      
      const classes = await c.env.DB.prepare(query).bind(userId).all()
      
      return c.json({ success: true, classes: classes.results || [] })
    } catch (tableError) {
      // í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ë°˜í™˜
      if (tableError.message && tableError.message.includes('no such table')) {
        return c.json({ success: true, classes: [] })
      }
      throw tableError
    }
  } catch (error) {
    console.error('[ClassesList] Error:', error)
    console.error('[ClassesList] Error message:', error.message)
    return c.json({ 
      success: true,  // ì—ëŸ¬ì—¬ë„ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬í•˜ê³  ë¹ˆ ë°°ì—´ ë°˜í™˜
      classes: [],
      warning: 'ë°˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°˜ì„ ìƒì„±í•´ì£¼ì„¸ìš”.',
      debug: error.message
    })
  }
})

// ì›ì¥ë‹˜: ë°˜ì— ì„ ìƒë‹˜ ë°°ì •
app.put('/api/classes/:id/assign-teacher', async (c) => {
  try {
    const classId = c.req.param('id')
    const { teacherId, userId } = await c.req.json()
    
    // ì›ì¥ë‹˜ ê¶Œí•œ í™•ì¸
    const classInfo = await c.env.DB.prepare(
      'SELECT user_id FROM classes WHERE id = ?'
    ).bind(classId).first()
    
    if (!classInfo || classInfo.user_id !== userId) {
      return c.json({ success: false, error: 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
    }
    
    // ì„ ìƒë‹˜ ë°°ì •
    await c.env.DB.prepare(
      'UPDATE classes SET teacher_id = ?, updated_at = datetime(\'now\') WHERE id = ?'
    ).bind(teacherId, classId).run()
    
    return c.json({ success: true, message: 'ì„ ìƒë‹˜ì´ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error) {
    console.error('Assign teacher error:', error)
    return c.json({ success: false, error: 'ì„ ìƒë‹˜ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ë°˜ ëª©ë¡ ì¡°íšŒ (í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œìš©) - ì™„ì „ ì¬ì‘ì„±
app.get('/api/classes', async (c) => {
  console.log('\nğŸ” [GetClasses] ==========================================')
  console.log('ğŸ” [GetClasses] Request started')
  
  try {
    // Step 1: DB ì—°ê²° í™•ì¸
    if (!c.env.DB) {
      console.error('âŒ [GetClasses] FATAL: DB not available')
      return c.json({ success: false, error: 'DB ì—°ê²° ì‹¤íŒ¨' }, 500)
    }
    console.log('âœ… [GetClasses] DB connection OK')
    
    // Step 2: userId ì¶”ì¶œ
    let userId = c.req.query('academyId') || c.req.query('userId')
    console.log('ğŸ” [GetClasses] Query params - userId:', userId)
    
    // Step 3: í—¤ë”ì—ì„œ ì¶”ì¶œ ì‹œë„
    const userHeader = c.req.header('X-User-Data-Base64')
    console.log('ğŸ” [GetClasses] Header present:', !!userHeader)
    
    if (userHeader && !userId) {
      try {
        const decoded = atob(userHeader)
        console.log('ğŸ” [GetClasses] Header decoded (first 100 chars):', decoded.substring(0, 100))
        const userData = JSON.parse(decoded)
        userId = userData.id || userData.academy_id
        console.log('ğŸ” [GetClasses] Extracted from header - userId:', userId)
      } catch (parseErr) {
        console.error('âŒ [GetClasses] Header parse failed:', parseErr.message)
      }
    }
    
    if (!userId) {
      console.error('âŒ [GetClasses] No userId found')
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    console.log('ğŸ” [GetClasses] Final userId:', userId)
    
    // Step 4: ê°€ì¥ ë‹¨ìˆœí•œ ì¿¼ë¦¬ë¡œ ì‹œì‘ - classes í…Œì´ë¸”ë§Œ
    let classes = []
    
    // Try 1: academy_id í•„ë“œë¡œ ì¡°íšŒ
    try {
      console.log('ğŸ” [GetClasses] Attempting: SELECT * FROM classes WHERE academy_id =', userId)
      const result1 = await c.env.DB.prepare(
        'SELECT * FROM classes WHERE academy_id = ? ORDER BY id DESC'
      ).bind(userId).all()
      
      classes = result1.results || []
      console.log('âœ… [GetClasses] SUCCESS with academy_id! Found', classes.length, 'classes')
      
      if (classes.length > 0) {
        console.log('âœ… [GetClasses] First class:', JSON.stringify(classes[0]))
      }
    } catch (err1) {
      console.log('âš ï¸  [GetClasses] academy_id failed:', err1.message)
      
      // Try 2: user_id í•„ë“œë¡œ ì¡°íšŒ
      try {
        console.log('ğŸ” [GetClasses] Attempting: SELECT * FROM classes WHERE user_id =', userId)
        const result2 = await c.env.DB.prepare(
          'SELECT * FROM classes WHERE user_id = ? ORDER BY id DESC'
        ).bind(userId).all()
        
        classes = result2.results || []
        console.log('âœ… [GetClasses] SUCCESS with user_id! Found', classes.length, 'classes')
        
        if (classes.length > 0) {
          console.log('âœ… [GetClasses] First class:', JSON.stringify(classes[0]))
        }
      } catch (err2) {
        console.log('âš ï¸  [GetClasses] user_id failed:', err2.message)
        
        // Try 3: ëª¨ë“  classes ì¡°íšŒ (í•„í„°ë§ ì—†ì´)
        try {
          console.log('ğŸ” [GetClasses] Attempting: SELECT * FROM classes (all)')
          const result3 = await c.env.DB.prepare(
            'SELECT * FROM classes ORDER BY id DESC LIMIT 100'
          ).all()
          
          classes = result3.results || []
          console.log('âœ… [GetClasses] Got all classes:', classes.length)
          
          // í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„í„°ë§í•˜ë„ë¡ ëª¨ë‘ ë°˜í™˜
          if (classes.length > 0) {
            console.log('âœ… [GetClasses] First class fields:', Object.keys(classes[0]))
          }
        } catch (err3) {
          console.error('âŒ [GetClasses] ALL queries failed!')
          console.error('âŒ [GetClasses] Error 1 (academy_id):', err1.message)
          console.error('âŒ [GetClasses] Error 2 (user_id):', err2.message)
          console.error('âŒ [GetClasses] Error 3 (all):', err3.message)
          throw err3
        }
      }
    }
    
    // Step 5: í•™ìƒ ìˆ˜ ì¶”ê°€ (ì˜µì…˜)
    for (const cls of classes) {
      try {
        const countResult = await c.env.DB.prepare(
          "SELECT COUNT(*) as cnt FROM students WHERE class_id = ? AND status = 'active'"
        ).bind(cls.id).first()
        cls.student_count = countResult?.cnt || 0
      } catch (countErr) {
        console.log('âš ï¸  [GetClasses] Student count failed for class', cls.id)
        cls.student_count = 0
      }
    }
    
    console.log('âœ… [GetClasses] Returning', classes.length, 'classes with student counts')
    console.log('ğŸ” [GetClasses] ==========================================\n')
    
    return c.json({ 
      success: true, 
      classes,
      debug: {
        userId,
        count: classes.length
      }
    })
    
  } catch (error) {
    console.error('âŒ [GetClasses] FATAL ERROR:', error)
    console.error('âŒ [GetClasses] Message:', error.message)
    console.error('âŒ [GetClasses] Stack:', error.stack)
    console.log('ğŸ” [GetClasses] ==========================================\n')
    
    return c.json({ 
      success: false, 
      error: 'ë°˜ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + error.message,
      stack: error.stack
    }, 500)
  }
})

// ë°˜ ì¶”ê°€
app.post('/api/classes', async (c) => {
  try {
    let { academyId, userId, className, grade, description, scheduleDays, startTime, endTime, color, daySchedule } = await c.req.json()
    
    console.log('â• [CreateClass] Received payload:', { academyId, userId, className, color, daySchedule })
    
    // academyId ë˜ëŠ” userId ì‚¬ìš© (í˜¸í™˜ì„±)
    userId = userId || academyId
    
    // X-User-Data-Base64 í—¤ë”ì—ì„œ user_id ì¶”ì¶œ
    const userHeader = c.req.header('X-User-Data-Base64')
    console.log('â• [CreateClass] Header present:', !!userHeader)
    
    if (userHeader && !userId) {
      try {
        const userData = JSON.parse(decodeURIComponent(escape(atob(userHeader))))
        userId = userData.id
        console.log('â• [CreateClass] Extracted userId from header:', userId)
      } catch (err) {
        console.error('[CreateClass] Failed to parse user header:', err)
      }
    }
    
    console.log('â• [CreateClass] Final userId:', userId)
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    if (!className) {
      return c.json({ success: false, error: 'ë°˜ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.' }, 400)
    }
    
    console.log('â• [CreateClass] Creating class for academy_id:', userId, 'name:', className)
    
    // ğŸ”§ ìŠ¤í‚¤ë§ˆ í˜¸í™˜ì„±: color, day_schedule ì»¬ëŸ¼ì´ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ try-catch
    let result
    try {
      // color, day_schedule ì»¬ëŸ¼ì´ ìˆëŠ” ê²½ìš°
      result = await c.env.DB.prepare('INSERT INTO classes (academy_id, class_name, grade, description, schedule_days, start_time, end_time, color, day_schedule, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, datetime(\'now\'))').bind(userId, className, grade || null, description || null, scheduleDays || null, startTime || null, endTime || null, color || '#8B5CF6', daySchedule || null).run()
    } catch (err) {
      console.log('âš ï¸ [CreateClass] new columns not found, trying without them')
      // ê¸°ë³¸ ì»¬ëŸ¼ë§Œ ì‚¬ìš©
      try {
        result = await c.env.DB.prepare('INSERT INTO classes (academy_id, class_name, grade, description, schedule_days, start_time, end_time, created_at) VALUES (?, ?, ?, ?, ?, ?, ?, datetime(\'now\'))').bind(userId, className, grade || null, description || null, scheduleDays || null, startTime || null, endTime || null).run()
      } catch (err2) {
        result = await c.env.DB.prepare('INSERT INTO classes (academy_id, class_name, grade, description, created_at) VALUES (?, ?, ?, ?, datetime(\'now\'))').bind(userId, className, grade || null, description || null).run()
      }
    }
    
    console.log('âœ… [CreateClass] Class created with id:', result.meta.last_row_id)
    
    return c.json({ success: true, classId: result.meta.last_row_id, message: 'ë°˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error) {
    console.error('âŒ [CreateClass] Error:', error)
    console.error('âŒ [CreateClass] Error stack:', error.stack)
    return c.json({ success: false, error: 'ë°˜ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', details: error.message }, 500)
  }
})

// ë°˜ ìˆ˜ì •
app.put('/api/classes/:id', async (c) => {
  try {
    const classId = c.req.param('id')
    const { className, grade, description, scheduleDays, startTime, endTime, color, daySchedule } = await c.req.json()
    
    console.log('ğŸ”§ [UpdateClass] Received classId:', classId, 'className:', className, 'color:', color)
    
    if (!className) {
      return c.json({ success: false, error: 'ë°˜ ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.' }, 400)
    }
    
    // ë°˜ì´ ì¡´ì¬í•˜ëŠ”ì§€ë§Œ í™•ì¸
    const classCheck = await c.env.DB.prepare('SELECT id FROM classes WHERE id = ?').bind(classId).first()
    
    if (!classCheck) {
      return c.json({ success: false, error: 'ë°˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // ë°˜ ìˆ˜ì • (academy_id ì¡°ê±´ ì—†ì´)
    let result
    try {
      // color, day_schedule ì»¬ëŸ¼ì´ ìˆëŠ” ê²½ìš°
      result = await c.env.DB.prepare('UPDATE classes SET class_name = ?, grade = ?, description = ?, schedule_days = ?, start_time = ?, end_time = ?, color = ?, day_schedule = ? WHERE id = ?').bind(className, grade || null, description || null, scheduleDays || null, startTime || null, endTime || null, color || '#8B5CF6', daySchedule || null, classId).run()
    } catch (err) {
      console.log('âš ï¸ [UpdateClass] new columns not found, trying without them')
      // ê¸°ë³¸ ì»¬ëŸ¼ë§Œ ì‚¬ìš©
      try {
        result = await c.env.DB.prepare('UPDATE classes SET class_name = ?, grade = ?, description = ?, schedule_days = ?, start_time = ?, end_time = ? WHERE id = ?').bind(className, grade || null, description || null, scheduleDays || null, startTime || null, endTime || null, classId).run()
      } catch (err2) {
        result = await c.env.DB.prepare('UPDATE classes SET class_name = ?, grade = ?, description = ? WHERE id = ?').bind(className, grade || null, description || null, classId).run()
      }
    }
    
    if (result.meta.changes === 0) {
      return c.json({ success: false, error: 'ë°˜ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' }, 400)
    }
    
    console.log('âœ… [UpdateClass] Class updated successfully')
    return c.json({ success: true, message: 'ë°˜ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error) {
    console.error('Update class error:', error)
    return c.json({ success: false, error: 'ë°˜ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ë°˜ ì‚­ì œ
app.delete('/api/classes/:id', async (c) => {
  try {
    const classId = c.req.param('id')
    
    console.log('ğŸ—‘ï¸ [DeleteClass] ==================== START ====================')
    console.log('ğŸ—‘ï¸ [DeleteClass] Deleting class ID:', classId)
    
    if (!classId) {
      console.error('ğŸ—‘ï¸ [DeleteClass] âŒ No class ID')
      return c.json({ success: false, error: 'ë°˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    // 1. ë°˜ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    const classExists = await c.env.DB.prepare(
      'SELECT id, class_name FROM classes WHERE id = ?'
    ).bind(classId).first()
    
    if (!classExists) {
      console.error('ğŸ—‘ï¸ [DeleteClass] âŒ Class not found')
      return c.json({ success: false, error: 'ë°˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    console.log('ğŸ—‘ï¸ [DeleteClass] Found class:', classExists.class_name)
    
    // 2. í•™ìƒë“¤ì˜ class_id ì—…ë°ì´íŠ¸ (ë‹¨ì¼ ê°’ë§Œ ì²˜ë¦¬)
    try {
      const updateResult = await c.env.DB.prepare(
        'UPDATE students SET class_id = NULL WHERE class_id = ?'
      ).bind(classId).run()
      
      console.log('ğŸ—‘ï¸ [DeleteClass] Updated', updateResult.meta.changes, 'students')
    } catch (err) {
      console.error('ğŸ—‘ï¸ [DeleteClass] âš ï¸ Student update error:', err.message)
      // í•™ìƒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰
    }
    
    // 3. ë°˜ ì‚­ì œ
    try {
      const deleteResult = await c.env.DB.prepare(
        'DELETE FROM classes WHERE id = ?'
      ).bind(classId).run()
      
      console.log('ğŸ—‘ï¸ [DeleteClass] Delete changes:', deleteResult.meta.changes)
      
      if (deleteResult.meta.changes === 0) {
        return c.json({ success: false, error: 'ë°˜ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' }, 400)
      }
      
      console.log('ğŸ—‘ï¸ [DeleteClass] âœ… SUCCESS')
      return c.json({ success: true, message: 'ë°˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' })
      
    } catch (err) {
      console.error('ğŸ—‘ï¸ [DeleteClass] âŒ Delete error:', err)
      return c.json({ 
        success: false, 
        error: 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + err.message 
      }, 500)
    }
    
  } catch (error) {
    console.error('ğŸ—‘ï¸ [DeleteClass] âŒ Fatal error:', error)
    return c.json({ 
      success: false, 
      error: 'ë°˜ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message 
    }, 500)
  }
})

// ì¼ì¼ ì„±ê³¼ ê¸°ë¡ ì¡°íšŒ
app.get('/api/daily-records', async (c) => {
  try {
    const studentId = c.req.query('studentId')
    const date = c.req.query('date')
    const startDate = c.req.query('startDate')
    const endDate = c.req.query('endDate')
    
    let query = 'SELECT * FROM daily_records WHERE 1=1'
    const params = []
    
    if (studentId) {
      query += ' AND student_id = ?'
      params.push(studentId)
    }
    
    if (date) {
      query += ' AND record_date = ?'
      params.push(date)
    } else if (startDate && endDate) {
      query += ' AND record_date BETWEEN ? AND ?'
      params.push(startDate, endDate)
    }
    
    query += ' ORDER BY record_date DESC, id DESC'
    
    const result = await c.env.DB.prepare(query).bind(...params).all()
    
    return c.json({ success: true, records: result.results || [] })
  } catch (error) {
    console.error('Get daily records error:', error)
    return c.json({ success: false, error: 'ì¼ì¼ ì„±ê³¼ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì¼ì¼ ì„±ê³¼ ê¸°ë¡ ì¶”ê°€
app.post('/api/daily-records', async (c) => {
  try {
    const data = await c.req.json()
    const user = JSON.parse(c.req.header('X-User-Data-Base64') ? decodeURIComponent(escape(atob(c.req.header('X-User-Data-Base64') || ''))) : '{"id":1}')
    
    console.log('ğŸ“ [AddDailyRecord] User:', user.id, 'Student:', data.studentId)
    
    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    const userInfo = await c.env.DB.prepare(
      'SELECT id, user_type FROM users WHERE id = ?'
    ).bind(user.id).first()
    
    console.log('ğŸ“ [AddDailyRecord] UserInfo:', userInfo)
    
    // ì„ ìƒë‹˜ì¸ ê²½ìš° ê¶Œí•œ í™•ì¸
    if (userInfo && userInfo.user_type === 'teacher') {
      console.log('ğŸ“ [AddDailyRecord] Teacher detected, checking permissions...')
      
      // teacher_permissions í…Œì´ë¸”ì—ì„œ ê¶Œí•œ ì¡°íšŒ
      const permRows = await c.env.DB.prepare(
        'SELECT permission_key, permission_value FROM teacher_permissions WHERE teacher_id = ?'
      ).bind(user.id).all()
      
      let permissions = { canWriteDailyReports: false, canViewAllStudents: false, assignedClasses: [] }
      
      // ê¶Œí•œ íŒŒì‹±
      if (permRows.results) {
        for (const row of permRows.results) {
          const key = row.permission_key
          const value = row.permission_value
          
          if (key === 'canWriteDailyReports') {
            permissions.canWriteDailyReports = value === '1' || value === 1 || value === true
          } else if (key === 'canViewAllStudents') {
            permissions.canViewAllStudents = value === '1' || value === 1 || value === true
          } else if (key === 'assignedClasses' && typeof value === 'string') {
            try {
              permissions.assignedClasses = JSON.parse(value)
            } catch (e) {
              console.error('ğŸ“ [AddDailyRecord] Failed to parse assignedClasses:', e)
            }
          }
        }
      }
      
      console.log('ğŸ“ [AddDailyRecord] Parsed permissions:', permissions)
      
      // ì¼ì¼ ì„±ê³¼ ì‘ì„± ê¶Œí•œì´ ì—†ìœ¼ë©´ ê±°ë¶€
      if (!permissions.canWriteDailyReports) {
        console.log('ğŸ“ [AddDailyRecord] No write permission')
        return c.json({ success: false, error: 'ì¼ì¼ ì„±ê³¼ ì‘ì„± ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
      }
      
      // í•™ìƒì´ ë°°ì •ëœ ë°˜ì— ì†í•˜ëŠ”ì§€ í™•ì¸
      const student = await c.env.DB.prepare(
        'SELECT class_id FROM students WHERE id = ?'
      ).bind(data.studentId).first()
      
      if (!student) {
        console.log('ğŸ“ [AddDailyRecord] Student not found')
        return c.json({ success: false, error: 'í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
      }
      
      console.log('ğŸ“ [AddDailyRecord] Student class_id:', student.class_id)
      
      const assignedClasses = permissions.assignedClasses || []
      if (!permissions.canViewAllStudents && !assignedClasses.includes(student.class_id)) {
        console.log('ğŸ“ [AddDailyRecord] Class not assigned:', student.class_id, 'Assigned:', assignedClasses)
        return c.json({ success: false, error: 'ì´ í•™ìƒì˜ ì„±ê³¼ë¥¼ ì‘ì„±í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
      }
      
      console.log('ğŸ“ [AddDailyRecord] Permission granted')
    }
    
    const result = await c.env.DB.prepare(`
      INSERT INTO daily_records (
        student_id, course_id, record_date, attendance, homework_status,
        understanding_level, participation_level, achievement, memo,
        class_id, lesson_concept, lesson_understanding, lesson_participation,
        lesson_achievement, homework_content, homework_achievement,
        next_homework_type, next_homework_start_page, next_homework_end_page, next_homework_details,
        created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(
      data.studentId,
      data.courseId || null,
      data.recordDate,
      data.attendance || null,
      data.homeworkStatus || null,
      data.understandingLevel || null,
      data.participationLevel || null,
      data.achievement || null,
      data.memo || null,
      data.classId || null,
      data.lessonConcept || null,
      data.lessonUnderstanding || null,
      data.lessonParticipation || null,
      data.lessonAchievement || null,
      data.homeworkContent || null,
      data.homeworkAchievement || null,
      data.nextHomeworkType || null,
      data.nextHomeworkStartPage || null,
      data.nextHomeworkEndPage || null,
      data.nextHomeworkDetails || null
    ).run()
    
    console.log('âœ… [AddDailyRecord] Success, id:', result.meta.last_row_id)
    
    return c.json({ success: true, id: result.meta.last_row_id, message: 'ì¼ì¼ ì„±ê³¼ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error) {
    console.error('âŒ [AddDailyRecord] Error:', error)
    console.error('âŒ [AddDailyRecord] Stack:', error.stack)
    return c.json({ success: false, error: 'ì¼ì¼ ì„±ê³¼ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì¼ì¼ ì„±ê³¼ ê¸°ë¡ ìˆ˜ì •
app.put('/api/daily-records/:id', async (c) => {
  try {
    const recordId = c.req.param('id')
    const data = await c.req.json()
    const user = JSON.parse(c.req.header('X-User-Data-Base64') ? decodeURIComponent(escape(atob(c.req.header('X-User-Data-Base64') || ''))) : '{"id":1}')
    
    // ì‚¬ìš©ì ì •ë³´ ë° ê¶Œí•œ ì¡°íšŒ
    const userInfo = await c.env.DB.prepare(
      'SELECT id, user_type, permissions FROM users WHERE id = ?'
    ).bind(user.id).first()
    
    // ì„ ìƒë‹˜ì¸ ê²½ìš° ê¶Œí•œ í™•ì¸
    if (userInfo && userInfo.user_type === 'teacher') {
      let permissions = { canWriteDailyReports: false, assignedClasses: [] }
      
      if (userInfo.permissions) {
        try {
          permissions = JSON.parse(userInfo.permissions)
        } catch (e) {
          console.error('Failed to parse permissions:', e)
        }
      }
      
      if (!permissions.canWriteDailyReports) {
        return c.json({ success: false, error: 'ì¼ì¼ ì„±ê³¼ ìˆ˜ì • ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
      }
      
      // ê¸°ë¡ì˜ í•™ìƒì´ ë°°ì •ëœ ë°˜ì— ì†í•˜ëŠ”ì§€ í™•ì¸
      const record = await c.env.DB.prepare(
        'SELECT student_id FROM daily_records WHERE id = ?'
      ).bind(recordId).first()
      
      if (!record) {
        return c.json({ success: false, error: 'ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
      }
      
      const student = await c.env.DB.prepare(
        'SELECT class_id FROM students WHERE id = ?'
      ).bind(record.student_id).first()
      
      const assignedClasses = permissions.assignedClasses || []
      if (!permissions.canViewAllStudents && !assignedClasses.includes(student.class_id)) {
        return c.json({ success: false, error: 'ì´ í•™ìƒì˜ ì„±ê³¼ë¥¼ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
      }
    }
    
    await c.env.DB.prepare(`
      UPDATE daily_records SET
        course_id = ?,
        record_date = ?,
        attendance = ?,
        homework_status = ?,
        understanding_level = ?,
        participation_level = ?,
        achievement = ?,
        memo = ?,
        class_id = ?,
        lesson_concept = ?,
        lesson_understanding = ?,
        lesson_participation = ?,
        lesson_achievement = ?,
        homework_content = ?,
        homework_achievement = ?,
        next_homework_type = ?,
        next_homework_start_page = ?,
        next_homework_end_page = ?,
        next_homework_details = ?
      WHERE id = ?
    `).bind(
      data.courseId || null,
      data.recordDate,
      data.attendance || null,
      data.homeworkStatus || null,
      data.understandingLevel || null,
      data.participationLevel || null,
      data.achievement || null,
      data.memo || null,
      data.classId || null,
      data.lessonConcept || null,
      data.lessonUnderstanding || null,
      data.lessonParticipation || null,
      data.lessonAchievement || null,
      data.homeworkContent || null,
      data.homeworkAchievement || null,
      data.nextHomeworkType || null,
      data.nextHomeworkStartPage || null,
      data.nextHomeworkEndPage || null,
      data.nextHomeworkDetails || null,
      recordId
    ).run()
    
    return c.json({ success: true, message: 'ì¼ì¼ ì„±ê³¼ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error) {
    console.error('Update daily record error:', error)
    return c.json({ success: false, error: 'ì¼ì¼ ì„±ê³¼ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì¼ì¼ ì„±ê³¼ ê¸°ë¡ ì‚­ì œ
app.delete('/api/daily-records/:id', async (c) => {
  try {
    const recordId = c.req.param('id')
    const user = JSON.parse(c.req.header('X-User-Data-Base64') ? decodeURIComponent(escape(atob(c.req.header('X-User-Data-Base64') || ''))) : '{"id":1}')
    
    // ì‚¬ìš©ì ì •ë³´ ë° ê¶Œí•œ ì¡°íšŒ
    const userInfo = await c.env.DB.prepare(
      'SELECT id, user_type, permissions FROM users WHERE id = ?'
    ).bind(user.id).first()
    
    // ì„ ìƒë‹˜ì¸ ê²½ìš° ê¶Œí•œ í™•ì¸
    if (userInfo && userInfo.user_type === 'teacher') {
      let permissions = { canWriteDailyReports: false, assignedClasses: [] }
      
      if (userInfo.permissions) {
        try {
          permissions = JSON.parse(userInfo.permissions)
        } catch (e) {
          console.error('Failed to parse permissions:', e)
        }
      }
      
      if (!permissions.canWriteDailyReports) {
        return c.json({ success: false, error: 'ì¼ì¼ ì„±ê³¼ ì‚­ì œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
      }
      
      // ê¸°ë¡ì˜ í•™ìƒì´ ë°°ì •ëœ ë°˜ì— ì†í•˜ëŠ”ì§€ í™•ì¸
      const record = await c.env.DB.prepare(
        'SELECT student_id FROM daily_records WHERE id = ?'
      ).bind(recordId).first()
      
      if (!record) {
        return c.json({ success: false, error: 'ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
      }
      
      const student = await c.env.DB.prepare(
        'SELECT class_id FROM students WHERE id = ?'
      ).bind(record.student_id).first()
      
      const assignedClasses = permissions.assignedClasses || []
      if (!permissions.canViewAllStudents && !assignedClasses.includes(student.class_id)) {
        return c.json({ success: false, error: 'ì´ í•™ìƒì˜ ì„±ê³¼ë¥¼ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
      }
    }
    
    await c.env.DB.prepare(`
      DELETE FROM daily_records WHERE id = ?
    `).bind(recordId).run()
    
    return c.json({ success: true, message: 'ì¼ì¼ ì„±ê³¼ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.' })
  } catch (error) {
    console.error('Delete daily record error:', error)
    return c.json({ success: false, error: 'ì¼ì¼ ì„±ê³¼ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì›ì¥ë‹˜: ì„ ìƒë‹˜ ê¶Œí•œ ì¡°íšŒ

// ì„ ìƒë‹˜: ë‚´ ê¶Œí•œ í™•ì¸
app.get('/api/teachers/my-permissions', async (c) => {
  try {
    const teacherId = c.req.query('teacherId')
    
    if (!teacherId) {
      return c.json({ success: false, error: 'ì„ ìƒë‹˜ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    const permissions = await c.env.DB.prepare(
      'SELECT permission_key, permission_value FROM teacher_permissions WHERE teacher_id = ?'
    ).bind(teacherId).all()
    
    const permissionsMap = {}
    if (permissions.results) {
      permissions.results.forEach(p => {
        const key = p.permission_key
        const value = p.permission_value
        
        // JSON ë¬¸ìì—´ì¸ ê²½ìš° íŒŒì‹±
        if (key === 'assignedClasses' && typeof value === 'string') {
          try {
            permissionsMap[key] = JSON.parse(value)
          } catch (e) {
            console.error('JSON Parse Error:', key, e)
            permissionsMap[key] = []
          }
        } else if (typeof value === 'string' && (value === '1' || value === '0')) {
          permissionsMap[key] = value === '1'
        } else if (typeof value === 'number') {
          permissionsMap[key] = value === 1
        } else {
          permissionsMap[key] = !!value
        }
      })
    }
    
    return c.json({ success: true, permissions: permissionsMap })
  } catch (error) {
    console.error('Get my permissions error:', error)
    return c.json({ success: false, error: 'ê¶Œí•œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// í•™ìƒ ëª©ë¡ ì¡°íšŒ (ì›ì¥ë‹˜/ì„ ìƒë‹˜ë³„ ê¶Œí•œ)
app.get('/api/students/list', async (c) => {
  try {
    const userId = c.req.query('userId')
    const userType = c.req.query('userType')
    const classId = c.req.query('classId')
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    let query = ''
    let params = []
    
    if (userType === 'teacher') {
      // ì„ ìƒë‹˜ ê¶Œí•œ í™•ì¸
      console.log('ğŸ‘¨â€ğŸ« [StudentsList] Loading permissions for teacher:', userId)
      
      let permissions = { canViewAllStudents: false, assignedClasses: [] }
      try {
        const permRows = await c.env.DB.prepare(
          'SELECT permission_key, permission_value FROM teacher_permissions WHERE teacher_id = ?'
        ).bind(userId).all()
        
        if (permRows.results && permRows.results.length > 0) {
          permRows.results.forEach(p => {
            if (p.permission_key === 'canViewAllStudents') {
              permissions.canViewAllStudents = p.permission_value === '1' || p.permission_value === 1 || p.permission_value === true
            } else if (p.permission_key === 'assignedClasses' && typeof p.permission_value === 'string') {
              try {
                permissions.assignedClasses = JSON.parse(p.permission_value)
              } catch (e) {
                console.error('Failed to parse assignedClasses:', e)
              }
            }
          })
        }
        console.log('ğŸ‘¨â€ğŸ« [StudentsList] Teacher permissions:', permissions)
      } catch (permErr) {
        console.error('Failed to load teacher permissions:', permErr)
      }
      
      // ì„ ìƒë‹˜ ê¶Œí•œì— ë”°ë¼ í•™ìƒ ì¡°íšŒ
      if (permissions.canViewAllStudents) {
        // ëª¨ë‘ ë‹¤ ê³µê°œ: ëª¨ë“  í•™ìƒ ì¡°íšŒ
        console.log('ğŸ‘¨â€ğŸ« [StudentsList] Teacher can view all students')
        if (classId) {
          query = `
            SELECT s.*, c.name as class_name
            FROM students s
            LEFT JOIN classes c ON s.class_id = c.id
            WHERE s.class_id = ? AND s.status = 'active' AND s.id NOT IN (4)
            ORDER BY s.name
          `
          params = [classId]
        } else {
          query = `
            SELECT s.*, c.name as class_name
            FROM students s
            LEFT JOIN classes c ON s.class_id = c.id
            WHERE s.status = 'active' AND s.id NOT IN (4)
            ORDER BY c.name, s.name
          `
          params = []
        }
      } else if (permissions.assignedClasses && permissions.assignedClasses.length > 0) {
        // ë°°ì •ëœ ë°˜ë§Œ ê³µê°œ: ë°°ì •ëœ ë°˜ì˜ í•™ìƒë§Œ ì¡°íšŒ
        console.log('ğŸ‘¨â€ğŸ« [StudentsList] Teacher can view assigned classes:', permissions.assignedClasses)
        const classIds = permissions.assignedClasses
        const placeholders = classIds.map(() => '?').join(',')
        
        if (classId) {
          // íŠ¹ì • ë°˜ ì¡°íšŒ ì‹œ ë°°ì •ëœ ë°˜ì¸ì§€ í™•ì¸
          if (!classIds.includes(parseInt(classId))) {
            console.log('ğŸ‘¨â€ğŸ« [StudentsList] Class not assigned to teacher:', classId)
            return c.json({ success: true, students: [] })
          }
          query = `
            SELECT s.*, c.name as class_name
            FROM students s
            LEFT JOIN classes c ON s.class_id = c.id
            WHERE s.class_id = ? AND s.status = 'active' AND s.id NOT IN (4)
            ORDER BY s.name
          `
          params = [classId]
        } else {
          query = `
            SELECT s.*, c.name as class_name
            FROM students s
            LEFT JOIN classes c ON s.class_id = c.id
            WHERE s.class_id IN (${placeholders}) AND s.status = 'active' AND s.id NOT IN (4)
            ORDER BY c.name, s.name
          `
          params = classIds
        }
      } else {
        // ê¶Œí•œ ì—†ìŒ: ë¹ˆ ë°°ì—´ ë°˜í™˜
        console.log('ğŸ‘¨â€ğŸ« [StudentsList] No permissions assigned, returning empty list')
        return c.json({ success: true, students: [] })
      }
    } else {
      // ì›ì¥ë‹˜ì€ ìì‹ ì˜ í•™ì›ì˜ ëª¨ë“  í•™ìƒ ì¡°íšŒ
      if (classId) {
        query = `
          SELECT s.*, c.name as class_name, u.name as teacher_name
          FROM students s
          LEFT JOIN classes c ON s.class_id = c.id
          LEFT JOIN users u ON c.teacher_id = u.id
          WHERE s.academy_id = ? AND s.class_id = ? AND s.status = 'active'
          ORDER BY s.name
        `
        params = [userId, classId]
      } else {
        query = `
          SELECT s.*, c.name as class_name, u.name as teacher_name
          FROM students s
          LEFT JOIN classes c ON s.class_id = c.id
          LEFT JOIN users u ON c.teacher_id = u.id
          WHERE s.academy_id = ? AND s.status = 'active'
          ORDER BY c.name, s.name
        `
        params = [userId]
      }
    }
    
    const students = await c.env.DB.prepare(query).bind(...params).all()
    
    return c.json({ success: true, students: students.results || [] })
  } catch (error) {
    console.error('Get students error:', error)
    return c.json({ success: false, error: 'í•™ìƒ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ê´€ë¦¬ì: ì‚¬ìš©ì ìƒì„¸ ì •ë³´ ì¡°íšŒ API
app.get('/api/admin/users/:id/detail', async (c) => {
  try {
    const userId = c.req.param('id')
    
    // ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´
    const user = await c.env.DB.prepare(`
      SELECT id, email, name, phone, academy_name, role, points, created_at
      FROM users WHERE id = ?
    `).bind(userId).first()
    
    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }
    
    // ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ìš”ì²­ ë‚´ì—­ (try-catchë¡œ ê°ì‹¸ê¸°)
    let verificationRequests = { results: [] }
    try {
      verificationRequests = await c.env.DB.prepare(`
        SELECT id, phone_number, verification_method, document_url, status, 
               created_at, processed_at, admin_note
        FROM sender_verification_requests
        WHERE user_id = ?
        ORDER BY created_at DESC
      `).bind(userId).all()
    } catch (verError) {
      console.error('Verification requests error (non-critical):', verError)
    }
    
    // ë“±ë¡ëœ ë°œì‹ ë²ˆí˜¸ ëª©ë¡ (try-catchë¡œ ê°ì‹¸ê¸°)
    let senderNumbers = { results: [] }
    try {
      senderNumbers = await c.env.DB.prepare(`
        SELECT id, phone_number, verification_method, status, verification_date, created_at
        FROM sender_ids
        WHERE user_id = ?
        ORDER BY created_at DESC
      `).bind(userId).all()
    } catch (senderError) {
      console.error('Sender numbers error (non-critical):', senderError)
    }
    
    // ëœë”©í˜ì´ì§€ ëª©ë¡ (try-catchë¡œ ê°ì‹¸ê¸°)
    let landingPages = { results: [] }
    try {
      landingPages = await c.env.DB.prepare(`
        SELECT id, title, slug, status, view_count, created_at, updated_at
        FROM landing_pages
        WHERE user_id = ?
        ORDER BY created_at DESC
        LIMIT 10
      `).bind(userId).all()
    } catch (lpError) {
      console.error('Landing pages error (non-critical):', lpError)
    }
    
    // ê¶Œí•œ ëª©ë¡ (try-catchë¡œ ê°ì‹¸ê¸°)
    let permissions = { results: [] }
    try {
      permissions = await c.env.DB.prepare(`
        SELECT program_key, granted_at, expires_at
        FROM user_permissions
        WHERE user_id = ? AND is_active = 1
        ORDER BY granted_at DESC
      `).bind(userId).all()
    } catch (permError) {
      console.error('Permissions error (non-critical):', permError)
    }
    
    // SMS ë°œì†¡ í†µê³„ (try-catchë¡œ ê°ì‹¸ê¸°)
    let smsStats = { total_sent: 0, success_count: 0, failed_count: 0 }
    try {
      const stats = await c.env.DB.prepare(`
        SELECT 
          COUNT(*) as total_sent,
          SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) as success_count,
          SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed_count
        FROM sms_logs
        WHERE user_id = ?
      `).bind(userId).first()
      if (stats) {
        smsStats = stats
      }
    } catch (smsError) {
      console.error('SMS stats error (non-critical):', smsError)
      // Continue with default values
    }
    
    return c.json({
      success: true,
      user,
      verificationRequests: verificationRequests.results || [],
      senderNumbers: senderNumbers.results || [],
      landingPages: landingPages.results || [],
      permissions: permissions.results || [],
      smsStats: smsStats || { total_sent: 0, success_count: 0, failed_count: 0 }
    })
  } catch (err) {
    console.error('Get user detail error:', err)
    return c.json({ success: false, error: 'ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})

// ì‚¬ìš©ì ìƒì„¸ ì •ë³´ í˜ì´ì§€
app.get('/admin/users/:id', async (c) => {
  const { env } = c
  const userId = c.req.param('id')
  
  try {
    // ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
    const user = await env.DB.prepare('SELECT * FROM users WHERE id = ?').bind(userId).first()
    
    if (!user) {
      return c.html('<h1>ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h1>', 404)
    }
    
    // ì‚¬ìš©ì ê¶Œí•œ ì¡°íšŒ (í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
    let permissions = { results: [] }
    try {
      permissions = await env.DB.prepare(
        'SELECT program_key, granted_at FROM user_permissions WHERE user_id = ? AND is_active = 1'
      ).bind(userId).all()
    } catch (e) {
      console.log('user_permissions í…Œì´ë¸” ì—†ìŒ:', e.message)
    }
    
    // ì‚¬ìš©ìì˜ ë¬¸ì˜ ë‚´ì—­ ì¡°íšŒ (í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
    let contacts = { results: [] }
    try {
      contacts = await env.DB.prepare(
        'SELECT * FROM contacts WHERE email = ? ORDER BY created_at DESC'
      ).bind(user.email).all()
    } catch (e) {
      console.log('contacts í…Œì´ë¸” ì—†ìŒ:', e.message)
    }
    
    // ì‚¬ìš©ìì˜ ì…ê¸ˆ ì‹ ì²­ ë‚´ì—­ ì¡°íšŒ (í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
    let deposits = { results: [] }
    try {
      deposits = await env.DB.prepare(
        'SELECT * FROM deposits WHERE user_id = ? ORDER BY created_at DESC'
      ).bind(userId).all()
    } catch (e) {
      console.log('deposits í…Œì´ë¸” ì—†ìŒ:', e.message)
    }
    
    // ê¶Œí•œì„ ì½ê¸° ì‰¬ìš´ ì´ë¦„ìœ¼ë¡œ ë³€í™˜
    const permissionNames = {
      'search_volume': 'ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ',
      'parent_message': 'í•™ë¶€ëª¨ ì†Œí†µ ë©”ì‹œì§€',
      'blog_writer': 'ë¸”ë¡œê·¸ ìë™ ì‘ì„±',
      'landing_builder': 'ëœë”©í˜ì´ì§€ ìƒì„±ê¸°',
      'sms_sender': 'SMS ë¬¸ì ë°œì†¡',
      'student_management': 'í•™ìƒ ê´€ë¦¬',
      'dashboard_analytics': 'í†µí•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ',
      'ai_learning_report': 'AI í•™ìŠµ ë¦¬í¬íŠ¸',
      'landing_manager': 'ëœë”©í˜ì´ì§€ ê´€ë¦¬',
      'keyword_analyzer': 'í‚¤ì›Œë“œ ë¶„ì„ê¸°',
      'review_template': 'í›„ê¸° í…œí”Œë¦¿',
      'ad_copy_generator': 'ê´‘ê³  ë¬¸êµ¬ ìƒì„±ê¸°',
      'photo_optimizer': 'ì‚¬ì§„ ìµœì í™”',
      'competitor_analysis': 'ê²½ìŸì‚¬ ë¶„ì„',
      'blog_checklist': 'ë¸”ë¡œê·¸ ì²´í¬ë¦¬ìŠ¤íŠ¸',
      'content_calendar': 'ì½˜í…ì¸  ìº˜ë¦°ë”',
      'consultation_script': 'ìƒë‹´ ìŠ¤í¬ë¦½íŠ¸',
      'place_optimization': 'í”Œë ˆì´ìŠ¤ ìµœì í™”',
      'roi_calculator': 'ROI ê³„ì‚°ê¸°'
    }
    
    return c.html(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>${user.name} ìƒì„¸ ì •ë³´ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
          <script src="https://cdn.tailwindcss.com"></script>
          <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
          <style>
              .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
              .info-card { transition: all 0.3s ease; }
              .info-card:hover { transform: translateY(-2px); box-shadow: 0 8px 15px -5px rgba(0, 0, 0, 0.1); }
          </style>
      </head>
      <body class="bg-gray-50">
          <!-- í—¤ë” -->
          <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
              <div class="max-w-7xl mx-auto px-6 py-4">
                  <div class="flex justify-between items-center">
                      <div class="flex items-center gap-8">
                          <a href="/admin/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a>
                          <div class="flex gap-4">
                              <a href="/admin/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                              <a href="/admin/users" class="text-purple-600 font-medium">ì‚¬ìš©ì</a>
                              <a href="/admin/contacts" class="text-gray-600 hover:text-purple-600">ë¬¸ì˜</a>
                              <a href="/admin/bank-transfers" class="text-gray-600 hover:text-purple-600">ê³„ì¢Œì´ì²´</a>
                          </div>
                      </div>
                      <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                          <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                      </button>
                  </div>
              </div>
          </nav>

          <!-- ë©”ì¸ ì»¨í…ì¸  -->
          <div class="max-w-7xl mx-auto px-6 py-8">
              <!-- ìƒë‹¨: ë’¤ë¡œê°€ê¸° + ì‚¬ìš©ì ì´ë¦„ -->
              <div class="mb-8">
                  <a href="/admin/users" class="text-purple-600 hover:text-purple-700 font-medium mb-4 inline-flex items-center">
                      <i class="fas fa-arrow-left mr-2"></i> ì‚¬ìš©ì ëª©ë¡ìœ¼ë¡œ
                  </a>
                  <h1 class="text-3xl font-bold text-gray-900 mt-4 mb-2">${user.name}ë‹˜ì˜ ìƒì„¸ ì •ë³´</h1>
                  <p class="text-gray-600">ì‚¬ìš©ì ID: ${user.id} | ì´ë©”ì¼: ${user.email}</p>
              </div>

              <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  <!-- ì™¼ìª½: ê¸°ë³¸ ì •ë³´ -->
                  <div class="lg:col-span-1 space-y-6">
                      <!-- ê¸°ë³¸ ì •ë³´ ì¹´ë“œ -->
                      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 info-card">
                          <div class="flex items-center gap-4 mb-6">
                              <div class="w-16 h-16 gradient-purple rounded-full flex items-center justify-center">
                                  <i class="fas fa-user text-white text-2xl"></i>
                              </div>
                              <div>
                                  <h2 class="text-xl font-bold text-gray-900">${user.name}</h2>
                                  <span class="px-3 py-1 text-xs font-medium rounded-full ${user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700'}">
                                      ${user.role === 'admin' ? 'ê´€ë¦¬ì' : 'ì¼ë°˜íšŒì›'}
                                  </span>
                              </div>
                          </div>

                          <div class="space-y-4">
                              <div>
                                  <div class="text-xs text-gray-500 mb-1">ğŸ“§ ì´ë©”ì¼</div>
                                  <div class="text-sm font-medium text-gray-900">${user.email}</div>
                              </div>
                              <div>
                                  <div class="text-xs text-gray-500 mb-1">ğŸ“± ì „í™”ë²ˆí˜¸</div>
                                  <div class="text-sm font-medium text-gray-900">${user.phone || '-'}</div>
                              </div>
                              <div>
                                  <div class="text-xs text-gray-500 mb-1">ğŸ« í•™ì›ëª…</div>
                                  <div class="text-sm font-medium text-gray-900">${user.academy_name || '-'}</div>
                              </div>
                              <div>
                                  <div class="text-xs text-gray-500 mb-1">ğŸ’° í¬ì¸íŠ¸</div>
                                  <div class="text-xl font-bold text-blue-600">${(user.points || 0).toLocaleString()}P</div>
                              </div>
                              <div>
                                  <div class="text-xs text-gray-500 mb-1">ğŸ“… ê°€ì…ì¼</div>
                                  <div class="text-sm font-medium text-gray-900">${new Date(user.created_at).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}</div>
                              </div>
                          </div>
                      </div>

                      <!-- ë¹ ë¥¸ ê´€ë¦¬ ë²„íŠ¼ -->
                      ${user.role !== 'admin' ? `
                      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 info-card">
                          <h3 class="text-lg font-bold text-gray-900 mb-4">ë¹ ë¥¸ ê´€ë¦¬</h3>
                          <div class="space-y-2">
                              <button onclick="changePassword(${user.id}, '${user.name}')" class="w-full px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition text-sm font-medium text-left">
                                  ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                              </button>
                              <button onclick="givePoints(${user.id}, '${user.name}', ${user.points || 0})" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition text-sm font-medium text-left">
                                  ğŸ’° í¬ì¸íŠ¸ ì§€ê¸‰
                              </button>
                              <button onclick="deductPoints(${user.id}, '${user.name}', ${user.points || 0})" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition text-sm font-medium text-left">
                                  âŒ í¬ì¸íŠ¸ ì°¨ê°
                              </button>
                              <button onclick="loginAs(${user.id}, '${user.name}')" class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm font-medium text-left">
                                  ğŸ‘¤ ì´ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸
                              </button>
                          </div>
                      </div>
                      ` : ''}
                  </div>

                  <!-- ì˜¤ë¥¸ìª½: ìƒì„¸ ì •ë³´ -->
                  <div class="lg:col-span-2 space-y-6">
                      <!-- êµ¬ë… & ì‚¬ìš©ëŸ‰ ì •ë³´ -->
                      <div id="subscriptionInfo" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 info-card">
                          <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“Š êµ¬ë… & ì‚¬ìš©ëŸ‰ ì •ë³´</h3>
                          <div id="subscriptionContent">
                              <div class="animate-pulse flex space-x-4">
                                  <div class="flex-1 space-y-4 py-1">
                                      <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                                      <div class="space-y-2">
                                          <div class="h-4 bg-gray-200 rounded"></div>
                                          <div class="h-4 bg-gray-200 rounded w-5/6"></div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <!-- í™œì„±í™”ëœ ê¶Œí•œ -->
                      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 info-card">
                          <h3 class="text-lg font-bold text-gray-900 mb-4">âš™ï¸ í™œì„±í™”ëœ ê¶Œí•œ</h3>
                          <p class="text-gray-500 text-sm">ê¶Œí•œ ê´€ë¦¬ëŠ” ì‚¬ìš©ì ëª©ë¡ í˜ì´ì§€ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                          <button onclick="window.location.href='/admin/users'" class="mt-4 text-purple-600 hover:text-purple-700 text-sm font-medium">
                              ì‚¬ìš©ì ëª©ë¡ìœ¼ë¡œ ì´ë™ â†’
                          </button>
                      </div>

                      <!-- ë¬¸ì˜ ë‚´ì—­ -->
                      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 info-card">
                          <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“§ ë¬¸ì˜ ë‚´ì—­</h3>
                          <p class="text-gray-500 text-sm">ë¬¸ì˜ ë‚´ì—­ì€ ë¬¸ì˜ ê´€ë¦¬ í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                          <button onclick="window.location.href='/admin/contacts'" class="mt-4 text-purple-600 hover:text-purple-700 text-sm font-medium">
                              ë¬¸ì˜ ê´€ë¦¬ë¡œ ì´ë™ â†’
                          </button>
                      </div>

                      <!-- ì¶”ê°€ ì •ë³´ -->
                      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 info-card">
                          <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ“Š ì‚¬ìš©ì ì •ë³´</h3>
                          <div class="grid grid-cols-2 gap-4">
                              <div class="text-center p-4 bg-blue-50 rounded-lg">
                                  <div class="text-2xl font-bold text-blue-600">${user.email}</div>
                                  <div class="text-xs text-gray-600 mt-1">ì´ë©”ì¼</div>
                              </div>
                              <div class="text-center p-4 bg-green-50 rounded-lg">
                                  <div class="text-2xl font-bold text-green-600">${(user.points || 0).toLocaleString()}</div>
                                  <div class="text-xs text-gray-600 mt-1">í¬ì¸íŠ¸</div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>

          <script src="/static/admin-users.js"></script>
          <script>
              const userId = ${user.id};
              
              // êµ¬ë… & ì‚¬ìš©ëŸ‰ ì •ë³´ ë¡œë“œ
              async function loadSubscriptionInfo() {
                  try {
                      const response = await fetch(\`/api/admin/usage/\${userId}\`);
                      const data = await response.json();
                      
                      const content = document.getElementById('subscriptionContent');
                      
                      if (!data.success || !data.hasSubscription) {
                          content.innerHTML = \`
                              <div class="text-center py-8">
                                  <p class="text-gray-500 mb-4">\${data.message || 'í™œì„± êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤'}</p>
                                  <a href="/pricing" class="inline-block px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                      í”Œëœ ì„ íƒí•˜ê¸°
                                  </a>
                              </div>
                          \`;
                          return;
                      }
                      
                      const { subscription, usage } = data;
                      
                      content.innerHTML = \`
                          <div class="space-y-6">
                              <!-- í”Œëœ ì •ë³´ -->
                              <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl p-4">
                                  <div class="flex justify-between items-start mb-3">
                                      <div>
                                          <h4 class="text-lg font-bold text-gray-900">\${subscription.planName}</h4>
                                          <p class="text-sm text-gray-600 mt-1">
                                              \${subscription.startDate} ~ \${subscription.endDate}
                                          </p>
                                      </div>
                                      <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                                          í™œì„±
                                      </span>
                                  </div>
                              </div>
                              
                              <!-- ì‚¬ìš©ëŸ‰ & í•œë„ ì¡°ì ˆ -->
                              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                  <!-- í•™ìƒ ìˆ˜ -->
                                  <div class="border border-gray-200 rounded-lg p-4">
                                      <div class="flex items-center justify-between mb-2">
                                          <span class="text-sm font-medium text-gray-700">ğŸ‘¥ í•™ìƒ ìˆ˜</span>
                                          <span class="text-sm font-bold \${usage.currentStudents >= subscription.studentLimit ? 'text-red-600' : 'text-blue-600'}">
                                              \${usage.currentStudents} / \${subscription.studentLimit}
                                          </span>
                                      </div>
                                      <div class="w-full bg-gray-200 rounded-full h-2">
                                          <div class="bg-blue-600 h-2 rounded-full transition-all" style="width: \${Math.min((usage.currentStudents / subscription.studentLimit) * 100, 100)}%"></div>
                                      </div>
                                      <div class="mt-2">
                                          <label class="text-xs text-gray-500">í•œë„ ì„¤ì •:</label>
                                          <input type="number" id="studentLimit" value="\${subscription.studentLimit}" 
                                              class="w-full mt-1 px-3 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                                      </div>
                                  </div>
                                  
                                  <!-- AI ë¦¬í¬íŠ¸ -->
                                  <div class="border border-gray-200 rounded-lg p-4">
                                      <div class="flex items-center justify-between mb-2">
                                          <span class="text-sm font-medium text-gray-700">ğŸ“Š AI ë¦¬í¬íŠ¸</span>
                                          <span class="text-sm font-bold \${usage.aiReportsUsed >= subscription.aiReportLimit ? 'text-red-600' : 'text-green-600'}">
                                              \${usage.aiReportsUsed} / \${subscription.aiReportLimit}
                                          </span>
                                      </div>
                                      <div class="w-full bg-gray-200 rounded-full h-2">
                                          <div class="bg-green-600 h-2 rounded-full transition-all" style="width: \${Math.min((usage.aiReportsUsed / subscription.aiReportLimit) * 100, 100)}%"></div>
                                      </div>
                                      <div class="mt-2">
                                          <label class="text-xs text-gray-500">í•œë„ ì„¤ì •:</label>
                                          <input type="number" id="aiReportLimit" value="\${subscription.aiReportLimit}" 
                                              class="w-full mt-1 px-3 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                                      </div>
                                  </div>
                                  
                                  <!-- ëœë”©í˜ì´ì§€ -->
                                  <div class="border border-gray-200 rounded-lg p-4">
                                      <div class="flex items-center justify-between mb-2">
                                          <span class="text-sm font-medium text-gray-700">ğŸ¨ ëœë”©í˜ì´ì§€</span>
                                          <span class="text-sm font-bold \${usage.landingPagesCreated >= subscription.landingPageLimit ? 'text-red-600' : 'text-purple-600'}">
                                              \${usage.landingPagesCreated} / \${subscription.landingPageLimit}
                                          </span>
                                      </div>
                                      <div class="w-full bg-gray-200 rounded-full h-2">
                                          <div class="bg-purple-600 h-2 rounded-full transition-all" style="width: \${Math.min((usage.landingPagesCreated / subscription.landingPageLimit) * 100, 100)}%"></div>
                                      </div>
                                      <div class="mt-2">
                                          <label class="text-xs text-gray-500">í•œë„ ì„¤ì •:</label>
                                          <input type="number" id="landingPageLimit" value="\${subscription.landingPageLimit}" 
                                              class="w-full mt-1 px-3 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                                      </div>
                                  </div>
                                  
                                  <!-- ì„ ìƒë‹˜ ê³„ì • -->
                                  <div class="border border-gray-200 rounded-lg p-4">
                                      <div class="flex items-center justify-between mb-2">
                                          <span class="text-sm font-medium text-gray-700">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜</span>
                                          <span class="text-sm font-bold \${usage.currentTeachers >= subscription.teacherLimit ? 'text-red-600' : 'text-orange-600'}">
                                              \${usage.currentTeachers} / \${subscription.teacherLimit}
                                          </span>
                                      </div>
                                      <div class="w-full bg-gray-200 rounded-full h-2">
                                          <div class="bg-orange-600 h-2 rounded-full transition-all" style="width: \${Math.min((usage.currentTeachers / subscription.teacherLimit) * 100, 100)}%"></div>
                                      </div>
                                      <div class="mt-2">
                                          <label class="text-xs text-gray-500">í•œë„ ì„¤ì •:</label>
                                          <input type="number" id="teacherLimit" value="\${subscription.teacherLimit}" 
                                              class="w-full mt-1 px-3 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                                      </div>
                                  </div>
                              </div>
                              
                              <!-- ì €ì¥ ë²„íŠ¼ -->
                              <div class="flex justify-end gap-3 pt-4 border-t">
                                  <button onclick="loadSubscriptionInfo()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-medium">
                                      ì·¨ì†Œ
                                  </button>
                                  <button onclick="updateLimits()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium">
                                      í•œë„ ì €ì¥
                                  </button>
                              </div>
                          </div>
                      \`;
                  } catch (error) {
                      console.error('Failed to load subscription info:', error);
                      document.getElementById('subscriptionContent').innerHTML = \`
                          <div class="text-center py-8 text-red-500">
                              <p>ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</p>
                          </div>
                      \`;
                  }
              }
              
              // í•œë„ ì—…ë°ì´íŠ¸
              async function updateLimits() {
                  const studentLimit = parseInt(document.getElementById('studentLimit').value);
                  const aiReportLimit = parseInt(document.getElementById('aiReportLimit').value);
                  const landingPageLimit = parseInt(document.getElementById('landingPageLimit').value);
                  const teacherLimit = parseInt(document.getElementById('teacherLimit').value);
                  
                  if (!studentLimit || !aiReportLimit || !landingPageLimit || !teacherLimit) {
                      alert('ëª¨ë“  í•œë„ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”');
                      return;
                  }
                  
                  if (confirm('ì •ë§ ì‚¬ìš© í•œë„ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                      try {
                          const response = await fetch(\`/api/admin/usage/\${userId}/update-limits\`, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                  studentLimit,
                                  aiReportLimit,
                                  landingPageLimit,
                                  teacherLimit
                              })
                          });
                          
                          const data = await response.json();
                          
                          if (data.success) {
                              alert('âœ… ì‚¬ìš© í•œë„ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
                              loadSubscriptionInfo();
                          } else {
                              alert('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                          }
                      } catch (error) {
                          console.error('Update error:', error);
                          alert('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                      }
                  }
              }
              
              // í˜ì´ì§€ ë¡œë“œ ì‹œ êµ¬ë… ì •ë³´ ë¡œë“œ
              window.addEventListener('DOMContentLoaded', loadSubscriptionInfo);
              
              function logout() {
                  if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                      localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                      window.location.href = '/';
                  }
              }
          </script>
      </body>
      </html>
    `)
  } catch (error) {
    console.error('ì‚¬ìš©ì ìƒì„¸ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error)
    return c.html('<h1>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h1>', 500)
  }
})

// ë¬¸ì˜ ê´€ë¦¬ í˜ì´ì§€
app.get('/admin/contacts', async (c) => {
  const { env } = c
  
  // ë¬¸ì˜ ëª©ë¡ ì¡°íšŒ
  const contacts = await env.DB.prepare('SELECT * FROM contacts ORDER BY created_at DESC').all()
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¬¸ì˜ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- í—¤ë” -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-8">
                        <a href="/admin/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a>
                        <div class="flex gap-4">
                            <a href="/admin/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                            <a href="/admin/users" class="text-gray-600 hover:text-purple-600">ì‚¬ìš©ì</a>
                            <a href="/admin/contacts" class="text-purple-600 font-medium">ë¬¸ì˜</a>
                            <a href="/admin/bank-transfers" class="text-gray-600 hover:text-purple-600">ê³„ì¢Œì´ì²´</a>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </nav>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="mb-8 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">ë¬¸ì˜ ê´€ë¦¬</h1>
                    <p class="text-gray-600">ì „ì²´ ${contacts?.results?.length || 0}ê±´ì˜ ë¬¸ì˜</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="filterContacts('all')" class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium">ì „ì²´</button>
                    <button onclick="filterContacts('pending')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">ëŒ€ê¸°ì¤‘</button>
                    <button onclick="filterContacts('completed')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium">ì²˜ë¦¬ì™„ë£Œ</button>
                </div>
            </div>

            <!-- ë¬¸ì˜ ëª©ë¡ -->
            <div class="space-y-4">
                ${contacts?.results?.map(contact => `
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition" data-status="${contact.status || 'pending'}">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-lg font-bold text-gray-900">${contact.name}</h3>
                                    <span class="px-3 py-1 text-xs font-medium rounded-full ${contact.status === 'completed' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'}">
                                        ${contact.status === 'completed' ? 'ì²˜ë¦¬ì™„ë£Œ' : 'ëŒ€ê¸°ì¤‘'}
                                    </span>
                                    <span class="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700">
                                        ${contact.inquiry || 'ì¼ë°˜ë¬¸ì˜'}
                                    </span>
                                </div>
                                <div class="flex gap-4 text-sm text-gray-600">
                                    <span><i class="fas fa-building mr-1"></i>${contact.academy || '-'}</span>
                                    <span><i class="fas fa-phone mr-1"></i>${contact.phone}</span>
                                    <span><i class="fas fa-envelope mr-1"></i>${contact.email}</span>
                                </div>
                            </div>
                            <div class="text-sm text-gray-500">
                                ${new Date(contact.created_at).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-xl p-4 mb-4">
                            <div class="text-sm text-gray-700 whitespace-pre-wrap">${contact.message}</div>
                        </div>

                        ${contact.programs ? `
                            <div class="flex gap-2 mb-4">
                                <span class="text-sm text-gray-600">ê´€ì‹¬ í”„ë¡œê·¸ë¨:</span>
                                ${JSON.parse(contact.programs || '[]').map(p => `
                                    <span class="px-2 py-1 bg-purple-50 text-purple-700 text-xs rounded-lg">${p}</span>
                                `).join('')}
                            </div>
                        ` : ''}

                        <div class="flex gap-2">
                            <button onclick="updateStatus(${contact.id}, 'completed')" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600">
                                <i class="fas fa-check mr-1"></i>ì²˜ë¦¬ì™„ë£Œ
                            </button>
                            <button onclick="updateStatus(${contact.id}, 'pending')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300">
                                <i class="fas fa-undo mr-1"></i>ëŒ€ê¸°ì¤‘ìœ¼ë¡œ
                            </button>
                        </div>
                    </div>
                `).join('') || '<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center text-gray-500">ë“±ë¡ëœ ë¬¸ì˜ê°€ ì—†ìŠµë‹ˆë‹¤</div>'}
            </div>
        </div>

        <script>
            function logout() {
                if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                    window.location.href = '/';
                }
            }

            function filterContacts(status) {
                const items = document.querySelectorAll('[data-status]');
                const buttons = document.querySelectorAll('button[onclick^="filterContacts"]');
                
                buttons.forEach(btn => {
                    btn.classList.remove('bg-purple-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                event.target.classList.add('bg-purple-600', 'text-white');
                event.target.classList.remove('bg-gray-200', 'text-gray-700');
                
                items.forEach(item => {
                    if(status === 'all') {
                        item.style.display = 'block';
                    } else {
                        item.style.display = item.dataset.status === status ? 'block' : 'none';
                    }
                });
            }

            async function updateStatus(id, status) {
                try {
                    const response = await fetch('/api/admin/contacts/' + id, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });

                    if(response.ok) {
                        alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
                        location.reload();
                    } else {
                        alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨');
                    }
                } catch(error) {
                    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
                }
            }
        </script>
    </body>
    </html>
  `)
})

// ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ í˜ì´ì§€
app.get('/privacy', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .section-title {
            color: #7c3aed;
            font-weight: 700;
            margin-top: 2rem;
            margin-bottom: 1rem;
          }
          .subsection-title {
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100 shadow-sm">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <img src="/static/images/logo.png" alt="SUPER PLACE" class="h-10" onerror="this.style.display='none'">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <a href="/" class="text-gray-700 hover:text-purple-600 font-medium transition">
                        í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="pt-32 pb-20 px-6">
            <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-8 md:p-12">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</h1>
                <p class="text-gray-600 mb-8">ìµœì¢… ìˆ˜ì •ì¼: 2026ë…„ 1ì›” 23ì¼</p>
                
                <div class="prose prose-lg max-w-none text-gray-700 leading-relaxed">
                    <p class="mb-6">
                        ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤(ì´í•˜ "íšŒì‚¬"ë¼ í•©ë‹ˆë‹¤)ëŠ” ì´ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼ ì¤‘ìš”ì‹œí•˜ë©°, 
                        ã€Œê°œì¸ì •ë³´ë³´í˜¸ë²•ã€, ã€Œì •ë³´í†µì‹ ë§ ì´ìš©ì´‰ì§„ ë° ì •ë³´ë³´í˜¸ ë“±ì— ê´€í•œ ë²•ë¥ ã€ ë“± ê´€ë ¨ ë²•ë ¹ì„ ì¤€ìˆ˜í•˜ê³  ìˆìŠµë‹ˆë‹¤. 
                        íšŒì‚¬ëŠ” ë³¸ ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì„ í†µí•˜ì—¬ ì´ìš©ìê°€ ì œê³µí•˜ëŠ” ê°œì¸ì •ë³´ê°€ ì–´ë– í•œ ìš©ë„ì™€ ë°©ì‹ìœ¼ë¡œ ì´ìš©ë˜ê³  ìˆìœ¼ë©°, 
                        ê°œì¸ì •ë³´ë³´í˜¸ë¥¼ ìœ„í•´ ì–´ë– í•œ ì¡°ì¹˜ê°€ ì·¨í•´ì§€ê³  ìˆëŠ”ì§€ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.
                    </p>

                    <h2 class="section-title text-2xl">1. ê°œì¸ì •ë³´ì˜ ìˆ˜ì§‘ í•­ëª© ë° ìˆ˜ì§‘ ë°©ë²•</h2>
                    
                    <h3 class="subsection-title text-xl">ê°€. ìˆ˜ì§‘í•˜ëŠ” ê°œì¸ì •ë³´ì˜ í•­ëª©</h3>
                    <p class="mb-4">íšŒì‚¬ëŠ” íšŒì›ê°€ì…, ì›í™œí•œ ê³ ê°ìƒë‹´, ì„œë¹„ìŠ¤ ì œê³µ(AI ë¦¬í¬íŠ¸, ë¬¸ì ë°œì†¡ ë“±)ì„ ìœ„í•´ ì•„ë˜ì™€ ê°™ì€ ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    <ul class="list-disc pl-8 mb-4 space-y-2">
                        <li><strong>[í•„ìˆ˜í•­ëª©]</strong> ì•„ì´ë””, ë¹„ë°€ë²ˆí˜¸, ì„±ëª…, íœ´ëŒ€ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ ì£¼ì†Œ, í•™ì›ëª…, í•™ì› ì£¼ì†Œ</li>
                        <li><strong>[ìœ ë£Œ ê²°ì œ ì‹œ]</strong> ì¹´ë“œì‚¬ëª…, ì¹´ë“œë²ˆí˜¸(ì¼ë¶€), ì€í–‰ê³„ì¢Œ ì •ë³´, ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</li>
                        <li><strong>[ì„œë¹„ìŠ¤ ì´ìš© ê³¼ì •]</strong> ì„œë¹„ìŠ¤ ì´ìš©ê¸°ë¡, ì ‘ì† ë¡œê·¸, ì¿ í‚¤, ì ‘ì† IP ì •ë³´, ê²°ì œ ê¸°ë¡, ë¶ˆëŸ‰ ì´ìš© ê¸°ë¡</li>
                        <li><strong>[AI ì„œë¹„ìŠ¤ ì´ìš© ì‹œ]</strong> íšŒì›ì´ ì…ë ¥í•˜ëŠ” í•™ìŠµ ë°ì´í„°(í•™ìƒ ì´ë¦„(ì‹ë³„ ë¶ˆê°€ ì²˜ë¦¬ ê¶Œì¥), ì„±ì , í‰ê°€ ë‚´ìš© ë“±)</li>
                    </ul>

                    <h3 class="subsection-title text-xl">ë‚˜. ìˆ˜ì§‘ë°©ë²•</h3>
                    <p class="mb-6">í™ˆí˜ì´ì§€(íšŒì›ê°€ì…, ê²Œì‹œíŒ, ê²°ì œì°½), ì„œë©´ ì–‘ì‹, ì „í™”/íŒ©ìŠ¤, ìƒì„±í˜• AI ì„œë¹„ìŠ¤ ì´ìš© ê³¼ì •</p>

                    <h2 class="section-title text-2xl">2. ê°œì¸ì •ë³´ì˜ ì´ìš©ëª©ì </h2>
                    <p class="mb-4">íšŒì‚¬ëŠ” ìˆ˜ì§‘í•œ ê°œì¸ì •ë³´ë¥¼ ë‹¤ìŒì˜ ëª©ì ì„ ìœ„í•´ í™œìš©í•©ë‹ˆë‹¤.</p>
                    <ul class="list-disc pl-8 mb-6 space-y-2">
                        <li><strong>ì„œë¹„ìŠ¤ ì œê³µ ë° ê³„ì•½ ì´í–‰:</strong> AI ê¸°ë°˜ ì½˜í…ì¸ (ë¦¬í¬íŠ¸, ëœë”©í˜ì´ì§€) ìƒì„±, ë¬¸ì ë©”ì‹œì§€(SMS/LMS) ë°œì†¡, ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ, ìš”ê¸ˆ ê²°ì œ ë° ì •ì‚°</li>
                        <li><strong>íšŒì› ê´€ë¦¬:</strong> íšŒì›ì œ ì„œë¹„ìŠ¤ ì´ìš©ì— ë”°ë¥¸ ë³¸ì¸í™•ì¸, ê°œì¸ ì‹ë³„, ë¶ˆëŸ‰ íšŒì›ì˜ ë¶€ì • ì´ìš© ë°©ì§€, ê°€ì… ì˜ì‚¬ í™•ì¸, ë¯¼ì› ì²˜ë¦¬, ê³ ì§€ì‚¬í•­ ì „ë‹¬</li>
                        <li><strong>ë§ˆì¼€íŒ… ë° ê´‘ê³  (ë™ì˜ ì‹œ):</strong> ì‹ ê·œ ì„œë¹„ìŠ¤(Gems) ê°œë°œ ë° ë§ì¶¤ ì„œë¹„ìŠ¤ ì œê³µ, ì´ë²¤íŠ¸ ë° ê´‘ê³ ì„± ì •ë³´ ì œê³µ</li>
                    </ul>

                    <h2 class="section-title text-2xl">3. ê°œì¸ì •ë³´ì˜ ì œ3ì ì œê³µ</h2>
                    <p class="mb-4">íšŒì‚¬ëŠ” ì´ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼ ì›ì¹™ì ìœ¼ë¡œ ì™¸ë¶€ì— ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ë§Œ, ì•„ë˜ì˜ ê²½ìš°ì—ëŠ” ì˜ˆì™¸ë¡œ í•©ë‹ˆë‹¤.</p>
                    <ul class="list-disc pl-8 mb-6 space-y-2">
                        <li>ì´ìš©ìë“¤ì´ ì‚¬ì „ì— ë™ì˜í•œ ê²½ìš°</li>
                        <li>ë²•ë ¹ì˜ ê·œì •ì— ì˜ê±°í•˜ê±°ë‚˜, ìˆ˜ì‚¬ ëª©ì ìœ¼ë¡œ ë²•ë ¹ì— ì •í•´ì§„ ì ˆì°¨ì™€ ë°©ë²•ì— ë”°ë¼ ìˆ˜ì‚¬ê¸°ê´€ì˜ ìš”êµ¬ê°€ ìˆëŠ” ê²½ìš°</li>
                    </ul>

                    <h2 class="section-title text-2xl">4. ê°œì¸ì •ë³´ ì²˜ë¦¬ì˜ ìœ„íƒ â­</h2>
                    <p class="mb-4">íšŒì‚¬ëŠ” ì„œë¹„ìŠ¤ í–¥ìƒ ë° ì›í™œí•œ ê³„ì•½ ì´í–‰ì„ ìœ„í•´ ì•„ë˜ì™€ ê°™ì´ ê°œì¸ì •ë³´ ì²˜ë¦¬ë¥¼ ìœ„íƒí•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    <div class="overflow-x-auto mb-6">
                        <table class="min-w-full border-collapse border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold">ìˆ˜íƒì—…ì²´</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left font-semibold">ìœ„íƒ ì—…ë¬´ ë‚´ìš©</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="border border-gray-300 px-4 py-3">OpenAI, L.L.C., Google AI (ë¯¸êµ­)</td>
                                    <td class="border border-gray-300 px-4 py-3">AI ê¸°ë°˜ ë¦¬í¬íŠ¸ ë° ëœë”©í˜ì´ì§€ ìƒì„±ì„ ìœ„í•œ ë°ì´í„° ì²˜ë¦¬</td>
                                </tr>
                                <tr class="bg-gray-50">
                                    <td class="border border-gray-300 px-4 py-3">(ì£¼)ê¸¸ì»´í¼ë‹ˆ ë˜ëŠ” ì•Œë¦¬ê³ </td>
                                    <td class="border border-gray-300 px-4 py-3">ë¬¸ì ë©”ì‹œì§€(SMS/LMS) ë°œì†¡ ì‹œìŠ¤í…œ ìš´ì˜</td>
                                </tr>
                                <tr>
                                    <td class="border border-gray-300 px-4 py-3">Cloudflare / Vercel</td>
                                    <td class="border border-gray-300 px-4 py-3">ì„œë¹„ìŠ¤ ë°ì´í„° í˜¸ìŠ¤íŒ… ë° ë³´ì•ˆ ì„œë²„ ìš´ì˜</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h2 class="section-title text-2xl">5. ê°œì¸ì •ë³´ì˜ ë³´ìœ  ë° ì´ìš©ê¸°ê°„</h2>
                    <p class="mb-4">
                        íšŒì‚¬ëŠ” ì›ì¹™ì ìœ¼ë¡œ ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ëª©ì ì´ ë‹¬ì„±ëœ í›„ì—ëŠ” í•´ë‹¹ ì •ë³´ë¥¼ ì§€ì²´ ì—†ì´ íŒŒê¸°í•©ë‹ˆë‹¤. 
                        ë‹¨, ê´€ê³„ë²•ë ¹ì˜ ê·œì •ì— ì˜í•˜ì—¬ ë³´ì¡´í•  í•„ìš”ê°€ ìˆëŠ” ê²½ìš° ì•„ë˜ì™€ ê°™ì´ ì¼ì • ê¸°ê°„ ë³´ê´€í•©ë‹ˆë‹¤.
                    </p>
                    <ul class="list-disc pl-8 mb-6 space-y-2">
                        <li>ê³„ì•½ ë˜ëŠ” ì²­ì•½ì² íšŒ ë“±ì— ê´€í•œ ê¸°ë¡: 5ë…„ (ì „ììƒê±°ë˜ë²•)</li>
                        <li>ëŒ€ê¸ˆê²°ì œ ë° ì¬í™” ë“±ì˜ ê³µê¸‰ì— ê´€í•œ ê¸°ë¡: 5ë…„ (ì „ììƒê±°ë˜ë²•)</li>
                        <li>ì†Œë¹„ìì˜ ë¶ˆë§Œ ë˜ëŠ” ë¶„ìŸì²˜ë¦¬ì— ê´€í•œ ê¸°ë¡: 3ë…„ (ì „ììƒê±°ë˜ë²•)</li>
                        <li>ì›¹ì‚¬ì´íŠ¸ ë°©ë¬¸ ê¸°ë¡(ë¡œê·¸): 3ê°œì›” (í†µì‹ ë¹„ë°€ë³´í˜¸ë²•)</li>
                    </ul>

                    <h2 class="section-title text-2xl">6. ê°œì¸ì •ë³´ì˜ íŒŒê¸°ì ˆì°¨ ë° ë°©ë²•</h2>
                    
                    <h3 class="subsection-title text-xl">ê°€. íŒŒê¸°ì ˆì°¨</h3>
                    <p class="mb-4">
                        ì´ìš©ìì˜ ì •ë³´ëŠ” ëª©ì ì´ ë‹¬ì„±ëœ í›„ ë³„ë„ì˜ DBë¡œ ì˜®ê²¨ì ¸(ì¢…ì´ì˜ ê²½ìš° ë³„ë„ì˜ ì„œë¥˜í•¨) 
                        ë‚´ë¶€ ë°©ì¹¨ ë° ê¸°íƒ€ ê´€ë ¨ ë²•ë ¹ì— ì˜í•œ ì •ë³´ë³´í˜¸ ì‚¬ìœ ì— ë”°ë¼ ì¼ì • ê¸°ê°„ ì €ì¥ëœ í›„ íŒŒê¸°ë©ë‹ˆë‹¤.
                    </p>

                    <h3 class="subsection-title text-xl">ë‚˜. íŒŒê¸°ë°©ë²•</h3>
                    <p class="mb-6">
                        ì „ìì  íŒŒì¼ í˜•íƒœë¡œ ì €ì¥ëœ ê°œì¸ì •ë³´ëŠ” ê¸°ë¡ì„ ì¬ìƒí•  ìˆ˜ ì—†ëŠ” ê¸°ìˆ ì  ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ ì‚­ì œí•˜ë©°, 
                        ì¢…ì´ ë¬¸ì„œëŠ” ë¶„ì‡„í•˜ê±°ë‚˜ ì†Œê°í•˜ì—¬ íŒŒê¸°í•©ë‹ˆë‹¤.
                    </p>

                    <h2 class="section-title text-2xl">7. ì´ìš©ì ë° ë²•ì •ëŒ€ë¦¬ì¸ì˜ ê¶Œë¦¬ì™€ ê·¸ í–‰ì‚¬ë°©ë²•</h2>
                    <p class="mb-6">
                        ì´ìš©ìëŠ” ì–¸ì œë“ ì§€ ë“±ë¡ë˜ì–´ ìˆëŠ” ìì‹ ì˜ ê°œì¸ì •ë³´ë¥¼ ì¡°íšŒí•˜ê±°ë‚˜ ìˆ˜ì •í•  ìˆ˜ ìˆìœ¼ë©° ê°€ì… í•´ì§€ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
                        ê°œì¸ì •ë³´ ì¡°íšŒ/ìˆ˜ì •ì„ ìœ„í•´ì„œëŠ” 'ê°œì¸ì •ë³´ë³€ê²½'(ë˜ëŠ” 'íšŒì›ì •ë³´ìˆ˜ì •')ì„, 
                        ê°€ì… í•´ì§€ë¥¼ ìœ„í•´ì„œëŠ” 'íšŒì›íƒˆí‡´'ë¥¼ í´ë¦­í•˜ì—¬ ë³¸ì¸ í™•ì¸ ì ˆì°¨ë¥¼ ê±°ì¹œ í›„ ì§ì ‘ ì—´ëŒ, ì •ì • ë˜ëŠ” íƒˆí‡´ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                    </p>

                    <h2 class="section-title text-2xl">8. ê°œì¸ì •ë³´ ìë™ ìˆ˜ì§‘ ì¥ì¹˜ì˜ ì„¤ì¹˜/ìš´ì˜ ë° ê±°ë¶€ì— ê´€í•œ ì‚¬í•­</h2>
                    <p class="mb-6">
                        íšŒì‚¬ëŠ” ì´ìš©ìì—ê²Œ íŠ¹í™”ëœ ë§ì¶¤ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ì„œ ì´ìš©ìë“¤ì˜ ì •ë³´ë¥¼ ìˆ˜ì‹œë¡œ ì €ì¥í•˜ê³  ì°¾ì•„ë‚´ëŠ” 'ì¿ í‚¤(cookie)' ë“±ì„ ìš´ìš©í•©ë‹ˆë‹¤. 
                        ì´ìš©ìëŠ” ì¿ í‚¤ ì„¤ì¹˜ì— ëŒ€í•œ ì„ íƒê¶Œì„ ê°€ì§€ê³  ìˆìœ¼ë©°, ì›¹ë¸Œë¼ìš°ì € ì„¤ì •ì„ í†µí•´ ì¿ í‚¤ ì €ì¥ì„ ê±°ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
                        ë‹¨, ì¿ í‚¤ ì €ì¥ì„ ê±°ë¶€í•  ê²½ìš° ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì¼ë¶€ ì„œë¹„ìŠ¤ ì´ìš©ì— ì–´ë ¤ì›€ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>

                    <h2 class="section-title text-2xl">9. ê°œì¸ì •ë³´ì˜ ê¸°ìˆ ì /ê´€ë¦¬ì  ë³´í˜¸ ëŒ€ì±…</h2>
                    <p class="mb-4">
                        íšŒì‚¬ëŠ” ì´ìš©ìì˜ ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬í•¨ì— ìˆì–´ ë¶„ì‹¤, ë„ë‚œ, ìœ ì¶œ, ë³€ì¡° ë˜ëŠ” í›¼ì†ë˜ì§€ ì•Šë„ë¡ ë‹¤ìŒê³¼ ê°™ì€ ëŒ€ì±…ì„ ê°•êµ¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.
                    </p>
                    <ul class="list-disc pl-8 mb-6 space-y-2">
                        <li><strong>ì•”í˜¸í™”:</strong> ë¹„ë°€ë²ˆí˜¸ì™€ ì¤‘ìš” ë°ì´í„°ëŠ” ì•”í˜¸í™”ë˜ì–´ ì €ì¥ ë° ê´€ë¦¬ë©ë‹ˆë‹¤.</li>
                        <li><strong>í•´í‚¹ ëŒ€ë¹„:</strong> í•´í‚¹ì´ë‚˜ ì»´í“¨í„° ë°”ì´ëŸ¬ìŠ¤ ë“±ì— ì˜í•œ í”¼í•´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ë³´ì•ˆ í”„ë¡œê·¸ë¨ì„ ì„¤ì¹˜í•˜ê³  ì£¼ê¸°ì ì¸ ê°±ì‹ Â·ì ê²€ì„ í•˜ë©°, ì™¸ë¶€ë¡œë¶€í„° ì ‘ê·¼ì´ í†µì œëœ êµ¬ì—­ì— ì‹œìŠ¤í…œì„ ì„¤ì¹˜í•˜ê³  ê¸°ìˆ ì /ë¬¼ë¦¬ì ìœ¼ë¡œ ê°ì‹œ ë° ì°¨ë‹¨í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
                        <li><strong>ì·¨ê¸‰ ì§ì›ì˜ ìµœì†Œí™”:</strong> ê°œì¸ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì§ì›ì„ ìµœì†Œí•œìœ¼ë¡œ ì§€ì •í•˜ê³  ë‹´ë‹¹ìì— ëŒ€í•œ ìˆ˜ì‹œ êµìœ¡ì„ í†µí•´ ë³¸ ì •ì±…ì˜ ì¤€ìˆ˜ë¥¼ ê°•ì¡°í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
                    </ul>

                    <h2 class="section-title text-2xl">10. ê°œì¸ì •ë³´ë³´í˜¸ì±…ì„ì ë° ì—°ë½ì²˜</h2>
                    <p class="mb-4">íšŒì‚¬ëŠ” íšŒì›ì˜ ê°œì¸ì •ë³´ë¥¼ ë³´í˜¸í•˜ê³  ê°œì¸ì •ë³´ì™€ ê´€ë ¨í•œ ë¶ˆë§Œì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ ê´€ë ¨ ë¶€ì„œ ë° ê°œì¸ì •ë³´ë³´í˜¸ì±…ì„ìë¥¼ ì§€ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                    <div class="bg-purple-50 border-l-4 border-purple-600 p-6 mb-6">
                        <p class="font-semibold mb-2">ê°œì¸ì •ë³´ë³´í˜¸ì±…ì„ì(CPO): ê³ í¬ì¤€ (ëŒ€í‘œ)</p>
                        <p class="mb-1">ì—°ë½ì²˜: 010-8739-9697</p>
                        <p>ì´ë©”ì¼: wangholy1@naver.com</p>
                    </div>
                    <p class="mb-6">ê¸°íƒ€ ê°œì¸ì •ë³´ì¹¨í•´ì— ëŒ€í•œ ì‹ ê³ ë‚˜ ìƒë‹´ì´ í•„ìš”í•˜ì‹  ê²½ìš°ì—ëŠ” ì•„ë˜ ê¸°ê´€ì— ë¬¸ì˜í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                    <ul class="list-disc pl-8 mb-6 space-y-2">
                        <li>ê°œì¸ì •ë³´ì¹¨í•´ì‹ ê³ ì„¼í„° (privacy.kisa.or.kr / 118)</li>
                        <li>ëŒ€ê²€ì°°ì²­ ì‚¬ì´ë²„ìˆ˜ì‚¬ê³¼ (www.spo.go.kr / 1301)</li>
                        <li>ê²½ì°°ì²­ ì‚¬ì´ë²„ìˆ˜ì‚¬êµ­ (ecrm.police.go.kr / 182)</li>
                    </ul>

                    <h2 class="section-title text-2xl">11. ê³ ì§€ì˜ ì˜ë¬´</h2>
                    <p class="mb-6">
                        ì´ ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì€ 2026ë…„ 1ì›” 23ì¼ë¶€í„° ì ìš©ë©ë‹ˆë‹¤. 
                        ë‚´ìš©ì˜ ì¶”ê°€, ì‚­ì œ ë° ìˆ˜ì •ì´ ìˆì„ ì‹œì—ëŠ” ê°œì • ìµœì†Œ 7ì¼ ì „ë¶€í„° í™ˆí˜ì´ì§€ì˜ 'ê³µì§€ì‚¬í•­'ì„ í†µí•´ ê³ ì§€í•  ê²ƒì…ë‹ˆë‹¤.
                    </p>
                </div>

                <div class="mt-12 pt-8 border-t border-gray-200 text-center">
                    <a href="/" class="inline-block px-8 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition">
                        í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-900 text-gray-400 py-8 px-6">
            <div class="max-w-7xl mx-auto text-center">
                <p class="text-sm">&copy; 2024 ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤. All rights reserved.</p>
            </div>
        </footer>
    </body>
    </html>
  `)
})

// ì´ìš©ì•½ê´€ í˜ì´ì§€
app.get('/terms', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ - ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .section-title {
            color: #7c3aed;
            font-weight: 700;
            margin-top: 2rem;
            margin-bottom: 1rem;
          }
          .subsection-title {
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
          }
          .chapter-title {
            color: #fb923c;
            font-weight: 700;
            margin-top: 2.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #fb923c;
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100 shadow-sm">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="flex items-center space-x-3">
                        <img src="/static/images/logo.png" alt="SUPER PLACE" class="h-10" onerror="this.style.display='none'">
                        <span class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</span>
                    </a>
                    <a href="/" class="text-gray-700 hover:text-purple-600 font-medium transition">
                        í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="pt-32 pb-20 px-6">
            <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-8 md:p-12">
                <h1 class="text-4xl font-bold text-gray-900 mb-4">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</h1>
                <p class="text-gray-600 mb-8">ì‹œí–‰ì¼: 2026ë…„ 1ì›” 23ì¼</p>
                
                <div class="prose prose-lg max-w-none text-gray-700 leading-relaxed">
                    <h2 class="chapter-title text-3xl">ì œ 1 ì¥ ì´ ì¹™</h2>

                    <h3 class="section-title text-xl">ì œ 1 ì¡° (ëª©ì )</h3>
                    <p class="mb-6">
                        ì´ ì•½ê´€ì€ ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤(ì´í•˜ "íšŒì‚¬"ë¼ í•©ë‹ˆë‹¤)ê°€ ì œê³µí•˜ëŠ” í•™ì› ê´€ë¦¬ í”Œë«í¼, 
                        AI ë§ˆì¼€íŒ… ìë™í™” ì†”ë£¨ì…˜, ë¬¸ì ë°œì†¡ ì„œë¹„ìŠ¤ ë° ê¸°íƒ€ ì œë°˜ ì„œë¹„ìŠ¤(ì´í•˜ "ì„œë¹„ìŠ¤"ë¼ í•©ë‹ˆë‹¤)ì˜ ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬ 
                        íšŒì‚¬ì™€ íšŒì› ê°„ì˜ ê¶Œë¦¬, ì˜ë¬´ ë° ì±…ì„ì‚¬í•­, ê¸°íƒ€ í•„ìš”í•œ ì‚¬í•­ì„ ê·œì •í•¨ì„ ëª©ì ìœ¼ë¡œ í•©ë‹ˆë‹¤.
                    </p>

                    <h3 class="section-title text-xl">ì œ 2 ì¡° (ìš©ì–´ì˜ ì •ì˜)</h3>
                    <p class="mb-4">ì´ ì•½ê´€ì—ì„œ ì‚¬ìš©í•˜ëŠ” ìš©ì–´ì˜ ì •ì˜ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.</p>
                    <ul class="list-decimal pl-8 mb-6 space-y-3">
                        <li>"ì„œë¹„ìŠ¤"ë¼ í•¨ì€ êµ¬í˜„ë˜ëŠ” ë‹¨ë§ê¸°(PC, íœ´ëŒ€í˜• ë‹¨ë§ê¸° ë“±)ì™€ ìƒê´€ì—†ì´ íšŒì›ì´ ì´ìš©í•  ìˆ˜ ìˆëŠ” 'ìŠˆí¼í”Œë ˆì´ìŠ¤ ì•„ì¹´ë°ë¯¸' ë° ê´€ë ¨ ì œë°˜ ì„œë¹„ìŠ¤ë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
                        <li>"íšŒì›"ì´ë¼ í•¨ì€ íšŒì‚¬ì˜ ì„œë¹„ìŠ¤ì— ì ‘ì†í•˜ì—¬ ì´ ì•½ê´€ì— ë”°ë¼ íšŒì‚¬ì™€ ì´ìš©ê³„ì•½ì„ ì²´ê²°í•˜ê³  íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ëŠ” ê³ ê°(í•™ì›ì¥ ë° í•™ì› ê´€ê³„ì)ì„ ë§í•©ë‹ˆë‹¤.</li>
                        <li>"ì•„ì´ë””(ID)"ë¼ í•¨ì€ íšŒì›ì˜ ì‹ë³„ê³¼ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•˜ì—¬ íšŒì›ì´ ì •í•˜ê³  íšŒì‚¬ê°€ ìŠ¹ì¸í•˜ëŠ” ë¬¸ìì™€ ìˆ«ìì˜ ì¡°í•©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
                        <li>"ë¹„ë°€ë²ˆí˜¸"ë¼ í•¨ì€ íšŒì›ì´ ë¶€ì—¬ë°›ì€ IDì™€ ì¼ì¹˜ëœ íšŒì›ì„ì„ í™•ì¸í•˜ê³  ë¹„ë°€ë³´í˜¸ë¥¼ ìœ„í•´ íšŒì› ìì‹ ì´ ì •í•œ ë¬¸ì ë˜ëŠ” ìˆ«ìì˜ ì¡°í•©ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
                        <li>"í¬ì¸íŠ¸"ë¼ í•¨ì€ ì„œë¹„ìŠ¤ ë‚´ì—ì„œ ë¬¸ì ë©”ì‹œì§€(SMS/LMS) ë°œì†¡ ë“±ì„ ì´ìš©í•˜ê¸° ìœ„í•´ íšŒì›ì´ ìœ ìƒìœ¼ë¡œ ì¶©ì „í•˜ê±°ë‚˜ íšŒì‚¬ê°€ ë¬´ìƒìœ¼ë¡œ ì§€ê¸‰í•˜ëŠ” ê°€ìƒì˜ ê²°ì œ ìˆ˜ë‹¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
                        <li>"AI ê²°ê³¼ë¬¼"ì´ë¼ í•¨ì€ íšŒì›ì´ ì…ë ¥í•œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ê³µì§€ëŠ¥(OpenAI ë“±) ì•Œê³ ë¦¬ì¦˜ì„ í†µí•´ ìƒì„±ëœ ë¦¬í¬íŠ¸, ëœë”©í˜ì´ì§€, í…ìŠ¤íŠ¸ ë“±ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
                    </ul>

                    <h3 class="section-title text-xl">ì œ 3 ì¡° (ì•½ê´€ì˜ íš¨ë ¥ ë° ë³€ê²½)</h3>
                    <p class="mb-2">â‘  ì´ ì•½ê´€ì€ ì„œë¹„ìŠ¤ í™”ë©´ì— ê²Œì‹œí•˜ê±°ë‚˜ ê¸°íƒ€ì˜ ë°©ë²•ìœ¼ë¡œ íšŒì›ì—ê²Œ ê³µì§€í•¨ìœ¼ë¡œì¨ íš¨ë ¥ì´ ë°œìƒí•©ë‹ˆë‹¤.</p>
                    <p class="mb-2">â‘¡ íšŒì‚¬ëŠ” í•„ìš”í•˜ë‹¤ê³  ì¸ì •ë˜ëŠ” ê²½ìš° ã€Œì•½ê´€ì˜ ê·œì œì— ê´€í•œ ë²•ë¥ ã€ ë“± ê´€ë ¨ ë²•ë ¹ì„ ìœ„ë°°í•˜ì§€ ì•ŠëŠ” ë²”ìœ„ì—ì„œ ì´ ì•½ê´€ì„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <p class="mb-2">â‘¢ íšŒì‚¬ê°€ ì•½ê´€ì„ ë³€ê²½í•  ê²½ìš°ì—ëŠ” ì ìš©ì¼ì ë° ë³€ê²½ì‚¬ìœ ë¥¼ ëª…ì‹œí•˜ì—¬ í˜„í–‰ì•½ê´€ê³¼ í•¨ê»˜ ì„œë¹„ìŠ¤ ì´ˆê¸°í™”ë©´ì— ê·¸ ì ìš©ì¼ì 7ì¼ ì „ë¶€í„° ê³µì§€í•©ë‹ˆë‹¤. ë‹¨, íšŒì›ì—ê²Œ ë¶ˆë¦¬í•œ ë³€ê²½ì˜ ê²½ìš°ì—ëŠ” 30ì¼ ì „ë¶€í„° ê³µì§€í•˜ê³ , ì´ë©”ì¼ì´ë‚˜ ë¬¸ì ë“±ìœ¼ë¡œ ê°œë³„ í†µì§€í•©ë‹ˆë‹¤.</p>
                    <p class="mb-6">â‘£ íšŒì›ì´ ë³€ê²½ëœ ì•½ê´€ì— ë™ì˜í•˜ì§€ ì•Šì„ ê²½ìš° ì´ìš©ê³„ì•½ì„ í•´ì§€(íšŒì›íƒˆí‡´)í•  ìˆ˜ ìˆìœ¼ë©°, ë³€ê²½ëœ ì•½ê´€ì˜ íš¨ë ¥ ë°œìƒì¼ ì´í›„ì—ë„ ì„œë¹„ìŠ¤ë¥¼ ê³„ì† ì´ìš©í•˜ëŠ” ê²½ìš° ì•½ê´€ì˜ ë³€ê²½ì‚¬í•­ì— ë™ì˜í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.</p>

                    <h2 class="chapter-title text-3xl">ì œ 2 ì¥ ì´ìš©ê³„ì•½ì˜ ì²´ê²°</h2>

                    <h3 class="section-title text-xl">ì œ 4 ì¡° (ì´ìš©ê³„ì•½ì˜ ì„±ë¦½)</h3>
                    <p class="mb-2">â‘  ì´ìš©ê³„ì•½ì€ íšŒì›ì´ ë˜ê³ ì í•˜ëŠ” ì(ì´í•˜ "ê°€ì…ì‹ ì²­ì")ê°€ ì•½ê´€ì˜ ë‚´ìš©ì— ëŒ€í•˜ì—¬ ë™ì˜ë¥¼ í•œ ë‹¤ìŒ íšŒì›ê°€ì… ì‹ ì²­ì„ í•˜ê³  íšŒì‚¬ê°€ ì´ëŸ¬í•œ ì‹ ì²­ì— ëŒ€í•˜ì—¬ ìŠ¹ë‚™í•¨ìœ¼ë¡œì¨ ì²´ê²°ë©ë‹ˆë‹¤.</p>
                    <p class="mb-6">â‘¡ ê°€ì…ì‹ ì²­ìëŠ” ë§Œ 14ì„¸ ì´ìƒì´ì–´ì•¼ í•˜ë©°, ë§Œ 14ì„¸ ë¯¸ë§Œ ì•„ë™ì˜ íšŒì›ê°€ì…ì€ ì œí•œë©ë‹ˆë‹¤.</p>

                    <h3 class="section-title text-xl">ì œ 5 ì¡° (ì´ìš©ì‹ ì²­ì˜ ìŠ¹ë‚™ê³¼ ì œí•œ)</h3>
                    <p class="mb-4">â‘  íšŒì‚¬ëŠ” ê°€ì…ì‹ ì²­ìì˜ ì‹ ì²­ì— ëŒ€í•˜ì—¬ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìŠ¹ë‚™í•¨ì„ ì›ì¹™ìœ¼ë¡œ í•©ë‹ˆë‹¤. ë‹¤ë§Œ, íšŒì‚¬ëŠ” ë‹¤ìŒ ê° í˜¸ì— í•´ë‹¹í•˜ëŠ” ì‹ ì²­ì— ëŒ€í•˜ì—¬ëŠ” ìŠ¹ë‚™ì„ í•˜ì§€ ì•Šê±°ë‚˜ ì‚¬í›„ì— ì´ìš©ê³„ì•½ì„ í•´ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <ul class="list-decimal pl-8 mb-6 space-y-2">
                        <li>ê°€ì…ì‹ ì²­ìê°€ ì´ ì•½ê´€ì— ì˜í•˜ì—¬ ì´ì „ì— íšŒì›ìê²©ì„ ìƒì‹¤í•œ ì ì´ ìˆëŠ” ê²½ìš°</li>
                        <li>ì‹¤ëª…ì´ ì•„ë‹ˆê±°ë‚˜ íƒ€ì¸ì˜ ëª…ì˜ë¥¼ ì´ìš©í•œ ê²½ìš°</li>
                        <li>í—ˆìœ„ì˜ ì •ë³´ë¥¼ ê¸°ì¬í•˜ê±°ë‚˜, íšŒì‚¬ê°€ ì œì‹œí•˜ëŠ” ë‚´ìš©ì„ ê¸°ì¬í•˜ì§€ ì•Šì€ ê²½ìš°</li>
                        <li>ë¶€ì •í•œ ìš©ë„(ìŠ¤íŒ¸ ë¬¸ì ë°œì†¡, í•´í‚¹ ë“±)ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ê³ ì í•˜ëŠ” ê²½ìš°</li>
                        <li>íšŒì›ì˜ ê·€ì±…ì‚¬ìœ ë¡œ ì¸í•˜ì—¬ ìŠ¹ì¸ì´ ë¶ˆê°€ëŠ¥í•˜ê±°ë‚˜ ê¸°íƒ€ ê·œì •í•œ ì œë°˜ ì‚¬í•­ì„ ìœ„ë°˜í•˜ë©° ì‹ ì²­í•˜ëŠ” ê²½ìš°</li>
                    </ul>

                    <h2 class="chapter-title text-3xl">ì œ 3 ì¥ ê³„ì•½ ë‹¹ì‚¬ìì˜ ì˜ë¬´</h2>

                    <h3 class="section-title text-xl">ì œ 6 ì¡° (íšŒì‚¬ì˜ ì˜ë¬´)</h3>
                    <p class="mb-2">â‘  íšŒì‚¬ëŠ” ê´€ë ¨ ë²•ë ¹ê³¼ ì´ ì•½ê´€ì´ ê¸ˆì§€í•˜ê±°ë‚˜ ë¯¸í’ì–‘ì†ì— ë°˜í•˜ëŠ” í–‰ìœ„ë¥¼ í•˜ì§€ ì•Šìœ¼ë©°, ê³„ì†ì ì´ê³  ì•ˆì •ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê¸° ìœ„í•˜ì—¬ ìµœì„ ì„ ë‹¤í•˜ì—¬ ë…¸ë ¥í•©ë‹ˆë‹¤.</p>
                    <p class="mb-2">â‘¡ íšŒì‚¬ëŠ” íšŒì›ì´ ì•ˆì „í•˜ê²Œ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆë„ë¡ ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ ë³´ì•ˆ ì‹œìŠ¤í…œì„ ê°–ì¶”ì–´ì•¼ í•˜ë©° ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨ì„ ê³µì‹œí•˜ê³  ì¤€ìˆ˜í•©ë‹ˆë‹¤.</p>
                    <p class="mb-6">â‘¢ íšŒì‚¬ëŠ” AI ì„œë¹„ìŠ¤ ë° ì™¸ë¶€ API(ë„¤ì´ë²„ ë“±)ì˜ ê¸°ìˆ ì  í•œê³„ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí•  ê²½ìš°, ì´ë¥¼ ì‹œì •í•˜ê±°ë‚˜ íšŒì›ì—ê²Œ ê³ ì§€í•˜ê¸° ìœ„í•´ ë…¸ë ¥í•©ë‹ˆë‹¤.</p>

                    <h3 class="section-title text-xl">ì œ 7 ì¡° (íšŒì›ì˜ ì˜ë¬´)</h3>
                    <p class="mb-4">â‘  íšŒì›ì€ ë‹¤ìŒ í–‰ìœ„ë¥¼ í•˜ì—¬ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.</p>
                    <ul class="list-decimal pl-8 mb-6 space-y-2">
                        <li>ì‹ ì²­ ë˜ëŠ” ë³€ê²½ ì‹œ í—ˆìœ„ë‚´ìš©ì˜ ë“±ë¡</li>
                        <li>íƒ€ì¸ì˜ ì •ë³´ ë„ìš©</li>
                        <li>íšŒì‚¬ê°€ ê²Œì‹œí•œ ì •ë³´ì˜ ë³€ê²½ ë˜ëŠ” ì„œë¹„ìŠ¤ ë‚´ ë°ì´í„°(í…œí”Œë¦¿ ë“±)ì˜ ë¬´ë‹¨ í¬ë¡¤ë§ ë° ë³µì œ</li>
                        <li>íšŒì‚¬ì˜ ë™ì˜ ì—†ì´ ì˜ë¦¬ ëª©ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” í–‰ìœ„ (ë‹¨, í•™ì› ìš´ì˜ ëª©ì ì˜ ì •ìƒì  ì´ìš©ì€ ì œì™¸)</li>
                        <li>ì •ë³´í†µì‹ ë§ë²•ì„ ìœ„ë°˜í•˜ì—¬ ìˆ˜ì‹ ìì˜ ë™ì˜ ì—†ëŠ” ê´‘ê³ ì„± ì •ë³´(ìŠ¤íŒ¸ ë¬¸ì)ë¥¼ ì „ì†¡í•˜ëŠ” í–‰ìœ„</li>
                        <li>ê¸°íƒ€ ë¶ˆë²•ì ì´ê±°ë‚˜ ë¶€ë‹¹í•œ í–‰ìœ„</li>
                    </ul>

                    <h2 class="chapter-title text-3xl">ì œ 4 ì¥ ì„œë¹„ìŠ¤ì˜ ì´ìš©</h2>

                    <h3 class="section-title text-xl">ì œ 8 ì¡° (ì„œë¹„ìŠ¤ì˜ ì œê³µ ë° ë³€ê²½)</h3>
                    <p class="mb-2">â‘  ì„œë¹„ìŠ¤ëŠ” ì—°ì¤‘ë¬´íœ´, 1ì¼ 24ì‹œê°„ ì œê³µí•¨ì„ ì›ì¹™ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
                    <p class="mb-6">â‘¡ íšŒì‚¬ëŠ” AI ì•Œê³ ë¦¬ì¦˜ ì—…ë°ì´íŠ¸, ì™¸ë¶€ ì œíœ´ì‚¬(OpenAI, ë„¤ì´ë²„, í†µì‹ ì‚¬)ì˜ ì •ì±… ë³€ê²½, ê¸°ìˆ ì  í•„ìš”ì— ë”°ë¼ ì„œë¹„ìŠ¤ì˜ ë‚´ìš©ì„ ë³€ê²½í•˜ê±°ë‚˜ ì¤‘ë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° íšŒì‚¬ëŠ” ì‚¬ì „ì— ê³µì§€í•˜ë©°, íšŒì‚¬ì˜ ê³ ì˜ ë˜ëŠ” ì¤‘ê³¼ì‹¤ì´ ì—†ëŠ” í•œ ì´ë¡œ ì¸í•œ íšŒì›ì˜ ì†í•´ì— ëŒ€í•´ ì±…ì„ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

                    <h3 class="section-title text-xl">ì œ 9 ì¡° (AI ì„œë¹„ìŠ¤ ì´ìš© ë° ë©´ì±… íŠ¹ì•½) [ì¤‘ìš”]</h3>
                    <p class="mb-2">â‘  íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” AI ê¸°ë°˜ ì„œë¹„ìŠ¤(ëœë”©í˜ì´ì§€ ìƒì„±, í•™ìƒ ë¦¬í¬íŠ¸ ë“±)ëŠ” í™•ë¥ ì  ìƒì„± ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ í•˜ë¯€ë¡œ, ê²°ê³¼ë¬¼ì˜ ì™„ì „í•œ ì •í™•ì„±, ì ë²•ì„±, ë¬´ê²°ì„±ì„ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                    <p class="mb-2">â‘¡ íšŒì›ì€ AIê°€ ìƒì„±í•œ ê²°ê³¼ë¬¼ì„ í•™ë¶€ëª¨ ìƒë‹´, ë§ˆì¼€íŒ… ë“±ì— í™œìš©í•˜ê¸° ì „ì— ë°˜ë“œì‹œ ë‚´ìš©ì„ ê²€ìˆ˜í•˜ì—¬ì•¼ í•˜ë©°, ê²€ìˆ˜í•˜ì§€ ì•Šê³  í™œìš©í•˜ì—¬ ë°œìƒí•œ ë¬¸ì œ(í•™ìŠµ ì •ë³´ ì˜¤ë¥˜, ì €ì‘ê¶Œ ì¹¨í•´ ë“±)ì— ëŒ€í•œ ì±…ì„ì€ íšŒì› ë³¸ì¸ì—ê²Œ ìˆìŠµë‹ˆë‹¤.</p>
                    <p class="mb-6">â‘¢ íšŒì‚¬ëŠ” AI ì„œë¹„ìŠ¤ ì´ìš© ê²°ê³¼ë¡œ ì¸í•œ íšŒì›ì˜ ì˜ì—… ì†ì‹¤, ê¸°ëŒ€ ìˆ˜ìµ ìƒì‹¤ ë“±ì— ëŒ€í•˜ì—¬ ë°°ìƒ ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

                    <h3 class="section-title text-xl">ì œ 10 ì¡° (ë¬¸ì ë°œì†¡ ì„œë¹„ìŠ¤ ì´ìš© ë° ìŠ¤íŒ¸ ë°©ì§€) [ì¤‘ìš”]</h3>
                    <p class="mb-2">â‘  íšŒì›ì€ ë¬¸ì ë©”ì‹œì§€ ë°œì†¡ ì‹œ ã€Œì •ë³´í†µì‹ ë§ ì´ìš©ì´‰ì§„ ë° ì •ë³´ë³´í˜¸ ë“±ì— ê´€í•œ ë²•ë¥ ã€ ë° KISAì˜ ìŠ¤íŒ¸ë°©ì§€ ê°€ì´ë“œë¼ì¸ì„ ì¤€ìˆ˜í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.</p>
                    <p class="mb-2">â‘¡ ìˆ˜ì‹ ìì˜ ì‚¬ì „ ë™ì˜ ì—†ëŠ” ê´‘ê³ ì„± ì •ë³´ ì „ì†¡ìœ¼ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ë¯¼Â·í˜•ì‚¬ìƒ ì±…ì„ ë° ê³¼íƒœë£ŒëŠ” ì „ì ìœ¼ë¡œ íšŒì›ì´ ë¶€ë‹´í•˜ë©°, íšŒì‚¬ëŠ” ì´ì— ëŒ€í•´ ë©´ì±…ë©ë‹ˆë‹¤.</p>
                    <p class="mb-6">â‘¢ íšŒì‚¬ëŠ” íšŒì›ì´ ë¶ˆë²• ìŠ¤íŒ¸ì„ ì „ì†¡í•˜ëŠ” ê²ƒìœ¼ë¡œ ì˜ì‹¬ë˜ê±°ë‚˜ ê´€ê³„ ê¸°ê´€ì˜ ìš”ì²­ì´ ìˆëŠ” ê²½ìš°, ì¦‰ì‹œ ì„œë¹„ìŠ¤ ì´ìš©ì„ ì •ì§€í•˜ê³  ì”ì—¬ í¬ì¸íŠ¸ì˜ í™˜ë¶ˆì„ ê±°ë¶€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                    <h3 class="section-title text-xl">ì œ 11 ì¡° (ê¶Œë¦¬ì˜ ê·€ì† ë° ì €ì‘ê¶Œ)</h3>
                    <p class="mb-2">â‘  ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì €ì‘ê¶Œ ë° ì§€ì ì¬ì‚°ê¶Œì€ íšŒì‚¬ì— ê·€ì†ë©ë‹ˆë‹¤.</p>
                    <p class="mb-2">â‘¡ íšŒì›ì´ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ìƒì„±í•œ ì½˜í…ì¸ (ëœë”©í˜ì´ì§€ ë“±)ì˜ ì €ì‘ê¶Œì€ íšŒì›ì—ê²Œ ìˆìœ¼ë‚˜, íšŒì‚¬ëŠ” ì„œë¹„ìŠ¤ í’ˆì§ˆ ê°œì„ , AI ëª¨ë¸ í•™ìŠµ, í†µê³„ ì‘ì„± ë“±ì„ ìœ„í•˜ì—¬ íšŒì›ì˜ ë°ì´í„°ë¥¼ ê°œì¸ì„ ì‹ë³„í•  ìˆ˜ ì—†ëŠ” ìµëª…í™”ëœ í˜•íƒœë¡œ ê°€ê³µí•˜ì—¬ ì˜êµ¬ì ìœ¼ë¡œ ì‚¬ìš©(ë³µì œ, ìˆ˜ì •, ì „ì†¡ ë“±)í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <p class="mb-6">â‘¢ íšŒì›ì€ íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” í…œí”Œë¦¿, ë””ìì¸ ì†ŒìŠ¤ ë“±ì„ íšŒì‚¬ì˜ ì‚¬ì „ í—ˆë½ ì—†ì´ ì™¸ë¶€ë¡œ ìœ ì¶œí•˜ê±°ë‚˜ ì¬íŒë§¤í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>

                    <h2 class="chapter-title text-3xl">ì œ 5 ì¥ ì´ìš©ìš”ê¸ˆ ë° í™˜ë¶ˆ</h2>

                    <h3 class="section-title text-xl">ì œ 12 ì¡° (ìœ ë£Œ ì„œë¹„ìŠ¤ ë° í™˜ë¶ˆ ê·œì •)</h3>
                    <p class="mb-2">â‘  íšŒì‚¬ê°€ ì œê³µí•˜ëŠ” ìœ ë£Œ ì„œë¹„ìŠ¤ëŠ” 'ì •ê¸° êµ¬ë…í˜•'ê³¼ 'í¬ì¸íŠ¸ ì¶©ì „í˜•'ìœ¼ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤.</p>
                    <p class="mb-2">â‘¡ ë””ì§€í„¸ ì½˜í…ì¸ (AI ë¦¬í¬íŠ¸, ëœë”©í˜ì´ì§€ í…œí”Œë¦¿ ë“±)ì˜ ê²½ìš°: ã€Œì „ììƒê±°ë˜ ë“±ì—ì„œì˜ ì†Œë¹„ìë³´í˜¸ì— ê´€í•œ ë²•ë¥ ã€ì— ë”°ë¼ ì½˜í…ì¸ ë¥¼ ì—´ëŒí•˜ê±°ë‚˜ ì‚¬ìš©í•œ(AI ìƒì„± ë“±) ê²½ìš° ì²­ì•½ì² íšŒ(í™˜ë¶ˆ)ê°€ ì œí•œë©ë‹ˆë‹¤.</p>
                    <p class="mb-2">â‘¢ ë¬¸ì ë°œì†¡ í¬ì¸íŠ¸ì˜ ê²½ìš°: íšŒì›ì€ ì¶©ì „ í›„ ì‚¬ìš©í•˜ì§€ ì•Šì€ ì”ì—¬ í¬ì¸íŠ¸ì— ëŒ€í•´ í™˜ë¶ˆì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¨, ì´ ê²½ìš° ê²°ì œ ìˆ˜ìˆ˜ë£Œ ë° ìœ„ì•½ê¸ˆ(ì”ì•¡ì˜ 10% ë˜ëŠ” ìµœì†Œ 1,000ì›)ì„ ê³µì œí•œ ê¸ˆì•¡ì„ í™˜ë¶ˆí•©ë‹ˆë‹¤.</p>
                    <p class="mb-6">â‘£ íšŒì›ì´ ê´€ê³„ ë²•ë ¹ ë° ì•½ê´€ì„ ìœ„ë°˜í•˜ì—¬ ì´ìš©ì´ ì •ì§€ëœ ê²½ìš°, ì”ì—¬ ì´ìš©ê¸°ê°„ ë° í¬ì¸íŠ¸ì— ëŒ€í•œ í™˜ë¶ˆì€ ì´ë£¨ì–´ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

                    <h2 class="chapter-title text-3xl">ì œ 6 ì¥ ì†í•´ë°°ìƒ ë° ê¸°íƒ€ì‚¬í•­</h2>

                    <h3 class="section-title text-xl">ì œ 13 ì¡° (ì†í•´ë°°ìƒ)</h3>
                    <p class="mb-2">â‘  íšŒì‚¬ê°€ ê³ ì˜ ë˜ëŠ” ì¤‘ê³¼ì‹¤ë¡œ íšŒì›ì—ê²Œ ì†í•´ë¥¼ ë¼ì¹œ ê²½ìš°, ê·¸ ì†í•´ë¥¼ ë°°ìƒí•  ì±…ì„ì´ ìˆìŠµë‹ˆë‹¤.</p>
                    <p class="mb-6">â‘¡ íšŒì›ì€ ì´ ì•½ê´€ì„ ìœ„ë°˜í•˜ê±°ë‚˜ ë¶ˆë²•í–‰ìœ„ë¡œ ì¸í•˜ì—¬ íšŒì‚¬ì— ì†í•´ë¥¼ ë¼ì¹œ ê²½ìš°, ê·¸ ì†í•´ë¥¼ ë°°ìƒí•˜ì—¬ì•¼ í•©ë‹ˆë‹¤. (ìŠ¤íŒ¸ ë°œì†¡ìœ¼ë¡œ ì¸í•œ í†µì‹ ì‚¬ ê³¼íƒœë£Œ êµ¬ìƒê¶Œ ì²­êµ¬ ë“± í¬í•¨)</p>

                    <h3 class="section-title text-xl">ì œ 14 ì¡° (ë©´ì±…ì¡°í•­)</h3>
                    <p class="mb-2">â‘  íšŒì‚¬ëŠ” ì²œì¬ì§€ë³€, ë””ë„ìŠ¤(DDoS) ê³µê²©, IDC ì¥ì• , ê¸°ê°„í†µì‹ ì‚¬ì—…ìì˜ íšŒì„  ì¥ì•  ë“± ë¶ˆê°€í•­ë ¥ìœ¼ë¡œ ì¸í•˜ì—¬ ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•  ìˆ˜ ì—†ëŠ” ê²½ìš°ì—ëŠ” ì±…ì„ì´ ë©´ì œë©ë‹ˆë‹¤.</p>
                    <p class="mb-2">â‘¡ íšŒì‚¬ëŠ” íšŒì›ì´ ì…ë ¥í•œ ì •ë³´(í•™ìƒ ì„±ì , ê°œì¸ì •ë³´ ë“±)ì˜ ë¶€ì •í™•ì„±ìœ¼ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ì†í•´ì— ëŒ€í•˜ì—¬ ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                    <p class="mb-6">â‘¢ íšŒì‚¬ëŠ” ë¬´ë£Œë¡œ ì œê³µë˜ëŠ” ì„œë¹„ìŠ¤ ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬ ê´€ë ¨ ë²•ë ¹ì— íŠ¹ë³„í•œ ê·œì •ì´ ì—†ëŠ” í•œ ì±…ì„ì„ ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

                    <h3 class="section-title text-xl">ì œ 15 ì¡° (ì¬íŒê¶Œ ë° ì¤€ê±°ë²•)</h3>
                    <p class="mb-2">â‘  ì„œë¹„ìŠ¤ ì´ìš©ê³¼ ê´€ë ¨í•˜ì—¬ íšŒì‚¬ì™€ íšŒì› ê°„ì— ë°œìƒí•œ ë¶„ìŸì— ëŒ€í•´ì„œëŠ” íšŒì‚¬ì˜ ë³¸ì  ì†Œì¬ì§€ë¥¼ ê´€í• í•˜ëŠ” ë²•ì›ì„ ê´€í• ë²•ì›ìœ¼ë¡œ í•©ë‹ˆë‹¤.</p>
                    <p class="mb-6">â‘¡ ì´ ì•½ê´€ì˜ í•´ì„ ë° ë¶„ìŸì˜ í•´ê²°ì—ëŠ” ëŒ€í•œë¯¼êµ­ ë²•ë¥ ì„ ì ìš©í•©ë‹ˆë‹¤.</p>

                    <h2 class="section-title text-2xl">ë¶€ ì¹™</h2>
                    <p class="mb-6">ì´ ì•½ê´€ì€ 2026ë…„ 1ì›” 23ì¼ë¶€í„° ì‹œí–‰í•©ë‹ˆë‹¤.</p>
                </div>

                <div class="mt-12 pt-8 border-t border-gray-200 text-center">
                    <a href="/" class="inline-block px-8 py-3 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition">
                        í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-900 text-gray-400 py-8 px-6">
            <div class="max-w-7xl mx-auto text-center">
                <p class="text-sm">&copy; 2024 ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤. All rights reserved.</p>
            </div>
        </footer>
    </body>
    </html>
  `)
})

// ğŸ”§ ì„ì‹œ DB ì´ˆê¸°í™” API (ê´€ë¦¬ì ì „ìš© - í•œ ë²ˆë§Œ ì‹¤í–‰)
app.post('/api/admin/init-sender-table', async (c) => {
  try {
    const { adminSecret } = await c.req.json()
    
    // ê°„ë‹¨í•œ ë³´ì•ˆ ì²´í¬ (ì‹¤ì œë¡œëŠ” ë” ê°•ë ¥í•œ ì¸ì¦ í•„ìš”)
    if (adminSecret !== 'superplace-init-2026') {
      return c.json({ success: false, error: 'ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
    }

    console.log('Creating sender_verification_requests table...')

    // í…Œì´ë¸” ìƒì„±
    await c.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS sender_verification_requests (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        phone_number TEXT NOT NULL,
        business_name TEXT NOT NULL,
        business_registration_number TEXT NOT NULL,
        business_registration_image TEXT NOT NULL,
        certificate_image TEXT,
        employment_cert_image TEXT,
        contract_image TEXT,
        request_date DATETIME DEFAULT CURRENT_TIMESTAMP,
        status TEXT DEFAULT 'pending',
        admin_note TEXT,
        rejection_reason TEXT,
        processed_by INTEGER,
        processed_date DATETIME,
        FOREIGN KEY (user_id) REFERENCES users(id),
        FOREIGN KEY (processed_by) REFERENCES users(id)
      )
    `).run()

    // ì¸ë±ìŠ¤ ìƒì„±
    await c.env.DB.prepare(`
      CREATE INDEX IF NOT EXISTS idx_sender_verification_user_id ON sender_verification_requests(user_id)
    `).run()

    await c.env.DB.prepare(`
      CREATE INDEX IF NOT EXISTS idx_sender_verification_status ON sender_verification_requests(status)
    `).run()

    await c.env.DB.prepare(`
      CREATE INDEX IF NOT EXISTS idx_sender_verification_phone ON sender_verification_requests(phone_number)
    `).run()

    // sender_ids í…Œì´ë¸”ì— ì»¬ëŸ¼ ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œë¨)
    try {
      await c.env.DB.prepare(`ALTER TABLE sender_ids ADD COLUMN verification_request_id INTEGER`).run()
    } catch (e) {
      console.log('verification_request_id column already exists or error:', e.message)
    }

    try {
      await c.env.DB.prepare(`ALTER TABLE sender_ids ADD COLUMN business_name TEXT`).run()
    } catch (e) {
      console.log('business_name column already exists or error:', e.message)
    }

    try {
      await c.env.DB.prepare(`ALTER TABLE sender_ids ADD COLUMN business_registration_number TEXT`).run()
    } catch (e) {
      console.log('business_registration_number column already exists or error:', e.message)
    }

    console.log('Table creation complete!')

    return c.json({ 
      success: true, 
      message: 'âœ… sender_verification_requests í…Œì´ë¸”ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!' 
    })
  } catch (err) {
    console.error('Init table error:', err)
    return c.json({ 
      success: false, 
      error: 'í…Œì´ë¸” ìƒì„± ì‹¤íŒ¨: ' + err.message 
    }, 500)
  }
})

// ê¶Œí•œ ê´€ë¦¬ API
// ì‚¬ìš©ì ê¶Œí•œ ì¡°íšŒ API
app.get('/api/user/:id/permissions', async (c) => {
  try {
    const { env } = c;
    const userId = c.req.param('id');
    
    const permissions = await env.DB.prepare(`
      SELECT permission_type, permission_name, granted_at, expires_at, is_active
      FROM user_permissions
      WHERE user_id = ? AND is_active = 1
      ORDER BY granted_at DESC
    `).bind(userId).all();
    
    return c.json({ permissions: permissions.results });
  } catch (err) {
    console.error('Get permissions error:', err);
    return c.json({ success: false, error: 'ê¶Œí•œ ì¡°íšŒ ì‹¤íŒ¨' }, 500);
  }
});

// ê¶Œí•œ ë¶€ì—¬ API (ê´€ë¦¬ì ì „ìš©)
app.post('/api/admin/permissions/grant', async (c) => {
  try {
    const { env } = c;
    const { userId, permissionType, permissionName, expiresAt } = await c.req.json();
    
    const result = await env.DB.prepare(`
      INSERT INTO user_permissions (user_id, permission_type, permission_name, granted_by, expires_at, is_active)
      VALUES (?, ?, ?, 1, ?, 1)
    `).bind(userId, permissionType, permissionName, expiresAt || null).run();
    
    return c.json({ success: true, message: 'ê¶Œí•œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤' });
  } catch (err) {
    console.error('Grant permission error:', err);
    return c.json({ success: false, error: 'ê¶Œí•œ ë¶€ì—¬ ì‹¤íŒ¨' }, 500);
  }
});

// ê¶Œí•œ íšŒìˆ˜ API (ê´€ë¦¬ì ì „ìš©)
app.post('/api/admin/permissions/revoke', async (c) => {
  try {
    const { env } = c;
    const { userId, permissionType, permissionName } = await c.req.json();
    
    await env.DB.prepare(`
      UPDATE user_permissions
      SET is_active = 0
      WHERE user_id = ? AND permission_type = ? AND permission_name = ?
    `).bind(userId, permissionType, permissionName).run();
    
    return c.json({ success: true, message: 'ê¶Œí•œì´ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤' });
  } catch (err) {
    console.error('Revoke permission error:', err);
    return c.json({ success: false, error: 'ê¶Œí•œ íšŒìˆ˜ ì‹¤íŒ¨' }, 500);
  }
});

// ë¬¸ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸ API
app.patch('/api/admin/contacts/:id', async (c) => {
  try {
    const id = c.req.param('id')
    const { status } = await c.req.json()
    const { env } = c
    
    await env.DB.prepare('UPDATE contacts SET status = ? WHERE id = ?').bind(status, id).run()
    
    return c.json({ success: true })
  } catch (err) {
    console.error('Update contact status error:', err)
    return c.json({ success: false }, 500)
  }
})

// ========================================
// ê²°ì œ ê´€ë¦¬ API
// ========================================

// ê²°ì œ ê²€ì¦ ë° êµ¬ë… ìƒì„± API
app.post('/api/payment/verify', async (c) => {
  try {
    const { imp_uid, merchant_uid, plan, amount, user_id } = await c.req.json()
    const { DB } = c.env
    
    console.log('[Payment Verify] User:', user_id, 'Plan:', plan, 'Amount:', amount)
    
    // í”Œëœë³„ í•œë„ ì„¤ì •
    const planLimits: any = {
      'ìŠ¤íƒ€í„° í”Œëœ': { student: 50, ai_report: 50, landing_page: 50, teacher: 2, price: 55000 },
      'ë² ì´ì§ í”Œëœ': { student: 150, ai_report: 150, landing_page: 160, teacher: 6, price: 143000 },
      'í”„ë¡œ í”Œëœ': { student: 500, ai_report: 500, landing_page: 530, teacher: 20, price: 187000 },
      'í”„ë¦¬ë¯¸ì—„ í”Œëœ': { student: 1000, ai_report: 1000, landing_page: 1100, teacher: 40, price: 330000 },
      'ì—”í„°í”„ë¼ì´ì¦ˆ í”Œëœ': { student: 3000, ai_report: 3000, landing_page: 5000, teacher: 999, price: 750000 }
    }
    
    const limits = planLimits[plan] || planLimits['ìŠ¤íƒ€í„° í”Œëœ']
    
    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    const user: any = await DB.prepare('SELECT id, name, email FROM users WHERE id = ?').bind(user_id).first()
    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }
    
    // ì‚¬ìš©ìì˜ academy_id í™•ì¸ (ì—†ìœ¼ë©´ ìƒì„±)
    let academy: any = await DB.prepare(`
      SELECT id FROM academies WHERE owner_id = ?
    `).bind(user_id).first()
    
    if (!academy) {
      // í•™ì› ìƒì„±
      const academyResult = await DB.prepare(`
        INSERT INTO academies (academy_name, owner_id, created_at)
        VALUES (?, ?, CURRENT_TIMESTAMP)
      `).bind(user.name + ' í•™ì›', user_id).run()
      
      academy = { id: academyResult.meta.last_row_id }
      
      // users í…Œì´ë¸”ì— academy_id ì—…ë°ì´íŠ¸
      await DB.prepare(`
        UPDATE users SET academy_id = ? WHERE id = ?
      `).bind(academy.id, user_id).run()
      
      console.log('[Payment Verify] Created academy:', academy.id)
    }
    
    const academyId = academy.id
    
    // í•œêµ­ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œ ê³„ì‚°
    const startDate = new Date()
    const endDate = new Date()
    endDate.setMonth(endDate.getMonth() + 1)
    
    // êµ¬ë… ìƒì„±
    const subscriptionResult = await DB.prepare(`
      INSERT INTO subscriptions (
        academy_id, plan_name, plan_price, student_limit, ai_report_limit,
        landing_page_limit, teacher_limit, subscription_start_date,
        subscription_end_date, status, payment_method, merchant_uid, imp_uid,
        created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'active', 'card', ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `).bind(
      academyId,
      plan,
      limits.price,
      limits.student,
      limits.ai_report,
      limits.landing_page,
      limits.teacher,
      startDate.toISOString(),
      endDate.toISOString(),
      merchant_uid,
      imp_uid
    ).run()
    
    const subscriptionId = subscriptionResult.meta.last_row_id
    console.log('[Payment Verify] Created subscription:', subscriptionId)
    
    // usage_tracking ìƒì„±
    await DB.prepare(`
      INSERT INTO usage_tracking (
        academy_id, subscription_id, current_students, ai_reports_used_this_month,
        landing_pages_created, current_teachers, updated_at
      ) VALUES (?, ?, 0, 0, 0, 0, CURRENT_TIMESTAMP)
    `).bind(academyId, subscriptionId).run()
    
    console.log('[Payment Verify] Created usage_tracking')
    
    // payments í…Œì´ë¸”ì— ê¸°ë¡
    const paymentId = 'PAY_' + Date.now()
    await DB.prepare(`
      INSERT INTO payments (id, subscription_id, user_id, amount, payment_method, merchant_uid, imp_uid, status, created_at)
      VALUES (?, ?, ?, ?, 'card', ?, ?, 'completed', datetime('now'))
    `).bind(paymentId, subscriptionId, user_id, amount, merchant_uid, imp_uid).run()
    
    // ğŸ”¥ í”„ë¡œê·¸ë¨ ìë™ ë“±ë¡ (4ê°œ ê¸°ë³¸ í”„ë¡œê·¸ë¨)
    const programs = [
      { route: '/students', name: 'í•™ìƒ ê´€ë¦¬' },
      { route: '/tools/ai-learning-report', name: 'AIí•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸' },
      { route: '/tools/dashboard-analytics', name: 'í†µí•© ë¶„ì„ ëŒ€ì‹œë³´ë“œ' },
      { route: '/tools/search-volume', name: 'ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ' }
    ]
    
    // user_programs í…Œì´ë¸”ì— ê¸°ë³¸ 4ê°œ í”„ë¡œê·¸ë¨ ì¶”ê°€
    for (const program of programs) {
      try {
        await DB.prepare(`
          INSERT OR IGNORE INTO user_programs (user_id, program_route, program_name, enabled, created_at)
          VALUES (?, ?, ?, 1, CURRENT_TIMESTAMP)
        `).bind(user_id, program.route, program.name).run()
      } catch (e) {
        console.error('[Payment Verify] Failed to add program:', program.name, e)
      }
    }
    
    console.log('[Payment Verify] Added 4 basic programs for user:', user_id)
    
    return c.json({
      success: true,
      message: 'ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤',
      subscription_id: subscriptionId,
      academy_id: academyId,
      subscription: { id: subscriptionId, plan: plan, startDate: startDate.toISOString(), endDate: endDate.toISOString() }
    })
  } catch (error: any) {
    console.error('Payment verification error:', error)
    return c.json({ success: false, error: error.message || 'ê²°ì œ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤' }, 500)
  }
})

// ì‚¬ìš©ì êµ¬ë… ì •ë³´ ì¡°íšŒ API
app.get('/api/subscription/:userId', async (c) => {
  try {
    const userId = c.req.param('userId')
    const { DB } = c.env
    
    const subscription = await DB.prepare(`
      SELECT * FROM subscriptions WHERE user_id = ? AND status = 'active' ORDER BY created_at DESC LIMIT 1
    `).bind(userId).first()
    
    return c.json({ success: true, subscription: subscription || null })
  } catch (error: any) {
    console.error('Get subscription error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ê²°ì œ ë‚´ì—­ ì¡°íšŒ API
app.get('/api/payments/:userId', async (c) => {
  try {
    const userId = c.req.param('userId')
    const { DB } = c.env
    
    const { results } = await DB.prepare(`
      SELECT p.*, s.plan_type FROM payments p
      LEFT JOIN subscriptions s ON p.subscription_id = s.id
      WHERE p.user_id = ? ORDER BY p.created_at DESC
    `).bind(userId).all()
    
    return c.json({ success: true, payments: results || [] })
  } catch (error: any) {
    console.error('Get payments error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// êµ¬ë… ì·¨ì†Œ API
app.post('/api/subscription/:subscriptionId/cancel', async (c) => {
  try {
    const subscriptionId = c.req.param('subscriptionId')
    const { DB } = c.env
    
    await DB.prepare(`
      UPDATE subscriptions SET status = 'cancelled', updated_at = datetime('now') WHERE id = ?
    `).bind(subscriptionId).run()
    
    return c.json({ success: true, message: 'êµ¬ë…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤' })
  } catch (error: any) {
    console.error('Cancel subscription error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ê²°ì œ ê´€ë ¨ í…Œì´ë¸” ì´ˆê¸°í™” API
app.post('/api/admin/init-payment-tables', async (c) => {
  try {
    const { DB } = c.env
    
    // Create academies table FIRST (before subscriptions, since subscriptions references it)
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS academies (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        academy_name TEXT NOT NULL,
        owner_id INTEGER NOT NULL,
        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (owner_id) REFERENCES users(id)
      )
    `).run()
    
    // Drop old subscriptions table if exists (for migration)
    try {
      await DB.prepare(`DROP TABLE IF EXISTS old_subscriptions`).run()
      await DB.prepare(`ALTER TABLE subscriptions RENAME TO old_subscriptions`).run()
    } catch (e) {
      // Table doesn't exist or already migrated
    }
    
    // Create new subscriptions table with correct schema (AFTER academies table)
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS subscriptions (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        academy_id INTEGER NOT NULL,
        plan_name TEXT NOT NULL,
        plan_price INTEGER NOT NULL DEFAULT 0,
        student_limit INTEGER NOT NULL DEFAULT 30,
        ai_report_limit INTEGER NOT NULL DEFAULT 30,
        landing_page_limit INTEGER NOT NULL DEFAULT 40,
        teacher_limit INTEGER NOT NULL DEFAULT 2,
        subscription_start_date TEXT NOT NULL,
        subscription_end_date TEXT NOT NULL,
        status TEXT DEFAULT 'active',
        payment_method TEXT,
        merchant_uid TEXT,
        imp_uid TEXT,
        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
        updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (academy_id) REFERENCES academies(id)
      )
    `).run()
    
    // Create usage_tracking table
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS usage_tracking (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        academy_id INTEGER NOT NULL,
        subscription_id INTEGER NOT NULL,
        current_students INTEGER DEFAULT 0,
        ai_reports_used_this_month INTEGER DEFAULT 0,
        landing_pages_created INTEGER DEFAULT 0,
        current_teachers INTEGER DEFAULT 0,
        updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (academy_id) REFERENCES academies(id),
        FOREIGN KEY (subscription_id) REFERENCES subscriptions(id)
      )
    `).run()
    
    // Create bank_transfer_requests table
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS bank_transfer_requests (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        user_name TEXT NOT NULL,
        user_email TEXT NOT NULL,
        user_phone TEXT NOT NULL,
        plan_name TEXT NOT NULL,
        amount INTEGER NOT NULL,
        note TEXT,
        status TEXT DEFAULT 'pending',
        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
        approved_at TEXT,
        approved_by TEXT,
        rejected_at TEXT,
        rejected_by TEXT,
        rejection_reason TEXT,
        FOREIGN KEY (user_id) REFERENCES users(id)
      )
    `).run()
    
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS payments (
        id TEXT PRIMARY KEY,
        subscription_id INTEGER NOT NULL,
        user_id INTEGER NOT NULL,
        amount INTEGER NOT NULL,
        payment_method TEXT NOT NULL,
        merchant_uid TEXT NOT NULL,
        imp_uid TEXT,
        status TEXT DEFAULT 'pending',
        created_at TEXT NOT NULL,
        FOREIGN KEY (subscription_id) REFERENCES subscriptions(id),
        FOREIGN KEY (user_id) REFERENCES users(id)
      )
    `).run()
    
    // Create indexes
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_subscriptions_academy_id ON subscriptions(academy_id)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_subscriptions_status ON subscriptions(status)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_academies_owner_id ON academies(owner_id)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_usage_tracking_academy_id ON usage_tracking(academy_id)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_usage_tracking_subscription_id ON usage_tracking(subscription_id)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_payments_user_id ON payments(user_id)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_payments_subscription_id ON payments(subscription_id)`).run()
    
    // Add academy_id column to users if not exists
    try {
      await DB.prepare(`ALTER TABLE users ADD COLUMN academy_id INTEGER`).run()
    } catch (e) {
      // Column already exists
    }
    
    return c.json({
      success: true,
      message: 'ê²°ì œ ê´€ë ¨ í…Œì´ë¸”ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (subscriptions, payments, academies, usage_tracking)'
    })
  } catch (error: any) {
    console.error('Init payment tables error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ë¬´ë£Œ í”Œëœ í…Œì´ë¸” ì´ˆê¸°í™” API
app.post('/api/admin/init-free-plan-table', async (c) => {
  try {
    const { DB } = c.env
    
    // Drop and recreate free_plan_requests table with correct schema
    await DB.prepare(`DROP TABLE IF EXISTS free_plan_requests`).run()
    
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS free_plan_requests (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id TEXT NOT NULL,
        academy_name TEXT NOT NULL,
        owner_name TEXT NOT NULL,
        email TEXT NOT NULL,
        phone TEXT NOT NULL,
        reason TEXT,
        status TEXT NOT NULL DEFAULT 'pending',
        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
        approved_at TEXT,
        approved_by TEXT,
        rejected_at TEXT,
        rejected_by TEXT,
        rejection_reason TEXT
      )
    `).run()
    
    // Create indexes for better performance
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_free_plan_user_id ON free_plan_requests(user_id)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_free_plan_status ON free_plan_requests(status)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_free_plan_created_at ON free_plan_requests(created_at)`).run()
    
    return c.json({
      success: true,
      message: 'ë¬´ë£Œ í”Œëœ í…Œì´ë¸”ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (free_plan_requests)'
    })
  } catch (error: any) {
    console.error('Init free plan table error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// Database migration endpoint - run this to fix academy_id issues
app.post('/api/admin/migrate-database', async (c) => {
  try {
    const { DB } = c.env
    const migrations = []
    
    // 1. Add academy_id to users table if not exists
    try {
      await DB.prepare(`ALTER TABLE users ADD COLUMN academy_id INTEGER`).run()
      migrations.push('Added academy_id column to users table')
    } catch (e) {
      migrations.push('users.academy_id already exists')
    }
    
    // 2. Create academies table if not exists
    try {
      await DB.prepare(`
        CREATE TABLE IF NOT EXISTS academies (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          academy_name TEXT NOT NULL,
          owner_id INTEGER NOT NULL,
          created_at TEXT DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (owner_id) REFERENCES users(id)
        )
      `).run()
      migrations.push('Created academies table')
    } catch (e) {
      migrations.push('academies table already exists')
    }
    
    // 3. Create new subscriptions table
    try {
      await DB.prepare(`DROP TABLE IF EXISTS subscriptions_backup`).run()
      await DB.prepare(`ALTER TABLE subscriptions RENAME TO subscriptions_backup`).run()
      migrations.push('Backed up old subscriptions table')
    } catch (e) {
      migrations.push('No old subscriptions table to backup')
    }
    
    try {
      await DB.prepare(`
        CREATE TABLE IF NOT EXISTS subscriptions (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          academy_id INTEGER NOT NULL,
          plan_name TEXT NOT NULL,
          plan_price INTEGER NOT NULL DEFAULT 0,
          student_limit INTEGER NOT NULL DEFAULT 30,
          ai_report_limit INTEGER NOT NULL DEFAULT 30,
          landing_page_limit INTEGER NOT NULL DEFAULT 40,
          teacher_limit INTEGER NOT NULL DEFAULT 2,
          subscription_start_date TEXT NOT NULL,
          subscription_end_date TEXT NOT NULL,
          status TEXT DEFAULT 'active',
          payment_method TEXT,
          merchant_uid TEXT,
          imp_uid TEXT,
          created_at TEXT DEFAULT CURRENT_TIMESTAMP,
          updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (academy_id) REFERENCES academies(id)
        )
      `).run()
      migrations.push('Created new subscriptions table with academy_id')
    } catch (e: any) {
      migrations.push('Subscriptions table creation: ' + e.message)
    }
    
    // 4. Create usage_tracking table
    try {
      await DB.prepare(`
        CREATE TABLE IF NOT EXISTS usage_tracking (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          academy_id INTEGER,
          subscription_id INTEGER,
          current_students INTEGER DEFAULT 0,
          ai_reports_used_this_month INTEGER DEFAULT 0,
          landing_pages_created INTEGER DEFAULT 0,
          current_teachers INTEGER DEFAULT 0,
          updated_at TEXT DEFAULT CURRENT_TIMESTAMP
        )
      `).run()
      migrations.push('âœ… Created usage_tracking table (no FK constraints)')
    } catch (e: any) {
      migrations.push('â„¹ï¸ usage_tracking table: ' + e.message)
    }
    
    // 5. Create indexes
    const indexes = [
      'CREATE INDEX IF NOT EXISTS idx_subscriptions_academy_id ON subscriptions(academy_id)',
      'CREATE INDEX IF NOT EXISTS idx_subscriptions_status ON subscriptions(status)',
      'CREATE INDEX IF NOT EXISTS idx_academies_owner_id ON academies(owner_id)',
      'CREATE INDEX IF NOT EXISTS idx_usage_tracking_academy_id ON usage_tracking(academy_id)',
      'CREATE INDEX IF NOT EXISTS idx_usage_tracking_subscription_id ON usage_tracking(subscription_id)'
    ]
    
    for (const indexSql of indexes) {
      try {
        await DB.prepare(indexSql).run()
      } catch (e) {
        // Index already exists
      }
    }
    migrations.push('Created/verified all indexes')
    
    return c.json({
      success: true,
      message: 'ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
      migrations
    })
  } catch (error: any) {
    console.error('Database migration error:', error)
    return c.json({ 
      success: false, 
      error: error.message,
      stack: error.stack 
    }, 500)
  }
})

// ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
// DB ì—°ê²° í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸
app.get('/api/test/db', async (c) => {
  const { env } = c
  try {
    if (!env.DB) {
      return c.json({ success: false, error: 'DB binding not found', env_keys: Object.keys(env) })
    }
    
    const result = await env.DB.prepare('SELECT 1 as test').first()
    return c.json({ success: true, message: 'DB connection OK', result })
  } catch (error: any) {
    return c.json({ success: false, error: error.message, stack: error.stack }, 500)
  }
})

// ========================================
// ê¸°ëŠ¥ ì†Œê°œ í˜ì´ì§€
// ========================================

// ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ ì†Œê°œ
app.get('/features/search-volume', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
          .gradient-cyan { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/dashboard" class="text-2xl font-bold text-cyan-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/dashboard" class="text-gray-600 hover:text-cyan-600">â† ëŒ€ì‹œë³´ë“œ</a>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-12">
            <!-- Hero Section -->
            <div class="text-center mb-16">
                <div class="inline-block px-4 py-2 bg-cyan-100 rounded-full text-cyan-700 text-sm font-semibold mb-4">
                    ğŸ“Š ì‹¤ì‹œê°„ ë°ì´í„° ë¶„ì„
                </div>
                <h1 class="text-5xl font-bold text-gray-900 mb-6">ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒ</h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    í‚¤ì›Œë“œ ê²€ìƒ‰ëŸ‰ê³¼ ê²½ìŸ í˜„í™©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ íŒŒì•…í•˜ì„¸ìš”.<br>
                    ë°ì´í„° ê¸°ë°˜ ë§ˆì¼€íŒ… ì „ëµìœ¼ë¡œ í•™ì› í™ë³´ íš¨ê³¼ë¥¼ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <!-- ì£¼ìš” ê¸°ëŠ¥ -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì£¼ìš” ê¸°ëŠ¥</h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-cyan-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-search text-3xl text-cyan-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">í‚¤ì›Œë“œ ê²€ìƒ‰ëŸ‰ ë¶„ì„</h3>
                        <p class="text-gray-600">
                            ì›í•˜ëŠ” í‚¤ì›Œë“œì˜ ì›”ê°„ ê²€ìƒ‰ëŸ‰ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¡°íšŒí•˜ê³  íŠ¸ë Œë“œë¥¼ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-chart-line text-3xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ê²½ìŸ í˜„í™© ë¶„ì„</h3>
                        <p class="text-gray-600">
                            ê´€ë ¨ í‚¤ì›Œë“œì˜ ê²½ìŸ ê°•ë„ì™€ ê´‘ê³  ë¹„ìš©ì„ í™•ì¸í•˜ì—¬ íš¨ìœ¨ì ì¸ ë§ˆì¼€íŒ… ì „ëµì„ ìˆ˜ë¦½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-lightbulb text-3xl text-purple-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ì—°ê´€ í‚¤ì›Œë“œ ì¶”ì²œ</h3>
                        <p class="text-gray-600">
                            ì…ë ¥í•œ í‚¤ì›Œë“œì™€ ê´€ë ¨ëœ ì¶”ì²œ í‚¤ì›Œë“œë¥¼ ìë™ìœ¼ë¡œ ì œê³µí•˜ì—¬ ë§ˆì¼€íŒ… ê¸°íšŒë¥¼ ë°œêµ´í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš© ë°©ë²• -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì‚¬ìš© ë°©ë²•</h2>
                <div class="space-y-6">
                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-cyan-600 text-white rounded-full flex items-center justify-center font-bold text-xl">1</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">í‚¤ì›Œë“œ ì…ë ¥</h3>
                            <p class="text-gray-600">ì¡°íšŒí•˜ê³  ì‹¶ì€ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•©ë‹ˆë‹¤. ì˜ˆ: "ìˆ˜í•™í•™ì›", "ì˜ì–´ê³¼ì™¸" ë“±</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-cyan-600 text-white rounded-full flex items-center justify-center font-bold text-xl">2</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ê²€ìƒ‰ëŸ‰ í™•ì¸</h3>
                            <p class="text-gray-600">ì›”ê°„ ê²€ìƒ‰ëŸ‰, PC/ëª¨ë°”ì¼ ë¹„ìœ¨, ê²½ìŸ ê°•ë„ ë“±ì˜ ë°ì´í„°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-cyan-600 text-white rounded-full flex items-center justify-center font-bold text-xl">3</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ì—°ê´€ í‚¤ì›Œë“œ ë¶„ì„</h3>
                            <p class="text-gray-600">ì¶”ì²œëœ ì—°ê´€ í‚¤ì›Œë“œë¥¼ í™•ì¸í•˜ê³  ì¶”ê°€ë¡œ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-cyan-600 text-white rounded-full flex items-center justify-center font-bold text-xl">4</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ë§ˆì¼€íŒ… ì „ëµ ìˆ˜ë¦½</h3>
                            <p class="text-gray-600">ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¸”ë¡œê·¸, í”Œë ˆì´ìŠ¤, ê´‘ê³  ë“±ì˜ ë§ˆì¼€íŒ… ì „ëµì„ ìˆ˜ë¦½í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¥ì  -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì™œ ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰ ì¡°íšŒë¥¼ ì‚¬ìš©í•´ì•¼ í• ê¹Œìš”?</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-cyan-50 to-cyan-100 rounded-xl p-6 border border-cyan-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-cyan-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì •</h3>
                                <p class="text-gray-700">ì‹¤ì œ ê²€ìƒ‰ëŸ‰ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ íš¨ê³¼ì ì¸ ë§ˆì¼€íŒ… ì „ëµì„ ìˆ˜ë¦½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-blue-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ì˜ˆì‚° ìµœì í™”</h3>
                                <p class="text-gray-700">ê²€ìƒ‰ëŸ‰ì´ ë§ê³  ê²½ìŸì´ ì ì€ í‚¤ì›Œë“œë¥¼ ì°¾ì•„ ê´‘ê³  ë¹„ìš©ì„ ì ˆê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-purple-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">íŠ¸ë Œë“œ íŒŒì•…</h3>
                                <p class="text-gray-700">ì‹¤ì‹œê°„ ê²€ìƒ‰ íŠ¸ë Œë“œë¥¼ íŒŒì•…í•˜ì—¬ ì‹œì˜ì ì ˆí•œ ë§ˆì¼€íŒ…ì„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-green-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ê²½ìŸ ìš°ìœ„ í™•ë³´</h3>
                                <p class="text-gray-700">ê²½ìŸì‚¬ê°€ ê°„ê³¼í•˜ëŠ” í‹ˆìƒˆ í‚¤ì›Œë“œë¥¼ ë°œêµ´í•˜ì—¬ ê²½ìŸì—ì„œ ì•ì„œê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CTA -->
            <div class="text-center bg-gradient-to-r from-cyan-600 to-cyan-700 rounded-2xl p-12 text-white">
                <h2 class="text-3xl font-bold mb-4">í”Œëœì„ ì‹œì‘í•´ë³´ì„¸ìš”!</h2>
                <p class="text-xl mb-8 text-cyan-100">ë°ì´í„° ê¸°ë°˜ ë§ˆì¼€íŒ…ìœ¼ë¡œ í•™ì›ì„ ì„±ì¥ì‹œí‚¤ì„¸ìš”</p>
                <a href="/pricing" class="inline-block px-8 py-4 bg-white text-cyan-600 rounded-xl font-bold text-lg hover:bg-cyan-50 transition shadow-lg">
                    ìš”ê¸ˆì œ ë³´ê¸° â†’
                </a>
            </div>
        </div>
    </body>
    </html>
  `)
})

// ëœë”©í˜ì´ì§€ ìƒì„±ê¸° ì†Œê°œ
app.get('/features/landing-builder', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ëœë”©í˜ì´ì§€ ìƒì„±ê¸° - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
          .gradient-purple { background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/dashboard" class="text-gray-600 hover:text-purple-600">â† ëŒ€ì‹œë³´ë“œ</a>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-12">
            <!-- Hero Section -->
            <div class="text-center mb-16">
                <div class="inline-block px-4 py-2 bg-purple-100 rounded-full text-purple-700 text-sm font-semibold mb-4">
                    ğŸš€ AI ê¸°ë°˜ ìë™í™” ë„êµ¬
                </div>
                <h1 class="text-5xl font-bold text-gray-900 mb-6">ëœë”©í˜ì´ì§€ ìƒì„±ê¸°</h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    AIê°€ ìë™ìœ¼ë¡œ ì „ë¬¸ì ì¸ ëœë”©í˜ì´ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.<br>
                    í•™ì› ì†Œê°œ, í”„ë¡œê·¸ë¨ í™ë³´, í•™ìƒ ë¦¬í¬íŠ¸ë¥¼ ê°„í¸í•˜ê²Œ ì œì‘í•˜ê³  ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê³µìœ í•˜ì„¸ìš”.
                </p>
            </div>

            <!-- ì£¼ìš” ê¸°ëŠ¥ -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì£¼ìš” ê¸°ëŠ¥</h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-magic text-3xl text-purple-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">AI ìë™ ìƒì„±</h3>
                        <p class="text-gray-600">
                            ê°„ë‹¨í•œ ì •ë³´ë§Œ ì…ë ¥í•˜ë©´ AIê°€ ì „ë¬¸ì ì¸ ë””ìì¸ì˜ ëœë”©í˜ì´ì§€ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-mobile-alt text-3xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ëª¨ë°”ì¼ ìµœì í™”</h3>
                        <p class="text-gray-600">
                            ëª¨ë“  í˜ì´ì§€ëŠ” ëª¨ë°”ì¼ í™˜ê²½ì— ìµœì í™”ë˜ì–´ ì–´ë–¤ ê¸°ê¸°ì—ì„œë„ ì™„ë²½í•˜ê²Œ í‘œì‹œë©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-green-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fab fa-kickstarter text-3xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ì¹´ì¹´ì˜¤í†¡ ê³µìœ </h3>
                        <p class="text-gray-600">
                            ìƒì„±ëœ í˜ì´ì§€ë¥¼ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ë°”ë¡œ ê³µìœ í•˜ì—¬ í•™ë¶€ëª¨ë‹˜ê»˜ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš© ë°©ë²• -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì‚¬ìš© ë°©ë²•</h2>
                <div class="space-y-6">
                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold text-xl">1</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">í˜ì´ì§€ ìœ í˜• ì„ íƒ</h3>
                            <p class="text-gray-600">í•™ì› ì†Œê°œ, í”„ë¡œê·¸ë¨ í™ë³´, í•™ìƒ ë¦¬í¬íŠ¸ ì¤‘ ì›í•˜ëŠ” ìœ í˜•ì„ ì„ íƒí•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold text-xl">2</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ì •ë³´ ì…ë ¥</h3>
                            <p class="text-gray-600">í•™ì› ì´ë¦„, í”„ë¡œê·¸ë¨ ì„¤ëª…, í•™ìƒ ì •ë³´ ë“± í•„ìš”í•œ ë‚´ìš©ì„ ê°„ë‹¨íˆ ì…ë ¥í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold text-xl">3</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">AI ìë™ ìƒì„±</h3>
                            <p class="text-gray-600">AIê°€ ì…ë ¥ëœ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì „ë¬¸ì ì¸ ëœë”©í˜ì´ì§€ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-purple-600 text-white rounded-full flex items-center justify-center font-bold text-xl">4</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ê³µìœ  ë° ê´€ë¦¬</h3>
                            <p class="text-gray-600">ìƒì„±ëœ í˜ì´ì§€ë¥¼ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê³µìœ í•˜ê±°ë‚˜ ë§í¬ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¥ì  -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì™œ ëœë”©í˜ì´ì§€ ìƒì„±ê¸°ë¥¼ ì‚¬ìš©í•´ì•¼ í• ê¹Œìš”?</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-purple-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ì‹œê°„ ì ˆì•½</h3>
                                <p class="text-gray-700">ë””ìì´ë„ˆë‚˜ ê°œë°œì ì—†ì´ë„ ëª‡ ë¶„ ë§Œì— ì „ë¬¸ì ì¸ í˜ì´ì§€ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-blue-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ë¹„ìš© ì ˆê°</h3>
                                <p class="text-gray-700">ì™¸ë¶€ ì œì‘ ë¹„ìš© ì—†ì´ ë¬´ì œí•œìœ¼ë¡œ ëœë”©í˜ì´ì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-green-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ì „ë¬¸ì ì¸ ë””ìì¸</h3>
                                <p class="text-gray-700">AIê°€ ìµœì‹  ë””ìì¸ íŠ¸ë Œë“œë¥¼ ë°˜ì˜í•œ ì„¸ë ¨ëœ í˜ì´ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6 border border-orange-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-orange-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ì¦‰ì‹œ ê³µìœ </h3>
                                <p class="text-gray-700">ìƒì„± ì¦‰ì‹œ ì¹´ì¹´ì˜¤í†¡ì´ë‚˜ ë§í¬ë¡œ í•™ë¶€ëª¨ë‹˜ê»˜ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CTA -->
            <div class="text-center bg-gradient-to-r from-purple-600 to-purple-700 rounded-2xl p-12 text-white">
                <h2 class="text-3xl font-bold mb-4">í”Œëœì„ ì‹œì‘í•´ë³´ì„¸ìš”!</h2>
                <p class="text-xl mb-8 text-purple-100">AIê°€ ë§Œë“œëŠ” ì „ë¬¸ì ì¸ ëœë”©í˜ì´ì§€ë¥¼ ê²½í—˜í•´ë³´ì„¸ìš”</p>
                <a href="/pricing" class="inline-block px-8 py-4 bg-white text-purple-600 rounded-xl font-bold text-lg hover:bg-purple-50 transition shadow-lg">
                    ìš”ê¸ˆì œ ë³´ê¸° â†’
                </a>
            </div>
        </div>
    </body>
    </html>
  `)
})

// SMS ë¬¸ì ë°œì†¡ ì†Œê°œ
app.get('/features/sms-sender', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SMS ë¬¸ì ë°œì†¡ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
          .gradient-blue { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/dashboard" class="text-2xl font-bold text-blue-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/dashboard" class="text-gray-600 hover:text-blue-600">â† ëŒ€ì‹œë³´ë“œ</a>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-12">
            <!-- Hero Section -->
            <div class="text-center mb-16">
                <div class="inline-block px-4 py-2 bg-blue-100 rounded-full text-blue-700 text-sm font-semibold mb-4">
                    ğŸ’¬ ë¹ ë¥´ê³  íš¨ìœ¨ì ì¸ ì†Œí†µ
                </div>
                <h1 class="text-5xl font-bold text-gray-900 mb-6">SMS ë¬¸ì ë°œì†¡</h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    í•™ë¶€ëª¨ë‹˜ë“¤ê³¼ ë¹ ë¥´ê³  íš¨ê³¼ì ìœ¼ë¡œ ì†Œí†µí•˜ì„¸ìš”.<br>
                    ì¼ì • ì•ˆë‚´, ê³µì§€ì‚¬í•­, ê°œë³„ ë©”ì‹œì§€ë¥¼ ì†ì‰½ê²Œ ë°œì†¡í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <!-- ì£¼ìš” ê¸°ëŠ¥ -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì£¼ìš” ê¸°ëŠ¥</h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-users text-3xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ëŒ€ëŸ‰ ë°œì†¡</h3>
                        <p class="text-gray-600">
                            ì—¬ëŸ¬ í•™ë¶€ëª¨ë‹˜ê»˜ í•œ ë²ˆì— ë¬¸ìë¥¼ ë°œì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë£¹ë³„, í•™ë…„ë³„ ë°œì†¡ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-green-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-user-check text-3xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ê°œì¸ ë§ì¶¤ ë°œì†¡</h3>
                        <p class="text-gray-600">
                            í•™ìƒ ì´ë¦„ì´ë‚˜ ê°œë³„ ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ì¹˜í™˜í•˜ì—¬ ë§ì¶¤í˜• ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-chart-bar text-3xl text-purple-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ë°œì†¡ ë‚´ì—­ ê´€ë¦¬</h3>
                        <p class="text-gray-600">
                            ëª¨ë“  ë°œì†¡ ê¸°ë¡ì„ í™•ì¸í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°œì†¡ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ë„ ì¶”ì ë©ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš© ë°©ë²• -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì‚¬ìš© ë°©ë²•</h2>
                <div class="space-y-6">
                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-xl">1</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ë°œì‹ ë²ˆí˜¸ ë“±ë¡</h3>
                            <p class="text-gray-600">ë¨¼ì € ë°œì‹ ë²ˆí˜¸ë¥¼ ë“±ë¡í•˜ê³  ì¸ì¦ì„ ì™„ë£Œí•©ë‹ˆë‹¤. (ìµœì´ˆ 1íšŒ)</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-xl">2</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ìˆ˜ì‹ ì ì„ íƒ</h3>
                            <p class="text-gray-600">í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œì—ì„œ ìˆ˜ì‹ ìë¥¼ ì„ íƒí•˜ê±°ë‚˜, ì§ì ‘ ë²ˆí˜¸ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-xl">3</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ë©”ì‹œì§€ ì‘ì„±</h3>
                            <p class="text-gray-600">ë³´ë‚¼ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. í…œí”Œë¦¿ì„ ì‚¬ìš©í•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center font-bold text-xl">4</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ë°œì†¡ ë° í™•ì¸</h3>
                            <p class="text-gray-600">ë°œì†¡ ë²„íŠ¼ì„ í´ë¦­í•˜ê³ , ë°œì†¡ ë‚´ì—­ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¥ì  -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì™œ SMS ë¬¸ì ë°œì†¡ì„ ì‚¬ìš©í•´ì•¼ í• ê¹Œìš”?</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-blue-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ë†’ì€ ë„ë‹¬ë¥ </h3>
                                <p class="text-gray-700">SMSëŠ” 98% ì´ìƒì˜ ë„ë‹¬ë¥ ê³¼ 90% ì´ìƒì˜ ì½ê¸°ìœ¨ì„ ìë‘í•©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-green-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ì¦‰ê°ì ì¸ ì†Œí†µ</h3>
                                <p class="text-gray-700">ê¸´ê¸‰ ê³µì§€ë‚˜ ì¼ì • ë³€ê²½ ì‚¬í•­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-purple-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">íš¨ìœ¨ì ì¸ ê´€ë¦¬</h3>
                                <p class="text-gray-700">ëª¨ë“  ë°œì†¡ ë‚´ì—­ì„ í•œ ê³³ì—ì„œ ê´€ë¦¬í•˜ê³  ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6 border border-orange-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-orange-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ë¹„ìš© íš¨ìœ¨ì </h3>
                                <p class="text-gray-700">ê±´ë‹¹ ì €ë ´í•œ ë¹„ìš©ìœ¼ë¡œ íš¨ê³¼ì ì¸ ì†Œí†µì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CTA -->
            <div class="text-center bg-gradient-to-r from-blue-600 to-blue-700 rounded-2xl p-12 text-white">
                <h2 class="text-3xl font-bold mb-4">í”Œëœì„ ì‹œì‘í•´ë³´ì„¸ìš”!</h2>
                <p class="text-xl mb-8 text-blue-100">í•™ë¶€ëª¨ë‹˜ë“¤ê³¼ ë” íš¨ê³¼ì ìœ¼ë¡œ ì†Œí†µí•˜ì„¸ìš”</p>
                <a href="/pricing" class="inline-block px-8 py-4 bg-white text-blue-600 rounded-xl font-bold text-lg hover:bg-blue-50 transition shadow-lg">
                    ìš”ê¸ˆì œ ë³´ê¸° â†’
                </a>
            </div>
        </div>
    </body>
    </html>
  `)
})

// í•™ìƒ ê´€ë¦¬ ì†Œê°œ
app.get('/features/student-management', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í•™ìƒ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
          .gradient-green { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/dashboard" class="text-2xl font-bold text-green-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/dashboard" class="text-gray-600 hover:text-green-600">â† ëŒ€ì‹œë³´ë“œ</a>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-12">
            <!-- Hero Section -->
            <div class="text-center mb-16">
                <div class="inline-block px-4 py-2 bg-green-100 rounded-full text-green-700 text-sm font-semibold mb-4">
                    ğŸ‘¨â€ğŸ“ ì²´ê³„ì ì¸ í•™ìƒ ê´€ë¦¬
                </div>
                <h1 class="text-5xl font-bold text-gray-900 mb-6">í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    í•™ìƒ ì •ë³´ë¥¼ í•œëˆˆì— íŒŒì•…í•˜ê³  ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”.<br>
                    ì¶œê²° ê´€ë¦¬, ì„±ì  ì¶”ì , í•™ë¶€ëª¨ ì—°ë½ì²˜ê¹Œì§€ ëª¨ë“  ì •ë³´ë¥¼ í†µí•© ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <!-- ì£¼ìš” ê¸°ëŠ¥ -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì£¼ìš” ê¸°ëŠ¥</h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-green-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-user-graduate text-3xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">í•™ìƒ ì •ë³´ ê´€ë¦¬</h3>
                        <p class="text-gray-600">
                            í•™ìƒì˜ ì´ë¦„, í•™ë…„, ì—°ë½ì²˜, í•™ë¶€ëª¨ ì •ë³´ ë“±ì„ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-calendar-check text-3xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ì¶œê²° ê´€ë¦¬</h3>
                        <p class="text-gray-600">
                            ì¶œì„, ì§€ê°, ê²°ì„ì„ ê¸°ë¡í•˜ê³  ì¶œê²° í˜„í™©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-chart-line text-3xl text-purple-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ì„±ì  ì¶”ì </h3>
                        <p class="text-gray-600">
                            ì‹œí—˜ ì„±ì , ê³¼ì œ ì ìˆ˜ ë“±ì„ ê¸°ë¡í•˜ê³  í•™ìƒë³„ ì„±ì  ë³€í™”ë¥¼ ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš© ë°©ë²• -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì‚¬ìš© ë°©ë²•</h2>
                <div class="space-y-6">
                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-xl">1</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">í•™ìƒ ë“±ë¡</h3>
                            <p class="text-gray-600">ìƒˆë¡œìš´ í•™ìƒ ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ ë“±ë¡í•©ë‹ˆë‹¤. ì´ë¦„, í•™ë…„, ì—°ë½ì²˜ ë“± ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-xl">2</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ì •ë³´ ê´€ë¦¬</h3>
                            <p class="text-gray-600">í•™ìƒ ëª©ë¡ì—ì„œ ì›í•˜ëŠ” í•™ìƒì„ ì„ íƒí•˜ì—¬ ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒí•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-xl">3</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ì¶œê²° ë° ì„±ì  ê¸°ë¡</h3>
                            <p class="text-gray-600">ì¼ì¼ ì¶œê²°ì„ ì²´í¬í•˜ê³ , ì‹œí—˜ì´ë‚˜ ê³¼ì œ ì„±ì ì„ ì…ë ¥í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-xl">4</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ë¦¬í¬íŠ¸ ìƒì„±</h3>
                            <p class="text-gray-600">í•™ìƒë³„ ì¶œê²° í˜„í™©, ì„±ì  ì¶”ì´ ë“±ì˜ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ì—¬ í•™ë¶€ëª¨ë‹˜ê»˜ ì „ë‹¬í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¥ì  -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì™œ í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•´ì•¼ í• ê¹Œìš”?</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-green-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">í†µí•© ê´€ë¦¬</h3>
                                <p class="text-gray-700">ëª¨ë“  í•™ìƒ ì •ë³´ë¥¼ í•œ ê³³ì—ì„œ í†µí•© ê´€ë¦¬í•˜ì—¬ ì—…ë¬´ íš¨ìœ¨ì´ í–¥ìƒë©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-blue-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ì‹¤ì‹œê°„ í˜„í™© íŒŒì•…</h3>
                                <p class="text-gray-700">í•™ìƒë³„ ì¶œê²°, ì„±ì , ìƒë‹´ ë‚´ì—­ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-purple-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ë°ì´í„° ê¸°ë°˜ ì§€ë„</h3>
                                <p class="text-gray-700">ì¶•ì ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìƒë³„ ë§ì¶¤ ì§€ë„ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-6 border border-orange-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-orange-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">í•™ë¶€ëª¨ ì†Œí†µ ê°•í™”</h3>
                                <p class="text-gray-700">ì •í™•í•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ë¶€ëª¨ë‹˜ê³¼ ë” íš¨ê³¼ì ìœ¼ë¡œ ì†Œí†µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CTA -->
            <div class="text-center bg-gradient-to-r from-green-600 to-green-700 rounded-2xl p-12 text-white">
                <h2 class="text-3xl font-bold mb-4">í”Œëœì„ ì‹œì‘í•´ë³´ì„¸ìš”!</h2>
                <p class="text-xl mb-8 text-green-100">ì²´ê³„ì ì¸ í•™ìƒ ê´€ë¦¬ë¡œ í•™ì› ìš´ì˜ì„ íš¨ìœ¨í™”í•˜ì„¸ìš”</p>
                <a href="/pricing" class="inline-block px-8 py-4 bg-white text-green-600 rounded-xl font-bold text-lg hover:bg-green-50 transition shadow-lg">
                    ìš”ê¸ˆì œ ë³´ê¸° â†’
                </a>
            </div>
        </div>
    </body>
    </html>
  `)
})

// AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ ì†Œê°œ
app.get('/features/ai-learning-report', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, sans-serif; }
          .gradient-indigo { background: linear-gradient(135deg, #6366f1 0%, #818cf8 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <a href="/dashboard" class="text-2xl font-bold text-indigo-600">ìŠˆí¼í”Œë ˆì´ìŠ¤</a>
                    <a href="/dashboard" class="text-gray-600 hover:text-indigo-600">â† ëŒ€ì‹œë³´ë“œ</a>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-12">
            <!-- Hero Section -->
            <div class="text-center mb-16">
                <div class="inline-block px-4 py-2 bg-indigo-100 rounded-full text-indigo-700 text-sm font-semibold mb-4">
                    ğŸ¤– AI ê¸°ë°˜ í•™ìŠµ ë¶„ì„
                </div>
                <h1 class="text-5xl font-bold text-gray-900 mb-6">AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
                <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                    AIê°€ í•™ìƒì˜ í•™ìŠµ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì—¬ ë§ì¶¤í˜• ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.<br>
                    ê°•ì ê³¼ ì•½ì ì„ íŒŒì•…í•˜ê³ , ê°œì„  ë°©í–¥ì„ ì œì‹œí•˜ì—¬ íš¨ê³¼ì ì¸ í•™ìŠµì„ ì§€ì›í•©ë‹ˆë‹¤.
                </p>
            </div>

            <!-- ì£¼ìš” ê¸°ëŠ¥ -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì£¼ìš” ê¸°ëŠ¥</h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-indigo-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-brain text-3xl text-indigo-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">AI ìë™ ë¶„ì„</h3>
                        <p class="text-gray-600">
                            í•™ìƒì˜ ì„±ì , ì¶œê²°, ê³¼ì œ ë°ì´í„°ë¥¼ AIê°€ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-purple-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-chart-pie text-3xl text-purple-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ì‹œê°í™” ë¦¬í¬íŠ¸</h3>
                        <p class="text-gray-600">
                            ì°¨íŠ¸ì™€ ê·¸ë˜í”„ë¡œ í•™ìŠµ í˜„í™©ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆëŠ” ë³´ê¸° ì‰¬ìš´ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                        <div class="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center mb-4">
                            <i class="fas fa-bullseye text-3xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">ë§ì¶¤í˜• ì œì•ˆ</h3>
                        <p class="text-gray-600">
                            í•™ìƒë³„ ê°•ì ê³¼ ì•½ì ì„ ë¶„ì„í•˜ì—¬ êµ¬ì²´ì ì¸ í•™ìŠµ ê°œì„  ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>

            <!-- ì‚¬ìš© ë°©ë²• -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì‚¬ìš© ë°©ë²•</h2>
                <div class="space-y-6">
                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl">1</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">í•™ìƒ ì„ íƒ</h3>
                            <p class="text-gray-600">ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•  í•™ìƒì„ ì„ íƒí•©ë‹ˆë‹¤. ê°œë³„ í•™ìƒ ë˜ëŠ” ê·¸ë£¹ë³„ ì„ íƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl">2</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ë¶„ì„ ê¸°ê°„ ì„¤ì •</h3>
                            <p class="text-gray-600">ë¶„ì„í•  ê¸°ê°„ì„ ì„ íƒí•©ë‹ˆë‹¤. ìµœê·¼ 1ê°œì›”, 3ê°œì›”, 6ê°œì›” ë“± ì›í•˜ëŠ” ê¸°ê°„ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl">3</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">AI ë¶„ì„ ì‹¤í–‰</h3>
                            <p class="text-gray-600">AIê°€ ìë™ìœ¼ë¡œ í•™ìŠµ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ìˆ˜ ì´ˆ ë‚´ì— ì™„ë£Œë©ë‹ˆë‹¤.</p>
                        </div>
                    </div>

                    <div class="flex gap-6 items-start">
                        <div class="flex-shrink-0 w-12 h-12 bg-indigo-600 text-white rounded-full flex items-center justify-center font-bold text-xl">4</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">ë¦¬í¬íŠ¸ í™•ì¸ ë° ê³µìœ </h3>
                            <p class="text-gray-600">ìƒì„±ëœ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ê³ , í•™ë¶€ëª¨ë‹˜ê»˜ ê³µìœ í•˜ê±°ë‚˜ ìƒë‹´ ìë£Œë¡œ í™œìš©í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¥ì  -->
            <div class="mb-16">
                <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">ì™œ AI í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ì‚¬ìš©í•´ì•¼ í• ê¹Œìš”?</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-xl p-6 border border-indigo-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-indigo-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ê°ê´€ì ì¸ ë¶„ì„</h3>
                                <p class="text-gray-700">AIê°€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê°ê´€ì ì´ê³  ì •í™•í•œ ë¶„ì„ ê²°ê³¼ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-purple-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ì‹œê°„ ì ˆì•½</h3>
                                <p class="text-gray-700">ìˆ˜ì‘ì—…ìœ¼ë¡œ ë¶„ì„í•˜ë˜ ì‹œê°„ì„ ëŒ€í­ ì ˆì•½í•˜ê³  í•™ìƒ ì§€ë„ì— ì§‘ì¤‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-blue-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">ë§ì¶¤í˜• ì§€ë„</h3>
                                <p class="text-gray-700">í•™ìƒë³„ ê°•ì•½ì ì„ íŒŒì•…í•˜ì—¬ ê°œì¸ ë§ì¶¤í˜• í•™ìŠµ ì§€ë„ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-check-circle text-2xl text-green-600 mt-1"></i>
                            <div>
                                <h3 class="font-bold text-lg mb-2">í•™ë¶€ëª¨ ë§Œì¡±ë„ í–¥ìƒ</h3>
                                <p class="text-gray-700">ì „ë¬¸ì ì¸ ë¦¬í¬íŠ¸ë¡œ í•™ë¶€ëª¨ë‹˜ê»˜ ì‹ ë¢°ë¥¼ ì–»ê³  ë§Œì¡±ë„ë¥¼ ë†’ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CTA -->
            <div class="text-center bg-gradient-to-r from-indigo-600 to-indigo-700 rounded-2xl p-12 text-white">
                <h2 class="text-3xl font-bold mb-4">í”Œëœì„ ì‹œì‘í•´ë³´ì„¸ìš”!</h2>
                <p class="text-xl mb-8 text-indigo-100">AIê°€ ë§Œë“œëŠ” ì „ë¬¸ì ì¸ í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ê²½í—˜í•´ë³´ì„¸ìš”</p>
                <a href="/pricing" class="inline-block px-8 py-4 bg-white text-indigo-600 rounded-xl font-bold text-lg hover:bg-indigo-50 transition shadow-lg">
                    ìš”ê¸ˆì œ ë³´ê¸° â†’
                </a>
            </div>
        </div>
    </body>
    </html>
  `)
})

app.get('/admin/dashboard', async (c) => {
  const {env}=c
  if(!env?.DB)return c.html('<h1>DB Error</h1><a href="/admin/users">Users</a>')
  let u=0,co=0,pc=0,pd=0,ps=0,pbt=0,pfp=0
  try{u=(await env.DB.prepare('SELECT COUNT(*)c FROM users').first())?.c||0}catch(e){}
  try{co=(await env.DB.prepare('SELECT COUNT(*)c FROM contacts').first())?.c||0}catch(e){}
  try{pc=(await env.DB.prepare('SELECT COUNT(*)c FROM contacts WHERE status=?').bind('pending').first())?.c||0}catch(e){}
  try{pd=(await env.DB.prepare('SELECT COUNT(*)c FROM deposit_requests WHERE status=?').bind('pending').first())?.c||0}catch(e){}
  try{ps=(await env.DB.prepare('SELECT COUNT(*)c FROM sender_verification_requests WHERE status=?').bind('pending').first())?.c||0}catch(e){}
  try{pbt=(await env.DB.prepare('SELECT COUNT(*)c FROM bank_transfer_requests WHERE status=?').bind('pending').first())?.c||0}catch(e){}
  try{pfp=(await env.DB.prepare('SELECT COUNT(*)c FROM free_plan_requests WHERE status=?').bind('pending').first())?.c||0}catch(e){}
  let pcp=0
  try{pcp=(await env.DB.prepare('SELECT COUNT(*)c FROM card_payment_requests WHERE status=?').bind('pending').first())?.c||0}catch(e){}
  const h=`<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet"></head><body class="bg-gray-50">`
  const n=`<nav class="bg-white border-b"><div class="max-w-7xl mx-auto px-6 py-4"><div class="flex justify-between items-center"><div class="flex items-center gap-8"><a href="/" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a><div class="flex gap-4"><a href="/admin/dashboard" class="text-purple-600 font-semibold">ëŒ€ì‹œë³´ë“œ</a><a href="/admin/users" class="text-gray-600 hover:text-purple-600">ì‚¬ìš©ì</a><a href="/admin/contacts" class="text-gray-600 hover:text-purple-600">ë¬¸ì˜</a><a href="/admin/active-sessions" class="text-gray-600 hover:text-purple-600">ì‹¤ì‹œê°„ ì ‘ì†ì</a><a href="/admin/bank-transfers" class="text-gray-600 hover:text-purple-600">ê³„ì¢Œì´ì²´</a><a href="/admin/sms" class="text-gray-600 hover:text-purple-600">ë¬¸ì</a><a href="/admin/sender/verification" class="text-gray-600 hover:text-purple-600">ë°œì‹ ë²ˆí˜¸</a><a href="/admin/free-plan-requests" class="text-gray-600 hover:text-purple-600">ë¬´ë£Œ í”Œëœ</a></div></div><button onclick="localStorage.removeItem('user');
                localStorage.removeItem('loginTime');location.href='/'" class="text-gray-600 hover:text-red-600"><i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ</button></div></div></nav>`
  const b=`<div class="max-w-7xl mx-auto px-6 py-8"><h1 class="text-3xl font-bold mb-8">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1><div class="grid md:grid-cols-4 gap-6 mb-8"><div class="bg-white rounded-xl shadow p-6 border"><div class="flex items-center justify-between mb-2"><span class="text-gray-600">ì „ì²´ ì‚¬ìš©ì</span><i class="fas fa-users text-blue-600 text-2xl"></i></div><p class="text-3xl font-bold">${u}</p></div><div class="bg-white rounded-xl shadow p-6 border"><div class="flex items-center justify-between mb-2"><span class="text-gray-600">ì „ì²´ ë¬¸ì˜</span><i class="fas fa-envelope text-green-600 text-2xl"></i></div><p class="text-3xl font-bold">${co}</p></div><div class="bg-white rounded-xl shadow p-6 border"><div class="flex items-center justify-between mb-2"><span class="text-gray-600">ëŒ€ê¸°ì¤‘ ë¬¸ì˜</span><i class="fas fa-clock text-orange-600 text-2xl"></i></div><p class="text-3xl font-bold">${pc}</p></div><a href="/admin/active-sessions" class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white hover:shadow-xl transition border-0"><div class="flex items-center justify-between mb-2"><span class="font-semibold">ì‹¤ì‹œê°„ ì ‘ì†ì</span><i class="fas fa-signal text-2xl"></i></div><p class="text-3xl font-bold" id="totalActive">-</p><p class="text-sm opacity-90 mt-2"><i class="fas fa-arrow-right mr-1"></i>ìì„¸íˆ ë³´ê¸°</p></a></div><script>
async function loadActiveSessionCount(){try{const user=JSON.parse(localStorage.getItem('user')||'null');if(!user||!user.is_admin){return;}const base64=(str)=>btoa(unescape(encodeURIComponent(str)));const r=await fetch('/api/admin/active-sessions',{headers:{'X-User-Data-Base64':base64(JSON.stringify(user))}});const d=await r.json();if(d.success&&d.activeSessions){document.getElementById('totalActive').textContent=d.activeSessions.total||0;}}catch(e){console.error('Failed to load active session count:',e);}}
loadActiveSessionCount();
setInterval(loadActiveSessionCount,30000);
</script>`
  const s=`<div class="mb-8"><h2 class="text-xl font-bold mb-4">ì‹ ì²­ ëŒ€ê¸°</h2><div class="grid md:grid-cols-5 gap-6"><div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow p-6 text-white"><div class="flex items-center justify-between mb-2"><span>ì…ê¸ˆ ëŒ€ê¸°</span><i class="fas fa-money-bill-wave text-2xl"></i></div><p class="text-3xl font-bold">${pd}</p></div><div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow p-6 text-white"><div class="flex items-center justify-between mb-2"><span>ë°œì‹ ë²ˆí˜¸ ëŒ€ê¸°</span><i class="fas fa-phone text-2xl"></i></div><p class="text-3xl font-bold">${ps}</p></div><a href="/admin/bank-transfers" class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow p-6 text-white hover:shadow-lg transition"><div class="flex items-center justify-between mb-2"><span>ê³„ì¢Œì´ì²´ ëŒ€ê¸°</span><i class="fas fa-university text-2xl"></i></div><p class="text-3xl font-bold">${pbt}</p><p class="text-sm text-blue-100 mt-2">í´ë¦­í•˜ì—¬ ê´€ë¦¬</p></a><a href="/admin/free-plan-requests" class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl shadow p-6 text-white hover:shadow-lg transition"><div class="flex items-center justify-between mb-2"><span>ë¬´ë£Œ í”Œëœ ëŒ€ê¸°</span><i class="fas fa-gift text-2xl"></i></div><p class="text-3xl font-bold">${pfp}</p><p class="text-sm text-emerald-100 mt-2">í´ë¦­í•˜ì—¬ ê´€ë¦¬</p></a><a href="/admin/card-payments" class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl shadow p-6 text-white hover:shadow-lg transition"><div class="flex items-center justify-between mb-2"><span>ì¹´ë“œê²°ì œ ì‹ ì²­</span><i class="fas fa-credit-card text-2xl"></i></div><p class="text-3xl font-bold">${pcp}</p><p class="text-sm text-pink-100 mt-2">í´ë¦­í•˜ì—¬ ê´€ë¦¬</p></a></div></div>`
  const l=`<div class="grid md:grid-cols-3 gap-6"><a href="/admin/users" class="bg-white rounded-xl shadow p-6 hover:shadow-md transition border"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"><i class="fas fa-user-cog text-blue-600 text-xl"></i></div><div><h3 class="text-lg font-bold">ì‚¬ìš©ì ê´€ë¦¬</h3><p class="text-gray-600 text-sm">ê¶Œí•œ ê´€ë¦¬</p></div></div></a><a href="/admin/contacts" class="bg-white rounded-xl shadow p-6 hover:shadow-md transition border"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"><i class="fas fa-comments text-green-600 text-xl"></i></div><div><h3 class="text-lg font-bold">ë¬¸ì˜ ê´€ë¦¬</h3><p class="text-gray-600 text-sm">ë¬¸ì˜ ì²˜ë¦¬</p></div></div></a><a href="/admin/revenue" class="bg-white rounded-xl shadow p-6 hover:shadow-md transition border"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center"><i class="fas fa-chart-line text-yellow-600 text-xl"></i></div><div><h3 class="text-lg font-bold">ë§¤ì¶œ ê´€ë¦¬</h3><p class="text-gray-600 text-sm">ë§¤ì¶œ í†µê³„</p></div></div></a><a href="/admin/sms" class="bg-white rounded-xl shadow p-6 hover:shadow-md transition border"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"><i class="fas fa-sms text-blue-600 text-xl"></i></div><div><h3 class="text-lg font-bold">ë¬¸ì ê´€ë¦¬</h3><p class="text-gray-600 text-sm">SMS ë°œì†¡</p></div></div></a><a href="/admin/sender/verification" class="bg-white rounded-xl shadow p-6 hover:shadow-md transition border"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center"><i class="fas fa-phone text-purple-600 text-xl"></i></div><div><h3 class="text-lg font-bold">ë°œì‹ ë²ˆí˜¸</h3><p class="text-gray-600 text-sm">ì¸ì¦ ìŠ¹ì¸</p></div></div></a><a href="/admin/deposits" class="bg-white rounded-xl shadow p-6 hover:shadow-md transition border"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center"><i class="fas fa-money-bill-wave text-green-600 text-xl"></i></div><div><h3 class="text-lg font-bold">ì…ê¸ˆ ê´€ë¦¬</h3><p class="text-gray-600 text-sm">í¬ì¸íŠ¸ ìŠ¹ì¸</p></div></div></a><a href="/admin/bank-transfers" class="bg-white rounded-xl shadow p-6 hover:shadow-md transition border"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center"><i class="fas fa-university text-blue-600 text-xl"></i></div><div><h3 class="text-lg font-bold">ê³„ì¢Œì´ì²´</h3><p class="text-gray-600 text-sm">ìŠ¹ì¸ ê´€ë¦¬</p></div></div></a><a href="/admin/programs" class="bg-white rounded-xl shadow p-6 hover:shadow-md transition border"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center"><i class="fas fa-graduation-cap text-purple-600 text-xl"></i></div><div><h3 class="text-lg font-bold">í”„ë¡œê·¸ë¨</h3><p class="text-gray-600 text-sm">êµìœ¡ ê´€ë¦¬</p></div></div></a><a href="/admin/card-payments" class="bg-white rounded-xl shadow p-6 hover:shadow-md transition border"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-pink-100 rounded-lg flex items-center justify-center"><i class="fas fa-credit-card text-pink-600 text-xl"></i></div><div><h3 class="text-lg font-bold">ì¹´ë“œê²°ì œ ì‹ ì²­</h3><p class="text-gray-600 text-sm">ê²°ì œ ìŠ¹ì¸ ê´€ë¦¬</p></div></div></a></div></div><script>(function(){try{let sessionId=localStorage.getItem('sessionId');if(!sessionId){sessionId='session_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);localStorage.setItem('sessionId',sessionId);}const user=JSON.parse(localStorage.getItem('user')||'null');fetch('/api/session/track',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:sessionId,userId:user?.id||null})}).catch(err=>console.log('Session track error:',err));setInterval(()=>{fetch('/api/session/track',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sessionId:sessionId,userId:user?.id||null})}).catch(err=>console.log('Session track error:',err));},5*60*1000);}catch(e){console.log('Session tracking init error:',e);}})();</script></body></html>`
  return c.html(h+n+b+s+l)
})

// ê´€ë¦¬ì: ì‚¬ìš©ëŸ‰ ë™ê¸°í™” í˜ì´ì§€
app.get('/admin/sync-usage', (c) => {
  return c.html(`<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ìš©ëŸ‰ ë™ê¸°í™” - ê´€ë¦¬ì</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <a href="/admin/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a>
                <div class="flex gap-4">
                    <a href="/admin/dashboard" class="text-gray-700 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                    <a href="/admin/sync-usage" class="text-purple-600 font-semibold">ì‚¬ìš©ëŸ‰ ë™ê¸°í™”</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ”„ ì‚¬ìš©ëŸ‰ ë™ê¸°í™”</h1>
        <p class="text-gray-600 mb-8">ëœë”©í˜ì´ì§€ ì‚¬ìš©ëŸ‰ì„ ì‹¤ì œ ë°ì´í„°ì™€ ë™ê¸°í™”í•©ë‹ˆë‹¤.</p>

        <div class="bg-white rounded-xl shadow p-8 mb-6">
            <h2 class="text-xl font-bold mb-4">ëœë”©í˜ì´ì§€ ì‚¬ìš©ëŸ‰ ë™ê¸°í™”</h2>
            <p class="text-gray-600 mb-6">
                ì´ ê¸°ëŠ¥ì€ ëª¨ë“  í™œì„± êµ¬ë…ì— ëŒ€í•´ <code class="bg-gray-100 px-2 py-1 rounded">landing_pages</code> í…Œì´ë¸”ì˜ ì‹¤ì œ ë°ì´í„°ë¥¼ ì„¸ì–´
                <code class="bg-gray-100 px-2 py-1 rounded">usage_tracking</code> í…Œì´ë¸”ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            </p>
            
            <button onclick="syncLandingPages()" id="syncBtn" class="w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-bold text-lg hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg hover:shadow-xl">
                <i class="fas fa-sync-alt mr-2"></i>ëœë”©í˜ì´ì§€ ì‚¬ìš©ëŸ‰ ë™ê¸°í™”
            </button>
            
            <div id="syncResult" class="mt-6 hidden"></div>
        </div>

        <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
            <h3 class="font-bold text-blue-900 mb-2">ğŸ’¡ ì–¸ì œ ì‚¬ìš©í•˜ë‚˜ìš”?</h3>
            <ul class="text-blue-800 text-sm space-y-2">
                <li>â€¢ ëŒ€ì‹œë³´ë“œì— ëœë”©í˜ì´ì§€ ì‚¬ìš©ëŸ‰ì´ í‘œì‹œë˜ì§€ ì•Šì„ ë•Œ</li>
                <li>â€¢ ëœë”©í˜ì´ì§€ë¥¼ ìƒì„±í–ˆëŠ”ë° ì¹´ìš´íŠ¸ê°€ ì¦ê°€í•˜ì§€ ì•Šì„ ë•Œ</li>
                <li>â€¢ <code class="bg-blue-100 px-2 py-1 rounded">usage_tracking</code> í…Œì´ë¸”ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ì„ ë•Œ</li>
                <li>â€¢ ë°ì´í„° ë¬´ê²°ì„±ì„ í™•ì¸í•˜ê³  ì‹¶ì„ ë•Œ</li>
            </ul>
        </div>
    </div>

    <script>
        async function syncLandingPages() {
            const btn = document.getElementById('syncBtn');
            const resultDiv = document.getElementById('syncResult');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ë™ê¸°í™” ì¤‘...';
            resultDiv.classList.add('hidden');
            
            try {
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                if (!user || user.role !== 'admin') {
                    alert('ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }
                
                const userDataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(user))));
                
                const response = await fetch('/api/admin/sync-landing-pages-usage', {
                    method: 'POST',
                    headers: {
                        'X-User-Data-Base64': userDataBase64
                    }
                });
                
                const data = await response.json();
                
                resultDiv.classList.remove('hidden');
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border-2 border-green-200 rounded-xl p-6">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-check-circle text-green-600 text-2xl mt-1"></i>
                                <div class="flex-1">
                                    <h3 class="font-bold text-green-900 text-lg mb-2">âœ… ë™ê¸°í™” ì„±ê³µ!</h3>
                                    <p class="text-green-800 mb-4">${data.message}</p>
                                    <div class="bg-white rounded-lg p-4 mb-3">
                                        <div class="text-sm text-gray-600 mb-2">ì„¸ë¶€ ê²°ê³¼:</div>
                                        <div class="space-y-1 text-sm">
                                            ${data.results.map(r => `<div class="text-gray-700">${r}</div>`).join('')}
                                        </div>
                                    </div>
                                    <p class="text-sm text-green-700">
                                        <strong>ì—…ë°ì´íŠ¸ë¨:</strong> ${data.synced}ê°œ / ì „ì²´: ${data.total}ê°œ
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-times-circle text-red-600 text-2xl mt-1"></i>
                                <div>
                                    <h3 class="font-bold text-red-900 text-lg mb-2">âŒ ë™ê¸°í™” ì‹¤íŒ¨</h3>
                                    <p class="text-red-800">${data.error}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ë™ê¸°í™” ì˜¤ë¥˜:', error);
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-exclamation-triangle text-red-600 text-2xl mt-1"></i>
                            <div>
                                <h3 class="font-bold text-red-900 text-lg mb-2">âš ï¸ ì˜¤ë¥˜ ë°œìƒ</h3>
                                <p class="text-red-800">${error.message}</p>
                            </div>
                        </div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>ëœë”©í˜ì´ì§€ ì‚¬ìš©ëŸ‰ ë™ê¸°í™”';
            }
        }
    </script>
</body>
</html>`)
})

// ê´€ë¦¬ì: ì‹¤ì‹œê°„ ëŒ€ê¸° ê±´ìˆ˜ ì¡°íšŒ API
app.get('/api/admin/pending-counts', async (c) => {
  const {env} = c
  if (!env?.DB) return c.json({ success: false, error: 'DB Error' }, 500)
  
  let pd = 0, ps = 0, pbt = 0
  try {
    pd = (await env.DB.prepare('SELECT COUNT(*) c FROM deposit_requests WHERE status=?').bind('pending').first())?.c || 0
  } catch (e) {}
  try {
    ps = (await env.DB.prepare('SELECT COUNT(*) c FROM sender_verification_requests WHERE status=?').bind('pending').first())?.c || 0
  } catch (e) {}
  try {
    pbt = (await env.DB.prepare('SELECT COUNT(*) c FROM bank_transfer_requests WHERE status=?').bind('pending').first())?.c || 0
  } catch (e) {}
  
  return c.json({
    success: true,
    deposits: pd,
    senders: ps,
    bankTransfers: pbt
  })
})

// ê´€ë¦¬ì: ì‹¤ì‹œê°„ ì ‘ì†ì í˜ì´ì§€
app.get('/admin/active-sessions', async (c) => {
  return c.html(`<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì ‘ì†ì - ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/admin/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a>
                </div>
                <div class="flex items-center gap-6">
                    <a href="/admin/dashboard" class="text-gray-700 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                    <a href="/admin/users" class="text-gray-700 hover:text-purple-600">ì‚¬ìš©ì</a>
                    <a href="/admin/contacts" class="text-gray-700 hover:text-purple-600">ë¬¸ì˜</a>
                    <a href="/admin/active-sessions" class="text-purple-600 font-semibold">ì‹¤ì‹œê°„ ì ‘ì†ì</a>
                    <a href="/admin/bank-transfers" class="text-gray-700 hover:text-purple-600">ê³„ì¢Œì´ì²´</a>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header with Tabs -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">
                <i class="fas fa-users text-purple-600 mr-3"></i>ì ‘ì†ì ê´€ë¦¬
            </h1>
            
            <!-- Tabs -->
            <div class="flex gap-2 mb-6 border-b border-gray-200">
                <button onclick="switchTab('realtime')" id="tabRealtime" class="px-6 py-3 font-semibold text-purple-600 border-b-2 border-purple-600">
                    <i class="fas fa-signal mr-2"></i>ì‹¤ì‹œê°„ ì ‘ì†ì
                </button>
                <button onclick="switchTab('history')" id="tabHistory" class="px-6 py-3 font-semibold text-gray-500 hover:text-purple-600">
                    <i class="fas fa-chart-bar mr-2"></i>ì ‘ì†ì í†µê³„
                </button>
            </div>
            
            <!-- Realtime Tab Content -->
            <div id="contentRealtime">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-medium opacity-90">í˜„ì¬ ì ‘ì†ì</div>
                        <i class="fas fa-signal text-2xl opacity-80"></i>
                    </div>
                    <div class="text-4xl font-bold" id="totalActive">0</div>
                    <div class="text-xs opacity-80 mt-2">10ë¶„ ì´ë‚´ í™œë™</div>
                </div>
                
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-medium opacity-90">ë¡œê·¸ì¸ ì‚¬ìš©ì</div>
                        <i class="fas fa-user-check text-2xl opacity-80"></i>
                    </div>
                    <div class="text-4xl font-bold" id="loggedInCount">0</div>
                    <div class="text-xs opacity-80 mt-2">íšŒì› ì ‘ì† ì¤‘</div>
                </div>
                
                <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-medium opacity-90">ë¹„íšŒì› ë°©ë¬¸ì</div>
                        <i class="fas fa-user text-2xl opacity-80"></i>
                    </div>
                    <div class="text-4xl font-bold" id="guestsCount">0</div>
                    <div class="text-xs opacity-80 mt-2">ê²ŒìŠ¤íŠ¸ ì ‘ì† ì¤‘</div>
                </div>
                
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-medium opacity-90">ì´ ì„¸ì…˜</div>
                        <i class="fas fa-chart-line text-2xl opacity-80"></i>
                    </div>
                    <div class="text-4xl font-bold" id="totalSessions">0</div>
                    <div class="text-xs opacity-80 mt-2">ì „ì²´ ê¸°ë¡</div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="loadActiveSessions()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                    <i class="fas fa-sync-alt"></i>
                    ìƒˆë¡œê³ ì¹¨
                </button>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-clock mr-2"></i>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="lastUpdate">-</span>
                </div>
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" id="autoRefresh" class="w-4 h-4">
                    <span class="text-gray-700">ìë™ ìƒˆë¡œê³ ì¹¨ (10ì´ˆ)</span>
                </label>
            </div>
        </div>

        <!-- Logged In Users -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-user-check text-green-600 mr-2"></i>
                    ë¡œê·¸ì¸ ì‚¬ìš©ì (<span id="loggedInCountTitle">0</span>ëª…)
                </h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ì‚¬ìš©ì</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">í•™ì›ëª…</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ë¡œê·¸ì¸ ì‹œê°„</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ë¡œê·¸ì•„ì›ƒ ì‹œê°„</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ë§ˆì§€ë§‰ í™œë™</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">IP ì£¼ì†Œ</th>
                        </tr>
                    </thead>
                    <tbody id="loggedInUsersTable" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div id="emptyLoggedIn" class="hidden px-6 py-12 text-center text-gray-500">
                <i class="fas fa-user-slash text-4xl mb-3"></i>
                <p>í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
        </div>

        <!-- Guests -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">
                    <i class="fas fa-user text-orange-600 mr-2"></i>
                    ë¹„íšŒì› ë°©ë¬¸ì (<span id="guestsCountTitle">0</span>ëª…)
                </h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ì„¸ì…˜ ID</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ì ‘ì† ì‹œê°„</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ë§ˆì§€ë§‰ í™œë™</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">IP ì£¼ì†Œ</th>
                        </tr>
                    </thead>
                    <tbody id="guestsTable" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div id="emptyGuests" class="hidden px-6 py-12 text-center text-gray-500">
                <i class="fas fa-users-slash text-4xl mb-3"></i>
                <p>í˜„ì¬ ë¹„íšŒì› ë°©ë¬¸ìê°€ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
        </div>
        </div>
        <!-- End Realtime Tab -->
        
        <!-- History Tab Content -->
        <div id="contentHistory" class="hidden">
            <!-- Filters -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-filter text-purple-600 mr-2"></i>í•„í„°
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ì‹œì‘ ë‚ ì§œ</label>
                        <input type="date" id="startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ì¢…ë£Œ ë‚ ì§œ</label>
                        <input type="date" id="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">ê²€ìƒ‰ (ì´ë¦„, ì´ë©”ì¼, IP)</label>
                        <input type="text" id="searchKeyword" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </div>
                <div class="mt-4 flex gap-3">
                    <button onclick="loadSessionHistory()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                        <i class="fas fa-search"></i>
                        ì¡°íšŒ
                    </button>
                    <button onclick="resetFilters()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                        <i class="fas fa-redo mr-2"></i>ì´ˆê¸°í™”
                    </button>
                    <button onclick="downloadCSV()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2">
                        <i class="fas fa-download"></i>
                        CSV ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>
            
            <!-- Daily Stats -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        ì¼ë³„ í†µê³„
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ë‚ ì§œ</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ì´ ì„¸ì…˜</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ë¡œê·¸ì¸</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ê²ŒìŠ¤íŠ¸</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ê³ ìœ  ì‚¬ìš©ì</th>
                            </tr>
                        </thead>
                        <tbody id="dailyStatsTable" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="emptyDailyStats" class="hidden px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-chart-bar text-4xl mb-3"></i>
                    <p>ì¡°íšŒëœ í†µê³„ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            </div>
            
            <!-- Sessions List -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-list text-indigo-600 mr-2"></i>
                        ì„¸ì…˜ ëª©ë¡ (<span id="sessionCount">0</span>ê°œ)
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ì‚¬ìš©ì</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">í•™ì›ëª…</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ë¡œê·¸ì¸</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ì ‘ì† ì‹œê°„</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ë¡œê·¸ì•„ì›ƒ</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">ë§ˆì§€ë§‰ í™œë™</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-700 uppercase">IP ì£¼ì†Œ</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsTable" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
                <div id="emptySessions" class="hidden px-6 py-12 text-center text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>ì¡°íšŒëœ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
        <!-- End History Tab -->
    </div>

    <script>
        let autoRefreshInterval = null;
        let currentSessionsData = null;

        // UTF-8 safe base64 encoding
        function base64Encode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                return String.fromCharCode('0x' + p1);
            }));
        }
        
        // Tab switching
        function switchTab(tab) {
            if (tab === 'realtime') {
                document.getElementById('tabRealtime').className = 'px-6 py-3 font-semibold text-purple-600 border-b-2 border-purple-600';
                document.getElementById('tabHistory').className = 'px-6 py-3 font-semibold text-gray-500 hover:text-purple-600';
                document.getElementById('contentRealtime').classList.remove('hidden');
                document.getElementById('contentHistory').classList.add('hidden');
                loadActiveSessions();
            } else {
                document.getElementById('tabRealtime').className = 'px-6 py-3 font-semibold text-gray-500 hover:text-purple-600';
                document.getElementById('tabHistory').className = 'px-6 py-3 font-semibold text-purple-600 border-b-2 border-purple-600';
                document.getElementById('contentRealtime').classList.add('hidden');
                document.getElementById('contentHistory').classList.remove('hidden');
                
                // Set default dates (last 7 days)
                const today = new Date();
                const weekAgo = new Date(today);
                weekAgo.setDate(today.getDate() - 7);
                document.getElementById('endDate').value = today.toISOString().split('T')[0];
                document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
                
                loadSessionHistory();
            }
        }
        
        // Load session history
        async function loadSessionHistory() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (!user.id || user.role !== 'admin') {
                    alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }
                
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const searchKeyword = document.getElementById('searchKeyword').value;
                
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (searchKeyword) params.append('search', searchKeyword);
                
                const userDataBase64 = base64Encode(JSON.stringify(user));
                const response = await fetch('/api/admin/sessions/history?' + params.toString(), {
                    headers: {
                        'X-User-Data-Base64': userDataBase64
                    }
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    alert(result.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                currentSessionsData = result;
                
                // Render daily stats
                renderDailyStats(result.dailyStats);
                
                // Render sessions list
                renderSessions(result.sessions);
                
            } catch (err) {
                console.error('Load history error:', err);
                alert('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        function renderDailyStats(stats) {
            const table = document.getElementById('dailyStatsTable');
            const empty = document.getElementById('emptyDailyStats');
            
            if (!stats || stats.length === 0) {
                table.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            table.innerHTML = stats.map(stat => \`
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">\${stat.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">\${stat.total_sessions}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">\${stat.logged_in_sessions}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-orange-600">\${stat.guest_sessions}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">\${stat.unique_users}</td>
                </tr>
            \`).join('');
        }
        
        function renderSessions(sessions) {
            const table = document.getElementById('sessionsTable');
            const empty = document.getElementById('emptySessions');
            const count = document.getElementById('sessionCount');
            
            count.textContent = sessions.length;
            
            if (!sessions || sessions.length === 0) {
                table.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            table.innerHTML = sessions.map(session => \`
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">\${session.user_name || '-'}</div>
                        <div class="text-sm text-gray-500">\${session.user_email || '-'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">\${session.academy_name || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        \${session.is_logged_in === 1 
                            ? '<span class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded-full">íšŒì›</span>'
                            : '<span class="px-2 py-1 text-xs bg-gray-100 text-gray-800 rounded-full">ê²ŒìŠ¤íŠ¸</span>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">\${formatKoreanTime(session.created_at)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">\${formatKoreanTime(session.logout_time)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">\${formatKoreanTime(session.last_activity)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">\${session.ip_address || '-'}</td>
                </tr>
            \`).join('');
        }
        
        function resetFilters() {
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];
            document.getElementById('searchKeyword').value = '';
            loadSessionHistory();
        }
        
        function downloadCSV() {
            if (!currentSessionsData || !currentSessionsData.sessions) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const sessions = currentSessionsData.sessions;
            const headers = ['ì‚¬ìš©ìëª…', 'ì´ë©”ì¼', 'í•™ì›ëª…', 'ë¡œê·¸ì¸ì—¬ë¶€', 'ì ‘ì†ì‹œê°„', 'ë¡œê·¸ì•„ì›ƒì‹œê°„', 'ë§ˆì§€ë§‰í™œë™', 'IPì£¼ì†Œ'];
            const rows = sessions.map(s => [
                s.user_name || '',
                s.user_email || '',
                s.academy_name || '',
                s.is_logged_in === 1 ? 'íšŒì›' : 'ê²ŒìŠ¤íŠ¸',
                s.created_at || '',
                s.logout_time || '',
                s.last_activity || '',
                s.ip_address || ''
            ]);
            
            const csv = [headers, ...rows].map(row => row.map(cell => \`"\${cell}"\`).join(',')).join('\\n');
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = \`ì ‘ì†ìí†µê³„_\${new Date().toISOString().split('T')[0]}.csv\`;
            link.click();
        }

        function formatKoreanTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            // UTC ì‹œê°„ì„ KST (UTC+9)ë¡œ ë³€í™˜
            const kstDate = new Date(date.getTime() + (9 * 60 * 60 * 1000));
            return kstDate.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        async function loadActiveSessions() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (!user.id || user.role !== 'admin') {
                    alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/admin/dashboard';
                    return;
                }

                const userDataBase64 = base64Encode(JSON.stringify(user));
                const response = await fetch('/api/admin/active-sessions', {
                    headers: {
                        'X-User-Data-Base64': userDataBase64
                    }
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    alert(result.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // Update stats
                document.getElementById('totalActive').textContent = result.activeSessions.total;
                document.getElementById('loggedInCount').textContent = result.activeSessions.loggedInCount;
                document.getElementById('guestsCount').textContent = result.activeSessions.guestsCount;
                document.getElementById('totalSessions').textContent = result.totalStats.total_sessions;
                
                // Update titles
                document.getElementById('loggedInCountTitle').textContent = result.activeSessions.loggedInCount;
                document.getElementById('guestsCountTitle').textContent = result.activeSessions.guestsCount;
                
                // Render logged in users
                renderLoggedInUsers(result.activeSessions.loggedIn);
                
                // Render guests
                renderGuests(result.activeSessions.guests);
                
                // Update last update time
                document.getElementById('lastUpdate').textContent = formatKoreanTime(new Date().toISOString());
            } catch (err) {
                console.error('Error loading sessions:', err);
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function renderLoggedInUsers(users) {
            const tbody = document.getElementById('loggedInUsersTable');
            const empty = document.getElementById('emptyLoggedIn');
            
            if (users.length === 0) {
                tbody.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            tbody.innerHTML = users.map(u => \`
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="font-medium text-gray-900">\${u.user_name || 'Unknown'}</div>
                        <div class="text-sm text-gray-500">\${u.user_email || '-'}</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">\${u.academy_name || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">\${formatKoreanTime(u.login_time)}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">\${formatKoreanTime(u.logout_time)}</td>
                    <td class="px-6 py-4 text-sm">
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs">
                            \${formatKoreanTime(u.last_activity)}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">\${u.ip_address || '-'}</td>
                </tr>
            \`).join('');
        }

        function renderGuests(guests) {
            const tbody = document.getElementById('guestsTable');
            const empty = document.getElementById('emptyGuests');
            
            if (guests.length === 0) {
                tbody.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            
            tbody.innerHTML = guests.map(g => \`
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-mono text-gray-600">\${g.session_id.substring(0, 12)}...</td>
                    <td class="px-6 py-4 text-sm text-gray-900">\${formatKoreanTime(g.created_at)}</td>
                    <td class="px-6 py-4 text-sm">
                        <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs">
                            \${formatKoreanTime(g.last_activity)}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">\${g.ip_address || '-'}</td>
                </tr>
            \`).join('');
        }

        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('loginTime');
            window.location.href = '/';
        }

        // Auto refresh functionality
        document.getElementById('autoRefresh').addEventListener('change', (e) => {
            if (e.target.checked) {
                autoRefreshInterval = setInterval(loadActiveSessions, 10000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        });

        // Load on page load
        loadActiveSessions();
    </script>
</body>
</html>`)
})

// .html í™•ì¥ì ì ‘ê·¼ ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸
app.get('/admin/programs.html', (c) => {
  return c.redirect('/admin/programs', 301)
})


// ğŸ’° ê´€ë¦¬ì: ë§¤ì¶œ ê´€ë¦¬ í˜ì´ì§€
app.get('/admin/revenue', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë§¤ì¶œ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    </head>
    <body class="bg-gray-50">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-8">
                        <a href="/admin/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a>
                        <div class="flex gap-4">
                            <a href="/admin/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                            <a href="/admin/users" class="text-gray-600 hover:text-purple-600">ì‚¬ìš©ì</a>
                            <a href="/admin/revenue" class="text-purple-600 font-semibold">ë§¤ì¶œ</a>
                            <a href="/admin/bank-transfers" class="text-gray-600 hover:text-purple-600">ê³„ì¢Œì´ì²´</a>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ’° ë§¤ì¶œ ê´€ë¦¬</h1>
                <p class="text-gray-600">
                    ì‹¤ì‹œê°„ ë§¤ì¶œ í†µê³„ ë° ê±°ë˜ ë‚´ì—­ì„ í™•ì¸í•˜ì„¸ìš”
                    <span id="currentDate" class="ml-4 font-semibold text-purple-600"></span>
                </p>
            </div>

            <!-- ë¡œë”© ìƒíƒœ -->
            <div id="loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
                <p class="mt-4 text-gray-600">ë°ì´í„° ë¡œë”© ì¤‘...</p>
            </div>

            <!-- ë©”ì¸ ì»¨í…ì¸  -->
            <div id="content" class="hidden">
                <!-- ì›”ë³„ ë§¤ì¶œ ìš”ì•½ ì¹´ë“œ -->
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 text-white mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-indigo-100 text-sm">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</p>
                            <p class="text-4xl font-bold mt-1" id="currentMonthRevenue">â‚©0</p>
                            <p class="text-indigo-100 text-sm mt-2">
                                <span id="currentMonthCount">0</span>ê±´ Â· 
                                <span id="currentMonthName"></span>
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-indigo-100 text-sm">ì§€ë‚œ ë‹¬ ë§¤ì¶œ</p>
                            <p class="text-2xl font-bold mt-1" id="lastMonthRevenue">â‚©0</p>
                            <p class="text-indigo-100 text-sm mt-2">
                                <span id="lastMonthCount">0</span>ê±´ Â· 
                                <span id="lastMonthName"></span>
                            </p>
                        </div>
                        <div class="text-right">
                            <p class="text-indigo-100 text-sm">ì¦ê°ë¥ </p>
                            <p class="text-2xl font-bold mt-1" id="growthRate">-</p>
                            <p class="text-indigo-100 text-sm mt-2">ì „ì›” ëŒ€ë¹„</p>
                        </div>
                    </div>
                </div>
                
                <!-- í†µê³„ ì¹´ë“œ -->
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-purple-100">ì´ ë§¤ì¶œ</span>
                            <i class="fas fa-won-sign text-2xl"></i>
                        </div>
                        <p class="text-3xl font-bold" id="totalRevenue">â‚©0</p>
                        <p class="text-purple-100 text-sm mt-2">
                            <span id="totalCount">0</span>ê±´
                        </p>
                    </div>

                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-blue-100">ì¹´ë“œ ê²°ì œ</span>
                            <i class="fas fa-credit-card text-2xl"></i>
                        </div>
                        <p class="text-3xl font-bold" id="cardRevenue">â‚©0</p>
                        <p class="text-blue-100 text-sm mt-2">
                            <span id="cardCount">0</span>ê±´
                        </p>
                    </div>

                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-green-100">ê³„ì¢Œì´ì²´</span>
                            <i class="fas fa-university text-2xl"></i>
                        </div>
                        <p class="text-3xl font-bold" id="bankRevenue">â‚©0</p>
                        <p class="text-green-100 text-sm mt-2">
                            <span id="bankCount">0</span>ê±´
                        </p>
                    </div>

                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-yellow-100">ì›” í‰ê· </span>
                            <i class="fas fa-chart-line text-2xl"></i>
                        </div>
                        <p class="text-3xl font-bold" id="avgRevenue">â‚©0</p>
                        <p class="text-yellow-100 text-sm mt-2">ìµœê·¼ 12ê°œì›”</p>
                    </div>
                </div>

                <!-- ì°¨íŠ¸ ì˜ì—­ -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow p-6 border">
                        <h3 class="text-lg font-bold mb-4">ì¼ë³„ ë§¤ì¶œ ì¶”ì´ (ìµœê·¼ 30ì¼)</h3>
                        <canvas id="dailyChart"></canvas>
                    </div>

                    <div class="bg-white rounded-xl shadow p-6 border">
                        <h3 class="text-lg font-bold mb-4">í”Œëœë³„ ë§¤ì¶œ ë¶„í¬</h3>
                        <canvas id="planChart"></canvas>
                    </div>
                </div>

                <!-- í•„í„° ì˜ì—­ -->
                <div class="bg-white rounded-xl shadow p-6 border mb-6">
                    <h3 class="text-lg font-bold mb-4">ê±°ë˜ ë‚´ì—­ í•„í„°</h3>
                    <div class="grid md:grid-cols-4 gap-4">
                        <select id="filterMethod" class="px-4 py-2 border rounded-lg">
                            <option value="">ì „ì²´ ê²°ì œìˆ˜ë‹¨</option>
                            <option value="card">ì¹´ë“œ ê²°ì œ</option>
                            <option value="bank_transfer">ê³„ì¢Œì´ì²´</option>
                        </select>

                        <select id="filterPlan" class="px-4 py-2 border rounded-lg">
                            <option value="">ì „ì²´ í”Œëœ</option>
                            <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </select>

                        <input type="date" id="filterStartDate" class="px-4 py-2 border rounded-lg">
                        <input type="date" id="filterEndDate" class="px-4 py-2 border rounded-lg">
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button onclick="applyFilters()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            <i class="fas fa-filter mr-2"></i>í•„í„° ì ìš©
                        </button>
                        <button onclick="resetFilters()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            <i class="fas fa-redo mr-2"></i>ì´ˆê¸°í™”
                        </button>
                        <button onclick="exportData()" class="ml-auto px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-download mr-2"></i>ë‚´ë³´ë‚´ê¸°
                        </button>
                    </div>
                </div>

                <!-- ê±°ë˜ ë‚´ì—­ í…Œì´ë¸” -->
                <div class="bg-white rounded-xl shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-bold">ê±°ë˜ ë‚´ì—­</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">ë‚ ì§œ/ì‹œê°„</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">ì‚¬ìš©ì</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">í”Œëœ</th>
                                    <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700">ê²°ì œìˆ˜ë‹¨</th>
                                    <th class="px-6 py-3 text-right text-sm font-semibold text-gray-700">ê¸ˆì•¡</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsList" class="divide-y">
                                <!-- ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 bg-gray-50 border-t">
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-gray-600">
                                ì´ <span id="transactionTotal">0</span>ê±´
                            </p>
                            <div class="flex gap-2">
                                <button onclick="loadPreviousPage()" id="prevBtn" class="px-4 py-2 text-sm border rounded-lg hover:bg-gray-100 disabled:opacity-50" disabled>
                                    ì´ì „
                                </button>
                                <button onclick="loadNextPage()" id="nextBtn" class="px-4 py-2 text-sm border rounded-lg hover:bg-gray-100 disabled:opacity-50" disabled>
                                    ë‹¤ìŒ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // 5ì‹œê°„ ìë™ ë¡œê·¸ì•„ì›ƒ ì²´í¬
            function checkAutoLogout() {
                const loginTime = localStorage.getItem('loginTime');
                const user = localStorage.getItem('user');
                
                if (!user) {
                    location.href = '/login';
                    return;
                }
                
                if (loginTime) {
                    const elapsed = Date.now() - parseInt(loginTime);
                    const fiveHours = 5 * 60 * 60 * 1000; // 5ì‹œê°„ = 18000000ms
                    
                    if (elapsed >= fiveHours) {
                        localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                        localStorage.removeItem('loginTime');
                        alert('5ì‹œê°„ì´ ê²½ê³¼í•˜ì—¬ ìë™ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.href = '/login';
                    }
                }
            }
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì²´í¬
            checkAutoLogout();
            // 1ë¶„ë§ˆë‹¤ ì£¼ê¸°ì ìœ¼ë¡œ ì²´í¬
            setInterval(checkAutoLogout, 60000);

            let currentOffset = 0;
            const limit = 50;
            let totalTransactions = 0;
            let statsData = null;
            let dailyChart = null;
            let planChart = null;

            function logout() {
                localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                localStorage.removeItem('loginTime');
                location.href = '/';
            }

            function formatCurrency(amount) {
                return 'â‚©' + (amount || 0).toLocaleString('ko-KR');
            }

            function formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function getPaymentMethodBadge(method) {
                if (method === 'card') {
                    return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">ì¹´ë“œ</span>';
                } else if (method === 'bank_transfer') {
                    return '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">ê³„ì¢Œì´ì²´</span>';
                }
                return method;
            }

            async function loadStats() {
                try {
                    const response = await fetch('/api/admin/revenue/stats');
                    const data = await response.json();
                    
                    if (data.success) {
                        statsData = data.data;
                        updateStatCards(data.data);
                        updateCharts(data.data);
                        updatePlanFilter(data.data.byPlan);
                    }
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }

            function updateStatCards(data) {
                // í˜„ì¬ ë‚ ì§œ í‘œì‹œ
                const now = new Date();
                const dateStr = now.getFullYear() + 'ë…„ ' + (now.getMonth() + 1) + 'ì›” ' + now.getDate() + 'ì¼';
                document.getElementById('currentDate').textContent = dateStr;
                
                // ì´ ë§¤ì¶œ ì¹´ë“œ
                document.getElementById('totalRevenue').textContent = formatCurrency(data.total.revenue);
                document.getElementById('totalCount').textContent = data.total.count;
                
                // ê²°ì œ ìˆ˜ë‹¨ë³„ ì¹´ë“œ
                document.getElementById('cardRevenue').textContent = formatCurrency(data.byMethod.card.revenue);
                document.getElementById('cardCount').textContent = data.byMethod.card.count;
                
                document.getElementById('bankRevenue').textContent = formatCurrency(data.byMethod.bank_transfer.revenue);
                document.getElementById('bankCount').textContent = data.byMethod.bank_transfer.count;
                
                // ì›” í‰ê· 
                const avgMonthly = data.monthly.length > 0 
                    ? Math.floor(data.monthly.reduce((sum, m) => sum + (m.revenue || 0), 0) / data.monthly.length)
                    : 0;
                document.getElementById('avgRevenue').textContent = formatCurrency(avgMonthly);
                
                // ì›”ë³„ ë°ì´í„° (ìµœì‹  2ê°œì›”)
                if (data.monthly && data.monthly.length > 0) {
                    const currentMonth = data.monthly[0]; // ê°€ì¥ ìµœê·¼ ë‹¬
                    const lastMonth = data.monthly[1] || { month: '', count: 0, revenue: 0 };
                    
                    // í˜„ì¬ ë‹¬
                    document.getElementById('currentMonthRevenue').textContent = formatCurrency(currentMonth.revenue || 0);
                    document.getElementById('currentMonthCount').textContent = currentMonth.count || 0;
                    document.getElementById('currentMonthName').textContent = formatMonthName(currentMonth.month);
                    
                    // ì§€ë‚œ ë‹¬
                    document.getElementById('lastMonthRevenue').textContent = formatCurrency(lastMonth.revenue || 0);
                    document.getElementById('lastMonthCount').textContent = lastMonth.count || 0;
                    document.getElementById('lastMonthName').textContent = formatMonthName(lastMonth.month);
                    
                    // ì¦ê°ë¥  ê³„ì‚°
                    if (lastMonth.revenue > 0) {
                        const growth = ((currentMonth.revenue - lastMonth.revenue) / lastMonth.revenue * 100).toFixed(1);
                        const growthText = growth >= 0 ? ('+' + growth + '%') : (growth + '%');
                        const growthColor = growth >= 0 ? 'â†‘' : 'â†“';
                        document.getElementById('growthRate').textContent = growthColor + ' ' + growthText;
                    } else {
                        document.getElementById('growthRate').textContent = '-';
                    }
                } else {
                    // ë°ì´í„° ì—†ì„ ë•Œ
                    document.getElementById('currentMonthRevenue').textContent = 'â‚©0';
                    document.getElementById('currentMonthCount').textContent = '0';
                    document.getElementById('currentMonthName').textContent = now.getFullYear() + 'ë…„ ' + (now.getMonth() + 1) + 'ì›”';
                    document.getElementById('lastMonthRevenue').textContent = 'â‚©0';
                    document.getElementById('lastMonthCount').textContent = '0';
                    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    document.getElementById('lastMonthName').textContent = lastMonth.getFullYear() + 'ë…„ ' + (lastMonth.getMonth() + 1) + 'ì›”';
                    document.getElementById('growthRate').textContent = '-';
                }
            }
            
            function formatMonthName(monthStr) {
                if (!monthStr) return '';
                const parts = monthStr.split('-'); // '2026-01' í˜•ì‹
                return parts[0] + 'ë…„ ' + parseInt(parts[1]) + 'ì›”';
            }

            function updateCharts(data) {
                // ì¼ë³„ ì°¨íŠ¸ - ë¹ˆ ë°ì´í„° ì²˜ë¦¬
                const dailyLabels = data.daily && data.daily.length > 0
                    ? data.daily.slice(0, 30).reverse().map(d => {
                        const date = new Date(d.date);
                        return (date.getMonth() + 1) + '/' + date.getDate();
                    })
                    : ['ìµœê·¼ 30ì¼'];
                
                const dailyData = data.daily && data.daily.length > 0
                    ? data.daily.slice(0, 30).reverse().map(d => d.revenue || 0)
                    : [0];

                const dailyCtx = document.getElementById('dailyChart').getContext('2d');
                if (dailyChart) dailyChart.destroy();
                dailyChart = new Chart(dailyCtx, {
                    type: 'line',
                    data: {
                        labels: dailyLabels,
                        datasets: [{
                            label: 'ì¼ë³„ ë§¤ì¶œ',
                            data: dailyData,
                            borderColor: 'rgb(147, 51, 234)',
                            backgroundColor: 'rgba(147, 51, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'â‚©' + (value / 1000) + 'K';
                                    }
                                }
                            }
                        }
                    }
                });

                // í”Œëœë³„ ì°¨íŠ¸ - ë¹ˆ ë°ì´í„° ì²˜ë¦¬
                const planLabels = data.byPlan && data.byPlan.length > 0
                    ? data.byPlan.map(p => p.plan_name)
                    : ['ë°ì´í„° ì—†ìŒ'];
                
                const planData = data.byPlan && data.byPlan.length > 0
                    ? data.byPlan.map(p => p.revenue || 0)
                    : [1];
                const planColors = [
                    'rgb(147, 51, 234)',
                    'rgb(59, 130, 246)',
                    'rgb(16, 185, 129)',
                    'rgb(245, 158, 11)',
                    'rgb(239, 68, 68)',
                    'rgb(168, 85, 247)'
                ];

                const planCtx = document.getElementById('planChart').getContext('2d');
                if (planChart) planChart.destroy();
                planChart = new Chart(planCtx, {
                    type: 'doughnut',
                    data: {
                        labels: planLabels,
                        datasets: [{
                            data: planData,
                            backgroundColor: planColors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            function updatePlanFilter(plans) {
                const select = document.getElementById('filterPlan');
                plans.forEach(plan => {
                    const option = document.createElement('option');
                    option.value = plan.plan_name;
                    option.textContent = plan.plan_name;
                    select.appendChild(option);
                });
            }

            async function loadTransactions(offset = 0) {
                try {
                    const method = document.getElementById('filterMethod').value;
                    const plan = document.getElementById('filterPlan').value;
                    const startDate = document.getElementById('filterStartDate').value;
                    const endDate = document.getElementById('filterEndDate').value;

                    let url = '/api/admin/revenue/transactions?limit=' + limit + '&offset=' + offset;
                    if (method) url += '&method=' + method;
                    if (plan) url += '&plan=' + encodeURIComponent(plan);
                    if (startDate) url += '&startDate=' + startDate;
                    if (endDate) url += '&endDate=' + endDate;

                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.success) {
                        totalTransactions = data.data.pagination.total;
                        updateTransactionsList(data.data.transactions);
                        updatePagination(data.data.pagination);
                    }
                } catch (error) {
                    console.error('Error loading transactions:', error);
                }
            }

            function updateTransactionsList(transactions) {
                const tbody = document.getElementById('transactionsList');
                tbody.innerHTML = '';

                if (transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }

                transactions.forEach(t => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = '<td class="px-6 py-4 text-sm text-gray-900">' + formatDate(t.created_at) + '</td>' +
                        '<td class="px-6 py-4 text-sm">' +
                            '<div class="font-medium text-gray-900">' + t.user_name + '</div>' +
                            '<div class="text-gray-500">' + t.user_email + '</div>' +
                        '</td>' +
                        '<td class="px-6 py-4 text-sm text-gray-900">' + t.plan_name + '</td>' +
                        '<td class="px-6 py-4 text-sm">' + getPaymentMethodBadge(t.payment_method) + '</td>' +
                        '<td class="px-6 py-4 text-sm text-right font-semibold text-gray-900">' + formatCurrency(t.amount) + '</td>';
                    tbody.appendChild(row);
                });
            }

            function updatePagination(pagination) {
                document.getElementById('transactionTotal').textContent = pagination.total;
                document.getElementById('prevBtn').disabled = pagination.offset === 0;
                document.getElementById('nextBtn').disabled = !pagination.hasMore;
                currentOffset = pagination.offset;
            }

            function loadPreviousPage() {
                if (currentOffset > 0) {
                    loadTransactions(currentOffset - limit);
                }
            }

            function loadNextPage() {
                loadTransactions(currentOffset + limit);
            }

            function applyFilters() {
                currentOffset = 0;
                loadTransactions(0);
            }

            function resetFilters() {
                document.getElementById('filterMethod').value = '';
                document.getElementById('filterPlan').value = '';
                document.getElementById('filterStartDate').value = '';
                document.getElementById('filterEndDate').value = '';
                applyFilters();
            }

            function exportData() {
                if (!statsData) return;

                let csv = 'ë‚ ì§œ,ì‚¬ìš©ì,ì´ë©”ì¼,í”Œëœ,ê²°ì œìˆ˜ë‹¨,ê¸ˆì•¡\\n';
                
                // ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ ì „ì²´ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•˜ì§€ë§Œ, 
                // ì—¬ê¸°ì„œëŠ” í˜„ì¬ í˜ì´ì§€ì˜ ë°ì´í„°ë§Œ ë‚´ë³´ëƒ…ë‹ˆë‹¤
                const tbody = document.getElementById('transactionsList');
                const rows = tbody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 1) {
                        const date = cells[0].textContent.trim();
                        const userName = cells[1].querySelector('div:first-child').textContent.trim();
                        const userEmail = cells[1].querySelector('div:last-child').textContent.trim();
                        const plan = cells[2].textContent.trim();
                        const method = cells[3].textContent.trim();
                        const amount = cells[4].textContent.trim();
                        csv += '"' + date + '","' + userName + '","' + userEmail + '","' + plan + '","' + method + '","' + amount + '"\\n';
                    }
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'revenue_' + new Date().toISOString().split('T')[0] + '.csv';
                link.click();
            }

            // ì´ˆê¸° ë¡œë”©
            async function init() {
                await loadStats();
                await loadTransactions(0);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');
            }

            init();
        </script>
    </body>
    </html>
  `)
})

// ê´€ë¦¬ì í”„ë¡œê·¸ë¨ ê´€ë¦¬ í˜ì´ì§€
app.get('/admin/programs', async (c) => {
  const { env } = c
  
  // ëª¨ë“  ì‚¬ìš©ìì™€ í”„ë¡œê·¸ë¨ ëª©ë¡ ì¡°íšŒ
  const users = await env.DB.prepare('SELECT id, email, name, role FROM users WHERE role != ? ORDER BY created_at DESC').bind('admin').all()

  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í”„ë¡œê·¸ë¨ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-8">
                        <a href="/admin/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a>
                        <div class="flex gap-4">
                            <a href="/admin/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                            <a href="/admin/users" class="text-gray-600 hover:text-purple-600">ì‚¬ìš©ì</a>
                            <a href="/admin/contacts" class="text-gray-600 hover:text-purple-600">ë¬¸ì˜</a>
                            <a href="/admin/bank-transfers" class="text-gray-600 hover:text-purple-600">ê³„ì¢Œì´ì²´</a>
                            <a href="/admin/programs" class="text-purple-600 font-semibold">í”„ë¡œê·¸ë¨</a>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">í”„ë¡œê·¸ë¨ ê´€ë¦¬</h1>
                <p class="text-gray-600">ì´ 13ê°œì˜ êµìœ¡ í”„ë¡œê·¸ë¨ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. í´ë¦­í•˜ì—¬ ê¶Œí•œì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
            </div>

            <div id="programsGrid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- ê¶Œí•œ ê´€ë¦¬ ëª¨ë‹¬ -->
        <div id="permissionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">
                        <span id="modalProgramIcon"></span>
                        <span id="modalProgramName"></span> ê¶Œí•œ ê´€ë¦¬
                    </h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-bold mb-4">ì‚¬ìš©ìë³„ ê¶Œí•œ ì„¤ì •</h3>
                    <div id="usersList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                </div>

                <div class="flex gap-4">
                    <button onclick="savePermissions()" class="flex-1 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                        <i class="fas fa-save mr-2"></i>ì €ì¥
                    </button>
                    <button onclick="closeModal()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold">
                        ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>

        <script>
            const programs = [
                { id: 'naver-place', name: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ìƒìœ„ë…¸ì¶œ', desc: 'ì§€ì—­ ê²€ìƒ‰ 1ìœ„ë¥¼ ìœ„í•œ ì‹¤ì „ ë…¸í•˜ìš°', icon: 'ğŸ—ºï¸', url: '/programs/naver-place' },
                { id: 'blog', name: 'ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œ', desc: 'ê²€ìƒ‰ 1í˜ì´ì§€ ì§„ì…ì„ ìœ„í•œ ë¸”ë¡œê·¸ ë§ˆì¼€íŒ…', icon: 'ğŸ“', url: '/programs/blog' },
                { id: 'funnel', name: 'í¼ë„ ë§ˆì¼€íŒ…', desc: 'ìë™í™”ëœ í•™ìƒ ëª¨ì§‘ ì‹œìŠ¤í…œ êµ¬ì¶•', icon: 'ğŸ¯', url: '/programs/funnel' },
                { id: 'sns', name: 'SNS ë§ˆì¼€íŒ…', desc: 'ì¸ìŠ¤íƒ€ê·¸ë¨, í˜ì´ìŠ¤ë¶ í™œìš© ì „ëµ', icon: 'ğŸ“±', url: '/programs/sns' },
                { id: 'video', name: 'ì˜ìƒ ë§ˆì¼€íŒ…', desc: 'ìœ íŠœë¸Œ, ìˆí¼ ì½˜í…ì¸  ì œì‘', icon: 'ğŸ¥', url: '/programs/video' },
                { id: 'ad', name: 'ì˜¨ë¼ì¸ ê´‘ê³ ', desc: 'ë„¤ì´ë²„, êµ¬ê¸€ ê´‘ê³  ìš´ì˜ ì „ëµ', icon: 'ğŸ’°', url: '/programs/ad' },
                { id: 'community', name: 'ì»¤ë®¤ë‹ˆí‹° ë§ˆì¼€íŒ…', desc: 'í•™ë¶€ëª¨ ì»¤ë®¤ë‹ˆí‹° í™œì„±í™” ì „ëµ', icon: 'ğŸ‘¥', url: '/programs/community' },
                { id: 'branding', name: 'ë¸Œëœë”©', desc: 'í•™ì› ë¸Œëœë“œ ì•„ì´ë´í‹°í‹° êµ¬ì¶•', icon: 'ğŸ¨', url: '/programs/branding' },
                { id: 'data', name: 'ë°ì´í„° ë¶„ì„', desc: 'ë§ˆì¼€íŒ… ì„±ê³¼ ë¶„ì„ ë° ìµœì í™”', icon: 'ğŸ“Š', url: '/programs/data' },
                { id: 'carrot', name: 'ë‹¹ê·¼ ë¹„ì¦ˆë‹ˆìŠ¤ ë§ˆì¼€íŒ…', desc: 'ì§€ì—­ ê¸°ë°˜ ë‹¹ê·¼ë§ˆì¼“ í™œìš© ì „ëµ', icon: 'ğŸ¥•', url: '/programs/carrot' },
                { id: 'meta', name: 'ë©”íƒ€ ê´‘ê³ ', desc: 'Facebook/Instagram ê´‘ê³  ìš´ì˜', icon: 'ğŸ“˜', url: '/programs/meta' },
                { id: 'youtube-ad', name: 'ìœ íŠœë¸Œ ê´‘ê³ ', desc: 'ìœ íŠœë¸Œ ê´‘ê³  ìº í˜ì¸ ìš´ì˜', icon: 'ğŸ“º', url: '/programs/youtube-ad' },
                { id: 'threads', name: 'ì“°ë ˆë“œ ë§ˆì¼€íŒ…', desc: 'Meta Threads í™œìš© ì „ëµ', icon: 'ğŸ§µ', url: '/programs/threads' }
            ];

            const users = ${JSON.stringify(users.results || [])};
            let currentProgram = null;
            let userPermissions = {};

            // í”„ë¡œê·¸ë¨ ì¹´ë“œ ë Œë”ë§
            function renderPrograms() {
                const grid = document.getElementById('programsGrid');
                grid.innerHTML = programs.map(p => 
                    '<div onclick="openPermissionModal(\\'' + p.id + '\\')" ' +
                         'class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 hover:border-purple-300 hover:shadow-lg transition cursor-pointer">' +
                        '<div class="text-4xl mb-3">' + p.icon + '</div>' +
                        '<h3 class="text-xl font-bold text-gray-900 mb-2">' + p.name + '</h3>' +
                        '<p class="text-gray-600 text-sm mb-4">' + p.desc + '</p>' +
                        '<div class="flex gap-2">' +
                            '<span class="px-3 py-1 bg-green-100 text-green-700 text-xs rounded-full">í™œì„±í™”</span>' +
                            '<a href="' + p.url + '" target="_blank" onclick="event.stopPropagation()" ' +
                               'class="px-3 py-1 bg-blue-100 text-blue-700 text-xs rounded-full hover:bg-blue-200">' +
                                '<i class="fas fa-external-link-alt mr-1"></i>ë³´ê¸°' +
                            '</a>' +
                        '</div>' +
                    '</div>'
                ).join('');
            }

            // ê¶Œí•œ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
            async function openPermissionModal(programId) {
                currentProgram = programs.find(p => p.id === programId);
                document.getElementById('modalProgramIcon').textContent = currentProgram.icon;
                document.getElementById('modalProgramName').textContent = currentProgram.name;

                // ì‚¬ìš©ìë³„ ê¶Œí•œ ì¡°íšŒ
                userPermissions = {};
                for (const user of users) {
                    const response = await fetch('/api/user/' + user.id + '/permissions');
                    const data = await response.json();
                    const permissions = data.permissions || [];
                    userPermissions[user.id] = permissions.some(
                        p => p.permission_type === 'program' && p.permission_name === programId && p.is_active === 1
                    );
                }

                renderUsersList();
                document.getElementById('permissionModal').classList.remove('hidden');
            }

            // ì‚¬ìš©ì ëª©ë¡ ë Œë”ë§
            function renderUsersList() {
                const list = document.getElementById('usersList');
                list.innerHTML = users.map(user =>
                    '<div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">' +
                        '<div class="flex-1">' +
                            '<p class="font-semibold text-gray-900">' + user.name + '</p>' +
                            '<p class="text-sm text-gray-600">' + user.email + '</p>' +
                        '</div>' +
                        '<label class="flex items-center cursor-pointer">' +
                            '<input type="checkbox" ' +
                                   'id="user-' + user.id + '" ' +
                                   (userPermissions[user.id] ? 'checked' : '') +
                                   ' class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500">' +
                            '<span class="ml-3 text-sm font-medium text-gray-900">ê¶Œí•œ ë¶€ì—¬</span>' +
                        '</label>' +
                    '</div>'
                ).join('');
            }

            // ê¶Œí•œ ì €ì¥
            async function savePermissions() {
                const updates = [];
                
                for (const user of users) {
                    const checkbox = document.getElementById('user-' + user.id);
                    const hasPermission = checkbox.checked;
                    const hadPermission = userPermissions[user.id];

                    if (hasPermission !== hadPermission) {
                        updates.push({ userId: user.id, hasPermission });
                    }
                }

                if (updates.length === 0) {
                    alert('ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                for (const update of updates) {
                    const url = update.hasPermission 
                        ? '/api/admin/permissions/grant'
                        : '/api/admin/permissions/revoke';

                    await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: update.userId,
                            permissionType: 'program',
                            permissionName: currentProgram.id
                        })
                    });
                }

                alert('ê¶Œí•œì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal();
            }

            function closeModal() {
                document.getElementById('permissionModal').classList.add('hidden');
                currentProgram = null;
            }

            function logout() {
                if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                    window.location.href = '/';
                }
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ í”„ë¡œê·¸ë¨ ë Œë”ë§
            renderPrograms();
        </script>
    </body>
    </html>
  `)
})

// ========================================
// SMS í˜ì´ì§€ ë¼ìš°íŠ¸
// ========================================

// ë°œì‹ ë²ˆí˜¸ ê´€ë¦¬ í˜ì´ì§€
app.get('/sms/senders', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë°œì‹ ë²ˆí˜¸ ê´€ë¦¬ - SMS ë°œì†¡</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-8">
                        <a href="/dashboard" class="text-xl font-bold text-purple-600">SMS ë°œì†¡ ì‹œìŠ¤í…œ</a>
                        <div class="flex space-x-4">
                            <a href="/sms/senders" class="text-purple-600 border-b-2 border-purple-600 px-3 py-2 font-medium">ë°œì‹ ë²ˆí˜¸</a>
                            <a href="/sms/compose" class="text-gray-600 hover:text-purple-600 px-3 py-2">ë¬¸ì ì‘ì„±</a>
                            <a href="/sms/logs" class="text-gray-600 hover:text-purple-600 px-3 py-2">ë°œì†¡ ë‚´ì—­</a>
                            <a href="/sms/points" class="text-gray-600 hover:text-purple-600 px-3 py-2">í¬ì¸íŠ¸ ê´€ë¦¬</a>
                        </div>
                    </div>
                    <a href="/dashboard" class="text-gray-600 hover:text-purple-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-6xl mx-auto">
                <!-- Header -->
                <div class="mb-8 flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ“± ë°œì‹ ë²ˆí˜¸ ê´€ë¦¬</h1>
                        <p class="text-gray-600">ë¬¸ì ë°œì†¡ì— ì‚¬ìš©í•  ë°œì‹ ë²ˆí˜¸ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</p>
                    </div>
                    <a href="/sms/sender/request" 
                       class="px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg font-bold hover:from-green-700 hover:to-green-800 transition shadow-md hover:shadow-lg flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span>ì¸ì¦ ì‹ ì²­</span>
                    </a>
                </div>

                <!-- ì•Œë¦¬ê³  ì•ˆë‚´ -->
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-6 mb-6">
                    <div class="flex items-start space-x-3">
                        <svg class="w-6 h-6 text-orange-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <h3 class="font-semibold text-orange-900 mb-2">âš ï¸ ë°œì‹ ë²ˆí˜¸ ë“±ë¡ ì•ˆë‚´</h3>
                            <ol class="text-sm text-orange-800 space-y-1">
                                <li>1. ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­ì„ ì™„ë£Œ</li>
                                <li>2. ì•„ë˜ "ë°œì‹ ë²ˆí˜¸ ì¶”ê°€" ë²„íŠ¼ìœ¼ë¡œ ì¸ì¦ëœ ë²ˆí˜¸ë¥¼ ì‹œìŠ¤í…œì— ë“±ë¡</li>
                                <li>3. ë“±ë¡ëœ ë°œì‹ ë²ˆí˜¸ë¡œ ë¬¸ì ë°œì†¡ ê°€ëŠ¥</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- ë°œì‹ ë²ˆí˜¸ ì¶”ê°€ -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 mb-4">ë°œì‹ ë²ˆí˜¸ ì¶”ê°€</h2>
                    <div class="flex gap-4">
                        <input type="text" id="phoneNumber" placeholder="010-1234-5678" 
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                            onkeypress="if(event.key === 'Enter') registerSender()">
                        <button id="registerButton" onclick="registerSender()" 
                            class="bg-purple-600 text-white px-8 py-3 rounded-lg hover:bg-purple-700 transition font-medium shadow-sm">
                            ë“±ë¡í•˜ê¸°
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">ğŸ’¡ ë¨¼ì € ì¸ì¦ ì‹ ì²­ì„ ì™„ë£Œí•œ í›„, ì¸ì¦ëœ ë²ˆí˜¸ë¥¼ ì—¬ê¸°ì„œ ë“±ë¡í•´ì£¼ì„¸ìš”</p>
                </div>

                <!-- ë°œì‹ ë²ˆí˜¸ ëª©ë¡ -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-900">ë“±ë¡ëœ ë°œì‹ ë²ˆí˜¸</h2>
                    </div>
                    <div id="sendersContainer" class="divide-y divide-gray-200">
                        <!-- ë¡œë”© ìƒíƒœ -->
                        <div class="p-8 text-center text-gray-500">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"></div>
                            ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let currentUserId = null;

            // ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            async function checkAuth() {
                const user = localStorage.getItem('user');
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return null;
                }
                const userData = JSON.parse(user);
                currentUserId = userData.id;
                return userData;
            }

            // ë°œì‹ ë²ˆí˜¸ ëª©ë¡ ë¡œë“œ
            async function loadSenders() {
                try {
                    const response = await fetch(\`/api/sms/senders?userId=\${currentUserId}\`);
                    const data = await response.json();

                    const container = document.getElementById('sendersContainer');
                    
                    if (data.success && data.senders.length > 0) {
                        container.innerHTML = data.senders.map(sender => \`
                            <div class="p-6 hover:bg-gray-50 transition">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="font-semibold text-gray-900 text-lg">\${formatPhoneNumber(sender.phone_number)}</div>
                                            <div class="text-sm text-gray-500">ì¸ì¦: \${sender.verification_date || 'ì•Œ ìˆ˜ ì—†ìŒ'}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <span class="px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-full">
                                            âœ“ ì¸ì¦ì™„ë£Œ
                                        </span>
                                        <button onclick="deleteSender(\${sender.id})" 
                                            class="text-red-600 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        \`).join('');
                    } else {
                        container.innerHTML = \`
                            <div class="p-12 text-center">
                                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                <p class="text-gray-500 mb-2">ë“±ë¡ëœ ë°œì‹ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                                <p class="text-sm text-gray-400">ì•Œë¦¬ê³  ì›¹ì‚¬ì´íŠ¸ì—ì„œ ì¸ì¦ í›„ ë“±ë¡í•´ì£¼ì„¸ìš”</p>
                            </div>
                        \`;
                    }
                } catch (err) {
                    console.error('Failed to load senders:', err);
                    alert('ë°œì‹ ë²ˆí˜¸ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
            function formatPhoneNumber(phone) {
                if (phone.length === 10) {
                    return phone.replace(/(\\d{3})(\\d{3})(\\d{4})/, '$1-$2-$3');
                } else if (phone.length === 11) {
                    return phone.replace(/(\\d{3})(\\d{4})(\\d{4})/, '$1-$2-$3');
                }
                return phone;
            }

            // ë°œì‹ ë²ˆí˜¸ ë“±ë¡
            async function registerSender() {
                console.log('registerSender called, userId:', currentUserId);
                
                if (!currentUserId) {
                    alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    window.location.href = '/login';
                    return;
                }
                
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                
                if (!phoneNumber) {
                    alert('ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    console.log('Sending register request:', { userId: currentUserId, phoneNumber });
                    
                    const response = await fetch('/api/sms/sender/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: currentUserId,
                            phoneNumber: phoneNumber,
                            verificationMethod: 'aligo_web'
                        })
                    });

                    const data = await response.json();
                    console.log('Register response:', data);

                    if (data.success) {
                        alert('âœ… ë°œì‹ ë²ˆí˜¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        document.getElementById('phoneNumber').value = '';
                        loadSenders();
                    } else {
                        alert('âŒ ' + data.error);
                    }
                } catch (err) {
                    console.error('Failed to register sender:', err);
                    alert('ë°œì‹ ë²ˆí˜¸ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                }
            }

            // ë°œì‹ ë²ˆí˜¸ ì‚­ì œ
            async function deleteSender(senderId) {
                if (!confirm('ì´ ë°œì‹ ë²ˆí˜¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }

                try {
                    const response = await fetch(\`/api/sms/sender/\${senderId}?userId=\${currentUserId}\`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('âœ… ë°œì‹ ë²ˆí˜¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadSenders();
                    } else {
                        alert('âŒ ' + data.error);
                    }
                } catch (err) {
                    console.error('Failed to delete sender:', err);
                    alert('ë°œì‹ ë²ˆí˜¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
            (async () => {
                console.log('Page loaded, initializing...');
                await checkAuth();
                if (currentUserId) {
                    console.log('User authenticated, userId:', currentUserId);
                    loadSenders();
                    
                    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì´ì¤‘ ë³´ì•ˆ)
                    const registerBtn = document.getElementById('registerButton');
                    if (registerBtn) {
                        registerBtn.addEventListener('click', registerSender);
                        console.log('Register button event listener added');
                    }
                } else {
                    console.error('User not authenticated');
                }
            })();
        </script>
    </body>
    </html>
  `)
})

// ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­ í˜ì´ì§€
app.get('/sms/sender/request', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­ - SMS ì‹œìŠ¤í…œ</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-5xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-3">
                        <a href="/dashboard" class="text-lg font-bold text-gray-900">â† ëŒ€ì‹œë³´ë“œ</a>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/sms/senders" class="text-gray-600 hover:text-purple-600 transition">ë°œì‹ ë²ˆí˜¸ ê´€ë¦¬</a>
                        <span id="userName" class="text-gray-700 font-medium"></span>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-3xl mx-auto">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ“± ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­</h1>
                    <p class="text-gray-600">ì‚¬ì—…ì ë“±ë¡ì¦ì„ ì—…ë¡œë“œí•˜ê³  ë°œì‹ ë²ˆí˜¸ë¥¼ ë“±ë¡í•˜ì„¸ìš”</p>
                </div>

                <!-- ì•ˆë‚´ ì‚¬í•­ -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8">
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-blue-600 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-sm text-blue-800">
                            <p class="font-bold mb-3">ğŸ“‹ í•„ìš” ì„œë¥˜ ë° ì ˆì°¨</p>
                            <ul class="space-y-2 list-disc list-inside ml-2">
                                <li><strong>ì‚¬ì—…ì ë“±ë¡ì¦</strong> (í•„ìˆ˜)</li>
                                <li><strong>í†µì‹ ì‚¬ ê°€ì…ì¦ëª…ì›</strong> (í•„ìˆ˜)
                                    <ul class="ml-6 mt-1 text-xs space-y-1">
                                        <li>âœ“ ë°œê¸‰ì¼ì: ìµœê·¼ 1ê°œì›” ì´ë‚´</li>
                                        <li>âœ“ ê°€ì…ì ì •ë³´(ê°€ì…ë²ˆí˜¸, ê°€ì…ìëª…, ê°œí†µì¼ì, ë°œê¸‰ì¼ì) ëª¨ë‘ ê¸°ì¬</li>
                                        <li>âœ“ ë°œì‹ ë²ˆí˜¸ê°€ 010-1234-5678 í˜•ì‹ìœ¼ë¡œ ëª…í™•íˆ í‘œì‹œ</li>
                                        <li>âœ“ ê°€ë ¤ì§„ ì •ë³´ ì—†ì´, ì˜ë¦° ë¶€ë¶„ ì—†ì´ ì²¨ë¶€</li>
                                    </ul>
                                </li>
                                <li><strong>ëŒ€í‘œì ì‹ ë¶„ì¦</strong> ë˜ëŠ” <strong>ì¬ì§ì ì‹ ë¶„ì¦ + ì¬ì§ì¦ëª…ì„œ</strong> (í•„ìˆ˜)
                                    <ul class="ml-6 mt-1 text-xs space-y-1">
                                        <li>âœ“ ì£¼ë¯¼ë²ˆí˜¸ ë’·ìë¦¬, ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹ í•„ìˆ˜</li>
                                        <li>âœ“ ì¬ì§ì¦ëª…ì„œ: ë„ì¥ ë‚ ì¸ í•„ìˆ˜</li>
                                    </ul>
                                </li>
                                <li><strong>ë¬¸ìë©”ì‹œì§€ ì´ìš©ê³„ì•½ì„œ</strong> (í•„ìˆ˜, ë„ì¥ ë‚ ì¸ í•„ìˆ˜)</li>
                                <li>íŒŒì¼ í˜•ì‹: JPG, PNG, PDF, DOC, DOCX (ê° íŒŒì¼ ìµœëŒ€ 5MB)</li>
                                <li>ìŠ¹ì¸ ì†Œìš”: í‰ì¼ ì—…ë¬´ì‹œê°„(10ì‹œ~17ì‹œ) ë‚´ í‰ê·  1~3ì‹œê°„ ì†Œìš”</li>
                                <li class="text-red-700 font-bold">âš ï¸ ëª¨ë“  ì„œë¥˜ëŠ” ì ‘ìˆ˜ì¼ ê¸°ì¤€ ìµœê·¼ 1ê°œì›” ì´ë‚´ë§Œ ì¸ì •</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- ì„œë¥˜ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ -->
                <div class="bg-green-50 border border-green-200 rounded-xl p-6 mb-8">
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-green-600 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        <div class="text-sm text-green-800">
                            <p class="font-bold mb-3">ğŸ“¥ ì„œë¥˜ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</p>
                            <div class="flex flex-wrap gap-3">
                                <a href="/downloads/ë°œì‹ ë²ˆí˜¸_ì‚¬ì „ë“±ë¡_ëŒ€ë¦¬_ì‹ ì²­ì„œ.docx" download class="px-4 py-2 bg-white border border-green-300 rounded-lg hover:bg-green-100 transition font-medium">
                                    ğŸ“„ ë°œì‹ ë²ˆí˜¸ ì‚¬ì „ë“±ë¡ ëŒ€ë¦¬ ì‹ ì²­ì„œ
                                </a>
                                <a href="/downloads/ë¬¸ìë©”ì‹œì§€_ì´ìš©ê³„ì•½ì„œ.docx" download class="px-4 py-2 bg-white border border-green-300 rounded-lg hover:bg-green-100 transition font-medium">
                                    ğŸ“„ ë¬¸ìë©”ì‹œì§€ ì´ìš©ê³„ì•½ì„œ
                                </a>
                                <a href="/api/downloads/employment-cert" download class="px-4 py-2 bg-white border border-green-300 rounded-lg hover:bg-green-100 transition font-medium">
                                    ğŸ“„ ì¬ì§ì¦ëª…ì„œ ì–‘ì‹
                                </a>
                            </div>
                            <p class="mt-3 text-xs text-green-700">ğŸ’¡ ë„ì¥(ì§ì¸)ì€ ì‹¸ì¸ì´ ì•ˆë˜ë©° ë°˜ë“œì‹œ ë„ì¥ìœ¼ë¡œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>

                <!-- ì‹ ì²­ í¼ -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-8">
                    <form id="verificationForm" class="space-y-6">
                        <!-- ì‚¬ì—…ì ì •ë³´ -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">ì‚¬ì—…ì²´ëª… *</label>
                            <input type="text" id="businessName" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="ì˜ˆ: ê¾¸ë©”ë•…í•™ì›">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸ *</label>
                            <input type="text" id="businessRegistrationNumber" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="123-45-67890"
                                   maxlength="12">
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">ë°œì‹ ë²ˆí˜¸ (íœ´ëŒ€í°) *</label>
                            <input type="text" id="phoneNumber" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="010-1234-5678"
                                   maxlength="13">
                            <p class="text-xs text-gray-500 mt-1">í•˜ì´í”ˆ(-)ì„ í¬í•¨í•˜ì—¬ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                        </div>

                        <!-- 1. ì‚¬ì—…ì ë“±ë¡ì¦ ì—…ë¡œë“œ -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">1. ì‚¬ì—…ì ë“±ë¡ì¦ * <span class="text-red-600">(í•„ìˆ˜)</span></label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-500 transition cursor-pointer upload-area"
                                 data-target="businessRegistrationImage">
                                <input type="file" id="businessRegistrationImage" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="hidden" required>
                                <div class="upload-placeholder">
                                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-gray-600 font-medium mb-1">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                                    <p class="text-sm text-gray-500">JPG, PNG, PDF, DOC, DOCX (ìµœëŒ€ 5MB)</p>
                                </div>
                                <div class="upload-preview hidden">
                                    <img class="preview-image max-w-full max-h-64 mx-auto rounded-lg mb-3">
                                    <p class="file-name text-sm text-gray-600 font-medium"></p>
                                    <button type="button" class="reset-upload text-sm text-red-600 hover:text-red-700 mt-2">
                                        ë‹¤ì‹œ ì„ íƒ
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 2. í†µì‹ ì‚¬ ê°€ì…ì¦ëª…ì› ì—…ë¡œë“œ -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">2. í†µì‹ ì‚¬ ê°€ì…ì¦ëª…ì› * <span class="text-red-600">(í•„ìˆ˜)</span></label>
                            <p class="text-xs text-gray-500 mb-2">ë°œì‹ ë²ˆí˜¸ê°€ ëª…í™•íˆ í‘œì‹œë˜ì–´ì•¼ í•©ë‹ˆë‹¤ (010-1234-5678 í˜•ì‹, ê°€ë¦¼ ì—†ì´)</p>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-500 transition cursor-pointer upload-area"
                                 data-target="certificateImage">
                                <input type="file" id="certificateImage" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="hidden" required>
                                <div class="upload-placeholder">
                                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-gray-600 font-medium mb-1">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                                    <p class="text-sm text-gray-500">JPG, PNG, PDF, DOC, DOCX (ìµœëŒ€ 5MB)</p>
                                </div>
                                <div class="upload-preview hidden">
                                    <img class="preview-image max-w-full max-h-64 mx-auto rounded-lg mb-3">
                                    <p class="file-name text-sm text-gray-600 font-medium"></p>
                                    <button type="button" class="reset-upload text-sm text-red-600 hover:text-red-700 mt-2">
                                        ë‹¤ì‹œ ì„ íƒ
                                    </button>
                                </div>
                            </div>
                            <p class="text-xs text-blue-600 mt-2">ğŸ’¡ í†µì‹ ì‚¬ 114 ë¬¸ì˜ ì‹œ: "ê³ ê° ì‘ëŒ€ìš© ë¬¸ì ë°œì‹ ë“±ë¡ìš©"ì´ë¼ê³  ë‹µë³€í•˜ì„¸ìš”</p>
                        </div>
                        
                        <!-- 3. ì¬ì§ì¦ëª…ì„œ ì—…ë¡œë“œ -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">3. ì¬ì§ì¦ëª…ì„œ * <span class="text-red-600">(í•„ìˆ˜, ë„ì¥ ë‚ ì¸ í•„ìˆ˜)</span></label>
                            <p class="text-xs text-gray-500 mb-2">ì‚¬ì—…ì ëŒ€í‘œë„ ë³¸ì¸ì˜ ì¬ì§ì¦ëª…ì„œ ì œì¶œ í•„ìš”</p>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-500 transition cursor-pointer upload-area"
                                 data-target="employmentCertImage">
                                <input type="file" id="employmentCertImage" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="hidden" required>
                                <div class="upload-placeholder">
                                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-gray-600 font-medium mb-1">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                                    <p class="text-sm text-gray-500">JPG, PNG, PDF, DOC, DOCX (ìµœëŒ€ 5MB)</p>
                                </div>
                                <div class="upload-preview hidden">
                                    <img class="preview-image max-w-full max-h-64 mx-auto rounded-lg mb-3">
                                    <p class="file-name text-sm text-gray-600 font-medium"></p>
                                    <button type="button" class="reset-upload text-sm text-red-600 hover:text-red-700 mt-2">
                                        ë‹¤ì‹œ ì„ íƒ
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 4. ë¬¸ìë©”ì‹œì§€ ì´ìš©ê³„ì•½ì„œ ì—…ë¡œë“œ -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">4. ë¬¸ìë©”ì‹œì§€ ì´ìš©ê³„ì•½ì„œ * <span class="text-red-600">(í•„ìˆ˜, ë„ì¥ ë‚ ì¸ í•„ìˆ˜)</span></label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-500 transition cursor-pointer upload-area"
                                 data-target="contractImage">
                                <input type="file" id="contractImage" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document" class="hidden" required>
                                <div class="upload-placeholder">
                                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-gray-600 font-medium mb-1">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                                    <p class="text-sm text-gray-500">JPG, PNG, PDF, DOC, DOCX (ìµœëŒ€ 5MB)</p>
                                </div>
                                <div class="upload-preview hidden">
                                    <img class="preview-image max-w-full max-h-64 mx-auto rounded-lg mb-3">
                                    <p class="file-name text-sm text-gray-600 font-medium"></p>
                                    <button type="button" class="reset-upload text-sm text-red-600 hover:text-red-700 mt-2">
                                        ë‹¤ì‹œ ì„ íƒ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- ì œì¶œ ë²„íŠ¼ -->
                        <div class="flex gap-4 pt-4">
                            <button type="button" onclick="history.back()"
                                    class="flex-1 px-6 py-3 border border-gray-300 rounded-lg text-gray-700 font-bold hover:bg-gray-50 transition">
                                ì·¨ì†Œ
                            </button>
                            <button type="submit" id="submitButton"
                                    class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg font-bold hover:from-purple-700 hover:to-purple-800 transition shadow-md hover:shadow-lg">
                                ì‹ ì²­í•˜ê¸°
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ì‹ ì²­ ë‚´ì—­ -->
                <div class="mt-8 bg-white rounded-xl shadow-lg border border-gray-200 p-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">ğŸ“‹ ì‹ ì²­ ë‚´ì—­</h2>
                    <div id="requestsList" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p>ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const user = JSON.parse(localStorage.getItem('user'))
            if (!user) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.')
                window.location.href = '/login'
            }
            document.getElementById('userName').textContent = user.name

            // ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸ ìë™ í•˜ì´í”ˆ ì¶”ê°€
            document.getElementById('businessRegistrationNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '')
                if (value.length > 3 && value.length <= 5) {
                    value = value.slice(0, 3) + '-' + value.slice(3)
                } else if (value.length > 5) {
                    value = value.slice(0, 3) + '-' + value.slice(3, 5) + '-' + value.slice(5, 10)
                }
                e.target.value = value
            })

            // ì „í™”ë²ˆí˜¸ ìë™ í•˜ì´í”ˆ ì¶”ê°€
            document.getElementById('phoneNumber').addEventListener('input', function(e) {
                let value = e.target.value.replace(/[^0-9]/g, '')
                if (value.length > 3 && value.length <= 7) {
                    value = value.slice(0, 3) + '-' + value.slice(3)
                } else if (value.length > 7) {
                    value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11)
                }
                e.target.value = value
            })

            // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ (4ê°œ íŒŒì¼)
            document.querySelectorAll('.upload-area').forEach(uploadArea => {
                const inputId = uploadArea.dataset.target
                const fileInput = document.getElementById(inputId)
                const placeholder = uploadArea.querySelector('.upload-placeholder')
                const preview = uploadArea.querySelector('.upload-preview')
                const previewImage = preview.querySelector('.preview-image')
                const fileNameEl = preview.querySelector('.file-name')
                const resetBtn = preview.querySelector('.reset-upload')

                uploadArea.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('reset-upload')) {
                        fileInput.click()
                    }
                })
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault()
                    uploadArea.classList.add('border-purple-500', 'bg-purple-50')
                })

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('border-purple-500', 'bg-purple-50')
                })

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault()
                    uploadArea.classList.remove('border-purple-500', 'bg-purple-50')
                    const file = e.dataTransfer.files[0]
                    if (file && (
                        file.type.startsWith('image/') || 
                        file.type === 'application/pdf' ||
                        file.type === 'application/msword' ||
                        file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                    )) {
                        handleFileUpload(file, fileInput, placeholder, preview, previewImage, fileNameEl)
                    } else if (file) {
                        alert('JPG, PNG, PDF, DOC, DOCX íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.')
                    }
                })

                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0]
                    if (file) {
                        handleFileUpload(file, fileInput, placeholder, preview, previewImage, fileNameEl)
                    }
                })

                resetBtn.addEventListener('click', (e) => {
                    e.stopPropagation()
                    fileInput.value = ''
                    placeholder.classList.remove('hidden')
                    preview.classList.add('hidden')
                    previewImage.src = ''
                    fileNameEl.textContent = ''
                })
            })

            function handleFileUpload(file, fileInput, placeholder, preview, previewImage, fileNameEl) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.')
                    return
                }

                // íŒŒì¼ íƒ€ì… ê²€ì¦
                const allowedTypes = [
                    'image/jpeg', 
                    'image/jpg', 
                    'image/png', 
                    'application/pdf',
                    'application/msword', // .doc
                    'application/vnd.openxmlformats-officedocument.wordprocessingml.document' // .docx
                ]
                if (!allowedTypes.includes(file.type)) {
                    alert('JPG, PNG, PDF, DOC, DOCX íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.')
                    return
                }

                const reader = new FileReader()
                reader.onload = (e) => {
                    // PDFì™€ Word íŒŒì¼ì€ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ëŒ€ì‹  íŒŒì¼ëª…ë§Œ í‘œì‹œ
                    if (file.type === 'application/pdf') {
                        previewImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjQwIiBmaWxsPSIjZWY0NDQ0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+UERGPC90ZXh0Pjwvc3ZnPg=='
                        previewImage.classList.add('max-h-32')
                    } else if (file.type === 'application/msword' || file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        previewImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjM1IiBmaWxsPSIjMjk2N2FhIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+RE9DPC90ZXh0Pjwvc3ZnPg=='
                        previewImage.classList.add('max-h-32')
                    } else {
                        previewImage.src = e.target.result
                        previewImage.classList.remove('max-h-32')
                    }
                    fileNameEl.textContent = file.name
                    placeholder.classList.add('hidden')
                    preview.classList.remove('hidden')
                }
                reader.readAsDataURL(file)
            }

            // R2 ì—…ë¡œë“œ í•¨ìˆ˜ (imgbb ëŒ€ì²´)
            async function uploadToR2(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader()
                    reader.onload = async (e) => {
                        try {
                            const response = await fetch('/api/upload/document', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    userId: user.id,
                                    fileName: file.name,
                                    fileData: e.target.result,
                                    fileType: file.type
                                })
                            })
                            
                            const data = await response.json()
                            if (data.success) {
                                resolve(data.url)
                            } else {
                                reject(new Error(data.error || 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨'))
                            }
                        } catch (err) {
                            reject(err)
                        }
                    }
                    reader.onerror = () => reject(new Error('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨'))
                    reader.readAsDataURL(file)
                })
            }

            // í¼ ì œì¶œ
            document.getElementById('verificationForm').addEventListener('submit', async function(e) {
                e.preventDefault()
                
                const submitButton = document.getElementById('submitButton')
                submitButton.disabled = true
                submitButton.textContent = 'ì—…ë¡œë“œ ì¤‘... (ìµœëŒ€ 4ë¶„ ì†Œìš”)'

                try {
                    const businessName = document.getElementById('businessName').value
                    const businessRegistrationNumber = document.getElementById('businessRegistrationNumber').value
                    const phoneNumber = document.getElementById('phoneNumber').value
                    
                    // 4ê°œ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
                    const businessRegFile = document.getElementById('businessRegistrationImage').files[0]
                    const certificateFile = document.getElementById('certificateImage').files[0]
                    const employmentFile = document.getElementById('employmentCertImage').files[0]
                    const contractFile = document.getElementById('contractImage').files[0]

                    if (!businessRegFile || !certificateFile || !employmentFile || !contractFile) {
                        alert('ëª¨ë“  ì„œë¥˜ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.')
                        submitButton.disabled = false
                        submitButton.textContent = 'ì‹ ì²­í•˜ê¸°'
                        return
                    }

                    // ìˆœì°¨ì ìœ¼ë¡œ ì´ë¯¸ì§€ ì—…ë¡œë“œ (R2 ì‚¬ìš©)
                    submitButton.textContent = 'ì—…ë¡œë“œ ì¤‘... (1/4)'
                    const businessRegUrl = await uploadToR2(businessRegFile)
                    
                    submitButton.textContent = 'ì—…ë¡œë“œ ì¤‘... (2/4)'
                    const certificateUrl = await uploadToR2(certificateFile)
                    
                    submitButton.textContent = 'ì—…ë¡œë“œ ì¤‘... (3/4)'
                    const employmentUrl = await uploadToR2(employmentFile)
                    
                    submitButton.textContent = 'ì—…ë¡œë“œ ì¤‘... (4/4)'
                    const contractUrl = await uploadToR2(contractFile)

                    submitButton.textContent = 'ì‹ ì²­ ì¤‘...'

                    // ì‹ ì²­ API í˜¸ì¶œ
                    const response = await fetch('/api/sms/sender/verification-request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: user.id,
                            phoneNumber,
                            businessName,
                            businessRegistrationNumber,
                            businessRegistrationImage: businessRegUrl,
                            certificateImage: certificateUrl,
                            employmentCertImage: employmentUrl,
                            contractImage: contractUrl
                        })
                    })

                    const data = await response.json()

                    console.log('API Response:', data) // ë””ë²„ê¹…ìš©

                    if (data.success) {
                        alert('âœ… ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. (í‰ì¼ ê¸°ì¤€ 2~3ì¼ ì†Œìš”)')
                        document.getElementById('verificationForm').reset()
                        // ëª¨ë“  í”„ë¦¬ë·° ì´ˆê¸°í™”
                        document.querySelectorAll('.upload-preview').forEach(p => p.classList.add('hidden'))
                        document.querySelectorAll('.upload-placeholder').forEach(p => p.classList.remove('hidden'))
                        loadRequests()
                    } else {
                        console.error('API Error:', data.error)
                        alert('âŒ ì‹ ì²­ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'))
                    }
                } catch (err) {
                    console.error('Submission error:', err)
                    alert('âŒ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message)
                } finally {
                    submitButton.disabled = false
                    submitButton.textContent = 'ì‹ ì²­í•˜ê¸°'
                }
            })

            // ì‹ ì²­ ë‚´ì—­ ë¡œë“œ
            async function loadRequests() {
                try {
                    const response = await fetch('/api/sms/sender/verification-requests?userId=' + user.id)
                    const data = await response.json()

                    const container = document.getElementById('requestsList')
                    
                    if (data.success && data.requests.length > 0) {
                        container.innerHTML = data.requests.map(req => {
                            const statusColor = req.status === 'pending' ? 'yellow' : req.status === 'approved' ? 'green' : 'red'
                            const statusText = req.status === 'pending' ? 'ìŠ¹ì¸ ëŒ€ê¸°' : req.status === 'approved' ? 'ìŠ¹ì¸ ì™„ë£Œ' : 'ê±°ì ˆë¨'
                            
                            return \`
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <p class="font-bold text-gray-900">\${req.business_name}</p>
                                            <p class="text-sm text-gray-600">\${req.phone_number}</p>
                                        </div>
                                        <span class="px-3 py-1 bg-\${statusColor}-100 text-\${statusColor}-700 text-sm font-medium rounded-full">
                                            \${statusText}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <p>ì‚¬ì—…ìë²ˆí˜¸: \${req.business_registration_number}</p>
                                        <p>ì‹ ì²­ì¼: \${new Date(req.request_date).toLocaleString('ko-KR')}</p>
                                        \${req.admin_note ? '<p class="text-red-600">ê´€ë¦¬ì ë©”ëª¨: ' + req.admin_note + '</p>' : ''}
                                    </div>
                                    <a href="\${req.business_registration_image}" target="_blank" 
                                       class="inline-block mt-3 text-sm text-purple-600 hover:text-purple-700 font-medium">
                                        ì‚¬ì—…ì ë“±ë¡ì¦ ë³´ê¸° â†’
                                    </a>
                                </div>
                            \`
                        }).join('')
                    } else {
                        container.innerHTML = \`
                            <div class="text-center text-gray-500 py-8">
                                <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p>ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            </div>
                        \`
                    }
                } catch (err) {
                    console.error('Load requests error:', err)
                }
            }

            loadRequests()
        </script>
    </body>
    </html>
  `)
})

// ë¬¸ì ì‘ì„± í˜ì´ì§€
app.get('/sms/compose', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¬¸ì ì‘ì„± - SMS ë°œì†¡</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-8">
                        <a href="/dashboard" class="text-xl font-bold text-purple-600">SMS ë°œì†¡ ì‹œìŠ¤í…œ</a>
                        <div class="flex space-x-4">
                            <a href="/sms/senders" class="text-gray-600 hover:text-purple-600 px-3 py-2">ë°œì‹ ë²ˆí˜¸</a>
                            <a href="/sms/compose" class="text-purple-600 border-b-2 border-purple-600 px-3 py-2 font-medium">ë¬¸ì ì‘ì„±</a>
                            <a href="/sms/logs" class="text-gray-600 hover:text-purple-600 px-3 py-2">ë°œì†¡ ë‚´ì—­</a>
                            <a href="/sms/points" class="text-gray-600 hover:text-purple-600 px-3 py-2">í¬ì¸íŠ¸ ê´€ë¦¬</a>
                        </div>
                    </div>
                    <a href="/dashboard" class="text-gray-600 hover:text-purple-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-6xl mx-auto">
                <!-- Header -->
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">âœ‰ï¸ ë¬¸ì ì‘ì„±</h1>
                    <p class="text-gray-600">ë¬¸ì ë©”ì‹œì§€ë¥¼ ì‘ì„±í•˜ê³  ë°œì†¡í•©ë‹ˆë‹¤</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- ì™¼ìª½: ë¬¸ì ì‘ì„± -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- ë°œì‹ ë²ˆí˜¸ ì„ íƒ -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <label class="block text-sm font-semibold text-gray-900 mb-3">ë°œì‹ ë²ˆí˜¸</label>
                            <select id="senderId" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">ë°œì‹ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>

                        <!-- í…œí”Œë¦¿ ê´€ë¦¬ -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-semibold text-gray-900">ğŸ“ í…œí”Œë¦¿ ê´€ë¦¬</h3>
                                <div class="flex gap-2">
                                    <button onclick="openFolderModal()" class="text-xs px-3 py-1.5 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                                        + í´ë”
                                    </button>
                                    <button onclick="saveTemplate()" class="text-xs px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition">
                                        ğŸ’¾ ì €ì¥
                                    </button>
                                </div>
                            </div>
                            
                            <!-- í´ë” íƒ­ -->
                            <div class="flex gap-2 mb-3 overflow-x-auto pb-2" id="folderTabs">
                                <button onclick="selectFolder(null)" class="folder-tab active px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap bg-purple-100 text-purple-700">
                                    ì „ì²´
                                </button>
                            </div>
                            
                            <!-- í…œí”Œë¦¿ ëª©ë¡ -->
                            <div id="templateList" class="space-y-2 max-h-40 overflow-y-auto">
                                <p class="text-xs text-gray-400 text-center py-3">í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            </div>
                        </div>

                        <!-- ë©”ì‹œì§€ ì‘ì„± -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-3">
                                <label class="block text-sm font-semibold text-gray-900">ë©”ì‹œì§€ ë‚´ìš©</label>
                                <div class="flex items-center space-x-2">
                                    <span id="byteCount" class="text-sm font-medium text-gray-600">0</span>
                                    <span class="text-sm text-gray-400">/ 2000 ë°”ì´íŠ¸</span>
                                </div>
                            </div>
                            
                            <!-- ì¹˜í™˜ ë³€ìˆ˜ ë²„íŠ¼ë“¤ -->
                            <div class="flex flex-wrap gap-2 mb-3">
                                <button onclick="insertVariable('#{ì´ë¦„}')" class="text-xs px-3 py-1.5 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg transition">
                                    + #{ì´ë¦„}
                                </button>
                                <button onclick="insertVariable('#{ì „í™”ë²ˆí˜¸}')" class="text-xs px-3 py-1.5 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg transition">
                                    + #{ì „í™”ë²ˆí˜¸}
                                </button>
                                <button onclick="insertVariable('#{í•™ë…„}')" class="text-xs px-3 py-1.5 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg transition">
                                    + #{í•™ë…„}
                                </button>
                                <button onclick="insertVariable('#{ë°˜}')" class="text-xs px-3 py-1.5 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg transition">
                                    + #{ë°˜}
                                </button>
                            </div>
                            
                            <textarea id="message" rows="10" 
                                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”&#10;&#10;ì¹˜í™˜ ë³€ìˆ˜ ì‚¬ìš© ì˜ˆì‹œ:&#10;ì•ˆë…•í•˜ì„¸ìš” #{ì´ë¦„} í•™ë¶€ëª¨ë‹˜!&#10;ê¾¸ë©”ë•…í•™ì›ì…ë‹ˆë‹¤."
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 resize-none"></textarea>
                            <div class="flex items-center justify-between mt-3">
                                <span id="messageType" class="text-sm font-medium px-3 py-1 bg-blue-100 text-blue-800 rounded-full">SMS (ë‹¨ë¬¸)</span>
                                <p class="text-xs text-gray-500">90ë°”ì´íŠ¸ ì´ˆê³¼ ì‹œ LMS(ì¥ë¬¸)ë¡œ ìë™ ì „í™˜</p>
                            </div>
                        </div>

                        <!-- ì˜ˆì•½ ë°œì†¡ -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <label class="flex items-center space-x-3 mb-4">
                                <input type="checkbox" id="reserveEnabled" class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                                <span class="text-sm font-semibold text-gray-900">ì˜ˆì•½ ë°œì†¡</span>
                            </label>
                            <input type="datetime-local" id="reserveTime" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 disabled:bg-gray-100 disabled:text-gray-400" 
                                disabled>
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½: ìˆ˜ì‹ ì ê´€ë¦¬ -->
                    <div class="space-y-6">
                        <!-- ìˆ˜ì‹ ì ì¶”ê°€ -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <h3 class="text-sm font-semibold text-gray-900 mb-4">ìˆ˜ì‹ ì ì¶”ê°€</h3>
                            <div class="space-y-3 mb-4">
                                <input type="text" id="receiverName" placeholder="ì´ë¦„" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <input type="text" id="receiverPhone" placeholder="010-1234-5678" 
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                            <button onclick="addReceiver()" 
                                class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition font-medium">
                                + ìˆ˜ì‹ ì ì¶”ê°€
                            </button>
                        </div>

                        <!-- ì—‘ì…€ ì—…ë¡œë“œ -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <h3 class="text-sm font-semibold text-gray-900 mb-4">ì—‘ì…€ ì—…ë¡œë“œ</h3>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-500 transition cursor-pointer" 
                                onclick="document.getElementById('excelFile').click()">
                                <svg class="w-12 h-12 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <p class="text-sm text-gray-600">í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>
                                <p class="text-xs text-gray-400 mt-1">ì´ë¦„, ì „í™”ë²ˆí˜¸ ì»¬ëŸ¼ í•„ìˆ˜</p>
                            </div>
                            <input type="file" id="excelFile" accept=".xlsx,.xls" class="hidden" onchange="uploadExcel(event)">
                        </div>

                        <!-- ìˆ˜ì‹ ì ëª©ë¡ -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-sm font-semibold text-gray-900">ìˆ˜ì‹ ì ëª©ë¡</h3>
                                <span id="receiverCount" class="text-sm font-medium text-purple-600">0ëª…</span>
                            </div>
                            
                            <!-- ê²€ìƒ‰ ì…ë ¥ -->
                            <div class="mb-3">
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        id="receiverSearch" 
                                        placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..." 
                                        oninput="filterReceivers()"
                                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                                    >
                                    <svg class="w-5 h-5 absolute left-3 top-2.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                    </svg>
                                </div>
                            </div>
                            
                            <div id="receiversContainer" class="space-y-2 max-h-64 overflow-y-auto">
                                <p class="text-sm text-gray-400 text-center py-4">ìˆ˜ì‹ ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>
                            </div>
                            <button onclick="clearReceivers()" 
                                class="w-full mt-4 border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition text-sm">
                                ì „ì²´ ì‚­ì œ
                            </button>
                        </div>

                        <!-- ë°œì†¡ ë¹„ìš© -->
                        <div class="bg-purple-50 rounded-lg p-6">
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ìˆ˜ì‹ ì ìˆ˜</span>
                                    <span id="costReceivers" class="font-medium">0ëª…</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ê±´ë‹¹ ìš”ê¸ˆ</span>
                                    <span id="costPerMessage" class="font-medium">20P</span>
                                </div>
                                <div class="border-t border-purple-200 pt-2 mt-2">
                                    <div class="flex justify-between">
                                        <span class="font-semibold text-gray-900">ì´ ë¹„ìš©</span>
                                        <span id="totalCost" class="font-bold text-purple-600 text-lg">0P</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ë°œì†¡ ë²„íŠ¼ -->
                        <button onclick="sendSMS()" 
                            class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white px-6 py-4 rounded-lg hover:from-purple-700 hover:to-purple-800 transition font-semibold text-lg shadow-lg">
                            ğŸ“¤ ë¬¸ì ë°œì†¡í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let currentUserId = null;
            let receivers = [];
            let sendersList = [];
            let folders = [];
            let templates = [];
            let currentFolderId = null;

            // ì‚¬ìš©ì ì¸ì¦
            async function checkAuth() {
                const user = localStorage.getItem('user');
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return null;
                }
                const userData = JSON.parse(user);
                currentUserId = userData.id;
                return userData;
            }

            // ë°œì‹ ë²ˆí˜¸ ëª©ë¡ ë¡œë“œ
            async function loadSenders() {
                try {
                    const response = await fetch(\`/api/sms/senders?userId=\${currentUserId}\`);
                    const data = await response.json();

                    const select = document.getElementById('senderId');
                    
                    if (data.success && data.senders.length > 0) {
                        sendersList = data.senders;
                        select.innerHTML = '<option value="">ë°œì‹ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>' + 
                            data.senders.map(s => \`<option value="\${s.id}">\${formatPhoneNumber(s.phone_number)}</option>\`).join('');
                    } else {
                        select.innerHTML = '<option value="">ë“±ë¡ëœ ë°œì‹ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
                        alert('ë°œì‹ ë²ˆí˜¸ë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.');
                        window.location.href = '/sms/senders';
                    }
                } catch (err) {
                    console.error('Failed to load senders:', err);
                }
            }

            // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
            function formatPhoneNumber(phone) {
                phone = phone.replace(/[^0-9]/g, '');
                if (phone.length === 10) {
                    return phone.replace(/(\\d{3})(\\d{3})(\\d{4})/, '$1-$2-$3');
                } else if (phone.length === 11) {
                    return phone.replace(/(\\d{3})(\\d{4})(\\d{4})/, '$1-$2-$3');
                }
                return phone;
            }

            // ë°”ì´íŠ¸ ìˆ˜ ê³„ì‚°
            function calculateBytes(str) {
                return new Blob([str]).size;
            }

            // ë©”ì‹œì§€ ì…ë ¥ ì´ë²¤íŠ¸
            document.getElementById('message').addEventListener('input', (e) => {
                const message = e.target.value;
                const byteSize = calculateBytes(message);
                
                document.getElementById('byteCount').textContent = byteSize;
                
                const messageTypeEl = document.getElementById('messageType');
                const costPerMessageEl = document.getElementById('costPerMessage');
                
                if (byteSize > 90) {
                    messageTypeEl.textContent = 'LMS (ì¥ë¬¸)';
                    messageTypeEl.className = 'text-sm font-medium px-3 py-1 bg-orange-100 text-orange-800 rounded-full';
                    costPerMessageEl.textContent = '50P';
                } else {
                    messageTypeEl.textContent = 'SMS (ë‹¨ë¬¸)';
                    messageTypeEl.className = 'text-sm font-medium px-3 py-1 bg-blue-100 text-blue-800 rounded-full';
                    costPerMessageEl.textContent = '20P';
                }
                
                updateCost();
            });

            // ì˜ˆì•½ ë°œì†¡ ì²´í¬ë°•ìŠ¤
            document.getElementById('reserveEnabled').addEventListener('change', (e) => {
                document.getElementById('reserveTime').disabled = !e.target.checked;
            });

            // ìˆ˜ì‹ ì ì¶”ê°€
            function addReceiver() {
                const name = document.getElementById('receiverName').value.trim();
                const phone = document.getElementById('receiverPhone').value.trim().replace(/[^0-9]/g, '');
                
                if (!name || !phone) {
                    alert('ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                if (phone.length < 10) {
                    alert('ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                receivers.push({ name, phone });
                
                document.getElementById('receiverName').value = '';
                document.getElementById('receiverPhone').value = '';
                
                renderReceivers();
            }

            // ìˆ˜ì‹ ì ëª©ë¡ ë Œë”ë§
            function renderReceivers(filteredList = null) {
                const container = document.getElementById('receiversContainer');
                const list = filteredList !== null ? filteredList : receivers;
                
                if (list.length === 0) {
                    if (filteredList !== null && receivers.length > 0) {
                        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</p>';
                    } else {
                        container.innerHTML = '<p class="text-sm text-gray-400 text-center py-4">ìˆ˜ì‹ ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>';
                    }
                } else {
                    container.innerHTML = list.map((r, i) => {
                        // ì‹¤ì œ ì¸ë±ìŠ¤ ì°¾ê¸° (ê²€ìƒ‰ ì‹œ)
                        const actualIndex = filteredList !== null ? receivers.indexOf(r) : i;
                        return \`
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <div class="font-medium text-sm">\${r.name}</div>
                                <div class="text-xs text-gray-500">\${formatPhoneNumber(r.phone)}</div>
                            </div>
                            <button onclick="removeReceiver(\${actualIndex})" class="text-red-600 hover:text-red-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    \`;
                    }).join('');
                }
                
                document.getElementById('receiverCount').textContent = receivers.length + 'ëª…';
                updateCost();
            }

            // ìˆ˜ì‹ ì ê²€ìƒ‰ í•„í„°ë§
            function filterReceivers() {
                const searchTerm = document.getElementById('receiverSearch').value.toLowerCase().trim();
                
                if (!searchTerm) {
                    renderReceivers();
                    return;
                }
                
                const filtered = receivers.filter(r => {
                    const name = r.name.toLowerCase();
                    const phone = r.phone;
                    return name.includes(searchTerm) || phone.includes(searchTerm);
                });
                
                renderReceivers(filtered);
            }

            // ìˆ˜ì‹ ì ì œê±°
            function removeReceiver(index) {
                receivers.splice(index, 1);
                renderReceivers();
            }

            // ì „ì²´ ì‚­ì œ
            function clearReceivers() {
                if (receivers.length === 0) return;
                if (confirm('ëª¨ë“  ìˆ˜ì‹ ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    receivers = [];
                    renderReceivers();
                }
            }

            // ì—‘ì…€ ì—…ë¡œë“œ
            async function uploadExcel(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Aì—´ê³¼ Bì—´ë§Œ ì½ê¸° (í—¤ë” ë¬´ì‹œ)
                    const range = XLSX.utils.decode_range(firstSheet['!ref']);
                    console.log('Excel range:', firstSheet['!ref']);
                    
                    let addedCount = 0;
                    let duplicateCount = 0;
                    const tempReceivers = [];
                    
                    // 2í–‰ë¶€í„° ì½ê¸° (1í–‰ì€ í—¤ë”)
                    for (let rowNum = range.s.r + 1; rowNum <= range.e.r; rowNum++) {
                        // Aì—´: ì´ë¦„
                        const nameCell = firstSheet[XLSX.utils.encode_cell({ r: rowNum, c: 0 })];
                        const name = nameCell ? String(nameCell.v).trim() : '';
                        
                        // Bì—´: ì—°ë½ì²˜
                        const phoneCell = firstSheet[XLSX.utils.encode_cell({ r: rowNum, c: 1 })];
                        const phoneRaw = phoneCell ? String(phoneCell.v) : '';
                        const phone = phoneRaw.replace(/[^0-9]/g, '');
                        
                        console.log(\`Row \${rowNum + 1}:\`, { name, phone, phoneLength: phone.length });
                        
                        // ì´ë¦„ê³¼ ì „í™”ë²ˆí˜¸ ëª¨ë‘ ìˆê³ , ì „í™”ë²ˆí˜¸ê°€ 10ìë¦¬ ì´ìƒ
                        if (name && phone && phone.length >= 10) {
                            // ê¸°ì¡´ ìˆ˜ì‹ ì ëª©ë¡ì— ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
                            const existsInCurrent = receivers.some(r => r.phone === phone);
                            // ì„ì‹œ ëª©ë¡ì— ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸ (ì—‘ì…€ ë‚´ ì¤‘ë³µ)
                            const existsInTemp = tempReceivers.some(r => r.phone === phone);
                            
                            if (!existsInCurrent && !existsInTemp) {
                                tempReceivers.push({ name, phone });
                                addedCount++;
                            } else {
                                duplicateCount++;
                                console.log('ì¤‘ë³µ ì œì™¸:', { name, phone });
                            }
                        }
                    }
                    
                    // ì¤‘ë³µ ì œê±°ëœ ìˆ˜ì‹ ìë“¤ ì¶”ê°€
                    receivers.push(...tempReceivers);

                    if (addedCount === 0 && duplicateCount === 0) {
                        alert('âŒ ì—‘ì…€ íŒŒì¼ì—ì„œ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\\n\\ní˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”:\\n- Aì—´: ì´ë¦„\\n- Bì—´: ì—°ë½ì²˜ (01012345678 í˜•ì‹)\\n- 1í–‰: í—¤ë” (ìë™ ê±´ë„ˆëœ€)\\n\\në¸Œë¼ìš°ì € ì½˜ì†”(F12)ì—ì„œ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                    } else {
                        let message = \`âœ… \${addedCount}ëª…ì˜ ìˆ˜ì‹ ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\`;
                        if (duplicateCount > 0) {
                            message += \`\\n\\nâš ï¸ ì¤‘ë³µëœ \${duplicateCount}ëª…ì€ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.\`;
                        }
                        alert(message);
                    }
                    
                    renderReceivers();
                    updateCost();
                } catch (err) {
                    console.error('Excel upload error:', err);
                    alert('ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\\n' + err.message);
                }
                
                event.target.value = '';
            }

            // ë¹„ìš© ê³„ì‚°
            function updateCost() {
                const byteSize = calculateBytes(document.getElementById('message').value);
                const costPerMessage = byteSize > 90 ? 50 : 20;
                const totalCost = costPerMessage * receivers.length;
                
                document.getElementById('costReceivers').textContent = receivers.length + 'ëª…';
                document.getElementById('totalCost').textContent = totalCost + 'P';
            }

            // SMS ë°œì†¡
            async function sendSMS() {
                const senderId = document.getElementById('senderId').value;
                const message = document.getElementById('message').value.trim();
                const reserveEnabled = document.getElementById('reserveEnabled').checked;
                const reserveTime = document.getElementById('reserveTime').value;

                if (!senderId) {
                    alert('ë°œì‹ ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!message) {
                    alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (receivers.length === 0) {
                    alert('ìˆ˜ì‹ ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (reserveEnabled && !reserveTime) {
                    alert('ì˜ˆì•½ ë°œì†¡ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!confirm(\`\${receivers.length}ëª…ì—ê²Œ ë¬¸ìë¥¼ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) {
                    return;
                }

                try {
                    const payload = {
                        userId: currentUserId,
                        senderId: parseInt(senderId),
                        receivers: receivers,
                        message: message
                    };

                    if (reserveEnabled && reserveTime) {
                        payload.reserveTime = reserveTime;
                    }

                    const response = await fetch('/api/sms/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert(\`âœ… ë¬¸ì ë°œì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\në°œì†¡ ê±´ìˆ˜: \${data.sentCount}ê±´\\nì°¨ê° í¬ì¸íŠ¸: \${data.totalCost}P\\në‚¨ì€ í¬ì¸íŠ¸: \${data.remainingBalance}P\`);
                        
                        // ì´ˆê¸°í™”
                        document.getElementById('message').value = '';
                        receivers = [];
                        renderReceivers();
                        
                        // ë°œì†¡ ë‚´ì—­ìœ¼ë¡œ ì´ë™
                        if (confirm('ë°œì†¡ ë‚´ì—­ì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            window.location.href = '/sms/logs';
                        }
                    } else {
                        alert('âŒ ' + data.error);
                    }
                } catch (err) {
                    console.error('Send SMS error:', err);
                    alert('ë¬¸ì ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // === í…œí”Œë¦¿ & í´ë” ê´€ë¦¬ í•¨ìˆ˜ ===
            
            // ì¹˜í™˜ ë³€ìˆ˜ ì‚½ì…
            function insertVariable(variable) {
                const messageBox = document.getElementById('message');
                const start = messageBox.selectionStart;
                const end = messageBox.selectionEnd;
                const text = messageBox.value;
                messageBox.value = text.substring(0, start) + variable + text.substring(end);
                messageBox.focus();
                messageBox.setSelectionRange(start + variable.length, start + variable.length);
                updateByteCount();
            }

            // í´ë” ëª©ë¡ ë¡œë“œ
            async function loadFolders() {
                try {
                    const response = await fetch(\`/api/sms/folders?userId=\${currentUserId}\`);
                    const data = await response.json();
                    
                    if (data.success) {
                        folders = data.folders;
                        renderFolderTabs();
                    }
                } catch (err) {
                    console.error('Failed to load folders:', err);
                }
            }

            // í´ë” íƒ­ ë Œë”ë§
            function renderFolderTabs() {
                const container = document.getElementById('folderTabs');
                const tabs = \`
                    <button onclick="selectFolder(null)" class="folder-tab \${!currentFolderId ? 'active' : ''} px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap \${!currentFolderId ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                        ì „ì²´
                    </button>
                    \${folders.map(folder => \`
                        <div class="relative inline-block group">
                            <button onclick="selectFolder(\${folder.id})" class="folder-tab \${currentFolderId === folder.id ? 'active' : ''} px-3 py-1.5 rounded-lg text-xs font-medium whitespace-nowrap \${currentFolderId === folder.id ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                                ğŸ“ \${folder.name}
                            </button>
                            <button 
                                onclick="event.stopPropagation(); deleteFolder(\${folder.id}, '\${folder.name}')" 
                                class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-xs hover:bg-red-600"
                                title="í´ë” ì‚­ì œ"
                            >
                                Ã—
                            </button>
                        </div>
                    \`).join('')}
                \`;
                container.innerHTML = tabs;
            }

            // í´ë” ì„ íƒ
            async function selectFolder(folderId) {
                currentFolderId = folderId;
                await loadTemplates();
                renderFolderTabs();
            }

            // í…œí”Œë¦¿ ëª©ë¡ ë¡œë“œ
            async function loadTemplates() {
                try {
                    let url = \`/api/sms/templates?userId=\${currentUserId}\`;
                    if (currentFolderId) {
                        url += \`&folderId=\${currentFolderId}\`;
                    }
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.success) {
                        templates = data.templates;
                        renderTemplates();
                    }
                } catch (err) {
                    console.error('Failed to load templates:', err);
                }
            }

            // í…œí”Œë¦¿ ëª©ë¡ ë Œë”ë§
            function renderTemplates() {
                const container = document.getElementById('templateList');
                
                if (templates.length === 0) {
                    container.innerHTML = '<p class="text-xs text-gray-400 text-center py-3">í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                    return;
                }
                
                container.innerHTML = templates.map(template => \`
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                        <button onclick="loadTemplateMessage(\${template.id})" class="flex-1 text-left text-xs font-medium text-gray-700 truncate">
                            \${template.title}
                        </button>
                        <button onclick="deleteTemplate(\${template.id})" class="ml-2 text-red-500 hover:text-red-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                \`).join('');
            }

            // í…œí”Œë¦¿ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
            function loadTemplateMessage(templateId) {
                const template = templates.find(t => t.id === templateId);
                if (template) {
                    // ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
                    document.getElementById('message').value = template.message;
                    updateByteCount();
                    
                    // ìˆ˜ì‹ ì ë¶ˆëŸ¬ì˜¤ê¸°
                    if (template.receivers) {
                        try {
                            const savedReceivers = JSON.parse(template.receivers);
                            receivers = savedReceivers;
                            renderReceivers();
                            updateCost();
                            alert(\`âœ… í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!\\në©”ì‹œì§€ + ìˆ˜ì‹ ì \${receivers.length}ëª…\`);
                        } catch (err) {
                            console.error('Failed to parse receivers:', err);
                        }
                    }
                }
            }

            // í…œí”Œë¦¿ ì €ì¥
            async function saveTemplate() {
                const message = document.getElementById('message').value.trim();
                if (!message) {
                    alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                const title = prompt('í…œí”Œë¦¿ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:', message.substring(0, 20) + '...');
                if (!title) return;
                
                try {
                    const response = await fetch('/api/sms/templates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: currentUserId,
                            folderId: currentFolderId,
                            title,
                            message,
                            receivers: JSON.stringify(receivers) // ìˆ˜ì‹ ì ì •ë³´ë„ ì €ì¥
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert(\`âœ… í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!\\nìˆ˜ì‹ ì: \${receivers.length}ëª…\`);
                        await loadTemplates();
                    } else {
                        alert('âŒ ' + data.error);
                    }
                } catch (err) {
                    console.error('Save template error:', err);
                    alert('í…œí”Œë¦¿ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // í…œí”Œë¦¿ ì‚­ì œ
            async function deleteTemplate(templateId) {
                if (!confirm('ì´ í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                
                try {
                    const response = await fetch(\`/api/sms/templates/\${templateId}?userId=\${currentUserId}\`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('âœ… í…œí”Œë¦¿ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        await loadTemplates();
                    } else {
                        alert('âŒ ' + data.error);
                    }
                } catch (err) {
                    console.error('Delete template error:', err);
                    alert('í…œí”Œë¦¿ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // í´ë” ìƒì„± ëª¨ë‹¬
            function openFolderModal() {
                const name = prompt('í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ì¤‘ë“± í•™ë¶€ëª¨');
                if (!name) return;
                createFolder(name);
            }

            // í´ë” ìƒì„±
            async function createFolder(name) {
                try {
                    const response = await fetch('/api/sms/folders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: currentUserId,
                            name
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('âœ… í´ë”ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        await loadFolders();
                        await loadTemplates();
                    } else {
                        alert('âŒ ' + data.error);
                    }
                } catch (err) {
                    console.error('Create folder error:', err);
                    alert('í´ë” ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // í´ë” ì‚­ì œ
            async function deleteFolder(folderId, folderName) {
                if (!confirm(\`"\${folderName}" í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ í´ë” ì•ˆì˜ ëª¨ë“  í…œí”Œë¦¿ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.\`)) {
                    return;
                }
                
                try {
                    const response = await fetch(\`/api/sms/folders/\${folderId}?userId=\${currentUserId}\`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('âœ… í´ë”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        
                        // ì‚­ì œëœ í´ë”ê°€ í˜„ì¬ ì„ íƒëœ í´ë”ì˜€ë‹¤ë©´ ì „ì²´ë¡œ ì´ë™
                        if (currentFolderId === folderId) {
                            currentFolderId = null;
                        }
                        
                        await loadFolders();
                        await loadTemplates();
                    } else {
                        alert('âŒ ' + data.error);
                    }
                } catch (err) {
                    console.error('Delete folder error:', err);
                    alert('í´ë” ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // í˜ì´ì§€ ë¡œë“œ
            (async () => {
                await checkAuth();
                if (currentUserId) {
                    await loadSenders();
                    await loadFolders();
                    await loadTemplates();
                }
            })();
        </script>
    </body>
    </html>
  `)
})

// ë°œì†¡ ë‚´ì—­ í˜ì´ì§€
app.get('/sms/logs', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë°œì†¡ ë‚´ì—­ - SMS ë°œì†¡</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-8">
                        <a href="/dashboard" class="text-xl font-bold text-purple-600">SMS ë°œì†¡ ì‹œìŠ¤í…œ</a>
                        <div class="flex space-x-4">
                            <a href="/sms/senders" class="text-gray-600 hover:text-purple-600 px-3 py-2">ë°œì‹ ë²ˆí˜¸</a>
                            <a href="/sms/compose" class="text-gray-600 hover:text-purple-600 px-3 py-2">ë¬¸ì ì‘ì„±</a>
                            <a href="/sms/logs" class="text-purple-600 border-b-2 border-purple-600 px-3 py-2 font-medium">ë°œì†¡ ë‚´ì—­</a>
                            <a href="/sms/points" class="text-gray-600 hover:text-purple-600 px-3 py-2">í¬ì¸íŠ¸ ê´€ë¦¬</a>
                        </div>
                    </div>
                    <a href="/dashboard" class="text-gray-600 hover:text-purple-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ“Š ë°œì†¡ ë‚´ì—­</h1>
                    <p class="text-gray-600">ë¬¸ì ë°œì†¡ ë‚´ì—­ì„ í™•ì¸í•©ë‹ˆë‹¤</p>
                </div>

                <!-- í•„í„° -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìƒíƒœ</label>
                            <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">ì „ì²´</option>
                                <option value="success">ì„±ê³µ</option>
                                <option value="failed">ì‹¤íŒ¨</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë©”ì‹œì§€ íƒ€ì…</label>
                            <select id="typeFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">ì „ì²´</option>
                                <option value="SMS">SMS (ë‹¨ë¬¸)</option>
                                <option value="LMS">LMS (ì¥ë¬¸)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í˜ì´ì§€ë‹¹ ê°œìˆ˜</label>
                            <select id="limitFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="20">20ê°œ</option>
                                <option value="50">50ê°œ</option>
                                <option value="100">100ê°œ</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="applyFilters()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition font-medium">
                                ê²€ìƒ‰
                            </button>
                        </div>
                    </div>
                </div>

                <!-- í†µê³„ ì¹´ë“œ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ì´ ë°œì†¡</p>
                                <p id="totalSent" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ì„±ê³µ</p>
                                <p id="totalSuccess" class="text-2xl font-bold text-green-600">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ì‹¤íŒ¨</p>
                                <p id="totalFailed" class="text-2xl font-bold text-red-600">0</p>
                            </div>
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600 mb-1">ì´ ë¹„ìš©</p>
                                <p id="totalCost" class="text-2xl font-bold text-purple-600">0P</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ë°œì†¡ ë‚´ì—­ í…Œì´ë¸” -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-semibold text-gray-900">ë°œì†¡ ë‚´ì—­</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë°œì†¡ ì¼ì‹œ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë°œì‹ ë²ˆí˜¸</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìˆ˜ì‹ ì</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">íƒ€ì…</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìƒíƒœ</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ë¹„ìš©</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìƒì„¸</th>
                                </tr>
                            </thead>
                            <tbody id="logsContainer" class="divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-6 py-12 text-center">
                                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"></div>
                                        <p class="text-gray-500">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                    <div class="p-6 border-t border-gray-200">
                        <div class="flex items-center justify-between">
                            <p id="paginationInfo" class="text-sm text-gray-600">ì´ 0ê±´</p>
                            <div class="flex space-x-2" id="paginationButtons">
                                <!-- ë™ì  ìƒì„± -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìƒì„¸ ëª¨ë‹¬ -->
        <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-6">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-gray-900">ë°œì†¡ ìƒì„¸</h3>
                        <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="detailContent" class="p-6">
                    <!-- ë™ì  ìƒì„± -->
                </div>
            </div>
        </div>

        <script>
            let currentUserId = null;
            let currentPage = 1;
            let currentLimit = 20;

            async function checkAuth() {
                const user = localStorage.getItem('user');
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return null;
                }
                const userData = JSON.parse(user);
                currentUserId = userData.id;
                return userData;
            }

            function formatPhoneNumber(phone) {
                phone = phone.replace(/[^0-9]/g, '');
                if (phone.length === 10) {
                    return phone.replace(/(\\d{3})(\\d{3})(\\d{4})/, '$1-$2-$3');
                } else if (phone.length === 11) {
                    return phone.replace(/(\\d{3})(\\d{4})(\\d{4})/, '$1-$2-$3');
                }
                return phone;
            }

            function formatDateTime(dateStr) {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return date.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            async function loadLogs(page = 1) {
                currentPage = page;
                const limit = parseInt(document.getElementById('limitFilter').value);
                currentLimit = limit;

                try {
                    const response = await fetch(\`/api/sms/logs?userId=\${currentUserId}&page=\${page}&limit=\${limit}\`);
                    const data = await response.json();

                    if (data.success) {
                        renderLogs(data.logs);
                        renderPagination(data.pagination);
                        updateStats(data.logs);
                    }
                } catch (err) {
                    console.error('Failed to load logs:', err);
                }
            }

            function renderLogs(logs) {
                const container = document.getElementById('logsContainer');

                if (logs.length === 0) {
                    container.innerHTML = \`
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center">
                                <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                </svg>
                                <p class="text-gray-500">ë°œì†¡ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            </td>
                        </tr>
                    \`;
                    return;
                }

                container.innerHTML = logs.map(log => \`
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-900">\${formatDateTime(log.sent_at || log.created_at)}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">\${formatPhoneNumber(log.sender_number)}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">\${log.receiver_number.split(',').length}ëª…</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full \${log.message_type === 'SMS' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}">
                                \${log.message_type}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-medium rounded-full \${log.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                \${log.status === 'success' ? 'âœ“ ì„±ê³µ' : 'âœ— ì‹¤íŒ¨'}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">\${log.point_cost}P</td>
                        <td class="px-6 py-4">
                            <button onclick='showDetail(\${JSON.stringify(log).replace(/'/g, "\\\\'")})'
                                class="text-purple-600 hover:text-purple-700 text-sm font-medium">
                                ë³´ê¸°
                            </button>
                        </td>
                    </tr>
                \`).join('');
            }

            function renderPagination(pagination) {
                const info = document.getElementById('paginationInfo');
                const buttons = document.getElementById('paginationButtons');

                info.textContent = \`ì´ \${pagination.total}ê±´ (í˜ì´ì§€ \${pagination.page}/\${pagination.totalPages})\`;

                let html = '';
                
                if (pagination.page > 1) {
                    html += \`<button onclick="loadLogs(\${pagination.page - 1})" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50">ì´ì „</button>\`;
                }

                for (let i = 1; i <= Math.min(pagination.totalPages, 5); i++) {
                    const active = i === pagination.page ? 'bg-purple-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-50';
                    html += \`<button onclick="loadLogs(\${i})" class="px-3 py-1 border border-gray-300 rounded \${active}">\${i}</button>\`;
                }

                if (pagination.page < pagination.totalPages) {
                    html += \`<button onclick="loadLogs(\${pagination.page + 1})" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50">ë‹¤ìŒ</button>\`;
                }

                buttons.innerHTML = html;
            }

            function updateStats(logs) {
                const totalSent = logs.length;
                const totalSuccess = logs.filter(l => l.status === 'success').length;
                const totalFailed = logs.filter(l => l.status === 'failed').length;
                const totalCost = logs.reduce((sum, l) => sum + (l.point_cost || 0), 0);

                document.getElementById('totalSent').textContent = totalSent;
                document.getElementById('totalSuccess').textContent = totalSuccess;
                document.getElementById('totalFailed').textContent = totalFailed;
                document.getElementById('totalCost').textContent = totalCost + 'P';
            }

            function showDetail(log) {
                const modal = document.getElementById('detailModal');
                const content = document.getElementById('detailContent');

                content.innerHTML = \`
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">ë°œì†¡ ì •ë³´</h4>
                            <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ë°œì‹ ë²ˆí˜¸</span>
                                    <span class="font-medium">\${formatPhoneNumber(log.sender_number)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ìˆ˜ì‹ ì</span>
                                    <span class="font-medium">\${log.receiver_number.split(',').length}ëª…</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ë°œì†¡ ì¼ì‹œ</span>
                                    <span class="font-medium">\${formatDateTime(log.sent_at || log.created_at)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ë©”ì‹œì§€ íƒ€ì…</span>
                                    <span class="font-medium">\${log.message_type}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ìƒíƒœ</span>
                                    <span class="font-medium">\${log.status === 'success' ? 'âœ“ ì„±ê³µ' : 'âœ— ì‹¤íŒ¨'}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">ë¹„ìš©</span>
                                    <span class="font-medium">\${log.point_cost}P</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">ë©”ì‹œì§€ ë‚´ìš©</h4>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-900 whitespace-pre-wrap">\${log.message_content}</p>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">ìˆ˜ì‹ ì ëª©ë¡</h4>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="space-y-1 text-sm text-gray-900">
                                    \${log.receiver_number.split(',').map(phone => \`
                                        <div>\${formatPhoneNumber(phone)}</div>
                                    \`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                \`;

                modal.classList.remove('hidden');
            }

            function closeDetailModal() {
                document.getElementById('detailModal').classList.add('hidden');
            }

            function applyFilters() {
                loadLogs(1);
            }

            (async () => {
                await checkAuth();
                if (currentUserId) {
                    loadLogs(1);
                }
            })();
        </script>
    </body>
    </html>
  `)
})

// í¬ì¸íŠ¸ ê´€ë¦¬ í˜ì´ì§€
app.get('/sms/points', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í¬ì¸íŠ¸ ê´€ë¦¬ - SMS ë°œì†¡</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * {
            font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
          }
          .tab-active {
            border-bottom: 2px solid #9333ea;
            color: #9333ea;
            font-weight: 600;
          }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-8">
                        <a href="/dashboard" class="text-xl font-bold text-purple-600">SMS ë°œì†¡ ì‹œìŠ¤í…œ</a>
                        <div class="flex space-x-4">
                            <a href="/sms/senders" class="text-gray-600 hover:text-purple-600 px-3 py-2">ë°œì‹ ë²ˆí˜¸</a>
                            <a href="/sms/compose" class="text-gray-600 hover:text-purple-600 px-3 py-2">ë¬¸ì ì‘ì„±</a>
                            <a href="/sms/logs" class="text-gray-600 hover:text-purple-600 px-3 py-2">ë°œì†¡ ë‚´ì—­</a>
                            <a href="/sms/points" class="text-purple-600 border-b-2 border-purple-600 px-3 py-2 font-medium">í¬ì¸íŠ¸ ê´€ë¦¬</a>
                        </div>
                    </div>
                    <a href="/dashboard" class="text-gray-600 hover:text-purple-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-7xl mx-auto">
                <!-- Header -->
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ’° í¬ì¸íŠ¸ ê´€ë¦¬</h1>
                    <p class="text-gray-600">SMS ë°œì†¡ í¬ì¸íŠ¸ë¥¼ ê´€ë¦¬í•˜ê³  ê±°ë˜ ë‚´ì—­ì„ í™•ì¸í•©ë‹ˆë‹¤</p>
                </div>

                <!-- í˜„ì¬ ì”ì•¡ ì¹´ë“œ -->
                <div class="bg-gradient-to-br from-purple-600 to-purple-800 rounded-lg shadow-lg p-8 text-white mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-medium opacity-90">ë³´ìœ  í¬ì¸íŠ¸</h2>
                        <svg class="w-8 h-8 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p id="currentBalance" class="text-5xl font-bold mb-2">0</p>
                            <p class="text-lg opacity-90">í¬ì¸íŠ¸</p>
                        </div>
                        <div class="text-right space-y-2">
                            <div class="flex items-center gap-3">
                                <span class="text-sm opacity-75">SMS</span>
                                <span id="smsCount" class="text-xl font-bold">0ê±´</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm opacity-75">LMS</span>
                                <span id="lmsCount" class="text-xl font-bold">0ê±´</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm opacity-75">MMS</span>
                                <span id="mmsCount" class="text-xl font-bold">0ê±´</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- í†µê³„ -->
                    <div class="grid grid-cols-3 gap-4 pt-6 mt-6 border-t border-white/20">
                        <div>
                            <p class="text-xs opacity-75 mb-1">ì´ ì¶©ì „</p>
                            <p id="totalCharged" class="text-lg font-semibold">0P</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-75 mb-1">ì´ ì‚¬ìš©</p>
                            <p id="totalUsed" class="text-lg font-semibold">0P</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-75 mb-1">ê±°ë˜ ê±´ìˆ˜</p>
                            <p id="totalTransactions" class="text-lg font-semibold">0ê±´</p>
                        </div>
                    </div>
                </div>

                <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
                    <div class="flex border-b border-gray-200">
                        <button onclick="switchTab('charge')" id="tab-charge" class="tab-active flex-1 px-6 py-4 text-center transition">
                            ğŸ’³ ì¶©ì „í•˜ê¸°
                        </button>
                        <button onclick="switchTab('deposit')" id="tab-deposit" class="flex-1 px-6 py-4 text-center text-gray-600 hover:text-purple-600 transition">
                            ğŸ“‹ ì¶©ì „ ë‚´ì—­
                        </button>
                        <button onclick="switchTab('transactions')" id="tab-transactions" class="flex-1 px-6 py-4 text-center text-gray-600 hover:text-purple-600 transition">
                            ğŸ“Š ì‚¬ìš© ë‚´ì—­
                        </button>
                        <button onclick="switchTab('pricing')" id="tab-pricing" class="flex-1 px-6 py-4 text-center text-gray-600 hover:text-purple-600 transition">
                            ğŸ’µ ìš”ê¸ˆí‘œ
                        </button>
                    </div>

                    <!-- ì¶©ì „í•˜ê¸° íƒ­ -->
                    <div id="content-charge" class="p-6">
                        <div class="max-w-2xl mx-auto space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì¶©ì „ ê¸ˆì•¡</label>
                                <div class="relative">
                                    <input type="number" id="depositAmount" placeholder="10000" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 pr-12">
                                    <span class="absolute right-4 top-3 text-gray-500">ì›</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="setAmount(10000)" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-purple-50 hover:border-purple-500 text-sm transition">+1ë§Œ</button>
                                <button onclick="setAmount(50000)" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-purple-50 hover:border-purple-500 text-sm transition">+5ë§Œ</button>
                                <button onclick="setAmount(100000)" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-purple-50 hover:border-purple-500 text-sm transition">+10ë§Œ</button>
                                <button onclick="setAmount(500000)" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-purple-50 hover:border-purple-500 text-sm transition">+50ë§Œ</button>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì€í–‰ëª… (ì„ íƒ)</label>
                                <input type="text" id="bankName" placeholder="ì‹ í•œì€í–‰" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ê³„ì¢Œë²ˆí˜¸ (ì„ íƒ)</label>
                                <input type="text" id="accountNumber" placeholder="110-123-456789" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ì…ê¸ˆìëª… (ì„ íƒ)</label>
                                <input type="text" id="depositorName" placeholder="í™ê¸¸ë™" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ë©”ëª¨ (ì„ íƒ)</label>
                                <textarea id="depositMessage" rows="3" placeholder="ì…ê¸ˆ ê´€ë ¨ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                            </div>
                            
                            <!-- ì…ê¸ˆ ì•ˆë‚´ -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <h4 class="font-semibold text-blue-900 mb-2">ğŸ’¡ ì…ê¸ˆ ì•ˆë‚´</h4>
                                <p class="text-sm text-blue-800 mb-2">ì•„ë˜ ê³„ì¢Œë¡œ ì…ê¸ˆ í›„ ì‹ ì²­í•´ì£¼ì„¸ìš”:</p>
                                <div class="bg-white rounded p-3 font-mono text-sm">
                                    <p class="font-bold text-gray-900">êµ­ë¯¼ì€í–‰ 746-910023-17004</p>
                                    <p class="text-gray-600">ì˜ˆê¸ˆì£¼: ìŠˆí¼í”Œë ˆì´ìŠ¤</p>
                                </div>
                                <p class="text-xs text-blue-600 mt-2">â€¢ ìµœì†Œ ì¶©ì „ ê¸ˆì•¡: 10,000ì›<br>â€¢ ê´€ë¦¬ì ìŠ¹ì¸ í›„ í¬ì¸íŠ¸ê°€ ìë™ ì¶©ì „ë©ë‹ˆë‹¤</p>
                            </div>
                            
                            <button onclick="requestDeposit()" 
                                class="w-full bg-purple-600 text-white px-6 py-4 rounded-lg hover:bg-purple-700 transition font-semibold text-lg">
                                ì…ê¸ˆ ì‹ ì²­í•˜ê¸°
                            </button>
                        </div>
                    </div>

                    <!-- ì¶©ì „ ë‚´ì—­ íƒ­ -->
                    <div id="content-deposit" class="p-6 hidden">
                        <div id="depositsContainer" class="space-y-3">
                            <p class="text-sm text-gray-400 text-center py-8">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>

                    <!-- ì‚¬ìš© ë‚´ì—­ íƒ­ -->
                    <div id="content-transactions" class="p-6 hidden">
                        <div id="transactionsContainer" class="space-y-3">
                            <p class="text-sm text-gray-400 text-center py-8">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                    </div>

                    <!-- ìš”ê¸ˆí‘œ íƒ­ -->
                    <div id="content-pricing" class="p-6 hidden">
                        <div id="pricingContainer" class="max-w-2xl mx-auto space-y-3">
                            <div class="animate-pulse">
                                <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                                <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let currentUserId = null;
            let currentUserName = '';
            let currentUserEmail = '';
            let currentBalance = 0;
            let currentTab = 'charge';

            async function checkAuth() {
                const user = localStorage.getItem('user');
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return null;
                }
                const userData = JSON.parse(user);
                currentUserId = userData.id;
                currentUserName = userData.name || '';
                currentUserEmail = userData.email || '';
                currentBalance = userData.points || 0;
                return userData;
            }

            function switchTab(tab) {
                // ëª¨ë“  íƒ­ ë²„íŠ¼ì˜ active í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                    btn.classList.remove('tab-active');
                    btn.classList.add('text-gray-600');
                });
                
                // ëª¨ë“  íƒ­ ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
                document.querySelectorAll('[id^="content-"]').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // ì„ íƒëœ íƒ­ í™œì„±í™”
                document.getElementById('tab-' + tab).classList.add('tab-active');
                document.getElementById('tab-' + tab).classList.remove('text-gray-600');
                document.getElementById('content-' + tab).classList.remove('hidden');
                
                currentTab = tab;
                
                // ë°ì´í„° ë¡œë“œ
                if (tab === 'deposit' && currentUserId) {
                    loadDepositRequests();
                } else if (tab === 'transactions' && currentUserId) {
                    loadTransactions();
                } else if (tab === 'pricing') {
                    loadPricing();
                }
            }

            async function loadBalance() {
                try {
                    const response = await fetch(\`/api/users/\${currentUserId}/points\`);
                    const data = await response.json();

                    if (data.success) {
                        currentBalance = data.points || 0;
                        document.getElementById('currentBalance').textContent = currentBalance.toLocaleString();
                        
                        // ë°œì†¡ ê°€ëŠ¥ ê±´ìˆ˜ ê³„ì‚°
                        document.getElementById('smsCount').textContent = Math.floor(currentBalance / 20) + 'ê±´';
                        document.getElementById('lmsCount').textContent = Math.floor(currentBalance / 50) + 'ê±´';
                        document.getElementById('mmsCount').textContent = Math.floor(currentBalance / 150) + 'ê±´';
                    }
                } catch (err) {
                    console.error('Failed to load balance:', err);
                }
            }

            async function loadStats() {
                try {
                    const response = await fetch(\`/api/point-transactions/\${currentUserId}?limit=1000\`);
                    const data = await response.json();

                    if (data.success && data.stats) {
                        document.getElementById('totalCharged').textContent = data.stats.totalCharged.toLocaleString() + 'P';
                        document.getElementById('totalUsed').textContent = data.stats.totalUsed.toLocaleString() + 'P';
                        document.getElementById('totalTransactions').textContent = data.stats.totalTransactions.toLocaleString() + 'ê±´';
                    }
                } catch (err) {
                    console.error('Failed to load stats:', err);
                }
            }

            async function loadPricing() {
                try {
                    const response = await fetch('/api/sms/pricing');
                    const data = await response.json();

                    if (data.success) {
                        const container = document.getElementById('pricingContainer');
                        container.innerHTML = data.pricing.map(p => \`
                            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div>
                                    <div class="font-semibold text-gray-900">\${p.message_type}</div>
                                    <div class="text-sm text-gray-500 mt-1">\${p.description}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-purple-600">\${p.retail_price}P</div>
                                    <div class="text-xs text-gray-400">ê±´ë‹¹</div>
                                </div>
                            </div>
                        \`).join('');
                    }
                } catch (err) {
                    console.error('Failed to load pricing:', err);
                }
            }

            async function loadDepositRequests() {
                try {
                    const response = await fetch(\`/api/deposit/my-requests/\${currentUserId}\`);
                    const data = await response.json();

                    const container = document.getElementById('depositsContainer');
                    
                    if (data.success && data.requests && data.requests.length > 0) {
                        container.innerHTML = data.requests.map(req => \`
                            <div class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xl font-bold text-gray-900">\${req.amount.toLocaleString()}ì›</span>
                                    <span class="text-xs px-3 py-1 rounded-full font-semibold \${
                                        req.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                        req.status === 'approved' ? 'bg-green-100 text-green-800' :
                                        'bg-red-100 text-red-800'
                                    }">
                                        \${req.status === 'pending' ? 'ëŒ€ê¸°ì¤‘' : req.status === 'approved' ? 'ìŠ¹ì¸ì™„ë£Œ' : 'ê±°ì ˆë¨'}
                                    </span>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                                    \${req.bank_name ? \`<div>â€¢ ì€í–‰: \${req.bank_name}</div>\` : ''}
                                    \${req.depositor_name ? \`<div>â€¢ ì…ê¸ˆì: \${req.depositor_name}</div>\` : ''}
                                </div>
                                <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200">
                                    <span class="text-xs text-gray-500">ì‹ ì²­ì¼: \${new Date(req.created_at).toLocaleString('ko-KR')}</span>
                                    \${req.processed_at ? \`<span class="text-xs text-gray-500">ì²˜ë¦¬ì¼: \${new Date(req.processed_at).toLocaleString('ko-KR')}</span>\` : ''}
                                </div>
                                \${req.message ? \`<div class="mt-2 text-sm text-gray-600 italic">\${req.message}</div>\` : ''}
                            </div>
                        \`).join('');
                    } else {
                        container.innerHTML = '<div class="text-center py-12"><p class="text-gray-400">ì…ê¸ˆ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p><p class="text-sm text-gray-400 mt-2">ì¶©ì „í•˜ê¸° íƒ­ì—ì„œ ì…ê¸ˆì„ ì‹ ì²­í•´ë³´ì„¸ìš”</p></div>';
                    }
                } catch (err) {
                    console.error('Failed to load deposit requests:', err);
                    document.getElementById('depositsContainer').innerHTML = '<p class="text-sm text-red-500 text-center py-8">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>';
                }
            }

            async function loadTransactions() {
                try {
                    const response = await fetch(\`/api/point-transactions/\${currentUserId}?limit=50\`);
                    const data = await response.json();

                    const container = document.getElementById('transactionsContainer');
                    
                    if (data.success && data.transactions && data.transactions.length > 0) {
                        container.innerHTML = data.transactions.map(tx => {
                            const isPositive = tx.amount > 0;
                            const typeLabels = {
                                'deposit': 'ì…ê¸ˆ ìŠ¹ì¸',
                                'charge': 'ê´€ë¦¬ì ì¶©ì „',
                                'sms_cost': 'SMS ë°œì†¡',
                                'refund': 'í™˜ë¶ˆ'
                            };
                            const typeLabel = typeLabels[tx.transaction_type] || tx.transaction_type;
                            
                            return \`
                            <div class="p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-2xl">\${isPositive ? 'ğŸ“¥' : 'ğŸ“¤'}</span>
                                        <div>
                                            <div class="font-semibold text-gray-900">\${typeLabel}</div>
                                            <div class="text-xs text-gray-500">\${new Date(tx.created_at).toLocaleString('ko-KR')}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-bold \${isPositive ? 'text-green-600' : 'text-red-600'}">
                                            \${isPositive ? '+' : ''}\${tx.amount.toLocaleString()}P
                                        </div>
                                        <div class="text-xs text-gray-500">ì”ì•¡: \${tx.balance_after.toLocaleString()}P</div>
                                    </div>
                                </div>
                                \${tx.description ? \`<div class="text-sm text-gray-600 mt-2">\${tx.description}</div>\` : ''}
                            </div>
                        \`}).join('');
                    } else {
                        container.innerHTML = '<div class="text-center py-12"><p class="text-gray-400">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p><p class="text-sm text-gray-400 mt-2">ì¶©ì „ ë˜ëŠ” SMS ë°œì†¡ í›„ ë‚´ì—­ì´ í‘œì‹œë©ë‹ˆë‹¤</p></div>';
                    }
                } catch (err) {
                    console.error('Failed to load transactions:', err);
                    document.getElementById('transactionsContainer').innerHTML = '<p class="text-sm text-red-500 text-center py-8">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</p>';
                }
            }

            function setAmount(amount) {
                const input = document.getElementById('depositAmount');
                const current = parseInt(input.value) || 0;
                input.value = current + amount;
            }

            async function requestDeposit() {
                const amount = parseInt(document.getElementById('depositAmount').value);
                const bankName = document.getElementById('bankName').value.trim();
                const accountNumber = document.getElementById('accountNumber').value.trim();
                const depositorName = document.getElementById('depositorName').value.trim();
                const message = document.getElementById('depositMessage').value.trim();

                if (!amount || amount <= 0) {
                    alert('ì¶©ì „ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (amount < 10000) {
                    alert('ìµœì†Œ ì¶©ì „ ê¸ˆì•¡ì€ 10,000ì›ì…ë‹ˆë‹¤.');
                    return;
                }

                if (!confirm(\`\${amount.toLocaleString()}ì›ì„ ì¶©ì „ ì‹ ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) {
                    return;
                }

                try {
                    const response = await fetch('/api/deposit/request', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: currentUserId,
                            userName: currentUserName,
                            userEmail: currentUserEmail,
                            amount: amount,
                            bankName: bankName,
                            accountNumber: accountNumber,
                            depositorName: depositorName,
                            message: message
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('âœ… ì…ê¸ˆ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\nê´€ë¦¬ì ìŠ¹ì¸ í›„ í¬ì¸íŠ¸ê°€ ì¶©ì „ë©ë‹ˆë‹¤.');
                        
                        // í¼ ì´ˆê¸°í™”
                        document.getElementById('depositAmount').value = '';
                        document.getElementById('bankName').value = '';
                        document.getElementById('accountNumber').value = '';
                        document.getElementById('depositorName').value = '';
                        document.getElementById('depositMessage').value = '';
                        
                        // ì¶©ì „ ë‚´ì—­ íƒ­ìœ¼ë¡œ ì „í™˜
                        switchTab('deposit');
                    } else {
                        alert('âŒ ' + data.error);
                    }
                } catch (err) {
                    console.error('Deposit request error:', err);
                    alert('ì…ê¸ˆ ì‹ ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            (async () => {
                await checkAuth();
                if (currentUserId) {
                    loadBalance();
                    loadStats();
                }
            })();
        </script>
    </body>
    </html>
  `)
})

// ê´€ë¦¬ì - ë°œì‹ ë²ˆí˜¸ ìŠ¹ì¸ í˜ì´ì§€
// ê´€ë¦¬ì ë¬¸ì ê´€ë¦¬ í˜ì´ì§€
app.get('/admin/sms', async (c) => {
  const { env } = c
  
  // SMS í†µê³„ ì¡°íšŒ
  const smsStats = await env.DB.prepare(`
    SELECT 
      COUNT(*) as total,
      SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) as success,
      SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed
    FROM sms_logs
  `).all()
  
  // ì¹´ì¹´ì˜¤ í†µê³„ ì¡°íšŒ
  const kakaoStats = await env.DB.prepare(`
    SELECT 
      COUNT(*) as total,
      SUM(CASE WHEN status = 'success' THEN 1 ELSE 0 END) as success,
      SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed
    FROM kakao_logs
  `).all()
  
  // ìµœê·¼ ë°œì†¡ ë‚´ì—­ (SMS + ì¹´ì¹´ì˜¤ í†µí•©)
  const recentSMS = await env.DB.prepare(`
    SELECT 
      id, user_id, sender_id, message_type, 
      status, created_at
    FROM sms_logs 
    ORDER BY created_at DESC 
    LIMIT 10
  `).all()
  
  const recentKakao = await env.DB.prepare(`
    SELECT 
      id, user_id, sender_key, template_code, 
      status, created_at
    FROM kakao_logs 
    ORDER BY created_at DESC 
    LIMIT 10
  `).all()
  
  const sms = smsStats.results[0] || { total: 0, success: 0, failed: 0 }
  const kakao = kakaoStats.results[0] || { total: 0, success: 0, failed: 0 }
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¬¸ì ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-8">
                        <a href="/admin/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a>
                        <div class="flex gap-4">
                            <a href="/admin/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                            <a href="/admin/users" class="text-gray-600 hover:text-purple-600">ì‚¬ìš©ì</a>
                            <a href="/admin/contacts" class="text-gray-600 hover:text-purple-600">ë¬¸ì˜</a>
                            <a href="/admin/bank-transfers" class="text-gray-600 hover:text-purple-600">ê³„ì¢Œì´ì²´</a>
                            <a href="/admin/sms" class="text-purple-600 font-semibold">ë¬¸ì ê´€ë¦¬</a>
                            <a href="/admin/sender/verification" class="text-gray-600 hover:text-purple-600">ë°œì‹ ë²ˆí˜¸ ìŠ¹ì¸</a>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">ë¬¸ì ë°œì†¡ ê´€ë¦¬</h1>
            
            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-sm p-6 text-white">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-blue-100">SMS ë°œì†¡</span>
                        <i class="fas fa-sms text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold mb-1">${sms.total}</p>
                    <p class="text-sm text-blue-100">ì„±ê³µ ${sms.success} / ì‹¤íŒ¨ ${sms.failed}</p>
                </div>
                
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-sm p-6 text-white">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-green-100">SMS ì„±ê³µ</span>
                        <i class="fas fa-check-circle text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold mb-1">${sms.success || 0}</p>
                    <p class="text-sm text-green-100">ì„±ê³µë¥  ${sms.total > 0 ? Math.round((sms.success / sms.total) * 100) : 0}%</p>
                </div>
                
                <div class="bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-xl shadow-sm p-6 text-white">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-yellow-100">ì¹´ì¹´ì˜¤í†¡</span>
                        <i class="fas fa-comment-dots text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold mb-1">${kakao.total}</p>
                    <p class="text-sm text-yellow-100">ì„±ê³µ ${kakao.success} / ì‹¤íŒ¨ ${kakao.failed}</p>
                </div>
                
                <div class="bg-gradient-to-br from-green-400 to-green-500 rounded-xl shadow-sm p-6 text-white">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-green-100">ì¹´ì¹´ì˜¤ ì„±ê³µ</span>
                        <i class="fas fa-check-circle text-2xl"></i>
                    </div>
                    <p class="text-3xl font-bold mb-1">${kakao.success || 0}</p>
                    <p class="text-sm text-green-100">ì„±ê³µë¥  ${kakao.total > 0 ? Math.round((kakao.success / kakao.total) * 100) : 0}%</p>
                </div>
            </div>
            
            <!-- ìµœê·¼ ë°œì†¡ ë‚´ì—­ -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200 mb-8">
                <h2 class="text-xl font-bold text-gray-900 mb-4">ìµœê·¼ SMS ë°œì†¡ ë‚´ì—­</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ID</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ì‚¬ìš©ì</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">íƒ€ì…</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ì„±ê³µ/ì‹¤íŒ¨</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ìƒíƒœ</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ë°œì†¡ì¼ì‹œ</th>
                            </tr>
                        </thead>
                        <tbody id="smsTableBody">
                            ${recentSMS.results.map(log => `
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="py-3 px-4">#${log.id}</td>
                                    <td class="py-3 px-4">User ${log.user_id}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded text-xs font-semibold ${
                                          log.message_type === 'SMS' ? 'bg-blue-100 text-blue-800' : 
                                          log.message_type === 'LMS' ? 'bg-purple-100 text-purple-800' : 
                                          'bg-pink-100 text-pink-800'
                                        }">
                                            ${log.message_type}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4">-</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded text-xs font-semibold ${
                                          log.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                        }">
                                            ${log.status === 'success' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4 text-sm text-gray-600">${new Date(log.created_at).toLocaleString('ko-KR')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ìµœê·¼ ì¹´ì¹´ì˜¤í†¡ ë°œì†¡ ë‚´ì—­ -->
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <h2 class="text-xl font-bold text-gray-900 mb-4">ìµœê·¼ ì¹´ì¹´ì˜¤í†¡ ë°œì†¡ ë‚´ì—­</h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ID</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ì‚¬ìš©ì</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">í…œí”Œë¦¿</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ì„±ê³µ/ì‹¤íŒ¨</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ìƒíƒœ</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ë°œì†¡ì¼ì‹œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentKakao.results.map(log => `
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="py-3 px-4">#${log.id}</td>
                                    <td class="py-3 px-4">User ${log.user_id}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded text-xs font-semibold bg-yellow-100 text-yellow-800">
                                            ${log.template_code || 'N/A'}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4">-</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded text-xs font-semibold ${
                                          log.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                        }">
                                            ${log.status === 'success' ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}
                                        </span>
                                    </td>
                                    <td class="py-3 px-4 text-sm text-gray-600">${new Date(log.created_at).toLocaleString('ko-KR')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            function logout() {
                if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                    window.location.href = '/';
                }
            }
        </script>
    </body>
    </html>
  `)
})

// ê´€ë¦¬ì ì…ê¸ˆ ê´€ë¦¬ í˜ì´ì§€
app.get('/admin/deposits', async (c) => {
  const { env } = c
  
  // ì…ê¸ˆ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ
  const deposits = await env.DB.prepare(`
    SELECT 
      dr.*,
      u.name as user_name,
      u.email as user_email
    FROM deposit_requests dr
    LEFT JOIN users u ON dr.user_id = u.id
    ORDER BY 
      CASE 
        WHEN dr.status = 'pending' THEN 1
        WHEN dr.status = 'approved' THEN 2
        ELSE 3
      END,
      dr.created_at DESC
    LIMIT 50
  `).all()
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì…ê¸ˆ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-8">
                        <a href="/admin/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a>
                        <div class="flex gap-4">
                            <a href="/admin/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                            <a href="/admin/users" class="text-gray-600 hover:text-purple-600">ì‚¬ìš©ì</a>
                            <a href="/admin/contacts" class="text-gray-600 hover:text-purple-600">ë¬¸ì˜</a>
                            <a href="/admin/bank-transfers" class="text-gray-600 hover:text-purple-600">ê³„ì¢Œì´ì²´</a>
                            <a href="/admin/sms" class="text-gray-600 hover:text-purple-600">ë¬¸ì ê´€ë¦¬</a>
                            <a href="/admin/deposits" class="text-purple-600 font-semibold">ì…ê¸ˆ ê´€ë¦¬</a>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">í¬ì¸íŠ¸ ì…ê¸ˆ ê´€ë¦¬</h1>
            
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ID</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ì‚¬ìš©ì</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ê¸ˆì•¡</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ì€í–‰/ì…ê¸ˆì</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ì‹ ì²­ì¼</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ìƒíƒœ</th>
                                <th class="text-left py-3 px-4 text-gray-600 font-semibold">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${deposits.results.map(deposit => `
                                <tr class="border-b border-gray-100 hover:bg-gray-50">
                                    <td class="py-3 px-4">#${deposit.id}</td>
                                    <td class="py-3 px-4">
                                        <div class="font-semibold">${deposit.user_name}</div>
                                        <div class="text-sm text-gray-600">${deposit.user_email}</div>
                                    </td>
                                    <td class="py-3 px-4 font-bold text-lg">${deposit.amount.toLocaleString()}P</td>
                                    <td class="py-3 px-4">
                                        <div class="text-sm">${deposit.bank_name || 'N/A'}</div>
                                        <div class="text-sm text-gray-600">${deposit.depositor_name || 'N/A'}</div>
                                    </td>
                                    <td class="py-3 px-4 text-sm text-gray-600">${new Date(deposit.created_at).toLocaleString('ko-KR')}</td>
                                    <td class="py-3 px-4">
                                        <span class="px-2 py-1 rounded text-xs font-semibold ${
                                          deposit.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                          deposit.status === 'approved' ? 'bg-green-100 text-green-800' :
                                          'bg-red-100 text-red-800'
                                        }">
                                            ${
                                              deposit.status === 'pending' ? 'ëŒ€ê¸°ì¤‘' :
                                              deposit.status === 'approved' ? 'ìŠ¹ì¸ì™„ë£Œ' :
                                              'ê±°ì ˆë¨'
                                            }
                                        </span>
                                    </td>
                                    <td class="py-3 px-4">
                                        ${deposit.status === 'pending' ? `
                                            <button onclick="processDeposit(${deposit.id}, 'approved')" 
                                                class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 text-sm mr-2">
                                                ìŠ¹ì¸
                                            </button>
                                            <button onclick="processDeposit(${deposit.id}, 'rejected')" 
                                                class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                                                ê±°ì ˆ
                                            </button>
                                        ` : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            async function processDeposit(requestId, status) {
                const action = status === 'approved' ? 'ìŠ¹ì¸' : 'ê±°ì ˆ';
                if(!confirm(\`ì •ë§ ì´ ì…ê¸ˆ ì‹ ì²­ì„ \${action}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) return;
                
                try {
                    const response = await fetch(\`/api/admin/deposit/requests/\${requestId}/process\`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            status: status,
                            adminId: user.id
                        })
                    });
                    
                    const data = await response.json();
                    
                    if(data.success) {
                        alert(\`ì…ê¸ˆ ì‹ ì²­ì´ \${action}ë˜ì—ˆìŠµë‹ˆë‹¤.\`);
                        location.reload();
                    } else {
                        alert(\`ì˜¤ë¥˜: \${data.error}\`);
                    }
                } catch(error) {
                    alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            function logout() {
                if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                    window.location.href = '/';
                }
            }
        </script>
    </body>
    </html>
  `)
})

// ê´€ë¦¬ì: ë¬´ë£Œ í”Œëœ ì‹ ì²­ ê´€ë¦¬
app.get('/admin/free-plan-requests', async (c) => {
  try {
    const { env } = c
    
    if (!env.DB) {
      return c.html(`
        <!DOCTYPE html>
        <html><body>
          <h1>Database Error</h1>
          <p>ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
        </body></html>
      `)
    }
    
    // ë¬´ë£Œ í”Œëœ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ
    let requests: any = { results: [] }
    try {
      requests = await env.DB.prepare(`
        SELECT * FROM free_plan_requests
        ORDER BY 
          CASE status
            WHEN 'pending' THEN 1
            WHEN 'approved' THEN 2
            WHEN 'rejected' THEN 3
          END,
          created_at DESC
        LIMIT 100
      `).all()
    } catch (dbError) {
      console.error('DB query error:', dbError)
      requests = { results: [] }
    }
    
    // í•œêµ­ ì‹œê°„ í¬ë§· í•¨ìˆ˜
    const formatKoreanTime = (utcTimeString: string) => {
      if (!utcTimeString) return '-'
      const date = new Date(utcTimeString)
      const koreaTime = new Date(date.getTime() + (9 * 60 * 60 * 1000))
      const year = koreaTime.getFullYear()
      const month = String(koreaTime.getMonth() + 1).padStart(2, '0')
      const day = String(koreaTime.getDate()).padStart(2, '0')
      const hours = String(koreaTime.getHours()).padStart(2, '0')
      const minutes = String(koreaTime.getMinutes()).padStart(2, '0')
      return `${year}-${month}-${day} ${hours}:${minutes}`
    }
    
    // í†µê³„ ê³„ì‚°
    const pendingCount = requests.results.filter((r: any) => r.status === 'pending').length
    const approvedCount = requests.results.filter((r: any) => r.status === 'approved').length
    const rejectedCount = requests.results.filter((r: any) => r.status === 'rejected').length
    
    // í…Œì´ë¸” í–‰ ìƒì„±
    const tableRows = requests.results.map((request: any) => {
      const statusBadge = request.status === 'pending' 
        ? '<span class="px-3 py-1 text-xs font-semibold text-yellow-800 bg-yellow-100 rounded-full">ëŒ€ê¸° ì¤‘</span>'
        : request.status === 'approved'
        ? '<span class="px-3 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">ìŠ¹ì¸ ì™„ë£Œ</span>'
        : '<span class="px-3 py-1 text-xs font-semibold text-red-800 bg-red-100 rounded-full">ê±°ì ˆ</span>'
      
      const actionButtons = request.status === 'pending' 
        ? `<button onclick="approveRequest(${request.id}, '${request.academy_name.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-green-600 text-white rounded-lg hover:bg-green-700 mr-2">
             <i class="fas fa-check mr-1"></i>ìŠ¹ì¸
           </button>
           <button onclick="rejectRequest(${request.id}, '${request.academy_name.replace(/'/g, "\\'")}')" class="px-3 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700">
             <i class="fas fa-times mr-1"></i>ê±°ì ˆ
           </button>`
        : '-'
      
      const reasonButton = request.reason 
        ? `<button onclick="showReason('${request.reason.replace(/'/g, "\\'")}', '${request.academy_name.replace(/'/g, "\\'")}')" class="ml-2 px-3 py-1 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
             <i class="fas fa-info-circle mr-1"></i>ì‚¬ìœ 
           </button>`
        : ''
      
      return `<tr class="hover:bg-gray-50">
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${request.id}</td>
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="text-sm font-medium text-gray-900">${request.academy_name}</div>
          <div class="text-xs text-gray-500">${request.email}</div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.owner_name}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${request.phone}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatKoreanTime(request.created_at)}</td>
        <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
        <td class="px-6 py-4 whitespace-nowrap text-center text-sm">${actionButtons}${reasonButton}</td>
      </tr>`
    }).join('')
    
    return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë¬´ë£Œ í”Œëœ ì‹ ì²­ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css" rel="stylesheet">
        <style>
          * { font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
          .status-badge {
            animation: fadeIn 0.3s ease-in-out;
          }
          @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
          }
          .hover-lift {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
          }
          .hover-lift:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
          }
        </style>
    </head>
    <body class="bg-gradient-to-br from-gray-50 to-purple-50"
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-8">
                        <a href="/admin/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a>
                        <div class="flex gap-4">
                            <a href="/admin/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                            <a href="/admin/users" class="text-gray-600 hover:text-purple-600">ì‚¬ìš©ì</a>
                            <a href="/admin/contacts" class="text-gray-600 hover:text-purple-600">ë¬¸ì˜</a>
                            <a href="/admin/deposits" class="text-gray-600 hover:text-purple-600">í¬ì¸íŠ¸ ì…ê¸ˆ</a>
                            <a href="/admin/bank-transfers" class="text-gray-600 hover:text-purple-600">ê³„ì¢Œì´ì²´</a>
                            <a href="/admin/free-plan-requests" class="text-purple-600 font-semibold">ë¬´ë£Œ í”Œëœ</a>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">ğŸ ë¬´ë£Œ í”Œëœ ì‹ ì²­ ê´€ë¦¬</h1>
                <button onclick="location.reload()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    <i class="fas fa-sync-alt mr-2"></i>ìƒˆë¡œê³ ì¹¨
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 border-2 border-yellow-300 rounded-2xl p-6 hover-lift">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-yellow-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-clock text-2xl text-white"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900">ëŒ€ê¸° ì¤‘</h3>
                        </div>
                    </div>
                    <p class="text-4xl font-black text-yellow-600 mb-1">${pendingCount}</p>
                    <p class="text-sm text-yellow-700">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­</p>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-300 rounded-2xl p-6 hover-lift">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-check-circle text-2xl text-white"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900">ìŠ¹ì¸ ì™„ë£Œ</h3>
                        </div>
                    </div>
                    <p class="text-4xl font-black text-green-600 mb-1">${approvedCount}</p>
                    <p class="text-sm text-green-700">ë¬´ë£Œ í”Œëœ ì´ìš© ì¤‘</p>
                </div>
                <div class="bg-gradient-to-br from-red-50 to-red-100 border-2 border-red-300 rounded-2xl p-6 hover-lift">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center">
                                <i class="fas fa-times-circle text-2xl text-white"></i>
                            </div>
                            <h3 class="text-lg font-bold text-gray-900">ê±°ì ˆ</h3>
                        </div>
                    </div>
                    <p class="text-4xl font-black text-red-600 mb-1">${rejectedCount}</p>
                    <p class="text-sm text-red-700">ê±°ì ˆëœ ì‹ ì²­</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                <div class="bg-gradient-to-r from-purple-600 to-purple-700 px-6 py-4">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-list"></i>
                        ì‹ ì²­ ëª©ë¡
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">í•™ì›ëª…</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ì›ì¥ë‹˜</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ì—°ë½ì²˜</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ì‹ ì²­ì¼</th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ìƒíƒœ</th>
                                <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                    ${requests.results.length === 0 ? `
                        <div class="text-center py-20">
                            <div class="mb-6">
                                <i class="fas fa-inbox text-8xl text-gray-300"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-700 mb-2">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p class="text-gray-500 mb-6">ì•„ì§ ë¬´ë£Œ í”Œëœ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì‹ ì²­ì´ ë“¤ì–´ì˜¤ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                            <div class="flex gap-4 justify-center">
                                <button onclick="location.reload()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">
                                    <i class="fas fa-sync-alt mr-2"></i>ìƒˆë¡œê³ ì¹¨
                                </button>
                                <a href="/pricing/free" target="_blank" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
                                    <i class="fas fa-external-link-alt mr-2"></i>ì‹ ì²­ í˜ì´ì§€ ë³´ê¸°
                                </a>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>

        <script>
            const ADMIN_EMAIL = 'admin@superplace.co.kr';

            function logout() {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '/login';
            }

            function showReason(reason, academyName) {
                alert('[' + academyName + '] ì‹ ì²­ ì‚¬ìœ :\\n\\n' + reason);
            }

            async function approveRequest(requestId, academyName) {
                if (!confirm('ë¬´ë£Œ í”Œëœì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\ní•™ì›: ' + academyName + '\\n\\nìŠ¹ì¸ ì‹œ í•™ìƒ 50ëª…ê¹Œì§€ ê´€ë¦¬ ê°€ëŠ¥í•œ ë¬´ë£Œ í”Œëœì´ í™œì„±í™”ë©ë‹ˆë‹¤.')) {
                    return;
                }

                try {
                    const response = await fetch('/api/free-plan/approve', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            requestId: requestId,
                            adminEmail: ADMIN_EMAIL
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('âœ… ìŠ¹ì¸ ì™„ë£Œ!\\n\\ní•™ì›: ' + academyName + '\\në¬´ë£Œ í”Œëœì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.reload();
                    } else {
                        alert('âŒ ìŠ¹ì¸ ì‹¤íŒ¨: ' + result.error);
                    }
                } catch (error) {
                    alert('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                }
            }

            async function rejectRequest(requestId, academyName) {
                const reason = prompt('ë¬´ë£Œ í”Œëœ ì‹ ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\ní•™ì›: ' + academyName + '\\n\\nê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:');
                
                if (!reason || reason.trim() === '') {
                    return;
                }

                try {
                    const response = await fetch('/api/free-plan/reject', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            requestId: requestId,
                            adminEmail: ADMIN_EMAIL,
                            reason: reason.trim()
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('âœ… ê±°ì ˆ ì²˜ë¦¬ ì™„ë£Œ\\n\\ní•™ì›: ' + academyName + '\\nì‚¬ìœ : ' + reason);
                        location.reload();
                    } else {
                        alert('âŒ ê±°ì ˆ ì‹¤íŒ¨: ' + result.error);
                    }
                } catch (error) {
                    alert('âŒ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
                }
            }
        </script>
    </body>
    </html>
    `)
  } catch (error) {
    console.error('Free plan requests page error:', error)
    return c.html(`
      <!DOCTYPE html>
      <html><body>
        <h1>Error</h1>
        <p>${(error as Error).message}</p>
      </body></html>
    `)
  }
})

// ê´€ë¦¬ì: ê³„ì¢Œì´ì²´ ì‹ ì²­ ê´€ë¦¬
app.get('/admin/bank-transfers', async (c) => {
  try {
    const { env } = c
    
    // DBê°€ ì—†ìœ¼ë©´ ì—ëŸ¬
    if (!env.DB) {
      return c.html(`
        <!DOCTYPE html>
        <html><body>
          <h1>Database Error</h1>
          <p>ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
          <a href="/api/admin/init-payment-tables">ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”í•˜ê¸°</a>
        </body></html>
      `)
    }
    
    // ê³„ì¢Œì´ì²´ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ (í…Œì´ë¸”ì´ ì—†ì„ ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ try-catch)
    let transfers: any = { results: [] }
    try {
      transfers = await env.DB.prepare(`
        SELECT * FROM bank_transfer_requests
        ORDER BY 
          CASE status
            WHEN 'pending' THEN 1
            WHEN 'approved' THEN 2
            WHEN 'rejected' THEN 3
          END,
          created_at DESC
        LIMIT 100
      `).all()
    } catch (dbError) {
      console.error('DB query error:', dbError)
      // í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ê³„ì† ì§„í–‰
      transfers = { results: [] }
    }
    
    // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜ í•¨ìˆ˜
    const formatKoreanTime = (utcTimeString: string) => {
      if (!utcTimeString) return '-'
      const date = new Date(utcTimeString)
      // UTC to Korea Time (UTC+9)
      const koreaTime = new Date(date.getTime() + (9 * 60 * 60 * 1000))
      const year = koreaTime.getFullYear()
      const month = String(koreaTime.getMonth() + 1).padStart(2, '0')
      const day = String(koreaTime.getDate()).padStart(2, '0')
      const hours = String(koreaTime.getHours()).padStart(2, '0')
      const minutes = String(koreaTime.getMinutes()).padStart(2, '0')
      const seconds = String(koreaTime.getSeconds()).padStart(2, '0')
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`
    }
    
    return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ê³„ì¢Œì´ì²´ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-8">
                        <a href="/admin/dashboard" class="text-2xl font-bold text-purple-600">ìŠˆí¼í”Œë ˆì´ìŠ¤ ê´€ë¦¬ì</a>
                        <div class="flex gap-4">
                            <a href="/admin/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                            <a href="/admin/users" class="text-gray-600 hover:text-purple-600">ì‚¬ìš©ì</a>
                            <a href="/admin/contacts" class="text-gray-600 hover:text-purple-600">ë¬¸ì˜</a>
                            <a href="/admin/deposits" class="text-gray-600 hover:text-purple-600">í¬ì¸íŠ¸ ì…ê¸ˆ</a>
                            <a href="/admin/bank-transfers" class="text-purple-600 font-semibold">ê³„ì¢Œì´ì²´</a>
                            <a href="/admin/free-plan-requests" class="text-gray-600 hover:text-purple-600">ë¬´ë£Œ í”Œëœ</a>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900">ğŸ’° ê³„ì¢Œì´ì²´ ì‹ ì²­ ê´€ë¦¬</h1>
                <div class="text-sm text-gray-600">
                    ì´ <span class="font-bold text-purple-600">${transfers.results?.length || 0}</span>ê±´
                </div>
            </div>

            <!-- ê²€ìƒ‰ì°½ -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <div class="flex gap-4 items-center">
                    <div class="flex-1">
                        <input 
                            type="text" 
                            id="searchInput" 
                            placeholder="ì‹ ì²­ì ì´ë¦„, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰..." 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            onkeyup="filterTransfers()"
                        />
                    </div>
                    <select id="statusFilter" class="px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="filterTransfers()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="pending">ëŒ€ê¸°ì¤‘</option>
                        <option value="approved">ìŠ¹ì¸ì™„ë£Œ</option>
                        <option value="rejected">ê±°ì ˆ</option>
                    </select>
                    <button onclick="clearFilters()" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                        <i class="fas fa-redo mr-2"></i>ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 shadow-md border-l-4 border-yellow-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm mb-1">ëŒ€ê¸°ì¤‘</p>
                            <p class="text-3xl font-bold text-yellow-600" id="pendingCount">0</p>
                        </div>
                        <div class="w-14 h-14 bg-yellow-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-clock text-yellow-600 text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-md border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm mb-1">ìŠ¹ì¸ì™„ë£Œ</p>
                            <p class="text-3xl font-bold text-green-600" id="approvedCount">0</p>
                        </div>
                        <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-6 shadow-md border-l-4 border-red-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm mb-1">ê±°ì ˆ</p>
                            <p class="text-3xl font-bold text-red-600" id="rejectedCount">0</p>
                        </div>
                        <div class="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì‹ ì²­ ëª©ë¡ -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">ì‹ ì²­ID</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">ì‹ ì²­ì</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">í”Œëœ</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">ê¸ˆì•¡</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">ì—°ë½ì²˜</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">ì‹ ì²­ì¼ì‹œ</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">ìƒíƒœ</th>
                            <th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="transferList">
                        ${transfers.results?.map((t: any) => {
                          const statusBadge = t.status === 'pending' 
                            ? '<span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full">ëŒ€ê¸°ì¤‘</span>'
                            : t.status === 'approved'
                            ? '<span class="px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">ìŠ¹ì¸ì™„ë£Œ</span>'
                            : '<span class="px-3 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full">ê±°ì ˆ</span>'
                          
                          const actionButtons = t.status === 'pending'
                            ? '<button onclick="approve(' + t.id + ')" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 mr-2">' +
                                '<i class="fas fa-check mr-1"></i>ìŠ¹ì¸' +
                               '</button>' +
                               '<button onclick="reject(' + t.id + ')" class="px-3 py-1.5 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700">' +
                                '<i class="fas fa-times mr-1"></i>ê±°ì ˆ' +
                               '</button>'
                            : '<span class="text-gray-400 text-sm">ì™„ë£Œ</span>'
                          
                          return `
                            <tr class="border-b hover:bg-gray-50 transfer-row" data-name="${t.user_name}" data-email="${t.user_email}" data-phone="${t.user_phone}" data-status="${t.status}">
                              <td class="px-6 py-4 text-sm text-gray-900 font-mono">#${t.id}</td>
                              <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900">${t.user_name}</div>
                                <div class="text-xs text-gray-500">${t.user_email}</div>
                              </td>
                              <td class="px-6 py-4 text-sm text-gray-900">${t.plan_name}</td>
                              <td class="px-6 py-4 text-sm font-bold text-purple-600">â‚©${parseInt(t.amount).toLocaleString()}</td>
                              <td class="px-6 py-4 text-sm text-gray-600">${t.user_phone}</td>
                              <td class="px-6 py-4 text-sm text-gray-600">${formatKoreanTime(t.created_at)}</td>
                              <td class="px-6 py-4">${statusBadge}</td>
                              <td class="px-6 py-4 text-center">${actionButtons}</td>
                            </tr>
                          `
                        }).join('') || '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>'}
                    </tbody>
                </table>
            </div>
        </div>

        <script>
        // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜
        function formatKoreanTime(utcTimeString) {
            if (!utcTimeString) return '-'
            const date = new Date(utcTimeString)
            // UTC to Korea Time (UTC+9)
            const koreaTime = new Date(date.getTime() + (9 * 60 * 60 * 1000))
            const year = koreaTime.getFullYear()
            const month = String(koreaTime.getMonth() + 1).padStart(2, '0')
            const day = String(koreaTime.getDate()).padStart(2, '0')
            const hours = String(koreaTime.getHours()).padStart(2, '0')
            const minutes = String(koreaTime.getMinutes()).padStart(2, '0')
            const seconds = String(koreaTime.getSeconds()).padStart(2, '0')
            return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds
        }

        function logout() {
            localStorage.removeItem('user')
            window.location.href = '/'
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        function filterTransfers() {
            const searchText = document.getElementById('searchInput').value.toLowerCase()
            const statusFilter = document.getElementById('statusFilter').value
            const rows = document.querySelectorAll('.transfer-row')
            
            rows.forEach(row => {
                const name = row.getAttribute('data-name').toLowerCase()
                const email = row.getAttribute('data-email').toLowerCase()
                const phone = row.getAttribute('data-phone').toLowerCase()
                const status = row.getAttribute('data-status')
                
                const matchesSearch = name.includes(searchText) || email.includes(searchText) || phone.includes(searchText)
                const matchesStatus = !statusFilter || status === statusFilter
                
                if (matchesSearch && matchesStatus) {
                    row.style.display = ''
                } else {
                    row.style.display = 'none'
                }
            })
            
            updateStats()
        }

        // í•„í„° ì´ˆê¸°í™”
        function clearFilters() {
            document.getElementById('searchInput').value = ''
            document.getElementById('statusFilter').value = ''
            filterTransfers()
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const rows = document.querySelectorAll('.transfer-row')
            let pending = 0, approved = 0, rejected = 0
            
            rows.forEach(row => {
                // ë³´ì´ëŠ” í–‰ë§Œ ì¹´ìš´íŠ¸
                if (row.style.display !== 'none') {
                    const status = row.querySelector('span[class*="bg-"]')?.textContent?.trim()
                    if (status === 'ëŒ€ê¸°ì¤‘') pending++
                    else if (status === 'ìŠ¹ì¸ì™„ë£Œ') approved++
                    else if (status === 'ê±°ì ˆ') rejected++
                }
            })
            
            document.getElementById('pendingCount').textContent = pending
            document.getElementById('approvedCount').textContent = approved
            document.getElementById('rejectedCount').textContent = rejected
        }

        updateStats()

        async function approve(id) {
            if (!confirm('ì´ ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\nìŠ¹ì¸ ì‹œ í•´ë‹¹ ì‚¬ìš©ìì˜ êµ¬ë…ì´ í™œì„±í™”ë©ë‹ˆë‹¤.')) {
                return
            }

            try {
                const response = await fetch('/api/bank-transfer/approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requestId: id,
                        adminEmail: 'admin@superplace.co.kr'
                    })
                })

                const result = await response.json()
                
                if (result.success) {
                    alert('âœ… ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!')
                    location.reload()
                } else {
                    alert('âŒ ìŠ¹ì¸ ì‹¤íŒ¨: ' + result.error)
                }
            } catch (err) {
                alert('âŒ ì˜¤ë¥˜: ' + err.message)
            }
        }

        async function reject(id) {
            const reason = prompt('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:')
            if (!reason) return

            try {
                const response = await fetch('/api/bank-transfer/reject', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requestId: id,
                        adminEmail: 'admin@superplace.co.kr',
                        reason
                    })
                })

                const result = await response.json()
                
                if (result.success) {
                    alert('âœ… ê±°ì ˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.')
                    location.reload()
                } else {
                    alert('âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ' + result.error)
                }
            } catch (err) {
                alert('âŒ ì˜¤ë¥˜: ' + err.message)
            }
        }
        </script>
    </body>
    </html>
  `)
  } catch (error) {
    console.error('Admin bank transfers page error:', error)
    return c.html(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì˜¤ë¥˜ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
      </head>
      <body class="bg-gray-50 flex items-center justify-center min-h-screen">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-md">
          <h1 class="text-2xl font-bold text-red-600 mb-4">âš ï¸ ì˜¤ë¥˜ ë°œìƒ</h1>
          <p class="text-gray-700 mb-4">ê³„ì¢Œì´ì²´ ê´€ë¦¬ í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
          <p class="text-sm text-gray-600 mb-6">ì˜¤ë¥˜: ${(error as Error).message}</p>
          <div class="space-y-3">
            <a href="/api/admin/init-payment-tables" class="block w-full text-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
              ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”í•˜ê¸°
            </a>
            <a href="/admin/dashboard" class="block w-full text-center px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
              ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
            </a>
          </div>
        </div>
      </body>
      </html>
    `, 500)
  }
})

app.get('/admin/sender/verification', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë°œì‹ ë²ˆí˜¸ ìŠ¹ì¸ ê´€ë¦¬ - ê´€ë¦¬ì</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-3">
                        <a href="/admin/dashboard" class="text-lg font-bold text-gray-900">â† ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a>
                    </div>
                    <span id="userName" class="text-gray-700 font-medium"></span>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-7xl mx-auto">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ“± ë°œì‹ ë²ˆí˜¸ ìŠ¹ì¸ ê´€ë¦¬</h1>
                    <p class="text-gray-600">ì‚¬ìš©ìì˜ ë°œì‹ ë²ˆí˜¸ ì¸ì¦ ì‹ ì²­ì„ ê²€í† í•˜ê³  ìŠ¹ì¸/ê±°ì ˆí•©ë‹ˆë‹¤</p>
                </div>

                <!-- í†µê³„ -->
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-yellow-700 font-medium">ìŠ¹ì¸ ëŒ€ê¸°</p>
                                <p class="text-3xl font-bold text-yellow-900 mt-1"><span id="pendingCount">0</span>ê±´</p>
                            </div>
                            <svg class="w-12 h-12 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-green-700 font-medium">ìŠ¹ì¸ ì™„ë£Œ</p>
                                <p class="text-3xl font-bold text-green-900 mt-1"><span id="approvedCount">0</span>ê±´</p>
                            </div>
                            <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>

                    <div class="bg-red-50 border border-red-200 rounded-xl p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-red-700 font-medium">ê±°ì ˆë¨</p>
                                <p class="text-3xl font-bold text-red-900 mt-1"><span id="rejectedCount">0</span>ê±´</p>
                            </div>
                            <svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- ì‹ ì²­ ëª©ë¡ -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-bold text-gray-900">ì‹ ì²­ ëª©ë¡</h2>
                            <button onclick="loadRequests()" class="text-purple-600 hover:text-purple-700 font-medium">
                                ğŸ”„ ìƒˆë¡œê³ ì¹¨
                            </button>
                        </div>
                    </div>
                    <div id="requestsList" class="divide-y divide-gray-200">
                        <div class="text-center text-gray-500 py-12">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                            <p>ë¡œë”© ì¤‘...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìƒì„¸ ëª¨ë‹¬ -->
        <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-900">ë°œì‹ ë²ˆí˜¸ ìŠ¹ì¸ ê²€í† </h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="modalContent" class="p-6">
                    <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
        </div>

        <script>
            const user = JSON.parse(localStorage.getItem('user'))
            if (!user || user.role !== 'admin') {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.')
                window.location.href = '/dashboard'
            }
            document.getElementById('userName').textContent = user.name

            let currentRequest = null

            async function loadRequests() {
                try {
                    const response = await fetch('/api/admin/sender/verification-requests?adminId=' + user.id)
                    const data = await response.json()

                    if (data.success) {
                        updateStats(data.requests)
                        renderRequests(data.requests)
                    }
                } catch (err) {
                    console.error('Load requests error:', err)
                }
            }

            function updateStats(requests) {
                const pending = requests.filter(r => r.status === 'pending').length
                const approved = requests.filter(r => r.status === 'approved').length
                const rejected = requests.filter(r => r.status === 'rejected').length

                document.getElementById('pendingCount').textContent = pending
                document.getElementById('approvedCount').textContent = approved
                document.getElementById('rejectedCount').textContent = rejected
            }

            function renderRequests(requests) {
                const container = document.getElementById('requestsList')

                if (requests.length === 0) {
                    container.innerHTML = \`
                        <div class="text-center text-gray-500 py-12">
                            <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p>ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                    \`
                    return
                }

                container.innerHTML = requests.map(req => {
                    const statusColor = req.status === 'pending' ? 'yellow' : req.status === 'approved' ? 'green' : 'red'
                    const statusText = req.status === 'pending' ? 'ìŠ¹ì¸ ëŒ€ê¸°' : req.status === 'approved' ? 'ìŠ¹ì¸ ì™„ë£Œ' : 'ê±°ì ˆë¨'
                    
                    return \`
                        <div class="p-6 hover:bg-gray-50 transition">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <span class="px-3 py-1 bg-\${statusColor}-100 text-\${statusColor}-700 text-sm font-medium rounded-full">
                                            \${statusText}
                                        </span>
                                        <span class="text-sm text-gray-500">
                                            \${new Date(req.request_date).toLocaleString('ko-KR')}
                                        </span>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-4 mb-3">
                                        <div>
                                            <p class="text-sm text-gray-600">ì‹ ì²­ì</p>
                                            <p class="font-bold text-gray-900">\${req.user_name} (\${req.user_email})</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">ì‚¬ì—…ì²´ëª…</p>
                                            <p class="font-bold text-gray-900">\${req.business_name}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">ë°œì‹ ë²ˆí˜¸</p>
                                            <p class="font-bold text-gray-900">\${req.phone_number}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-600">ì‚¬ì—…ìë²ˆí˜¸</p>
                                            <p class="font-bold text-gray-900">\${req.business_registration_number}</p>
                                        </div>
                                    </div>
                                    \${req.admin_note ? '<p class="text-sm text-gray-600 bg-gray-100 p-3 rounded">ê´€ë¦¬ì ë©”ëª¨: ' + req.admin_note + '</p>' : ''}
                                </div>
                                <div class="ml-6">
                                    <button onclick='openModal(\${JSON.stringify(req)})' 
                                            class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                                        ìƒì„¸ë³´ê¸°
                                    </button>
                                </div>
                            </div>
                        </div>
                    \`
                }).join('')
            }

            // íŒŒì¼ ë Œë”ë§ í—¬í¼ í•¨ìˆ˜ (ì´ë¯¸ì§€ ë˜ëŠ” PDF)
            function renderFilePreview(url, title) {
                if (!url) {
                    return '<p class="text-gray-500 text-sm">íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</p>'
                }
                
                // URLì—ì„œ íŒŒì¼ í™•ì¥ì í™•ì¸
                const isPdf = url.toLowerCase().endsWith('.pdf') || url.includes('application/pdf')
                
                if (isPdf) {
                    return \`
                        <div class="border border-gray-300 rounded-lg p-4 bg-gray-50">
                            <div class="flex items-center justify-center mb-3">
                                <svg class="w-16 h-16 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"/>
                                    <path d="M8 10a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"/>
                                </svg>
                            </div>
                            <p class="text-center text-sm font-medium text-gray-700 mb-3">PDF ë¬¸ì„œ</p>
                            <a href="\${url}" target="_blank" 
                               class="block w-full px-4 py-2 bg-red-600 text-white text-center rounded-lg hover:bg-red-700 transition">
                                ğŸ“„ PDF ì—´ê¸°
                            </a>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-center">í´ë¦­í•˜ë©´ ìƒˆ íƒ­ì—ì„œ ì—´ë¦½ë‹ˆë‹¤</p>
                    \`
                } else {
                    return \`
                        <a href="\${url}" target="_blank" class="block">
                            <img src="\${url}" 
                                 class="w-full rounded-lg border border-gray-300 hover:border-purple-500 transition cursor-pointer"
                                 onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YzZjRmNiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LXNpemU9IjE2IiBmaWxsPSIjOTc5N2E3IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+7J2066+47KeAIOuhnOuTnCDsi6Ttjqg8L3RleHQ+PC9zdmc+'">
                        </a>
                        <p class="text-xs text-gray-500 mt-2 text-center">í´ë¦­í•˜ë©´ ìƒˆ íƒ­ì—ì„œ ì—´ë¦½ë‹ˆë‹¤</p>
                    \`
                }
            }

            function openModal(request) {
                currentRequest = request
                const modal = document.getElementById('detailModal')
                const content = document.getElementById('modalContent')

                const statusColor = request.status === 'pending' ? 'yellow' : request.status === 'approved' ? 'green' : 'red'
                const statusText = request.status === 'pending' ? 'ìŠ¹ì¸ ëŒ€ê¸°' : request.status === 'approved' ? 'ìŠ¹ì¸ ì™„ë£Œ' : 'ê±°ì ˆë¨'

                content.innerHTML = \`
                    <div class="space-y-6">
                        <!-- ìƒíƒœ -->
                        <div class="flex items-center justify-between p-4 bg-\${statusColor}-50 border border-\${statusColor}-200 rounded-lg">
                            <span class="text-\${statusColor}-700 font-bold">ìƒíƒœ: \${statusText}</span>
                            \${request.processed_date ? '<span class="text-sm text-' + statusColor + '-600">ì²˜ë¦¬ì¼: ' + new Date(request.processed_date).toLocaleString('ko-KR') + '</span>' : ''}
                        </div>

                        <!-- ì‹ ì²­ì ì •ë³´ -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 mb-3">ì‹ ì²­ì ì •ë³´</h3>
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p class="text-gray-600">ì´ë¦„</p>
                                    <p class="font-medium">\${request.user_name}</p>
                                </div>
                                <div>
                                    <p class="text-gray-600">ì´ë©”ì¼</p>
                                    <p class="font-medium">\${request.user_email}</p>
                                </div>
                            </div>
                        </div>

                        <!-- ì‚¬ì—…ì ì •ë³´ -->
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h3 class="font-bold text-gray-900 mb-3">ì‚¬ì—…ì ì •ë³´</h3>
                            <div class="grid md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <p class="text-gray-600">ì‚¬ì—…ì²´ëª…</p>
                                    <p class="font-medium">\${request.business_name}</p>
                                </div>
                                <div>
                                    <p class="text-gray-600">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</p>
                                    <p class="font-medium">\${request.business_registration_number}</p>
                                </div>
                                <div class="md:col-span-2">
                                    <p class="text-gray-600">ë°œì‹ ë²ˆí˜¸</p>
                                    <p class="font-medium">\${request.phone_number}</p>
                                </div>
                            </div>
                        </div>

                        <!-- ì œì¶œ ì„œë¥˜ ì´ë¯¸ì§€ -->
                        <div class="space-y-4">
                            <!-- 1. ì‚¬ì—…ì ë“±ë¡ì¦ -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h3 class="font-bold text-gray-900 mb-3">ğŸ“„ 1. ì‚¬ì—…ì ë“±ë¡ì¦</h3>
                                \${renderFilePreview(request.business_registration_image, 'ì‚¬ì—…ì ë“±ë¡ì¦')}
                            </div>

                            <!-- 2. í†µì‹ ì‚¬ ê°€ì…ì¦ëª…ì› -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h3 class="font-bold text-gray-900 mb-3">ğŸ“„ 2. í†µì‹ ì‚¬ ê°€ì…ì¦ëª…ì›</h3>
                                \${renderFilePreview(request.certificate_image, 'í†µì‹ ì‚¬ ê°€ì…ì¦ëª…ì›')}
                            </div>

                            <!-- 3. ì¬ì§ì¦ëª…ì„œ -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h3 class="font-bold text-gray-900 mb-3">ğŸ“„ 3. ì¬ì§ì¦ëª…ì„œ (ë„ì¥ ë‚ ì¸)</h3>
                                \${renderFilePreview(request.employment_cert_image, 'ì¬ì§ì¦ëª…ì„œ')}
                            </div>

                            <!-- 4. ë¬¸ìë©”ì‹œì§€ ì´ìš©ê³„ì•½ì„œ -->
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h3 class="font-bold text-gray-900 mb-3">ğŸ“„ 4. ë¬¸ìë©”ì‹œì§€ ì´ìš©ê³„ì•½ì„œ (ë„ì¥ ë‚ ì¸)</h3>
                                \${renderFilePreview(request.contract_image, 'ë¬¸ìë©”ì‹œì§€ ì´ìš©ê³„ì•½ì„œ')}
                            </div>
                        </div>

                        <!-- ê´€ë¦¬ì ë©”ëª¨ ì…ë ¥ -->
                        \${request.status === 'pending' ? \`
                            <div class="border border-gray-200 rounded-lg p-4">
                                <label class="block text-sm font-bold text-gray-700 mb-2">ê´€ë¦¬ì ë©”ëª¨ (ì„ íƒ)</label>
                                <textarea id="adminNote" rows="3" 
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                          placeholder="ìŠ¹ì¸/ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                            </div>
                        \` : request.admin_note ? \`
                            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                                <p class="text-sm font-bold text-gray-700 mb-2">ê´€ë¦¬ì ë©”ëª¨</p>
                                <p class="text-gray-900">\${request.admin_note}</p>
                            </div>
                        \` : ''}

                        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
                        \${request.status === 'pending' ? \`
                            <div class="flex gap-4 pt-4">
                                <button onclick="processRequest('reject')" 
                                        class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-bold">
                                    âŒ ê±°ì ˆ
                                </button>
                                <button onclick="processRequest('approve')" 
                                        class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold">
                                    âœ… ìŠ¹ì¸
                                </button>
                            </div>
                        \` : ''}
                    </div>
                \`

                modal.classList.remove('hidden')
            }

            function closeModal() {
                document.getElementById('detailModal').classList.add('hidden')
                currentRequest = null
            }

            async function processRequest(action) {
                if (!currentRequest) return

                const adminNote = document.getElementById('adminNote')?.value || ''

                if (!confirm(\`ì •ë§ë¡œ ì´ ì‹ ì²­ì„ \${action === 'approve' ? 'ìŠ¹ì¸' : 'ê±°ì ˆ'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) {
                    return
                }

                try {
                    const response = await fetch('/api/sms/sender/verification-process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            requestId: currentRequest.id,
                            action,
                            adminNote,
                            adminId: user.id
                        })
                    })

                    const data = await response.json()

                    if (data.success) {
                        alert(data.message)
                        closeModal()
                        loadRequests()
                    } else {
                        alert(data.error || 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
                    }
                } catch (err) {
                    console.error('Process error:', err)
                    alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
                }
            }

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.getElementById('detailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal()
                }
            })

            loadRequests()
        </script>
    </body>
    </html>
  `)
})

// ========================================
// í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ í˜ì´ì§€
// ========================================

// ì„ ìƒë‹˜ ê´€ë¦¬ í˜ì´ì§€ (ì›ì¥ë‹˜ ì „ìš©)
app.get('/teachers/manage', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì„ ìƒë‹˜ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-8">
                        <h1 class="text-xl font-bold text-purple-600">
                            <i class="fas fa-chalkboard-teacher mr-2"></i>ì„ ìƒë‹˜ & ë°˜ ê´€ë¦¬
                        </h1>
                        <div class="flex gap-4">
                            <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                            <a href="/students" class="text-gray-600 hover:text-purple-600">í•™ìƒ ê´€ë¦¬</a>
                        </div>
                    </div>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </nav>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- ìƒë‹¨ ìš”ì•½ -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">ë“±ë¡ëœ ì„ ìƒë‹˜</p>
                            <p id="teacherCount" class="text-3xl font-bold text-purple-600">0ëª…</p>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-user-tie text-purple-600 text-2xl"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">ìš´ì˜ ì¤‘ì¸ ë°˜</p>
                            <p id="classCount" class="text-3xl font-bold text-blue-600">0ê°œ</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-chalkboard text-blue-600 text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì„ ìƒë‹˜ ëª©ë¡ ì„¹ì…˜ -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-user-tie text-purple-600 mr-2"></i>ì„ ìƒë‹˜ ëª©ë¡
                    </h2>
                    <button onclick="openCreateTeacherModal()" class="px-4 py-2 gradient-purple text-white rounded-lg hover:opacity-90 transition">
                        <i class="fas fa-plus mr-2"></i>ì„ ìƒë‹˜ ì¶”ê°€
                    </button>
                </div>
                <div id="teacherList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- ì„ ìƒë‹˜ ì¹´ë“œê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                        <p>ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>

            <!-- ë°˜ ëª©ë¡ ì„¹ì…˜ -->
            <div>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-chalkboard text-blue-600 mr-2"></i>ë°˜ ëª©ë¡
                    </h2>
                    <button onclick="openCreateClassModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-plus mr-2"></i>ë°˜ ìƒì„±
                    </button>
                </div>
                <div id="classList" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- ë°˜ ì¹´ë“œê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                        <p>ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì„ ìƒë‹˜ ìƒì„± ëª¨ë‹¬ -->
        <div id="createTeacherModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">ì„ ìƒë‹˜ ê³„ì • ìƒì„±</h3>
                    <button onclick="closeCreateTeacherModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="createTeacherForm" onsubmit="createTeacher(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„ *</label>
                            <input type="text" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼ *</label>
                            <input type="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸ *</label>
                            <input type="password" name="password" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
                            <input type="password" name="confirmPassword" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì „í™”ë²ˆí˜¸</label>
                            <input type="tel" name="phone" placeholder="010-1234-5678" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeCreateTeacherModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            ì·¨ì†Œ
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 gradient-purple text-white rounded-lg hover:opacity-90">
                            ìƒì„±
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ë°˜ ìƒì„± ëª¨ë‹¬ -->
        <div id="createClassModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">ë°˜ ìƒì„±</h3>
                    <button onclick="closeCreateClassModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="createClassForm" onsubmit="createClass(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ë°˜ ì´ë¦„ *</label>
                            <input type="text" name="className" required placeholder="ì˜ˆ: ì´ˆë“± 1ë°˜" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                            <textarea name="description" rows="2" placeholder="ë°˜ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">í•™ë…„ ìˆ˜ì¤€</label>
                            <select name="gradeLevel" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì´ˆë“±">ì´ˆë“±</option>
                                <option value="ì¤‘ë“±">ì¤‘ë“±</option>
                                <option value="ê³ ë“±">ê³ ë“±</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ê³¼ëª©</label>
                            <input type="text" name="subject" placeholder="ì˜ˆ: ìˆ˜í•™, ì˜ì–´, ì „ê³¼ëª©" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ìµœëŒ€ í•™ìƒ ìˆ˜</label>
                            <input type="number" name="maxStudents" value="20" min="1" max="50" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="closeCreateClassModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            ì·¨ì†Œ
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            ìƒì„±
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script src="/static/teacher-management.js"></script>
    </body>
    </html>
  `)
})

// ì„ ìƒë‹˜: í•™ì› ê´€ë¦¬ í˜ì´ì§€
app.get('/academy-management', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í•™ì› ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white shadow-sm border-b sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-8">
                        <h1 class="text-xl font-bold text-purple-600">
                            <i class="fas fa-school mr-2"></i>í•™ì› ê´€ë¦¬
                        </h1>
                        <a href="/" class="text-gray-600 hover:text-purple-600">í™ˆìœ¼ë¡œ</a>
                    </div>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-600">
                        <i class="fas fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
        </nav>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- ë‚´ í•™ì› ëª©ë¡ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-building text-purple-600 mr-2"></i>ë‚´ í•™ì›
                    </h2>
                    <button onclick="openAddAcademyModal()" class="px-4 py-2 gradient-purple text-white rounded-lg hover:opacity-90">
                        <i class="fas fa-plus mr-2"></i>í•™ì› ì¶”ê°€
                    </button>
                </div>
                <div id="academyList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- í•™ì› ì¶”ê°€ ëª¨ë‹¬ -->
        <div id="addAcademyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">í•™ì› ì¶”ê°€í•˜ê¸°</h3>
                    <button onclick="closeAddAcademyModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="addAcademyForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì›ëª… <span class="text-red-500">*</span></label>
                        <input type="text" name="academy_name" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="ê¾¸ë©”ë•…í•™ì› ë¶„ë‹¹ì ">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">í•™ì› ì£¼ì†Œ <span class="text-red-500">*</span></label>
                        <input type="text" name="academy_address" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="ì¸ì²œ ì„œêµ¬ ê²€ë‹¨ë™">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">ì›ì¥ë‹˜ ì´ë¦„ <span class="text-red-500">*</span></label>
                        <input type="text" name="director_name" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="í™ê¸¸ë™">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">ì›ì¥ë‹˜ ì—°ë½ì²˜ <span class="text-red-500">*</span></label>
                        <input type="tel" name="director_phone" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="010-0000-0000">
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤
                        </p>
                    </div>
                    
                    <button type="submit" class="w-full gradient-purple text-white py-3 rounded-lg font-medium hover:opacity-90">
                        <i class="fas fa-paper-plane mr-2"></i>ì‹ ì²­í•˜ê¸°
                    </button>
                </form>
            </div>
        </div>

        <script>
            let currentUser = null;
            
            // ë¡œê·¸ì¸ í™•ì¸
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                location.href = '/login';
            } else {
                currentUser = JSON.parse(userStr);
                if (currentUser.user_type !== 'teacher') {
                    alert('ì„ ìƒë‹˜ ê³„ì •ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    location.href = '/';
                }
                loadMyAcademies();
            }
            
            async function loadMyAcademies() {
                try {
                    const res = await fetch('/api/teacher/academies?teacherId=' + currentUser.id);
                    const data = await res.json();
                    const container = document.getElementById('academyList');
                    
                    if (!data.success || data.academies.length === 0) {
                        container.innerHTML = \`
                            <div class="text-center py-12">
                                <i class="fas fa-school text-6xl text-gray-300 mb-4"></i>
                                <p class="text-gray-600 mb-4">ë“±ë¡ëœ í•™ì›ì´ ì—†ìŠµë‹ˆë‹¤</p>
                                <button onclick="openAddAcademyModal()" class="px-6 py-3 gradient-purple text-white rounded-lg hover:opacity-90">
                                    <i class="fas fa-plus mr-2"></i>ì²« í•™ì› ì¶”ê°€í•˜ê¸°
                                </button>
                            </div>
                        \`;
                        return;
                    }
                    
                    container.innerHTML = data.academies.map(academy => \`
                        <div class="border rounded-xl p-6 hover:shadow-lg transition">
                            <div class="flex items-start justify-between">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900 mb-2">\${academy.academy_name}</h3>
                                    <p class="text-sm text-gray-600 mb-1"><i class="fas fa-map-marker-alt mr-2"></i>\${academy.academy_address}</p>
                                    <p class="text-sm text-gray-600 mb-1"><i class="fas fa-user mr-2"></i>ì›ì¥: \${academy.director_name}</p>
                                    <p class="text-sm text-gray-600"><i class="fas fa-phone mr-2"></i>\${academy.director_phone}</p>
                                </div>
                                <div>
                                    \${academy.status === 'pending' ? 
                                        '<span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">ìŠ¹ì¸ ëŒ€ê¸°</span>' :
                                      academy.status === 'approved' ?
                                        '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">ìŠ¹ì¸ ì™„ë£Œ</span>' :
                                        '<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm font-medium">ê±°ì ˆë¨</span>'
                                    }
                                </div>
                            </div>
                        </div>
                    \`).join('');
                } catch (error) {
                    console.error('Load academies error:', error);
                }
            }
            
            function openAddAcademyModal() {
                document.getElementById('addAcademyModal').classList.remove('hidden');
            }
            
            function closeAddAcademyModal() {
                document.getElementById('addAcademyModal').classList.add('hidden');
            }
            
            document.getElementById('addAcademyForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = {
                    teacher_id: currentUser.id,
                    academy_name: formData.get('academy_name'),
                    academy_address: formData.get('academy_address'),
                    director_name: formData.get('director_name'),
                    director_phone: formData.get('director_phone')
                };
                
                try {
                    const res = await fetch('/api/teacher/academy/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await res.json();
                    
                    if (result.success) {
                        alert('í•™ì› ì¶”ê°€ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                        closeAddAcademyModal();
                        e.target.reset();
                        loadMyAcademies();
                    } else {
                        alert(result.error || 'í•™ì› ì¶”ê°€ ì‹¤íŒ¨');
                    }
                } catch (error) {
                    console.error('Add academy error:', error);
                    alert('í•™ì› ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
            
            function logout() {
                if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                    location.href = '/';
                }
            }
        </script>
    </body>
    </html>
  `)
})

// Redirect /teachers to /students (all features are in /students page)
app.get('/teachers', (c) => {
  return c.redirect('/students')
})

// OLD /teachers page (temporarily disabled due to JS errors)
app.get('/teachers-old', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì„ ìƒë‹˜ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
            * { font-family: 'Pretendard Variable', sans-serif; }
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/" class="text-gray-600 hover:text-gray-900">
                            <i class="fas fa-home mr-2"></i>í™ˆ
                        </a>
                        <a href="/students" class="text-gray-600 hover:text-gray-900">
                            <i class="fas fa-user-graduate mr-2"></i>í•™ìƒ ê´€ë¦¬
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">ì „ì²´ ì„ ìƒë‹˜</p>
                            <p class="text-3xl font-bold text-gray-900" id="totalTeachers">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chalkboard-teacher text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</p>
                            <p class="text-3xl font-bold text-gray-900" id="pendingCount">0</p>
                        </div>
                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-yellow-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">ë‹´ë‹¹ ë°˜ ë°°ì •ì™„ë£Œ</p>
                            <p class="text-3xl font-bold text-gray-900" id="assignedCount">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì¸ì¦ ì½”ë“œ ì„¹ì…˜ -->
            <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4">
                    <i class="fas fa-key text-purple-600 mr-2"></i>í•™ì› ì¸ì¦ ì½”ë“œ
                </h3>
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <div>
                        <p class="text-sm text-gray-600 mb-2">ì„ ìƒë‹˜ì—ê²Œ ì´ ì½”ë“œë¥¼ ì „ë‹¬í•˜ì„¸ìš”</p>
                        <span id="verificationCode" class="text-3xl font-mono font-bold text-purple-600 block mb-2">------</span>
                        <a href="/signup?teacher=true" target="_blank" class="text-sm text-purple-600 hover:underline">
                            <i class="fas fa-external-link-alt mr-1"></i>ì„ ìƒë‹˜ ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™
                        </a>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyVerificationCode()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 whitespace-nowrap">
                            <i class="fas fa-copy mr-2"></i>ë³µì‚¬
                        </button>
                        <button onclick="regenerateVerificationCode()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 whitespace-nowrap">
                            <i class="fas fa-sync-alt mr-2"></i>ì¬ìƒì„±
                        </button>
                    </div>
                </div>
            </div>

            <!-- ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ ì„¹ì…˜ -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-clock text-yellow-600 mr-2"></i>ìŠ¹ì¸ ëŒ€ê¸° ì¤‘
                    </h3>
                    <span id="pendingBadge" class="px-3 py-1 bg-yellow-500 text-white rounded-full text-sm font-bold">0</span>
                </div>
                <div id="pendingList" class="space-y-4">
                    <div class="text-center text-gray-500 py-4">ë¡œë”© ì¤‘...</div>
                </div>
            </div>

            <!-- ë“±ë¡ëœ ì„ ìƒë‹˜ ì„¹ì…˜ -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-users text-green-600 mr-2"></i>ë“±ë¡ëœ ì„ ìƒë‹˜
                    </h3>
                    <button onclick="openAddTeacherModal()" class="px-6 py-3 gradient-purple text-white rounded-lg hover:opacity-90 font-semibold shadow-lg">
                        <i class="fas fa-user-plus mr-2"></i>ì„ ìƒë‹˜ ì¶”ê°€
                    </button>
                </div>
                <div id="teachersList" class="space-y-4">
                    <div class="text-center text-gray-500 py-4">ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- ì„ ìƒë‹˜ ì¶”ê°€ ëª¨ë‹¬ -->
        <div id="addTeacherModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-user-plus text-purple-600 mr-2"></i>ì„ ìƒë‹˜ ì¶”ê°€
                    </h3>
                    <button onclick="closeAddTeacherModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="addTeacherForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">
                            ì´ë¦„ <span class="text-red-500">*</span>
                        </label>
                        <input type="text" name="name" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="ê¹€ì„ ìƒ">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">
                            ì´ë©”ì¼ (íšŒì› ì•„ì´ë””) <span class="text-red-500">*</span>
                        </label>
                        <input type="email" name="email" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="teacher@example.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">
                            ì—°ë½ì²˜ <span class="text-red-500">*</span>
                        </label>
                        <input type="tel" name="phone" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="010-0000-0000">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">
                            ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ <span class="text-red-500">*</span>
                        </label>
                        <input type="password" name="password" required minlength="6" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="ìµœì†Œ 6ì">
                        <p class="text-xs text-gray-500 mt-1">ì„ ìƒë‹˜ì´ ë¡œê·¸ì¸ í›„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-900 mb-2">
                            ë‹´ë‹¹ ë°˜ ë°°ì • (ì„ íƒ)
                        </label>
                        <select name="class_id" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">ë‚˜ì¤‘ì— ë°°ì •</option>
                            <!-- ë°˜ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </select>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            ì„ ìƒë‹˜ ê³„ì •ì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ë©°, ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                    
                    <button type="submit" class="w-full gradient-purple text-white py-3 rounded-lg font-medium hover:opacity-90">
                        <i class="fas fa-check mr-2"></i>ì„ ìƒë‹˜ ì¶”ê°€í•˜ê¸°
                    </button>
                </form>
            </div>
        </div>

        <!-- ê¶Œí•œ ì„¤ì • ëª¨ë‹¬ -->
        <div id="permissionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-user-shield text-purple-600 mr-2"></i><span id="permissionsTeacherName"></span> ì„ ìƒë‹˜ ê¶Œí•œ ì„¤ì •
                    </h3>
                    <button onclick="closePermissionsModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <form id="permissionsForm" class="space-y-6">
                    <input type="hidden" id="permissionsTeacherId">
                    
                    <!-- ê¶Œí•œ ì„ íƒ (ë¼ë””ì˜¤ ë²„íŠ¼) - Updated for /teachers page -->
                    <div class="space-y-4">
                        <h4 class="font-semibold text-gray-900 text-lg mb-4">
                            <i class="fas fa-shield-alt text-purple-600 mr-2"></i>ì ‘ê·¼ ê¶Œí•œ ì„ íƒ
                        </h4>
                        
                        <!-- ì˜µì…˜ 1: ëª¨ë‘ ë‹¤ ê³µê°œ -->
                        <label class="block cursor-pointer">
                            <div class="border-2 border-gray-200 rounded-xl p-5 hover:border-purple-400 transition-colors" id="allAccessOption">
                                <div class="flex items-start">
                                    <input type="radio" name="accessLevel" value="all" id="accessLevelAll" class="mt-1 w-5 h-5 text-purple-600 focus:ring-purple-500">
                                    <div class="ml-4 flex-1">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-globe text-blue-600 mr-2 text-xl"></i>
                                            <span class="text-base font-bold text-gray-900">ëª¨ë‘ ë‹¤ ê³µê°œ</span>
                                        </div>
                                        <p class="text-sm text-gray-600 leading-relaxed">
                                            â€¢ ëª¨ë“  í•™ìƒ ì •ë³´ ì¡°íšŒ<br>
                                            â€¢ ëª¨ë“  ë°˜ ê´€ë¦¬<br>
                                            â€¢ ëª¨ë“  ê³¼ëª© ê´€ë¦¬<br>
                                            â€¢ ì „ì²´ ì¼ì¼ ì„±ê³¼ ì‘ì„±<br>
                                            â€¢ ëœë”©í˜ì´ì§€ ì ‘ê·¼
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </label>
                        
                        <!-- ì˜µì…˜ 2: ë°°ì •ëœ ë°˜ë§Œ ê³µê°œ -->
                        <label class="block cursor-pointer">
                            <div class="border-2 border-gray-200 rounded-xl p-5 hover:border-purple-400 transition-colors" id="assignedOnlyOption">
                                <div class="flex items-start">
                                    <input type="radio" name="accessLevel" value="assigned" id="accessLevelAssigned" class="mt-1 w-5 h-5 text-purple-600 focus:ring-purple-500">
                                    <div class="ml-4 flex-1">
                                        <div class="flex items-center mb-2">
                                            <i class="fas fa-users text-green-600 mr-2 text-xl"></i>
                                            <span class="text-base font-bold text-gray-900">ë°°ì •ëœ ë°˜ë§Œ ê³µê°œ</span>
                                        </div>
                                        <p class="text-sm text-gray-600 leading-relaxed mb-3">
                                            â€¢ ë°°ì •ëœ ë°˜ì˜ í•™ìƒë§Œ ì¡°íšŒ<br>
                                            â€¢ ë°°ì •ëœ ë°˜ì˜ ì¼ì¼ ì„±ê³¼ë§Œ ì‘ì„±<br>
                                            â€¢ ë°˜/ê³¼ëª© ê´€ë¦¬ ë¶ˆê°€<br>
                                            â€¢ ëœë”©í˜ì´ì§€ ì ‘ê·¼ ë¶ˆê°€
                                        </p>
                                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 mt-3">
                                            <p class="text-xs text-purple-800 font-medium mb-2">
                                                <i class="fas fa-info-circle mr-1"></i>ì´ ì˜µì…˜ì„ ì„ íƒí•˜ë©´ ì•„ë˜ì—ì„œ ë°˜ì„ ë°°ì •í•´ì£¼ì„¸ìš”:
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- ë°˜ ë°°ì • (ë°°ì •ëœ ë°˜ë§Œ ê³µê°œ ì„ íƒ ì‹œì—ë§Œ í™œì„±í™”) -->
                    <div id="classAssignmentSection" class="border border-gray-200 rounded-lg p-4 bg-gray-50" style="display: none;">
                        <h4 class="font-medium text-gray-900 mb-3">
                            <i class="fas fa-chalkboard text-purple-600 mr-2"></i>ë°˜ ë°°ì •
                        </h4>
                        <div id="classesCheckboxList" class="space-y-2 max-h-60 overflow-y-auto">
                            <div class="text-center text-gray-500 py-4">ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            ê¶Œí•œ ì„¤ì • í›„ ì„ ìƒë‹˜ì€ ì¦‰ì‹œ í•´ë‹¹ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="button" onclick="closePermissionsModal()" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">
                            <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                        </button>
                        <button type="submit" class="flex-1 gradient-purple text-white py-3 rounded-lg font-medium hover:opacity-90">
                            <i class="fas fa-save mr-2"></i>ì €ì¥
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            // Complete JavaScript for /teachers page - to replace lines 24599-24794
            
            let currentUser = null;
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
            window.addEventListener('DOMContentLoaded', () => {
                const userStr = localStorage.getItem('user');
                if (!userStr) {
                    window.location.href = '/login';
                    return;
                }
                
                currentUser = JSON.parse(userStr);
                console.log('Current user:', currentUser);
                
                loadPageData();
            });
            
            async function loadPageData() {
                loadVerificationCode();
                loadPendingApplications();
                loadTeachersList();
            }
            
            // ì¸ì¦ ì½”ë“œ ë¡œë“œ
            async function loadVerificationCode() {
                try {
                    const res = await fetch('/api/teachers/verification-code?directorId=' + currentUser.id);
                    const data = await res.json();
                    
                    if (data.success) {
                        const code = data.code || (data.codeData && (data.codeData.code || data.codeData.verification_code)) || '------';
                        document.getElementById('verificationCode').textContent = code;
                    }
                } catch (error) {
                    console.error('ì¸ì¦ ì½”ë“œ ë¡œë”© ì‹¤íŒ¨:', error);
                }
            }
            
            // ì¸ì¦ ì½”ë“œ ë³µì‚¬
            function copyVerificationCode() {
                const code = document.getElementById('verificationCode').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    alert('ì¸ì¦ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + code);
                });
            }
            
            // ì¸ì¦ ì½”ë“œ ì¬ìƒì„±
            async function regenerateVerificationCode() {
                if (!confirm('ì¸ì¦ ì½”ë“œë¥¼ ì¬ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nâš ï¸ ì´ì „ ì½”ë“œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.')) return;
                try {
                    const res = await fetch('/api/teachers/verification-code/regenerate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ directorId: currentUser.id })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        const newCode = data.code || (data.codeData && (data.codeData.code || data.codeData.verification_code));
                        document.getElementById('verificationCode').textContent = newCode;
                        alert('âœ… ì¸ì¦ ì½”ë“œê°€ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nìƒˆ ì½”ë“œ: ' + newCode);
                    } else {
                        alert('âŒ ì½”ë“œ ì¬ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                } catch (error) {
                    alert('ì½”ë“œ ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
            
            // ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ë¡œë“œ
            async function loadPendingApplications() {
                try {
                    const res = await fetch('/api/teachers/applications?directorId=' + currentUser.id + '&status=pending');
                    const data = await res.json();
                    const container = document.getElementById('pendingList');
                    const countBadge = document.getElementById('pendingBadge');
                    const pendingCount = document.getElementById('pendingCount');
                    
                    if (!data.success || !data.applications || data.applications.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-500 py-8">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        countBadge.textContent = '0';
                        pendingCount.textContent = '0';
                        return;
                    }
            
                    countBadge.textContent = data.applications.length;
                    pendingCount.textContent = data.applications.length;
                    container.innerHTML = data.applications.map(app => {
                        const escapedName = (app.name || '').replace(/'/g, "\\'");
                        return \`
                        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-gray-900">\${app.name}</h3>
                                    <p class="text-sm text-gray-600">\${app.email}</p>
                                    <p class="text-sm text-gray-500">\${app.phone || '-'}</p>
                                    <p class="text-xs text-gray-400 mt-2">ì‹ ì²­ì¼: \${new Date(app.applied_at).toLocaleString('ko-KR')}</p>
                                </div>
                                <span class="px-3 py-1 bg-yellow-500 text-white rounded-full text-xs font-medium">
                                    ëŒ€ê¸°ì¤‘
                                </span>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="approveApplication(\${app.id}, '\${escapedName}')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    <i class="fas fa-check mr-2"></i>ìŠ¹ì¸
                                </button>
                                <button onclick="rejectApplication(\${app.id}, '\${escapedName}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                    <i class="fas fa-times mr-2"></i>ê±°ì ˆ
                                </button>
                            </div>
                        </div>
                        \`;
                    }).join('');
                } catch (error) {
                    console.error('ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
                }
            }
            
            // ì„ ìƒë‹˜ ìŠ¹ì¸
            async function approveApplication(id, name) {
                if (!confirm(\`\${name} ì„ ìƒë‹˜ì˜ ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) return;
                try {
                    const res = await fetch(\`/api/teachers/applications/\${id}/approve\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ directorId: currentUser.id })
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert(\`\${name} ì„ ìƒë‹˜ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!\`);
                        loadPendingApplications();
                        loadTeachersList();
                    } else {
                        alert('ìŠ¹ì¸ ì‹¤íŒ¨: ' + data.error);
                    }
                } catch (error) {
                    alert('ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            // ì„ ìƒë‹˜ ê±°ì ˆ
            async function rejectApplication(id, name) {
                if (!confirm(\`\${name} ì„ ìƒë‹˜ì˜ ì‹ ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) return;
                const reason = prompt('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­):');
                try {
                    const res = await fetch(\`/api/teachers/applications/\${id}/reject\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            directorId: currentUser.id,
                            reason: reason || 'ìŠ¹ì¸ ê±°ë¶€'
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert(\`\${name} ì„ ìƒë‹˜ì˜ ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.\`);
                        loadPendingApplications();
                    } else {
                        alert('ê±°ì ˆ ì‹¤íŒ¨: ' + data.error);
                    }
                } catch (error) {
                    alert('ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            // ë“±ë¡ëœ ì„ ìƒë‹˜ ëª©ë¡ ë¡œë“œ
            async function loadTeachersList() {
                try {
                    const res = await fetch('/api/teachers/list?directorId=' + currentUser.id);
                    const data = await res.json();
                    const container = document.getElementById('teachersList');
                    const totalCount = document.getElementById('totalTeachers');
                    const assignedCount = document.getElementById('assignedCount');
                    
                    if (!data.success || data.teachers.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-500 py-8">ë“±ë¡ëœ ì„ ìƒë‹˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        totalCount.textContent = '0';
                        assignedCount.textContent = '0';
                        return;
                    }
            
                    totalCount.textContent = data.teachers.length;
                    let assignedCounter = 0;
                    data.teachers.forEach(t => {
                        if (t.class_count && t.class_count > 0) assignedCounter++;
                    });
                    assignedCount.textContent = assignedCounter;
            
                    container.innerHTML = data.teachers.map(teacher => {
                        const escapedName = (teacher.name || '').replace(/'/g, "\\'");
                        return \`
                        <div class="bg-white border rounded-xl p-6 hover:shadow-lg transition">
                            <div class="flex items-start justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 bg-purple-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user-tie text-purple-600 text-2xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-900">\${teacher.name}</h3>
                                        <p class="text-sm text-gray-600">\${teacher.email}</p>
                                        <p class="text-sm text-gray-500">\${teacher.phone || '-'}</p>
                                        <span class="inline-block mt-2 px-3 py-1 bg-purple-100 text-purple-600 rounded-full text-xs font-medium">
                                            ë‹´ë‹¹ ë°˜: \${teacher.class_count || 0}ê°œ
                                        </span>
                                    </div>
                                </div>
                                <button onclick="showTeacherPermissions(\${teacher.id}, '\${escapedName}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    <i class="fas fa-cog mr-2"></i>ê¶Œí•œ ì„¤ì •
                                </button>
                            </div>
                        </div>
                        \`;
                    }).join('');
                } catch (error) {
                    console.error('ì„ ìƒë‹˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
                }
            }
            
            // ì„ ìƒë‹˜ ì¶”ê°€ ëª¨ë‹¬
            function openAddTeacherModal() {
                document.getElementById('addTeacherModal').classList.remove('hidden');
            }
            
            function closeAddTeacherModal() {
                document.getElementById('addTeacherModal').classList.add('hidden');
                document.getElementById('addTeacherForm').reset();
            }
            
            document.getElementById('addTeacherForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const data = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    password: formData.get('password'),
                    directorId: currentUser.id
                };
            
                try {
                    const res = await fetch('/api/teachers/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await res.json();
                    
                    if (result.success) {
                        alert(\`\${data.name} ì„ ìƒë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\`);
                        closeAddTeacherModal();
                        loadTeachersList();
                    } else {
                        alert('ì¶”ê°€ ì‹¤íŒ¨: ' + result.error);
                    }
                } catch (error) {
                    alert('ì„ ìƒë‹˜ ì¶”ê°€ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            });
            
            // ê¶Œí•œ ì„¤ì • ëª¨ë‹¬
            async function showTeacherPermissions(teacherId, teacherName) {
                document.getElementById('permissionsModal').classList.remove('hidden');
                document.getElementById('permissionsTeacherName').textContent = teacherName;
                document.getElementById('permissionsTeacherId').value = teacherId;
                
                try {
                    // ë°˜ ëª©ë¡ ë¡œë“œ - /api/classes/list ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                    const classesRes = await fetch(\`/api/classes/list?userId=\${currentUser.id}&userType=director\`);
                    const classesData = await classesRes.json();
                    
                    console.log('[Teachers Page] Classes loaded:', classesData);
                    
                    if (classesData.success) {
                        const classList = document.getElementById('classesCheckboxList');
                        if (classesData.classes && classesData.classes.length > 0) {
                            classList.innerHTML = classesData.classes.map(cls => \`
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="\${cls.id}" class="class-checkbox w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="ml-2 text-sm text-gray-700">\${cls.class_name || cls.name} \${cls.grade || cls.grade_level ? '(' + (cls.grade || cls.grade_level) + ')' : ''}</span>
                                </label>
                            \`).join('');
                        } else {
                            classList.innerHTML = '<div class="text-center text-gray-500 py-4">ë“±ë¡ëœ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                        }
                    }
                    
                    // ì„ ìƒë‹˜ ê¶Œí•œ ì •ë³´ ë¡œë“œ
                    const permRes = await fetch(\`/api/teachers/\${teacherId}/permissions?directorId=\${currentUser.id}\`);
                    const permData = await permRes.json();
                    
                    console.log('[Teachers Page] Permissions loaded:', permData);
                    
                    if (permData.success) {
                        const hasFullAccess = permData.permissions?.canViewAllStudents || false;
                        const assignedClasses = permData.permissions?.assignedClasses || [];
                        
                        // ë¼ë””ì˜¤ ë²„íŠ¼ ì„¤ì •
                        if (hasFullAccess) {
                            document.getElementById('accessLevelAll').checked = true;
                            document.getElementById('classAssignmentSection').style.display = 'none';
                            document.getElementById('allAccessOption').classList.add('border-purple-500', 'bg-purple-50');
                            document.getElementById('assignedOnlyOption').classList.remove('border-purple-500', 'bg-purple-50');
                        } else if (assignedClasses.length > 0) {
                            document.getElementById('accessLevelAssigned').checked = true;
                            document.getElementById('classAssignmentSection').style.display = 'block';
                            document.getElementById('assignedOnlyOption').classList.add('border-purple-500', 'bg-purple-50');
                            document.getElementById('allAccessOption').classList.remove('border-purple-500', 'bg-purple-50');
                            
                            // ë°°ì •ëœ ë°˜ ì²´í¬
                            document.querySelectorAll('.class-checkbox').forEach(checkbox => {
                                checkbox.checked = assignedClasses.includes(parseInt(checkbox.value));
                            });
                        } else {
                            // ê¶Œí•œ ì—†ìŒ
                            document.getElementById('accessLevelAll').checked = false;
                            document.getElementById('accessLevelAssigned').checked = false;
                            document.getElementById('classAssignmentSection').style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('[Teachers Page] ê¶Œí•œ ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('ê¶Œí•œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
            
            // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.addEventListener('DOMContentLoaded', function() {
                const allAccessRadio = document.getElementById('accessLevelAll');
                const assignedRadio = document.getElementById('accessLevelAssigned');
                const classSection = document.getElementById('classAssignmentSection');
                const allOption = document.getElementById('allAccessOption');
                const assignedOption = document.getElementById('assignedOnlyOption');
                
                if (allAccessRadio) {
                    allAccessRadio.addEventListener('change', function() {
                        if (this.checked) {
                            classSection.style.display = 'none';
                            allOption.classList.add('border-purple-500', 'bg-purple-50');
                            assignedOption.classList.remove('border-purple-500', 'bg-purple-50');
                        }
                    });
                }
                
                if (assignedRadio) {
                    assignedRadio.addEventListener('change', function() {
                        if (this.checked) {
                            classSection.style.display = 'block';
                            assignedOption.classList.add('border-purple-500', 'bg-purple-50');
                            allOption.classList.remove('border-purple-500', 'bg-purple-50');
                        }
                    });
                }
            });
            
            function closePermissionsModal() {
                document.getElementById('permissionsModal').classList.add('hidden');
                document.getElementById('permissionsForm').reset();
                document.getElementById('classAssignmentSection').style.display = 'none';
                document.getElementById('allAccessOption').classList.remove('border-purple-500', 'bg-purple-50');
                document.getElementById('assignedOnlyOption').classList.remove('border-purple-500', 'bg-purple-50');
            }
            
            // ê¶Œí•œ ì €ì¥ - ì•„ë˜ 37046ë²ˆ ì¤„ì— ë” ìƒì„¸í•œ ë²„ì „ì´ ìˆìœ¼ë¯€ë¡œ ì´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆëŠ” ì œê±°ë¨
            
        </script>
    </body>
    </html>
  `)
})

// ğŸ›’ ì¸ìŠ¤íƒ€ê·¸ë¨ ìƒí’ˆ êµ¬ë§¤ API
app.post('/api/store/purchase-instagram', async (c) => {
  try {
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      return c.json({ success: false, error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤' }, 401)
    }

    const DB = c.env.DB
    
    // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì ì¡°íšŒ
    const session = await DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ?
    `).bind(sessionId).first()

    if (!session) {
      return c.json({ success: false, error: 'ìœ íš¨í•˜ì§€ ì•Šì€ ì„¸ì…˜ì…ë‹ˆë‹¤' }, 401)
    }

    const userId = session.user_id

    // ìš”ì²­ ë°ì´í„°
    const { productKey, optionName, price, quantity, targetUrl, apiKey } = await c.req.json()

    if (!productKey || !optionName || !price || !quantity || !targetUrl) {
      return c.json({ success: false, error: 'í•„ìˆ˜ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤' }, 400)
    }

    // ì´ ë¹„ìš© ê³„ì‚°
    const totalCost = price * quantity

    // ì‚¬ìš©ì í¬ì¸íŠ¸ ì¡°íšŒ
    const user = await DB.prepare(`
      SELECT balance FROM users WHERE id = ?
    `).bind(userId).first()

    if (!user) {
      return c.json({ success: false, error: 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤' }, 404)
    }

    if (user.balance < totalCost) {
      return c.json({ 
        success: false, 
        error: `í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (ë³´ìœ : ${user.balance.toLocaleString()}ì›, í•„ìš”: ${totalCost.toLocaleString()}ì›)` 
      }, 400)
    }

    // í¬ì¸íŠ¸ ì°¨ê°
    const newBalance = user.balance - totalCost
    await DB.prepare(`
      UPDATE users SET balance = ? WHERE id = ?
    `).bind(newBalance, userId).run()

    // ì£¼ë¬¸ ìƒì„±
    const productName = `ì¸ìŠ¤íƒ€ê·¸ë¨ ${productKey} - ${optionName}`
    const orderInsert = await DB.prepare(`
      INSERT INTO store_orders (
        user_id, product_name, product_key, option_name, 
        quantity, unit_price, total_price, target_url,
        status, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'pending', CURRENT_TIMESTAMP)
    `).bind(
      userId, productName, productKey, optionName,
      quantity, price, totalCost, targetUrl
    ).run()

    const orderId = orderInsert.meta.last_row_id

    // í¬ì¸íŠ¸ ê±°ë˜ ê¸°ë¡
    const balanceBefore = user.balance
    const balanceAfter = newBalance
    await DB.prepare(`
      INSERT INTO point_transactions (
        user_id, amount, balance_before, balance_after,
        transaction_type, description, created_at
      ) VALUES (?, ?, ?, ?, 'purchase', ?, CURRENT_TIMESTAMP)
    `).bind(
      userId, -totalCost, balanceBefore, balanceAfter,
      `ìŠ¤í† ì–´ êµ¬ë§¤: ${productName}`
    ).run()

    console.log(`[Store] Instagram purchase - User: ${userId}, Product: ${productName}, Quantity: ${quantity}, Cost: ${totalCost}`)

    return c.json({
      success: true,
      message: 'êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤',
      orderId,
      remainingPoints: newBalance
    })

  } catch (err: any) {
    console.error('[Store] Purchase error:', err)
    return c.json({ success: false, error: 'êµ¬ë§¤ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message }, 500)
  }
})

// ğŸ›’ ì†Œì…œ íŠ¸ë˜í”½ ìŠ¤í† ì–´ í˜ì´ì§€
app.get('/store', (c) => {
  return c.html(`<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œì…œ íŠ¸ë˜í”½ ìŠ¤í† ì–´ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Pretendard', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background: #f8f9fa;
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* í—¤ë” */
        .header {
            background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%);
            border-radius: 20px;
            padding: 40px 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            text-align: center;
            position: relative;
        }
        .home-link {
            position: absolute;
            top: 20px;
            left: 30px;
            background: white;
            color: #667eea;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .home-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        .header-title {
            font-size: 32px;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }
        .header-subtitle {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 20px;
        }
        .points-display {
            background: white;
            padding: 12px 24px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }
        
        /* ì¹´í…Œê³ ë¦¬ */
        .categories {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        .categories::-webkit-scrollbar {
            display: none;
        }
        .category-btn {
            padding: 10px 24px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }
        .category-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }
        .category-btn.active {
            background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%);
            border-color: transparent;
            color: white;
        }
        
        /* ìƒí’ˆ ê·¸ë¦¬ë“œ */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .product-content {
            padding: 20px;
        }
        .product-name {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }
        .product-description {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .product-price {
            font-size: 28px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 20px;
        }
        .product-options-count {
            display: inline-block;
            background: #f0f4ff;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .buy-btn {
            width: 100%;
            background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .buy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }
        
        /* ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 550px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        .modal-header {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 8px;
        }
        .modal-subheader {
            font-size: 14px;
            color: #666;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-input::placeholder {
            color: #999;
        }
        .price-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 15px;
        }
        .price-row:last-child {
            margin-bottom: 0;
            padding-top: 10px;
            border-top: 2px solid #e0e0e0;
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
        }
        .price-label {
            color: #666;
        }
        .price-value {
            font-weight: 600;
            color: #333;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #666;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .btn-primary {
            background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: scale(1.05);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ì£¼ë¬¸ ë‚´ì—­ */
        .my-orders {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .my-orders h2 {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .order-item:last-child {
            border-bottom: none;
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }
        .order-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }
        .order-status {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .status-processing {
            background: #dbeafe;
            color: #1e40af;
        }
        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }
        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }
        .order-details {
            font-size: 13px;
            color: #666;
        }
        
        /* í‘¸í„° */
        .footer {
            background: #2d3748;
            color: white;
            padding: 40px 20px 20px;
            margin-top: 60px;
            border-radius: 20px 20px 0 0;
        }
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        .footer-info {
            margin-bottom: 30px;
        }
        .footer-company {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        .footer-details {
            font-size: 14px;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.8);
        }
        .footer-details p {
            margin-bottom: 5px;
        }
        .footer-copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 30px 20px;
            }
            .home-link {
                position: static;
                margin-bottom: 15px;
                display: inline-block;
            }
            .header-title {
                font-size: 24px;
            }
            .products-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <a href="/" class="home-link">ğŸ  í™ˆìœ¼ë¡œ</a>
            <div class="header-title">ì†Œì…œ íŠ¸ë˜í”½ ìŠ¤í† ì–´</div>
            <div class="header-subtitle">ì¸ìŠ¤íƒ€ê·¸ë¨ íŒ”ë¡œì›Œ, ì¢‹ì•„ìš”, ì¡°íšŒìˆ˜ ë“± ë‹¤ì–‘í•œ ì†Œì…œ ì„œë¹„ìŠ¤</div>
            <div class="points-display">
                ğŸ’° ë³´ìœ  í¬ì¸íŠ¸: <span id="points-balance">0</span> P
            </div>
        </div>

        <div id="store-content">
            <!-- ì¹´í…Œê³ ë¦¬ -->
            <div class="categories">
                <button class="category-btn active" data-category="all">ì „ì²´</button>
                <button class="category-btn" data-category="instagram">ğŸ“¸ ì¸ìŠ¤íƒ€ê·¸ë¨</button>
                <button class="category-btn" data-category="youtube">â–¶ï¸ ìœ íŠœë¸Œ</button>
                <button class="category-btn" data-category="facebook">ğŸ‘¥ í˜ì´ìŠ¤ë¶</button>
                <button class="category-btn" data-category="threads">ğŸ§µ ì“°ë ˆë“œ</button>
                <button class="category-btn" data-category="naver">ğŸŸ¢ ë„¤ì´ë²„</button>
            </div>

            <!-- ìƒí’ˆ ê·¸ë¦¬ë“œ -->
            <div class="products-grid" id="products-grid">
                <!-- ë™ì ìœ¼ë¡œ ë¡œë“œ -->
            </div>

            <!-- ì£¼ë¬¸ ë‚´ì—­ -->
            <div class="my-orders">
                <h2>ìµœê·¼ ì£¼ë¬¸ ë‚´ì—­</h2>
                <div id="orders-list">
                    <!-- ë™ì ìœ¼ë¡œ ë¡œë“œ -->
                </div>
            </div>
        </div>
    </div>

    <!-- í‘¸í„° -->
    <div class="footer">
        <div class="footer-content">
            <div class="footer-info">
                <div class="footer-company">ì£¼ì‹íšŒì‚¬ ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</div>
                <div class="footer-details">
                    <p>ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 142-88-02445</p>
                    <p>ì£¼ì†Œ: ì¸ì²œê´‘ì—­ì‹œ ì„œêµ¬ ì²­ë¼ì»¤ë‚¼ë¡œ 270, 2ì¸µ</p>
                    <p>ì´ë©”ì¼: wangholy1@naver.com</p>
                    <p>ì „í™”: 010-8739-9697</p>
                </div>
            </div>
            <div class="footer-copyright">
                Â© 2024 ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤. All rights reserved.
            </div>
        </div>
    </div>

    <script>
        const API_KEY = '14644c03bef19a85e4867e6d1d7939a1';
        let allProducts = [];
        let currentCategory = 'all';
        
        // ì¸ìŠ¤íƒ€ê·¸ë¨ ì œí’ˆ ì •ì˜ (ì´ë¯¸ì§€ í¬í•¨)
        const instagramProducts = [
            {
                id: 'ig_follower',
                name: 'ì¸ìŠ¤íƒ€ê·¸ë¨ íŒ”ë¡œì›Œ',
                category: 'instagram',
                description: 'ì‹¤ì œ í•œêµ­ì¸ íŒ”ë¡œì›Œë¶€í„° íƒ€ê²ŸíŒ…ëœ íŒ”ë¡œì›Œê¹Œì§€',
                image: 'https://www.genspark.ai/api/files/s/FiTBsr2a',
                options: [
                    { name: 'ì‹¤ì œ í•œêµ­ì¸ íŒ”ë¡œì›Œ', price: 220 },
                    { name: '[ë‚¨ì„±] í•œêµ­ì¸ íŒ”ë¡œì›Œ', price: 280 },
                    { name: '[ì—¬ì„±] í•œêµ­ì¸ íŒ”ë¡œì›Œ', price: 280 },
                    { name: '[20ëŒ€] í•œêµ­ì¸ íŒ”ë¡œì›Œ', price: 280 },
                    { name: '[30ëŒ€] í•œêµ­ì¸ íŒ”ë¡œì›Œ', price: 280 },
                    { name: '[20ëŒ€/ë‚¨ì„±] ì‹¤ì œ í•œêµ­ì¸ íŒ”ë¡œì›Œ', price: 440 },
                    { name: '[20ëŒ€/ì—¬ì„±] ì‹¤ì œ í•œêµ­ì¸ íŒ”ë¡œì›Œ', price: 440 },
                    { name: '[30ëŒ€/ë‚¨ì„±] ì‹¤ì œ í•œêµ­ì¸ íŒ”ë¡œì›Œ', price: 440 },
                    { name: '[30ëŒ€/ì—¬ì„±] ì‹¤ì œ í•œêµ­ì¸ íŒ”ë¡œì›Œ', price: 440 },
                    { name: 'ì™¸êµ­ì¸ íŒ”ë¡œì›Œ', price: 20 }
                ]
            },
            {
                id: 'ig_likes',
                name: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ì¢‹ì•„ìš”',
                category: 'instagram',
                description: 'ê²Œì‹œë¬¼ ì¢‹ì•„ìš” - ì™¸êµ­ì¸ë¶€í„° íƒ€ê²Ÿ í•œêµ­ì¸ê¹Œì§€',
                image: 'https://www.genspark.ai/api/files/s/FiTBsr2a',
                options: [
                    { name: 'ì™¸êµ­ì¸ ì¢‹ì•„ìš”', price: 2.5 },
                    { name: 'í•œêµ­ì¸ ì¢‹ì•„ìš”', price: 25 },
                    { name: '[ë‚¨ì„±] ì‹¤ì œ í•œêµ­ì¸ ì¢‹ì•„ìš”', price: 33 },
                    { name: '[ì—¬ì„±] ì‹¤ì œ í•œêµ­ì¸ ì¢‹ì•„ìš”', price: 33 },
                    { name: '[20ëŒ€] ì‹¤ì œ í•œêµ­ì¸ ì¢‹ì•„ìš”', price: 33 },
                    { name: '[30ëŒ€] ì‹¤ì œ í•œêµ­ì¸ ì¢‹ì•„ìš”', price: 33 },
                    { name: '[20ëŒ€/ë‚¨ì„±] ì‹¤ì œ í•œêµ­ì¸ ì¢‹ì•„ìš”', price: 44 },
                    { name: '[20ëŒ€/ì—¬ì„±] ì‹¤ì œ í•œêµ­ì¸ ì¢‹ì•„ìš”', price: 44 },
                    { name: '[30ëŒ€/ë‚¨ì„±] ì‹¤ì œ í•œêµ­ì¸ ì¢‹ì•„ìš”', price: 44 },
                    { name: '[30ëŒ€/ì—¬ì„±] ì‹¤ì œ í•œêµ­ì¸ ì¢‹ì•„ìš”', price: 44 }
                ]
            },
            {
                id: 'ig_views',
                name: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ì¡°íšŒìˆ˜',
                category: 'instagram',
                description: 'ì‹¤ì œ í•œêµ­ì¸ ì¡°íšŒìˆ˜',
                image: 'https://www.genspark.ai/api/files/s/FiTBsr2a',
                options: [
                    { name: 'ì‹¤ì œ í•œêµ­ì¸ ì¡°íšŒìˆ˜', price: 0.4 }
                ]
            },
            {
                id: 'ig_engagement',
                name: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ê³µìœ /ì €ì¥',
                category: 'instagram',
                description: 'ê²Œì‹œë¬¼ ê³µìœ , ì €ì¥, ë…¸ì¶œ ë“±',
                image: 'https://www.genspark.ai/api/files/s/FiTBsr2a',
                options: [
                    { name: 'í•œêµ­ì¸ ê²Œì‹œë¬¼ ê³µìœ ', price: 1 },
                    { name: 'í•œêµ­ì¸ ê²Œì‹œë¬¼ ì €ì¥', price: 4 },
                    { name: 'ì¼ë°˜ ê²Œì‹œë¬¼ ì €ì¥', price: 0.6 },
                    { name: 'ì¼ë°˜ ê²Œì‹œë¬¼ ë…¸ì¶œ/ë„ë‹¬', price: 0.6 },
                    { name: 'ì¼ë°˜ ê²Œì‹œë¬¼ í”„ë¡œí•„ë°©ë¬¸', price: 0.9 }
                ]
            },
            {
                id: 'ig_comments',
                name: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ëŒ“ê¸€',
                category: 'instagram',
                description: 'ì‹¤ì œ í•œêµ­ì¸ ëŒ“ê¸€ - íƒ€ê²ŸíŒ… ê°€ëŠ¥',
                image: 'https://www.genspark.ai/api/files/s/FiTBsr2a',
                options: [
                    { name: 'ì‹¤ì œ í•œêµ­ì¸ ëŒ“ê¸€', price: 280 },
                    { name: 'í•œêµ­ì¸ ì»¤ìŠ¤í…€ ëŒ“ê¸€', price: 280 },
                    { name: '[ë‚¨ì„±] ì‹¤ì œ í•œêµ­ì¸ ëŒ“ê¸€', price: 420 },
                    { name: '[ì—¬ì„±] ì‹¤ì œ í•œêµ­ì¸ ëŒ“ê¸€', price: 420 },
                    { name: '[20ëŒ€] ì‹¤ì œ í•œêµ­ì¸ ëŒ“ê¸€', price: 420 },
                    { name: '[30ëŒ€] ì‹¤ì œ í•œêµ­ì¸ ëŒ“ê¸€', price: 420 },
                    { name: '[20ëŒ€/ë‚¨ì„±] ì‹¤ì œ í•œêµ­ì¸ ëŒ“ê¸€', price: 480 },
                    { name: '[20ëŒ€/ì—¬ì„±] ì‹¤ì œ í•œêµ­ì¸ ëŒ“ê¸€', price: 480 },
                    { name: '[30ëŒ€/ë‚¨ì„±] ì‹¤ì œ í•œêµ­ì¸ ëŒ“ê¸€', price: 480 },
                    { name: '[30ëŒ€/ì—¬ì„±] ì‹¤ì œ í•œêµ­ì¸ ëŒ“ê¸€', price: 480 }
                ]
            }
        ];

        // ì´ˆê¸°í™”
        async function init() {
            await loadPoints();
            await loadProducts();
            await loadOrders();
        }

        // í¬ì¸íŠ¸ ì¡°íšŒ
        async function loadPoints() {
            try {
                const res = await fetch('/api/points/balance');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('points-balance').textContent = data.balance.toLocaleString();
                }
            } catch (err) {
                console.error('Failed to load points:', err);
            }
        }

        // ìƒí’ˆ ëª©ë¡ ì¡°íšŒ
        async function loadProducts() {
            try {
                allProducts = [...instagramProducts];
                
                // DB ì œí’ˆë„ ë¶ˆëŸ¬ì˜¤ê¸° (ë‹¤ë¥¸ ì¹´í…Œê³ ë¦¬ìš©)
                try {
                    const res = await fetch('/api/store/products');
                    const data = await res.json();
                    
                    if (data.success && data.products) {
                        const otherProducts = data.products.filter(p => p.category !== 'instagram');
                        allProducts = [...allProducts, ...otherProducts];
                    }
                } catch (err) {
                    console.log('DB products not available');
                }
                
                renderProducts();
            } catch (err) {
                console.error('Failed to load products:', err);
                allProducts = [...instagramProducts];
                renderProducts();
            }
        }

        // ìƒí’ˆ ë Œë”ë§
        function renderProducts() {
            const grid = document.getElementById('products-grid');
            const filtered = currentCategory === 'all' 
                ? allProducts 
                : allProducts.filter(p => p.category === currentCategory);

            if (filtered.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 60px; color: #999; font-size: 16px;">ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            grid.innerHTML = filtered.map(product => {
                if (product.options) {
                    // ì˜µì…˜ì´ ìˆëŠ” ì œí’ˆ (ì¸ìŠ¤íƒ€ê·¸ë¨)
                    const minPrice = Math.min(...product.options.map(o => o.price));
                    const maxPrice = Math.max(...product.options.map(o => o.price));
                    const priceText = minPrice === maxPrice ? 
                        minPrice.toLocaleString() + 'ì›' : 
                        minPrice.toLocaleString() + 'ì› ~ ' + maxPrice.toLocaleString() + 'ì›';
                    
                    return \`
                        <div class="product-card">
                            <img src="\${product.image}" alt="\${product.name}" class="product-image">
                            <div class="product-content">
                                <div class="product-name">\${product.name}</div>
                                <div class="product-description">\${product.description}</div>
                                <div class="product-price">\${priceText}</div>
                                <div class="product-options-count">
                                    \${product.options.length}ê°œ ì˜µì…˜
                                </div>
                                <button class="buy-btn" onclick="openPurchaseModal('\${product.id}')">
                                    ì˜µì…˜ ì„ íƒí•˜ê³  êµ¬ë§¤í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    \`;
                } else {
                    // ì¼ë°˜ ì œí’ˆ
                    return \`
                        <div class="product-card">
                            <div class="product-content">
                                <div class="product-name">\${product.name}</div>
                                <div class="product-description">\${product.description}</div>
                                <div class="product-price">\${product.price.toLocaleString()}ì›</div>
                                <button class="buy-btn" onclick="buyProduct('\${product.id}')">
                                    êµ¬ë§¤í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    \`;
                }
            }).join('');
        }

        // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = btn.dataset.category;
                    renderProducts();
                });
            });
        });

        // êµ¬ë§¤ ëª¨ë‹¬ ì—´ê¸° (ì¸ìŠ¤íƒ€ê·¸ë¨ ì˜µì…˜ ì„ íƒ í¼)
        function openPurchaseModal(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = \`
                <div class="modal-content">
                    <div class="modal-header">\${product.name}</div>
                    <div class="modal-subheader">\${product.description}</div>
                    
                    <div class="form-group">
                        <label class="form-label">ì˜µì…˜ ì„ íƒ</label>
                        <select class="form-select" id="option-select">
                            <option value="">ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            \${product.options.map((opt, idx) => 
                                \`<option value="\${idx}">\${opt.name} - \${opt.price.toLocaleString()}ì›</option>\`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ì¸ìŠ¤íƒ€ê·¸ë¨ URL</label>
                        <input type="text" class="form-input" id="target-url" 
                               placeholder="ì˜ˆ: https://instagram.com/yourpage">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ìˆ˜ëŸ‰</label>
                        <input type="number" class="form-input" id="quantity" 
                               value="1000" min="1" step="1">
                    </div>
                    
                    <div class="price-info" id="price-info" style="display: none;">
                        <div class="price-row">
                            <span class="price-label">ë‹¨ê°€</span>
                            <span class="price-value" id="unit-price">-</span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">ìˆ˜ëŸ‰</span>
                            <span class="price-value" id="quantity-display">-</span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">ì´ ê¸ˆì•¡</span>
                            <span class="price-value" id="total-price">-</span>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                        <button class="btn btn-primary" id="purchase-btn" disabled 
                                onclick="completePurchase('\${productId}')">êµ¬ë§¤í•˜ê¸°</button>
                    </div>
                </div>
            \`;
            
            document.body.appendChild(modal);
            
            // ì˜µì…˜, ìˆ˜ëŸ‰ ë³€ê²½ ì‹œ ê°€ê²© ì—…ë°ì´íŠ¸
            const optionSelect = modal.querySelector('#option-select');
            const quantityInput = modal.querySelector('#quantity');
            const purchaseBtn = modal.querySelector('#purchase-btn');
            
            function updatePrice() {
                const optionIdx = optionSelect.value;
                const quantity = parseInt(quantityInput.value) || 0;
                
                if (optionIdx !== '' && quantity > 0) {
                    const option = product.options[parseInt(optionIdx)];
                    const total = option.price * quantity;
                    
                    modal.querySelector('#unit-price').textContent = option.price.toLocaleString() + 'ì›';
                    modal.querySelector('#quantity-display').textContent = quantity.toLocaleString() + 'ê°œ';
                    modal.querySelector('#total-price').textContent = total.toLocaleString() + 'ì›';
                    modal.querySelector('#price-info').style.display = 'block';
                    purchaseBtn.disabled = false;
                } else {
                    modal.querySelector('#price-info').style.display = 'none';
                    purchaseBtn.disabled = true;
                }
            }
            
            optionSelect.addEventListener('change', updatePrice);
            quantityInput.addEventListener('input', updatePrice);
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) modal.remove();
        }

        // êµ¬ë§¤ ì™„ë£Œ
        async function completePurchase(productId) {
            const product = allProducts.find(p => p.id === productId);
            const optionIdx = document.getElementById('option-select').value;
            const targetUrl = document.getElementById('target-url').value;
            const quantity = parseInt(document.getElementById('quantity').value);
            
            if (optionIdx === '' || !targetUrl || !quantity) {
                alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const option = product.options[parseInt(optionIdx)];
            const totalCost = option.price * quantity;
            
            if (!confirm(\`\${product.name} - \${option.name}\nìˆ˜ëŸ‰: \${quantity.toLocaleString()}ê°œ\nì´ \${totalCost.toLocaleString()}ì›ì„ ê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) {
                return;
            }
            
            try {
                const res = await fetch('/api/store/purchase-instagram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productKey: productId,
                        optionName: option.name,
                        price: option.price,
                        quantity: quantity,
                        targetUrl: targetUrl,
                        apiKey: API_KEY
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert(\`êµ¬ë§¤ ì™„ë£Œ!\nì‚¬ìš© í¬ì¸íŠ¸: \${totalCost.toLocaleString()}ì›\në‚¨ì€ í¬ì¸íŠ¸: \${data.remainingPoints.toLocaleString()}ì›\`);
                    closeModal();
                    await loadPoints();
                    await loadOrders();
                } else {
                    alert('êµ¬ë§¤ ì‹¤íŒ¨: ' + data.error);
                }
            } catch (err) {
                alert('êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
            }
        }

        // ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ
        async function loadOrders() {
            try {
                const res = await fetch('/api/store/orders');
                const data = await res.json();
                
                if (data.success && data.orders && data.orders.length > 0) {
                    const ordersList = document.getElementById('orders-list');
                    ordersList.innerHTML = data.orders.slice(0, 10).map(order => {
                        const statusClass = {
                            'pending': 'status-pending',
                            'processing': 'status-processing',
                            'completed': 'status-completed',
                            'failed': 'status-failed'
                        }[order.status] || 'status-pending';
                        
                        const statusText = {
                            'pending': 'ëŒ€ê¸° ì¤‘',
                            'processing': 'ì²˜ë¦¬ ì¤‘',
                            'completed': 'ì™„ë£Œ',
                            'failed': 'ì‹¤íŒ¨'
                        }[order.status] || order.status;
                        
                        return \`
                            <div class="order-item">
                                <div class="order-header">
                                    <div class="order-name">\${order.product_name}</div>
                                    <div class="order-status \${statusClass}">\${statusText}</div>
                                </div>
                                <div class="order-details">
                                    ìˆ˜ëŸ‰: \${order.quantity.toLocaleString()}ê°œ | 
                                    ê¸ˆì•¡: \${order.total_price.toLocaleString()}ì› | 
                                    \${new Date(order.created_at).toLocaleString('ko-KR')}
                                </div>
                            </div>
                        \`;
                    }).join('');
                } else {
                    document.getElementById('orders-list').innerHTML = 
                        '<p style="text-align: center; padding: 40px; color: #999;">ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } catch (err) {
                console.error('Failed to load orders:', err);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        init();
    </script>
</body>
</html>
`);
});

// Redirect /students/ to /students (remove trailing slash)
app.get('/students/', (c) => {
  return c.redirect('/students', 301);
});

app.get('/students', (c) => {
  // ìºì‹œ ë¬´íš¨í™” í—¤ë” ì¶”ê°€
  c.header('Cache-Control', 'no-cache, no-store, must-revalidate');
  c.header('Pragma', 'no-cache');
  c.header('Expires', '0');
  c.header('X-Build-Version', '2.0.8');
  c.header('X-Build-Time', new Date().toISOString());
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="version" content="2.0.8">
        <meta name="build-time" content="${new Date().toISOString()}">
        <title>í•™ìƒ ê´€ë¦¬ - ê¾¸ë©”ë•…í•™ì›</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-purple { background: linear-gradient(135deg, #93b8f5 0%, #a78cc5 100%); }
            .gradient-blue { background: linear-gradient(135deg, #667eea 0%, #4facfe 100%); }
            .gradient-green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
            .gradient-orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">ğŸ‘¨â€ğŸ“ í•™ìƒ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/dashboard" class="text-gray-600 hover:text-gray-900">
                            <i class="fas fa-th-large mr-2"></i>ëŒ€ì‹œë³´ë“œ
                        </a>
                        <a href="/sms/compose" class="text-gray-600 hover:text-gray-900">
                            <i class="fas fa-sms mr-2"></i>ë¬¸ì
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- ëŒ€ì‹œë³´ë“œ ì¹´ë“œ ê·¸ë¦¬ë“œ -->
            <div id="dashboardCardGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- ì„ ìƒë‹˜ ê´€ë¦¬ (ì›ì¥ë‹˜ ì „ìš©) -->
                <div id="teacherManagementCard" class="bg-white rounded-xl shadow-lg hover:shadow-xl transition cursor-pointer" onclick="toggleTeacherSection()">
                    <div class="bg-gradient-to-br from-purple-500 to-indigo-600 text-white p-6 rounded-t-xl">
                        <i class="fas fa-chalkboard-teacher text-4xl mb-3"></i>
                        <h3 class="text-xl font-bold">ì„ ìƒë‹˜ ê´€ë¦¬</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4">ì„ ìƒë‹˜ ë“±ë¡, ë°˜ ë°°ì •, ìŠ¹ì¸ ê´€ë¦¬</p>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500">ë“±ë¡ <span id="totalTeachers" class="font-bold text-purple-600">0</span>ëª…</span>
                            <i class="fas fa-chevron-down text-purple-600" id="teacherSectionIcon"></i>
                        </div>
                    </div>
                </div>

                <!-- ë°˜ ê´€ë¦¬ -->
                <a href="/students/classes" class="block bg-white rounded-xl shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <div class="gradient-purple text-white p-6 rounded-t-xl">
                        <i class="fas fa-chalkboard text-4xl mb-3"></i>
                        <h3 class="text-xl font-bold">ë°˜ ê´€ë¦¬</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4">ë°˜ ìƒì„±, í•™ìƒ ë°°ì •, ë°˜ë³„ ê´€ë¦¬</p>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500">ì „ì²´ <span id="totalClasses" class="font-bold text-purple-600">0</span>ê°œ ë°˜</span>
                            <i class="fas fa-arrow-right text-purple-600"></i>
                        </div>
                    </div>
                </a>

                <!-- í•™ìƒ ëª©ë¡ -->
                <a href="/students/list" class="block bg-white rounded-xl shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <div class="gradient-blue text-white p-6 rounded-t-xl">
                        <i class="fas fa-users text-4xl mb-3"></i>
                        <h3 class="text-xl font-bold">í•™ìƒ ëª©ë¡</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4">í•™ìƒ ë“±ë¡, ì •ë³´ ìˆ˜ì •, í•™ë¶€ëª¨ ì—°ë½ì²˜</p>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500">ì „ì²´ <span id="totalStudents" class="font-bold text-blue-600">0</span>ëª…</span>
                            <i class="fas fa-arrow-right text-blue-600"></i>
                        </div>
                    </div>
                </a>

                <!-- ê³¼ëª© ê´€ë¦¬ -->
                <a href="/students/courses" class="block bg-white rounded-xl shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <div class="gradient-green text-white p-6 rounded-t-xl">
                        <i class="fas fa-book text-4xl mb-3"></i>
                        <h3 class="text-xl font-bold">ê³¼ëª© ê´€ë¦¬</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4">ê³¼ëª© ë“±ë¡, ìˆ˜ê°• ê´€ë¦¬</p>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500">ì „ì²´ <span id="totalCourses" class="font-bold text-green-600">0</span>ê°œ ê³¼ëª©</span>
                            <i class="fas fa-arrow-right text-green-600"></i>
                        </div>
                    </div>
                </a>

                <!-- ì¼ì¼ ì„±ê³¼ ê¸°ë¡ -->
                <a href="/students/daily-record" class="block bg-white rounded-xl shadow-lg hover:shadow-xl transition transform hover:-translate-y-1">
                    <div class="gradient-orange text-white p-6 rounded-t-xl">
                        <i class="fas fa-calendar-check text-4xl mb-3"></i>
                        <h3 class="text-xl font-bold">ì¼ì¼ ì„±ê³¼</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-600 mb-4">ì¶œì„, ê³¼ì œ, ìˆ˜ì—… ì´í•´ë„ ê¸°ë¡</p>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500">ì˜¤ëŠ˜ <span id="todayRecords" class="font-bold text-pink-600">0</span>ê±´</span>
                            <i class="fas fa-arrow-right text-pink-600"></i>
                        </div>
                    </div>
                </a>
            </div>

            <!-- ì„ ìƒë‹˜ ê´€ë¦¬ ì„¹ì…˜ -->
            <div id="teacherSection" class="hidden mb-8 space-y-6">
                <!-- ì¸ì¦ ì½”ë“œ -->
                <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-key text-purple-600 mr-2"></i>í•™ì› ì¸ì¦ ì½”ë“œ
                    </h3>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                        <div>
                            <p class="text-sm text-gray-600 mb-2">ì„ ìƒë‹˜ì—ê²Œ ì´ ì½”ë“œë¥¼ ì „ë‹¬í•˜ì„¸ìš”</p>
                            <span id="verificationCode" class="text-3xl font-mono font-bold text-purple-600 block mb-2">------</span>
                            <a href="/signup?teacher=true" target="_blank" class="text-sm text-purple-600 hover:underline">
                                <i class="fas fa-external-link-alt mr-1"></i>ì„ ìƒë‹˜ ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™
                            </a>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="copyVerificationCode()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 whitespace-nowrap">
                                <i class="fas fa-copy mr-2"></i>ë³µì‚¬
                            </button>
                            <button onclick="regenerateVerificationCode()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 whitespace-nowrap">
                                <i class="fas fa-sync-alt mr-2"></i>ì¬ìƒì„±
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ìŠ¹ì¸ ëŒ€ê¸° -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-clock text-yellow-600 mr-2"></i>ìŠ¹ì¸ ëŒ€ê¸° ì¤‘
                        </h3>
                        <span id="pendingBadge" class="px-3 py-1 bg-yellow-500 text-white rounded-full text-sm font-bold">0</span>
                    </div>
                    <div id="pendingList" class="space-y-4">
                        <div class="text-center text-gray-500 py-4">ë¡œë”© ì¤‘...</div>
                    </div>
                </div>

                <!-- ë“±ë¡ëœ ì„ ìƒë‹˜ -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-users text-green-600 mr-2"></i>ë“±ë¡ëœ ì„ ìƒë‹˜
                        </h3>
                        <button onclick="openAddTeacherModal()" class="px-6 py-3 gradient-purple text-white rounded-lg hover:opacity-90 font-semibold shadow-lg">
                            <i class="fas fa-user-plus mr-2"></i>ì„ ìƒë‹˜ ì¶”ê°€
                        </button>
                    </div>
                    <div id="teachersList" class="space-y-4">
                        <div class="text-center text-gray-500 py-4">ë¡œë”© ì¤‘...</div>
                    </div>
                </div>
            </div>

            <!-- ì„ ìƒë‹˜ ì¶”ê°€ ëª¨ë‹¬ -->
            <div id="addTeacherModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl max-w-md w-full p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-user-plus text-purple-600 mr-2"></i>ì„ ìƒë‹˜ ì¶”ê°€
                        </h3>
                        <button onclick="closeAddTeacherModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <form id="addTeacherForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">
                                ì´ë¦„ <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="name" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="ê¹€ì„ ìƒ">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">
                                ì´ë©”ì¼ (íšŒì› ì•„ì´ë””) <span class="text-red-500">*</span>
                            </label>
                            <input type="email" name="email" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="teacher@example.com">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">
                                ì—°ë½ì²˜ <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" name="phone" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="010-0000-0000">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">
                                ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ <span class="text-red-500">*</span>
                            </label>
                            <input type="password" name="password" required minlength="6" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="ìµœì†Œ 6ì">
                            <p class="text-xs text-gray-500 mt-1">ì„ ìƒë‹˜ì´ ë¡œê·¸ì¸ í›„ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-900 mb-2">
                                ë‹´ë‹¹ ë°˜ ë°°ì • (ì„ íƒ)
                            </label>
                            <select name="class_id" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">ë‚˜ì¤‘ì— ë°°ì •</option>
                                <!-- ë°˜ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                            </select>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-2"></i>
                                ì„ ìƒë‹˜ ê³„ì •ì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ë©°, ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                        
                        <button type="submit" class="w-full gradient-purple text-white py-3 rounded-lg font-medium hover:opacity-90">
                            <i class="fas fa-check mr-2"></i>ì„ ìƒë‹˜ ì¶”ê°€í•˜ê¸°
                        </button>
                    </form>
                </div>
            </div>

            <!-- ê¶Œí•œ ì„¤ì • ëª¨ë‹¬ -->
            <div id="permissionsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">
                            <i class="fas fa-user-shield text-purple-600 mr-2"></i><span id="permissionsTeacherName"></span> ì„ ìƒë‹˜ ê¶Œí•œ ì„¤ì •
                        </h3>
                        <button onclick="closePermissionsModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <form id="permissionsForm" class="space-y-6">
                        <input type="hidden" id="permissionsTeacherId">
                        
                        <!-- ê¶Œí•œ ì„ íƒ (ë¼ë””ì˜¤ ë²„íŠ¼) - Updated 2026-01-18 -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-900 text-lg mb-4">
                                <i class="fas fa-shield-alt text-purple-600 mr-2"></i>ì ‘ê·¼ ê¶Œí•œ ì„ íƒ
                            </h4>
                            
                            <!-- ì˜µì…˜ 1: ëª¨ë‘ ë‹¤ ê³µê°œ -->
                            <label class="block cursor-pointer">
                                <div class="border-2 border-gray-200 rounded-xl p-5 hover:border-purple-400 transition-colors" id="allAccessOption">
                                    <div class="flex items-start">
                                        <input type="radio" name="accessLevel" value="all" id="accessLevelAll" class="mt-1 w-5 h-5 text-purple-600 focus:ring-purple-500">
                                        <div class="ml-4 flex-1">
                                            <div class="flex items-center mb-2">
                                                <i class="fas fa-globe text-blue-600 mr-2 text-xl"></i>
                                                <span class="text-base font-bold text-gray-900">ëª¨ë‘ ë‹¤ ê³µê°œ</span>
                                            </div>
                                            <p class="text-sm text-gray-600 leading-relaxed">
                                                â€¢ ëª¨ë“  í•™ìƒ ì •ë³´ ì¡°íšŒ<br>
                                                â€¢ ëª¨ë“  ë°˜ ê´€ë¦¬<br>
                                                â€¢ ëª¨ë“  ê³¼ëª© ê´€ë¦¬<br>
                                                â€¢ ì „ì²´ ì¼ì¼ ì„±ê³¼ ì‘ì„±<br>
                                                â€¢ ëœë”©í˜ì´ì§€ ì ‘ê·¼
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </label>
                            
                            <!-- ì˜µì…˜ 2: ë°°ì •ëœ ë°˜ë§Œ ê³µê°œ -->
                            <label class="block cursor-pointer">
                                <div class="border-2 border-gray-200 rounded-xl p-5 hover:border-purple-400 transition-colors" id="assignedOnlyOption">
                                    <div class="flex items-start">
                                        <input type="radio" name="accessLevel" value="assigned" id="accessLevelAssigned" class="mt-1 w-5 h-5 text-purple-600 focus:ring-purple-500">
                                        <div class="ml-4 flex-1">
                                            <div class="flex items-center mb-2">
                                                <i class="fas fa-users text-green-600 mr-2 text-xl"></i>
                                                <span class="text-base font-bold text-gray-900">ë°°ì •ëœ ë°˜ë§Œ ê³µê°œ</span>
                                            </div>
                                            <p class="text-sm text-gray-600 leading-relaxed mb-3">
                                                â€¢ ë°°ì •ëœ ë°˜ì˜ í•™ìƒë§Œ ì¡°íšŒ<br>
                                                â€¢ ë°°ì •ëœ ë°˜ì˜ ì¼ì¼ ì„±ê³¼ë§Œ ì‘ì„±<br>
                                                â€¢ ë°˜/ê³¼ëª© ê´€ë¦¬ ë¶ˆê°€<br>
                                                â€¢ ëœë”©í˜ì´ì§€ ì ‘ê·¼ ë¶ˆê°€
                                            </p>
                                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-3 mt-3">
                                                <p class="text-xs text-purple-800 font-medium mb-2">
                                                    <i class="fas fa-info-circle mr-1"></i>ì´ ì˜µì…˜ì„ ì„ íƒí•˜ë©´ ì•„ë˜ì—ì„œ ë°˜ì„ ë°°ì •í•´ì£¼ì„¸ìš”:
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- ë°˜ ë°°ì • (ë°°ì •ëœ ë°˜ë§Œ ê³µê°œ ì„ íƒ ì‹œì—ë§Œ í™œì„±í™”) -->
                        <div id="classAssignmentSection" class="border border-gray-200 rounded-lg p-4 bg-gray-50" style="display: none;">
                            <h4 class="font-medium text-gray-900 mb-3">
                                <i class="fas fa-chalkboard text-purple-600 mr-2"></i>ë°˜ ë°°ì •
                            </h4>
                            <div id="classesCheckboxList" class="space-y-2 max-h-60 overflow-y-auto">
                                <div class="text-center text-gray-500 py-4">ë¡œë”© ì¤‘...</div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                ê¶Œí•œ ì„¤ì • í›„ ì„ ìƒë‹˜ì€ ì¦‰ì‹œ í•´ë‹¹ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                        
                        <div class="flex gap-3">
                            <button type="button" onclick="closePermissionsModal()" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">
                                <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                            </button>
                            <button type="submit" class="flex-1 gradient-purple text-white py-3 rounded-lg font-medium hover:opacity-90">
                                <i class="fas fa-save mr-2"></i>ì €ì¥
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ìµœê·¼ í™œë™ -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ğŸ“Š ìµœê·¼ í™œë™</h2>
                <div id="recentActivity" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
            </div>
        </div>

        <script>
            // ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ í™•ì¸
            const userStr = localStorage.getItem('user');
            let currentUser = null;
            let academyId = 1; // ê¸°ë³¸ê°’ (ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°)
            let userPermissions = {
                canViewAllStudents: false,
                canWriteDailyReports: false,
                assignedClasses: []
            };
            
            // âœ… ë¡œê·¸ì¸ ì²´í¬ ë° academy_id ê²€ì¦
            let shouldRedirect = false;
            
            if (!userStr) {
                console.warn('âš ï¸ Not logged in - redirecting to login');
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.');
                shouldRedirect = true;
            } else {
                try {
                    currentUser = JSON.parse(userStr);
                    
                    // academy_idê°€ ì—†ìœ¼ë©´ idë¥¼ ì‚¬ìš© (fallback)
                    if (!currentUser.academy_id && !currentUser.id) {
                        console.error('âŒ CRITICAL: No academy_id or id in localStorage!');
                        console.log('Clearing localStorage and redirecting to login...');
                        localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                        alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        shouldRedirect = true;
                    } else {
                        // academy_id ìš°ì„ , ì—†ìœ¼ë©´ id ì‚¬ìš©
                        academyId = currentUser.academy_id || currentUser.id;
                        console.log('âœ… Current user:', currentUser);
                        console.log('âœ… User ID:', currentUser.id);
                        console.log('âœ… Academy ID:', academyId);
                        console.log('âœ… User Type:', currentUser.user_type);
                    }
                } catch (e) {
                    console.error('Failed to parse user data:', e);
                    localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                    alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    shouldRedirect = true;
                }
            }
            
            // ë¦¬ë‹¤ì´ë ‰íŠ¸ê°€ í•„ìš”í•˜ë©´ ì¦‰ì‹œ ì‹¤í–‰
            if (shouldRedirect) {
                window.location.href = '/login';
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¶Œí•œ í™•ì¸ ë° UI ì œí•œ
            async function initializePage() {
                if (!currentUser) {
                    console.log('âš ï¸ No user logged in, redirecting to login page');
                    // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤.');
                    window.location.href = '/login';
                    return;
                }
                
                console.log('ğŸ” Initializing page for user:', currentUser);
                
                // âœ… ì„œë²„ì—ì„œ ìµœì‹  ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                try {
                    console.log('ğŸ”„ Fetching latest user info from server...');
                    const userResponse = await fetch('/api/user/profile', {
                        headers: {
                            'X-User-Id': currentUser.id.toString()
                        },
                        credentials: 'include'  // ì¿ í‚¤ í¬í•¨
                    });
                    
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        if (userData.success && userData.user) {
                            console.log('âœ… Latest user data from server:', userData.user);
                            // localStorage ì—…ë°ì´íŠ¸
                            const updatedUser = {
                                ...currentUser,
                                ...userData.user,
                                // ê¸°ì¡´ ì„¸ì…˜ ì •ë³´ ìœ ì§€
                                permissions: currentUser.permissions
                            };
                            currentUser = updatedUser;
                            localStorage.setItem('user', JSON.stringify(updatedUser));
                            console.log('âœ… localStorage updated with latest data');
                            
                            // academy_id ì—…ë°ì´íŠ¸
                            if (currentUser.academy_id) {
                                academyId = currentUser.academy_id;
                            }
                        }
                    } else if (userResponse.status === 401) {
                        // ì„¸ì…˜ ë§Œë£Œ
                        console.error('âŒ Session expired, redirecting to login');
                        localStorage.removeItem('user');
                localStorage.removeItem('loginTime');
                        alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                        window.location.href = '/login';
                        return;
                    } else {
                        console.warn('âš ï¸ Failed to fetch latest user info, using cached data');
                    }
                } catch (error) {
                    console.error('âŒ Error fetching user info:', error);
                    console.warn('âš ï¸ Continuing with cached user data');
                }
                
                // user_typeì´ ì—†ìœ¼ë©´ roleì„ ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜ì„±)
                if (!currentUser.user_type && currentUser.role) {
                    currentUser.user_type = currentUser.role;
                }
                
                // âœ… ì„ ìƒë‹˜ì˜ ê²½ìš° academy_idê°€ ì—†ìœ¼ë©´ parent_user_idë¡œ ì„¤ì •
                if (currentUser.user_type === 'teacher' && !currentUser.academy_id && currentUser.parent_user_id) {
                    console.log('âš ï¸ Teacher without academy_id, fixing with parent_user_id:', currentUser.parent_user_id);
                    currentUser.academy_id = currentUser.parent_user_id;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    academyId = currentUser.academy_id;
                    
                    // ì„œë²„ì—ë„ ì—…ë°ì´íŠ¸
                    try {
                        await fetch('/api/debug/fix-academy-id', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: currentUser.email,
                                academy_id: currentUser.academy_id
                            })
                        });
                        console.log('âœ… Academy ID updated on server');
                    } catch (err) {
                        console.warn('âš ï¸ Failed to update academy_id on server:', err);
                    }
                }
                
                // âœ… ì›ì¥ë‹˜ì˜ ê²½ìš° academy_idê°€ ì—†ìœ¼ë©´ ìì‹ ì˜ ID ì‚¬ìš©
                if (currentUser.user_type !== 'teacher' && !currentUser.academy_id) {
                    console.log('âš ï¸ Director without academy_id, using own ID:', currentUser.id);
                    currentUser.academy_id = currentUser.id;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    academyId = currentUser.academy_id;
                }
                
                
                // ì„ ìƒë‹˜ ê³„ì • ê°ì§€ (DBì— user_type='teacher'ë¡œ ë“±ë¡ëœ ê²½ìš°ì—ë§Œ ì„ ìƒë‹˜)
                // âœ… user_typeì„ ìš°ì„ ì ìœ¼ë¡œ ì²´í¬ (roleì€ ë¬´ì‹œ)
                // âœ… user_type='teacher'ì¸ ê²½ìš°ì—ë§Œ ì œí•œëœ ê¶Œí•œ ì ìš©
                // âœ… user_type='director' ë˜ëŠ” ë‹¤ë¥¸ ê°’ì´ë©´ ì›ì¥ë‹˜ìœ¼ë¡œ ê°„ì£¼
                const isTeacher = currentUser.user_type === 'teacher';
                const isDirector = currentUser.user_type === 'director' || !currentUser.user_type;
                
                console.log('ğŸ” Account type check:');
                console.log('   - user_type:', currentUser.user_type);
                console.log('   - role:', currentUser.role, '(ignored)');
                console.log('   - isTeacher:', isTeacher);
                console.log('   - isDirector:', isDirector);
                
                if (isDirector) {
                    // ì›ì¥ë‹˜ì€ ëª¨ë“  ê¶Œí•œ ìë™ ë¶€ì—¬
                    console.log('âœ… Director account - granting full access');
                    userPermissions = {
                        canViewAllStudents: true,
                        canWriteDailyReports: true,
                        assignedClasses: []
                    };
                    currentUser.permissions = userPermissions;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    console.log('âœ… Full permissions granted to director:', userPermissions);
                    
                } else if (isTeacher) {
                    console.log('âœ… Teacher account confirmed (user_type=teacher)');
                    console.log('   - id:', currentUser.id);
                    
                    // í•­ìƒ ì„œë²„ì—ì„œ ìµœì‹  ê¶Œí•œì„ ì¡°íšŒí•˜ì—¬ localStorage ê¶Œí•œì„ ë¬´ì‹œ
                    console.log('ğŸ”„ Fetching latest permissions from server...');
                    await loadTeacherPermissions();
                    
                    // í˜„ì¬ ë¡œë“œëœ ê¶Œí•œìœ¼ë¡œ userPermissions ì„¤ì •
                    console.log('âœ… Setting userPermissions from loadTeacherPermissions result');
                    console.log('   - userPermissions:', userPermissions);
                    
                    // ì¡°íšŒí•œ ê¶Œí•œì„ localStorageì— ì €ì¥
                    if (userPermissions) {
                        currentUser.permissions = userPermissions;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                        console.log('âœ… Permissions saved to localStorage:', userPermissions);
                    } else {
                        // ê¶Œí•œ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì œí•œì  ê¶Œí•œ
                        currentUser.permissions = {
                            canViewAllStudents: false,
                            canWriteDailyReports: false,
                            assignedClasses: []
                        };
                        userPermissions = currentUser.permissions;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                        console.log('âš ï¸ Using default restrictive permissions');
                    }
                    
                    // ì„ ìƒë‹˜ UI ì œí•œ ì ìš©
                    applyTeacherRestrictions();
                }
                
                await loadDashboard();
            }
            
            // ê³µê°œ ì½ê¸° ì „ìš© ëª¨ë“œ ì œí•œ ì ìš©
            function applyPublicViewRestrictions() {
                console.log('ğŸ”’ Applying public read-only restrictions');
                
                // ëª¨ë“  ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                const restrictedButtons = document.querySelectorAll(
                    '[onclick*="add"], [onclick*="create"], [onclick*="edit"], [onclick*="delete"], ' +
                    '[onclick*="update"], [onclick*="save"], [onclick*="remove"], ' +
                    '.add-button, .edit-button, .delete-button, .save-button'
                );
                restrictedButtons.forEach(btn => {
                    btn.style.display = 'none';
                });
                
                // ì„ ìƒë‹˜ ê´€ë¦¬ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
                const teacherSection = document.getElementById('teacherManagementSection');
                if (teacherSection) {
                    teacherSection.style.display = 'none';
                }
                
                // í˜ì´ì§€ ìƒë‹¨ì— ì•Œë¦¼ í‘œì‹œ
                const mainContent = document.querySelector('body > nav + div');
                if (mainContent) {
                    const notice = document.createElement('div');
                    notice.className = 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4';
                    notice.innerHTML = \`
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-lg">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-info-circle text-blue-400 text-xl"></i>
                                </div>
                                <div class="ml-3 flex-1">
                                    <p class="text-sm text-blue-700">
                                        <strong>ì½ê¸° ì „ìš© ëª¨ë“œ</strong> - ë°ì´í„°ë¥¼ ë³´ê¸°ë§Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
                                        <a href="/login" class="underline font-medium hover:text-blue-800">ë¡œê·¸ì¸</a>í•˜ì—¬ ì „ì²´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.
                                    </p>
                                </div>
                            </div>
                        </div>
                    \`;
                    mainContent.parentNode.insertBefore(notice, mainContent);
                }
            }

            // ì„ ìƒë‹˜ ê¶Œí•œ ë¡œë“œ
            async function loadTeacherPermissions() {
                try {
                    // parent_user_idë¥¼ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ í˜„ì¬ ë¡œê·¸ì¸í•œ ì›ì¥ë‹˜ ID ì‚¬ìš©
                    let directorId = currentUser.parent_user_id || currentUser.id;
                    
                    console.log(\`ğŸ” Fetching permissions for teacher \${currentUser.id} from director \${directorId}\`);
                    console.log('   - currentUser.parent_user_id:', currentUser.parent_user_id);
                    console.log('   - currentUser.id:', currentUser.id);
                    console.log('   - Using directorId:', directorId);
                    
                    const res = await fetch(\`/api/teachers/\${currentUser.id}/permissions?directorId=\${directorId}\`);
                    const data = await res.json();
                    
                    console.log('ğŸ“‹ Permission API response:', data);
                    
                    if (data.success && data.permissions) {
                        userPermissions = data.permissions;
                        console.log('âœ… Teacher permissions loaded from server:', userPermissions);
                        console.log('   - canViewAllStudents:', userPermissions.canViewAllStudents);
                        console.log('   - assignedClasses:', userPermissions.assignedClasses);
                        console.log('   - canWriteDailyReports:', userPermissions.canWriteDailyReports);
                    } else {
                        console.warn('âš ï¸ No permissions found or API failed');
                        console.warn('   - API error:', data.error);
                        console.warn('   - Using default restrictive permissions');
                        userPermissions = {
                            canViewAllStudents: false,
                            canWriteDailyReports: false,
                            assignedClasses: []
                        };
                    }
                } catch (error) {
                    console.error('âŒ ê¶Œí•œ ë¡œë“œ ì‹¤íŒ¨:', error);
                    // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ê¶Œí•œ (ëª¨ë‘ ì œí•œ)
                    userPermissions = {
                        canViewAllStudents: false,
                        canWriteDailyReports: false,
                        assignedClasses: []
                    };
                }
            }

            // ì„ ìƒë‹˜ UI ì œí•œ ì ìš©
            function applyTeacherRestrictions() {
                console.log('ğŸ”’ Applying teacher restrictions...');
                console.log('Current user:', currentUser);
                console.log('User permissions:', userPermissions);
                
                // âœ… ê¶Œí•œ í™•ì¸ ë¡œì§ ê°œì„ 
                // 1. canViewAllStudentsê°€ trueì´ë©´ ì „ì²´ ê¶Œí•œ (ëª¨ë“  í•™ìƒ ë³¼ ìˆ˜ ìˆìŒ)
                // 2. assignedClassesê°€ ìˆìœ¼ë©´ ì œí•œì  ê¶Œí•œ (ë°°ì •ëœ ë°˜ë§Œ)
                // 3. ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ê¶Œí•œ ì—†ìŒ
                const hasFullAccess = userPermissions && userPermissions.canViewAllStudents === true;
                const hasAssignedClasses = userPermissions && 
                                          userPermissions.assignedClasses && 
                                          Array.isArray(userPermissions.assignedClasses) &&
                                          userPermissions.assignedClasses.length > 0;
                const hasAnyPermission = hasFullAccess || hasAssignedClasses;
                
                console.log('ğŸ” Permission check:');
                console.log('   - canViewAllStudents:', userPermissions?.canViewAllStudents);
                console.log('   - assignedClasses:', userPermissions?.assignedClasses);
                console.log('   - hasFullAccess (can view all):', hasFullAccess);
                console.log('   - hasAssignedClasses (assigned classes):', hasAssignedClasses);
                console.log('   - hasAnyPermission (any access):', hasAnyPermission);
                
                // âœ… ì„ ìƒë‹˜ ê´€ë¦¬ ì¹´ë“œëŠ” ì„ ìƒë‹˜ì—ê²Œ í•­ìƒ ìˆ¨ê¹€
                const teacherCard = document.getElementById('teacherManagementCard');
                if (teacherCard) {
                    teacherCard.style.display = 'none';
                    console.log('âœ… Hidden: Teacher management card');
                }
                
                // âœ… ê¶Œí•œì´ ì•„ì˜ˆ ì—†ìœ¼ë©´ ëª¨ë“  ì¹´ë“œ ìˆ¨ê¸°ê³  "ê¶Œí•œ ì—†ìŒ" ë©”ì‹œì§€ í‘œì‹œ
                if (!hasAnyPermission) {
                    console.log('âŒ No permissions at all - showing no-permission message');
                    
                    // í•™ìƒ ê´€ë¦¬ ê´€ë ¨ ì¹´ë“œë§Œ ìˆ¨ê¸°ê³  ë©”ì‹œì§€ í‘œì‹œ
                    const studentCard = document.querySelector('a[href="/students/list"]');
                    const dailyCard = document.querySelector('a[href="/students/daily-record"]');
                    const classCard = document.querySelector('a[href="/students/classes"]');
                    const courseCard = document.querySelector('a[href="/students/courses"]');
                    
                    // í•™ìƒ ê´€ë¦¬ ì¹´ë“œë“¤ ìˆ¨ê¹€
                    if (studentCard) studentCard.style.display = 'none';
                    if (dailyCard) dailyCard.style.display = 'none';
                    if (classCard) classCard.style.display = 'none';
                    if (courseCard) courseCard.style.display = 'none';
                    
                    // í•™ìƒ ê´€ë¦¬ ì˜ì—­ì— ê¶Œí•œ ì—†ìŒ ë©”ì‹œì§€ ì¶”ê°€
                    const dashboardGrid = document.getElementById('dashboardCardGrid');
                    if (dashboardGrid) {
                        const noPermissionCard = document.createElement('div');
                        noPermissionCard.className = 'col-span-full';
                        noPermissionCard.innerHTML = '<div class="bg-yellow-50 border-2 border-yellow-200 rounded-2xl p-8 text-center">' +
                            '<i class="fas fa-lock text-5xl text-yellow-600 mb-4"></i>' +
                            '<h3 class="text-xl font-bold text-gray-900 mb-3">í•™ìƒ ê´€ë¦¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</h3>' +
                            '<p class="text-gray-600 mb-4">ì›ì¥ë‹˜ì´ ê¶Œí•œì„ ë¶€ì—¬í•˜ë©´<br>í•™ìƒ ê´€ë¦¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>' +
                            '<div class="bg-white rounded-lg p-3 text-sm text-gray-500">' +
                            '<i class="fas fa-info-circle mr-2"></i>ê¶Œí•œ ë¬¸ì˜ëŠ” ì›ì¥ë‹˜ê»˜ ìš”ì²­í•´ì£¼ì„¸ìš”.' +
                            '</div>' +
                            '</div>';
                        dashboardGrid.insertBefore(noPermissionCard, dashboardGrid.firstChild);
                        console.log('âœ… Added: No permission message for student management');
                    }
                    
                    // ì„ ìƒë‹˜ ê´€ë¦¬ ì„¹ì…˜ ìˆ¨ê¹€
                    const teacherSection = document.getElementById('teacherSection');
                    if (teacherSection) {
                        teacherSection.style.display = 'none';
                    }
                    
                    // ëœë”©í˜ì´ì§€, ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰, AI ë¦¬í¬íŠ¸ ë“± ë‹¤ë¥¸ ê¸°ëŠ¥ì€ ê·¸ëŒ€ë¡œ í‘œì‹œ
                    // returnì„ ì œê±°í•˜ì—¬ ì•„ë˜ ë¡œì§ ê³„ì† ì‹¤í–‰
                }
                
                // âœ… ë°˜ ê´€ë¦¬ì™€ ê³¼ëª© ê´€ë¦¬ëŠ” ì „ì²´ ê¶Œí•œì´ ìˆì„ ë•Œë§Œ í‘œì‹œ
                const classCard = document.querySelector('a[href="/students/classes"]');
                if (classCard) {
                    if (hasFullAccess) {
                        classCard.style.display = 'block';
                        console.log('âœ… Showing: Class management (full access)');
                    } else {
                        classCard.style.display = 'none';
                        console.log('âœ… Hidden: Class management (restricted)');
                    }
                }
                
                const courseCard = document.querySelector('a[href="/students/courses"]');
                if (courseCard) {
                    if (hasFullAccess) {
                        courseCard.style.display = 'block';
                        console.log('âœ… Showing: Course management (full access)');
                    } else {
                        courseCard.style.display = 'none';
                        console.log('âœ… Hidden: Course management (restricted)');
                    }
                }
                
                // âœ… í•™ìƒ ëª©ë¡ê³¼ ì¼ì¼ ì„±ê³¼ëŠ” ê¶Œí•œì´ ìˆìœ¼ë©´ í‘œì‹œ
                const studentCard = document.querySelector('a[href="/students/list"]');
                if (studentCard && hasAnyPermission) {
                    studentCard.style.display = 'block';
                    if (hasFullAccess) {
                        console.log('âœ… Showing: Student list (full access - all students)');
                    } else if (hasAssignedClasses) {
                        console.log('âœ… Showing: Student list (assigned classes only)');
                    }
                }
                
                const dailyCard = document.querySelector('a[href="/students/daily-record"]');
                if (dailyCard && hasAnyPermission) {
                    dailyCard.style.display = 'block';
                    if (hasFullAccess) {
                        console.log('âœ… Showing: Daily records (full access)');
                    } else if (hasAssignedClasses) {
                        console.log('âœ… Showing: Daily records (assigned classes only)');
                    }
                }
                
                // âœ… ëœë”©í˜ì´ì§€, ë„¤ì´ë²„ ê²€ìƒ‰ëŸ‰, AI ë¦¬í¬íŠ¸ëŠ” ì „ì²´ ê¶Œí•œì¼ ë•Œë§Œ í‘œì‹œ
                // ë°°ì •ëœ ë°˜ë§Œ í—ˆìš©ëœ ê²½ìš°ì—ëŠ” ìˆ¨ê¹€
                const landingSection = document.getElementById('landingPagesSection');
                if (landingSection) {
                    if (hasFullAccess) {
                        landingSection.style.display = 'block';
                        console.log('âœ… Showing: Landing pages section (full access)');
                    } else {
                        landingSection.style.display = 'none';
                        console.log('âœ… Hidden: Landing pages section (restricted or no permission)');
                    }
                }
                
                const naverSection = document.getElementById('naverSearchSection');
                if (naverSection) {
                    if (hasFullAccess) {
                        naverSection.style.display = 'block';
                        console.log('âœ… Showing: Naver search section (full access)');
                    } else {
                        naverSection.style.display = 'none';
                        console.log('âœ… Hidden: Naver search section (restricted or no permission)');
                    }
                }
                
                const aiReportSection = document.getElementById('aiReportSection');
                if (aiReportSection) {
                    if (hasFullAccess) {
                        aiReportSection.style.display = 'block';
                        console.log('âœ… Showing: AI report section (full access)');
                    } else {
                        aiReportSection.style.display = 'none';
                        console.log('âœ… Hidden: AI report section (restricted or no permission)');
                    }
                }
                
                console.log('âœ… Teacher restrictions applied');
            }

            async function loadDashboard() {
                try {
                    console.log('ğŸ”„ [loadDashboard] Starting... currentUser:', currentUser);
                    console.log('ğŸ”„ [loadDashboard] userPermissions:', userPermissions);
                    console.log('ğŸ”„ [loadDashboard] academy_id:', currentUser?.academy_id);
                    console.log('ğŸ”„ [loadDashboard] user_type:', currentUser?.user_type);
                    
                    // âœ… academy_id í™•ì¸ ë° ìë™ ìˆ˜ì •
                    let academyId = currentUser?.academy_id;
                    
                    // ì„ ìƒë‹˜ì˜ ê²½ìš° academy_idê°€ ì—†ìœ¼ë©´ parent_user_id ì‚¬ìš©
                    if (!academyId && currentUser?.user_type === 'teacher' && currentUser?.parent_user_id) {
                        console.log('âš ï¸ [loadDashboard] Teacher without academy_id, using parent_user_id:', currentUser.parent_user_id);
                        academyId = currentUser.parent_user_id;
                        currentUser.academy_id = academyId;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                    }
                    
                    // ì›ì¥ë‹˜ì˜ ê²½ìš° academy_idê°€ ì—†ìœ¼ë©´ ìì‹ ì˜ ID ì‚¬ìš©
                    if (!academyId && currentUser?.user_type !== 'teacher') {
                        console.log('âš ï¸ [loadDashboard] Director without academy_id, using own ID:', currentUser.id);
                        academyId = currentUser.id;
                        currentUser.academy_id = academyId;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                    }
                    
                    console.log('âœ… [loadDashboard] Final academy_id to use:', academyId);
                    
                    // âœ… í•™ìƒ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ìë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± (ëª¨ë“  ì‚¬ìš©ì)
                    if (currentUser && academyId) {
                        console.log('ğŸš€ [loadDashboard] Checking if test data is needed...');
                        console.log('ğŸš€ [loadDashboard] currentUser:', currentUser);
                        console.log('ğŸš€ [loadDashboard] academy_id:', currentUser.academy_id);
                        
                        const studentsCheckRes = await fetch('/api/students', {
                            headers: {
                                'X-User-Data-Base64': btoa(unescape(encodeURIComponent(JSON.stringify(currentUser))))
                            }
                        });
                        const studentsCheckData = await studentsCheckRes.json();
                        console.log('ğŸš€ [loadDashboard] Students check result:', studentsCheckData);
                        
                        if (studentsCheckData.success && studentsCheckData.students.length === 0) {
                            console.log('âš ï¸ [loadDashboard] No students found! Creating test data...');
                            console.log('âš ï¸ [loadDashboard] Using academy_id:', currentUser.academy_id);
                            
                            const initRes = await fetch('/api/init-test-data', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ academyId: currentUser.academy_id })
                            });
                            const initData = await initRes.json();
                            console.log('ğŸ‰ [loadDashboard] Test data creation result:', initData);
                            
                            if (initData.success) {
                                console.log('âœ… [loadDashboard] Test data created successfully!');
                                alert('í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ!\\n\\në°˜: ' + initData.classes + 'ê°œ\\ní•™ìƒ: ' + initData.students + 'ëª…');
                                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë°ì´í„° í‘œì‹œ
                                location.reload();
                            } else {
                                console.error('âŒ [loadDashboard] Test data creation failed:', initData.error);
                                alert('âŒ ë°ì´í„° ìƒì„± ì‹¤íŒ¨: ' + initData.error);
                            }
                        } else if (studentsCheckData.success) {
                            console.log('âœ… [loadDashboard] Students already exist:', studentsCheckData.students.length);
                        } else {
                            console.error('âŒ [loadDashboard] Students check failed:', studentsCheckData.error);
                        }
                    } else {
                        console.log('âš ï¸ [loadDashboard] No currentUser or academy_id, skipping test data check');
                    }
                    
                    // ì„ ìƒë‹˜ ìˆ˜ (ì›ì¥ë‹˜ë§Œ)
                    if (currentUser && currentUser.user_type !== 'teacher') {
                        console.log('ğŸ“Š [loadDashboard] Loading teachers...');
                        const teachersRes = await fetch('/api/teachers/list?directorId=' + currentUser.id);
                        const teachersData = await teachersRes.json();
                        console.log('ğŸ“Š [loadDashboard] Teachers response:', teachersData);
                        if (teachersData.success) {
                            const count = teachersData.teachers.length;
                            document.getElementById('totalTeachers').textContent = count;
                            console.log('âœ… [loadDashboard] Teachers count:', count);
                        } else {
                            console.error('âŒ [loadDashboard] Teachers load failed:', teachersData.error);
                        }
                    }
                
                    // ë°˜ ê°œìˆ˜ (ì„ ìƒë‹˜ì€ ìì‹ ì˜ ë°°ì •ëœ ë°˜ë§Œ)
                    if (currentUser && currentUser.user_type === 'teacher' && !userPermissions.canViewAllStudents) {
                        // ë°°ì •ëœ ë°˜ë§Œ í‘œì‹œ
                        const count = userPermissions.assignedClasses ? userPermissions.assignedClasses.length : 0;
                        document.getElementById('totalClasses').textContent = count;
                        console.log('âœ… [loadDashboard] Assigned classes count:', count);
                    } else {
                        console.log('ğŸ“Š [loadDashboard] Loading classes...');
                        const userDataHeader = currentUser ? btoa(unescape(encodeURIComponent(JSON.stringify(currentUser)))) : btoa(JSON.stringify({id: academyId}));
                        const classesRes = await fetch('/api/classes', {
                            headers: {
                                'X-User-Data-Base64': userDataHeader
                            }
                        });
                        const classesData = await classesRes.json();
                        console.log('ğŸ“Š [loadDashboard] Classes response:', classesData);
                        if (classesData.success) {
                            const count = classesData.classes.length;
                            document.getElementById('totalClasses').textContent = count;
                            console.log('âœ… [loadDashboard] Classes count:', count);
                        } else {
                            console.error('âŒ [loadDashboard] Classes load failed:', classesData.error);
                        }
                    }

                    // í•™ìƒ ìˆ˜ (APIê°€ ìë™ìœ¼ë¡œ ê¶Œí•œ í•„í„°ë§í•¨)
                    console.log('ğŸ“Š [loadDashboard] Loading students...');
                    const studentsUserDataHeader = currentUser ? btoa(unescape(encodeURIComponent(JSON.stringify(currentUser)))) : btoa(JSON.stringify({id: academyId}));
                    const studentsRes = await fetch('/api/students', {
                        headers: {
                            'X-User-Data-Base64': studentsUserDataHeader
                        }
                    });
                    const studentsData = await studentsRes.json();
                    console.log('ğŸ“Š [loadDashboard] Students response:', studentsData);
                    if (studentsData.success) {
                        const count = studentsData.students.length;
                        document.getElementById('totalStudents').textContent = count;
                        console.log('âœ… [loadDashboard] Students count:', count);
                        // ìµœê·¼ í™œë™ í‘œì‹œ
                        showRecentActivity(studentsData.students.slice(0, 5));
                    } else {
                        console.error('âŒ [loadDashboard] Students load failed:', studentsData.error);
                    }

                    // ê³¼ëª© ìˆ˜
                    console.log('ğŸ“Š [loadDashboard] Loading courses...');
                    const coursesRes = await fetch('/api/courses?academyId=' + academyId);
                    console.log('ğŸ“Š [loadDashboard] Courses response status:', coursesRes.status, coursesRes.ok);
                    
                    if (!coursesRes.ok) {
                        console.error('âŒ [loadDashboard] Courses API failed with status:', coursesRes.status);
                        document.getElementById('totalCourses').textContent = '0';
                    } else {
                        const coursesText = await coursesRes.text();
                        console.log('ğŸ“Š [loadDashboard] Courses raw response (first 100 chars):', coursesText.substring(0, 100));
                        
                        try {
                            const coursesData = JSON.parse(coursesText);
                            console.log('ğŸ“Š [loadDashboard] Courses response:', coursesData);
                            if (coursesData.success) {
                                const count = coursesData.courses.length;
                                document.getElementById('totalCourses').textContent = count;
                                console.log('âœ… [loadDashboard] Courses count:', count);
                            } else {
                                console.error('âŒ [loadDashboard] Courses load failed:', coursesData.error);
                                document.getElementById('totalCourses').textContent = '0';
                            }
                        } catch (jsonError) {
                            console.error('âŒ [loadDashboard] JSON parse error:', jsonError.message);
                            console.error('âŒ [loadDashboard] Invalid response text:', coursesText);
                            document.getElementById('totalCourses').textContent = '0';
                        }
                    }

                    // ì˜¤ëŠ˜ ê¸°ë¡ ìˆ˜
                    console.log('ğŸ“Š [loadDashboard] Loading daily records...');
                    const today = new Date().toISOString().split('T')[0];
                    const recordsRes = await fetch('/api/daily-records?date=' + today);
                    const recordsData = await recordsRes.json();
                    console.log('ğŸ“Š [loadDashboard] Records response:', recordsData);
                    if (recordsData.success) {
                        const count = recordsData.records.length;
                        document.getElementById('todayRecords').textContent = count;
                        console.log('âœ… [loadDashboard] Records count:', count);
                    } else {
                        console.error('âŒ [loadDashboard] Records load failed:', recordsData.error);
                    }
                    
                    console.log('âœ… [loadDashboard] Complete!');
                } catch (error) {
                    console.error('âŒ [loadDashboard] Exception:', error);
                    console.error('âŒ [loadDashboard] Stack:', error.stack);
                }
            }

            function showRecentActivity(students) {
                const container = document.getElementById('recentActivity');
                if (students.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8">ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                container.innerHTML = students.map(student => \`
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100">
                        <div class="flex items-center space-x-4">
                            <div class="bg-purple-100 text-purple-600 rounded-full w-10 h-10 flex items-center justify-center font-bold">
                                \${student.name.charAt(0)}
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">\${student.name}</p>
                                <p class="text-sm text-gray-500">\${student.class_name || 'ë°˜ ë¯¸ë°°ì •'} Â· \${student.grade}</p>
                            </div>
                        </div>
                        <a href="/students/detail/\${student.id}" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            ìƒì„¸ë³´ê¸°
                        </a>
                    </div>
                \`).join('');
            }

            // ì„ ìƒë‹˜ ê´€ë¦¬ ì„¹ì…˜ í† ê¸€
            function toggleTeacherSection() {
                const section = document.getElementById('teacherSection');
                const icon = document.getElementById('teacherSectionIcon');
                
                if (section.classList.contains('hidden')) {
                    section.classList.remove('hidden');
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                    loadTeacherData();
                } else {
                    section.classList.add('hidden');
                    icon.classList.remove('fa-chevron-up');
                    icon.classList.add('fa-chevron-down');
                }
            }

            function loadTeacherData() {
                if (!currentUser) return;
                loadVerificationCode();
                loadTeachersList();
                loadPendingApplications();
            }

            async function loadVerificationCode() {
                try {
                    console.log('[Frontend] Loading verification code for user:', currentUser);
                    
                    const res = await fetch('/api/teachers/verification-code?directorId=' + currentUser.id);
                    const data = await res.json();
                    console.log('[Frontend] Verification code response:', data);
                    
                    if (data.success) {
                        // code ìš°ì„ , ê·¸ ë‹¤ìŒ codeData.code, ë§ˆì§€ë§‰ìœ¼ë¡œ codeData.verification_code
                        const code = data.code || (data.codeData && (data.codeData.code || data.codeData.verification_code)) || '------';
                        console.log('[Frontend] Setting code to:', code);
                        
                        const codeElement = document.getElementById('verificationCode');
                        if (codeElement) {
                            codeElement.textContent = code;
                            // ì½”ë“œê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                            if (code === '------' || code === 'ì˜¤ë¥˜' || code === 'ERROR') {
                                codeElement.classList.add('text-red-600');
                                codeElement.classList.remove('text-purple-600');
                            } else {
                                codeElement.classList.add('text-purple-600');
                                codeElement.classList.remove('text-red-600');
                            }
                        }
                    } else {
                        console.error('[Frontend] ì¸ì¦ ì½”ë“œ ë¡œë”© ì‹¤íŒ¨:', data.error, data.details);
                        const codeElement = document.getElementById('verificationCode');
                        if (codeElement) {
                            codeElement.textContent = 'ì˜¤ë¥˜';
                            codeElement.classList.add('text-red-600');
                            codeElement.classList.remove('text-purple-600');
                        }
                        alert('ì¸ì¦ ì½”ë“œ ë¡œë”© ì‹¤íŒ¨: ' + data.error);
                    }
                } catch (error) {
                    console.error('[Frontend] ì¸ì¦ ì½”ë“œ ë¡œë”© ì‹¤íŒ¨:', error);
                    const codeElement = document.getElementById('verificationCode');
                    if (codeElement) {
                        codeElement.textContent = 'ì˜¤ë¥˜';
                        codeElement.classList.add('text-red-600');
                        codeElement.classList.remove('text-purple-600');
                    }
                }
            }

            async function regenerateVerificationCode() {
                if (!confirm('ì¸ì¦ ì½”ë“œë¥¼ ì¬ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nâš ï¸ ì´ì „ ì½”ë“œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.')) return;
                try {
                    console.log('[Frontend] Regenerating code for user:', currentUser);
                    
                    const res = await fetch('/api/teachers/verification-code/regenerate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ directorId: currentUser.id })
                    });
                    const data = await res.json();
                    console.log('[Frontend] Regenerate response:', data);
                    
                    if (data.success) {
                        // code ìš°ì„ , ê·¸ ë‹¤ìŒ codeData.code, ë§ˆì§€ë§‰ìœ¼ë¡œ codeData.verification_code
                        const newCode = data.code || (data.codeData && (data.codeData.code || data.codeData.verification_code));
                        console.log('[Frontend] New code:', newCode);
                        
                        const codeElement = document.getElementById('verificationCode');
                        if (codeElement) {
                            codeElement.textContent = newCode;
                            codeElement.classList.add('text-purple-600');
                            codeElement.classList.remove('text-red-600');
                        }
                        alert('âœ… ì¸ì¦ ì½”ë“œê°€ ì¬ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\nìƒˆ ì½”ë“œ: ' + newCode);
                    } else {
                        console.error('[Frontend] ì¬ìƒì„± ì‹¤íŒ¨:', data);
                        alert('âŒ ì½”ë“œ ì¬ìƒì„± ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                        console.error('ì¬ìƒì„± ì‹¤íŒ¨ ìƒì„¸:', data);
                    }
                } catch (error) {
                    console.error('ì½”ë“œ ì¬ìƒì„± ì‹¤íŒ¨:', error);
                    alert('ì½”ë“œ ì¬ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }

            function copyVerificationCode() {
                const code = document.getElementById('verificationCode').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    alert('ì¸ì¦ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + code);
                });
            }

            function copyRegisterLink() {
                const link = 'https://superplace-academy.pages.dev/signup?teacher=true';
                navigator.clipboard.writeText(link).then(() => {
                    alert('ë“±ë¡ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                });
            }

            async function loadTeachersList() {
                try {
                    const res = await fetch('/api/teachers/list?directorId=' + currentUser.id);
                    const data = await res.json();
                    const container = document.getElementById('teachersList');
                    
                    if (!data.success || data.teachers.length === 0) {
                        container.innerHTML = '<div class="text-center text-gray-500 py-8">ë“±ë¡ëœ ì„ ìƒë‹˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    container.innerHTML = data.teachers.map(teacher => {
                        const escapedName = (teacher.name || '').replace(/'/g, "\\'");
                        return \`
                        <div class="bg-white border rounded-xl p-6 hover:shadow-lg transition">
                            <div class="flex items-start justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="w-14 h-14 bg-purple-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user-tie text-purple-600 text-2xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-900">\${teacher.name}</h3>
                                        <p class="text-sm text-gray-600">\${teacher.email}</p>
                                        <p class="text-sm text-gray-500">\${teacher.phone || '-'}</p>
                                        <span class="inline-block mt-2 px-3 py-1 bg-purple-100 text-purple-600 rounded-full text-xs font-medium">
                                            ë‹´ë‹¹ ë°˜: \${teacher.class_count || 0}ê°œ
                                        </span>
                                    </div>
                                </div>
                                <button onclick="showTeacherPermissions(\${teacher.id}, '\${escapedName}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                    <i class="fas fa-cog mr-2"></i>ê¶Œí•œ ì„¤ì •
                                </button>
                            </div>
                        </div>
                        \`;
                    }).join('');
                } catch (error) {
                    console.error('ì„ ìƒë‹˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
                }
            }

            async function loadPendingApplications() {
                try {
                    const res = await fetch('/api/teachers/applications?directorId=' + currentUser.id + '&status=pending');
                    const data = await res.json();
                    const container = document.getElementById('pendingList');
                    const countBadge = document.getElementById('pendingBadge');
                    
                    console.log('[LoadPending] Response:', data);
                    
                    if (!data.success || !data.applications || data.applications.length === 0) {
                        if (container) container.innerHTML = '<div class="text-center text-gray-500 py-8">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        if (countBadge) countBadge.textContent = '0';
                        return;
                    }

                    if (countBadge) countBadge.textContent = data.applications.length;
                    if (container) {
                        container.innerHTML = data.applications.map(app => {
                            const escapedName = (app.name || '').replace(/'/g, "\\'");
                            return \`
                            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-900">\${app.name}</h3>
                                        <p class="text-sm text-gray-600">\${app.email}</p>
                                        <p class="text-sm text-gray-500">\${app.phone || '-'}</p>
                                        <p class="text-xs text-gray-400 mt-2">ì‹ ì²­ì¼: \${new Date(app.applied_at).toLocaleString('ko-KR')}</p>
                                    </div>
                                    <span class="px-3 py-1 bg-yellow-500 text-white rounded-full text-xs font-medium">
                                        ëŒ€ê¸°ì¤‘
                                    </span>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="approveApplication(\${app.id}, '\${escapedName}')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                        <i class="fas fa-check mr-2"></i>ìŠ¹ì¸
                                    </button>
                                    <button onclick="rejectApplication(\${app.id}, '\${escapedName}')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                        <i class="fas fa-times mr-2"></i>ê±°ì ˆ
                                    </button>
                                </div>
                            </div>
                            \`;
                        }).join('');
                    }
                } catch (error) {
                    console.error('ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
                    alert('ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ë¡œë”© ì‹¤íŒ¨: ' + error.message);
                }
            }

            async function approveApplication(id, name) {
                if (!confirm(\`\${name} ì„ ìƒë‹˜ì˜ ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) return;
                try {
                    const res = await fetch(\`/api/teachers/applications/\${id}/approve\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ directorId: currentUser.id })
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert(\`\${name} ì„ ìƒë‹˜ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!\`);
                        loadPendingApplications();
                        loadTeachersList();
                        loadDashboard();
                    } else {
                        alert('ìŠ¹ì¸ ì‹¤íŒ¨: ' + data.error);
                    }
                } catch (error) {
                    console.error('ìŠ¹ì¸ ì‹¤íŒ¨:', error);
                    alert('ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            async function rejectApplication(id, name) {
                if (!confirm(\`\${name} ì„ ìƒë‹˜ì˜ ì‹ ì²­ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) return;
                const reason = prompt('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­):');
                try {
                    const res = await fetch(\`/api/teachers/applications/\${id}/reject\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            directorId: currentUser.id,
                            reason: reason || 'ìŠ¹ì¸ ê±°ë¶€'
                        })
                    });
                    const data = await res.json();
                    if (data.success) {
                        alert(\`\${name} ì„ ìƒë‹˜ì˜ ì‹ ì²­ì´ ê±°ì ˆë˜ì—ˆìŠµë‹ˆë‹¤.\`);
                        loadPendingApplications();
                    } else {
                        alert('ê±°ì ˆ ì‹¤íŒ¨: ' + data.error);
                    }
                } catch (error) {
                    console.error('ê±°ì ˆ ì‹¤íŒ¨:', error);
                    alert('ê±°ì ˆ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            async function showTeacherPermissions(teacherId, teacherName) {
                // ëª¨ë‹¬ ì—´ê¸°
                document.getElementById('permissionsModal').classList.remove('hidden');
                document.getElementById('permissionsTeacherName').textContent = teacherName;
                document.getElementById('permissionsTeacherId').value = teacherId;
                
                console.log('ğŸ” [ShowPermissions] Opening modal for teacher:', teacherId, teacherName);
                console.log('ğŸ” [ShowPermissions] Current user:', currentUser);
                
                try {
                    // ë°˜ ëª©ë¡ ë¡œë“œ - /api/classes/list ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                    const classesRes = await fetch(\`/api/classes/list?userId=\${currentUser.id}&userType=director\`);
                    const classesData = await classesRes.json();
                    
                    console.log('ğŸ“š [ShowPermissions] Classes response:', classesData);
                    
                    if (classesData.success) {
                        const classList = document.getElementById('classesCheckboxList');
                        if (classesData.classes && classesData.classes.length > 0) {
                            console.log('âœ… [ShowPermissions] Found ' + classesData.classes.length + ' classes');
                            classList.innerHTML = classesData.classes.map(cls => \`
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="checkbox" value="\${cls.id}" class="class-checkbox w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                    <span class="ml-2 text-sm text-gray-700">\${cls.name || cls.class_name} \${cls.grade_level || cls.grade || ''}</span>
                                </label>
                            \`).join('');
                        } else {
                            console.warn('âš ï¸ [ShowPermissions] No classes found');
                            classList.innerHTML = '<div class="text-center text-gray-500 py-4">ë“±ë¡ëœ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                        }
                    } else {
                        console.error('âŒ [ShowPermissions] Classes API failed:', classesData.error);
                        document.getElementById('classesCheckboxList').innerHTML = '<div class="text-center text-red-500 py-4">ë°˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ' + (classesData.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '</div>';
                    }
                    
                    // ì„ ìƒë‹˜ ê¶Œí•œ ì •ë³´ ë¡œë“œ
                    console.log('ğŸ” [ShowPermissions] Loading permissions for teacher:', teacherId);
                    const permRes = await fetch(\`/api/teachers/\${teacherId}/permissions?directorId=\${currentUser.id}\`);
                    const permData = await permRes.json();
                    
                    console.log('ğŸ” [ShowPermissions] Permissions response:', permData);
                    
                    if (permData.success) {
                        const hasFullAccess = permData.permissions?.canViewAllStudents || false;
                        const assignedClasses = permData.permissions?.assignedClasses || [];
                        
                        // ë¼ë””ì˜¤ ë²„íŠ¼ ì„¤ì •
                        if (hasFullAccess) {
                            document.getElementById('accessLevelAll').checked = true;
                            document.getElementById('classAssignmentSection').style.display = 'none';
                            // ì˜µì…˜ ê°•ì¡°
                            document.getElementById('allAccessOption').classList.add('border-purple-500', 'bg-purple-50');
                            document.getElementById('assignedOnlyOption').classList.remove('border-purple-500', 'bg-purple-50');
                        } else if (assignedClasses.length > 0) {
                            document.getElementById('accessLevelAssigned').checked = true;
                            document.getElementById('classAssignmentSection').style.display = 'block';
                            // ì˜µì…˜ ê°•ì¡°
                            document.getElementById('assignedOnlyOption').classList.add('border-purple-500', 'bg-purple-50');
                            document.getElementById('allAccessOption').classList.remove('border-purple-500', 'bg-purple-50');
                            
                            // ë°°ì •ëœ ë°˜ ì²´í¬
                            console.log('ğŸ” [ShowPermissions] Assigned classes:', assignedClasses);
                            document.querySelectorAll('.class-checkbox').forEach(checkbox => {
                                const classId = parseInt(checkbox.value);
                                checkbox.checked = assignedClasses.includes(classId);
                                console.log('  - Class', classId, 'checked:', checkbox.checked);
                            });
                        } else {
                            // ê¶Œí•œ ì—†ìŒ - ê¸°ë³¸ê°’
                            document.getElementById('accessLevelAll').checked = false;
                            document.getElementById('accessLevelAssigned').checked = false;
                            document.getElementById('classAssignmentSection').style.display = 'none';
                        }
                    } else {
                        console.error('âŒ [ShowPermissions] Failed to load permissions:', permData.error);
                    }
                } catch (error) {
                    console.error('âŒ [ShowPermissions] Exception:', error);
                    console.error('âŒ [ShowPermissions] Stack:', error.stack);
                    alert('ê¶Œí•œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            }
            
            // ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ ì‹œ ë°˜ ë°°ì • ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
            document.addEventListener('DOMContentLoaded', function() {
                const allAccessRadio = document.getElementById('accessLevelAll');
                const assignedRadio = document.getElementById('accessLevelAssigned');
                const classSection = document.getElementById('classAssignmentSection');
                const allOption = document.getElementById('allAccessOption');
                const assignedOption = document.getElementById('assignedOnlyOption');
                
                if (allAccessRadio) {
                    allAccessRadio.addEventListener('change', function() {
                        if (this.checked) {
                            classSection.style.display = 'none';
                            allOption.classList.add('border-purple-500', 'bg-purple-50');
                            assignedOption.classList.remove('border-purple-500', 'bg-purple-50');
                        }
                    });
                }
                
                if (assignedRadio) {
                    assignedRadio.addEventListener('change', function() {
                        if (this.checked) {
                            classSection.style.display = 'block';
                            assignedOption.classList.add('border-purple-500', 'bg-purple-50');
                            allOption.classList.remove('border-purple-500', 'bg-purple-50');
                        }
                    });
                }
            });
            
            function closePermissionsModal() {
                document.getElementById('permissionsModal').classList.add('hidden');
                document.getElementById('permissionsForm').reset();
                document.getElementById('classAssignmentSection').style.display = 'none';
                document.getElementById('allAccessOption').classList.remove('border-purple-500', 'bg-purple-50');
                document.getElementById('assignedOnlyOption').classList.remove('border-purple-500', 'bg-purple-50');
            }
            
            // ê¶Œí•œ ì €ì¥
            document.getElementById('permissionsForm').addEventListener('submit', /* v1768961716 */ async (e) => {
                e.preventDefault();
                
                console.log('ğŸ”’ [SavePermissions] Form submitted');
                
                const teacherId = document.getElementById('permissionsTeacherId').value;
                const teacherName = document.getElementById('permissionsTeacherName').textContent;
                
                console.log('ğŸ”’ [SavePermissions] teacherId:', teacherId);
                console.log('ğŸ”’ [SavePermissions] teacherName:', teacherName);
                console.log('ğŸ”’ [SavePermissions] currentUser:', currentUser);
                
                // ë¼ë””ì˜¤ ë²„íŠ¼ ê°’ í™•ì¸
                const accessLevel = document.querySelector('input[name="accessLevel"]:checked')?.value;
                
                if (!accessLevel) {
                    alert('âŒ ê¶Œí•œ ë ˆë²¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                let permissions;
                
                if (accessLevel === 'all') {
                    // ëª¨ë‘ ë‹¤ ê³µê°œ
                    permissions = {
                        canViewAllStudents: true,
                        canWriteDailyReports: true,
                        assignedClasses: []  // ì „ì²´ ì ‘ê·¼ì´ë¯€ë¡œ ë¹ˆ ë°°ì—´
                    };
                    console.log('ğŸ”’ [SavePermissions] Selected: ëª¨ë‘ ë‹¤ ê³µê°œ');
                } else {
                    // ë°°ì •ëœ ë°˜ë§Œ ê³µê°œ
                    const assignedClasses = Array.from(document.querySelectorAll('.class-checkbox:checked'))
                        .map(cb => parseInt(cb.value));
                    
                    if (assignedClasses.length === 0) {
                        alert('âŒ ìµœì†Œ 1ê°œ ì´ìƒì˜ ë°˜ì„ ë°°ì •í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    permissions = {
                        canViewAllStudents: false,
                        canWriteDailyReports: true,  // ë°°ì •ëœ ë°˜ì— ëŒ€í•´ì„œëŠ” ì¼ì¼ ì„±ê³¼ ì‘ì„± ê°€ëŠ¥
                        assignedClasses: assignedClasses
                    };
                    console.log('ğŸ”’ [SavePermissions] Selected: ë°°ì •ëœ ë°˜ë§Œ ê³µê°œ, classes:', assignedClasses);
                }
                
                console.log('ğŸ”’ [SavePermissions] Final permissions:', permissions);
                console.log('ğŸ”’ [SavePermissions] directorId:', currentUser?.id);
                
                if (!currentUser?.id) {
                    alert('âŒ ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                if (!teacherId) {
                    alert('âŒ ì„ ìƒë‹˜ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                try {
                    console.log('ğŸ”’ [SavePermissions] Sending request to /api/teachers/' + teacherId + '/permissions');
                    
                    const requestBody = {
                        directorId: currentUser.id,
                        permissions: permissions
                    };
                    
                    console.log('ğŸ”’ [SavePermissions] Request body:', JSON.stringify(requestBody, null, 2));
                    
                    const res = await fetch(\`/api/teachers/\${teacherId}/permissions\`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    
                    console.log('ğŸ”’ [SavePermissions] Response status:', res.status);
                    console.log('ğŸ”’ [SavePermissions] Response ok:', res.ok);
                    
                    const data = await res.json();
                    console.log('ğŸ”’ [SavePermissions] Response data:', data);
                    
                    if (data.success) {
                        // ì €ì¥ í›„ ì‹¤ì œ ì €ì¥ëœ ê¶Œí•œ í™•ì¸
                        console.log('âœ… [SavePermissions] Success!');
                        alert('âœ… ' + teacherName + ' ì„ ìƒë‹˜ì˜ ê¶Œí•œì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        closePermissionsModal();
                        // ì„ ìƒë‹˜ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                        location.reload();
                    } else {
                        alert('âŒ ê¶Œí•œ ì €ì¥ ì‹¤íŒ¨: ' + data.error);
                        console.error('âŒ [SavePermissions] Failed:', data.error);
                    }
                } catch (error) {
                    console.error('âŒ [SavePermissions] Exception:', error);
                    console.error('âŒ [SavePermissions] Stack:', error.stack);
                    alert('âŒ ê¶Œí•œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            });

            function openAddTeacherModal() {
                document.getElementById('addTeacherModal').classList.remove('hidden');
            }

            function closeAddTeacherModal() {
                document.getElementById('addTeacherModal').classList.add('hidden');
                document.getElementById('addTeacherForm').reset();
            }

            // ì„ ìƒë‹˜ ì¶”ê°€ í¼ ì œì¶œ
            document.getElementById('addTeacherForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                console.log('[AddTeacher] Form submitted');
                console.log('[AddTeacher] Current user:', currentUser);
                
                const formData = new FormData(e.target);
                const data = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    password: formData.get('password'),
                    directorId: currentUser?.id
                };
                
                console.log('[AddTeacher] Form data:', data);
                
                if (!data.directorId) {
                    alert('ë¡œê·¸ì¸ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    return;
                }

                try {
                    console.log('[AddTeacher] Sending request...');
                    const res = await fetch('/api/teachers/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    console.log('[AddTeacher] Response status:', res.status);
                    const result = await res.json();
                    console.log('[AddTeacher] Response data:', result);
                    
                    if (result.success) {
                        alert(\`\${data.name} ì„ ìƒë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!\`);
                        closeAddTeacherModal();
                        loadTeachersList();
                        loadDashboard();
                    } else {
                        alert('ì¶”ê°€ ì‹¤íŒ¨: ' + result.error);
                        if (result.details) {
                            console.error('[AddTeacher] Error details:', result.details);
                        }
                    }
                } catch (error) {
                    console.error('[AddTeacher] Network error:', error);
                    alert('ì„ ìƒë‹˜ ì¶”ê°€ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            });

            // í˜ì´ì§€ ì´ˆê¸°í™” (ë¡œê·¸ì¸ëœ ê²½ìš°ì—ë§Œ)
            if (!shouldRedirect && currentUser) {
                initializePage();
            }
        </script>
    </body>
    </html>
  `)
})

// ìºì‹œ ê°•ì œ ì‚­ì œ í˜ì´ì§€
app.get('/clear-cache', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ìºì‹œ ì‚­ì œ ì¤‘...</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-50 flex items-center justify-center min-h-screen">
        <div class="text-center p-8 bg-white rounded-xl shadow-lg max-w-md">
            <div class="mb-6">
                <i class="fas fa-sync-alt fa-spin text-6xl text-purple-600"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-900 mb-4">ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ ì¤‘...</h1>
            <p class="text-gray-600 mb-6">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            <div id="status" class="text-sm text-gray-500"></div>
        </div>
        
        <script>
            const statusEl = document.getElementById('status');
            let step = 1;
            
            async function clearCache() {
                try {
                    // Step 1: Service Worker ì œê±°
                    statusEl.textContent = 'Step 1/4: Service Worker ì œê±° ì¤‘...';
                    if ('serviceWorker' in navigator) {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for(let registration of registrations) {
                            await registration.unregister();
                        }
                    }
                    
                    await sleep(500);
                    
                    // Step 2: ëª¨ë“  ìºì‹œ ì‚­ì œ
                    statusEl.textContent = 'Step 2/4: ìºì‹œ ìŠ¤í† ë¦¬ì§€ ì‚­ì œ ì¤‘...';
                    if ('caches' in window) {
                        const names = await caches.keys();
                        for (let name of names) {
                            await caches.delete(name);
                        }
                    }
                    
                    await sleep(500);
                    
                    // Step 3: localStorage/sessionStorage ì •ë¦¬
                    statusEl.textContent = 'Step 3/4: ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì •ë¦¬ ì¤‘...';
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    await sleep(500);
                    
                    // Step 4: ì™„ë£Œ
                    statusEl.textContent = 'Step 4/4: ì™„ë£Œ!';
                    
                    await sleep(1000);
                    
                    alert('âœ… ìºì‹œê°€ ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!

í™•ì¸ì„ ëˆ„ë¥´ë©´ í•™ìƒ ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    window.location.href = '/students?nocache=' + Date.now();
                    
                } catch (error) {
                    console.error('Cache clear error:', error);
                    alert('ìºì‹œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ë¥¼ ì§ì ‘ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš” (Ctrl+Shift+R)');
                }
            }
            
            function sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
            clearCache();
        </script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </body>
    </html>
  `)
})


// ë°˜ ê´€ë¦¬ í˜ì´ì§€
app.get('/students/classes', (c) => {
  return c.html(studentPages.classesPage)
})

// í•™ìƒ ëª©ë¡ í˜ì´ì§€
app.get('/students/list', (c) => {
  return c.html(studentPages.studentsListPage)
})

// ì¼ì¼ ì„±ê³¼ ê¸°ë¡ í˜ì´ì§€
app.get('/students/daily-record', (c) => {
  return c.html(studentPages.dailyRecordPage)
})

// ê³¼ëª© ê´€ë¦¬ í˜ì´ì§€
app.get('/students/courses', (c) => {
  return c.html(studentPages.coursesPage)
})

// í•™ìƒ ìƒì„¸ í˜ì´ì§€
app.get('/students/detail/:studentId', (c) => {
  return c.html(studentPages.studentDetailPage)
})

// DB ì´ˆê¸°í™” API (í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ í•™ìƒ ê´€ë¦¬ í…Œì´ë¸” ìƒì„±ìš©)
app.get('/api/init-student-tables', async (c) => {
  try {
    const { DB } = c.env
    
    // í•™ìƒ ì •ë³´ í…Œì´ë¸” ìƒì„± (ë¨¼ì € ìƒì„±)
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS students (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        academy_id INTEGER DEFAULT 1,
        name TEXT NOT NULL,
        phone TEXT,
        parent_name TEXT NOT NULL,
        parent_phone TEXT NOT NULL,
        parent_email TEXT,
        grade TEXT NOT NULL,
        subjects TEXT NOT NULL,
        enrollment_date DATE NOT NULL,
        status TEXT DEFAULT 'active',
        notes TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run()
    
    // ë°˜(Class) í…Œì´ë¸” ìƒì„±
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS classes (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        academy_id INTEGER DEFAULT 1,
        class_name TEXT NOT NULL,
        grade TEXT,
        description TEXT,
        schedule_days TEXT,
        start_time TEXT,
        end_time TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run()
    
    // classes í…Œì´ë¸”ì— ìŠ¤ì¼€ì¤„ ì»´ëŸ¼ ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œ)
    try {
      await DB.prepare(`ALTER TABLE classes ADD COLUMN schedule_days TEXT`).run()
    } catch (e) {
      console.log('schedule_days column already exists')
    }
    try {
      await DB.prepare(`ALTER TABLE classes ADD COLUMN start_time TEXT`).run()
    } catch (e) {
      console.log('start_time column already exists')
    }
    try {
      await DB.prepare(`ALTER TABLE classes ADD COLUMN end_time TEXT`).run()
    } catch (e) {
      console.log('end_time column already exists')
    }
    try {
      await DB.prepare(`ALTER TABLE classes ADD COLUMN color TEXT DEFAULT '#8B5CF6'`).run()
    } catch (e) {
      console.log('color column already exists')
    }
    try {
      await DB.prepare(`ALTER TABLE classes ADD COLUMN day_schedule TEXT`).run()
    } catch (e) {
      console.log('day_schedule column already exists')
    }
    
    // ê³¼ëª©(Course) í…Œì´ë¸” ìƒì„±
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS courses (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        academy_id INTEGER DEFAULT 1,
        course_name TEXT NOT NULL,
        description TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run()
    
    // í•™ìƒ í…Œì´ë¸”ì— class_id ì»¬ëŸ¼ ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œ)
    try {
      await DB.prepare(`ALTER TABLE students ADD COLUMN class_id INTEGER`).run()
    } catch (e) {
      // ì»¬ëŸ¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë¬´ì‹œ
      console.log('class_id column already exists')
    }
    
    // ì¼ì¼ ì„±ê³¼ ê¸°ë¡ í…Œì´ë¸” ìƒì„±
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS daily_records (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        student_id INTEGER NOT NULL,
        class_id INTEGER,
        record_date DATE NOT NULL,
        attendance TEXT CHECK(attendance IN ('ì¶œì„', 'ì§€ê°', 'ê²°ì„', 'ì¡°í‡´')),
        lesson_concept TEXT,
        lesson_understanding INTEGER CHECK(lesson_understanding >= 1 AND lesson_understanding <= 5),
        lesson_participation INTEGER CHECK(lesson_participation >= 1 AND lesson_participation <= 5),
        lesson_achievement TEXT,
        homework_status TEXT CHECK(homework_status IN ('ì™„ë£Œ', 'ë¯¸ì™„ë£Œ', 'ë¶€ë¶„ì™„ë£Œ')),
        homework_content TEXT,
        homework_achievement TEXT,
        memo TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run()
    
    // ê¸°ì¡´ í…Œì´ë¸”ì— ìƒˆ ì»¬ëŸ¼ ì¶”ê°€ (ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œ)
    try {
      await DB.prepare(`ALTER TABLE daily_records ADD COLUMN class_id INTEGER`).run()
    } catch (e) {
      console.log('class_id column already exists')
    }
    try {
      await DB.prepare(`ALTER TABLE daily_records ADD COLUMN lesson_concept TEXT`).run()
    } catch (e) {
      console.log('lesson_concept column already exists')
    }
    try {
      await DB.prepare(`ALTER TABLE daily_records ADD COLUMN lesson_understanding INTEGER`).run()
    } catch (e) {
      console.log('lesson_understanding column already exists')
    }
    try {
      await DB.prepare(`ALTER TABLE daily_records ADD COLUMN lesson_participation INTEGER`).run()
    } catch (e) {
      console.log('lesson_participation column already exists')
    }
    try {
      await DB.prepare(`ALTER TABLE daily_records ADD COLUMN lesson_achievement TEXT`).run()
    } catch (e) {
      console.log('lesson_achievement column already exists')
    }
    try {
      await DB.prepare(`ALTER TABLE daily_records ADD COLUMN homework_content TEXT`).run()
    } catch (e) {
      console.log('homework_content column already exists')
    }
    try {
      await DB.prepare(`ALTER TABLE daily_records ADD COLUMN homework_achievement TEXT`).run()
    } catch (e) {
      console.log('homework_achievement column already exists')
    }
    
    // ë‹¤ìŒ ìˆ™ì œ í•„ë“œ
    try {
      await DB.prepare(`ALTER TABLE daily_records ADD COLUMN next_homework_type TEXT`).run()
    } catch (e) {
      console.log('next_homework_type column already exists')
    }
    
    try {
      await DB.prepare(`ALTER TABLE daily_records ADD COLUMN next_homework_start_page INTEGER`).run()
    } catch (e) {
      console.log('next_homework_start_page column already exists')
    }
    
    try {
      await DB.prepare(`ALTER TABLE daily_records ADD COLUMN next_homework_end_page INTEGER`).run()
    } catch (e) {
      console.log('next_homework_end_page column already exists')
    }
    
    try {
      await DB.prepare(`ALTER TABLE daily_records ADD COLUMN next_homework_details TEXT`).run()
    } catch (e) {
      console.log('next_homework_details column already exists')
    }
    
    // ì¸ë±ìŠ¤ ìƒì„±
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_students_academy_id ON students(academy_id)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_classes_academy_id ON classes(academy_id)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_courses_academy_id ON courses(academy_id)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_students_class_id ON students(class_id)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_daily_records_student_id ON daily_records(student_id)`).run()
    await DB.prepare(`CREATE INDEX IF NOT EXISTS idx_daily_records_date ON daily_records(record_date)`).run()
    
    return c.json({
      success: true,
      message: 'í•™ìƒ ê´€ë¦¬ í…Œì´ë¸”ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! (students, classes, courses, daily_records)'
    })
  } catch (error: any) {
    return c.json({
      success: false,
      error: error.message
    }, 500)
  }
})

// ë””ë²„ê·¸: í•™ìƒ ì°¸ì¡° í™•ì¸ API
app.get('/api/debug/student-references/:studentId', async (c) => {
  try {
    const studentId = c.req.param('studentId')
    const { DB } = c.env
    
    const references: any = {}
    
    // daily_records í™•ì¸
    const dailyRecords = await DB.prepare('SELECT COUNT(*) as count FROM daily_records WHERE student_id = ?').bind(studentId).first()
    references.daily_records = dailyRecords
    
    // í•™ìƒ ì •ë³´ í™•ì¸
    const student = await DB.prepare('SELECT * FROM students WHERE id = ?').bind(studentId).first()
    references.student = student
    
    return c.json({
      success: true,
      studentId,
      references
    })
  } catch (error: any) {
    return c.json({
      success: false,
      error: error.message
    }, 500)
  }
})

// ë””ë²„ê¹… API: í˜„ì¬ ì„ ìƒë‹˜ì˜ ì €ì¥ëœ ê¶Œí•œ í™•ì¸
app.get('/api/debug/my-permissions', async (c) => {
  try {
    const user = JSON.parse(c.req.header('X-User-Data-Base64') ? decodeURIComponent(escape(atob(c.req.header('X-User-Data-Base64') || ''))) : '{"id":1}')
    
    console.log('ğŸ” [DebugPermissions] User ID:', user.id)
    
    // teacher_permissions í…Œì´ë¸”ì—ì„œ ê¶Œí•œ ì¡°íšŒ
    const permRows = await c.env.DB.prepare(
      'SELECT permission_key, permission_value FROM teacher_permissions WHERE teacher_id = ?'
    ).bind(user.id).all()
    
    console.log('ğŸ” [DebugPermissions] Found', permRows.results?.length || 0, 'permission rows')
    
    const permissions = {}
    if (permRows.results) {
      for (const row of permRows.results) {
        const key = row.permission_key
        const value = row.permission_value
        
        // ê°’ íŒŒì‹±
        if (key === 'assignedClasses' && typeof value === 'string') {
          try {
            permissions[key] = JSON.parse(value)
          } catch (e) {
            permissions[key] = value
          }
        } else if (key === 'canViewAllStudents' || key === 'canWriteDailyReports') {
          permissions[key] = value === '1' || value === 1 || value === true
        } else {
          permissions[key] = value
        }
      }
    }
    
    return c.json({
      success: true,
      userId: user.id,
      rawRows: permRows.results,
      parsedPermissions: permissions
    })
  } catch (err) {
    console.error('âŒ [DebugPermissions] Error:', err)
    return c.json({ success: false, error: err.message }, 500)
  }
})

// ğŸš€ ì´ˆê¸° ë°ì´í„° ìƒì„± API (ë°˜ ìë™ ìƒì„±)
app.post('/api/admin/init-sample-classes', async (c) => {
  try {
    const { userId } = await c.req.json()
    
    if (!userId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }
    
    console.log('[InitClasses] Creating sample classes for userId:', userId)
    
    const sampleClasses = [
      { name: 'ì´ˆë“± 3í•™ë…„ ìˆ˜í•™ë°˜', grade: '3í•™ë…„', description: 'ì´ˆë“±í•™êµ 3í•™ë…„ ìˆ˜í•™ ìˆ˜ì—…' },
      { name: 'ì´ˆë“± 4í•™ë…„ ìˆ˜í•™ë°˜', grade: '4í•™ë…„', description: 'ì´ˆë“±í•™êµ 4í•™ë…„ ìˆ˜í•™ ìˆ˜ì—…' },
      { name: 'ì´ˆë“± 5í•™ë…„ ìˆ˜í•™ë°˜', grade: '5í•™ë…„', description: 'ì´ˆë“±í•™êµ 5í•™ë…„ ìˆ˜í•™ ìˆ˜ì—…' }
    ]
    
    const created = []
    
    for (const cls of sampleClasses) {
      const result = await c.env.DB.prepare(`
        INSERT INTO classes (name, description, user_id, grade_level, max_students, status, created_at)
        VALUES (?, ?, ?, ?, 20, 'active', datetime('now'))
      `).bind(cls.name, cls.description, userId, cls.grade).run()
      
      created.push({
        id: result.meta.last_row_id,
        name: cls.name,
        grade: cls.grade
      })
      
      console.log('[InitClasses] Created class:', cls.name, 'with ID:', result.meta.last_row_id)
    }
    
    return c.json({
      success: true,
      message: `${created.length}ê°œì˜ ìƒ˜í”Œ ë°˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`,
      classes: created
    })
  } catch (err) {
    console.error('[InitClasses] Error:', err)
    return c.json({ success: false, error: err.message }, 500)
  }
})

// ==================== TEMPORARY FIX ====================
// Create empty teacher_classes table to fix D1 error
app.get('/api/fix-teacher-classes-error', async (c) => {
  try {
    // Create teacher_classes table (empty, unused, just to prevent error)
    await c.env.DB.prepare(`
      CREATE TABLE IF NOT EXISTS teacher_classes (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        teacher_id INTEGER NOT NULL,
        class_id INTEGER NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(teacher_id, class_id)
      )
    `).run()
    
    return c.json({ 
      success: true, 
      message: 'teacher_classes í…Œì´ë¸”ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤ (ì„ì‹œ ìˆ˜ì •)',
      note: 'ì´ í…Œì´ë¸”ì€ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ D1 ì—ëŸ¬ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤'
    })
  } catch (err) {
    return c.json({ success: false, error: err.message }, 500)
  }
})
// ==================== END TEMPORARY FIX ====================

// ì‚¬ìš©ì ë° ë°˜ ì •ë³´ ì¡°íšŒ API
app.get('/api/admin/get-user-classes', async (c) => {
  try {
    const { DB } = c.env
    const email = c.req.query('email')
    
    if (!email) {
      return c.json({ success: false, error: 'Email parameter required' }, 400)
    }
    
    // ì‚¬ìš©ì ì°¾ê¸°
    const user = await DB.prepare('SELECT id, email, name, academy_name FROM users WHERE email = ?')
      .bind(email)
      .first()
    
    if (!user) {
      return c.json({ success: false, error: 'User not found' }, 404)
    }
    
    // í•´ë‹¹ ì‚¬ìš©ìì˜ ë°˜ ëª©ë¡ (academy_id ì‚¬ìš©)
    const classes = await DB.prepare(`
      SELECT c.*, COUNT(s.id) as student_count
      FROM classes c
      LEFT JOIN students s ON c.id = s.class_id AND s.status = 'active'
      WHERE c.academy_id = ?
      GROUP BY c.id
      ORDER BY c.class_name
    `).bind(user.id).all()
    
    return c.json({
      success: true,
      user,
      classes: classes.results || []
    })
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ë°˜ ì†Œìœ ê¶Œ ì´ì „ API
app.post('/api/admin/transfer-classes', async (c) => {
  try {
    const { DB } = c.env
    const { fromEmail, toEmail, classIds } = await c.req.json()
    
    if (!fromEmail || !toEmail || !classIds || !Array.isArray(classIds)) {
      return c.json({ 
        success: false, 
        error: 'fromEmail, toEmail, and classIds array required' 
      }, 400)
    }
    
    // ë‘ ì‚¬ìš©ì ì°¾ê¸°
    const fromUser = await DB.prepare('SELECT id, email, name FROM users WHERE email = ?')
      .bind(fromEmail).first()
    const toUser = await DB.prepare('SELECT id, email, name FROM users WHERE email = ?')
      .bind(toEmail).first()
    
    if (!fromUser || !toUser) {
      return c.json({ 
        success: false, 
        error: !fromUser ? 'From user not found' : 'To user not found' 
      }, 404)
    }
    
    // ê° ë°˜ì˜ ì†Œìœ ê¶Œ ì´ì „
    const transferred = []
    for (const classId of classIds) {
      // ë°˜ì´ fromUser ì†Œìœ ì¸ì§€ í™•ì¸ (academy_id ì‚¬ìš©)
      const classInfo = await DB.prepare('SELECT * FROM classes WHERE id = ? AND academy_id = ?')
        .bind(classId, fromUser.id)
        .first()
      
      if (classInfo) {
        // ì†Œìœ ê¶Œ ì´ì „
        await DB.prepare('UPDATE classes SET academy_id = ? WHERE id = ?')
          .bind(toUser.id, classId)
          .run()
        
        // í•´ë‹¹ ë°˜ì˜ í•™ìƒë“¤ë„ ì´ì „ (academy_id ì‚¬ìš©)
        await DB.prepare('UPDATE students SET academy_id = ? WHERE class_id = ?')
          .bind(toUser.id, classId)
          .run()
        
        transferred.push({
          classId,
          className: classInfo.class_name,
          studentCount: classInfo.student_count || 0
        })
      }
    }
    
    return c.json({
      success: true,
      message: `${transferred.length}ê°œ ë°˜ ì´ì „ ì™„ë£Œ`,
      transferred,
      from: { id: fromUser.id, email: fromUser.email, name: fromUser.name },
      to: { id: toUser.id, email: toUser.email, name: toUser.name }
    })
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ========================================
// Form Builder Pages
// ========================================

// í¼ í…œí”Œë¦¿ ê´€ë¦¬ í˜ì´ì§€ (í¼ ë¹Œë”)
app.get('/tools/form-builder', async (c) => {
  return c.html(`<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¼ í…œí”Œë¦¿ ê´€ë¦¬ - SUPERPLACE</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm mb-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-900">í¼ ë¹Œë”</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/tools/form-submissions" class="text-gray-600 hover:text-gray-900">ì‹ ì²­ ë‚´ì—­</a>
                    <a href="/dashboard" class="text-gray-600 hover:text-gray-900">ëŒ€ì‹œë³´ë“œ</a>
                </div>
            </div>
        </div>
    </nav>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">ë‚´ í¼ í…œí”Œë¦¿</h2>
                <p class="text-gray-600 mt-1">ëœë”©í˜ì´ì§€ì— ì‚¬ìš©í•  ì»¤ìŠ¤í…€ í¼ì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
            </div>
            <button onclick="openCreateModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">+ ìƒˆ í…œí”Œë¦¿ ë§Œë“¤ê¸°</button>
        </div>
        <div id="templatesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="col-span-full text-center py-12"><p class="text-gray-500">ë¡œë”© ì¤‘...</p></div>
        </div>
    </div>
    <div id="templateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b sticky top-0 bg-white z-10"><h3 class="text-xl font-bold">ìƒˆ í¼ í…œí”Œë¦¿ ë§Œë“¤ê¸°</h3></div>
                <form id="templateForm" class="p-6 space-y-6">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">í…œí”Œë¦¿ ì´ë¦„ *</label>
                        <input type="text" id="templateName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="ì˜ˆ: í•™ì› ì„¤ëª…íšŒ ì‹ ì²­ì„œ"></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">ì„¤ëª…</label>
                        <textarea id="templateDescription" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea></div>
                    <div><div class="flex justify-between items-center mb-3"><h4 class="text-lg font-semibold">í¼ í•„ë“œ</h4>
                            <button type="button" onclick="addField()" class="text-blue-600 text-sm">+ í•„ë“œ ì¶”ê°€</button></div>
                        <div id="fieldsList" class="space-y-3"></div></div>
                    <div class="flex justify-end space-x-3 pt-6 border-t">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-700">ì·¨ì†Œ</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg">ì €ì¥í•˜ê¸°</button></div>
                </form>
            </div>
        </div>
    </div>
    <script>
        let currentFields=[{type:'text',name:'name',label:'ì´ë¦„',required:true,placeholder:'ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'},{type:'tel',name:'phone',label:'ì „í™”ë²ˆí˜¸',required:true,placeholder:'010-1234-5678'}];
        document.addEventListener('DOMContentLoaded',function(){loadTemplates()});
        async function loadTemplates(){try{const response=await fetch('/api/form-templates',{credentials:'include'});if(!response.ok){if(response.status===401){window.location.href='/login';return}throw new Error('í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')}const templates=await response.json();displayTemplates(templates)}catch(error){console.error('Error:',error);alert('í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')}}
        function displayTemplates(templates){const container=document.getElementById('templatesList');if(templates.length===0){container.innerHTML='<div class="col-span-full text-center py-12"><p class="text-gray-500">í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';return}container.innerHTML=templates.map(t=>{const fields=JSON.parse(t.fields);return\`<div class="bg-white rounded-lg shadow-sm border p-6"><h3 class="text-lg font-semibold mb-2">\${t.name}</h3><p class="text-sm text-gray-600 mb-4">\${fields.length}ê°œ í•„ë“œ</p><div class="flex space-x-2"><button onclick="copyHTML(\${t.id})" class="flex-1 px-4 py-2 text-sm text-green-600 bg-green-50 rounded-lg">HTML ë³µì‚¬</button><button onclick="deleteTemplate(\${t.id})" class="px-4 py-2 text-sm text-red-600 bg-red-50 rounded-lg">ì‚­ì œ</button></div></div>\`}).join('')}
        function openCreateModal(){renderFields();document.getElementById('templateModal').classList.remove('hidden')}
        function closeModal(){document.getElementById('templateModal').classList.add('hidden');document.getElementById('templateForm').reset()}
        function addField(){currentFields.push({type:'text',name:'field_'+Date.now(),label:'ìƒˆ í•„ë“œ',required:false,placeholder:''});renderFields()}
        function renderFields(){const container=document.getElementById('fieldsList');container.innerHTML=currentFields.map((f,i)=>\`<div class="border p-3 rounded"><div class="grid grid-cols-2 gap-2 mb-2"><input type="text" value="\${f.label}" onchange="currentFields[\${i}].label=this.value" class="px-2 py-1 text-sm border rounded" placeholder="ë ˆì´ë¸”"><input type="text" value="\${f.name}" onchange="currentFields[\${i}].name=this.value" class="px-2 py-1 text-sm border rounded" placeholder="í•„ë“œëª…"></div><div class="flex items-center justify-between"><select onchange="currentFields[\${i}].type=this.value" class="px-2 py-1 text-sm border rounded"><option value="text" \${f.type==='text'?'selected':''}>í…ìŠ¤íŠ¸</option><option value="email" \${f.type==='email'?'selected':''}>ì´ë©”ì¼</option><option value="tel" \${f.type==='tel'?'selected':''}>ì „í™”ë²ˆí˜¸</option><option value="textarea" \${f.type==='textarea'?'selected':''}>ê¸´ í…ìŠ¤íŠ¸</option></select><label class="text-sm"><input type="checkbox" \${f.required?'checked':''} onchange="currentFields[\${i}].required=this.checked"> í•„ìˆ˜</label><button type="button" onclick="currentFields.splice(\${i},1);renderFields()" class="text-red-600 text-sm">ì‚­ì œ</button></div></div>\`).join('')}
        document.getElementById('templateForm').addEventListener('submit',async function(e){e.preventDefault();try{const response=await fetch('/api/form-templates',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({name:document.getElementById('templateName').value,description:document.getElementById('templateDescription').value,fields:JSON.stringify(currentFields),submit_button_text:'ì‹ ì²­í•˜ê¸°',success_message:'ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!'})});if(!response.ok)throw new Error('ì €ì¥ ì‹¤íŒ¨');alert('í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');closeModal();loadTemplates()}catch(error){alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')}});
        async function copyHTML(id){try{const response=await fetch(\`/api/form-templates/\${id}/html\`,{credentials:'include'});if(!response.ok)throw new Error('HTML ìƒì„± ì‹¤íŒ¨');const data=await response.json();await navigator.clipboard.writeText(data.html);alert('HTMLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!')}catch(error){alert('HTML ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')}}
        async function deleteTemplate(id){if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{const response=await fetch(\`/api/form-templates/\${id}\`,{method:'DELETE',credentials:'include'});if(!response.ok)throw new Error('ì‚­ì œ ì‹¤íŒ¨');alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');loadTemplates()}catch(error){alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')}}
    </script>
</body>
</html>`)
})

// í¼ ì œì¶œ ë‚´ì—­ í˜ì´ì§€
app.get('/tools/form-submissions', async (c) => {
  return c.html(`<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¼ ì‹ ì²­ ë‚´ì—­ - SUPERPLACE</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm mb-6">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-900">í¼ ì‹ ì²­ ë‚´ì—­</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/tools/form-builder" class="text-gray-600 hover:text-gray-900">í¼ ë¹Œë”</a>
                    <a href="/dashboard" class="text-gray-600 hover:text-gray-900">ëŒ€ì‹œë³´ë“œ</a>
                </div>
            </div>
        </div>
    </nav>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">ì‹ ì²­ ë‚´ì—­ ê´€ë¦¬</h2>
            <div id="statsSection" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-blue-50 p-4 rounded-lg"><div class="text-sm text-blue-600 font-medium">ì „ì²´ ì‹ ì²­</div><div id="totalCount" class="text-2xl font-bold text-blue-900 mt-1">0</div></div>
                <div class="bg-yellow-50 p-4 rounded-lg"><div class="text-sm text-yellow-600 font-medium">ìƒˆ ì‹ ì²­</div><div id="newCount" class="text-2xl font-bold text-yellow-900 mt-1">0</div></div>
                <div class="bg-green-50 p-4 rounded-lg"><div class="text-sm text-green-600 font-medium">ì—°ë½ ì™„ë£Œ</div><div id="contactedCount" class="text-2xl font-bold text-green-900 mt-1">0</div></div>
                <div class="bg-purple-50 p-4 rounded-lg"><div class="text-sm text-purple-600 font-medium">ì²˜ë¦¬ ì™„ë£Œ</div><div id="completedCount" class="text-2xl font-bold text-purple-900 mt-1">0</div></div>
            </div>
            <div class="flex space-x-3">
                <select id="statusFilter" onchange="loadSubmissions()" class="px-4 py-2 border rounded-lg">
                    <option value="">ì „ì²´ ìƒíƒœ</option><option value="new">ìƒˆ ì‹ ì²­</option><option value="contacted">ì—°ë½ ì™„ë£Œ</option><option value="completed">ì²˜ë¦¬ ì™„ë£Œ</option><option value="rejected">ê±°ì ˆ</option>
                </select>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì‹ ì²­ì¼ì‹œ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">í…œí”Œë¦¿</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì‹ ì²­ì</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìƒíƒœ</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="submissionsList" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                <div class="p-6 border-b"><h3 class="text-xl font-bold">ì‹ ì²­ ìƒì„¸ ì •ë³´</h3></div>
                <div id="detailContent" class="p-6"></div>
                <div class="p-6 border-t">
                    <div class="space-y-4">
                        <div><label class="block text-sm font-medium mb-2">ìƒíƒœ ë³€ê²½</label>
                            <select id="statusUpdate" class="w-full px-3 py-2 border rounded-lg">
                                <option value="new">ìƒˆ ì‹ ì²­</option><option value="contacted">ì—°ë½ ì™„ë£Œ</option><option value="completed">ì²˜ë¦¬ ì™„ë£Œ</option><option value="rejected">ê±°ì ˆ</option>
                            </select></div>
                        <div><label class="block text-sm font-medium mb-2">ë©”ëª¨</label>
                            <textarea id="notesUpdate" rows="3" class="w-full px-3 py-2 border rounded-lg"></textarea></div>
                        <div class="flex justify-between">
                            <button onclick="deleteSubmission()" class="px-4 py-2 text-red-600">ì‚­ì œ</button>
                            <div class="space-x-3">
                                <button onclick="closeDetailModal()" class="px-4 py-2">ì·¨ì†Œ</button>
                                <button onclick="updateSubmission()" class="px-6 py-2 bg-blue-600 text-white rounded-lg">ì €ì¥</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let currentSubmissionId=null;
        document.addEventListener('DOMContentLoaded',function(){loadStats();loadSubmissions()});
        async function loadStats(){try{const response=await fetch('/api/form-submissions/stats',{credentials:'include'});if(!response.ok)throw new Error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨');const stats=await response.json();document.getElementById('totalCount').textContent=stats.total||0;document.getElementById('newCount').textContent=stats.new_count||0;document.getElementById('contactedCount').textContent=stats.contacted_count||0;document.getElementById('completedCount').textContent=stats.completed_count||0}catch(error){console.error('Error loading stats:',error)}}
        async function loadSubmissions(){try{const status=document.getElementById('statusFilter').value;const url=status?'/api/form-submissions?status='+status:'/api/form-submissions';const response=await fetch(url,{credentials:'include'});if(!response.ok){if(response.status===401){window.location.href='/login';return}throw new Error('ì‹ ì²­ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨')}const submissions=await response.json();displaySubmissions(submissions)}catch(error){console.error('Error:',error);alert('ì‹ ì²­ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')}}
        function displaySubmissions(submissions){const container=document.getElementById('submissionsList');if(submissions.length===0){container.innerHTML='<tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';return}container.innerHTML=submissions.map(function(s){const data=JSON.parse(s.submission_data);const name=data.name||'ì´ë¦„ ì—†ìŒ';const phone=data.phone||data.email||'ì—°ë½ì²˜ ì—†ìŒ';let statusBadge='';if(s.status==='new')statusBadge='<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">ìƒˆ ì‹ ì²­</span>';else if(s.status==='contacted')statusBadge='<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">ì—°ë½ ì™„ë£Œ</span>';else if(s.status==='completed')statusBadge='<span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">ì²˜ë¦¬ ì™„ë£Œ</span>';else if(s.status==='rejected')statusBadge='<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">ê±°ì ˆ</span>';return'<tr class="hover:bg-gray-50"><td class="px-6 py-4 text-sm">'+new Date(s.submitted_at).toLocaleString('ko-KR')+'</td><td class="px-6 py-4 text-sm font-medium">'+s.template_name+'</td><td class="px-6 py-4 text-sm"><div class="font-medium">'+name+'</div><div class="text-gray-500">'+phone+'</div></td><td class="px-6 py-4">'+statusBadge+'</td><td class="px-6 py-4 text-right"><button onclick="viewSubmission('+s.id+')" class="text-blue-600 text-sm">ìƒì„¸ë³´ê¸°</button></td></tr>'}).join('')}
        async function viewSubmission(id){try{const response=await fetch('/api/form-submissions/'+id,{credentials:'include'});if(!response.ok)throw new Error('ì¡°íšŒ ì‹¤íŒ¨');const submission=await response.json();displaySubmissionDetail(submission);currentSubmissionId=id;document.getElementById('detailModal').classList.remove('hidden')}catch(error){alert('ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')}}
        function displaySubmissionDetail(s){const data=JSON.parse(s.submission_data);let html='<div class="space-y-3">';for(const key in data){html+='<div><div class="text-sm text-gray-500">'+key+'</div><div class="font-medium">'+data[key]+'</div></div>'}html+='</div>';document.getElementById('detailContent').innerHTML=html;document.getElementById('statusUpdate').value=s.status;document.getElementById('notesUpdate').value=s.notes||''}
        async function updateSubmission(){if(!currentSubmissionId)return;try{const response=await fetch('/api/form-submissions/'+currentSubmissionId,{method:'PATCH',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({status:document.getElementById('statusUpdate').value,notes:document.getElementById('notesUpdate').value})});if(!response.ok)throw new Error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');alert('ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤');closeDetailModal();loadStats();loadSubmissions()}catch(error){alert('ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')}}
        async function deleteSubmission(){if(!currentSubmissionId||!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;try{const response=await fetch('/api/form-submissions/'+currentSubmissionId,{method:'DELETE',credentials:'include'});if(!response.ok)throw new Error('ì‚­ì œ ì‹¤íŒ¨');alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');closeDetailModal();loadStats();loadSubmissions()}catch(error){alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤')}}
        function closeDetailModal(){document.getElementById('detailModal').classList.add('hidden');currentSubmissionId=null}
    </script>
</body>
</html>`)
})

// Test route to verify deployment
app.get('/test-deployment', async (c) => {
  return c.text('Deployment successful! Timestamp: ' + Date.now())
})

// ğŸ” ë””ë²„ê·¸: ì‚¬ìš©ì êµ¬ë… ì •ë³´ ìƒì„¸ ì¡°íšŒ
// ğŸ”¥ í•™ìƒ ëª©ë¡ í™•ì¸ API (ë””ë²„ê¹…ìš©)
app.get('/api/debug/students/:academyId', async (c) => {
  try {
    const academyId = c.req.param('academyId')
    
    // students í…Œì´ë¸”ì—ì„œ ì‹¤ì œ í•™ìƒ ëª©ë¡ ì¡°íšŒ
    const students = await c.env.DB.prepare(`
      SELECT id, name, parent_phone, academy_id, created_at 
      FROM students 
      WHERE academy_id = ?
      ORDER BY created_at DESC
      LIMIT 100
    `).bind(academyId).all()
    
    // ì´ í•™ìƒ ìˆ˜
    const count = await c.env.DB.prepare(`
      SELECT COUNT(*) as count FROM students WHERE academy_id = ?
    `).bind(academyId).first()
    
    return c.json({
      academyId: academyId,
      totalCount: count?.count || 0,
      students: students.results || [],
      message: `Academy ${academyId}ì˜ ì‹¤ì œ students í…Œì´ë¸” ë°ì´í„°`
    })
  } catch (error) {
    return c.json({ error: error.message, stack: error.stack }, 500)
  }
})

app.get('/api/debug/user/:userId/subscription', async (c) => {
  try {
    const userId = c.req.param('userId')
    
    // ì‚¬ìš©ì ì •ë³´
    const user = await c.env.DB.prepare(`
      SELECT id, email, name, academy_id, academy_name FROM users WHERE id = ?
    `).bind(userId).first()
    
    if (!user) {
      return c.json({ error: 'User not found' }, 404)
    }
    
    // ëª¨ë“  êµ¬ë… ì¡°íšŒ (academy_id ê¸°ì¤€)
    const subscriptionsByAcademy = await c.env.DB.prepare(`
      SELECT * FROM subscriptions WHERE academy_id = ? ORDER BY created_at DESC
    `).bind(user.academy_id || user.id).all()
    
    // í™œì„± êµ¬ë…ë§Œ
    const activeSubscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(user.academy_id || user.id).first()
    
    // ê´€ë¦¬ì ì„¤ì • í”Œëœ
    const adminSubscription = await c.env.DB.prepare(`
      SELECT * FROM subscriptions 
      WHERE academy_id = ? AND plan_name = 'ê´€ë¦¬ì ì„¤ì • í”Œëœ'
      ORDER BY created_at DESC LIMIT 1
    `).bind(user.academy_id || user.id).first()
    
    // usage_tracking ì •ë³´
    const usageTracking = await c.env.DB.prepare(`
      SELECT * FROM usage_tracking WHERE academy_id = ? ORDER BY updated_at DESC LIMIT 1
    `).bind(user.academy_id || user.id).first()
    
    // ğŸ”¥ ì‹¤ì œ í…Œì´ë¸” ë°ì´í„° ì¡°íšŒ
    let actualData = {}
    try {
      // students í…Œì´ë¸” í™•ì¸
      let studentsCount = 0
      try {
        const students = await c.env.DB.prepare(`
          SELECT COUNT(*) as count FROM students WHERE academy_id = ?
        `).bind(user.academy_id || user.id).first()
        studentsCount = students?.count || 0
      } catch (e) {
        studentsCount = 'table_not_found'
      }
      
      // landing_pages ëˆ„ì  ê°œìˆ˜ í™•ì¸ (usage_trackingì—ì„œ ì¡°íšŒ)
      let landingPagesCount = 0
      try {
        // usage_trackingì—ì„œ ëˆ„ì  ìƒì„± ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸° (ì‚­ì œí•´ë„ ëˆ„ì  ìœ ì§€)
        landingPagesCount = usageTracking?.landing_pages_created || 0
      } catch (e) {
        landingPagesCount = 'table_not_found'
      }
      
      // teacher_applications í…Œì´ë¸” í™•ì¸ (teachers ëŒ€ì‹ )
      let teachersCount = 0
      try {
        const teachers = await c.env.DB.prepare(`
          SELECT COUNT(*) as count FROM teacher_applications WHERE academy_id = ?
        `).bind(user.academy_id || user.id).first()
        teachersCount = teachers?.count || 0
      } catch (e) {
        teachersCount = 'table_not_found'
      }
      
      actualData = {
        students: studentsCount,
        landingPages: landingPagesCount,
        teachers: teachersCount
      }
    } catch (err) {
      actualData = { error: err.message }
    }
    
    return c.json({
      user: user,
      subscriptions: {
        all: subscriptionsByAcademy.results,
        active: activeSubscription,
        admin: adminSubscription
      },
      usageTracking: usageTracking,
      actualData: actualData,
      debug: {
        academyIdUsedForQuery: user.academy_id || user.id,
        totalSubscriptions: subscriptionsByAcademy.results.length
      }
    })
  } catch (error) {
    return c.json({ error: error.message }, 500)
  }
})

// ==================== ğŸ’° í¬ì¸íŠ¸ & ì†Œì…œ íŠ¸ë˜í”½ ìŠ¤í† ì–´ ì‹œìŠ¤í…œ ====================

// ğŸ“Š í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ API
app.get('/api/points/balance', async (c) => {
  try {
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const session = await c.env.DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')
    `).bind(sessionId).first()
    
    if (!session) {
      return c.json({ success: false, error: 'Session expired' }, 401)
    }

    const userId = session.user_id

    // ì‚¬ìš©ì í¬ì¸íŠ¸ ì¡°íšŒ (users í…Œì´ë¸”ì— points ì»¬ëŸ¼ ì¶”ê°€ í•„ìš”)
    const user = await c.env.DB.prepare(`
      SELECT id, email, name, points FROM users WHERE id = ?
    `).bind(userId).first()

    if (!user) {
      return c.json({ success: false, error: 'User not found' }, 404)
    }

    // í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ
    const history = await c.env.DB.prepare(`
      SELECT * FROM point_transactions 
      WHERE user_id = ? 
      ORDER BY created_at DESC 
      LIMIT 50
    `).bind(userId).all()

    return c.json({
      success: true,
      balance: user.points || 0,
      history: history.results || []
    })
  } catch (error) {
    console.error('[Points Balance] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ›’ ìŠ¤í† ì–´ ìƒí’ˆ ëª©ë¡ ì¡°íšŒ API
app.get('/api/store/products', async (c) => {
  try {
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const session = await c.env.DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')
    `).bind(sessionId).first()
    
    if (!session) {
      return c.json({ success: false, error: 'Session expired' }, 401)
    }

    const userId = session.user_id

    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸)
    const user = await c.env.DB.prepare(`
      SELECT id, email, role FROM users WHERE id = ?
    `).bind(userId).first()

    if (!user) {
      return c.json({ success: false, error: 'User not found' }, 404)
    }

    // ìŠ¤í† ì–´ ì ‘ê·¼ ê¶Œí•œ í™•ì¸
    const storeAccess = await c.env.DB.prepare(`
      SELECT * FROM store_access WHERE user_id = ?
    `).bind(userId).first()

    const isAdmin = user.email === 'admin@superplace.co.kr'
    const hasAccess = isAdmin || storeAccess?.enabled === 1

    if (!hasAccess) {
      return c.json({ 
        success: false, 
        error: 'ìŠ¤í† ì–´ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.',
        message: 'ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'
      }, 403)
    }

    // ìƒí’ˆ ëª©ë¡ ì¡°íšŒ
    const products = await c.env.DB.prepare(`
      SELECT * FROM store_products 
      WHERE enabled = 1 
      ORDER BY category, display_order, id
    `).all()

    return c.json({
      success: true,
      products: products.results || [],
      isAdmin
    })
  } catch (error) {
    console.error('[Store Products] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ›ï¸ ìƒí’ˆ êµ¬ë§¤ API
app.post('/api/store/purchase', async (c) => {
  try {
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const session = await c.env.DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')
    `).bind(sessionId).first()
    
    if (!session) {
      return c.json({ success: false, error: 'Session expired' }, 401)
    }

    const userId = session.user_id
    const { productId, quantity, targetUrl } = await c.req.json()

    if (!productId || !quantity || quantity <= 0) {
      return c.json({ success: false, error: 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.' }, 400)
    }

    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT id, email, points FROM users WHERE id = ?
    `).bind(userId).first()

    if (!user) {
      return c.json({ success: false, error: 'User not found' }, 404)
    }

    // ìƒí’ˆ ì •ë³´ ì¡°íšŒ
    const product = await c.env.DB.prepare(`
      SELECT * FROM store_products WHERE id = ? AND enabled = 1
    `).bind(productId).first()

    if (!product) {
      return c.json({ success: false, error: 'ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, 404)
    }

    const totalCost = product.price * quantity
    const currentPoints = user.points || 0

    // í¬ì¸íŠ¸ ë¶€ì¡± í™•ì¸
    if (currentPoints < totalCost) {
      return c.json({ 
        success: false, 
        error: 'í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.',
        required: totalCost,
        current: currentPoints,
        shortage: totalCost - currentPoints
      }, 400)
    }

    // íŠ¸ëœì­ì…˜ ì‹œì‘
    const newPoints = currentPoints - totalCost

    // í¬ì¸íŠ¸ ì°¨ê°
    await c.env.DB.prepare(`
      UPDATE users SET points = ? WHERE id = ?
    `).bind(newPoints, userId).run()

    // í¬ì¸íŠ¸ ê±°ë˜ ë‚´ì—­ ì¶”ê°€
    await c.env.DB.prepare(`
      INSERT INTO point_transactions (
        user_id, type, amount, balance_after, description, created_at
      ) VALUES (?, 'purchase', ?, ?, ?, datetime('now'))
    `).bind(userId, -totalCost, newPoints, `${product.name} x${quantity} êµ¬ë§¤`).run()

    // ì£¼ë¬¸ ìƒì„±
    const orderResult = await c.env.DB.prepare(`
      INSERT INTO store_orders (
        user_id, product_id, product_name, quantity, 
        price_per_unit, total_price, target_url, 
        status, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, 'pending', datetime('now'))
    `).bind(
      userId, 
      productId, 
      product.name, 
      quantity, 
      product.price, 
      totalCost, 
      targetUrl || null
    ).run()

    const orderId = orderResult.meta.last_row_id

    return c.json({
      success: true,
      message: 'êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
      order: {
        id: orderId,
        product: product.name,
        quantity,
        totalCost,
        remainingPoints: newPoints
      }
    })
  } catch (error) {
    console.error('[Store Purchase] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ“¦ ë‚´ ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ API
app.get('/api/store/orders', async (c) => {
  try {
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const session = await c.env.DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')
    `).bind(sessionId).first()
    
    if (!session) {
      return c.json({ success: false, error: 'Session expired' }, 401)
    }

    const userId = session.user_id

    const orders = await c.env.DB.prepare(`
      SELECT * FROM store_orders 
      WHERE user_id = ? 
      ORDER BY created_at DESC 
      LIMIT 100
    `).bind(userId).all()

    return c.json({
      success: true,
      orders: orders.results || []
    })
  } catch (error) {
    console.error('[Store Orders] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì: ìŠ¤í† ì–´ ì ‘ê·¼ ê¶Œí•œ ê´€ë¦¬ API
app.post('/api/admin/store-access', async (c) => {
  try {
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const session = await c.env.DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')
    `).bind(sessionId).first()
    
    if (!session) {
      return c.json({ success: false, error: 'Session expired' }, 401)
    }

    const adminUserId = session.user_id

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await c.env.DB.prepare(`
      SELECT email FROM users WHERE id = ?
    `).bind(adminUserId).first()

    if (!admin || admin.email !== 'admin@superplace.co.kr') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
    }

    const { targetUserId, enabled } = await c.req.json()

    if (!targetUserId) {
      return c.json({ success: false, error: 'ì‚¬ìš©ì IDê°€ í•„ìš”í•©ë‹ˆë‹¤.' }, 400)
    }

    // ê¸°ì¡´ ê¶Œí•œ í™•ì¸
    const existing = await c.env.DB.prepare(`
      SELECT * FROM store_access WHERE user_id = ?
    `).bind(targetUserId).first()

    if (existing) {
      // ì—…ë°ì´íŠ¸
      await c.env.DB.prepare(`
        UPDATE store_access 
        SET enabled = ?, updated_at = datetime('now'), updated_by = ?
        WHERE user_id = ?
      `).bind(enabled ? 1 : 0, adminUserId, targetUserId).run()
    } else {
      // ìƒì„±
      await c.env.DB.prepare(`
        INSERT INTO store_access (user_id, enabled, created_at, updated_by)
        VALUES (?, ?, datetime('now'), ?)
      `).bind(targetUserId, enabled ? 1 : 0, adminUserId).run()
    }

    return c.json({
      success: true,
      message: enabled ? 'ìŠ¤í† ì–´ ì ‘ê·¼ ê¶Œí•œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìŠ¤í† ì–´ ì ‘ê·¼ ê¶Œí•œì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (error) {
    console.error('[Admin Store Access] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì: í¬ì¸íŠ¸ ì§€ê¸‰/íšŒìˆ˜ API
app.post('/api/admin/points', async (c) => {
  try {
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    const session = await c.env.DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')
    `).bind(sessionId).first()
    
    if (!session) {
      return c.json({ success: false, error: 'Session expired' }, 401)
    }

    const adminUserId = session.user_id

    // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
    const admin = await c.env.DB.prepare(`
      SELECT email FROM users WHERE id = ?
    `).bind(adminUserId).first()

    if (!admin || admin.email !== 'admin@superplace.co.kr') {
      return c.json({ success: false, error: 'ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.' }, 403)
    }

    const { targetUserId, amount, description } = await c.req.json()

    if (!targetUserId || !amount || amount === 0) {
      return c.json({ success: false, error: 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.' }, 400)
    }

    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT id, points FROM users WHERE id = ?
    `).bind(targetUserId).first()

    if (!user) {
      return c.json({ success: false, error: 'User not found' }, 404)
    }

    const currentPoints = user.points || 0
    const newPoints = currentPoints + amount

    if (newPoints < 0) {
      return c.json({ 
        success: false, 
        error: 'í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.',
        current: currentPoints,
        requested: amount
      }, 400)
    }

    // í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
    await c.env.DB.prepare(`
      UPDATE users SET points = ? WHERE id = ?
    `).bind(newPoints, targetUserId).run()

    // í¬ì¸íŠ¸ ê±°ë˜ ë‚´ì—­ ì¶”ê°€
    await c.env.DB.prepare(`
      INSERT INTO point_transactions (
        user_id, type, amount, balance_after, description, admin_id, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(
      targetUserId, 
      amount > 0 ? 'admin_grant' : 'admin_deduct', 
      amount, 
      newPoints, 
      description || (amount > 0 ? 'ê´€ë¦¬ì ì§€ê¸‰' : 'ê´€ë¦¬ì íšŒìˆ˜'),
      adminUserId
    ).run()

    return c.json({
      success: true,
      message: amount > 0 ? 'í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'í¬ì¸íŠ¸ê°€ íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.',
      newBalance: newPoints
    })
  } catch (error) {
    console.error('[Admin Points] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ”§ ë””ë²„ê¹…: ì„ ìƒë‹˜ ë°ì´í„° í™•ì¸ API
app.get('/api/debug/teachers', async (c) => {
  try {
    const sessionId = getCookie(c, 'session_id')
    if (!sessionId) {
      return c.json({ success: false, error: 'Not authenticated' }, 401)
    }

    // ì„¸ì…˜ì—ì„œ user_id ì¡°íšŒ
    const session = await c.env.DB.prepare(`
      SELECT user_id FROM sessions WHERE session_id = ? AND expires_at > datetime('now')
    `).bind(sessionId).first()
    
    if (!session) {
      return c.json({ success: false, error: 'Session expired' }, 401)
    }

    const userId = session.user_id
    
    // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    const user = await c.env.DB.prepare(`
      SELECT id, name, email, user_type, academy_id, parent_user_id FROM users WHERE id = ?
    `).bind(userId).first()
    
    if (!user) {
      return c.json({ success: false, error: 'User not found' }, 404)
    }

    // academyId ê²°ì •
    let academyId
    if (user.user_type === 'teacher') {
      academyId = user.academy_id || user.parent_user_id
    } else {
      academyId = user.id
    }

    // ëª¨ë“  ì„ ìƒë‹˜ ì¡°íšŒ (academy_id ê¸°ì¤€)
    const teachersByAcademyId = await c.env.DB.prepare(`
      SELECT id, name, email, user_type, academy_id, parent_user_id, created_at 
      FROM users 
      WHERE academy_id = ? AND user_type = 'teacher'
      ORDER BY created_at DESC
    `).bind(academyId).all()

    // ëª¨ë“  ì„ ìƒë‹˜ ì¡°íšŒ (parent_user_id ê¸°ì¤€)
    const teachersByParentId = await c.env.DB.prepare(`
      SELECT id, name, email, user_type, academy_id, parent_user_id, created_at 
      FROM users 
      WHERE parent_user_id = ? AND user_type = 'teacher'
      ORDER BY created_at DESC
    `).bind(academyId).all()

    // user_type='teacher'ì¸ ëª¨ë“  ì‚¬ìš©ì
    const allTeachers = await c.env.DB.prepare(`
      SELECT id, name, email, user_type, academy_id, parent_user_id, created_at 
      FROM users 
      WHERE user_type = 'teacher'
      ORDER BY created_at DESC
      LIMIT 50
    `).all()

    // êµ¬ë… ì •ë³´
    const subscription = await c.env.DB.prepare(`
      SELECT id, academy_id, plan_name, teacher_limit, status 
      FROM subscriptions 
      WHERE academy_id = ? AND status = 'active'
      ORDER BY created_at DESC LIMIT 1
    `).bind(academyId).first()

    return c.json({
      success: true,
      debug: {
        currentUser: {
          id: user.id,
          name: user.name,
          email: user.email,
          user_type: user.user_type,
          academy_id: user.academy_id,
          parent_user_id: user.parent_user_id
        },
        academyIdUsed: academyId,
        subscription: subscription || null,
        counts: {
          byAcademyId: teachersByAcademyId.results?.length || 0,
          byParentId: teachersByParentId.results?.length || 0,
          allTeachers: allTeachers.results?.length || 0
        },
        teachersByAcademyId: teachersByAcademyId.results || [],
        teachersByParentId: teachersByParentId.results || [],
        allTeachers: allTeachers.results || []
      }
    })
  } catch (error) {
    console.error('[Debug Teachers] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ğŸ”§ DB ì´ˆê¸°í™”: ìŠ¤í† ì–´ ì‹œìŠ¤í…œ í…Œì´ë¸” ìƒì„±
app.get('/api/store/init-db', async (c) => {
  try {
    const results = []

    // 1. users í…Œì´ë¸”ì— points ì»¬ëŸ¼ ì¶”ê°€
    try {
      await c.env.DB.prepare(`ALTER TABLE users ADD COLUMN points INTEGER DEFAULT 0`).run()
      results.push('âœ… Added points column to users')
    } catch (e) {
      results.push('â„¹ï¸ points column: ' + e.message.substring(0, 50))
    }

    // 2. point_transactions í…Œì´ë¸” ìƒì„±
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS point_transactions (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          type TEXT NOT NULL,
          amount INTEGER NOT NULL,
          balance_after INTEGER NOT NULL,
          description TEXT,
          admin_id INTEGER,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          FOREIGN KEY (user_id) REFERENCES users(id)
        )
      `).run()
      results.push('âœ… Created point_transactions table')
    } catch (e) {
      results.push('âŒ point_transactions: ' + e.message)
    }

    // 3. store_products í…Œì´ë¸” ìƒì„±
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS store_products (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          name TEXT NOT NULL,
          description TEXT,
          category TEXT NOT NULL,
          price INTEGER NOT NULL,
          enabled INTEGER DEFAULT 1,
          display_order INTEGER DEFAULT 0,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
      `).run()
      results.push('âœ… Created store_products table')
    } catch (e) {
      results.push('âŒ store_products: ' + e.message)
    }

    // 4. store_orders í…Œì´ë¸” ìƒì„±
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS store_orders (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL,
          product_id INTEGER NOT NULL,
          product_name TEXT NOT NULL,
          quantity INTEGER NOT NULL,
          price_per_unit INTEGER NOT NULL,
          total_price INTEGER NOT NULL,
          target_url TEXT,
          status TEXT DEFAULT 'pending',
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          completed_at DATETIME,
          FOREIGN KEY (user_id) REFERENCES users(id),
          FOREIGN KEY (product_id) REFERENCES store_products(id)
        )
      `).run()
      results.push('âœ… Created store_orders table')
    } catch (e) {
      results.push('âŒ store_orders: ' + e.message)
    }

    // 5. store_access í…Œì´ë¸” ìƒì„±
    try {
      await c.env.DB.prepare(`
        CREATE TABLE IF NOT EXISTS store_access (
          id INTEGER PRIMARY KEY AUTOINCREMENT,
          user_id INTEGER NOT NULL UNIQUE,
          enabled INTEGER DEFAULT 0,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          updated_by INTEGER,
          FOREIGN KEY (user_id) REFERENCES users(id),
          FOREIGN KEY (updated_by) REFERENCES users(id)
        )
      `).run()
      results.push('âœ… Created store_access table')
    } catch (e) {
      results.push('âŒ store_access: ' + e.message)
    }

    // 6. ì´ˆê¸° ìƒí’ˆ ë°ì´í„° ì‚½ì…
    const initialProducts = [
      // ì¸ìŠ¤íƒ€ê·¸ë¨
      { name: 'ì¸ìŠ¤íƒ€ê·¸ë¨ íŒ”ë¡œì›Œ', description: 'ì‹¤ì œ í™œì„± íŒ”ë¡œì›Œ ì¦ê°€', category: 'instagram', price: 10, order: 1 },
      { name: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ì¢‹ì•„ìš”', description: 'ê²Œì‹œë¬¼ ì¢‹ì•„ìš” ì¦ê°€', category: 'instagram', price: 5, order: 2 },
      { name: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ì¡°íšŒìˆ˜', description: 'ë¦´ìŠ¤/ê²Œì‹œë¬¼ ì¡°íšŒìˆ˜', category: 'instagram', price: 3, order: 3 },
      { name: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ì €ì¥ ìˆ˜', description: 'ê²Œì‹œë¬¼ ì €ì¥ ìˆ˜ ì¦ê°€', category: 'instagram', price: 8, order: 4 },
      { name: 'ì¸ìŠ¤íƒ€ê·¸ë¨ ê³µìœ  ìˆ˜', description: 'ê²Œì‹œë¬¼ ê³µìœ  ìˆ˜ ì¦ê°€', category: 'instagram', price: 7, order: 5 },
      
      // ìœ íŠœë¸Œ
      { name: 'ìœ íŠœë¸Œ êµ¬ë…ì', description: 'ì±„ë„ êµ¬ë…ì ì¦ê°€', category: 'youtube', price: 15, order: 6 },
      { name: 'ìœ íŠœë¸Œ ì¡°íšŒìˆ˜', description: 'ì˜ìƒ ì¡°íšŒìˆ˜ ì¦ê°€', category: 'youtube', price: 5, order: 7 },
      { name: 'ìœ íŠœë¸Œ ì¢‹ì•„ìš”', description: 'ì˜ìƒ ì¢‹ì•„ìš” ì¦ê°€', category: 'youtube', price: 6, order: 8 },
      { name: 'ìœ íŠœë¸Œ ëŒ“ê¸€', description: 'ê¸ì •ì  ëŒ“ê¸€ ì‘ì„±', category: 'youtube', price: 20, order: 9 },
      
      // í˜ì´ìŠ¤ë¶
      { name: 'í˜ì´ìŠ¤ë¶ íŒ”ë¡œì›Œ', description: 'í˜ì´ì§€ íŒ”ë¡œì›Œ ì¦ê°€', category: 'facebook', price: 10, order: 10 },
      { name: 'í˜ì´ìŠ¤ë¶ ì¢‹ì•„ìš”', description: 'ê²Œì‹œë¬¼ ì¢‹ì•„ìš” ì¦ê°€', category: 'facebook', price: 5, order: 11 },
      { name: 'í˜ì´ìŠ¤ë¶ ê³µìœ ', description: 'ê²Œì‹œë¬¼ ê³µìœ  ìˆ˜ ì¦ê°€', category: 'facebook', price: 12, order: 12 },
      
      // ì“°ë ˆë“œ
      { name: 'ì“°ë ˆë“œ íŒ”ë¡œì›Œ', description: 'ì“°ë ˆë“œ íŒ”ë¡œì›Œ ì¦ê°€', category: 'threads', price: 12, order: 13 },
      { name: 'ì“°ë ˆë“œ ì¢‹ì•„ìš”', description: 'ê²Œì‹œë¬¼ ì¢‹ì•„ìš” ì¦ê°€', category: 'threads', price: 6, order: 14 },
      
      // ë„¤ì´ë²„
      { name: 'ë„¤ì´ë²„ ë¸”ë¡œê·¸ ë°©ë¬¸ì', description: 'ë¸”ë¡œê·¸ ë°©ë¬¸ì ìˆ˜ ì¦ê°€', category: 'naver', price: 8, order: 15 },
      { name: 'ë„¤ì´ë²„ ë¸”ë¡œê·¸ ê³µê°', description: 'ë¸”ë¡œê·¸ ê³µê° ìˆ˜ ì¦ê°€', category: 'naver', price: 5, order: 16 },
      { name: 'ë„¤ì´ë²„ í”Œë ˆì´ìŠ¤ ë¦¬ë·°', description: 'ê¸ì •ì  ë¦¬ë·° ì‘ì„±', category: 'naver', price: 50, order: 17 },
    ]

    let insertedCount = 0
    for (const product of initialProducts) {
      try {
        const existing = await c.env.DB.prepare(`
          SELECT id FROM store_products WHERE name = ?
        `).bind(product.name).first()

        if (!existing) {
          await c.env.DB.prepare(`
            INSERT INTO store_products (name, description, category, price, display_order, enabled)
            VALUES (?, ?, ?, ?, ?, 1)
          `).bind(product.name, product.description, product.category, product.price, product.order).run()
          insertedCount++
        }
      } catch (e) {
        console.error('Failed to insert product:', product.name, e)
      }
    }
    results.push('âœ… Inserted ' + insertedCount + ' initial products')

    return c.json({
      success: true,
      message: 'ìŠ¤í† ì–´ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ',
      results
    })
  } catch (error) {
    console.error('[Store Init] Error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

export default app
// Force rebuild: Sun Jan 18 18:13:00 UTC 2026
// Cache buster: 1768863600
// Force deploy: Mon Jan 20 00:00:00 UTC 2026
// UI update: Single column layout for usage cards
// Force deploy Mon Jan 19 02:13:47 UTC 2026
// Cache bust: 1768961503
// Version: 2.0.4 - 1768962016
// ëœë”©í˜ì´ì§€ ì œì‘ ìƒì„¸ í˜ì´ì§€
app.get('/services/landing-page', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ëœë”©í˜ì´ì§€ ì œì‘ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white/90 backdrop-blur-md shadow-sm">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</a>
                    <div class="hidden md:flex items-center space-x-8">
                        <a href="/" class="text-gray-700 hover:text-purple-600">í™ˆ</a>
                        <a href="/pricing" class="text-gray-700 hover:text-purple-600">ìš”ê¸ˆì œ</a>
                        <a href="/contact" class="text-gray-700 hover:text-purple-600">ë¬¸ì˜í•˜ê¸°</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="pt-32 pb-16 px-6 bg-gradient-to-br from-purple-50 to-white">
            <div class="max-w-4xl mx-auto text-center">
                <div class="inline-block mb-6 px-5 py-2 bg-purple-100 rounded-full text-purple-700 text-sm font-semibold">
                    ğŸ¨ ì „ë¬¸ ëœë”©í˜ì´ì§€ ì œì‘
                </div>
                <h1 class="text-5xl font-bold text-gray-900 mb-6">
                    ì „í™˜ìœ¨ì„ ë†’ì´ëŠ”<br>
                    <span class="text-purple-600">ë§ì¶¤í˜• ëœë”©í˜ì´ì§€</span>
                </h1>
                <p class="text-xl text-gray-600 mb-8">
                    í•™ì› íŠ¹ì„±ì— ìµœì í™”ëœ ëœë”©í˜ì´ì§€ë¡œ<br>
                    ìƒë‹´ ì‹ ì²­ë¥ ì„ ê·¹ëŒ€í™”í•˜ì„¸ìš”
                </p>
                <a href="#inquiry" class="inline-block px-8 py-4 bg-purple-600 text-white rounded-full font-bold hover:bg-purple-700 transition-all shadow-lg hover:shadow-xl">
                    ì§€ê¸ˆ ë¬¸ì˜í•˜ê¸° <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
        </section>

        <!-- Features -->
        <section class="py-16 px-6">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-3xl font-bold text-center mb-12">ëœë”©í˜ì´ì§€ ì œì‘ ì„œë¹„ìŠ¤</h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-desktop text-3xl text-purple-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-4">ë°˜ì‘í˜• ë””ìì¸</h3>
                        <p class="text-gray-600">PC, ëª¨ë°”ì¼, íƒœë¸”ë¦¿ ëª¨ë“  ê¸°ê¸°ì—ì„œ ì™„ë²½í•˜ê²Œ ìµœì í™”ëœ ë””ìì¸ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
                    </div>
                    <div class="bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-bolt text-3xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-4">ë¹ ë¥¸ ë¡œë”© ì†ë„</h3>
                        <p class="text-gray-600">ìµœì í™”ëœ ì½”ë“œë¡œ í˜ì´ì§€ ë¡œë”© ì‹œê°„ì„ ìµœì†Œí™”í•˜ì—¬ ì´íƒˆë¥ ì„ ì¤„ì…ë‹ˆë‹¤.</p>
                    </div>
                    <div class="bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-chart-line text-3xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-4">ì „í™˜ìœ¨ ìµœì í™”</h3>
                        <p class="text-gray-600">ë°ì´í„° ê¸°ë°˜ UX/UIë¡œ ìƒë‹´ ì‹ ì²­ ì „í™˜ìœ¨ì„ ê·¹ëŒ€í™”í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Process -->
        <section class="py-16 px-6 bg-gray-100">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-3xl font-bold text-center mb-12">ì œì‘ í”„ë¡œì„¸ìŠ¤</h2>
                <div class="grid md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-600 text-white rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold">1</div>
                        <h3 class="font-bold mb-2">ìƒë‹´</h3>
                        <p class="text-sm text-gray-600">í•™ì› íŠ¹ì„± íŒŒì•…</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-600 text-white rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold">2</div>
                        <h3 class="font-bold mb-2">ê¸°íš</h3>
                        <p class="text-sm text-gray-600">ë§ì¶¤í˜• êµ¬ì„±ì•ˆ ì œì‘</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-600 text-white rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold">3</div>
                        <h3 class="font-bold mb-2">ë””ìì¸ & ê°œë°œ</h3>
                        <p class="text-sm text-gray-600">ì „ë¬¸ ë””ìì´ë„ˆ ì œì‘</p>
                    </div>
                    <div class="text-center">
                        <div class="w-16 h-16 bg-purple-600 text-white rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold">4</div>
                        <h3 class="font-bold mb-2">ë°°í¬ & ìš´ì˜</h3>
                        <p class="text-sm text-gray-600">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Inquiry Form -->
        <section id="inquiry" class="py-16 px-6">
            <div class="max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold text-center mb-4">ë¬¸ì˜í•˜ê¸°</h2>
                <p class="text-center text-gray-600 mb-8">ëœë”©í˜ì´ì§€ ì œì‘ ìƒë‹´ì„ ì›í•˜ì‹œë©´ ì•„ë˜ ì–‘ì‹ì„ ì‘ì„±í•´ì£¼ì„¸ìš”</p>
                
                <form id="inquiryForm" class="bg-white rounded-2xl p-8 shadow-lg">
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">í•™ì›ëª… *</label>
                        <input type="text" name="academy_name" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ë‹´ë‹¹ìëª… *</label>
                        <input type="text" name="name" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ì—°ë½ì²˜ *</label>
                        <input type="tel" name="phone" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ì´ë©”ì¼ *</label>
                        <input type="email" name="email" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ë¬¸ì˜ ë‚´ìš© *</label>
                        <textarea name="message" rows="5" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                    </div>
                    <input type="hidden" name="service_type" value="landing_page">
                    <button type="submit"
                        class="w-full py-4 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 transition-all shadow-lg hover:shadow-xl">
                        ë¬¸ì˜ ì œì¶œí•˜ê¸°
                    </button>
                </form>
            </div>
        </section>

        <script>
            document.getElementById('inquiryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                try {
                    const response = await fetch('/api/service-inquiry', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… ë¬¸ì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
                        e.target.reset();
                    } else {
                        alert('âŒ ì˜¤ë¥˜: ' + result.error);
                    }
                } catch (err) {
                    alert('âŒ ë¬¸ì˜ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        </script>
    </body>
    </html>
  `)
})

// í•™ì›ë§ˆì¼€íŒ… ëŒ€í–‰ ìƒì„¸ í˜ì´ì§€  
app.get('/services/marketing', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>í•™ì›ë§ˆì¼€íŒ… ëŒ€í–‰ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- Navigation -->
        <nav class="fixed w-full top-0 z-50 bg-white/90 backdrop-blur-md shadow-sm">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <a href="/" class="text-xl font-bold text-gray-900">ìš°ë¦¬ëŠ” ìŠˆí¼í”Œë ˆì´ìŠ¤ë‹¤</a>
                    <div class="hidden md:flex items-center space-x-8">
                        <a href="/" class="text-gray-700 hover:text-purple-600">í™ˆ</a>
                        <a href="/pricing" class="text-gray-700 hover:text-purple-600">ìš”ê¸ˆì œ</a>
                        <a href="/contact" class="text-gray-700 hover:text-purple-600">ë¬¸ì˜í•˜ê¸°</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="pt-32 pb-16 px-6 bg-gradient-to-br from-orange-50 to-white">
            <div class="max-w-4xl mx-auto text-center">
                <div class="inline-block mb-6 px-5 py-2 bg-orange-100 rounded-full text-orange-700 text-sm font-semibold">
                    ğŸ“ˆ ì „ë¬¸ ë§ˆì¼€íŒ… ëŒ€í–‰
                </div>
                <h1 class="text-5xl font-bold text-gray-900 mb-6">
                    í•™ìƒ ëª¨ì§‘ë¶€í„° ìœ ì§€ê¹Œì§€<br>
                    <span class="text-orange-600">ì˜¬ì¸ì› ë§ˆì¼€íŒ… ì†”ë£¨ì…˜</span>
                </h1>
                <p class="text-xl text-gray-600 mb-8">
                    ì „ë¬¸ ë§ˆì¼€í„°ê°€ í•™ì› ì„±ì¥ì„ ìœ„í•œ<br>
                    ëª¨ë“  ë§ˆì¼€íŒ… ì—…ë¬´ë¥¼ ëŒ€í–‰í•©ë‹ˆë‹¤
                </p>
                <a href="#inquiry" class="inline-block px-8 py-4 bg-orange-600 text-white rounded-full font-bold hover:bg-orange-700 transition-all shadow-lg hover:shadow-xl">
                    ì§€ê¸ˆ ìƒë‹´í•˜ê¸° <i class="fas fa-arrow-right ml-2"></i>
                </a>
            </div>
        </section>

        <!-- Services -->
        <section class="py-16 px-6">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-3xl font-bold text-center mb-12">ì œê³µ ì„œë¹„ìŠ¤</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-bullhorn text-3xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-4">ì˜¨ë¼ì¸ ê´‘ê³ </h3>
                        <p class="text-gray-600">ë„¤ì´ë²„, êµ¬ê¸€, SNS ë“± ê°ì¢… í”Œë«í¼ ê´‘ê³  ìš´ì˜ ë° ìµœì í™”</p>
                    </div>
                    <div class="bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-search text-3xl text-green-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-4">SEO ìµœì í™”</h3>
                        <p class="text-gray-600">ê²€ìƒ‰ ì—”ì§„ ìµœì í™”ë¡œ ìì—° ìœ ì… ê·¹ëŒ€í™”</p>
                    </div>
                    <div class="bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-share-alt text-3xl text-purple-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-4">SNS ë§ˆì¼€íŒ…</h3>
                        <p class="text-gray-600">ì¸ìŠ¤íƒ€ê·¸ë¨, í˜ì´ìŠ¤ë¶ ë“± ì†Œì…œ ë¯¸ë””ì–´ ìš´ì˜ ëŒ€í–‰</p>
                    </div>
                    <div class="bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition">
                        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-file-alt text-3xl text-yellow-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-4">ì½˜í…ì¸  ì œì‘</h3>
                        <p class="text-gray-600">ë¸”ë¡œê·¸, ì¹´ë“œë‰´ìŠ¤, ì˜ìƒ ë“± ë‹¤ì–‘í•œ ì½˜í…ì¸  ì œì‘</p>
                    </div>
                    <div class="bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-chart-bar text-3xl text-red-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-4">ë°ì´í„° ë¶„ì„</h3>
                        <p class="text-gray-600">ë§ˆì¼€íŒ… ì„±ê³¼ ë¶„ì„ ë° ê°œì„  ì „ëµ ìˆ˜ë¦½</p>
                    </div>
                    <div class="bg-white rounded-2xl p-8 shadow-md hover:shadow-xl transition">
                        <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-headset text-3xl text-indigo-600"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-4">ìƒë‹´ ê´€ë¦¬</h3>
                        <p class="text-gray-600">ë¬¸ì˜ ê´€ë¦¬ ë° ìƒë‹´ ì „í™˜ìœ¨ ìµœì í™”</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Why Us -->
        <section class="py-16 px-6 bg-gray-100">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-3xl font-bold text-center mb-12">ìŠˆí¼í”Œë ˆì´ìŠ¤ë¥¼ ì„ íƒí•´ì•¼ í•˜ëŠ” ì´ìœ </h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="text-center">
                        <div class="text-4xl font-bold text-orange-600 mb-4">10+</div>
                        <h3 class="font-bold mb-2">ë…„ê°„ ê²½í—˜</h3>
                        <p class="text-gray-600">í•™ì› ë§ˆì¼€íŒ… ì „ë¬¸ ê²½ë ¥</p>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl font-bold text-orange-600 mb-4">300%</div>
                        <h3 class="font-bold mb-2">í‰ê·  ì„±ì¥ë¥ </h3>
                        <p class="text-gray-600">í•™ìƒ ìˆ˜ ì¦ê°€</p>
                    </div>
                    <div class="text-center">
                        <div class="text-4xl font-bold text-orange-600 mb-4">100+</div>
                        <h3 class="font-bold mb-2">í•™ì› íŒŒíŠ¸ë„ˆ</h3>
                        <p class="text-gray-600">ì„±ê³µ ì‚¬ë¡€</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Inquiry Form -->
        <section id="inquiry" class="py-16 px-6">
            <div class="max-w-2xl mx-auto">
                <h2 class="text-3xl font-bold text-center mb-4">ë§ˆì¼€íŒ… ìƒë‹´ ì‹ ì²­</h2>
                <p class="text-center text-gray-600 mb-8">í•™ì› ë§ˆì¼€íŒ… ëŒ€í–‰ ìƒë‹´ì„ ì›í•˜ì‹œë©´ ì•„ë˜ ì–‘ì‹ì„ ì‘ì„±í•´ì£¼ì„¸ìš”</p>
                
                <form id="inquiryForm" class="bg-white rounded-2xl p-8 shadow-lg">
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">í•™ì›ëª… *</label>
                        <input type="text" name="academy_name" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ë‹´ë‹¹ìëª… *</label>
                        <input type="text" name="name" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ì—°ë½ì²˜ *</label>
                        <input type="tel" name="phone" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ì´ë©”ì¼ *</label>
                        <input type="email" name="email" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">í˜„ì¬ í•™ìƒ ìˆ˜</label>
                        <input type="number" name="student_count"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">ë¬¸ì˜ ë‚´ìš© *</label>
                        <textarea name="message" rows="5" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"></textarea>
                    </div>
                    <input type="hidden" name="service_type" value="marketing">
                    <button type="submit"
                        class="w-full py-4 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 transition-all shadow-lg hover:shadow-xl">
                        ë¬¸ì˜ ì œì¶œí•˜ê¸°
                    </button>
                </form>
            </div>
        </section>

        <script>
            document.getElementById('inquiryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                try {
                    const response = await fetch('/api/service-inquiry', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('âœ… ë¬¸ì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! ë¹ ë¥¸ ì‹œì¼ ë‚´ì— ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.');
                        e.target.reset();
                    } else {
                        alert('âŒ ì˜¤ë¥˜: ' + result.error);
                    }
                } catch (err) {
                    alert('âŒ ë¬¸ì˜ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        </script>
    </body>
    </html>
  `)
})

// ì„œë¹„ìŠ¤ ë¬¸ì˜ API
app.post('/api/service-inquiry', async (c) => {
  try {
    const { academy_name, name, phone, email, message, service_type, student_count } = await c.req.json()
    
    if (!academy_name || !name || !phone || !email || !message || !service_type) {
      return c.json({ success: false, error: 'í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.' }, 400)
    }
    
    // contacts í…Œì´ë¸”ì— ì €ì¥
    const serviceNames = {
      landing_page: 'ëœë”©í˜ì´ì§€ ì œì‘',
      marketing: 'í•™ì›ë§ˆì¼€íŒ… ëŒ€í–‰'
    }
    
    const fullMessage = `[${serviceNames[service_type]}]\n\ní•™ì›ëª…: ${academy_name}\në‹´ë‹¹ì: ${name}\nì—°ë½ì²˜: ${phone}\nì´ë©”ì¼: ${email}${student_count ? `\ní˜„ì¬ í•™ìƒ ìˆ˜: ${student_count}ëª…` : ''}\n\në¬¸ì˜ ë‚´ìš©:\n${message}`
    
    await c.env.DB.prepare(`
      INSERT INTO contacts (name, email, phone, message, status, created_at)
      VALUES (?, ?, ?, ?, 'pending', CURRENT_TIMESTAMP)
    `).bind(name, email, phone, fullMessage).run()
    
    return c.json({ 
      success: true,
      message: 'ë¬¸ì˜ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.'
    })
  } catch (err) {
    console.error('Service inquiry error:', err)
    return c.json({ success: false, error: 'ë¬¸ì˜ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' }, 500)
  }
})
// Force rebuild Sat Jan 24 20:41:42 UTC 2026

// ========================================
// êµìœ¡ë¹„ ê´€ë¦¬ í˜ì´ì§€ (ì›ì¥ë‹˜ ì „ìš© - ì„ ìƒë‹˜ 100% ì°¨ë‹¨)
// ========================================
app.get('/tools/tuition-management', async (c) => {
  return c.html(`<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµìœ¡ë¹„ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
        * { font-family: 'Pretendard Variable', sans-serif; }
        
        .calendar-cell { 
            min-height: 160px;
            position: relative;
            transition: all 0.2s;
        }
        .calendar-cell:hover { 
            background-color: #f9fafb; 
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .student-item {
            font-size: 11px;
            padding: 6px 8px;
            margin: 2px 0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .student-item:hover {
            transform: scale(1.02);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        .date-number {
            font-size: 18px;
            font-weight: 700;
        }
        .day-name {
            font-size: 10px;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-[1800px] mx-auto px-6 py-8">
        <!-- í—¤ë” -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-bold text-gray-900 mb-2">ğŸ“… êµìœ¡ë¹„ ê´€ë¦¬ ë‹¬ë ¥</h1>
                <p class="text-gray-600">í•™ìƒë³„ ì›”ë³„ êµìœ¡ë¹„ ë‚©ì… í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
            </div>
            <div class="flex gap-3">
                <button onclick="openPaymentModal()" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium shadow-lg">
                    <i class="fas fa-plus mr-2"></i> ë‚©ë¶€ ì¶”ê°€
                </button>
                <button onclick="openClassFeeModal()" class="inline-flex items-center px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium shadow-lg">
                    <i class="fas fa-cog mr-2"></i> ë°˜ êµìœ¡ë¹„ ì„¤ì •
                </button>
                <a href="/tools/revenue-management" class="inline-flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium shadow-lg">
                    <i class="fas fa-chart-line mr-2"></i> ë§¤ì¶œ ê´€ë¦¬
                </a>
                <a href="/dashboard" class="inline-flex items-center px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-medium shadow-lg">
                    <i class="fas fa-home mr-2"></i> ëŒ€ì‹œë³´ë“œ
                </a>
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ì´ í•™ìƒ ìˆ˜</span>
                    <i class="fas fa-users text-2xl opacity-80"></i>
                </div>
                <div class="text-3xl font-bold" id="totalStudents">0</div>
                <div class="text-xs opacity-75 mt-1">ëª…</div>
            </div>
            
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ì™„ë‚©</span>
                    <i class="fas fa-check-circle text-2xl opacity-80"></i>
                </div>
                <div class="text-3xl font-bold" id="paidStudents">0</div>
                <div class="text-xs opacity-75 mt-1">ëª…</div>
            </div>
            
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ë¯¸ë‚©</span>
                    <i class="fas fa-exclamation-circle text-2xl opacity-80"></i>
                </div>
                <div class="text-3xl font-bold" id="unpaidStudents">0</div>
                <div class="text-xs opacity-75 mt-1">ëª…</div>
            </div>
            
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ì˜ˆìƒ ë§¤ì¶œ</span>
                    <i class="fas fa-won-sign text-2xl opacity-80"></i>
                </div>
                <div class="text-2xl font-bold" id="totalAmount">0ì›</div>
            </div>
            
            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ì‹¤ë‚©ì…ì•¡</span>
                    <i class="fas fa-coins text-2xl opacity-80"></i>
                </div>
                <div class="text-2xl font-bold" id="totalPaid">0ì›</div>
            </div>
        </div>

        <!-- ë‹¬ë ¥ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <button onclick="prevMonth()" class="p-3 hover:bg-gray-100 rounded-xl transition">
                        <i class="fas fa-chevron-left text-gray-700 text-lg"></i>
                    </button>
                    <div class="flex gap-4">
                        <select id="yearFilter" onchange="loadCalendar()" class="px-6 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 font-bold text-lg">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                        </select>
                        <select id="monthFilter" onchange="loadCalendar()" class="px-6 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 font-bold text-lg">
                            <option value="1">1ì›”</option>
                            <option value="2">2ì›”</option>
                            <option value="3">3ì›”</option>
                            <option value="4">4ì›”</option>
                            <option value="5">5ì›”</option>
                            <option value="6">6ì›”</option>
                            <option value="7">7ì›”</option>
                            <option value="8">8ì›”</option>
                            <option value="9">9ì›”</option>
                            <option value="10">10ì›”</option>
                            <option value="11">11ì›”</option>
                            <option value="12">12ì›”</option>
                        </select>
                    </div>
                    <button onclick="nextMonth()" class="p-3 hover:bg-gray-100 rounded-xl transition">
                        <i class="fas fa-chevron-right text-gray-700 text-lg"></i>
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="goToday()" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-bold shadow-lg">
                        <i class="fas fa-calendar-day mr-2"></i>ì˜¤ëŠ˜
                    </button>
                </div>
            </div>
        </div>

        <!-- ë‹¬ë ¥ -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <!-- ìš”ì¼ í—¤ë” -->
            <div class="grid grid-cols-7 border-b-2 border-gray-300">
                <div class="p-4 text-center font-bold text-lg text-red-600 bg-red-50">ì¼ìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-gray-700 bg-gray-50">ì›”ìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-gray-700 bg-gray-50">í™”ìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-gray-700 bg-gray-50">ìˆ˜ìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-gray-700 bg-gray-50">ëª©ìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-gray-700 bg-gray-50">ê¸ˆìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-blue-600 bg-blue-50">í† ìš”ì¼</div>
            </div>
            <!-- ë‚ ì§œ ì…€ -->
            <div id="calendarBody" class="grid grid-cols-7">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>

    <!-- ê²°ì œ ì²˜ë¦¬ ëª¨ë‹¬ -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-blue-500 to-blue-600">
                <h3 class="text-2xl font-bold text-white" id="modalTitle">
                    <i class="fas fa-credit-card mr-2"></i>êµìœ¡ë¹„ ë‚©ì… ì²˜ë¦¬
                </h3>
                <button onclick="closePaymentModal()" class="text-white hover:text-gray-200 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-8">
                <!-- í•™ìƒ ì •ë³´ -->
                <div class="mb-6" id="studentInfo">
                    <label class="block text-sm font-bold text-gray-700 mb-3">í•™ìƒ ì„ íƒ</label>
                    <select id="studentSelect" onchange="loadStudentPaymentInfo()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg font-medium">
                        <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>

                <!-- ë‚©ì… ì •ë³´ í‘œì‹œ -->
                <div id="paymentInfo" class="hidden">
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-600 mb-1">í•™ìƒ ì´ë¦„</div>
                                <div class="text-lg font-bold text-gray-900" id="infoStudentName">-</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600 mb-1">ë°˜</div>
                                <div class="text-lg font-bold text-gray-900" id="infoClassName">-</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600 mb-1">ì›” êµìœ¡ë¹„</div>
                                <div class="text-lg font-bold text-blue-600" id="infoMonthlyFee">0ì›</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600 mb-1">ë‚©ì… ìƒíƒœ</div>
                                <div class="text-lg font-bold" id="infoPaymentStatus">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- ë‚©ì… í¼ -->
                    <form id="paymentForm" onsubmit="submitPayment(event)">
                        <input type="hidden" id="selectedStudentId">
                        <input type="hidden" id="selectedPaymentId">
                        <input type="hidden" id="selectedMonthlyFee">
                        
                        <div class="space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-won-sign mr-2 text-blue-600"></i>ë‚©ì… ê¸ˆì•¡
                                </label>
                                <input type="number" id="paidAmount" required 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg font-medium"
                                    placeholder="ë‚©ì… ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>ë‚©ì…ì¼
                                </label>
                                <input type="date" id="paidDate" required 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg font-medium">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-credit-card mr-2 text-blue-600"></i>ê²°ì œ ë°©ë²•
                                </label>
                                <select id="paymentMethod" required 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg font-medium">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="card">ì¹´ë“œ</option>
                                    <option value="cash">í˜„ê¸ˆ</option>
                                    <option value="transfer">ê³„ì¢Œì´ì²´</option>
                                    <option value="other">ê¸°íƒ€</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-sticky-note mr-2 text-blue-600"></i>ë©”ëª¨
                                </label>
                                <textarea id="paymentMemo" rows="3" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"
                                    placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"></textarea>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-4 rounded-xl hover:bg-blue-700 transition font-bold text-lg shadow-lg">
                                    <i class="fas fa-check mr-2"></i>ë‚©ì… ì²˜ë¦¬
                                </button>
                                <button type="button" onclick="closePaymentModal()" class="px-8 bg-gray-200 text-gray-700 py-4 rounded-xl hover:bg-gray-300 transition font-bold text-lg">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ë°˜ êµìœ¡ë¹„ ì„¤ì • ëª¨ë‹¬ -->
    <div id="classFeeModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-purple-500 to-purple-600">
                <h3 class="text-2xl font-bold text-white">
                    <i class="fas fa-cog mr-2"></i>ë°˜ êµìœ¡ë¹„ ì„¤ì •
                </h3>
                <button onclick="closeClassFeeModal()" class="text-white hover:text-gray-200 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-8">
                <p class="text-gray-600 mb-6">ê° ë°˜ì˜ ì›” êµìœ¡ë¹„ë¥¼ ì„¤ì •í•˜ì„¸ìš”. í•™ìƒì´ í•´ë‹¹ ë°˜ì— ë°°ì •ë˜ë©´ ìë™ìœ¼ë¡œ êµìœ¡ë¹„ê°€ ì ìš©ë©ë‹ˆë‹¤.</p>
                
                <div id="classList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                        <p>ë°˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentYear, currentMonth;
        let allStudents = [];
        let allPayments = {};

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            const user = localStorage.getItem('user');
            if (!user) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }

            initYearSelect();
            const today = new Date();
            document.getElementById('yearFilter').value = today.getFullYear();
            document.getElementById('monthFilter').value = today.getMonth() + 1;
            currentYear = today.getFullYear();
            currentMonth = today.getMonth() + 1;
            
            loadCalendar();
        });

        function initYearSelect() {
            const yearSelect = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 2; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'ë…„';
                yearSelect.appendChild(option);
            }
        }

        function getApiHeaders() {
            const user = JSON.parse(localStorage.getItem('user'));
            return {
                'Content-Type': 'application/json',
                'X-User-Data-Base64': btoa(unescape(encodeURIComponent(JSON.stringify(user))))
            };
        }

        async function loadCalendar() {
            currentYear = parseInt(document.getElementById('yearFilter').value);
            currentMonth = parseInt(document.getElementById('monthFilter').value);
            
            await loadPayments();
            renderCalendar();
            updateStats();
        }

        async function loadPayments() {
            try {
                const response = await fetch(\`/api/tuition/payments?year=\${currentYear}&month=\${currentMonth}\`, {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    allStudents = data.payments || [];
                    allPayments = {};
                    allStudents.forEach(payment => {
                        allPayments[payment.student_id] = payment;
                    });
                }
            } catch (error) {
                console.error('ë‚©ì… í˜„í™© ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth, 0).getDate();
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth;
            const todayDate = today.getDate();
            
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';
            
            // ì´ì „ ë‹¬ì˜ ë¹ˆ ì¹¸
            for (let i = 0; i < firstDay; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell border border-gray-200 bg-gray-50';
                calendarBody.appendChild(cell);
            }
            
            // ë‚ ì§œ ì…€
            for (let day = 1; day <= lastDate; day++) {
                const dayOfWeek = (firstDay + day - 1) % 7;
                const cell = document.createElement('div');
                cell.className = 'calendar-cell border border-gray-200 p-3 bg-white';
                
                // ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡°
                if (isCurrentMonth && day === todayDate) {
                    cell.className += ' ring-4 ring-blue-400 bg-blue-50';
                }
                
                // ì£¼ë§ ë°°ê²½ìƒ‰
                if (dayOfWeek === 0) cell.className += ' bg-red-50';
                if (dayOfWeek === 6) cell.className += ' bg-blue-50';
                
                // ë‚ ì§œ í—¤ë”
                const dateHeader = document.createElement('div');
                dateHeader.className = 'flex items-center justify-between mb-3 pb-2 border-b-2 border-gray-200';
                const dateColor = dayOfWeek === 0 ? 'text-red-600' : dayOfWeek === 6 ? 'text-blue-600' : 'text-gray-800';
                dateHeader.innerHTML = \`
                    <div>
                        <div class="date-number \${dateColor}">\${day}</div>
                        <div class="day-name text-gray-500">\${['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][dayOfWeek]}</div>
                    </div>
                \`;
                cell.appendChild(dateHeader);
                
                // í•™ìƒ ëª©ë¡
                const studentList = document.createElement('div');
                studentList.className = 'space-y-1 overflow-y-auto max-h-24';
                
                // í•´ë‹¹ ë‚ ì§œê°€ ê²°ì œì¼ì¸ í•™ìƒ í•„í„°ë§
                const studentsOnThisDay = allStudents.filter(payment => {
                    if (!payment.enrollment_date) return false;
                    const enrollDate = new Date(payment.enrollment_date);
                    return enrollDate.getDate() === day;
                });
                
                studentsOnThisDay.forEach(payment => {
                    const statusColors = {
                        'paid': { bg: 'bg-green-500', text: 'ì™„ë‚©', icon: 'fa-check-circle' },
                        'partial': { bg: 'bg-yellow-500', text: 'ë¶€ë¶„', icon: 'fa-exclamation-circle' },
                        'unpaid': { bg: 'bg-red-500', text: 'ë¯¸ë‚©', icon: 'fa-times-circle' }
                    };
                    const status = statusColors[payment.status] || statusColors['unpaid'];
                    
                    const studentItem = document.createElement('div');
                    studentItem.className = \`student-item \${status.bg} text-white font-medium cursor-pointer\`;
                    studentItem.innerHTML = \`
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-bold">\${payment.student_name}</span>
                            <i class="fas \${status.icon} text-xs"></i>
                        </div>
                        <div class="flex items-center justify-between text-xs opacity-90">
                            <span>\${payment.class_name || 'ë°˜ ì—†ìŒ'}</span>
                            <span>\${(payment.paid_amount || 0).toLocaleString()}ì›</span>
                        </div>
                    \`;
                    studentItem.onclick = () => openPaymentModal(payment.student_id);
                    studentItem.title = \`[\${status.text}] \${payment.student_name}\\në°˜: \${payment.class_name || '-'}\\nì›” êµìœ¡ë¹„: \${(payment.amount || 0).toLocaleString()}ì›\\në‚©ì…ì•¡: \${(payment.paid_amount || 0).toLocaleString()}ì›\`;
                    studentList.appendChild(studentItem);
                });
                
                cell.appendChild(studentList);
                calendarBody.appendChild(cell);
            }
        }

        async function openPaymentModal(studentId = null) {
            document.getElementById('paymentModal').classList.remove('hidden');
            
            // í•™ìƒ ëª©ë¡ ë¡œë“œ
            try {
                const response = await fetch('/api/students', {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                if (data.success && data.students) {
                    const select = document.getElementById('studentSelect');
                    select.innerHTML = '<option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    
                    data.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = \`\${student.name} (\${student.grade || '-'}) - \${student.class_name || 'ë°˜ ë¯¸ë°°ì •'}\`;
                        option.dataset.classId = student.class_id;
                        option.dataset.className = student.class_name || '-';
                        option.dataset.classFee = student.class_fee || 0;
                        option.dataset.enrollmentDate = student.enrollment_date || '';
                        if (studentId && student.id == studentId) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    if (studentId) {
                        loadStudentPaymentInfo();
                    }
                }
            } catch (error) {
                console.error('í•™ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
            
            // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paidDate').value = today;
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('paymentInfo').classList.add('hidden');
            document.getElementById('paymentForm').reset();
        }

        async function loadStudentPaymentInfo() {
            const select = document.getElementById('studentSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption.value) {
                document.getElementById('paymentInfo').classList.add('hidden');
                return;
            }
            
            const studentId = selectedOption.value;
            const studentName = selectedOption.textContent.split(' (')[0];
            const className = selectedOption.dataset.className;
            const classFee = parseInt(selectedOption.dataset.classFee) || 0;
            
            document.getElementById('selectedStudentId').value = studentId;
            document.getElementById('selectedMonthlyFee').value = classFee; // ì›” êµìœ¡ë¹„ ì €ì¥
            document.getElementById('infoStudentName').textContent = studentName;
            document.getElementById('infoClassName').textContent = className;
            document.getElementById('infoMonthlyFee').textContent = classFee.toLocaleString() + 'ì›';
            document.getElementById('paidAmount').value = classFee;
            
            // ê¸°ì¡´ ë‚©ì… ë‚´ì—­ í™•ì¸
            const payment = allPayments[studentId];
            if (payment) {
                document.getElementById('selectedPaymentId').value = payment.id || '';
                const statusText = payment.status === 'paid' ? 'ì™„ë‚©' : payment.status === 'partial' ? 'ë¶€ë¶„ë‚©ì…' : 'ë¯¸ë‚©';
                const statusClass = payment.status === 'paid' ? 'text-green-600' : payment.status === 'partial' ? 'text-yellow-600' : 'text-red-600';
                document.getElementById('infoPaymentStatus').innerHTML = \`<span class="\${statusClass}">\${statusText} (\${(payment.paid_amount || 0).toLocaleString()}ì›)</span>\`;
            } else {
                document.getElementById('infoPaymentStatus').innerHTML = '<span class="text-red-600">ë¯¸ë‚© (0ì›)</span>';
            }
            
            document.getElementById('paymentInfo').classList.remove('hidden');
        }

        async function submitPayment(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('selectedStudentId').value;
            const monthlyFee = parseInt(document.getElementById('selectedMonthlyFee').value) || 0;
            const paidAmount = parseInt(document.getElementById('paidAmount').value);
            const paidDate = document.getElementById('paidDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const memo = document.getElementById('paymentMemo').value;
            
            // ìœ íš¨ì„± ê²€ì¦
            if (!studentId) {
                alert('âŒ í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!paidAmount || paidAmount <= 0) {
                alert('âŒ ë‚©ì… ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!paidDate) {
                alert('âŒ ë‚©ì…ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!paymentMethod) {
                alert('âŒ ê²°ì œ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìƒíƒœ ìë™ ê³„ì‚°
            let status = 'unpaid';
            if (paidAmount >= monthlyFee && monthlyFee > 0) {
                status = 'paid';
            } else if (paidAmount > 0) {
                status = 'partial';
            }
            
            const requestData = {
                student_id: parseInt(studentId),
                year: currentYear,
                month: currentMonth,
                amount: monthlyFee, // ì›” êµìœ¡ë¹„
                paid_amount: paidAmount,
                paid_date: paidDate,
                payment_method: paymentMethod,
                status: status,
                memo: memo || ''
            };
            
            console.log('ğŸ“¤ ë‚©ì… ì²˜ë¦¬ ìš”ì²­:', requestData);
            
            try {
                const response = await fetch('/api/tuition/payments', {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                console.log('ğŸ“¥ API ì‘ë‹µ:', data);
                
                if (data.success) {
                    alert('âœ… ë‚©ì… ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closePaymentModal();
                    await loadCalendar();
                } else {
                    alert('âŒ ë‚©ì… ì²˜ë¦¬ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    console.error('API ì˜¤ë¥˜ ìƒì„¸:', data);
                }
            } catch (error) {
                console.error('ë‚©ì… ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('âŒ ë‚©ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function updateStats() {
            const total = allStudents.length;
            const paid = allStudents.filter(p => p.status === 'paid').length;
            const unpaid = allStudents.filter(p => p.status === 'unpaid').length;
            const totalAmount = allStudents.reduce((sum, p) => sum + (p.amount || 0), 0);
            const totalPaid = allStudents.reduce((sum, p) => sum + (p.paid_amount || 0), 0);
            
            document.getElementById('totalStudents').textContent = total;
            document.getElementById('paidStudents').textContent = paid;
            document.getElementById('unpaidStudents').textContent = unpaid;
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + 'ì›';
            document.getElementById('totalPaid').textContent = totalPaid.toLocaleString() + 'ì›';
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            document.getElementById('yearFilter').value = currentYear;
            document.getElementById('monthFilter').value = currentMonth;
            loadCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            document.getElementById('yearFilter').value = currentYear;
            document.getElementById('monthFilter').value = currentMonth;
            loadCalendar();
        }

        function goToday() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth() + 1;
            document.getElementById('yearFilter').value = currentYear;
            document.getElementById('monthFilter').value = currentMonth;
            loadCalendar();
        }

        // ========== ë°˜ êµìœ¡ë¹„ ì„¤ì • ê¸°ëŠ¥ ==========
        async function openClassFeeModal() {
            document.getElementById('classFeeModal').classList.remove('hidden');
            await loadClassList();
        }

        function closeClassFeeModal() {
            document.getElementById('classFeeModal').classList.add('hidden');
        }

        async function loadClassList() {
            const classList = document.getElementById('classList');
            try {
                const response = await fetch('/api/tuition/classes', {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                if (data.success && data.classes) {
                    if (data.classes.length === 0) {
                        classList.innerHTML = \`
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-exclamation-circle text-3xl mb-3"></i>
                                <p>ë“±ë¡ëœ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                <a href="/students/classes" class="mt-4 inline-block text-blue-600 hover:underline">
                                    <i class="fas fa-plus-circle mr-1"></i>ë°˜ ë“±ë¡í•˜ëŸ¬ ê°€ê¸°
                                </a>
                            </div>
                        \`;
                        return;
                    }

                    classList.innerHTML = data.classes.map(cls => \`
                        <div class="bg-gray-50 rounded-xl p-6 border-2 border-gray-200 hover:border-purple-400 transition">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h4 class="text-lg font-bold text-gray-900">\${cls.name}</h4>
                                    <p class="text-sm text-gray-600">\${cls.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                                    <p class="text-sm text-gray-500 mt-1">
                                        <i class="fas fa-users mr-1"></i>í•™ìƒ ìˆ˜: \${cls.student_count || 0}ëª…
                                        \${cls.teacher_name ? \` | <i class="fas fa-chalkboard-teacher mr-1"></i>\${cls.teacher_name}\` : ''}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-purple-600">\${(cls.monthly_fee || 0).toLocaleString()}ì›</div>
                                    <div class="text-xs text-gray-500">ì›” êµìœ¡ë¹„</div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <input 
                                    type="number" 
                                    id="classFee_\${cls.id}" 
                                    value="\${cls.monthly_fee || 0}" 
                                    placeholder="ì›” êµìœ¡ë¹„"
                                    class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 font-medium text-lg"
                                />
                                <button 
                                    onclick="updateClassFee(\${cls.id})" 
                                    class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                                    <i class="fas fa-save mr-1"></i>ì €ì¥
                                </button>
                            </div>
                        </div>
                    \`).join('');
                }
            } catch (error) {
                console.error('ë°˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                classList.innerHTML = \`
                    <div class="text-center text-red-500 py-8">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                        <p>ë°˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                \`;
            }
        }

        async function updateClassFee(classId) {
            const feeInput = document.getElementById(\`classFee_\${classId}\`);
            const monthly_fee = parseInt(feeInput.value);

            if (!monthly_fee || monthly_fee < 0) {
                alert('âŒ ìœ íš¨í•œ êµìœ¡ë¹„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(\`/api/tuition/classes/\${classId}/fee\`, {
                    method: 'PUT',
                    headers: getApiHeaders(),
                    body: JSON.stringify({ monthly_fee })
                });

                const data = await response.json();

                if (data.success) {
                    alert(\`âœ… ë°˜ êµìœ¡ë¹„ê°€ \${monthly_fee.toLocaleString()}ì›ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\`);
                    await loadClassList();
                    await loadCalendar();
                } else {
                    alert('âŒ êµìœ¡ë¹„ ì„¤ì • ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('êµìœ¡ë¹„ ì„¤ì • ì‹¤íŒ¨:', error);
                alert('âŒ êµìœ¡ë¹„ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>
`)
})

app.get('/tools/revenue-management', async (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ë§¤ì¶œ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <style>
          @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
          * { font-family: 'Pretendard Variable', sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="fixed w-full top-0 z-50 bg-white border-b border-gray-100">
            <div class="max-w-7xl mx-auto px-6">
                <div class="flex justify-between items-center h-16">
                    <span class="text-xl font-bold text-gray-900">ğŸ’° ë§¤ì¶œ ê´€ë¦¬</span>
                    <div class="flex gap-4">
                        <a href="/dashboard" class="text-gray-600 hover:text-purple-600">ëŒ€ì‹œë³´ë“œ</a>
                        <button onclick="logout()" class="text-gray-600 hover:text-red-600">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-24 pb-12 px-6">
            <div class="max-w-7xl mx-auto">
                <!-- ì›” ì„ íƒ -->
                <div class="mb-6 flex items-center gap-4">
                    <select id="yearSelect" class="px-4 py-2 border border-gray-300 rounded-lg">
                    </select>
                    <select id="monthSelect" class="px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="1">1ì›”</option>
                        <option value="2">2ì›”</option>
                        <option value="3">3ì›”</option>
                        <option value="4">4ì›”</option>
                        <option value="5">5ì›”</option>
                        <option value="6">6ì›”</option>
                        <option value="7">7ì›”</option>
                        <option value="8">8ì›”</option>
                        <option value="9">9ì›”</option>
                        <option value="10">10ì›”</option>
                        <option value="11">11ì›”</option>
                        <option value="12">12ì›”</option>
                    </select>
                    <button onclick="loadData()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <i class="fas fa-sync mr-2"></i>ì¡°íšŒ
                    </button>
                </div>

                <!-- ëŒ€ì‹œë³´ë“œ í†µê³„ ì¹´ë“œ -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="text-sm text-gray-600 mb-2">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</div>
                        <div id="thisMonthRevenue" class="text-3xl font-bold text-green-600">0ì›</div>
                        <div id="growthRate" class="text-sm text-gray-500 mt-2"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="text-sm text-gray-600 mb-2">ì˜ˆìƒ ë§¤ì¶œ</div>
                        <div id="expectedRevenue" class="text-3xl font-bold text-blue-600">0ì›</div>
                        <div id="collectionRate" class="text-sm text-gray-500 mt-2"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="text-sm text-gray-600 mb-2">ë¯¸ìˆ˜ê¸ˆ</div>
                        <div id="unpaidAmount" class="text-3xl font-bold text-red-600">0ì›</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="text-sm text-gray-600 mb-2">ì´ í•™ìƒ</div>
                        <div id="totalStudents" class="text-3xl font-bold text-gray-900">0ëª…</div>
                        <div class="text-sm text-gray-500 mt-2">ë‚©ì…: <span id="payingStudents">0</span>ëª…</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="text-sm text-gray-600 mb-2">ì„ ìƒë‹˜ ìˆ˜</div>
                        <div id="totalTeachers" class="text-3xl font-bold text-purple-600">0ëª…</div>
                    </div>
                </div>

                <!-- ì—°ê°„ ë§¤ì¶œ ê·¸ë˜í”„ -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-chart-line mr-2"></i>ì—°ê°„ ë§¤ì¶œ ì¶”ì´
                    </h2>
                    <canvas id="revenueChart" height="80"></canvas>
                </div>

                <!-- í•™ìƒë³„ ë§¤ì¶œ ê¸°ì—¬ë„ -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">
                        <i class="fas fa-users mr-2"></i>í•™ìƒë³„ ë‚©ì… í˜„í™©
                    </h2>
                    <div id="studentList" class="space-y-3">
                        <p class="text-gray-500">ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>

        <script>
        let user = null;
        let revenueChart = null;

        // ë¡œê·¸ì¸ ì²´í¬ ë° ì„ ìƒë‹˜ ì°¨ë‹¨
        const userData = localStorage.getItem('user');
        if (!userData) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login';
        } else {
            user = JSON.parse(userData);
            
            // ì„ ìƒë‹˜ì€ 100% ì°¨ë‹¨
            if (user.user_type === 'teacher') {
                alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = '/dashboard';
            } else {
                initPage();
            }
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/';
        }

        function base64Encode(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => {
                return String.fromCharCode('0x' + p1);
            }));
        }

        function initPage() {
            // ì—°ë„ ì„ íƒ ì´ˆê¸°í™”
            const now = new Date();
            const yearSelect = document.getElementById('yearSelect');
            for (let i = now.getFullYear() - 2; i <= now.getFullYear() + 1; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + 'ë…„';
                if (i === now.getFullYear()) option.selected = true;
                yearSelect.appendChild(option);
            }

            // ì›” ì„ íƒ ì´ˆê¸°í™”
            document.getElementById('monthSelect').value = now.getMonth() + 1;

            // ë°ì´í„° ë¡œë“œ
            loadData();
        }

        async function loadData() {
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;

            await Promise.all([
                loadMonthlyRevenue(year, month),
                loadYearlyRevenue(year),
                loadStudentRevenue(year, month),
                loadDashboard()
            ]);
        }
        
        async function loadDashboard() {
            try {
                const userDataBase64 = base64Encode(JSON.stringify(user));
                const response = await fetch('/api/revenue/dashboard', {
                    headers: { 'X-User-Data-Base64': userDataBase64 }
                });
                const data = await response.json();

                if (data.success && data.dashboard) {
                    document.getElementById('totalTeachers').textContent = data.dashboard.total_teachers + 'ëª…';
                }
            } catch (err) {
                console.error('Dashboard error:', err);
            }
        }

        async function loadMonthlyRevenue(year, month) {
            try {
                const userDataBase64 = base64Encode(JSON.stringify(user));
                const response = await fetch(\`/api/revenue/monthly?year=\${year}&month=\${month}\`, {
                    headers: { 'X-User-Data-Base64': userDataBase64 }
                });
                const data = await response.json();

                if (data.success && data.revenue) {
                    const r = data.revenue;
                    document.getElementById('thisMonthRevenue').textContent = r.total_paid.toLocaleString() + 'ì›';
                    document.getElementById('expectedRevenue').textContent = r.expected_revenue.toLocaleString() + 'ì›';
                    document.getElementById('unpaidAmount').textContent = r.total_unpaid.toLocaleString() + 'ì›';
                    document.getElementById('totalStudents').textContent = r.total_students + 'ëª…';
                    document.getElementById('payingStudents').textContent = r.paying_students;
                    
                    const rate = parseFloat(r.collection_rate) || 0;
                    document.getElementById('collectionRate').textContent = \`ìˆ˜ê¸ˆë¥ : \${rate}%\`;
                    
                    // ì„±ì¥ë¥  í‘œì‹œ
                    const growth = parseFloat(r.growth_rate) || 0;
                    const growthEl = document.getElementById('growthRate');
                    if (growth > 0) {
                        growthEl.textContent = \`â–² \${growth}% ì¦ê°€\`;
                        growthEl.className = 'text-sm text-green-600 mt-2';
                    } else if (growth < 0) {
                        growthEl.textContent = \`â–¼ \${Math.abs(growth)}% ê°ì†Œ\`;
                        growthEl.className = 'text-sm text-red-600 mt-2';
                    } else {
                        growthEl.textContent = 'ì „ì›” ëŒ€ë¹„ ë™ì¼';
                        growthEl.className = 'text-sm text-gray-500 mt-2';
                    }
                }
            } catch (err) {
                console.error('Monthly revenue error:', err);
            }
        }

        async function loadYearlyRevenue(year) {
            try {
                const userDataBase64 = base64Encode(JSON.stringify(user));
                const response = await fetch(\`/api/revenue/yearly?year=\${year}\`, {
                    headers: { 'X-User-Data-Base64': userDataBase64 }
                });
                const data = await response.json();

                if (data.success && data.monthly_data) {
                    const labels = data.monthly_data.map(m => m.month + 'ì›”');
                    const values = data.monthly_data.map(m => m.total_paid);

                    const ctx = document.getElementById('revenueChart');
                    
                    if (revenueChart) {
                        revenueChart.destroy();
                    }

                    revenueChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'ì›”ë³„ ë§¤ì¶œ',
                                data: values,
                                backgroundColor: 'rgba(147, 51, 234, 0.5)',
                                borderColor: 'rgba(147, 51, 234, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.parsed.y.toLocaleString() + 'ì›';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString() + 'ì›';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (err) {
                console.error('Yearly revenue error:', err);
            }
        }

        async function loadStudentRevenue(year, month) {
            try {
                const userDataBase64 = base64Encode(JSON.stringify(user));
                const response = await fetch(\`/api/revenue/by-student?year=\${year}&month=\${month}\`, {
                    headers: { 'X-User-Data-Base64': userDataBase64 }
                });
                const data = await response.json();

                if (data.success) {
                    const statusColors = {
                        'paid': 'bg-green-50 border-green-300',
                        'unpaid': 'bg-red-50 border-red-300',
                        'partial': 'bg-yellow-50 border-yellow-300',
                        'overdue': 'bg-orange-50 border-orange-300'
                    };

                    const statusLabels = {
                        'paid': 'ì™„ë‚©',
                        'unpaid': 'ë¯¸ë‚©',
                        'partial': 'ë¶€ë¶„ë‚©',
                        'overdue': 'ì—°ì²´'
                    };

                    const statusTextColors = {
                        'paid': 'text-green-700',
                        'unpaid': 'text-red-700',
                        'partial': 'text-yellow-700',
                        'overdue': 'text-orange-700'
                    };

                    const html = data.students.length === 0 
                        ? '<p class="text-gray-500">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>'
                        : data.students.map(s => \`
                            <div class="p-4 rounded-lg border \${statusColors[s.payment_status] || 'bg-gray-50 border-gray-300'}">
                                <div class="flex justify-between items-center">
                                    <div class="flex-1">
                                        <div class="font-bold text-gray-900">\${s.student_name} (\${s.grade || '-'})</div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            êµìœ¡ë¹„: \${s.monthly_fee.toLocaleString()}ì› | 
                                            ë‚©ì…: \${s.paid_amount.toLocaleString()}ì›
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="px-3 py-1 rounded-full text-sm font-medium \${statusTextColors[s.payment_status] || 'text-gray-700'} \${statusColors[s.payment_status] || 'bg-gray-100'}">
                                            \${statusLabels[s.payment_status] || s.payment_status}
                                        </span>
                                        \${s.paid_date ? \`<div class="text-xs text-gray-500 mt-1">\${s.paid_date}</div>\` : ''}
                                    </div>
                                </div>
                            </div>
                        \`).join('');

                    document.getElementById('studentList').innerHTML = html;
                }
            } catch (err) {
                console.error('Student revenue error:', err);
                document.getElementById('studentList').innerHTML = '<p class="text-red-600">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }
        </script>
    </body>
    </html>
  `)
})


// ê´€ë¦¬ì: ì¹´ë“œê²°ì œ ì‹ ì²­ ê´€ë¦¬ í˜ì´ì§€
app.get('/admin/card-payments', async (c) => {
  const { env } = c
  if (!env?.DB) return c.html('<h1>DB Error</h1>')
  
  // ì¹´ë“œê²°ì œ ì‹ ì²­ ëª©ë¡ ì¡°íšŒ
  const requests = await env.DB.prepare(`
    SELECT 
      cpr.*,
      u.name as user_name,
      u.email as user_email,
      u.phone as user_phone
    FROM card_payment_requests cpr
    LEFT JOIN users u ON cpr.user_id = u.id
    ORDER BY 
      CASE 
        WHEN cpr.status = 'pending' THEN 1
        WHEN cpr.status = 'approved' THEN 2
        WHEN cpr.status = 'rejected' THEN 3
      END,
      cpr.created_at DESC
  `).all()
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì¹´ë“œê²°ì œ ì‹ ì²­ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            .gradient-pink { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); }
        </style>
    </head>
    <body class="bg-gray-50">
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-8">
                        <a href="/admin/dashboard" class="text-2xl font-bold text-pink-600">
                            <i class="fas fa-arrow-left mr-2"></i>ê´€ë¦¬ì
                        </a>
                        <h1 class="text-xl font-semibold">ì¹´ë“œê²°ì œ ì‹ ì²­ ê´€ë¦¬</h1>
                    </div>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-6 py-8">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-credit-card text-pink-600 mr-2"></i>
                        ì¹´ë“œê²°ì œ ì‹ ì²­ ëª©ë¡
                    </h2>
                    <div class="text-sm text-gray-600">
                        ì´ ${requests.results?.length || 0}ê±´
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ìƒíƒœ</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ì‹ ì²­ì¼ì‹œ (KST)</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ì‹ ì²­ì</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ì—°ë½ì²˜</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">í”Œëœ</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">ê¸ˆì•¡</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ë¹„ê³ </th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            ${requests.results?.map(req => {
                              const statusBadge = req.status === 'pending' 
                                ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">ëŒ€ê¸°ì¤‘</span>'
                                : req.status === 'approved'
                                ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">ìŠ¹ì¸ë¨</span>'
                                : '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">ê±°ë¶€ë¨</span>'
                              
                              return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">${statusBadge}</td>
                                    <td class="px-4 py-3 text-sm" data-utc="${req.created_at}">
                                        <div class="kst-time">${req.created_at}</div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium">${req.user_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</div>
                                        <div class="text-xs text-gray-500">${req.user_email || ''}</div>
                                    </td>
                                    <td class="px-4 py-3 text-sm">${req.user_phone || '-'}</td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 bg-pink-100 text-pink-800 rounded text-xs font-medium">
                                            ${req.plan_name}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-right font-semibold">
                                        â‚©${req.amount?.toLocaleString() || 0}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-600">${req.note || '-'}</td>
                                    <td class="px-4 py-3 text-center">
                                        ${req.status === 'pending' ? `
                                            <button onclick="approveRequest(${req.id}, '${req.user_name}', '${req.plan_name}')" 
                                                    class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 mr-2">
                                                ìŠ¹ì¸
                                            </button>
                                            <button onclick="rejectRequest(${req.id}, '${req.user_name}')" 
                                                    class="px-3 py-1 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700">
                                                ê±°ë¶€
                                            </button>
                                        ` : '<span class="text-gray-400 text-sm">ì²˜ë¦¬ì™„ë£Œ</span>'}
                                    </td>
                                </tr>
                              `
                            }).join('') || '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // UTC to KST ë³€í™˜ í•¨ìˆ˜
            function convertToKST() {
                document.querySelectorAll('.kst-time').forEach(el => {
                    const utcTime = el.closest('td').getAttribute('data-utc')
                    if (utcTime) {
                        const date = new Date(utcTime)
                        // í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³€í™˜ (UTC+9)
                        const kstDate = new Date(date.getTime() + (9 * 60 * 60 * 1000))
                        const formatted = kstDate.toLocaleString('ko-KR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        })
                        el.textContent = formatted.replace(/\\. /g, '-').replace(/\\./g, '') + ' (KST)'
                    }
                })
            }
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë³€í™˜
            convertToKST()
            
            async function approveRequest(id, userName, planName) {
                if (!confirm(\`\${userName}ë‹˜ì˜ \${planName} ì¹´ë“œê²°ì œ ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\`)) return
                
                try {
                    const response = await fetch('/api/card-payment/approve', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            requestId: id,
                            adminEmail: 'admin@superplace.co.kr'
                        })
                    })
                    
                    const result = await response.json()
                    if (result.success) {
                        alert('âœ… ìŠ¹ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\\n\\n' + (result.message || 'ì‚¬ìš©ìì—ê²Œ ê²°ì œ ë§í¬ë¥¼ ë¬¸ìë¡œ ë°œì†¡í•´ì£¼ì„¸ìš”.'))
                        location.reload()
                    } else {
                        let errorMsg = 'âŒ ìŠ¹ì¸ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜')
                        if (result.details) {
                            errorMsg += '\\n\\nìƒì„¸ ì˜¤ë¥˜: ' + result.details
                        }
                        alert(errorMsg)
                        console.error('Approval error:', result)
                    }
                } catch (error) {
                    alert('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\\n\\n' + error)
                    console.error('Network error:', error)
                }
            }
            
            async function rejectRequest(id, userName) {
                const reason = prompt(\`\${userName}ë‹˜ì˜ ì‹ ì²­ì„ ê±°ë¶€í•˜ëŠ” ì´ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:\`)
                if (!reason) return
                
                try {
                    const response = await fetch('/api/card-payment/reject', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            requestId: id,
                            adminEmail: 'admin@superplace.co.kr',
                            reason: reason
                        })
                    })
                    
                    const result = await response.json()
                    if (result.success) {
                        alert('âœ… ê±°ë¶€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.')
                        location.reload()
                    } else {
                        alert('âŒ ê±°ë¶€ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'))
                    }
                } catch (error) {
                    alert('âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')
                    console.error(error)
                }
            }
        </script>
    </body>
    </html>
  `)
})

