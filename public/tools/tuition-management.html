<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµìœ¡ë¹„ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
        * { font-family: 'Pretendard Variable', sans-serif; }
        .calendar-cell { 
            min-height: 120px; 
            position: relative;
        }
        .calendar-cell:hover { background-color: #f9fafb; }
        .student-badge { 
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #calendarBody {
            min-height: 600px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-[1600px] mx-auto px-4 py-8">
        <!-- í—¤ë” -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ’° êµìœ¡ë¹„ ê´€ë¦¬ ë‹¬ë ¥</h1>
                <p class="text-gray-600">ì›”ë³„ í•™ìƒ êµìœ¡ë¹„ ë‚©ì… í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
            </div>
            <div class="flex gap-3">
                <button onclick="showClassManagement()" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                    <i class="fas fa-cog mr-2"></i> ë°˜ êµìœ¡ë¹„ ì„¤ì •
                </button>
                <a href="/dashboard" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    <i class="fas fa-arrow-left mr-2"></i> ëŒ€ì‹œë³´ë“œ
                </a>
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs font-medium text-gray-600">ì´ í•™ìƒ ìˆ˜</span>
                    <i class="fas fa-users text-blue-500 text-sm"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900" id="totalStudents">0</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs font-medium text-gray-600">ì™„ë‚©</span>
                    <i class="fas fa-check-circle text-green-500 text-sm"></i>
                </div>
                <div class="text-2xl font-bold text-green-600" id="paidStudents">0</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs font-medium text-gray-600">ë¯¸ë‚©</span>
                    <i class="fas fa-exclamation-circle text-red-500 text-sm"></i>
                </div>
                <div class="text-2xl font-bold text-red-600" id="unpaidStudents">0</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs font-medium text-gray-600">ì˜ˆìƒ ë§¤ì¶œ</span>
                    <i class="fas fa-won-sign text-purple-500 text-sm"></i>
                </div>
                <div class="text-2xl font-bold text-gray-900" id="totalAmount">0ì›</div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center justify-between mb-1">
                    <span class="text-xs font-medium text-gray-600">ì‹¤ë‚©ì…ì•¡</span>
                    <i class="fas fa-coins text-yellow-500 text-sm"></i>
                </div>
                <div class="text-2xl font-bold text-blue-600" id="totalPaid">0ì›</div>
            </div>
        </div>

        <!-- ë‹¬ë ¥ í—¤ë” -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="prevMonth()" class="p-2 hover:bg-gray-100 rounded-lg transition">
                        <i class="fas fa-chevron-left text-gray-600"></i>
                    </button>
                    <div class="flex gap-3">
                        <select id="yearFilter" onchange="loadCalendar()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-semibold">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                        </select>
                        <select id="monthFilter" onchange="loadCalendar()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-semibold">
                            <option value="1">1ì›”</option>
                            <option value="2">2ì›”</option>
                            <option value="3">3ì›”</option>
                            <option value="4">4ì›”</option>
                            <option value="5">5ì›”</option>
                            <option value="6">6ì›”</option>
                            <option value="7">7ì›”</option>
                            <option value="8">8ì›”</option>
                            <option value="9">9ì›”</option>
                            <option value="10">10ì›”</option>
                            <option value="11">11ì›”</option>
                            <option value="12">12ì›”</option>
                        </select>
                    </div>
                    <button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded-lg transition">
                        <i class="fas fa-chevron-right text-gray-600"></i>
                    </button>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="goToday()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                        ì˜¤ëŠ˜
                    </button>
                </div>
            </div>
        </div>

        <!-- ë‹¬ë ¥ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="grid grid-cols-7 border-b border-gray-200">
                <div class="p-3 text-center font-semibold text-red-600 bg-red-50 border-r border-gray-200">ì¼</div>
                <div class="p-3 text-center font-semibold text-gray-700 bg-gray-50 border-r border-gray-200">ì›”</div>
                <div class="p-3 text-center font-semibold text-gray-700 bg-gray-50 border-r border-gray-200">í™”</div>
                <div class="p-3 text-center font-semibold text-gray-700 bg-gray-50 border-r border-gray-200">ìˆ˜</div>
                <div class="p-3 text-center font-semibold text-gray-700 bg-gray-50 border-r border-gray-200">ëª©</div>
                <div class="p-3 text-center font-semibold text-gray-700 bg-gray-50 border-r border-gray-200">ê¸ˆ</div>
                <div class="p-3 text-center font-semibold text-blue-600 bg-blue-50">í† </div>
            </div>
            <div id="calendarBody" class="grid grid-cols-7 auto-rows-fr">
                <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
            </div>
        </div>
    </div>

    <!-- í•™ìƒ ì¶”ê°€/ê²°ì œ ì²˜ë¦¬ ëª¨ë‹¬ -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-900" id="modalTitle">ë‚©ì… ì²˜ë¦¬</h3>
                <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <input type="hidden" id="modalDay">
                
                <!-- í•™ìƒ ì„ íƒ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">í•™ìƒ ì„ íƒ</label>
                    <select id="modalStudent" onchange="onStudentChange()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>

                <div id="paymentForm" class="hidden">
                    <!-- ë°˜ ì •ë³´ -->
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">ì†Œì† ë°˜</span>
                            <span id="modalClassName" class="text-sm font-bold text-blue-600">-</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">ë°˜ êµìœ¡ë¹„</span>
                            <span id="modalClassFee" class="text-sm font-bold text-blue-600">0ì›</span>
                        </div>
                    </div>

                    <!-- ë‚©ì…ì•¡ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë‚©ì…ì•¡</label>
                        <input type="number" id="modalPaidAmount" placeholder="ë‚©ì…ì•¡ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <!-- ë‚©ì… ë°©ë²• -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë‚©ì… ë°©ë²•</label>
                        <select id="modalPaymentMethod" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">ì„ íƒ</option>
                            <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                            <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                        </select>
                    </div>

                    <!-- ë©”ëª¨ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë©”ëª¨</label>
                        <textarea id="modalMemo" rows="3" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <!-- í˜„ì¬ ìƒíƒœ -->
                    <div id="currentStatus" class="hidden mb-4 p-4 bg-yellow-50 rounded-lg">
                        <div class="text-sm font-medium text-gray-700 mb-2">í˜„ì¬ ë‚©ì… ìƒíƒœ</div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-600">ê¸°ë‚©ì…ì•¡</span>
                            <span id="currentPaidAmount" class="font-bold text-gray-900">0ì›</span>
                        </div>
                        <div class="flex items-center justify-between text-sm mt-1">
                            <span class="text-gray-600">ë‚©ì…ì¼</span>
                            <span id="currentPaidDate" class="text-gray-600">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closePaymentModal()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                    ì·¨ì†Œ
                </button>
                <button onclick="savePayment()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    <i class="fas fa-save mr-2"></i>ì €ì¥
                </button>
            </div>
        </div>
    </div>

    <!-- ë°˜ êµìœ¡ë¹„ ì„¤ì • ëª¨ë‹¬ -->
    <div id="classManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-900">ë°˜ë³„ êµìœ¡ë¹„ ì„¤ì •</h3>
                <button onclick="closeClassManagement()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600">ê° ë°˜ì˜ ì›” êµìœ¡ë¹„ë¥¼ ì„¤ì •í•˜ì„¸ìš”. í•™ìƒì´ ì†Œì†ëœ ë°˜ì˜ êµìœ¡ë¹„ê°€ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">ë°˜ ì´ë¦„</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">ë‹´ë‹¹ ì„ ìƒë‹˜</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">í•™ìƒ ìˆ˜</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">ì›” êµìœ¡ë¹„</th>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="classList" class="divide-y divide-gray-200">
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                    ë¡œë”© ì¤‘...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end">
                <button onclick="closeClassManagement()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let allStudents = [];
        let allPayments = {};

        // Base64 ì¸ì½”ë”© (UTF-8 ì§€ì›)
        function encodeBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        // ì‚¬ìš©ì ì •ë³´ í™•ì¸ ë° ê¶Œí•œ ì²´í¬
        function checkAuth() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.id) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return null;
            }
            
            // ì„ ìƒë‹˜ì€ ì ‘ê·¼ ë¶ˆê°€
            if (user.user_type === 'teacher') {
                alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = '/dashboard';
                return null;
            }
            
            return user;
        }

        // API í—¤ë” ìƒì„±
        function getApiHeaders() {
            return {
                'X-User-Data-Base64': encodeBase64(JSON.stringify(currentUser))
            };
        }

        // ë…„ë„ í•„í„° ì´ˆê¸°í™”
        function initYearFilter() {
            const yearFilter = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'ë…„';
                if (year === currentYear) option.selected = true;
                yearFilter.appendChild(option);
            }
        }

        // ì›” í•„í„° ì´ˆê¸°í™”
        function initMonthFilter() {
            const monthFilter = document.getElementById('monthFilter');
            const currentMonth = new Date().getMonth() + 1;
            monthFilter.value = currentMonth;
        }

        // ì´ì „ ë‹¬
        function prevMonth() {
            const year = parseInt(document.getElementById('yearFilter').value);
            const month = parseInt(document.getElementById('monthFilter').value);
            
            if (month === 1) {
                document.getElementById('yearFilter').value = year - 1;
                document.getElementById('monthFilter').value = 12;
            } else {
                document.getElementById('monthFilter').value = month - 1;
            }
            loadCalendar();
        }

        // ë‹¤ìŒ ë‹¬
        function nextMonth() {
            const year = parseInt(document.getElementById('yearFilter').value);
            const month = parseInt(document.getElementById('monthFilter').value);
            
            if (month === 12) {
                document.getElementById('yearFilter').value = year + 1;
                document.getElementById('monthFilter').value = 1;
            } else {
                document.getElementById('monthFilter').value = month + 1;
            }
            loadCalendar();
        }

        // ì˜¤ëŠ˜ë¡œ ì´ë™
        function goToday() {
            const now = new Date();
            document.getElementById('yearFilter').value = now.getFullYear();
            document.getElementById('monthFilter').value = now.getMonth() + 1;
            loadCalendar();
        }

        // í†µê³„ ë¡œë“œ
        async function loadStats() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            
            try {
                const response = await fetch(`/api/tuition/stats?year=${year}&month=${month}`, {
                    headers: getApiHeaders()
                });
                
                const data = await response.json();
                
                if (data.success && data.stats) {
                    document.getElementById('totalStudents').textContent = data.stats.total_students || 0;
                    document.getElementById('paidStudents').textContent = data.stats.paid_count || 0;
                    document.getElementById('unpaidStudents').textContent = data.stats.unpaid_count || 0;
                    document.getElementById('totalAmount').textContent = ((data.stats.total_amount || 0).toLocaleString()) + 'ì›';
                    document.getElementById('totalPaid').textContent = ((data.stats.total_paid || 0).toLocaleString()) + 'ì›';
                }
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë‹¬ë ¥ ë¡œë“œ
        async function loadCalendar() {
            const year = parseInt(document.getElementById('yearFilter').value);
            const month = parseInt(document.getElementById('monthFilter').value);
            
            // í†µê³„ ë¡œë“œ
            loadStats();
            
            // í•´ë‹¹ ì›”ì˜ í•™ìƒ ë‚©ì… í˜„í™© ë¡œë“œ
            try {
                const response = await fetch(`/api/tuition/payments?year=${year}&month=${month}`, {
                    headers: getApiHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    allPayments = {};
                    allStudents = data.payments || [];
                    
                    // í•™ìƒë³„ë¡œ ì •ë¦¬
                    allStudents.forEach(payment => {
                        allPayments[payment.student_id] = payment;
                    });
                }
                
                // ë‹¬ë ¥ ê·¸ë¦¬ê¸°
                renderCalendar(year, month);
            } catch (error) {
                console.error('ë‚©ì… í˜„í™© ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë‹¬ë ¥ ë Œë”ë§ (í•™ìƒë³„ ê²°ì œì¼ ê¸°ì¤€)
        function renderCalendar(year, month) {
            const firstDay = new Date(year, month - 1, 1).getDay();
            const lastDate = new Date(year, month, 0).getDate();
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() + 1 === month;
            const todayDate = today.getDate();
            
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';
            
            // ì´ì „ ë‹¬ì˜ ë¹ˆ ì¹¸
            for (let i = 0; i < firstDay; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell border-b border-gray-200 bg-gray-50';
                if (i < 6) cell.className += ' border-r';
                calendarBody.appendChild(cell);
            }
            
            // ë‚ ì§œ ì…€
            for (let day = 1; day <= lastDate; day++) {
                const dayOfWeek = (firstDay + day - 1) % 7;
                const cell = document.createElement('div');
                cell.className = 'calendar-cell border-b border-gray-200 p-2';
                if (dayOfWeek < 6) cell.className += ' border-r';
                
                // ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡°
                if (isCurrentMonth && day === todayDate) {
                    cell.classList.add('bg-blue-50', 'ring-2', 'ring-blue-300');
                }
                
                // ë‚ ì§œ í—¤ë”
                const dateHeader = document.createElement('div');
                dateHeader.className = 'flex items-center justify-between mb-2 pb-1 border-b border-gray-200';
                dateHeader.innerHTML = `
                    <span class="text-sm font-bold ${isCurrentMonth && day === todayDate ? 'text-blue-600' : dayOfWeek === 0 ? 'text-red-600' : dayOfWeek === 6 ? 'text-blue-600' : 'text-gray-700'}">${day}</span>
                    <span class="text-xs text-gray-400">${['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][dayOfWeek]}</span>
                `;
                cell.appendChild(dateHeader);
                
                // í•™ìƒ ëª©ë¡ (enrollment_dateì˜ ì¼ìê°€ dayì™€ ê°™ì€ í•™ìƒë“¤)
                const studentList = document.createElement('div');
                studentList.className = 'space-y-1 overflow-y-auto';
                studentList.style.maxHeight = '80px';
                
                // í•´ë‹¹ ë‚ ì§œê°€ ê²°ì œì¼ì¸ í•™ìƒ í•„í„°ë§
                const studentsOnThisDay = allStudents.filter(payment => {
                    if (!payment.enrollment_date) return false;
                    const enrollDate = new Date(payment.enrollment_date);
                    const paymentDay = enrollDate.getDate();
                    return paymentDay === day;
                });
                
                studentsOnThisDay.forEach(payment => {
                    const badge = document.createElement('div');
                    const statusClass = 
                        payment.status === 'paid' ? 'bg-green-500' :
                        payment.status === 'partial' ? 'bg-yellow-500' : 'bg-red-500';
                    
                    badge.className = `student-badge px-2 py-1 rounded text-white cursor-pointer hover:opacity-80 transition ${statusClass}`;
                    badge.innerHTML = `
                        <div class="flex items-center justify-between gap-1">
                            <span class="font-medium truncate">${payment.student_name}</span>
                            <span class="text-xs">${(payment.paid_amount || 0).toLocaleString()}ì›</span>
                        </div>
                    `;
                    badge.onclick = (e) => {
                        e.stopPropagation();
                        editPayment(payment.student_id, day);
                    };
                    badge.title = `${payment.student_name} - ${payment.status === 'paid' ? 'ì™„ë‚©' : payment.status === 'partial' ? 'ë¶€ë¶„ë‚©ì…' : 'ë¯¸ë‚©'}`;
                    studentList.appendChild(badge);
                });
                
                // í•™ìƒì´ ìˆì„ ë•Œë§Œ ì¶”ê°€ ë²„íŠ¼ í‘œì‹œ
                if (studentsOnThisDay.length > 0) {
                    const addMoreBtn = document.createElement('button');
                    addMoreBtn.className = 'w-full text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition mt-1';
                    addMoreBtn.innerHTML = '<i class="fas fa-plus mr-1"></i>ì¶”ê°€';
                    addMoreBtn.onclick = () => openPaymentModal(day);
                    studentList.appendChild(addMoreBtn);
                }
                
                cell.appendChild(studentList);
                calendarBody.appendChild(cell);
            }
        }
            
            // ë‚ ì§œ ì…€
            for (let day = 1; day <= lastDate; day++) {
                const dayOfWeek = (firstDay + day - 1) % 7;
                const cell = document.createElement('div');
                cell.className = 'calendar-cell border-b border-gray-200 p-2 cursor-pointer';
                if (dayOfWeek < 6) cell.className += ' border-r';
                
                // ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡°
                if (isCurrentMonth && day === todayDate) {
                    cell.classList.add('bg-blue-50');
                }
                
                // ë‚ ì§œ í—¤ë”
                const dateHeader = document.createElement('div');
                dateHeader.className = 'flex items-center justify-between mb-2 pb-1 border-b border-gray-200';
                dateHeader.innerHTML = `
                    <span class="text-sm font-bold ${isCurrentMonth && day === todayDate ? 'text-blue-600' : 'text-gray-700'}">${day}ì¼</span>
                    <button onclick="openPaymentModal(${day})" class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
                cell.appendChild(dateHeader);
                
                // í•™ìƒ ëª©ë¡ (í•´ë‹¹ ë‚ ì§œì— ë‚©ì…í•œ í•™ìƒë“¤)
                const studentList = document.createElement('div');
                studentList.className = 'space-y-1 max-h-20 overflow-y-auto';
                
                // í•´ë‹¹ ë‚ ì§œì— ë‚©ì…í•œ í•™ìƒ í•„í„°ë§
                const studentsOnThisDay = allStudents.filter(payment => {
                    if (!payment.paid_date) return false;
                    const paidDate = new Date(payment.paid_date);
                    return paidDate.getFullYear() === year && 
                           paidDate.getMonth() + 1 === month && 
                           paidDate.getDate() === day;
                });
                
                studentsOnThisDay.forEach(payment => {
                    const badge = document.createElement('div');
                    badge.className = `student-badge px-2 py-1 rounded text-white cursor-pointer ${
                        payment.status === 'paid' ? 'bg-green-500' :
                        payment.status === 'partial' ? 'bg-yellow-500' : 'bg-gray-400'
                    }`;
                    badge.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="font-medium">${payment.student_name}</span>
                            <span class="ml-1">${(payment.paid_amount || 0).toLocaleString()}ì›</span>
                        </div>
                    `;
                    badge.onclick = (e) => {
                        e.stopPropagation();
                        editPayment(payment.student_id, day);
                    };
                    studentList.appendChild(badge);
                });
                
                cell.appendChild(studentList);
                calendarBody.appendChild(cell);
            }
        }

        // ë‚©ì… ì²˜ë¦¬ ëª¨ë‹¬ ì—´ê¸°
        async function openPaymentModal(day) {
            document.getElementById('modalDay').value = day;
            document.getElementById('modalTitle').textContent = `${day}ì¼ ë‚©ì… ì²˜ë¦¬`;
            
            // í•™ìƒ ëª©ë¡ ë¡œë“œ
            try {
                const response = await fetch('/api/students', {
                    headers: getApiHeaders()
                });
                
                const data = await response.json();
                
                if (data.success && data.students) {
                    const select = document.getElementById('modalStudent');
                    select.innerHTML = '<option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    
                    data.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.name} (${student.grade || '-'})`;
                        option.dataset.classId = student.class_id;
                        option.dataset.className = student.class_name || '-';
                        option.dataset.classFee = student.class_fee || 0;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('í•™ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
            
            // í¼ ì´ˆê¸°í™”
            document.getElementById('paymentForm').classList.add('hidden');
            document.getElementById('currentStatus').classList.add('hidden');
            document.getElementById('modalPaidAmount').value = '';
            document.getElementById('modalPaymentMethod').value = '';
            document.getElementById('modalMemo').value = '';
            
            document.getElementById('paymentModal').classList.remove('hidden');
        }

        // í•™ìƒ ì„ íƒ ì‹œ
        function onStudentChange() {
            const select = document.getElementById('modalStudent');
            const option = select.options[select.selectedIndex];
            
            if (!option.value) {
                document.getElementById('paymentForm').classList.add('hidden');
                return;
            }
            
            // ë°˜ ì •ë³´ í‘œì‹œ
            document.getElementById('modalClassName').textContent = option.dataset.className;
            document.getElementById('modalClassFee').textContent = parseInt(option.dataset.classFee).toLocaleString() + 'ì›';
            document.getElementById('modalPaidAmount').value = option.dataset.classFee;
            
            // ê¸°ì¡´ ë‚©ì… ë‚´ì—­ í™•ì¸
            const studentId = option.value;
            const payment = allPayments[studentId];
            
            if (payment && payment.paid_amount > 0) {
                document.getElementById('currentStatus').classList.remove('hidden');
                document.getElementById('currentPaidAmount').textContent = payment.paid_amount.toLocaleString() + 'ì›';
                document.getElementById('currentPaidDate').textContent = payment.paid_date || '-';
            } else {
                document.getElementById('currentStatus').classList.add('hidden');
            }
            
            document.getElementById('paymentForm').classList.remove('hidden');
        }

        // ë‚©ì… ì €ì¥
        async function savePayment() {
            const studentId = document.getElementById('modalStudent').value;
            const paidAmount = parseInt(document.getElementById('modalPaidAmount').value);
            const paymentMethod = document.getElementById('modalPaymentMethod').value;
            const memo = document.getElementById('modalMemo').value;
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            
            if (!studentId) {
                alert('í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!paidAmount) {
                alert('ë‚©ì…ì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('/api/tuition/mark-paid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getApiHeaders()
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        year: parseInt(year),
                        month: parseInt(month),
                        paid_amount: paidAmount,
                        payment_method: paymentMethod,
                        memo: memo
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('ë‚©ì… ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closePaymentModal();
                    loadCalendar();
                } else {
                    alert(data.error || 'ë‚©ì… ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë‚©ì… ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ë‚©ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë‚©ì… ìˆ˜ì •
        function editPayment(studentId, day) {
            openPaymentModal(day);
            
            // í•™ìƒ ìë™ ì„ íƒ
            setTimeout(() => {
                document.getElementById('modalStudent').value = studentId;
                onStudentChange();
                
                const payment = allPayments[studentId];
                if (payment) {
                    document.getElementById('modalPaidAmount').value = payment.paid_amount || 0;
                    document.getElementById('modalPaymentMethod').value = payment.payment_method || '';
                    document.getElementById('modalMemo').value = payment.memo || '';
                }
            }, 100);
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
        }

        // ë°˜ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
        async function showClassManagement() {
            document.getElementById('classManagementModal').classList.remove('hidden');
            loadClasses();
        }

        // ë°˜ ëª©ë¡ ë¡œë“œ
        async function loadClasses() {
            const classList = document.getElementById('classList');
            classList.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-500"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>ë¡œë”© ì¤‘...</td></tr>';
            
            try {
                const response = await fetch('/api/tuition/classes', {
                    headers: getApiHeaders()
                });
                
                const data = await response.json();
                
                if (!data.success || !data.classes || data.classes.length === 0) {
                    classList.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-gray-500"><i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i><div>ë“±ë¡ëœ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤</div></td></tr>';
                    return;
                }
                
                classList.innerHTML = data.classes.map(cls => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${cls.name}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${cls.teacher_name || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${cls.student_count || 0}ëª…</td>
                        <td class="px-6 py-4">
                            <input type="number" 
                                   id="classFee${cls.id}" 
                                   value="${cls.monthly_fee || 0}" 
                                   class="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                   placeholder="ê¸ˆì•¡">
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="updateClassFee(${cls.id})" class="px-3 py-1 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
                                <i class="fas fa-save mr-1"></i>ì €ì¥
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('ë°˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                classList.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-red-500"><i class="fas fa-exclamation-circle text-4xl mb-4"></i><div>ë°˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div></td></tr>';
            }
        }

        // ë°˜ êµìœ¡ë¹„ ì—…ë°ì´íŠ¸
        async function updateClassFee(classId) {
            const fee = parseInt(document.getElementById(`classFee${classId}`).value);
            
            if (isNaN(fee) || fee < 0) {
                alert('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch(`/api/tuition/classes/${classId}/fee`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getApiHeaders()
                    },
                    body: JSON.stringify({ monthly_fee: fee })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('ë°˜ êµìœ¡ë¹„ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadClasses();
                } else {
                    alert(data.error || 'êµìœ¡ë¹„ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('êµìœ¡ë¹„ ì„¤ì • ì‹¤íŒ¨:', error);
                alert('êµìœ¡ë¹„ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë°˜ ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeClassManagement() {
            document.getElementById('classManagementModal').classList.add('hidden');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', function() {
            currentUser = checkAuth();
            if (!currentUser) return;
            
            initYearFilter();
            initMonthFilter();
            loadCalendar();
        });
    </script>
</body>
</html>
