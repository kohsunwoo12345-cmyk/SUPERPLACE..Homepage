
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ëª©ë¡ - ê¾¸ë©”ë•…í•™ì›</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="/students" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-2"></i>ëŒì•„ê°€ê¸°
                    </a>
                    <h1 class="text-2xl font-bold text-gray-900">ğŸ‘¨â€ğŸ“ í•™ìƒ ëª©ë¡</h1>
                </div>
                <button onclick="showAddModal()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                    <i class="fas fa-user-plus mr-2"></i>ìƒˆ í•™ìƒ ë“±ë¡
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- í•„í„° ë° ê²€ìƒ‰ -->
        <div class="bg-white rounded-xl shadow p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë°˜ í•„í„°</label>
                    <select id="classFilter" onchange="loadStudents()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">ì „ì²´ í•™ìƒ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">í•™ë…„ í•„í„°</label>
                    <select id="gradeFilter" onchange="filterStudents()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">ì „ì²´ í•™ë…„</option>
                        <option value="ì´ˆ1">ì´ˆ1</option>
                        <option value="ì´ˆ2">ì´ˆ2</option>
                        <option value="ì´ˆ3">ì´ˆ3</option>
                        <option value="ì´ˆ4">ì´ˆ4</option>
                        <option value="ì´ˆ5">ì´ˆ5</option>
                        <option value="ì´ˆ6">ì´ˆ6</option>
                        <option value="ì¤‘1">ì¤‘1</option>
                        <option value="ì¤‘2">ì¤‘2</option>
                        <option value="ì¤‘3">ì¤‘3</option>
                        <option value="ê³ 1">ê³ 1</option>
                        <option value="ê³ 2">ê³ 2</option>
                        <option value="ê³ 3">ê³ 3</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê²€ìƒ‰</label>
                    <input type="text" id="searchInput" oninput="filterStudents()" placeholder="ì´ë¦„, í•™ë¶€ëª¨ ì´ë¦„, ì „í™”ë²ˆí˜¸..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                </div>
            </div>
        </div>

        <!-- í•™ìƒ ëª©ë¡ -->
        <div id="studentsList" class="space-y-4">
            <div class="text-center text-gray-500 py-8">ë¡œë”© ì¤‘...</div>
        </div>
    </div>

    <!-- í•™ìƒ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="studentModal" class="hidden fixed inset-0 z-50">
        <div class="fixed inset-0 bg-black bg-opacity-50" onclick="hideModal()"></div>
        <div class="fixed inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] flex flex-col pointer-events-auto">
                <h2 id="modalTitle" class="text-2xl font-bold px-8 pt-8 pb-4 border-b bg-white">ìƒˆ í•™ìƒ ë“±ë¡</h2>
                <div class="overflow-y-auto px-8 py-6 flex-1">
                <form id="studentForm">
                    <input type="hidden" id="studentId">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- í•™ìƒ ê¸°ë³¸ ì •ë³´ -->
                        <div class="col-span-2 border-b pb-4 mb-2">
                            <h3 class="text-lg font-semibold text-gray-800">ğŸ“‹ í•™ìƒ ì •ë³´</h3>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í•™ìƒ ì´ë¦„ *</label>
                            <input type="text" id="studentName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="í™ê¸¸ë™">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í•™ìƒ ì—°ë½ì²˜</label>
                            <input type="tel" id="studentPhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="010-1234-5678" maxlength="13">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í•™êµ</label>
                            <input type="text" id="studentSchool" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë°˜ ë°°ì • (ìµœëŒ€ 3ê°œ)</label>
                            <div id="classCheckboxes" class="space-y-2 p-3 border border-gray-300 rounded-lg max-h-48 overflow-y-auto bg-white">
                                <!-- ë°˜ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                            </div>
                            <input type="hidden" id="studentClasses">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í•™ë…„ *</label>
                            <select id="studentGrade" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="ì´ˆ1">ì´ˆ1</option>
                                <option value="ì´ˆ2">ì´ˆ2</option>
                                <option value="ì´ˆ3">ì´ˆ3</option>
                                <option value="ì´ˆ4">ì´ˆ4</option>
                                <option value="ì´ˆ5">ì´ˆ5</option>
                                <option value="ì´ˆ6">ì´ˆ6</option>
                                <option value="ì¤‘1">ì¤‘1</option>
                                <option value="ì¤‘2">ì¤‘2</option>
                                <option value="ì¤‘3">ì¤‘3</option>
                                <option value="ê³ 1">ê³ 1</option>
                                <option value="ê³ 2">ê³ 2</option>
                                <option value="ê³ 3">ê³ 3</option>
                            </select>
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìˆ˜ê°• ê³¼ëª© *</label>
                            <div id="subjectsCheckboxes" class="grid grid-cols-2 gap-2 p-3 border border-gray-300 rounded-lg">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="subject" value="ì˜ì–´" class="w-4 h-4 text-blue-600 cursor-pointer">
                                    <span class="text-sm">ì˜ì–´</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="subject" value="ìˆ˜í•™" class="w-4 h-4 text-blue-600 cursor-pointer">
                                    <span class="text-sm">ìˆ˜í•™</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="subject" value="ê³¼í•™" class="w-4 h-4 text-blue-600 cursor-pointer">
                                    <span class="text-sm">ê³¼í•™</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="subject" value="êµ­ì–´" class="w-4 h-4 text-blue-600 cursor-pointer">
                                    <span class="text-sm">êµ­ì–´</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="subject" value="í”„ë¡œê·¸ë¨1" class="w-4 h-4 text-blue-600 cursor-pointer">
                                    <span class="text-sm">í”„ë¡œê·¸ë¨1</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="subject" value="í”„ë¡œê·¸ë¨2" class="w-4 h-4 text-blue-600 cursor-pointer">
                                    <span class="text-sm">í”„ë¡œê·¸ë¨2</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="subject" value="í”„ë¡œê·¸ë¨3" class="w-4 h-4 text-blue-600 cursor-pointer">
                                    <span class="text-sm">í”„ë¡œê·¸ë¨3</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="subject" value="í”„ë¡œê·¸ë¨4" class="w-4 h-4 text-blue-600 cursor-pointer">
                                    <span class="text-sm">í”„ë¡œê·¸ë¨4</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="subject" value="í”„ë¡œê·¸ë¨5" class="w-4 h-4 text-blue-600 cursor-pointer">
                                    <span class="text-sm">í”„ë¡œê·¸ë¨5</span>
                                </label>
                            </div>
                            <input type="hidden" id="studentSubjects" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë“±ë¡ì¼ *</label>
                            <input type="date" id="enrollmentDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <!-- í•™ë¶€ëª¨ ì •ë³´ -->
                        <div class="col-span-2 border-b pb-4 mb-2 mt-4">
                            <h3 class="text-lg font-semibold text-gray-800">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ í•™ë¶€ëª¨ ì •ë³´</h3>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í•™ë¶€ëª¨ ì´ë¦„ *</label>
                            <input type="text" id="parentName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="í™ê¸¸ë™">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í•™ë¶€ëª¨ ì—°ë½ì²˜ *</label>
                            <input type="tel" id="parentPhone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="010-1234-5678" maxlength="13">
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë©”ëª¨</label>
                            <textarea id="studentMemo" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="íŠ¹ì´ì‚¬í•­ì´ë‚˜ ê¸°íƒ€ ë©”ëª¨"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 mt-6">
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">
                            ì €ì¥
                        </button>
                        <button type="button" onclick="hideModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const userStr = localStorage.getItem('user');
        if (!userStr) {
            alert('âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\\n\\ní•™ìƒ ëª©ë¡ì„ ë³´ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = '/login';
            throw new Error('Not logged in');
        }
        const currentUser = JSON.parse(userStr);
        const academyId = currentUser.id;
        console.log('ğŸ‘¤ Current User:', currentUser);
        console.log('ğŸ« Academy ID:', academyId);
        let students = [];
        let allStudents = [];
        let classes = [];

        // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ… í•¨ìˆ˜
        function formatPhoneNumber(value) {
            // ìˆ«ìë§Œ ì¶”ì¶œ
            const numbers = value.replace(/[^0-9]/g, '');
            
            // 010-1234-5678 í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            if (numbers.length <= 3) {
                return numbers;
            } else if (numbers.length <= 7) {
                return numbers.slice(0, 3) + '-' + numbers.slice(3);
            } else if (numbers.length <= 11) {
                return numbers.slice(0, 3) + '-' + numbers.slice(3, 7) + '-' + numbers.slice(7);
            } else {
                // 11ìë¦¬ ë„˜ì–´ê°€ë©´ ìë¥´ê¸°
                return numbers.slice(0, 3) + '-' + numbers.slice(3, 7) + '-' + numbers.slice(7, 11);
            }
        }

        async function loadClasses() {
            try {
                const userDataHeader = btoa(unescape(encodeURIComponent(JSON.stringify(currentUser))));
                const res = await fetch('/api/classes', {
                    headers: {
                        'X-User-Data-Base64': userDataHeader
                    }
                });
                const data = await res.json();
                if (data.success) {
                    classes = data.classes;
                    
                    // ë°˜ í•„í„° ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
                    const classFilter = document.getElementById('classFilter');
                    classFilter.innerHTML = '<option value="">ì „ì²´ í•™ìƒ</option>' +
                        classes.map(c => \`<option value="\${c.id}">\${c.class_name}</option>\`).join('');
                    
                    // ë°˜ ë°°ì • ì²´í¬ë°•ìŠ¤ ì±„ìš°ê¸°
                    const classCheckboxes = document.getElementById('classCheckboxes');
                    classCheckboxes.innerHTML = classes.map(c => \`
                        <label class="flex items-center space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer">
                            <input type="checkbox" name="classCheckbox" value="\${c.id}" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
                            <span class="text-sm">\${c.class_name}</span>
                        </label>
                    \`).join('');
                    
                    // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìµœëŒ€ 3ê°œ ì œí•œ)
                    document.querySelectorAll('input[name="classCheckbox"]').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const checkedCount = document.querySelectorAll('input[name="classCheckbox"]:checked').length;
                            if (checkedCount > 3) {
                                this.checked = false;
                                alert('ë°˜ ë°°ì •ì€ ìµœëŒ€ 3ê°œê¹Œì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                            }
                        });
                    });
                    
                    // URL íŒŒë¼ë¯¸í„°ì—ì„œ classId í™•ì¸
                    const urlParams = new URLSearchParams(window.location.search);
                    const classId = urlParams.get('classId');
                    if (classId) {
                        classFilter.value = classId;
                    }
                }
            } catch (error) {
                console.error('ë°˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }

        async function loadStudents() {
            try {
                // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                let currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                
                // user_typeì´ ì—†ìœ¼ë©´ role ì‚¬ìš© (í•˜ìœ„ í˜¸í™˜ì„±)
                if (!currentUser.user_type && currentUser.role) {
                    currentUser.user_type = currentUser.role;
                }
                
                // ì„ ìƒë‹˜ì¸ë° permissionsê°€ ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ ì¡°íšŒ
                if ((currentUser.user_type === 'teacher' || currentUser.role === 'teacher') && !currentUser.permissions) {
                    console.log('âš ï¸ Teacher without permissions detected, fetching...');
                    
                    try {
                        const directorId = currentUser.parent_user_id || 1;
                        const permRes = await fetch(\`/api/teachers/\${currentUser.id}/permissions?directorId=\${directorId}\`);
                        const permData = await permRes.json();
                        
                        if (permData.success && permData.permissions) {
                            currentUser.permissions = permData.permissions;
                            localStorage.setItem('user', JSON.stringify(currentUser));
                            console.log('âœ… Permissions loaded and saved:', currentUser.permissions);
                        } else {
                            currentUser.permissions = {
                                canViewAllStudents: false,
                                canWriteDailyReports: false,
                                assignedClasses: []
                            };
                            console.warn('âš ï¸ No permissions found, using restrictive defaults');
                        }
                    } catch (permError) {
                        console.error('âŒ Failed to load permissions:', permError);
                        currentUser.permissions = {
                            canViewAllStudents: false,
                            canWriteDailyReports: false,
                            assignedClasses: []
                        };
                    }
                }
                
                const userDataHeader = btoa(unescape(encodeURIComponent(JSON.stringify(currentUser))));
                
                const classId = document.getElementById('classFilter').value;
                let url = '/api/students';
                if (classId) url += '?classId=' + classId;
                
                const res = await fetch(url, {
                    headers: {
                        'X-User-Data-Base64': userDataHeader
                    }
                });
                const data = await res.json();
                if (data.success) {
                    allStudents = data.students;
                    students = allStudents;
                    filterStudents();
                }
            } catch (error) {
                console.error('í•™ìƒ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }

        function filterStudents() {
            const gradeFilter = document.getElementById('gradeFilter').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            students = allStudents.filter(student => {
                // current_grade ë˜ëŠ” grade ì‚¬ìš©
                const displayGrade = student.current_grade || student.grade;
                const matchGrade = !gradeFilter || displayGrade === gradeFilter;
                const matchSearch = !searchText || 
                    student.name.toLowerCase().includes(searchText) ||
                    (student.parent_name && student.parent_name.toLowerCase().includes(searchText)) ||
                    (student.phone && student.phone.includes(searchText)) ||
                    (student.parent_phone && student.parent_phone.includes(searchText));
                
                return matchGrade && matchSearch;
            });
            
            renderStudents();
        }

        function renderStudents() {
            const container = document.getElementById('studentsList');
            if (students.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-12 bg-white rounded-xl">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆ í•™ìƒì„ ë“±ë¡í•´ë³´ì„¸ìš”!</div>';
                return;
            }

            container.innerHTML = students.map(student => \`
                <div class="bg-white rounded-xl shadow p-6 hover:shadow-lg transition">
                    <div class="flex justify-between items-start">
                        <div class="flex items-start space-x-4 flex-1">
                            <div class="bg-blue-100 text-blue-600 rounded-full w-14 h-14 flex items-center justify-center text-xl font-bold flex-shrink-0">
                                \${student.name.charAt(0)}
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <h3 class="text-xl font-bold text-gray-900">\${student.name}</h3>
                                    <span class="px-3 py-1 bg-blue-100 text-blue-600 rounded-full text-sm font-medium">
                                        \${student.current_grade || student.grade}
                                        \${student.current_grade && student.current_grade !== student.entry_grade ? '<i class="fas fa-arrow-up ml-1 text-xs"></i>' : ''}
                                    </span>
                                    \${student.entry_grade && student.current_grade && student.current_grade !== student.entry_grade ? \`<span class="text-xs text-gray-400">(\${student.entry_grade}â†’\${student.current_grade})</span>\` : ''}
                                    \${student.class_name ? \`<span class="px-3 py-1 bg-purple-100 text-purple-600 rounded-full text-sm">\${student.class_name}</span>\` : ''}
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-600">
                                    <div><i class="fas fa-phone mr-2"></i>í•™ìƒ: \${student.phone || 'ë¯¸ë“±ë¡'}</div>
                                    <div><i class="fas fa-book mr-2"></i>\${student.subjects}</div>
                                    <div><i class="fas fa-user mr-2"></i>í•™ë¶€ëª¨: \${student.parent_name}</div>
                                    <div><i class="fas fa-mobile-alt mr-2"></i>\${student.parent_phone}</div>
                                </div>
                                \${student.notes ? \`<div class="mt-2 text-sm text-gray-500"><i class="fas fa-sticky-note mr-2"></i>\${student.notes}</div>\` : ''}
                            </div>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <a href="/students/detail/\${student.id}" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                <i class="fas fa-chart-line mr-1"></i>ìƒì„¸
                            </a>
                            <button onclick="editStudent(\${student.id})" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteStudent(\${student.id}, '\${student.name}')" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            \`).join('');
        }

        async function showAddModal() {
            document.getElementById('modalTitle').textContent = 'ìƒˆ í•™ìƒ ë“±ë¡';
            document.getElementById('studentForm').reset();
            document.getElementById('studentId').value = '';
            document.getElementById('enrollmentDate').valueAsDate = new Date();
            
            // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
            document.querySelectorAll('input[name="subject"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="classCheckbox"]').forEach(cb => cb.checked = false);
            
            // ìµœì‹  ë°˜ ëª©ë¡ ë¡œë“œ
            await loadClasses();
            
            const modal = document.getElementById('studentModal');
            modal.classList.remove('hidden');
            
            // ëª¨ë‹¬ ì»¨í…ì¸ ë¥¼ ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤
            setTimeout(() => {
                const scrollableContent = modal.querySelector('.overflow-y-auto');
                if (scrollableContent) {
                    scrollableContent.scrollTop = 0;
                }
            }, 10);
        }

        function hideModal() {
            document.getElementById('studentModal').classList.add('hidden');
        }

        async function editStudent(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;

            document.getElementById('modalTitle').textContent = 'í•™ìƒ ì •ë³´ ìˆ˜ì •';
            document.getElementById('studentId').value = student.id;
            document.getElementById('studentName').value = student.name;
            document.getElementById('studentPhone').value = student.phone || '';
            document.getElementById('studentSchool').value = student.school || '';
            document.getElementById('studentGrade').value = student.grade;
            document.getElementById('enrollmentDate').value = student.enrollment_date;
            document.getElementById('parentName').value = student.parent_name;
            document.getElementById('parentPhone').value = student.parent_phone;
            document.getElementById('studentMemo').value = student.notes || '';
            
            // ìµœì‹  ë°˜ ëª©ë¡ ë¡œë“œ
            await loadClasses();
            
            // ë°˜ ë°°ì • ì²´í¬ë°•ìŠ¤ ì„¤ì •
            document.querySelectorAll('input[name="classCheckbox"]').forEach(cb => cb.checked = false);
            if (student.class_id) {
                // class_idê°€ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ì¼ ìˆ˜ ìˆìŒ
                const classIds = String(student.class_id).split(',').map(id => id.trim());
                classIds.forEach(classId => {
                    const checkbox = document.querySelector(\`input[name="classCheckbox"][value="\${classId}"]\`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™” í›„ ì„ íƒëœ ê³¼ëª© ì²´í¬
            document.querySelectorAll('input[name="subject"]').forEach(cb => cb.checked = false);
            const subjects = student.subjects.split(',').map(s => s.trim());
            subjects.forEach(subject => {
                const checkbox = document.querySelector(\`input[name="subject"][value="\${subject}"]\`);
                if (checkbox) checkbox.checked = true;
            });
            
            const modal = document.getElementById('studentModal');
            modal.classList.remove('hidden');
            
            // ëª¨ë‹¬ ì»¨í…ì¸ ë¥¼ ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤
            setTimeout(() => {
                const scrollableContent = modal.querySelector('.overflow-y-auto');
                if (scrollableContent) {
                    scrollableContent.scrollTop = 0;
                }
            }, 10);
        }

        async function deleteStudent(studentId, studentName) {
            if (!confirm(\`"\${studentName}" í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\nâš ï¸ ëª¨ë“  ì„±ê³¼ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.\`)) return;

            try {
                console.log('ğŸ—‘ï¸ [DeleteStudent] Starting deletion');
                console.log('ğŸ—‘ï¸ [DeleteStudent] Student ID:', studentId);
                console.log('ğŸ—‘ï¸ [DeleteStudent] Student Name:', studentName);
                console.log('ğŸ—‘ï¸ [DeleteStudent] Current User:', currentUser);
                console.log('ğŸ—‘ï¸ [DeleteStudent] Academy ID:', academyId);
                
                // currentUser ê°ì²´ ê²€ì¦
                if (!currentUser) {
                    alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    window.location.href = '/login';
                    return;
                }
                
                if (!currentUser.id && !currentUser.academy_id) {
                    alert('ì‚¬ìš©ì IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    window.location.href = '/login';
                    return;
                }
                
                // Base64 ì¸ì½”ë”© - ë‹¤ë¥¸ APIì™€ ë™ì¼í•œ ë°©ì‹ ì‚¬ìš©
                const userDataHeader = btoa(unescape(encodeURIComponent(JSON.stringify(currentUser))));
                console.log('ğŸ—‘ï¸ [DeleteStudent] User Data Header length:', userDataHeader.length);
                console.log('ğŸ—‘ï¸ [DeleteStudent] First 50 chars:', userDataHeader.substring(0, 50));
                
                const res = await fetch('/api/students/' + studentId, { 
                    method: 'DELETE',
                    headers: {
                        'X-User-Data-Base64': userDataHeader
                    }
                });
                
                console.log('ğŸ—‘ï¸ [DeleteStudent] Response status:', res.status);
                console.log('ğŸ—‘ï¸ [DeleteStudent] Response headers:', Array.from(res.headers.entries()));
                
                const responseText = await res.text();
                console.log('ğŸ—‘ï¸ [DeleteStudent] Response text:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('ğŸ—‘ï¸ [DeleteStudent] Failed to parse response:', e);
                    alert('ì„œë²„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ' + responseText);
                    return;
                }
                
                console.log('ğŸ—‘ï¸ [DeleteStudent] Response data:', data);
                
                if (data.success) {
                    alert('í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadStudents();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.error + (data.details ? '\\nìƒì„¸: ' + data.details : ''));
                }
            } catch (error) {
                console.error('ğŸ—‘ï¸ [DeleteStudent] Error:', error);
                console.error('ğŸ—‘ï¸ [DeleteStudent] Error stack:', error.stack);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì „í™”ë²ˆí˜¸ ì…ë ¥ í•„ë“œì— í¬ë§·íŒ… ì ìš©
        document.getElementById('studentPhone').addEventListener('input', function(e) {
            e.target.value = formatPhoneNumber(e.target.value);
        });
        
        document.getElementById('parentPhone').addEventListener('input', function(e) {
            e.target.value = formatPhoneNumber(e.target.value);
        });

        document.getElementById('studentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ì²´í¬ë°•ìŠ¤ì—ì„œ ì„ íƒëœ ê³¼ëª© ìˆ˜ì§‘
            const selectedSubjects = Array.from(document.querySelectorAll('input[name="subject"]:checked'))
                .map(cb => cb.value);
            
            if (selectedSubjects.length === 0) {
                alert('ìˆ˜ê°• ê³¼ëª©ì„ ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì²´í¬ë°•ìŠ¤ì—ì„œ ì„ íƒëœ ë°˜ ìˆ˜ì§‘
            const selectedClasses = Array.from(document.querySelectorAll('input[name="classCheckbox"]:checked'))
                .map(cb => cb.value);
            
            const studentId = document.getElementById('studentId').value;
            const payload = {
                academyId,
                classId: selectedClasses.length > 0 ? selectedClasses.join(',') : null,
                name: document.getElementById('studentName').value,
                phone: document.getElementById('studentPhone').value,
                school: document.getElementById('studentSchool').value,
                parentName: document.getElementById('parentName').value,
                parentPhone: document.getElementById('parentPhone').value,
                grade: document.getElementById('studentGrade').value,
                subjects: selectedSubjects.join(', '),
                enrollmentDate: document.getElementById('enrollmentDate').value,
                memo: document.getElementById('studentMemo').value
            };

            try {
                const url = studentId ? '/api/students/' + studentId : '/api/students';
                const method = studentId ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (data.success) {
                    alert(studentId ? 'í•™ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒˆ í•™ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    hideModal();
                    loadStudents();
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + data.error);
                }
            } catch (error) {
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        });

        // ì´ˆê¸° ë¡œë“œ
        (async () => {
            await loadClasses();
            await loadStudents();
        })();
    </script>
</body>
</html>
