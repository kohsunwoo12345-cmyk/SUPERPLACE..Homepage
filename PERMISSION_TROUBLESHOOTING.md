# 선생님 권한 문제 해결 가이드

## 🚨 문제: "배정된 반만 공개"를 설정했는데 모든 학생이 보여요

### 원인 분석

이 문제는 다음 중 하나의 경우에 발생합니다:

1. **반을 선택하지 않고 저장한 경우**
   - "배정된 반만 공개" 라디오 버튼을 선택했지만
   - 아래의 **"반 배정"** 섹션에서 실제 반을 체크하지 않고 저장
   - 결과: `assignedClasses: []` (빈 배열)로 저장됨
   - API는 빈 배열을 받으면 **모든 학생을 반환하지 않고 빈 목록**을 반환해야 하지만,
   - 사용자가 "모든 학생이 보인다"고 하는 것은 다른 문제일 수 있습니다

2. **권한이 제대로 저장되지 않은 경우**
   - 네트워크 오류
   - 서버 오류
   - LocalStorage 동기화 문제

3. **잘못된 선생님 계정으로 로그인한 경우**
   - 다른 선생님 계정으로 로그인했을 가능성
   - 해당 선생님은 "모두 다 공개" 권한을 가지고 있을 수 있음

---

## ✅ 해결 방법

### 1단계: 권한 재설정

1. **원장님 계정으로 로그인**
   - 이메일: `kumetang@gmail.com`
   - 비밀번호: `1234`

2. **선생님 관리 페이지로 이동**
   - https://superplace-academy.pages.dev/students
   - 또는 https://superplace-academy.pages.dev/teachers

3. **해당 선생님의 권한 설정 버튼 클릭**

4. **"배정된 반만 공개" 선택**
   - ○ 모두 다 공개 ← 선택 안 함
   - ● 배정된 반만 공개 ← **이것을 선택**

5. **⚠️ 중요: 아래의 "반 배정" 섹션에서 반드시 1개 이상의 반을 체크**
   ```
   반 배정
   ☑ 1반 (초등 3학년)
   ☐ 2반 (초등 4학년)
   ☐ 3반 (초등 5학년)
   ```
   - **최소 1개는 반드시 체크해야 합니다!**

6. **저장 버튼 클릭**
   - 저장 후 **상세한 확인 메시지**가 나타납니다:
   ```
   ✅ 홍길동 선생님의 권한이 저장되었습니다!

   📌 권한: 배정된 반만 공개
   • 배정된 반: 1개
   • 배정된 반의 학생만 조회
   • 배정된 반의 일일 성과만 작성
   ```

7. **확인 메시지를 꼭 읽어보세요!**
   - "⚠️ 배정된 반 없음"이 나오면 다시 설정하세요

---

### 2단계: 선생님 계정으로 확인

1. **선생님 계정으로 로그아웃/로그인**
   - 기존 세션을 종료하고 다시 로그인

2. **/students/list 페이지로 이동**
   - https://superplace-academy.pages.dev/students/list

3. **학생 목록 확인**
   - 배정된 반의 학생만 표시되어야 합니다
   - 다른 반의 학생은 보이지 않아야 합니다

---

### 3단계: 디버깅 (문제가 계속되는 경우)

1. **브라우저 개발자 도구 열기** (F12)

2. **Console 탭에서 로그 확인**
   ```javascript
   // 다음 로그를 찾아보세요:
   👥 [GetStudents] Assigned classes: [1, 2, 3]
   👥 [GetStudents] Query: SELECT * FROM students WHERE ... AND class_id IN (?,?,?)
   ```

3. **Network 탭에서 API 호출 확인**
   - `/api/students` 요청을 찾아보세요
   - Response를 확인하여 반환된 학생 수를 확인

4. **디버그 API 호출** (고급)
   - 브라우저 Console에서 다음 코드 실행:
   ```javascript
   const user = JSON.parse(localStorage.getItem('user'));
   const userDataBase64 = btoa(unescape(encodeURIComponent(JSON.stringify(user))));
   
   fetch('/api/debug/my-permissions', {
     headers: { 'X-User-Data-Base64': userDataBase64 }
   })
   .then(r => r.json())
   .then(data => {
     console.log('내 권한:', data.parsedPermissions);
     console.log('저장된 원본 데이터:', data.rawRows);
   });
   ```

---

## 🔍 예상 결과

### 올바르게 설정된 경우

**원장님이 본 권한 저장 확인 메시지:**
```
✅ 홍길동 선생님의 권한이 저장되었습니다!

📌 권한: 배정된 반만 공개
• 배정된 반: 2개
• 배정된 반의 학생만 조회
• 배정된 반의 일일 성과만 작성
```

**선생님이 본 학생 목록:**
- 1반 학생: 김철수, 이영희, 박민수 (3명)
- 2반 학생: 최지우, 정다은 (2명)
- **총 5명만 표시** (다른 반 학생은 안 보임)

### 잘못 설정된 경우

**원장님이 본 권한 저장 확인 메시지:**
```
✅ 홍길동 선생님의 권한이 저장되었습니다!

📌 권한: 배정된 반만 공개
⚠️ 배정된 반 없음 - 권한 없음 상태
```
→ 이 경우 **다시 설정**해야 합니다!

**선생님이 본 학생 목록:**
- 학생이 아예 안 보이거나
- 모든 학생이 보이거나 (잘못된 상태)

---

## 📝 체크리스트

권한 설정 시 다음을 확인하세요:

- [ ] "배정된 반만 공개" 라디오 버튼을 선택했는가?
- [ ] 아래 "반 배정" 섹션이 나타났는가?
- [ ] 최소 1개 이상의 반을 체크했는가?
- [ ] 저장 버튼을 눌렀는가?
- [ ] 확인 메시지에서 "배정된 반: N개"가 표시되는가? (N > 0)
- [ ] "⚠️ 배정된 반 없음"이 나타나지 않았는가?
- [ ] 선생님 계정으로 다시 로그인했는가?

---

## 🎯 핵심 요약

**"배정된 반만 공개"를 선택할 때는 반드시:**
1. ● 배정된 반만 공개 선택
2. ☑ 아래에서 반 체크 (1개 이상)
3. 💾 저장
4. ✅ 확인 메시지에서 "배정된 반: N개" 확인 (N > 0)
5. 🔄 선생님 계정 재로그인

---

## 📞 추가 도움이 필요한 경우

문제가 계속되면:
1. 브라우저 캐시 삭제
2. 시크릿 모드로 테스트
3. 다른 브라우저로 테스트
4. 디버그 API 결과 확인 (위 3단계 참조)

---

**배포 정보:**
- 커밋: 013de22
- 날짜: 2026-01-18
- URL: https://superplace-academy.pages.dev
- 상태: ✅ 권한 검증 기능 추가됨
