<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ì¶œ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
        * { font-family: 'Pretendard Variable', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- í—¤ë” -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ“Š ë§¤ì¶œ ê´€ë¦¬</h1>
                <p class="text-gray-600">í•™ì› ë§¤ì¶œ í˜„í™©ì„ í™•ì¸í•˜ê³  ë¶„ì„í•˜ì„¸ìš”</p>
            </div>
            <a href="/dashboard" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                <i class="fas fa-arrow-left mr-2"></i> ëŒ€ì‹œë³´ë“œ
            </a>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ í†µê³„ -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ì´ë²ˆ ë‹¬ ë§¤ì¶œ</span>
                    <i class="fas fa-chart-line text-2xl opacity-80"></i>
                </div>
                <div class="text-3xl font-bold mb-1" id="thisMonthRevenue">0ì›</div>
                <div class="text-xs opacity-80" id="growthRate">ì „ì›” ëŒ€ë¹„ 0%</div>
            </div>
            
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ì˜¬í•´ ëˆ„ì  ë§¤ì¶œ</span>
                    <i class="fas fa-calendar-alt text-2xl opacity-80"></i>
                </div>
                <div class="text-3xl font-bold" id="yearlyRevenue">0ì›</div>
            </div>
            
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ì´ í•™ìƒ ìˆ˜</span>
                    <i class="fas fa-users text-2xl opacity-80"></i>
                </div>
                <div class="text-3xl font-bold" id="totalStudents">0ëª…</div>
            </div>
            
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">í‰ê·  êµìœ¡ë¹„</span>
                    <i class="fas fa-won-sign text-2xl opacity-80"></i>
                </div>
                <div class="text-3xl font-bold" id="avgFee">0ì›</div>
            </div>
        </div>

        <!-- í•„í„° ì˜ì—­ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë…„ë„</label>
                    <select id="yearFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì›”</label>
                    <select id="monthFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="1">1ì›”</option>
                        <option value="2">2ì›”</option>
                        <option value="3">3ì›”</option>
                        <option value="4">4ì›”</option>
                        <option value="5">5ì›”</option>
                        <option value="6">6ì›”</option>
                        <option value="7">7ì›”</option>
                        <option value="8">8ì›”</option>
                        <option value="9">9ì›”</option>
                        <option value="10">10ì›”</option>
                        <option value="11">11ì›”</option>
                        <option value="12">12ì›”</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="loadMonthlyRevenue()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                        <i class="fas fa-search mr-2"></i>ì¡°íšŒ
                    </button>
                </div>
            </div>
        </div>

        <!-- ì›”ë³„ ë§¤ì¶œ ìƒì„¸ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">ì›”ë³„ ë§¤ì¶œ ìƒì„¸</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="border-l-4 border-blue-500 pl-4">
                    <div class="text-sm text-gray-600 mb-1">ì‹¤ì œ ë‚©ì…ì•¡</div>
                    <div class="text-2xl font-bold text-blue-600" id="totalPaid">0ì›</div>
                </div>
                <div class="border-l-4 border-green-500 pl-4">
                    <div class="text-sm text-gray-600 mb-1">ì˜ˆìƒ ë§¤ì¶œ</div>
                    <div class="text-2xl font-bold text-green-600" id="expectedRevenue">0ì›</div>
                </div>
                <div class="border-l-4 border-red-500 pl-4">
                    <div class="text-sm text-gray-600 mb-1">ë¯¸ë‚© ê¸ˆì•¡</div>
                    <div class="text-2xl font-bold text-red-600" id="totalUnpaid">0ì›</div>
                </div>
            </div>
            <div class="mt-6 pt-6 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-600">ìˆ˜ê¸ˆë¥ </span>
                    <span class="text-lg font-bold text-gray-900" id="collectionRate">0%</span>
                </div>
                <div class="mt-2 bg-gray-200 rounded-full h-3">
                    <div id="collectionBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- ì—°ê°„ ë§¤ì¶œ ì°¨íŠ¸ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">ì—°ê°„ ë§¤ì¶œ ì¶”ì´</h2>
            <canvas id="yearlyChart" height="80"></canvas>
        </div>

        <!-- í•™ìƒë³„ ë§¤ì¶œ ê¸°ì—¬ë„ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-bold text-gray-900">í•™ìƒë³„ ë§¤ì¶œ ê¸°ì—¬ë„</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">í•™ìƒëª…</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">í•™ë…„</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ì›” êµìœ¡ë¹„</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ë‚©ì…ì•¡</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ìƒíƒœ</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ë‚©ì…ì¼</th>
                        </tr>
                    </thead>
                    <tbody id="studentList" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                ë¡œë”© ì¤‘...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let yearlyChart = null;

        // ì‚¬ìš©ì ì •ë³´ í™•ì¸ ë° ê¶Œí•œ ì²´í¬
        function checkAuth() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.id) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return null;
            }
            
            // ì„ ìƒë‹˜ì€ ì ‘ê·¼ ë¶ˆê°€
            if (user.user_type === 'teacher') {
                alert('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                window.location.href = '/dashboard';
                return null;
            }
            
            return user;
        }

        // ë…„ë„ í•„í„° ì´ˆê¸°í™”
        function initYearFilter() {
            const yearFilter = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'ë…„';
                if (year === currentYear) option.selected = true;
                yearFilter.appendChild(option);
            }
        }

        // ì›” í•„í„° ì´ˆê¸°í™”
        function initMonthFilter() {
            const monthFilter = document.getElementById('monthFilter');
            const currentMonth = new Date().getMonth() + 1;
            monthFilter.value = currentMonth;
        }

        // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
        async function loadDashboard() {
            try {
                const response = await fetch('/api/revenue/dashboard', {
                    headers: {
                        'X-User-Data-Base64': btoa(JSON.stringify(currentUser))
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.dashboard) {
                    const dash = data.dashboard;
                    document.getElementById('thisMonthRevenue').textContent = (dash.this_month_revenue || 0).toLocaleString() + 'ì›';
                    document.getElementById('yearlyRevenue').textContent = (dash.yearly_revenue || 0).toLocaleString() + 'ì›';
                    document.getElementById('totalStudents').textContent = (dash.total_students || 0) + 'ëª…';
                    document.getElementById('avgFee').textContent = (dash.avg_monthly_fee || 0).toLocaleString() + 'ì›';
                    
                    const growthRate = dash.growth_rate || 0;
                    const growthText = growthRate >= 0 
                        ? `â–² ${Math.abs(growthRate).toFixed(1)}%` 
                        : `â–¼ ${Math.abs(growthRate).toFixed(1)}%`;
                    document.getElementById('growthRate').textContent = 'ì „ì›” ëŒ€ë¹„ ' + growthText;
                }
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì›”ë³„ ë§¤ì¶œ ë¡œë“œ
        async function loadMonthlyRevenue() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            
            try {
                const response = await fetch(`/api/revenue/monthly?year=${year}&month=${month}`, {
                    headers: {
                        'X-User-Data-Base64': btoa(JSON.stringify(currentUser))
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.revenue) {
                    const rev = data.revenue;
                    document.getElementById('totalPaid').textContent = (rev.total_paid || 0).toLocaleString() + 'ì›';
                    document.getElementById('expectedRevenue').textContent = (rev.expected_revenue || 0).toLocaleString() + 'ì›';
                    document.getElementById('totalUnpaid').textContent = (rev.total_unpaid || 0).toLocaleString() + 'ì›';
                    
                    const collectionRate = rev.collection_rate || 0;
                    document.getElementById('collectionRate').textContent = collectionRate + '%';
                    document.getElementById('collectionBar').style.width = collectionRate + '%';
                }
                
                // í•™ìƒë³„ ë§¤ì¶œë„ í•¨ê»˜ ë¡œë“œ
                loadStudentRevenue(year, month);
            } catch (error) {
                console.error('ì›”ë³„ ë§¤ì¶œ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í•™ìƒë³„ ë§¤ì¶œ ë¡œë“œ
        async function loadStudentRevenue(year, month) {
            const studentList = document.getElementById('studentList');
            studentList.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>ë¡œë”© ì¤‘...</td></tr>';
            
            try {
                const response = await fetch(`/api/revenue/by-student?year=${year}&month=${month}`, {
                    headers: {
                        'X-User-Data-Base64': btoa(JSON.stringify(currentUser))
                    }
                });
                
                const data = await response.json();
                
                if (!data.success || !data.students || data.students.length === 0) {
                    studentList.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500"><i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i><div>í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div></td></tr>';
                    return;
                }
                
                studentList.innerHTML = data.students.map(student => {
                    let statusBadge = '';
                    if (student.payment_status === 'paid') {
                        statusBadge = '<span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">ì™„ë‚©</span>';
                    } else if (student.payment_status === 'partial') {
                        statusBadge = '<span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-medium">ë¶€ë¶„ë‚©</span>';
                    } else {
                        statusBadge = '<span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-medium">ë¯¸ë‚©</span>';
                    }
                    
                    return `<tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${student.student_name}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${student.grade || '-'}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${(student.monthly_fee || 0).toLocaleString()}ì›</td>
                        <td class="px-6 py-4 text-sm font-bold text-blue-600">${(student.paid_amount || 0).toLocaleString()}ì›</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${student.paid_date || '-'}</td>
                    </tr>`;
                }).join('');
            } catch (error) {
                console.error('í•™ìƒë³„ ë§¤ì¶œ ë¡œë“œ ì‹¤íŒ¨:', error);
                studentList.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-red-500"><i class="fas fa-exclamation-circle text-4xl mb-4"></i><div>í•™ìƒë³„ ë§¤ì¶œì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</div></td></tr>';
            }
        }

        // ì—°ê°„ ë§¤ì¶œ ì°¨íŠ¸ ë¡œë“œ
        async function loadYearlyChart() {
            const year = document.getElementById('yearFilter').value;
            
            try {
                const response = await fetch(`/api/revenue/yearly?year=${year}`, {
                    headers: {
                        'X-User-Data-Base64': btoa(JSON.stringify(currentUser))
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.monthly_data) {
                    const labels = data.monthly_data.map(m => m.month + 'ì›”');
                    const revenues = data.monthly_data.map(m => m.total_paid || 0);
                    
                    if (yearlyChart) {
                        yearlyChart.destroy();
                    }
                    
                    const ctx = document.getElementById('yearlyChart').getContext('2d');
                    yearlyChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'ì›”ë³„ ë§¤ì¶œ',
                                data: revenues,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.parsed.y.toLocaleString() + 'ì›';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value.toLocaleString() + 'ì›';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('ì—°ê°„ ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('DOMContentLoaded', function() {
            currentUser = checkAuth();
            if (!currentUser) return;
            
            initYearFilter();
            initMonthFilter();
            loadDashboard();
            loadMonthlyRevenue();
            loadYearlyChart();
        });
    </script>
</body>
</html>
