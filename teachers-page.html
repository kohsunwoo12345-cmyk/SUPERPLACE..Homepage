app.get('/teachers', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ì„ ìƒë‹˜ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <style>
            @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
            * { font-family: 'Pretendard Variable', sans-serif; }
        </style>
    </head>
    <body class="bg-gray-50">
        <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <h1 class="text-xl font-bold text-gray-900">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ê´€ë¦¬</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/dashboard" class="text-gray-600 hover:text-gray-900">
                            <i class="fas fa-home mr-2"></i>ëŒ€ì‹œë³´ë“œ
                        </a>
                        <a href="/students" class="text-gray-600 hover:text-gray-900">
                            <i class="fas fa-user-graduate mr-2"></i>í•™ìƒ ê´€ë¦¬
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">ì „ì²´ ì„ ìƒë‹˜</p>
                            <p class="text-3xl font-bold text-gray-900" id="totalTeachers">0</p>
                        </div>
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-chalkboard-teacher text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">ë°˜ ë°°ì • ì™„ë£Œ</p>
                            <p class="text-3xl font-bold text-gray-900" id="assignedTeachers">0</p>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 mb-1">ë¯¸ë°°ì •</p>
                            <p class="text-3xl font-bold text-gray-900" id="unassignedTeachers">0</p>
                        </div>
                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <i class="fas fa-exclamation-circle text-yellow-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì„ ìƒë‹˜ ì¶”ê°€ ë²„íŠ¼ -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">ì„ ìƒë‹˜ ëª©ë¡</h2>
                <button onclick="openAddTeacherModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-medium flex items-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span>ì„ ìƒë‹˜ ì¶”ê°€</span>
                </button>
            </div>

            <!-- ì„ ìƒë‹˜ ëª©ë¡ í…Œì´ë¸” -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ì´ë¦„</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ì´ë©”ì¼</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ì „í™”ë²ˆí˜¸</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ë‹´ë‹¹ ë°˜</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">í•™ìƒ ìˆ˜</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-900">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="teachersList" class="divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600 mx-auto mb-4"></div>
                                ë¡œë”© ì¤‘...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ì„ ìƒë‹˜ ì¶”ê°€ ëª¨ë‹¬ -->
        <div id="addTeacherModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 my-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ì¶”ê°€</h3>
                    <button onclick="closeAddTeacherModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„ *</label>
                        <input type="text" id="teacherName" placeholder="í™ê¸¸ë™" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼ *</label>
                        <input type="email" id="teacherEmail" placeholder="teacher@example.com" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì „í™”ë²ˆí˜¸</label>
                        <input type="tel" id="teacherPhone" placeholder="010-1234-5678" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë‹´ë‹¹ ë°˜</label>
                        <input type="text" id="teacherClass" placeholder="ì˜ˆ: ì´ˆë“± 3í•™ë…„ Aë°˜" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button onclick="closeAddTeacherModal()" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
                            ì·¨ì†Œ
                        </button>
                        <button onclick="submitAddTeacher()" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                            ì¶”ê°€í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë°˜ ë°°ì • ëª¨ë‹¬ -->
        <div id="assignClassModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto">
            <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 my-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">ğŸ“š ë°˜ ë°°ì •</h3>
                    <button onclick="closeAssignClassModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <p class="text-gray-600">ì„ ìƒë‹˜: <span id="assignTeacherName" class="font-bold text-gray-900"></span></p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë‹´ë‹¹ ë°˜ *</label>
                        <input type="text" id="assignClassName" placeholder="ì˜ˆ: ì´ˆë“± 3í•™ë…„ Aë°˜" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <p class="text-xs text-gray-500 mt-1">í•™ë…„ê³¼ ë°˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button onclick="closeAssignClassModal()" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium">
                            ì·¨ì†Œ
                        </button>
                        <button onclick="submitAssignClass()" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                            ë°°ì •í•˜ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let currentTeacherId = null;

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
            window.addEventListener('DOMContentLoaded', () => {
                loadTeachers();
            });

            async function loadTeachers() {
                const user = JSON.parse(localStorage.getItem('user'));
                if (!user || !user.id) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/';
                    return;
                }

                try {
                    const response = await fetch('/api/teachers?userId=' + user.id);
                    const data = await response.json();

                    const teachersList = document.getElementById('teachersList');
                    
                    if (!data.success || !data.teachers || data.teachers.length === 0) {
                        teachersList.innerHTML = '<tr><td colspan="6" class="px-6 py-12 text-center text-gray-500"><i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i><div>ë“±ë¡ëœ ì„ ìƒë‹˜ì´ ì—†ìŠµë‹ˆë‹¤</div></td></tr>';
                        updateStats(0, 0, 0);
                        return;
                    }

                    let assignedCount = 0;
                    let unassignedCount = 0;

                    teachersList.innerHTML = data.teachers.map(teacher => {
                        const hasClass = teacher.assigned_class && teacher.assigned_class.trim() !== '';
                        if (hasClass) assignedCount++;
                        else unassignedCount++;

                        return '<tr class="hover:bg-gray-50">' +
                            '<td class="px-6 py-4"><span class="font-medium text-gray-900">' + (teacher.name || '-') + '</span></td>' +
                            '<td class="px-6 py-4"><span class="text-gray-600">' + (teacher.email || '-') + '</span></td>' +
                            '<td class="px-6 py-4"><span class="text-gray-600">' + (teacher.phone || '-') + '</span></td>' +
                            '<td class="px-6 py-4">' + 
                                (hasClass 
                                    ? '<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">' + teacher.assigned_class + '</span>'
                                    : '<span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm">ë¯¸ë°°ì •</span>'
                                ) +
                            '</td>' +
                            '<td class="px-6 py-4"><span class="text-gray-900 font-medium">' + (teacher.student_count || 0) + 'ëª…</span></td>' +
                            '<td class="px-6 py-4">' +
                                '<div class="flex gap-2">' +
                                    '<button onclick="openAssignClass(' + teacher.id + ', \'' + (teacher.name || '').replace(/'/g, "\\'") + '\', \'' + (teacher.assigned_class || '').replace(/'/g, "\\'") + '\')" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">' +
                                        '<i class="fas fa-edit mr-1"></i>ë°˜ ë°°ì •' +
                                    '</button>' +
                                    '<button onclick="deleteTeacher(' + teacher.id + ', \'' + (teacher.name || '').replace(/'/g, "\\'") + '\')" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">' +
                                        '<i class="fas fa-trash mr-1"></i>ì‚­ì œ' +
                                    '</button>' +
                                '</div>' +
                            '</td>' +
                        '</tr>';
                    }).join('');

                    updateStats(data.teachers.length, assignedCount, unassignedCount);
                } catch (error) {
                    console.error('ì„ ìƒë‹˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    document.getElementById('teachersList').innerHTML = 
                        '<tr><td colspan="6" class="px-6 py-12 text-center text-red-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤</td></tr>';
                }
            }

            function updateStats(total, assigned, unassigned) {
                document.getElementById('totalTeachers').textContent = total;
                document.getElementById('assignedTeachers').textContent = assigned;
                document.getElementById('unassignedTeachers').textContent = unassigned;
            }

            function openAddTeacherModal() {
                document.getElementById('addTeacherModal').classList.remove('hidden');
            }

            function closeAddTeacherModal() {
                document.getElementById('addTeacherModal').classList.add('hidden');
                document.getElementById('teacherName').value = '';
                document.getElementById('teacherEmail').value = '';
                document.getElementById('teacherPhone').value = '';
                document.getElementById('teacherClass').value = '';
            }

            async function submitAddTeacher() {
                const name = document.getElementById('teacherName').value.trim();
                const email = document.getElementById('teacherEmail').value.trim();
                const phone = document.getElementById('teacherPhone').value.trim();
                const assignedClass = document.getElementById('teacherClass').value.trim();

                if (!name || !email) {
                    alert('ì´ë¦„ê³¼ ì´ë©”ì¼ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.');
                    return;
                }

                const user = JSON.parse(localStorage.getItem('user'));

                try {
                    const response = await fetch('/api/teachers/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name,
                            email,
                            phone,
                            assigned_class: assignedClass,
                            user_id: user.id
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert('ì„ ìƒë‹˜ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        closeAddTeacherModal();
                        loadTeachers();
                    } else {
                        alert('ì˜¤ë¥˜: ' + (data.error || 'ì„ ìƒë‹˜ ì¶”ê°€ ì‹¤íŒ¨'));
                    }
                } catch (error) {
                    console.error('ì„ ìƒë‹˜ ì¶”ê°€ ì˜¤ë¥˜:', error);
                    alert('ì„ ìƒë‹˜ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            function openAssignClass(teacherId, teacherName, currentClass) {
                currentTeacherId = teacherId;
                document.getElementById('assignTeacherName').textContent = teacherName;
                document.getElementById('assignClassName').value = currentClass || '';
                document.getElementById('assignClassModal').classList.remove('hidden');
            }

            function closeAssignClassModal() {
                document.getElementById('assignClassModal').classList.add('hidden');
                currentTeacherId = null;
            }

            async function submitAssignClass() {
                const className = document.getElementById('assignClassName').value.trim();

                if (!className) {
                    alert('ë°˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }

                try {
                    const response = await fetch('/api/teachers/' + currentTeacherId + '/assign-class', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ assigned_class: className })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert('ë°˜ ë°°ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        closeAssignClassModal();
                        loadTeachers();
                    } else {
                        alert('ì˜¤ë¥˜: ' + (data.error || 'ë°˜ ë°°ì • ì‹¤íŒ¨'));
                    }
                } catch (error) {
                    console.error('ë°˜ ë°°ì • ì˜¤ë¥˜:', error);
                    alert('ë°˜ ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            async function deleteTeacher(teacherId, teacherName) {
                if (!confirm(teacherName + ' ì„ ìƒë‹˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    return;
                }

                try {
                    const response = await fetch('/api/teachers/' + teacherId, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        alert('ì„ ìƒë‹˜ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadTeachers();
                    } else {
                        alert('ì˜¤ë¥˜: ' + (data.error || 'ì‚­ì œ ì‹¤íŒ¨'));
                    }
                } catch (error) {
                    console.error('ì„ ìƒë‹˜ ì‚­ì œ ì˜¤ë¥˜:', error);
                    alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        </script>
    </body>
    </html>
  `)
})

