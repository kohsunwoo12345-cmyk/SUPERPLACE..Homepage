<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµìœ¡ë¹„ ê´€ë¦¬ - ìŠˆí¼í”Œë ˆì´ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css');
        * { font-family: 'Pretendard Variable', sans-serif; }
        
        .calendar-cell { 
            min-height: 140px;
            position: relative;
            transition: all 0.2s;
        }
        .calendar-cell:hover { 
            background-color: #f9fafb; 
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .student-item {
            font-size: 11px;
            padding: 4px 6px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .student-item:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .date-number {
            font-size: 18px;
            font-weight: 700;
        }
        .day-name {
            font-size: 10px;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-[1800px] mx-auto px-6 py-8">
        <!-- í—¤ë” -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-bold text-gray-900 mb-2">ğŸ“… êµìœ¡ë¹„ ê´€ë¦¬ ë‹¬ë ¥</h1>
                <p class="text-gray-600">í•™ìƒë³„ ì›”ë³„ êµìœ¡ë¹„ ë‚©ì… í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”</p>
            </div>
            <div class="flex gap-3">
                <button onclick="openClassFeeModal()" class="inline-flex items-center px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium shadow-lg">
                    <i class="fas fa-cog mr-2"></i> ë°˜ êµìœ¡ë¹„ ì„¤ì •
                </button>
                <a href="/tools/revenue-management" class="inline-flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium shadow-lg">
                    <i class="fas fa-chart-line mr-2"></i> ë§¤ì¶œ ê´€ë¦¬
                </a>
                <a href="/dashboard" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium shadow-lg">
                    <i class="fas fa-home mr-2"></i> ëŒ€ì‹œë³´ë“œ
                </a>
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-8">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ì´ í•™ìƒ ìˆ˜</span>
                    <i class="fas fa-users text-2xl opacity-80"></i>
                </div>
                <div class="text-3xl font-bold" id="totalStudents">0</div>
                <div class="text-xs opacity-75 mt-1">ëª…</div>
            </div>
            
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ì™„ë‚©</span>
                    <i class="fas fa-check-circle text-2xl opacity-80"></i>
                </div>
                <div class="text-3xl font-bold" id="paidStudents">0</div>
                <div class="text-xs opacity-75 mt-1">ëª…</div>
            </div>
            
            <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ë¯¸ë‚©</span>
                    <i class="fas fa-exclamation-circle text-2xl opacity-80"></i>
                </div>
                <div class="text-3xl font-bold" id="unpaidStudents">0</div>
                <div class="text-xs opacity-75 mt-1">ëª…</div>
            </div>
            
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ì˜ˆìƒ ë§¤ì¶œ</span>
                    <i class="fas fa-won-sign text-2xl opacity-80"></i>
                </div>
                <div class="text-2xl font-bold" id="totalAmount">0ì›</div>
            </div>
            
            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-2xl shadow-lg p-6 text-white">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-medium opacity-90">ì‹¤ë‚©ì…ì•¡</span>
                    <i class="fas fa-coins text-2xl opacity-80"></i>
                </div>
                <div class="text-2xl font-bold" id="totalPaid">0ì›</div>
            </div>
        </div>

        <!-- ë‹¬ë ¥ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <button onclick="prevMonth()" class="p-3 hover:bg-gray-100 rounded-xl transition">
                        <i class="fas fa-chevron-left text-gray-700 text-lg"></i>
                    </button>
                    <div class="flex gap-4">
                        <select id="yearFilter" onchange="loadCalendar()" class="px-6 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 font-bold text-lg">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                        </select>
                        <select id="monthFilter" onchange="loadCalendar()" class="px-6 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 font-bold text-lg">
                            <option value="1">1ì›”</option>
                            <option value="2">2ì›”</option>
                            <option value="3">3ì›”</option>
                            <option value="4">4ì›”</option>
                            <option value="5">5ì›”</option>
                            <option value="6">6ì›”</option>
                            <option value="7">7ì›”</option>
                            <option value="8">8ì›”</option>
                            <option value="9">9ì›”</option>
                            <option value="10">10ì›”</option>
                            <option value="11">11ì›”</option>
                            <option value="12">12ì›”</option>
                        </select>
                    </div>
                    <button onclick="nextMonth()" class="p-3 hover:bg-gray-100 rounded-xl transition">
                        <i class="fas fa-chevron-right text-gray-700 text-lg"></i>
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="goToday()" class="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-bold shadow-lg">
                        <i class="fas fa-calendar-day mr-2"></i>ì˜¤ëŠ˜
                    </button>
                </div>
            </div>
        </div>

        <!-- ë‹¬ë ¥ -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <!-- ìš”ì¼ í—¤ë” -->
            <div class="grid grid-cols-7 border-b-2 border-gray-300">
                <div class="p-4 text-center font-bold text-lg text-red-600 bg-red-50">ì¼ìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-gray-700 bg-gray-50">ì›”ìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-gray-700 bg-gray-50">í™”ìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-gray-700 bg-gray-50">ìˆ˜ìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-gray-700 bg-gray-50">ëª©ìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-gray-700 bg-gray-50">ê¸ˆìš”ì¼</div>
                <div class="p-4 text-center font-bold text-lg text-blue-600 bg-blue-50">í† ìš”ì¼</div>
            </div>
            <!-- ë‚ ì§œ ì…€ -->
            <div id="calendarBody" class="grid grid-cols-7">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>

    <!-- ê²°ì œ ì²˜ë¦¬ ëª¨ë‹¬ -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-blue-500 to-blue-600">
                <h3 class="text-2xl font-bold text-white" id="modalTitle">
                    <i class="fas fa-credit-card mr-2"></i>êµìœ¡ë¹„ ë‚©ì… ì²˜ë¦¬
                </h3>
                <button onclick="closePaymentModal()" class="text-white hover:text-gray-200 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-8">
                <!-- í•™ìƒ ì •ë³´ -->
                <div class="mb-6" id="studentInfo">
                    <label class="block text-sm font-bold text-gray-700 mb-3">í•™ìƒ ì„ íƒ</label>
                    <select id="studentSelect" onchange="loadStudentPaymentInfo()" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg font-medium">
                        <option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>

                <!-- ë‚©ì… ì •ë³´ í‘œì‹œ -->
                <div id="paymentInfo" class="hidden">
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <div class="text-sm text-gray-600 mb-1">í•™ìƒ ì´ë¦„</div>
                                <div class="text-lg font-bold text-gray-900" id="infoStudentName">-</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600 mb-1">ë°˜</div>
                                <div class="text-lg font-bold text-gray-900" id="infoClassName">-</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600 mb-1">ì›” êµìœ¡ë¹„</div>
                                <div class="text-lg font-bold text-blue-600" id="infoMonthlyFee">0ì›</div>
                            </div>
                            <div>
                                <div class="text-sm text-gray-600 mb-1">ë‚©ì… ìƒíƒœ</div>
                                <div class="text-lg font-bold" id="infoPaymentStatus">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- ë‚©ì… í¼ -->
                    <form id="paymentForm" onsubmit="submitPayment(event)">
                        <input type="hidden" id="selectedStudentId">
                        <input type="hidden" id="selectedPaymentId">
                        
                        <div class="space-y-5">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-won-sign mr-2 text-blue-600"></i>ë‚©ì… ê¸ˆì•¡
                                </label>
                                <input type="number" id="paidAmount" required 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg font-medium"
                                    placeholder="ë‚©ì… ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt mr-2 text-blue-600"></i>ë‚©ì…ì¼
                                </label>
                                <input type="date" id="paidDate" required 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg font-medium">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-credit-card mr-2 text-blue-600"></i>ê²°ì œ ë°©ë²•
                                </label>
                                <select id="paymentMethod" required 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 text-lg font-medium">
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                    <option value="card">ì¹´ë“œ</option>
                                    <option value="cash">í˜„ê¸ˆ</option>
                                    <option value="transfer">ê³„ì¢Œì´ì²´</option>
                                    <option value="other">ê¸°íƒ€</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-sticky-note mr-2 text-blue-600"></i>ë©”ëª¨
                                </label>
                                <textarea id="paymentMemo" rows="3" 
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500"
                                    placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"></textarea>
                            </div>

                            <div class="flex gap-3 pt-4">
                                <button type="submit" class="flex-1 bg-blue-600 text-white py-4 rounded-xl hover:bg-blue-700 transition font-bold text-lg shadow-lg">
                                    <i class="fas fa-check mr-2"></i><span id="submitButtonText">ë‚©ì… ì²˜ë¦¬</span>
                                </button>
                                <button type="button" id="deletePaymentBtn" onclick="deletePayment()" class="hidden px-8 bg-red-600 text-white py-4 rounded-xl hover:bg-red-700 transition font-bold text-lg">
                                    <i class="fas fa-trash mr-2"></i>ì‚­ì œ
                                </button>
                                <button type="button" onclick="closePaymentModal()" class="px-8 bg-gray-200 text-gray-700 py-4 rounded-xl hover:bg-gray-300 transition font-bold text-lg">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ë°˜ êµìœ¡ë¹„ ì„¤ì • ëª¨ë‹¬ -->
    <div id="classFeeModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-purple-500 to-purple-600">
                <h3 class="text-2xl font-bold text-white">
                    <i class="fas fa-cog mr-2"></i>ë°˜ êµìœ¡ë¹„ ì„¤ì •
                </h3>
                <button onclick="closeClassFeeModal()" class="text-white hover:text-gray-200 transition">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div class="p-8">
                <p class="text-gray-600 mb-6">ê° ë°˜ì˜ ì›” êµìœ¡ë¹„ë¥¼ ì„¤ì •í•˜ì„¸ìš”. í•™ìƒì´ í•´ë‹¹ ë°˜ì— ë°°ì •ë˜ë©´ ìë™ìœ¼ë¡œ êµìœ¡ë¹„ê°€ ì ìš©ë©ë‹ˆë‹¤.</p>
                
                <div id="classList" class="space-y-4">
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                        <p>ë°˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentYear, currentMonth;
        let allStudents = [];
        let allPayments = {};

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            const user = localStorage.getItem('user');
            if (!user) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/login';
                return;
            }

            initYearSelect();
            const today = new Date();
            document.getElementById('yearFilter').value = today.getFullYear();
            document.getElementById('monthFilter').value = today.getMonth() + 1;
            currentYear = today.getFullYear();
            currentMonth = today.getMonth() + 1;
            
            loadCalendar();
        });

        function initYearSelect() {
            const yearSelect = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            for (let year = currentYear - 2; year <= currentYear + 2; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'ë…„';
                yearSelect.appendChild(option);
            }
        }

        function getApiHeaders() {
            const user = JSON.parse(localStorage.getItem('user'));
            return {
                'Content-Type': 'application/json',
                'X-User-Data-Base64': btoa(unescape(encodeURIComponent(JSON.stringify(user))))
            };
        }

        async function loadCalendar() {
            currentYear = parseInt(document.getElementById('yearFilter').value);
            currentMonth = parseInt(document.getElementById('monthFilter').value);
            
            await loadPayments();
            renderCalendar();
            updateStats();
        }

        async function loadPayments() {
            try {
                const response = await fetch(`/api/tuition/payments?year=${currentYear}&month=${currentMonth}`, {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    allStudents = data.payments || [];
                    allPayments = {};
                    allStudents.forEach(payment => {
                        allPayments[payment.student_id] = payment;
                    });
                }
            } catch (error) {
                console.error('ë‚©ì… í˜„í™© ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        function renderCalendar() {
            const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
            const lastDate = new Date(currentYear, currentMonth, 0).getDate();
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === currentYear && today.getMonth() + 1 === currentMonth;
            const todayDate = today.getDate();
            
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';
            
            // ì´ì „ ë‹¬ì˜ ë¹ˆ ì¹¸
            for (let i = 0; i < firstDay; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell border border-gray-200 bg-gray-50';
                calendarBody.appendChild(cell);
            }
            
            // ë‚ ì§œ ì…€
            for (let day = 1; day <= lastDate; day++) {
                const dayOfWeek = (firstDay + day - 1) % 7;
                const cell = document.createElement('div');
                cell.className = 'calendar-cell border border-gray-200 p-3 bg-white';
                
                // ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡°
                if (isCurrentMonth && day === todayDate) {
                    cell.className += ' ring-4 ring-blue-400 bg-blue-50';
                }
                
                // ì£¼ë§ ë°°ê²½ìƒ‰
                if (dayOfWeek === 0) cell.className += ' bg-red-50';
                if (dayOfWeek === 6) cell.className += ' bg-blue-50';
                
                // ë‚ ì§œ í—¤ë”
                const dateHeader = document.createElement('div');
                dateHeader.className = 'flex items-center justify-between mb-3 pb-2 border-b-2 border-gray-200';
                const dateColor = dayOfWeek === 0 ? 'text-red-600' : dayOfWeek === 6 ? 'text-blue-600' : 'text-gray-800';
                dateHeader.innerHTML = `
                    <div>
                        <div class="date-number ${dateColor}">${day}</div>
                        <div class="day-name text-gray-500">${['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][dayOfWeek]}</div>
                    </div>
                `;
                cell.appendChild(dateHeader);
                
                // í•™ìƒ ëª©ë¡
                const studentList = document.createElement('div');
                studentList.className = 'space-y-1 overflow-y-auto max-h-24';
                
                // í•´ë‹¹ ë‚ ì§œê°€ ê²°ì œì¼ì¸ í•™ìƒ í•„í„°ë§
                const studentsOnThisDay = allStudents.filter(payment => {
                    if (!payment.enrollment_date) return false;
                    const enrollDate = new Date(payment.enrollment_date);
                    return enrollDate.getDate() === day;
                });
                
                studentsOnThisDay.forEach(payment => {
                    const statusColors = {
                        'paid': { bg: 'bg-green-500', text: 'ì™„ë‚©', icon: 'check' },
                        'partial': { bg: 'bg-yellow-500', text: 'ë¶€ë¶„', icon: 'minus' },
                        'unpaid': { bg: 'bg-red-500', text: 'ë¯¸ë‚©', icon: 'exclamation' }
                    };
                    const status = statusColors[payment.status] || statusColors['unpaid'];
                    
                    const studentItem = document.createElement('div');
                    studentItem.className = `student-item ${status.bg} text-white font-medium`;
                    studentItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="truncate">${payment.student_name}</span>
                            <span class="text-xs ml-2"><i class="fas fa-${status.icon}-circle"></i> ${status.text}</span>
                        </div>
                    `;
                    studentItem.onclick = () => openPaymentModal(payment.student_id);
                    
                    // ë‹¤ìŒ ë‹¬ ë‚©ì… ì•Œë¦¼ (ë¯¸ë‚© ì‹œì—ë§Œ)
                    let tooltipText = `${payment.student_name} - ${(payment.amount || 0).toLocaleString()}ì›`;
                    if (payment.status !== 'paid') {
                        const nextMonthPaymentDay = day;
                        const nextMonth = currentMonth === 12 ? 1 : currentMonth + 1;
                        const nextYear = currentMonth === 12 ? currentYear + 1 : currentYear;
                        tooltipText += `\nâ° ë‹¤ìŒ ë‚©ì…: ${nextYear}ë…„ ${nextMonth}ì›” ${nextMonthPaymentDay}ì¼`;
                    }
                    studentItem.title = tooltipText;
                    studentList.appendChild(studentItem);
                });
                
                cell.appendChild(studentList);
                calendarBody.appendChild(cell);
            }
        }

        async function openPaymentModal(studentId = null) {
            document.getElementById('paymentModal').classList.remove('hidden');
            
            // í•™ìƒ ëª©ë¡ ë¡œë“œ
            try {
                const response = await fetch('/api/students', {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                if (data.success && data.students) {
                    const select = document.getElementById('studentSelect');
                    select.innerHTML = '<option value="">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    
                    data.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.name} (${student.grade || '-'}) - ${student.class_name || 'ë°˜ ë¯¸ë°°ì •'}`;
                        option.dataset.classId = student.class_id;
                        option.dataset.className = student.class_name || '-';
                        option.dataset.classFee = student.class_fee || 0;
                        option.dataset.enrollmentDate = student.enrollment_date || '';
                        if (studentId && student.id == studentId) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                    
                    if (studentId) {
                        loadStudentPaymentInfo();
                    }
                }
            } catch (error) {
                console.error('í•™ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
            
            // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('paidDate').value = today;
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
            document.getElementById('paymentInfo').classList.add('hidden');
            document.getElementById('paymentForm').reset();
            document.getElementById('deletePaymentBtn').classList.add('hidden');
            document.getElementById('submitButtonText').textContent = 'ë‚©ì… ì²˜ë¦¬';
        }

        async function deletePayment() {
            const paymentId = document.getElementById('selectedPaymentId').value;
            if (!paymentId) {
                alert('âŒ ì‚­ì œí•  ë‚©ì… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!confirm('âš ï¸ ì •ë§ ì´ ë‚©ì… ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/tuition/payments/${paymentId}`, {
                    method: 'DELETE',
                    headers: getApiHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… ë‚©ì… ë‚´ì—­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closePaymentModal();
                    await loadCalendar();
                } else {
                    alert('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
                alert('âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function loadStudentPaymentInfo() {
            const select = document.getElementById('studentSelect');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption.value) {
                document.getElementById('paymentInfo').classList.add('hidden');
                return;
            }
            
            const studentId = selectedOption.value;
            const studentName = selectedOption.textContent.split(' (')[0];
            const className = selectedOption.dataset.className;
            const classFee = parseInt(selectedOption.dataset.classFee) || 0;
            
            document.getElementById('selectedStudentId').value = studentId;
            document.getElementById('infoStudentName').textContent = studentName;
            document.getElementById('infoClassName').textContent = className;
            document.getElementById('infoMonthlyFee').textContent = classFee.toLocaleString() + 'ì›';
            document.getElementById('paidAmount').value = classFee;
            
            // ê¸°ì¡´ ë‚©ì… ë‚´ì—­ í™•ì¸
            const payment = allPayments[studentId];
            if (payment) {
                document.getElementById('selectedPaymentId').value = payment.id || '';
                const statusText = payment.status === 'paid' ? 'ì™„ë‚©' : payment.status === 'partial' ? 'ë¶€ë¶„ë‚©ì…' : 'ë¯¸ë‚©';
                const statusClass = payment.status === 'paid' ? 'text-green-600' : payment.status === 'partial' ? 'text-yellow-600' : 'text-red-600';
                document.getElementById('infoPaymentStatus').innerHTML = `<span class="${statusClass}">${statusText} (${(payment.paid_amount || 0).toLocaleString()}ì›)</span>`;
                
                // ê¸°ì¡´ ë‚©ì… ì •ë³´ë¥¼ í¼ì— ì±„ìš°ê¸° (ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡)
                if (payment.paid_amount) {
                    document.getElementById('paidAmount').value = payment.paid_amount;
                }
                if (payment.paid_date) {
                    document.getElementById('paidDate').value = payment.paid_date;
                }
                if (payment.payment_method) {
                    document.getElementById('paymentMethod').value = payment.payment_method;
                }
                if (payment.memo) {
                    document.getElementById('paymentMemo').value = payment.memo;
                }
                
                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ ë° ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('submitButtonText').textContent = 'ë‚©ì… ìˆ˜ì •';
                document.getElementById('deletePaymentBtn').classList.remove('hidden');
            } else {
                document.getElementById('infoPaymentStatus').innerHTML = '<span class="text-red-600">ë¯¸ë‚© (0ì›)</span>';
                document.getElementById('submitButtonText').textContent = 'ë‚©ì… ì²˜ë¦¬';
                document.getElementById('deletePaymentBtn').classList.add('hidden');
            }
            
            document.getElementById('paymentInfo').classList.remove('hidden');
        }

        async function submitPayment(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('selectedStudentId').value;
            const paidAmount = parseInt(document.getElementById('paidAmount').value);
            const paidDate = document.getElementById('paidDate').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const memo = document.getElementById('paymentMemo').value;
            
            try {
                const response = await fetch('/api/tuition/payments', {
                    method: 'POST',
                    headers: getApiHeaders(),
                    body: JSON.stringify({
                        student_id: studentId,
                        year: currentYear,
                        month: currentMonth,
                        paid_amount: paidAmount,
                        paid_date: paidDate,
                        payment_method: paymentMethod,
                        memo: memo
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('âœ… ë‚©ì… ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\në‹¬ë ¥ì´ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.');
                    closePaymentModal();
                    await loadCalendar(); // ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                } else {
                    alert('âŒ ë‚©ì… ì²˜ë¦¬ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('ë‚©ì… ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('âŒ ë‚©ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function updateStats() {
            const total = allStudents.length;
            const paid = allStudents.filter(p => p.status === 'paid').length;
            const unpaid = allStudents.filter(p => p.status === 'unpaid').length;
            const totalAmount = allStudents.reduce((sum, p) => sum + (p.amount || 0), 0);
            const totalPaid = allStudents.reduce((sum, p) => sum + (p.paid_amount || 0), 0);
            
            document.getElementById('totalStudents').textContent = total;
            document.getElementById('paidStudents').textContent = paid;
            document.getElementById('unpaidStudents').textContent = unpaid;
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString() + 'ì›';
            document.getElementById('totalPaid').textContent = totalPaid.toLocaleString() + 'ì›';
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            document.getElementById('yearFilter').value = currentYear;
            document.getElementById('monthFilter').value = currentMonth;
            loadCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            document.getElementById('yearFilter').value = currentYear;
            document.getElementById('monthFilter').value = currentMonth;
            loadCalendar();
        }

        function goToday() {
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth() + 1;
            document.getElementById('yearFilter').value = currentYear;
            document.getElementById('monthFilter').value = currentMonth;
            loadCalendar();
        }

        // ========== ë°˜ êµìœ¡ë¹„ ì„¤ì • ê¸°ëŠ¥ ==========
        async function openClassFeeModal() {
            document.getElementById('classFeeModal').classList.remove('hidden');
            await loadClassList();
        }

        function closeClassFeeModal() {
            document.getElementById('classFeeModal').classList.add('hidden');
        }

        async function loadClassList() {
            const classList = document.getElementById('classList');
            try {
                const response = await fetch('/api/tuition/classes', {
                    headers: getApiHeaders()
                });
                const data = await response.json();
                
                if (data.success && data.classes) {
                    if (data.classes.length === 0) {
                        classList.innerHTML = `
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-exclamation-circle text-3xl mb-3"></i>
                                <p>ë“±ë¡ëœ ë°˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                <a href="/students/classes" class="mt-4 inline-block text-blue-600 hover:underline">
                                    <i class="fas fa-plus-circle mr-1"></i>ë°˜ ë“±ë¡í•˜ëŸ¬ ê°€ê¸°
                                </a>
                            </div>
                        `;
                        return;
                    }

                    classList.innerHTML = data.classes.map(cls => `
                        <div class="bg-gray-50 rounded-xl p-6 border-2 border-gray-200 hover:border-purple-400 transition">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h4 class="text-lg font-bold text-gray-900">${cls.name}</h4>
                                    <p class="text-sm text-gray-600">${cls.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                                    <p class="text-sm text-gray-500 mt-1">
                                        <i class="fas fa-users mr-1"></i>í•™ìƒ ìˆ˜: ${cls.student_count || 0}ëª…
                                        ${cls.teacher_name ? ` | <i class="fas fa-chalkboard-teacher mr-1"></i>${cls.teacher_name}` : ''}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-purple-600">${(cls.monthly_fee || 0).toLocaleString()}ì›</div>
                                    <div class="text-xs text-gray-500">ì›” êµìœ¡ë¹„</div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <input 
                                    type="number" 
                                    id="classFee_${cls.id}" 
                                    value="${cls.monthly_fee || 0}" 
                                    placeholder="ì›” êµìœ¡ë¹„"
                                    class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 font-medium text-lg"
                                />
                                <button 
                                    onclick="updateClassFee(${cls.id})" 
                                    class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                                    <i class="fas fa-save mr-1"></i>ì €ì¥
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('ë°˜ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                classList.innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                        <p>ë°˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }

        async function updateClassFee(classId) {
            const feeInput = document.getElementById(`classFee_${classId}`);
            const monthly_fee = parseInt(feeInput.value);

            if (!monthly_fee || monthly_fee < 0) {
                alert('âŒ ìœ íš¨í•œ êµìœ¡ë¹„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`/api/tuition/classes/${classId}/fee`, {
                    method: 'PUT',
                    headers: getApiHeaders(),
                    body: JSON.stringify({ monthly_fee })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`âœ… ë°˜ êµìœ¡ë¹„ê°€ ${monthly_fee.toLocaleString()}ì›ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    await loadClassList();
                    await loadCalendar();
                } else {
                    alert('âŒ êµìœ¡ë¹„ ì„¤ì • ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('êµìœ¡ë¹„ ì„¤ì • ì‹¤íŒ¨:', error);
                alert('âŒ êµìœ¡ë¹„ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>
